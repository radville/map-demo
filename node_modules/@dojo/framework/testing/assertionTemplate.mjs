import select from './support/selector';
import { isWNode, isVNode, decorate } from '../widget-core/d';
const findOne = (nodes, selector) => {
    let finalSelector = selector;
    if (selector.indexOf('~') === 0) {
        finalSelector = `[\\~key='${selector.substr(1)}']`;
    }
    let [node] = select(finalSelector, nodes);
    if (!node) {
        finalSelector = `[assertion-key='${selector.substr(1)}']`;
        [node] = select(finalSelector, nodes);
    }
    return node;
};
const guard = (node) => {
    if (!node) {
        throw Error('Node not found');
    }
    if (!isWNode(node) && !isVNode(node)) {
        throw Error('Cannot set or get on unknown node');
    }
    return node;
};
export function assertionTemplate(renderFunc) {
    const assertionTemplateResult = () => {
        const render = renderFunc();
        decorate(render, (node) => {
            if (isWNode(node) || isVNode(node)) {
                delete node.properties['~key'];
                delete node.properties['assertion-key'];
            }
        });
        return render;
    };
    assertionTemplateResult.setProperty = (selector, property, value) => {
        return assertionTemplate(() => {
            const render = renderFunc();
            const node = guard(findOne(render, selector));
            node.properties[property] = value;
            return render;
        });
    };
    assertionTemplateResult.append = (selector, children) => {
        return assertionTemplateResult.setChildren(selector, children, 'append');
    };
    assertionTemplateResult.prepend = (selector, children) => {
        return assertionTemplateResult.setChildren(selector, children, 'prepend');
    };
    assertionTemplateResult.replace = (selector, children) => {
        return assertionTemplateResult.setChildren(selector, children, 'replace');
    };
    assertionTemplateResult.setChildren = (selector, children, type = 'replace') => {
        return assertionTemplate(() => {
            const render = renderFunc();
            const node = guard(findOne(render, selector));
            node.children = node.children || [];
            switch (type) {
                case 'prepend':
                    node.children = [...children, ...node.children];
                    break;
                case 'append':
                    node.children = [...node.children, ...children];
                    break;
                case 'replace':
                    node.children = [...children];
                    break;
            }
            return render;
        });
    };
    assertionTemplateResult.insertBefore = (selector, children) => {
        return assertionTemplateResult.insertSiblings(selector, children, 'before');
    };
    assertionTemplateResult.insertAfter = (selector, children) => {
        return assertionTemplateResult.insertSiblings(selector, children, 'after');
    };
    assertionTemplateResult.insertSiblings = (selector, children, type = 'after') => {
        return assertionTemplate(() => {
            const render = renderFunc();
            const node = guard(findOne(render, selector));
            const parent = node.parent;
            const index = parent.children.indexOf(node);
            let newChildren = [...parent.children];
            switch (type) {
                case 'before':
                    newChildren.splice(index, 0, ...children);
                    parent.children = newChildren;
                    break;
                case 'after':
                    newChildren.splice(index + 1, 0, ...children);
                    parent.children = newChildren;
                    break;
            }
            return render;
        });
    };
    assertionTemplateResult.getProperty = (selector, property) => {
        const render = renderFunc();
        const node = guard(findOne(render, selector));
        return node.properties[property];
    };
    assertionTemplateResult.getChildren = (selector) => {
        const render = renderFunc();
        const node = guard(findOne(render, selector));
        return node.children || [];
    };
    return assertionTemplateResult;
}
export default assertionTemplate;
//# sourceMappingURL=assertionTemplate.mjs.map