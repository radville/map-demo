// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","./core/tsSupport/declareExtendsHelper","./core/tsSupport/decorateHelper","./core/tsSupport/generatorHelper","./core/tsSupport/awaiterHelper","./core/arrayUtils","./core/Collection","./core/iteratorUtils","./core/JSONSupport","./core/lang","./core/Logger","./core/promiseUtils","./core/accessorSupport/decorators","./core/accessorSupport/ensureType","./layers/support/fieldUtils","./popup/content","./popup/ExpressionInfo","./popup/FieldInfo","./popup/LayerOptions","./popup/RelatedRecordsInfo","./popup/content/AttachmentsContent","./popup/content/Content","./popup/content/FieldsContent","./popup/content/MediaContent","./popup/content/TextContent","./popup/content/support/mediaInfoTypes","./support/actions/ActionBase","./support/actions/ActionButton","./support/actions/ActionToggle"],function(t,e,o,n,r,i,s,p,l,a,c,u,f,d,y,h,m,I,v,A,F,g,w,x,_,N,O,E,C,S,T){var b=l.ofType({key:"type",defaultKeyValue:"button",base:C,typeMap:{button:S,toggle:T}}),R={base:x,key:"type",typeMap:{media:N,text:O,attachments:w,fields:_}},L=f.getLogger("esri.PopupTemplate");return function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=null,e.content="",e.expressionInfos=null,e.fieldInfos=null,e.layerOptions=null,e.lastEditInfoEnabled=!0,e.outFields=null,e.overwriteActions=!1,e.title="",e.relatedRecordsInfo=null,e}n(e,t),o=e,e.prototype.castContent=function(t){return Array.isArray(t)?t.map(function(t){return h.ensureOneOfType(R,t)}):"string"==typeof t||"function"==typeof t||t instanceof HTMLElement||d.isPromiseLike(t)?t:(L.error("content error","unsupported content value",{value:t}),null)},e.prototype.readContent=function(t,e){var o=e.popupElements;return Array.isArray(o)&&o.length>0?this._readPopupInfoElements(e):this._readPopupInfo(e)},e.prototype.writeContent=function(t,e){var o=this;if("string"==typeof t)return void(e.description=t);Array.isArray(t)&&(e.popupElements=t.map(function(t){return t&&t.toJSON()}),e.popupElements.forEach(function(t){"attachments"===t.type?o._writeAttachmentContent(e):"media"===t.type?o._writeMediaContent(t,e):"text"===t.type&&o._writeTextContent(t,e)}))},e.prototype.writeFieldInfos=function(t,e){var o=this.content,n=Array.isArray(o)?o:null;if(t){var r=!!n&&n.some(function(t){return"fields"===t.type&&(!t.fieldInfos||0===t.fieldInfos.length)});e.fieldInfos=t.filter(Boolean).map(function(t){var e=t.toJSON();return r||(e.visible=!1),e})}if(n)for(var i=0,s=n;i<s.length;i++){var p=s[i];"fields"===p.type&&this._writeFieldsContent(p,e)}},e.prototype.writeLayerOptions=function(t,e){e.layerOptions=!t||null===t.showNoDataRecords&&null===t.returnTopmostRaster?null:t.toJSON()},e.prototype.writeTitle=function(t,e){e.title=t||""},e.prototype.clone=function(){var t=this.actions,e=t?u.clone(t.toArray()):[];return new o({actions:e,content:Array.isArray(this.content)?u.clone(this.content):this.content,expressionInfos:Array.isArray(this.expressionInfos)?u.clone(this.expressionInfos):null,fieldInfos:Array.isArray(this.fieldInfos)?u.clone(this.fieldInfos):null,layerOptions:this.layerOptions?u.clone(this.layerOptions):null,lastEditInfoEnabled:this.lastEditInfoEnabled,outFields:Array.isArray(this.outFields)?u.clone(this.outFields):null,overwriteActions:this.overwriteActions,title:this.title,relatedRecordsInfo:this.relatedRecordsInfo?u.clone(this.relatedRecordsInfo):null})},e.prototype.collectRequiredFields=function(t,e){return s(this,void 0,void 0,function(){return i(this,function(o){switch(o.label){case 0:return[4,this._collectExpressionInfoFields(t,e,this.expressionInfos)];case 1:return o.sent(),m.collectFields(t,e,(this.outFields||[]).concat(this._getActionsFields(this.actions),this._getTitleFields(this.title),this._getContentFields(this.content))),[2]}})})},e.prototype.getRequiredFields=function(t){return s(this,void 0,void 0,function(){var e;return i(this,function(o){switch(o.label){case 0:return e=new Set,[4,this.collectRequiredFields(e,t)];case 1:return o.sent(),[2,a.valuesOfSet(e).sort()]}})})},e.prototype._writeFieldsContent=function(t,e){if(Array.isArray(t.fieldInfos)&&t.fieldInfos.length){var o=u.clone(t.fieldInfos);Array.isArray(e.fieldInfos)?o.forEach(function(t){var o=p.find(e.fieldInfos,function(e){return e.fieldName.toLowerCase()===t.fieldName.toLowerCase()});o?o.visible=!0:e.fieldInfos.push(t)}):e.fieldInfos=o}},e.prototype._writeAttachmentContent=function(t){t.showAttachments||(t.showAttachments=!0)},e.prototype._writeTextContent=function(t,e){!e.description&&t.text&&(e.description=t.text)},e.prototype._writeMediaContent=function(t,e){if(Array.isArray(t.mediaInfos)&&t.mediaInfos.length){var o=u.clone(t.mediaInfos);Array.isArray(e.mediaInfos)?e.mediaInfos=e.mediaInfos.concat(o):e.mediaInfos=o}},e.prototype._readPopupInfoElements=function(t){var e=t.description,o=t.mediaInfos,n=t.popupElements,r={description:!1,mediaInfos:!1};return n.map(function(t){return"media"===t.type?(t.mediaInfos||!o||r.mediaInfos||(t.mediaInfos=o,r.mediaInfos=!0),N.fromJSON(t)):"text"===t.type?(t.text||!e||r.description||(t.text=e,r.description=!0),O.fromJSON(t)):"attachments"===t.type?w.fromJSON(t):"fields"===t.type?_.fromJSON(t):void 0}).filter(Boolean)},e.prototype._readPopupInfo=function(t){var e=t.description,o=t.mediaInfos,n=t.showAttachments,r=[];return e?r.push(new O({text:e})):r.push(new _),Array.isArray(o)&&o.length&&r.push(N.fromJSON({mediaInfos:o})),n&&r.push(w.fromJSON({displayType:"list"})),r.length?r:e},e.prototype._getContentElementFields=function(t){var e=this;if(!t||"attachments"===t.type)return[];if("fields"===t.type)return this._getFieldInfoFields(t.fieldInfos||this.fieldInfos);if("media"===t.type){return(t.mediaInfos||[]).reduce(function(t,o){return t.concat(e._getMediaInfoFields(o))},[])}return"text"===t.type?this._extractFieldNames(t.text):void 0},e.prototype._getMediaInfoFields=function(t){var e=t.caption,o=t.title,n=t.value,r=n||{},i=r.fields,s=void 0===i?[]:i,p=r.normalizeField,l=r.tooltipField,a=r.sourceURL,c=r.linkURL,u=this._extractFieldNames(o).concat(this._extractFieldNames(e),this._extractFieldNames(a),this._extractFieldNames(c),s);return p&&u.push(p),l&&u.push(l),u},e.prototype._getContentFields=function(t){var e=this;return"string"==typeof t?this._extractFieldNames(t):Array.isArray(t)?t.reduce(function(t,o){return t.concat(e._getContentElementFields(o))},[]):[]},e.prototype._collectExpressionInfoFields=function(t,e,o){return s(this,void 0,void 0,function(){return i(this,function(n){switch(n.label){case 0:return o?[4,d.all(o.map(function(o){return m.collectArcadeFieldNames(t,e,o.expression)}))]:[2];case 1:return n.sent(),[2]}})})},e.prototype._getFieldInfoFields=function(t){return t?t.filter(function(t){return void 0===t.visible||!!t.visible}).map(function(t){return t.fieldName}).filter(function(t){return-1===t.indexOf("relationships/")&&-1===t.indexOf("expression/")}):[]},e.prototype._getActionsFields=function(t){var e=this;return t?t.toArray().reduce(function(t,o){return t.concat(e._getActionFields(o))},[]):[]},e.prototype._getActionFields=function(t){var e=t.className,o=t.title,n=t.type,r="button"===n||"toggle"===n?t.image:"";return this._extractFieldNames(o).concat(this._extractFieldNames(e),this._extractFieldNames(r))},e.prototype._getTitleFields=function(t){return"string"==typeof t?this._extractFieldNames(t):[]},e.prototype._extractFieldNames=function(t){if(!t||"string"!=typeof t)return[];var e=/{[^}]*}/g,o=t.match(e);if(!o)return[];var n=/\{(\w+):.+\}/,r=o.filter(function(t){return!(0===t.indexOf("{relationships/")||0===t.indexOf("{expression/"))}).map(function(t){return t.replace(n,"{$1}")});return r?r.map(function(t){return t.slice(1,-1)}):[]};var o;return r([y.property({type:b})],e.prototype,"actions",void 0),r([y.property()],e.prototype,"content",void 0),r([y.cast("content")],e.prototype,"castContent",null),r([y.reader("content",["description","popupElements","mediaInfos","showAttachments"])],e.prototype,"readContent",null),r([y.writer("content",{popupElements:{type:l.ofType(I.types)},showAttachments:{type:Boolean},mediaInfos:{type:l.ofType(E.types)},description:{type:String}})],e.prototype,"writeContent",null),r([y.property({type:[v],json:{write:!0}})],e.prototype,"expressionInfos",void 0),r([y.property({type:[A]})],e.prototype,"fieldInfos",void 0),r([y.writer("fieldInfos")],e.prototype,"writeFieldInfos",null),r([y.property({type:F})],e.prototype,"layerOptions",void 0),r([y.writer("layerOptions")],e.prototype,"writeLayerOptions",null),r([y.property({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],e.prototype,"lastEditInfoEnabled",void 0),r([y.property()],e.prototype,"outFields",void 0),r([y.property()],e.prototype,"overwriteActions",void 0),r([y.property({json:{type:String}})],e.prototype,"title",void 0),r([y.writer("title")],e.prototype,"writeTitle",null),r([y.property({type:g,json:{write:!0}})],e.prototype,"relatedRecordsInfo",void 0),e=o=r([y.subclass("esri.PopupTemplate")],e)}(y.declared(c.JSONSupport))});