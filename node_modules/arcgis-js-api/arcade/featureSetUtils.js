// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/extendsHelper","../core/tsSupport/assignHelper","../request","./featureSetCollection","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerMemory","./featureset/sources/FeatureLayerRelated","./featureset/support/cache","./featureset/support/shared","../core/promiseUtils","../layers/FeatureLayer","../portal/Portal","../portal/PortalItem","./featureset/actions/OrderBy","./featureset/actions/Top","./featureset/actions/SpatialFilter","./featureset/actions/AttributeFilter","./featureset/actions/GroupBy"],function(e,t,r,a,n,i,l,o,u,s,c,d,f,h,p){function y(){null===s.applicationCache&&(s.applicationCache=new s)}function m(e,t){if(s.applicationCache){var r=s.applicationCache.getLayerInfo(e);if(r)return r.then(function(r){return d.resolve(new f({url:e,outFields:t,sourceJSON:r}))});var a=new f({url:e,outFields:t}),n=d.create(function(e,t){a.load().then(function(){e(a.sourceJSON)},function(e){t(e)})});return s.applicationCache&&(s.applicationCache.setLayerInfo(e,n),n=n.catch(function(t){throw s.applicationCache.clearLayerInfo(e),t})),n.then(function(e){return d.resolve(a)})}return d.resolve(new f({url:e,outFields:t}))}function v(e,t,r,a,n){return m(e,["*"]).then(function(e){return d.resolve(L(e,t,r,a,n))})}function L(e,t,r,a,n){return void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===n&&(n=null),!0===e._hasMemorySource()?new o({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n}):new l({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n})}function I(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then(function(e){if(e.data){var t=e.data;return d.resolve(t)}return d.resolve(null)});return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,r),r=r.catch(function(t){throw s.applicationCache.clearLayerInfo(e),t})),r}function S(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==s.applicationCache){var a=s.applicationCache.getLayerInfo(r);if(null!==a)return a}var i=n(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then(function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")});return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(r,i),i=i.catch(function(e){throw s.applicationCache.clearLayerInfo(r),e})),i}function _(e){if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then(function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),d.resolve(t)}var r={layers:[],tables:[]};return d.resolve(r)});return null!==s.applicationCache&&(s.applicationCache.setLayerInfo(e,r),r=r.catch(function(t){throw s.applicationCache.clearLayerInfo(e),t})),r}function F(e,t){var r={metadata:null,networkId:-1,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return _(e).then(function(a){if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(var n=0,i=a.layers;n<i.length;n++){var l=i[n];r.layerNameLkp[l.id]=l.name}if(a.tables)for(var o=0,u=a.tables;o<u.length;o++){var l=u[o];r.layerNameLkp[l.id]=l.name}var s=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=s,S(e,s).then(function(a){if(a){r.queryelem=a,r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(var n=0,i=r.queryelem.dataElement.domainNetworks;n<i.length;n++){for(var l=i[n],o=0,u=l.edgeSources?l.edgeSources:[];o<u.length;o++){var c=u[o],d={layerId:c.layerId,sourceId:c.sourceId,className:r.layerNameLkp[c.layerId]?r.layerNameLkp[c.layerId]:null};d.className&&(r.lkp[d.className]=d)}for(var f=0,h=l.junctionSources?l.junctionSources:[];f<h.length;f++){var c=h[f],d={layerId:c.layerId,sourceId:c.sourceId,className:r.layerNameLkp[c.layerId]?r.layerNameLkp[c.layerId]:null};d.className&&(r.lkp[d.className]=d)}}if(r.queryelem.dataElement.terminalConfigurations)for(var p=0,y=r.queryelem.dataElement.terminalConfigurations;p<y.length;p++)for(var m=y[p],L=0,S=m.terminals;L<S.length;L++){var _=S[L];r.terminals.push({terminalId:_.terminalId,terminalName:_.terminalName})}return I(e+"/"+s).then(function(a){return a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId?v(e+"/"+a.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],!1,null).then(function(e){return e.load()}).then(function(e){return{lkp:r.lkp,associations:e,terminals:r.terminals}}):{associations:null,lkp:null,terminals:[]}})}return{associations:null,lkp:null,terminals:[]}})}return{associations:null,lkp:null,terminals:[]}})}function g(e,t,r,a,n,i,l){void 0===a&&(a=null),void 0===n&&(n=null),void 0===i&&(i=!0),void 0===l&&(l=null);var o=e.serviceUrl();return o?(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),v(o,a,n,i,l).then(function(o){return new u({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:l})})):null}function N(e,t,r){return void 0===r&&(r=null),new T(e,t,r)}function C(e,t,r){return void 0===r&&(r=null),new w(e,t,r)}function b(e,t){return null===e?t:new h({url:e.field("url")})}function k(e,t,r,a,n,i,l){if(s.applicationCache){var o=s.applicationCache.getLayerInfo(e+":"+i.url);if(o)return o.then(function(e){try{var i=new f({url:c.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return d.resolve(L(i,r,a,n,l))}catch(e){return d.reject(e)}},function(e){return d.reject(e)})}return d.create(function(o,u){var d=new p({id:e,portal:i}),h=d.load();s.applicationCache&&s.applicationCache.setLayerInfo(e+":"+i.url,h),h.then(function(e){try{var i=new f({url:c.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});o(L(i,r,a,n,l))}catch(e){u(e)}},function(t){s.applicationCache&&s.applicationCache.clearLayerInfo(e+":"+i.url),u(t)})})}Object.defineProperty(t,"__esModule",{value:!0}),t.initialiseMetaDataCache=y,t.constructFeatureSetFromUrl=v,t.constructFeatureSet=L,t.constructAssociationMetaDataFeatureSetFromUrl=F,t.constructFeatureSetFromRelationship=g;var T=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._map=t,n._overridespref=r,n.lrucache=a,n._instantLayers=[],n}return r(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=L(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,r){var n=this;if(void 0===t&&(t=!0),void 0===r&&(r=null),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return n.featureSetByName(e,t,r)}catch(e){return d.reject(e)}});null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var i=JSON.stringify(r),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.title===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.layers.find(function(t){return t instanceof f&&t.title===e});if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,r));if(this._map.tables){var s=this._map.tables.find(function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)});if(s){if(s._materializedTable);else{var c=s.outFields?s:a({},s,{outFields:["*"]});s._materializedTable=new f(c)}return s._materializedTable.load().then(function(){return n.resolvePromise(n.makeAndAddFeatureSet(s._materializedTable,t,r))})}}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,r){var n=this;if(void 0===t&&(t=!0),void 0===r&&(r=["*"]),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return n.featureSetById(e,t,r)}catch(e){return d.reject(e)}});null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var i=JSON.stringify(r),l=0;l<this._instantLayers.length;l++){var o=this._instantLayers[l];if(o.opitem.id===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.layers.find(function(t){return t instanceof f&&t.id===e});if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,r));if(this._map.tables){var s=this._map.tables.find(function(t){return t.id===e});if(s){if(s._materializedTable);else{var c=a({},s,{outFields:["*"]});s._materializedTable=new f(c)}return s._materializedTable.load().then(function(){return n.resolvePromise(n.makeAndAddFeatureSet(s._materializedTable,t,r))})}}return this.resolvePromise(null)},t}(i),w=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var n=e.call(this)||this;return n._url=t,n._overridespref=r,n.lrucache=a,n.metadata=null,n._instantLayers=[],n}return r(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=L(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype._loadMetaData=function(){var e=this;return _(this._url).then(function(t){return e.metadata=t,t})},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var n=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then(function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){var u=o[l];u.name===e&&(i=u)}if(!i)for(var s=0,c=n.tables?n.tables:[];s<c.length;s++){var u=c[s];u.name===e&&(i=u)}return i?m(a._url+"/"+i.id,["*"]).then(function(e){return a.makeAndAddFeatureSet(e,t,r)}):a.resolvePromise(null)})},t.prototype.featureSetById=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();var n=JSON.stringify(r);e=null!==e&&void 0!==e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then(function(n){for(var i=null,l=0,o=n.layers?n.layers:[];l<o.length;l++){var u=o[l];null!==u.id&&void 0!==u.id&&u.id.toString()===e&&(i=u)}if(!i)for(var s=0,c=n.tables?n.tables:[];s<c.length;s++){var u=c[s];null!==u.id&&void 0!==u.id&&u.id.toString()===e&&(i=u)}return i?m(a._url+"/"+i.id,["*"]).then(function(e){return a.makeAndAddFeatureSet(e,t,r)}):a.resolvePromise(null)})},t}(i);t.createFeatureSetCollectionFromMap=N,t.createFeatureSetCollectionFromService=C,t.getPortal=b,t.constructFeatureSetFromPortalItem=k});