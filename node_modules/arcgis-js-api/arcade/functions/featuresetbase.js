// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../ArcadePortal","../Dictionary","../Dictionary","../Feature","../featureSetCollection","../featureSetUtils","../languageUtils","../featureset/actions/Adapted","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/Empty","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/shared","../featureset/support/sqlUtils","./fieldStats","../../core/promiseUtils","../../core/sql/WhereClause","../../layers/FeatureLayer","../../layers/support/Field"],function(e,r,t,n,a,i,l,s,o,u,f,d,c,m,p,y,g,h,v,F,I,S,A){function b(e,r,t,n){if(1===n.length){if(o.isArray(n[0]))return v.calculateStat(e,n[0],-1);if(o.isImmutableArray(n[0]))return v.calculateStat(e,n[0].toArray(),-1)}return v.calculateStat(e,n,-1)}function D(e,r,t){var n=e.getVariables();if(n.length>0){for(var a=[],i=0;i<n.length;i++){var l={name:n[i]};a.push(r.evaluateIdentifier(t,l))}return F.all(a).then(function(r){for(var t={},a=0;a<n.length;a++)t[n[a]]=r[a];return e.parameters=t,e})}return F.resolve(e)}function w(e,r,t){void 0===t&&(t=null);for(var n in e)if(n.toLowerCase()===r.toLowerCase())return e[n];return t}function E(e){if(null===e)return null;var r={type:w(e,"type",""),name:w(e,"name","")};if("range"===r.type)r.range=w(e,"range",[]);else{r.codedValues=[];for(var t=0,n=w(e,"codedValues",[]);t<n.length;t++){var a=n[t];r.codedValues.push({name:w(a,"name",""),code:w(a,"code",null)})}}return r}function x(e){if(null===e)return null;var r={},t=w(e,"wkt",null);null!==t&&(r.wkt=t);var n=w(e,"wkid",null);return null!==n&&(r.wkid=n),r}function C(e){if(null===e)return null;var r={hasZ:w(e,"hasz",!1),hasM:w(e,"hasm",!1)},t=w(e,"spatialreference",null);t&&(r.spatialReference=x(t));var n=w(e,"x",null);if(null!==n)return r.x=n,r.y=w(e,"y",null),r;var a=w(e,"rings",null);if(null!==a)return r.rings=a,r;var i=w(e,"paths",null);if(null!==i)return r.paths=i,r;var l=w(e,"points",null);if(null!==l)return r.points=l,r;for(var s=0,o=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];s<o.length;s++){var u=o[s],f=w(e,u,null);null!==f&&(r[u]=f)}return r}function N(e,r){for(var t=0,n=r;t<n.length;t++){if(n[t]===e)return!0}return!1}function T(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==N(e.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&(!1!==o.isArray(e.layerDefinition.fields)&&!1!==o.isArray(e.featureSet.features)))))}function L(e){"async"===e.mode&&(e.functions.featuresetbyid=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){if(o.pcCheck(t,2,4),t[0]instanceof l){var n=o.toString(t[1]),a=o.defaultUndefined(t[2],null),i=o.toBoolean(o.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===o.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetById(n,i,a)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.featuresetbyportalitem=function(r,n){return e.standardFunctionAsync(r,n,function(e,n,a){if(o.pcCheck(a,2,5),null===a[0])throw new Error("Portal is required");if(a[0]instanceof t){var i=o.toString(a[1]),l=o.toString(a[2]),u=o.defaultUndefined(a[3],null),f=o.toBoolean(o.defaultUndefined(a[4],!0));if(null===u&&(u=["*"]),!1===o.isArray(u))throw new Error("Invalid Parameter");var d=null;return r.services&&r.services.portal&&(d=r.services.portal),d=s.getPortal(a[0],d),s.constructFeatureSetFromPortalItem(i,l,r.spatialReference,u,f,d,r.lrucache)}if(!1===o.isString(a[0]))throw new Error("Portal is required");var c=o.toString(a[0]),m=o.toString(a[1]),p=o.defaultUndefined(a[2],null),y=o.toBoolean(o.defaultUndefined(a[3],!0));if(null===p&&(p=["*"]),!1===o.isArray(p))throw new Error("Invalid Parameter");if(r.services&&r.services.portal)return s.constructFeatureSetFromPortalItem(c,m,r.spatialReference,p,y,r.services.portal,r.lrucache);throw new Error("Portal is required")})},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){if(o.pcCheck(t,2,4),t[0]instanceof l){var n=o.toString(t[1]),a=o.defaultUndefined(t[2],null),i=o.toBoolean(o.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===o.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetByName(n,i,a)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(r,t){return e.standardFunction(r,t,function(e,t,a){o.pcCheck(a,1,1);var i=a[0],l={layerDefinition:{geometryType:"",objectIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(o.isString(i))i=JSON.parse(i),void 0!==i.layerDefinition?(l.layerDefinition=i.layerDefinition,l.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(l.featureSet.features=i.features,l.featureSet.geometryType=i.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=i.objectIdFieldName,l.layerDefinition.typeIdField=i.typeIdFieldName,l.layerDefinition.fields=i.fields,i.spatialReference&&(l.layerDefinition.spatialReference=i.spatialReference));else{if(!(a[0]instanceof n))throw new Error("Invalid Parameter");i=JSON.parse(a[0].castToText());var s=w(i,"layerdefinition");if(null!==s){l.layerDefinition.geometryType=w(s,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=w(s,"objectidfield",""),l.layerDefinition.typeIdField=w(s,"typeidfield","");var u=w(s,"spatialreference",null);u&&(l.layerDefinition.spatialReference=x(u));for(var f=0,d=w(s,"fields",[]);f<d.length;f++){var c=d[f],m={name:w(c,"name",""),alias:w(c,"alias",""),type:w(c,"type",""),nullable:w(c,"nullable",!0),editable:w(c,"editable",!0),length:w(c,"length",null),domain:E(w(c,"domain"))};l.layerDefinition.fields.push(m)}var y=w(i,"featureset",null);if(y){for(var g={},h=0,v=l.layerDefinition.fields;h<v.length;h++){var F=v[h];g[F.name.toLowerCase()]=F.name}for(var I=0,S=w(y,"features",[]);I<S.length;I++){var A=S[I],b={},D=w(A,"attributes",{});for(var F in D)b[g[F.toLowerCase()]]=D[F];l.featureSet.features.push({attributes:b,geometry:C(w(A,"geometry",null))})}}}else{l.layerDefinition.geometryType=w(i,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=w(i,"objectidfieldname",""),l.layerDefinition.typeIdField=w(i,"typeidfieldname","");var u=w(i,"spatialreference",null);u&&(l.layerDefinition.spatialReference=x(u));for(var N=0,L=w(i,"fields",[]);N<L.length;N++){var c=L[N],m={name:w(c,"name",""),alias:w(c,"alias",""),type:w(c,"type",""),nullable:w(c,"nullable",!0),editable:w(c,"editable",!0),length:w(c,"length",null),domain:E(w(c,"domain"))};l.layerDefinition.fields.push(m)}for(var g={},R=0,k=l.layerDefinition.fields;R<k.length;R++){var F=k[R];g[F.name.toLowerCase()]=F.name}for(var O=0,P=w(i,"features",[]);O<P.length;O++){var A=P[O],b={},D=w(A,"attributes",{});for(var F in D)b[g[F.toLowerCase()]]=D[F];l.featureSet.features.push({attributes:b,geometry:C(w(A,"geometry",null))})}}}if(!1===T(l))throw new Error("Invalid Parameter");return p.create(l,r.spatialReference)})},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(r,t){return e.standardFunctionAsync(r,t,function(t,n,a){return o.pcCheck(a,2,2),o.isFeatureSet(a[0])?a[0].load().then(function(t){var n=I.WhereClause.create(a[1],t.getFieldsIndex()),i=n.getVariables();if(i.length>0){for(var l=[],s=0;s<i.length;s++){var o={name:i[s]};l.push(e.evaluateIdentifier(r,o))}return F.all(l).then(function(e){for(var r={},t=0;t<i.length;t++)r[i[t]]=e[t];return n.parameters=r,new f({parentfeatureset:a[0],whereclause:n})})}return F.resolve(new f({parentfeatureset:a[0],whereclause:n}))}):e.failDefferred("Filter cannot accept this parameter type")})},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(r,t){return e.standardFunctionAsync(r,t,function(r,t,n){if(o.pcCheck(n,2,2),o.isFeatureSet(n[0])){var a=new y(n[1]);return F.resolve(new d({parentfeatureset:n[0],orderbyclause:a}))}return e.failDefferred("Order cannot accept this parameter type")})},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(r,t){return e.standardFunctionAsync(r,t,function(r,t,n){return o.pcCheck(n,2,2),o.isFeatureSet(n[0])?F.resolve(new c({parentfeatureset:n[0],topnum:n[1]})):o.isArray(n[0])?o.toNumber(n[1])>=n[0].length?n[0].slice(0):n[0].slice(0,o.toNumber(n[1])):o.isImmutableArray(n[0])?o.toNumber(n[1])>=n[0].length()?n[0].slice(0):n[0].slice(0,o.toNumber(n[1])):e.failDefferred("Top cannot accept this parameter type")})},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){return o.pcCheck(t,1,1),o.isFeatureSet(t[0])?t[0].first(e.abortSignal).then(function(e){if(null!==e){var r=i.createFromGraphicLikeObject(e.geometry,e.attributes,t[0]);r._underlyingGraphic=e,e=r}return e}):o.isArray(t[0])?0===t[0].length?F.resolve(null):F.resolve(t[0][0]):o.isImmutableArray(t[0])?0===t[0].length()?F.resolve(null):F.resolve(t[0].get(0)):null})},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(r,t){return e.standardFunctionAsync(r,t,function(e,t,a){o.pcCheck(a,1,2);var l={minsize:-1,maxsize:-1,types:null};if(a.length>1)if(a[1]instanceof n){if(a[1].hasField("minsize")&&(l.minsize=o.toNumber(a[1].field("minsize"))),a[1].hasField("maxsize")&&(l.maxsize=o.toNumber(a[1].field("maxsize"))),a[1].hasField("types")){var u=o.toStringArray(a[1].field("types"),!1);u.length>0&&(l.types=u)}}else if(null!==a[1])throw new Error("Invalid Parameter");if(a[0]instanceof i){var f=a[0]._layer;return f instanceof S&&(f=s.constructFeatureSet(f,r.spatialReference,["*"],!0,r.lrucache)),null===f?[]:!1===o.isFeatureSet(f)?[]:f.load().then(function(){return f.queryAttachments(a[0].field(f.objectIdField),l.minsize,l.maxsize,l.types)})}if(null===a[0])return[];throw new Error("Invalid Parameter")})},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(r,t){return e.standardFunctionAsync(r,t,function(e,t,n){o.pcCheck(n,2,4);var a=n[0],l=o.toString(n[1]),u=o.defaultUndefined(n[2],null),f=o.toBoolean(o.defaultUndefined(n[3],!0));if(null===u&&(u=["*"]),!1===o.isArray(u))throw new Error("Invalid Parameter");if(null===n[0])return null;if(!(n[0]instanceof i))throw new Error("Invalid Parameter");var d=a._layer;return d instanceof S&&(d=s.constructFeatureSet(d,r.spatialReference,["*"],!0,r.lrucache)),null===d?null:!1===o.isFeatureSet(d)?null:d.load().then(function(e){var t=e.relationshipMetaData(),n=t.filter(function(e){return e.name===l});if(0===n.length)return null;if(void 0!==n[0].relationshipTableId&&null!==n[0].relationshipTableId&&n[0].relationshipTableId>-1)return s.constructFeatureSetFromRelationship(e,n[0],a.field(e.objectIdField),e.spatialReference,u,f,r.lrucache);var i=e.serviceUrl();return i?(i="/"===i.charAt(i.length-1)?i+n[0].relatedTableId.toString():i+"/"+n[0].relatedTableId.toString(),s.constructFeatureSetFromUrl(i,e.spatialReference,u,f,r.lrucache).then(function(r){return r.load().then(function(){return r.relationshipMetaData()}).then(function(t){if(t=t.filter(function(e){return e.id===n[0].id}),!1===a.hasField(n[0].keyField)||null===a.field(n[0].keyField))return e.getFeatureByObjectId(a.field(e.objectIdField),[n[0].keyField]).then(function(e){if(e){var a=I.WhereClause.create(t[0].keyField+"= @id",r.getFieldsIndex());return a.parameters={id:e.attributes[n[0].keyField]},r.filter(a)}return new m({parentfeatureset:r})});var i=I.WhereClause.create(t[0].keyField+"= @id",r.getFieldsIndex());return i.parameters={id:a.field(n[0].keyField)},r.filter(i)})})):null})})},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.featuresetbyassociation=function(r,t){return e.standardFunctionAsync(r,t,function(e,t,n){o.pcCheck(n,2,3);var a=n[0],l=o.toString(o.defaultUndefined(n[1],"")).toLowerCase(),f=o.isString(n[2])?o.toString(n[2]):null;if(null===n[0])return null;if(!(n[0]instanceof i))throw new Error("Invalid Parameter");var d=a._layer;return d instanceof S&&(d=s.constructFeatureSet(d,r.spatialReference,["*"],!0,r.lrucache)),null===d?null:!1===o.isFeatureSet(d)?null:d.load().then(function(){var e=d.serviceUrl();return s.constructAssociationMetaDataFeatureSetFromUrl(e,r.spatialReference)}).then(function(e){var r=null,t=null,n=!1;if(null!==f&&""!==f&&void 0!==f){for(var i=0,s=e.terminals;i<s.length;i++){var c=s[i];c.terminalName===f&&(t=c.terminalId)}null===t&&(n=!0)}for(var m=e.associations.getFieldsIndex(),p=m.get("TOGLOBALID").name,y=m.get("FROMGLOBALID").name,h=m.get("TOTERMINALID").name,v=m.get("FROMTERMINALID").name,F=m.get("FROMNETWORKSOURCEID").name,S=m.get("TONETWORKSOURCEID").name,b=m.get("ASSOCIATIONTYPE").name,D=m.get("ISCONTENTVISIBLE").name,w=m.get("OBJECTID").name,E=0,x=d.fields;E<x.length;E++){var C=x[E];if("global-id"===C.type){r=a.field(C.name);break}}var N=null,T={};for(var L in e.lkp)T[L]=e.lkp[L].sourceId;var R=new u.StringToCodeAdapted(new A({name:"classname",alias:"classname",type:"string"}),null,T),k="";switch(l){case"connected":var O=p+"='@T'",P=y+"='@T'";null!==t&&(O+=" AND "+h+"=@A",P+=" AND "+v+"=@A"),k="(("+O+") OR ("+P+"))",k=o.multiReplace(k,"@T",r),O=o.multiReplace(O,"@T",r),null!==t&&(O=o.multiReplace(O,"@A",t.toString()),k=o.multiReplace(k,"@A",t.toString())),R.codefield=I.WhereClause.create("CASE WHEN "+O+" THEN "+F+" ELSE "+S+" END",e.associations.getFieldsIndex());var M=g.cloneField(u.AdaptedFeatureSet.findField(e.associations.fields,y));M.name="globalid",M.alias="globalid",N=new u.SqlExpressionAdapted(M,I.WhereClause.create("CASE WHEN "+O+" THEN "+y+" ELSE "+p+" END",e.associations.getFieldsIndex()));break;case"container":k=p+"='"+r+"' AND "+b+" = 2",null!==t&&(k+=" AND "+h+" = "+t.toString()),R.codefield=F,k="( "+k+" )",N=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,y),"globalid","globalid");case"content":k="("+y+"='"+r+"' AND "+b+" = 2)",null!==t&&(k+=" AND "+v+" = "+t.toString()),R.codefield=S,k="( "+k+" )",N=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,p),"globalid","globalid");break;case"structure":k="("+p+"='"+r+"' AND "+b+" = 3)",null!==t&&(k+=" AND "+h+" = "+t.toString()),R.codefield=F,k="( "+k+" )",N=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,y),"globalid","globalId");break;case"attached":k="("+y+"='"+r+"' AND "+b+" = 3)",null!==t&&(k+=" AND "+v+" = "+t.toString()),R.codefield=S,k="( "+k+" )",N=new u.FieldRename(u.AdaptedFeatureSet.findField(e.associations.fields,p),"globalid","globalId");break;default:throw new Error("Invalid Parameter")}return n&&(k="1 <> 1"),new u.AdaptedFeatureSet({parentfeatureset:e.associations,adaptedFields:[new u.OriginalField(u.AdaptedFeatureSet.findField(e.associations.fields,w)),new u.OriginalField(u.AdaptedFeatureSet.findField(e.associations.fields,D)),N,R],extraFilter:k?I.WhereClause.create(k,e.associations.getFieldsIndex()):null})})})},e.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),e.functions.groupby=function(r,t){return e.standardFunctionAsync(r,t,function(t,n,i){return o.pcCheck(i,3,3),o.isFeatureSet(i[0])?i[0].load().then(function(t){var n=[],l=[],s=!1,u=[];if(o.isString(i[1]))u.push(i[1]);else if(i[1]instanceof a)u.push(i[1]);else if(o.isArray(i[1]))u=i[1];else{if(!o.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");u=i[1].toArray()}for(var f=0,d=u;f<d.length;f++){var c=d[f];if(o.isString(c)){var m=I.WhereClause.create(o.toString(c),t.getFieldsIndex()),p=!0===h.isSingleField(m)?o.toString(c):"%%%%FIELDNAME";n.push({name:p,expression:m}),"%%%%FIELDNAME"===p&&(s=!0)}else{if(!(c instanceof a))return e.failDefferred("Illegal Value: GroupBy");var y=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",m=c.hasField("expression")?c.field("expression"):"";if("%%%%FIELDNAME"===y&&(s=!0),!y)return e.failDefferred("Illegal Value: GroupBy");n.push({name:y,expression:I.WhereClause.create(m||y,t.getFieldsIndex())})}}if(u=[],o.isString(i[2]))u.push(i[2]);else if(o.isArray(i[2]))u=i[2];else if(o.isImmutableArray(i[2]))u=i[2].toArray();else{if(!(i[2]instanceof a))return e.failDefferred("Illegal Value: GroupBy");u.push(i[2])}for(var g=0,v=u;g<v.length;g++){var c=v[g];if(!(c instanceof a))return e.failDefferred("Illegal Value: GroupBy");var S=c.hasField("name")?c.field("name"):"",A=c.hasField("statistic")?c.field("statistic"):"",m=c.hasField("expression")?c.field("expression"):"";if(!S||!A||!m)return e.failDefferred("Illegal Value: GroupBy");l.push({name:S,statistic:A.toLowerCase(),expression:I.WhereClause.create(m,t.getFieldsIndex())})}if(s){for(var b={},w=0,E=t.fields;w<E.length;w++){var x=E[w];b[x.name.toLowerCase()]=1}for(var C=0,N=n;C<N.length;C++){var x=N[C];"%%%%FIELDNAME"!==x.name&&(b[x.name.toLowerCase()]=1)}for(var T=0,L=l;T<L.length;T++){var x=L[T];"%%%%FIELDNAME"!==x.name&&(b[x.name.toLowerCase()]=1)}for(var R=0,k=0,O=n;k<O.length;k++){var x=O[k];if("%%%%FIELDNAME"===x.name){for(;1===b["field_"+R.toString()];)R++;b["field_"+R.toString()]=1,x.name="FIELD_"+R.toString()}}}for(var P=[],M=0,B=n;M<B.length;M++){var U=B[M];P.push(D(U.expression,e,r))}for(var G=0,V=l;G<V.length;G++){var U=V[G];P.push(D(U.expression,e,r))}return P.length>0?F.all(P).then(function(){return F.resolve(i[0].groupby(n,l))}):F.resolve(i[0].groupby(n,l))}):e.failDefferred("Illegal Value: GroupBy")})},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(r,t){return e.standardFunctionAsync(r,t,function(t,n,i){return o.isFeatureSet(i[0])?(o.pcCheck(i,2,2),i[0].load().then(function(t){var n=[],l=[];if(o.isString(i[1]))l.push(i[1]);else if(i[1]instanceof a)l.push(i[1]);else if(o.isArray(i[1]))l=i[1];else{if(!o.isImmutableArray(i[1]))return e.failDefferred("Illegal Value: GroupBy");l=i[1].toArray()}for(var s=!1,u=0,f=l;u<f.length;u++){var d=f[u];if(o.isString(d)){var c=I.WhereClause.create(o.toString(d),t.getFieldsIndex()),m=!0===h.isSingleField(c)?o.toString(d):"%%%%FIELDNAME";n.push({name:m,expression:c}),"%%%%FIELDNAME"===m&&(s=!0)}else{if(!(d instanceof a))return e.failDefferred("Illegal Value: GroupBy");var p=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",c=d.hasField("expression")?d.field("expression"):"";if("%%%%FIELDNAME"===p&&(s=!0),!p)return e.failDefferred("Illegal Value: GroupBy");n.push({name:p,expression:I.WhereClause.create(c||p,t.getFieldsIndex())})}}if(s){for(var y={},g=0,v=t.fields;g<v.length;g++){var S=v[g];y[S.name.toLowerCase()]=1}for(var A=0,b=n;A<b.length;A++){var S=b[A];"%%%%FIELDNAME"!==S.name&&(y[S.name.toLowerCase()]=1)}for(var w=0,E=0,x=n;E<x.length;E++){var S=x[E];if("%%%%FIELDNAME"===S.name){for(;1===y["field_"+w.toString()];)w++;y["field_"+w.toString()]=1,S.name="FIELD_"+w.toString()}}}for(var C=[],N=0,T=n;N<T.length;N++){var L=T[N];C.push(D(L.expression,e,r))}return C.length>0?F.all(C).then(function(){return F.resolve(i[0].groupby(n,[]))}):F.resolve(i[0].groupby(n,[]))})):b("distinct",t,n,i)})})}Object.defineProperty(r,"__esModule",{value:!0}),r.registerFunctions=L});