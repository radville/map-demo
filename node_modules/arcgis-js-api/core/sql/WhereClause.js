// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../has","../iteratorUtils","./AggregateFunctions","./StandardizedFunctions","./WhereGrammar"],function(e,t,r,a,n,i,s){function l(e,t){return e+="",e.length>=t?e:new Array(t-e.length+1).join("0")+e}function u(e,t,r,a,n,i,s,u,o){if(void 0===r&&(r="0"),void 0===a&&(a="0"),void 0===n&&(n="0"),void 0===i&&(i="0"),void 0===s&&(s=""),void 0===u&&(u="0"),void 0===o&&(o="0"),"+"===s||"-"===s){var c=l(parseInt(e,10),4)+"-"+l(parseInt(t,10),2)+"-"+l(parseInt(r,10),2),p="";parseFloat(i)<10&&(p="0");var v=l(parseInt(a,10),2)+":"+l(parseInt(n,10),2)+":"+(p+parseFloat(i).toString()),d=""+s+l(parseInt(u,10),2)+":"+l(parseInt(o,10),2);return new Date(c+"T"+v+d)}return new Date(parseInt(e,10),parseInt(t,10),parseInt(r,10),parseInt(a,10),parseInt(n,10),parseFloat(i))}function o(e){var t=b.exec(e);if(null!==t){var r=t[1],a=t[2],n=t[3],i=t[4],s=t[5],l=t[6];return u(r,a,n,i,s,l)}if(null!==(t=J.exec(e))){var r=t[1],a=t[2],n=t[3],i=t[4],s=t[5],l=t[6],o=t[7],c=t[8],p=t[9];return u(r,a,n,i,s,l,o,c,p)}if(null!==(t=E.exec(e))){var r=t[1],a=t[2],n=t[3],i=t[4],s=t[5],o=t[6],c=t[7],p=t[8];return u(r,a,n,i,s,"0",o,c,p)}if(null!==(t=D.exec(e))){var r=t[1],a=t[2],n=t[3],i=t[4],s=t[5];return u(r,a,n,i,s)}if(null!==(t=A.exec(e))){var r=t[1],a=t[2],n=t[3];return u(r,a,n)}throw new Error("SQL Invalid Timestamp")}function c(e){var t=A.exec(e);if(null===t)throw new Error("SQL Invalid Date");var r=t[1],a=t[2],n=t[3];return new Date(parseInt(r,10),parseInt(a,10)-1,parseInt(n,10))}function p(e){return!0===e}function v(e){return Array.isArray(e)?e:[e]}function d(e){return null!==e?!0!==e:null}function h(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function f(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function N(e,t){if(null==e)return null;for(var r=!1,a=0,n=t;a<n.length;a++){var i=n[a];if(null==i)r=null;else if(e===i){r=!0;break}}return r}function g(e,t,r){if(null==e)return null;for(var a=t,n=r,i="",s="-[]/{}()*+?.\\^$|",l=0,u=0;u<a.length;u++){var o=a.charAt(u);switch(l){case 0:o===n?l=1:s.indexOf(o)>=0?i+="\\"+o:i+="%"===o?".*":"_"===o?".":o;break;case 1:s.indexOf(o)>=0?i+="\\"+o:i+=o,l=0}}return new RegExp("^"+i+"$").test(e)}function m(e){return e instanceof Date?e.valueOf():e}function T(e,t,r){if(null==t||null==r)return null;var a=m(t),n=m(r);switch(e){case"<>":return a!==n;case"=":return a===n;case">":return a>n;case"<":return a<n;case">=":return a>=n;case"<=":return a<=n}}function S(e){for(var t=[],r={},a=0,n=e;a<n.length;a++){var i=n[a],s=i.toLowerCase();void 0===r[s]&&(t.push(i),r[s]=1)}return t}function y(e,t,r){if(t instanceof i.SqlInterval)if(r instanceof Date)switch(e){case"+":return new Date(t.valueInMilliseconds()+r.getTime());case"-":return t.valueInMilliseconds()-r.getTime();case"*":return t.valueInMilliseconds()*r.getTime();case"/":return t.valueInMilliseconds()/r.getTime()}else if(r instanceof i.SqlInterval)switch(e){case"+":return i.SqlInterval.createFromMilliseconds(t.valueInMilliseconds()+r.valueInMilliseconds());case"-":return i.SqlInterval.createFromMilliseconds(t.valueInMilliseconds()-r.valueInMilliseconds());case"*":return t.valueInMilliseconds()*r.valueInMilliseconds();case"/":return t.valueInMilliseconds()/r.valueInMilliseconds()}else t=t.valueInMilliseconds();else if(r instanceof i.SqlInterval)if(t instanceof Date)switch(e){case"+":return new Date(r.valueInMilliseconds()+t.getTime());case"-":return new Date(t.getTime()-r.valueInMilliseconds());case"*":return t.getTime()*r.valueInMilliseconds();case"/":return t.getTime()/r.valueInMilliseconds()}else r=r.valueInMilliseconds();else if(t instanceof Date&&"number"==typeof r)switch(r=24*r*60*60*1e3,t=t.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}else if(r instanceof Date&&"number"==typeof t)switch(t=24*t*60*60*1e3,r=r.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}switch(e){case"+":return t+r;case"-":return t-r;case"*":return t*r;case"/":return t/r}}function I(e){return e&&"object"==typeof e.attributes}function w(e,t,r,a){var n=a.getAttribute(e,t);return null!=n&&1===r[t]?new Date(n):n}Object.defineProperty(t,"__esModule",{value:!0});var A=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,b=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)$/,J=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)(\+|\-)(\d{1,2}):(\d{1,2})$/,E=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})(\+|\-)(\d{1,2}):(\d{1,2})$/,D=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/,M=function(){function e(){}return e.makeBool=function(e){return p(e)},e.featureValue=function(e,t,r,a){return w(e,t,r,a)},e.equalsNull=function(e){return null===e},e.applyLike=function(e,t,r){return g(e,t,r)},e.ensureArray=function(e){return v(e)},e.applyIn=function(e,t){return N(e,t)},e.currentDate=function(){var e=new Date;return e.setHours(0,0,0,0),e},e.makeSqlInterval=function(e,t,r){return i.SqlInterval.createFromValueAndQualifer(e,t,r)},e.convertInterval=function(e){return e instanceof i.SqlInterval?e.valueInMilliseconds():e},e.currentTimestamp=function(){return new Date},e.compare=function(e,t,r){return T(e,t,r)},e.calculate=function(e,t,r){return y(e,t,r)},e.makeComparable=function(e){return m(e)},e.evaluateFunction=function(e,t){return i.evaluateFunction(e,t)},e.lookup=function(e,t){var r=t[e];return void 0===r?null:r},e.between=function(e,t){return null==e||null==t[0]||null==t[1]?null:e>=t[0]&&e<=t[1]},e.notbetween=function(e,t){return null==e||null==t[0]||null==t[1]?null:e<t[0]||e>t[1]},e.ternaryNot=function(e){return d(e)},e.ternaryAnd=function(e,t){return h(e,t)},e.ternaryOr=function(e,t){return f(e,t)},e}(),x=function(){function e(e,t){this.fieldsIndex=t,this.datefields={},this.parameters={},this.parseTree=s.WhereGrammar.parse(e);var r=this.extractExpressionInfo(t),a=r.isStandardized,n=r.isAggregate,i=r.referencedFieldNames;this.referencedFieldNames=i,this.isStandardized=a,this.isAggregate=n}return e.create=function(t,r){return new e(t,r)},Object.defineProperty(e.prototype,"fieldNames",{get:function(){return this.referencedFieldNames},enumerable:!0,configurable:!0}),e.prototype.testSet=function(e,r){void 0===r&&(r=t.defaultAttributeAdapter);for(var a={},n=0,i=this.fieldNames;n<i.length;n++){var s=i[n];!function(t){a[t]=e.map(function(e){return r.getAttribute(e,t)})}(s)}return!!this.evaluateNode(this.parseTree,{attributes:a},t.defaultAttributeAdapter)},e.prototype.calculateValue=function(e,r){void 0===r&&(r=t.defaultAttributeAdapter);var a=this.evaluateNode(this.parseTree,e,r);return a instanceof i.SqlInterval?a.valueInMilliseconds()/864e5:a},e.prototype.calculateValueCompiled=function(e,a){return void 0===a&&(a=t.defaultAttributeAdapter),null!=this.parseTree._compiledVersion?this.parseTree._compiledVersion(e,this.parameters,a,this.datefields):r("csp-restrictions")?this.calculateValue(e,a):(this.compileMe(),this.parseTree._compiledVersion(e,this.parameters,a,this.datefields))},e.prototype.testFeature=function(e,r){return void 0===r&&(r=t.defaultAttributeAdapter),!!this.evaluateNode(this.parseTree,e,r)},e.prototype.testFeatureCompiled=function(e,a){return void 0===a&&(a=t.defaultAttributeAdapter),void 0===this.parseTree._compiledVersion?!!this.parseTree._compiledVersion(e,this.parameters,a,this.datefields):r("csp-restrictions")?this.testFeature(e,a):(this.compileMe(),!!this.parseTree._compiledVersion(e,this.parameters,a,this.datefields))},e.prototype.getFunctions=function(){var e=[];return this.visitAll(this.parseTree,function(t){"function"===t.type&&e.push(t.name.toLowerCase())}),S(e)},e.prototype.getExpressions=function(){var e=new Map;return this.visitAll(this.parseTree,function(t){if("function"===t.type){var r=t.name.toLowerCase(),a=t.args.value[0];if("column_ref"===a.type){var n=a.column,i=r+"-"+n;e.has(i)||e.set(i,{aggregateType:r,field:n})}}}),a.valuesOfMap(e)},e.prototype.getVariables=function(){var e=[];return this.visitAll(this.parseTree,function(t){"param"===t.type&&e.push(t.value.toLowerCase())}),S(e)},e.prototype.compileMe=function(){var e="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=new Function("feature","lookups","attributeAdapter","datefields",e).bind(M)},e.prototype.extractExpressionInfo=function(e){var t=this,r=[],a=!0,s=!0;return this.visitAll(this.parseTree,function(l){switch(l.type){case"column_ref":var u=l.column.toUpperCase();if("CURRENT_DATE"!==u&&"CURRENT_TIMESTAMP"!==u){var o=e.get(l.column),c=o&&o.name;!o||"date"!==o.type&&"esriFieldTypeDate"!==o.type||(t.datefields[o.name]=1),void 0!==c?(r.push(c),l.column=c):r.push(l.column)}break;case"function":var p=l.name,v=l.args,d=v.value.length;a&&(a=i.isStandardized(p,d)),s&&(s=n.isAggregate(p,d))}}),{referencedFieldNames:S(r),isStandardized:a,isAggregate:s}},e.prototype.visitAll=function(e,t){if(null!=e)switch(t(e),e.type){case"when_clause":this.visitAll(e.operand,t),this.visitAll(e.value,t);break;case"case_expression":for(var r=0,a=e.clauses;r<a.length;r++){var n=a[r];this.visitAll(n,t)}"simple"===e.format&&this.visitAll(e.operand,t),null!==e.else&&this.visitAll(e.else,t);break;case"expr_list":for(var i=0,s=e.value;i<s.length;i++){var n=s[i];this.visitAll(n,t)}break;case"unary_expr":this.visitAll(e.expr,t);break;case"binary_expr":this.visitAll(e.left,t),this.visitAll(e.right,t);break;case"function":this.visitAll(e.args,t)}},e.prototype.evaluateNodeToJavaScript=function(e){switch(e.type){case"interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(e.value)+", "+JSON.stringify(e.qualifier)+","+JSON.stringify(e.op)+")";case"case_expression":var t="";if("simple"===e.format){var r="this.makeComparable("+this.evaluateNodeToJavaScript(e.operand)+")";t="( ";for(var a=0;a<e.clauses.length;a++)t+=" ("+r+" === this.makeComparable("+this.evaluateNodeToJavaScript(e.clauses[a].operand)+")) ? ("+this.evaluateNodeToJavaScript(e.clauses[a].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}else{t="( ";for(var a=0;a<e.clauses.length;a++)t+=" this.makeBool("+this.evaluateNodeToJavaScript(e.clauses[a].operand)+")===true ? ("+this.evaluateNodeToJavaScript(e.clauses[a].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}return t;case"param":return"this.lookup("+JSON.stringify(e.value.toLowerCase())+",lookups)";case"expr_list":for(var n="[",i=0,s=e.value;i<s.length;i++){var l=s[i];"["!==n&&(n+=","),n+=this.evaluateNodeToJavaScript(l)}return n+="]";case"unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(e.expr)+")";case"binary_expr":switch(e.operator){case"AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")))";case"IN":return"this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+"))";case"NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+")))";case"BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+")";case"NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+"))";case"<>":case"<":case">":case">=":case"<=":case"=":return"this.compare("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"*":case"-":case"+":case"/":return"this.calculate("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")"}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return JSON.stringify(e.value);case"date":return"(new Date("+c(e.value).getTime().toString()+"))";case"timestamp":return"(new Date("+o(e.value).getTime().toString()+"))";case"column_ref":return"CURRENT_DATE"===e.column.toUpperCase()?"this.currentDate()":"CURRENT_TIMESTAMP"===e.column.toUpperCase()?"this.currentTimestamp()":"this.featureValue(feature,"+JSON.stringify(e.column)+",datefields,attributeAdapter)";case"function":return"this.evaluateFunction("+JSON.stringify(e.name)+","+this.evaluateNodeToJavaScript(e.args)+")"}throw new Error("Unsupported sql syntax "+e.type)},e.prototype.evaluateNode=function(e,t,r){switch(e.type){case"interval":var a=this.evaluateNode(e.value,t,r);return i.SqlInterval.createFromValueAndQualifer(a,e.qualifier,e.op);case"case_expression":if("simple"===e.format){for(var s=m(this.evaluateNode(e.operand,t,r)),l=0;l<e.clauses.length;l++)if(s===m(this.evaluateNode(e.clauses[l].operand,t,r)))return this.evaluateNode(e.clauses[l].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}else{for(var l=0;l<e.clauses.length;l++)if(p(this.evaluateNode(e.clauses[l].operand,t,r)))return this.evaluateNode(e.clauses[l].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":for(var u=[],S=0,I=e.value;S<I.length;S++){var A=I[S];u.push(this.evaluateNode(A,t,r))}return u;case"unary_expr":return d(this.evaluateNode(e.expr,t,r));case"binary_expr":switch(e.operator){case"AND":return h(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"OR":return f(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,t,r);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,t,r);case"IN":var b=v(this.evaluateNode(e.right,t,r));return N(this.evaluateNode(e.left,t,r),b);case"NOT IN":var b=v(this.evaluateNode(e.right,t,r));return d(N(this.evaluateNode(e.left,t,r),b));case"BETWEEN":var J=this.evaluateNode(e.left,t,r),E=this.evaluateNode(e.right,t,r);return null==J||null==E[0]||null==E[1]?null:J>=m(E[0])&&J<=m(E[1]);case"NOTBETWEEN":var J=this.evaluateNode(e.left,t,r),E=this.evaluateNode(e.right,t,r);return null==J||null==E[0]||null==E[1]?null:J<m(E[0])||J>m(E[1]);case"LIKE":return g(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape);case"NOT LIKE":return d(g(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return T(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"-":case"+":case"*":case"/":return y(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r))}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return e.value;case"date":return c(e.value);case"timestamp":return o(e.value);case"column_ref":if("CURRENT_DATE"===e.column.toUpperCase()){var A=new Date;return A.setHours(0,0,0,0),A}return"CURRENT_TIMESTAMP"===e.column.toUpperCase()?new Date:w(t,e.column,this.datefields,r);case"function":var D=this.evaluateNode(e.args,t,r);return this.isAggregate?n.aggregateFunction(e.name,D):i.evaluateFunction(e.name,D)}throw new Error("Unsupported sql syntax "+e.type)},e}();t.WhereClause=x,t.defaultAttributeAdapter={getAttribute:function(e,t){return(I(e)?e.attributes:e)[t]}}});