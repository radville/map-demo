// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/CircularArray","../core/maybe","./geohashUtils"],function(t,e,i,a,o){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this._pool=new i.default(8024),this._nodes=0,this._root=new s(0,0,0),this._fields=t}return t.prototype._acquire=function(t,e,i){var o=this._pool.dequeue();return this._nodes++,a.isSome(o)?o.realloc(t,e,i):new s(t,e,i)},t.prototype._release=function(t){this._nodes--,this._pool.enqueue(t)},Object.defineProperty(t.prototype,"count",{get:function(){return this._root.count},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._nodes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"poolSize",{get:function(){return this._pool.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depth",{get:function(){var t=0;return this._forEachNode(function(e){return t=Math.max(t,e.depth)}),t},enumerable:!0,configurable:!0}),t.prototype.dropLevels=function(t){var e=this;this._forEachNode(function(i){if(i.depth>=t)for(var a=0;a<i.children.length;a++){var o=i.children[a];i.children[a]=null,o&&e._release(o)}})},t.prototype.insert=function(t,e,i){void 0===i&&(i=0);for(var a=this._root,o=0,n=0,s=0;null!==a;){if(a.depth>=i&&(a.count+=1,a.xTotal+=t.geometry.coords[0],a.yTotal+=t.geometry.coords[1],a.xGeohashTotal+=t.geohashX,a.yGeohashTotal+=t.geohashY,this._updateStatistics(t,a,1)),o>=e)return;var r=Math.ceil((o+1)/2),h=Math.floor((o+1)/2),l=1-o%2,c=30-(3*r+2*h),u=30-(2*r+3*h),d=7*l+3*(1-l)<<c,f=3*l+7*(1-l)<<u,p=8*l+4*(1-l),v=(t.geohashX&d)>>c,y=(t.geohashY&f)>>u,g=v+y*p,x=3*l+2*(1-l),_=2*l+3*(1-l);n=n<<x|v,s=s<<_|y,null==a.children[g]&&(a.children[g]=this._acquire(n,s,o+1)),o+=1,a=a.children[g]}},t.prototype.remove=function(t,e){for(var i=this._root,a=0;null!==i;){if(i.count-=1,i.xTotal-=t.geometry.coords[0],i.yTotal-=t.geometry.coords[1],i.xGeohashTotal-=t.geohashX,i.yGeohashTotal-=t.geohashY,this._updateStatistics(t,i,-1),a>=e)return;var o=Math.ceil((a+1)/2),n=Math.floor((a+1)/2),s=1-a%2,r=30-(3*o+2*n),h=30-(2*o+3*n),l=7*s+3*(1-s)<<r,c=3*s+7*(1-s)<<h,u=8*s+4*(1-s),d=(t.geohashX&l)>>r,f=(t.geohashY&c)>>h,p=d+f*u,v=i.children[p];1===v.count&&(this._release(v),i.children[p]=null),a+=1,i=v}},t.prototype.find=function(t,e,i){return this._root.find(t,e,i,0,0,0)},t.prototype.findSingleOccupancyNode=function(t,e,i,a,o){for(var n=this._root;null!==n;){var s=n.depth,r=n.xNode,h=n.yNode,l=1-s%2,c=n.xGeohashTotal/n.count,u=n.yGeohashTotal/n.count;if(1===n.count&&t<c&&c<=i&&e<u&&u<=a)return n;if(s>=o)n=n.next;else{for(var d=Math.ceil((s+1)/2),f=Math.floor((s+1)/2),p=30-(3*d+2*f),v=30-(2*d+3*f),y=~((1<<p)-1),g=~((1<<v)-1),x=(t&y)>>p,_=(e&g)>>v,m=(i&y)>>p,T=(a&g)>>v,N=3*l+2*(1-l),b=2*l+3*(1-l),S=r<<N,M=h<<b,G=S+8*l+4*(1-l),k=M+4*l+8*(1-l),z=Math.max(S,x),C=Math.max(M,_),F=Math.min(G,m),w=Math.min(k,T),P=null,O=null,X=C;X<=w;X++)for(var Y=z;Y<=F;Y++){var j=8*l+4*(1-l),q=Y-S+(X-M)*j,E=n.children[q];E&&(P||(P=E,P.next=n.next),O&&(O.next=E),O=E,E.next=n.next)}n=P||n.next}}return null},t.prototype.getRegionStatistics=function(t,e,i,a,o){for(var n=this._root,s=0,r=0,h=0,l={};null!==n;){var c=n.depth,u=n.xNode,d=n.yNode;if(c>=o){var f=n.xGeohashTotal/n.count,p=n.yGeohashTotal/n.count;t<f&&f<=i&&e<p&&p<=a&&(s+=n.count,r+=n.xTotal,h+=n.yTotal,this._aggregateStatistics(l,n.statistics)),n=n.next}else{for(var v=Math.ceil((c+1)/2),y=Math.floor((c+1)/2),g=1-c%2,x=30-(3*v+2*y),_=30-(2*v+3*y),m=~((1<<x)-1),T=~((1<<_)-1),N=(t&m)>>x,b=(e&T)>>_,S=(i&m)>>x,M=(a&T)>>_,G=3*g+2*(1-g),k=2*g+3*(1-g),z=u<<G,C=d<<k,F=z+8*g+4*(1-g),w=C+4*g+8*(1-g),P=Math.max(z,N),O=Math.max(C,b),X=Math.min(F,S),Y=Math.min(w,M),j=null,q=null,E=O;E<=Y;E++)for(var L=P;L<=X;L++){var A=8*g+4*(1-g),I=L-z+(E-C)*A,B=n.children[I];if(B){var R=E!==O&&E!==Y&&L!==P&&L!==X;if(R){var f=B.xGeohashTotal/B.count,p=B.yGeohashTotal/B.count;t<f&&f<=i&&e<p&&p<=a&&(s+=B.count,r+=B.xTotal,h+=B.yTotal,this._aggregateStatistics(l,B.statistics));continue}j||(j=B,j.next=n.next),q&&(q.next=B),q=B,B.next=n.next}}n=j||n.next}}return{count:s,attributes:this._normalizeStatistics(l,s),xTotal:r,yTotal:h}},t.prototype._forEachNode=function(t){for(var e=this._root;null!==e;){var i=this._linkChildren(e)||e.next;t(e),e=i}},t.prototype._linkChildren=function(t){for(var e=null,i=null,a=0;a<=t.children.length;a++){var o=t.children[a];o&&(e||(e=o,e.next=t.next),i&&(i.next=o),i=o,o.next=t.next)}return e},t.prototype._updateStatistics=function(t,e,i){for(var a=0,o=this._fields;a<o.length;a++){var n=o[a],s=n.name,r=n.outStatistic.onStatisticField,h=t.attributes[r];switch(n.outStatistic.statisticType){case"norm":e.statistics[s]||(e.statistics[s]={});var l=n.outStatistic.onStatisticNormalizationField,c=t.attributes[l],u=e.statistics[s].onStatisticField||0,d=e.statistics[s].onStatisticNormalizationField||0;null==h||isNaN(h)||null==c||0===c||isNaN(c)||(e.statistics[s].onStatisticField=u+i*h,e.statistics[s].onStatisticNormalizationField=d+i*c);break;case"avg":e.statistics[s]||(e.statistics[s]={value:0,nanCount:0});var f=e.statistics[s].value,p=e.statistics[s].nanCount;null==h||isNaN(h)?e.statistics[s].nanCount=p+i:e.statistics[s].value=f+i*h;break;case"avg_angle":e.statistics[s]||(e.statistics[s]={x:0,y:0,nanCount:0});var v=e.statistics[s].x,y=e.statistics[s].y,p=e.statistics[s].nanCount,g=Math.PI/180;null==h||isNaN(h)?e.statistics[s].nanCount=p+i:(e.statistics[s].x=v+i*Math.cos(h*g),e.statistics[s].y=y+i*Math.sin(h*g));break;case"mode":e.statistics[s]||(e.statistics[s]={});var f=e.statistics[s][h]||0;e.statistics[s][h]=f+i}}},t.prototype._aggregateStatistics=function(t,e){for(var i=0,a=this._fields;i<a.length;i++){var o=a[i],n=o.name;switch(o.outStatistic.statisticType){case"avg":case"avg_angle":case"mode":case"norm":t[n]||(t[n]={});for(var s in e[n]){var r=t[n][s]||0;t[n][s]=r+e[n][s]}}}},t.prototype._normalizeStatistics=function(t,e){for(var i={},a=0,o=this._fields;a<o.length;a++){var n=o[a],s=n.name;switch(n.outStatistic.statisticType){case"norm":var r=t[s];if(e&&null==r.onStatisticNormalizationField)break;if(e&&r.onStatisticNormalizationField){i[s]=r.onStatisticField/r.onStatisticNormalizationField;break}i[s]=0;break;case"avg":if(!e)break;var h=t[s],l=h.value,c=h.nanCount;if(!(e-c))break;i[s]=l/(e-c);break;case"avg_angle":if(!e)break;var u=t[s],d=u.x,f=u.y,c=u.nanCount;if(!(e-c))break;var p=d/(e-c),v=f/(e-c),y=180/Math.PI,g=Math.atan2(v,p)*y;i[s]=g;break;case"mode":var x=t[s],_=0,m=null;for(var T in x){var N=x[T];N>_&&(_=N,m=T)}i[s]="null"===m?null:m}}return i},t}();e.GeohashTree=n;var s=function(){function t(t,e,i){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var a=0;a<this.children.length;a++)this.children[a]=null;this.xNode=t,this.yNode=e,this.depth=i}return t.prototype.realloc=function(t,e,i){for(var a=0;a<this.children.length;a++)this.children[a]=null;return this.xNode=t,this.yNode=e,this.depth=i,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this},t.prototype.getLngLatBounds=function(){var t=this.depth,e=Math.ceil(t/2),i=Math.floor(t/2),a=30-(3*e+2*i),n=30-(2*e+3*i),s=this.xNode<<a,r=this.yNode<<n;return o.decodeGeohashXY({geohashX:s,geohashY:r},this.depth)},t.prototype.find=function(t,e,i,a,o,n){if(a>=i)return this;var s=1-a%2,r=3*s+2*(1-s),h=2*s+3*(1-s),l=30-o-r,c=30-n-h,u=7*s+3*(1-s)<<l,d=3*s+7*(1-s)<<c,f=8*s+4*(1-s),p=(t&u)>>l,v=(e&d)>>c,y=p+v*f,g=this.children[y];return null==g?null:g.find(t,e,i,a+1,o+r,n+h)},t}()});