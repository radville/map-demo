// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["./Credential","../core/domUtils","../core/has","../core/Error","../core/promiseUtils","../core/urlUtils","../intl/substitute","dijit/Dialog","dijit/registry","dojo/dom-attr","dojo/i18n!./nls/identity","dijit/form/Button"],function(e,t,i,r,o,n,s,a,l,d,u){var h=s.substitute;return{_oAuthIntervalId:0,_oAuthDialogContent:"<div class='dijitDialogPaneContentArea'><div style='padding-bottom: 5px; word-wrap: break-word;'>{oAuthInfo}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='esriErrorMsg' style='display: none; color: white; background-color: #D46464; text-align: center; padding-top: 3px; padding-bottom: 3px;'>{invalidUser}</div><div style='margin: 0px; padding: 0px; height: 10px;'></div><div class='dijitDialogPaneActionBar'><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdSubmit\"'>{lblOk}</button><button data-dojo-type='dijit.form.Button' data-dojo-props='type:\"button\", \"class\":\"esriIdCancel\"'>{lblCancel}</button></div>",setOAuthRedirectionHandler:function(e){this._oAuthRedirectFunc=e},oAuthSignIn:function(e,i,r,n){var s=this._oAuthDfd=o.createResolver();n&&n.signal&&o.onAbort(n.signal,function(){var e=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;e&&!e.closed?e.close():this.oAuthDialog&&this.oAuthDialog.onCancel()}.bind(this)),s.resUrl_=e,s.sinfo_=i,s.oinfo_=r;var a=!n||!1!==n.oAuthPopupConfirmation;if(!r.popup||!a)return this._doOAuthSignIn(e,i,r),s.promise;this._nls||(this._nls=u),this.oAuthDialog||(this.oAuthDialog=this._createOAuthDialog());var l=this.oAuthDialog,h=n&&n.error,c=n&&n.token;return t.hide(l.errMsg_),h&&h.details&&403==h.details.httpStatus&&c&&(d.set(l.errMsg_,"innerHTML",this._nls.forbidden),t.show(l.errMsg_)),d.set(l.serverLink_,{title:i.server,innerHTML:-1!==i.server.toLowerCase().indexOf("arcgis.com")?"ArcGIS Online":i.server}),l.show(),s.promise},setOAuthResponseHash:function(t){var i=this._oAuthDfd;if(this._oAuthDfd=null,i&&t){clearInterval(this._oAuthIntervalId),"#"===t.charAt(0)&&(t=t.substring(1));var o=n.queryToObject(t);if(o.error){var s="access_denied"===o.error,a=new r(s?"identity-manager:user-aborted":"identity-manager:authentication-failed",s?"ABORTED":"OAuth: "+o.error+" - "+o.error_description);i.reject(a)}else{var l=i.sinfo_,d=i.oinfo_,u=d._oAuthCred,h=new e({userId:o.username,server:l.server,token:o.access_token,expires:Date.now()+1e3*Number(o.expires_in),ssl:"true"===o.ssl,_oAuthCred:u});u.storage=o.persist?window.localStorage:window.sessionStorage,u.token=h.token,u.expires=h.expires,u.userId=h.userId,u.ssl=h.ssl,u.save(),i.resolve(h)}}},_createOAuthDialog:function(){var e=this._nls,i=h(this._oAuthDialogContent,e);i=h(i,{server:"<span class='serverLink' style='word-wrap: break-word;'></span>"});var o=new a({title:e.title,content:i,class:"esri-widget esriOAuthSignInDialog esriIdentityDialog",style:"min-width: 18em;",esriIdMgr_:this,execute_:function(){var e=o.esriIdMgr_._oAuthDfd;o.hide_(),o.esriIdMgr_._doOAuthSignIn(e.resUrl_,e.sinfo_,e.oinfo_)},cancel_:function(){var e=o.esriIdMgr_._oAuthDfd;o.esriIdMgr_._oAuthDfd=null,o.hide_();var t=new r("identity-manager:user-aborted","ABORTED");e.reject(t)},hide_:function(){t.hide(o.errMsg_),o.hide(),a._DialogLevelManager.hide(o)}}),n=o.domNode;return o.btnSubmit_=l.byNode(n.getElementsByClassName("esriIdSubmit")[0]),o.btnCancel_=l.byNode(n.getElementsByClassName("esriIdCancel")[0]),o.serverLink_=n.getElementsByClassName("serverLink")[0],o.errMsg_=n.getElementsByClassName("esriErrorMsg")[0],o.connect(o.btnSubmit_,"onClick",o.execute_),o.connect(o.btnCancel_,"onClick",o.onCancel),o.connect(o,"onCancel",o.cancel_),o},_doOAuthSignIn:function(e,t,o){var s=this,a={portalUrl:o.portalUrl};!o.popup&&o.preserveUrlHash&&window.location.hash&&(a.hash=window.location.hash);var l={client_id:o.appId,response_type:"token",state:JSON.stringify(a),expiration:o.expiration,locale:o.locale,redirect_uri:o.popup?n.makeAbsolute(o.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};o.forceLogin&&(l.force_login=!0);var d=o.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",u=d+"?"+n.objectToQuery(l);if(o.popup){var h;if(7===i("ie")?(h=window.open(o.popupCallbackUrl,"esriJSAPIOAuth",o.popupWindowFeatures),h.location=u):h=window.open(u,"esriJSAPIOAuth",o.popupWindowFeatures),h)h.focus(),this._oAuthDfd.oAuthWin_=h,this._oAuthIntervalId=setInterval(function(){if(h.closed){clearInterval(s._oAuthIntervalId);var e=s._oAuthDfd;if(e){var t=new r("identity-manager:user-aborted","ABORTED");e.reject(t)}}},500);else{var c=new r("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(c)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:l,authorizeUrl:d,resourceUrl:e,serverInfo:t,oAuthInfo:o}):window.location=u}}});