// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/Accessor","../../../core/arrayUtils","../../../core/Handles","../../../core/has","../../../core/Logger","../../../core/PooledArray","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../dehydratedFeatures","../../support/PromiseQueue","../../../views/3d/layers/i3s/I3SFrameTask","../../../views/3d/layers/i3s/I3SIndex","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SStreamDataController","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/support/projectionUtils","../../../views/support/layerViewUtils"],function(e,t,i,r,a,n,o,s,d,l,u,h,c,p,_,f,y,g,b,v,m,x,w,N,D,C,L,S,I){function P(e,t){return e.length===t.length&&e.every(function(e){return V(t,e.name)>=0})}function V(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}function O(e){return null!=e&&null!=e.loadedAttributes&&null!=e.attributeData}var A=d.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),F=function(e){function t(t){var i=e.call(this,t)||this;return i.screenSizeFactor=0,i.featureTarget=5e4,i.fixedFeatureTarget=!1,i.updating=!0,i.updatingProgress=1,i.leafsReached=!1,i.scaleVisibilityEnabled=!0,i.uncompressedTextureDownsamplingEnabled=!1,i._featureLOD=1,i._stableFeatureLOD=!1,i._isIdle=!1,i._cameraDirty=!0,i._invisibleDirty=!1,i._newLoadingNodes=new l({deallocator:null}),i._loadedNodeScales=new Map,i._abortController=h.createAbortController(),i._downloadingNodes=new Set,i._loadingNodeRevisions=new Map,i._nextLoadingNodeRevision=0,i._updatingNodes=new Set,i._progressMaxNumNodes=1,i._poi=f.vec3f64.create(),i._requiredAttributes=[],i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableIDBCache=!1,i.disableMemCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new o,i._idleQueue=new v.PromiseQueue,i._errorCount=0,i}return i(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataController",{get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new D.default(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return C.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return C.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._index&&this._index.rootNode;return!e||(this._updateViewData(),this._index.isNodeVisible(e.index))},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._lodHandling=new w(this.layerView);var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=s("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var i=h.all([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var i=e.layerView.view;e._setClippingArea(i.clippingArea),e._centerOnSurface=i.pointsOfInterest.centerOnSurfaceFrequent;var r=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}),r.memoryController.events.on("quality-changed",function(){return e._setCameraDirty()}),c.init(e.layerView,"suspended",function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},a=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=a):e._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(i,a)}),m.addTask(e.layerView.view.resourceController.scheduler,{update:function(t,i){return e._frame(t,i)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",function(){return e.restartNodeLoading()}),e.watch(["featureTarget","fixedFeatureTarget"],function(){e._setCameraDirty(),e._stableFeatureLOD=!1}),i.state.watch("camera",function(){return e._setCameraDirty()}),e.layer.watch("elevationInfo",function(){return e._elevationInfoChanged()}),e.layer.watch(["minScale","maxScale"],function(){return e._scaleBoundsChanged()}),e.layerView.watch("lodFactor",function(){return e._setCameraDirty()}),e.layerView.watch("availableFields?",function(){return e._requiredFieldsChange()})]),e._updateScaleHandles(),e._viewportQueries=new L(e.crsIndex,i.renderCoordsHelper,i.state.camera,e._clippingArea,i.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new x.I3SIndex(t,e.streamDataController,e._viewportQueries,A,function(t){return e.layerView.isNodeLoaded(t)},function(t){return e._shouldLoadNode(t)},function(t){return e._enableFromGPUCache(t,"leaf")},function(t){return e._needsUpdate(t)},function(){return!e.streamDataController.busy})}});this._tmpPoint=b.makeDehydratedPoint(0,0,0,this.crsIndex),this.addResolvingPromise(i),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this._abortController.abort(),this._abortController=null,this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,U.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map(function(i){var r=V(e,i),a=V(t,i);return r>=0&&a>=0?{index:r,name:t[a].name,field:t[a],attributeStorageInfo:e[r]}:null}).filter(function(e){return null!=e&&e.name!==i})},t.prototype._requiredFieldsChange=function(){P(this._requiredAttributes,this._getRequiredAttributes())||this.requestUpdate()},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._setClippingArea=function(e){var t=y.create();S.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&this.camPos&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=M.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,i=f.vec3f64.create();_.vec3.subtract(i,t,this.camPos);var r=this.layerView.view.renderCoordsHelper,a=f.vec3f64.create();r.worldUpAtPosition(t,a);var n=_.vec3.angle(a,i)-.5*Math.PI;return _.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,n/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this._setClippingArea(e),this._viewportQueries&&this._index&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype.updateElevationChanged=function(e,t){if(null!=this._index){null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new l({deallocator:null}));var i=this._elevationUpdateNodes;i.clear();var r=this._index.rootNode;null!=r&&C.findIntersectingNodes(e,t,r,this.crsIndex,this._index,function(e){return i.push(e.index)});for(var a=0;a<i.length;a++){var n=i.data[a];this._index.invalidateBoundingVolumeCache(n),n===r.index&&this.notifyChange("rootNodeVisible")}i.length&&this.restartNodeLoading()}},t.prototype.getParentIndex=function(e){return this._index.getParentIndex(e)},t.prototype._elevationInfoChanged=function(){this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype._updateScaleHandles=function(){var e=this;this._handles.remove("scale-bounds"),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",function(t){return e._scaleUpdateHandler(t)}),"scale-bounds")},t.prototype._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()},t.prototype._scaleUpdateHandler=function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()},t.prototype._updateScaleInBoundingRect=function(e,t,i){var r=this;null!=this._index.rootNode&&S.boundingRectToBoundingRect(t,i,T,this.crsIndex)&&this._loadedNodeScales.forEach(function(t,i){var a=r._index.getNode(i);g.containsPoint(T,a.mbs)&&r._loadedNodeScales.set(i,e)})},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()},t.prototype.schedule=function(e,t){var i=this;return this._idleQueue.push(t).then(function(t){if(!i._loadingNodeRevisions.has(e)&&!i._updatingNodes.has(e))throw h.createAbortError();return t})},t.prototype.reschedule=function(e,t){var i=this;return this._idleQueue.unshift(t).then(function(t){if(!i._loadingNodeRevisions.has(e)&&!i._updatingNodes.has(e))throw h.createAbortError();return t})},Object.defineProperty(t.prototype,"isIntegratedMesh",{get:function(){return"integrated-mesh"===this.layer.type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"areScaleBoundsActive",{get:function(){var e=I.extractSafeScaleBounds(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexDepth",{get:function(){return this._index?this._index.maxLevel:0},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):this.layerView.visible?(this._processLogError(e,t),this._index.getPriority()):-1/0},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?A.error("Error during processing: "+e):50===this._errorCount&&A.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var i=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run(function(){return i._processIndex(e)}),this._updateFeatureLOD(),e.run(function(){return i._processCache(e)}),this.isIntegratedMesh&&(e.enabled=!0),e.run(function(){return i._processNodes(e,t)});!e.done&&this._idleQueue.process();)e.madeProgress();e.run(function(){return i._prefetchIndex()}),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingNodes.size,e.run(function(){return i._lodHandling.lodGlobalHandling(e)}),this._evaluateUpdating()}},t.prototype._processIndex=function(e){if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(n.keysOfMap(this._loadingNodeRevisions),e),!this.disableMemCache&&this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData&&(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var t=this._index.getFeatureEstimate().leafsReached;this._index.isLoading()||t===this._get("leafsReached")||this._set("leafsReached",t)}return this._index.load()},t.prototype._prefetchIndex=function(){return!(this._loadingNodeRevisions.size>0||this._index.updates.add.length>0)&&this._index.prefetch()},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.getFeatureEstimate();if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var a=this.lod,n=this._index.checkFeatureTarget(t,a);n!==a&&(this._featureLOD=n/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processCache=function(e){for(;this._newLoadingNodes.length>0&&!e.done;)for(var t=this._newLoadingNodes.pop(),i=this._index.getParent(t);i&&(!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i));i=this._index.getParent(i.index))if(this._enableFromGPUCache(i,"hole")){e.madeProgress();break}return e.hasProgressed},t.prototype._processNodes=function(e,t){var i=(this._isIdle?100:2)-this._loadingNodeRevisions.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.update.length>0&&!e.done;){var a=this._index.getNode(r.update.pop());this._updateLoadedNode(a),e.madeProgress()}for(;r.add.length>0&&!e.done&&i>0;){--i;var a=this._index.getNode(r.add.back());if(2!==a.cacheState&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed},t.prototype._cancelAllNodes=function(){this._loadingNodeRevisions.clear(),this._downloadingNodes.clear(),this._updatingNodes.clear(),this._abortController.abort(),this._abortController=new AbortController},t.prototype._cancelNode=function(e){this._loadingNodeRevisions.delete(e),this._downloadingNodes.delete(e)},t.prototype._hasNodeLoadToken=function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodeRevisions.size>=2)&&!this.streamDataController.busy},t.prototype._evaluateUpdating=function(){var e=!1,t=0;if(this.layerView.suspended)e=this._cameraDirty,t=e?.5:1;else{var i=this._index?this._index.getIndexMissing():0,r=this._index?this._index.updates.add.length:0,a=i+3*r+2*this._loadingNodeRevisions.size;e=!!(a>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===a&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(a,this._progressMaxNumNodes),t=1-a/this._progressMaxNumNodes}e!==this.updating&&this._set("updating",e),t!==this.updatingProgress&&this._set("updatingProgress",t)},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var e=this.layerView.view,t=e.state.camera;this.camPos=f.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=M.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return this._index.isGeometryVisible(e.index)},t.prototype.updateVisibility=function(e){return this._index.invalidateVisibilityCache(e)},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&(!e.obb||this._index.isGeometryVisible(e.index))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.childrenEmpty(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataController){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var t=N.TextureFormat.Normal;this.layerView.useCompressedTextures?t=N.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(t=N.TextureFormat.Downsampled);var i={textureFormat:t,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new N(this.layer,this.streamDataController,A,this._defaultGeometrySchema,this._requiredAttributes,i),this._index.requestUpdate(),this._lodHandling.startNodeLoading(function(t){return e._index.isNodeVisible(t)},function(t){return e._index.isGeometryVisible(t)},function(t){return e._isNodeInScaleBounds(t)},function(t){return e._index.nodeTraversalState(t)},function(t,i){return e._removeNodes(t,i)},this._index,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this.streamDataController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())},t.prototype._removeInvisibleNodes=function(e){var t=this;U.clear(),this.layerView.getLoadedNodeIndices(U);var i=0===this._viewportQueries.maxDistance,r=i?function(){return!1}:function(e){return t._shouldDropNode(e)};return U.filterInPlace(function(e){var i=t._index.getNode(e);return!t._index.isGeometryVisible(e)||r(i)||!t._isNodeInScaleBounds(i)}),U.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(U,e),!(i&&this.lodDropFactor<1)&&(0===U.length||(U.clear(),!1))},t.prototype._removeNodes=function(e,t){e.length>0&&this._index.requestUpdate();var i=e.length;if(this.layerView.removeNodeData(e,t),this._loadedNodeScales.size>0)for(var r=e.length;r<i;r++){var a=e.data[r];this._loadedNodeScales.delete(a)}},t.prototype._needsUpdate=function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,i=this.layerView.getLoadedAttributes(e.index),r=P(i,this._requiredAttributes)?h.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,this._abortController.signal);this._updatingNodes.add(e.index),r.then(function(i){return t.schedule(e.index).then(function(){return t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:i})})}).catch(function(i){h.isAbortError(i)||t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()}),this._evaluateUpdating()},t.prototype._loadNode=function(e){var t=this,i=this._nextLoadingNodeRevision++;this._loadingNodeRevisions.set(e.index,i),this._evaluateUpdating(),this._loadAndAddNode(e).catch(function(e){return e}).then(function(){t._loadingNodeRevisions.get(e.index)===i&&t._loadingNodeRevisions.delete(e.index),t._evaluateUpdating()})},t.prototype._loadAndAddNode=function(e){var t=this;return 1===e.cacheState?this._loadUncached(e):this._loadCached(e).then(function(i){i||(e.cacheState=1,t._index.updates.add.push(e.index))}).catch(function(t){h.isAbortError(t)||(e.cacheState=1)})},t.prototype._enableFromGPUCache=function(e,t){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)},t.prototype._loadCachedGPUData=function(e){var t=this.layerView.loadCachedGPUData(e);return t&&O(t.attributeInfo)&&P(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:null},t.prototype._nodeAdded=function(){this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype._loadCached=function(e){var t=this;if(this._enableFromGPUCache(e,"leaf"))return h.resolve(!0);var i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule(e.index).then(function(){return i.loadCachedNodeData(e,t._abortController.signal,function(i,r){return t._nodeLoader.loadTextures(e,i,r)})}).then(function(r){if(null==r)return!1;var a=t._requiredAttributes;return O(r)&&P(r.loadedAttributes,a)?t.reschedule(e.index).then(function(){return i.addCachedNodeData(e,r,r)}).then(function(){return t._nodeAdded(),!0}):t.reschedule(e.index).then(function(){return t._nodeLoader.loadAttributes(e,a,t._abortController.signal)}).then(function(i){return t.reschedule(e.index,{loadedAttributes:a,attributeData:i})}).then(function(t){return i.addCachedNodeData(e,r,t)}).then(function(){return t._nodeAdded(),!0})}):h.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this._downloadingNodes.add(e.index),this._nodeLoader.loadNodeData(e,this._abortController.signal).then(function(i){return t._downloadingNodes.delete(e.index),t.schedule(e.index,i)}).then(function(i){return t.layerView.addNodeData(e,i)}).then(function(){t._nodeAdded(),e.cacheState=2}).catch(function(i){h.isAbortError(i)||(A.error("Failed to load node '"+e.id+"': "+i),e.failed=!0,t._index.requestUpdate())})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&this._index.resetFailedNodes())},t.prototype._getScale=function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);var t=e.mbs;this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2];var i=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,i),i},t.prototype._isNodeInScaleBounds=function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),i=I.extractSafeScaleBounds(this.layer),r=i.minScale,a=i.maxScale;return I.scaleBoundsPredicate(t,r,a)},t.prototype.updateStats=function(e){e.index=this._index?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),this._index&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){e._index.ignoreServiceOBB=t}}},enumerable:!0,configurable:!0}),r([p.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),r([p.property({readOnly:!0})],t.prototype,"isGraphics3D",null),r([p.property({readOnly:!0})],t.prototype,"streamDataController",null),r([p.property({readOnly:!0})],t.prototype,"crsVertex",null),r([p.property({readOnly:!0})],t.prototype,"crsIndex",null),r([p.property()],t.prototype,"camPos",void 0),r([p.property()],t.prototype,"screenSizeFactor",void 0),r([p.property()],t.prototype,"featureTarget",void 0),r([p.property()],t.prototype,"fixedFeatureTarget",void 0),r([p.property()],t.prototype,"layerView",void 0),r([p.property()],t.prototype,"layer",void 0),r([p.property({readOnly:!0})],t.prototype,"updating",void 0),r([p.property({readOnly:!0})],t.prototype,"updatingProgress",void 0),r([p.property({readOnly:!0})],t.prototype,"leafsReached",void 0),r([p.property({constructOnly:!0})],t.prototype,"scaleVisibilityEnabled",void 0),r([p.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),r([p.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),t=r([p.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(p.declared(u.EsriPromiseMixin(a))),U=new l({deallocator:null}),M={factorIM:.2,factor3dObject:.05,distancePenalty:10},T=g.create();return F});