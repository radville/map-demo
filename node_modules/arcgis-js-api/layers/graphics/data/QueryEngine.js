// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/Error","../../../core/iteratorUtils","../../../core/lang","../../../core/Logger","../../../core/MemCache","../../../core/promiseUtils","../../../core/unitUtils","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/boundsUtils","../../../geometry/support/jsonUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./spatialQuerySupport","./timeSupport","./utils","../../support/FieldsIndex","../../support/PromiseQueue"],function(e,t,r,n,i,s,u,a,o,c,h,l,f,d,p,y,m,_,g,x,S,Q,v,E,b,R){Object.defineProperty(t,"__esModule",{value:!0});var F=o.getLogger("esri.layers.graphics.data.QueryEngine"),I=function(){function e(e,t,r,n,i){void 0===t&&(t=null),this.attributes=e,this.geometry=r,this.centroid=n,this.filterFlags=i,this.groupId=-1,this.localId=t}return e}();t.Feature=I;var w=new Set,T=new c.MemCacheStorage(2e6),C=0,P=function(){function e(e){var t=this;this.capabilities={query:x.queryCapabilities},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.cacheSpatialQueries=e.cacheSpatialQueries||!1,this.featureStore=e.featureStore,this._changeHandle=this.featureStore.events.on("changed",function(){return t.clearCache()}),this.timeInfo=e.timeInfo,this.cacheSpatialQueries&&(this._geometryQueryCache=new c.MemCache(C+++"$$",T)),this.fieldsIndex=new b(e.fields),e.scheduler&&e.task&&(this._frameQueue=new R.PromiseQueue,this._frameTask=e.scheduler.registerTask(e.task,function(e){return t._update(e)},function(){return t._frameQueue.length>0}))}return e.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null),this.fieldsIndex.destroy()},Object.defineProperty(e.prototype,"featureAdapter",{get:function(){return this.featureStore.featureAdapter},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullExtent",{get:function(){var e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:E.cleanFromGeometryEngine(this.spatialReference)}:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeExtent",{get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:(this._timeExtent=v.getTimeExtent(this.timeInfo,this.featureStore),this._timeExtent):null},enumerable:!0,configurable:!0}),e.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null},e.prototype.executeQuery=function(e,t){return void 0===e&&(e={}),i(this,void 0,void 0,function(){var t,r,i;return n(this,function(n){switch(n.label){case 0:t=a.clone(e),n.label=1;case 1:return n.trys.push([1,14,,15]),[4,this._schedule()];case 2:return n.sent(),[4,E.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 3:return t=n.sent(),[4,this._reschedule()];case 4:return n.sent(),[4,this._checkQuerySupport(t)];case 5:return t=n.sent(),[4,this._reschedule()];case 6:return n.sent(),[4,this._executeGeometryQuery(t)];case 7:return r=n.sent(),[4,this._reschedule()];case 8:return n.sent(),[4,r.executeObjectIdsQuery(t)];case 9:return r=n.sent(),[4,this._reschedule()];case 10:return n.sent(),[4,r.executeTimeQuery(t)];case 11:return r=n.sent(),[4,this._reschedule()];case 12:return n.sent(),[4,r.executeAttributesQuery(t)];case 13:return r=n.sent(),[3,15];case 14:if((i=n.sent())!==E.QUERY_ENGINE_EMPTY_RESULT)throw i;return r=new S.default([],null,this),[3,15];case 15:return[2,r.createQueryResponse(t)]}})})},e.prototype.executeQueryForCount=function(e,t){return void 0===e&&(e={}),i(this,void 0,void 0,function(){var t,r,i;return n(this,function(n){switch(n.label){case 0:t=a.clone(e),t.returnGeometry=!1,t.returnCentroid=!1,t.outSR=null,n.label=1;case 1:return n.trys.push([1,14,,15]),[4,this._schedule()];case 2:return n.sent(),[4,E.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 3:return t=n.sent(),[4,this._reschedule()];case 4:return n.sent(),[4,this._checkQuerySupport(t)];case 5:return t=n.sent(),[4,this._reschedule()];case 6:return n.sent(),[4,this._executeGeometryQuery(t)];case 7:return r=n.sent(),[4,this._reschedule()];case 8:return n.sent(),[4,r.executeObjectIdsQuery(t)];case 9:return r=n.sent(),[4,this._reschedule()];case 10:return n.sent(),[4,r.executeTimeQuery(t)];case 11:return r=n.sent(),[4,this._reschedule()];case 12:return n.sent(),[4,r.executeAttributesQuery(t)];case 13:return r=n.sent(),[2,r.size];case 14:if((i=n.sent())!==E.QUERY_ENGINE_EMPTY_RESULT)throw i;return[2,0];case 15:return[2]}})})},e.prototype.executeQueryForExtent=function(e,t){return void 0===e&&(e={}),i(this,void 0,void 0,function(){var t,r,i,s,u,o,c,c,c,h;return n(this,function(n){switch(n.label){case 0:t=a.clone(e),i=t.outSR,n.label=1;case 1:return n.trys.push([1,14,,15]),[4,this._schedule()];case 2:return n.sent(),[4,E.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 3:return t=n.sent(),[4,this._reschedule()];case 4:return n.sent(),[4,this._checkQuerySupport(t)];case 5:return t=n.sent(),t.returnGeometry=!0,t.returnCentroid=!1,t.outSR=null,[4,this._reschedule()];case 6:return n.sent(),[4,this._executeGeometryQuery(t)];case 7:return r=n.sent(),[4,this._reschedule()];case 8:return n.sent(),[4,r.executeObjectIdsQuery(t)];case 9:return r=n.sent(),[4,this._reschedule()];case 10:return n.sent(),[4,r.executeTimeQuery(t)];case 11:return r=n.sent(),[4,this._reschedule()];case 12:return n.sent(),[4,r.executeAttributesQuery(t)];case 13:return r=n.sent(),(s=r.size)?(f.set(A,f.NEGATIVE_INFINITY),this.featureStore.forEachBounds(r.items,function(e){return f.expand(A,e)},z),u={xmin:A[0],ymin:A[1],xmax:A[3],ymax:A[4],spatialReference:E.cleanFromGeometryEngine(this.spatialReference)},this.hasZ&&isFinite(A[2])&&isFinite(A[5])&&(u.zmin=A[2],u.zmax=A[5]),o=g.project(u,r.spatialReference,i),o.spatialReference=E.cleanFromGeometryEngine(i||this.spatialReference),o.xmax-o.xmin==0&&(c=l.getMetersPerUnitForSR(o.spatialReference),o.xmin-=c,o.xmax+=c),o.ymax-o.ymin==0&&(c=l.getMetersPerUnitForSR(o.spatialReference),o.ymin-=c,o.ymax+=c),this.hasZ&&null!=o.zmin&&null!=o.zmax&&o.zmax-o.zmin==0&&(c=l.getMetersPerUnitForSR(o.spatialReference),o.zmin-=c,o.zmax+=c),[2,{count:s,extent:o}]):[2,{count:s,extent:null}];case 14:if((h=n.sent())===E.QUERY_ENGINE_EMPTY_RESULT)return[2,{count:0,extent:null}];throw h;case 15:return[2]}})})},e.prototype.executeQueryForIds=function(e,t){return void 0===e&&(e={}),i(this,void 0,void 0,function(){return n(this,function(r){return[2,this.executeQueryForIdSet(e,t).then(function(e){return u.valuesOfSet(e)})]})})},e.prototype.executeQueryForIdSet=function(e,t){return void 0===e&&(e={}),i(this,void 0,void 0,function(){var t,r,i,s,u,o,c,h;return n(this,function(n){switch(n.label){case 0:t=a.clone(e),t.returnGeometry=!1,t.returnCentroid=!1,t.outSR=null,n.label=1;case 1:return n.trys.push([1,13,,14]),[4,this._schedule()];case 2:return n.sent(),[4,E.normalizeQuery(t,this.definitionExpression,this.spatialReference)];case 3:return t=n.sent(),[4,this._reschedule()];case 4:return n.sent(),[4,this._executeGeometryQuery(t)];case 5:return r=n.sent(),[4,this._reschedule()];case 6:return n.sent(),[4,r.executeObjectIdsQuery(t)];case 7:return r=n.sent(),[4,this._reschedule()];case 8:return n.sent(),[4,r.executeTimeQuery(t)];case 9:return r=n.sent(),[4,this._reschedule()];case 10:return n.sent(),[4,r.executeAttributesQuery(t)];case 11:return r=n.sent(),[4,this._reschedule()];case 12:for(n.sent(),i=r.items,s=new Set,u=0,o=i;u<o.length;u++)c=o[u],s.add(r.featureAdapter.getObjectId(c));return[2,s];case 13:if((h=n.sent())===E.QUERY_ENGINE_EMPTY_RESULT)return[2,new Set];throw h;case 14:return[2]}})})},e.prototype.executeQueryForLatestObservations=function(e,t){var r=this;return this.timeInfo?this.executeQuery(e,t).then(function(e){return r._filterLatest(e,r.timeInfo)}):void F.error(new s("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))},e.prototype._schedule=function(e){return i(this,void 0,void 0,function(){return n(this,function(t){return this._frameQueue?[2,this._frameQueue.push(e).then(function(e){return e})]:[2,e]})})},e.prototype._reschedule=function(e){return i(this,void 0,void 0,function(){return n(this,function(t){return this._frameQueue?[2,this._frameQueue.unshift(e).then(function(e){return e})]:[2,e]})})},e.prototype._update=function(e){for(this._budget=e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null},e.prototype._filterLatest=function(e,t){for(var n=t.trackIdField,i=t.startTimeField,s=t.endTimeField,u=s||i,a=new Map,o=[],c=0,h=e.features;c<h.length;c++){var l=h[c],f=l.attributes[n],d=l.attributes[u];(!a.has(f)||a.get(f).attributes[u]<d)&&a.set(f,l)}return a.forEach(function(e){return o.push(e)}),r({},e,{features:o})},e.prototype._getAll=function(){if(!this._allItems){var e=[];this.featureStore.forEach(function(t){return e.push(t)}),this._allItems=new S.default(e,null,this)}return this._allItems},e.prototype._executeGeometryQuery=function(e){return i(this,void 0,void 0,function(){var t,r,s,u,a,o,c,h,l,f,d,p,y,_,g,x,v,E,b,R,F,b,I,w,T,C=this;return n(this,function(P){switch(P.label){case 0:if(t=e.geometry,r=e.outSR,s=e.spatialRel,u=m.isValid(r)&&!m.equals(this.spatialReference,r),(a=this.cacheSpatialQueries?u?JSON.stringify({geometry:t,spatialRelationship:s,outSpatialReference:r}):JSON.stringify({geometry:t,spatialRelationship:s}):null)&&void 0!==(o=this._geometryQueryCache.get(a)))return[2,o];if(c=function(t){return i(C,void 0,void 0,function(){var i;return n(this,function(n){switch(n.label){case 0:return u&&(e.returnGeometry||e.returnCentroid)?[4,t.project(r)]:[3,2];case 1:return i=n.sent(),a&&this._geometryQueryCache.put(a,i,i.size||1),[2,i];case 2:return a&&this._geometryQueryCache.put(a,t,t.size||1),[2,t]}})})},!t)return[2,c(this._getAll())];if(h=this.featureAdapter,"esriSpatialRelDisjoint"!==s)return[3,5];if(l=this._searchFeatures(this._getQueryBBoxes(t)),!l.length)return[2,c(this._getAll())];for(p=new Set,y=0,_=l;y<_.length;y++)g=_[y],p.add(h.getObjectId(g));return[4,this._reschedule(p)];case 1:return p=P.sent(),x=0,f=new Array(p.size),this.featureStore.forEach(function(e){return f[x++]=e}),d=p,[4,this._reschedule()];case 2:return P.sent(),[4,Q.getSpatialQueryOperator(s,t,this)];case 3:return v=P.sent(),E=function(e){return!d.has(h.getObjectId(e))||v(h.getGeometry(e))},R=S.default.bind,[4,this._runSpatialFilter(f,E)];case 4:return b=new(R.apply(S.default,[void 0,P.sent(),t,this])),[2,c(b)];case 5:return F=this._searchFeatures(this._getQueryBBoxes(t)),F.length?(I=this._canExecuteSoloPass(t,e),I?[2,c(new S.default(F,t,this))]:[4,Q.getSpatialQueryOperator(s,t,this)]):(b=new S.default([],t,this),a&&this._geometryQueryCache.put(a,b,b.size||1),[2,b]);case 6:return w=P.sent(),[4,this._runSpatialFilter(F,function(e){return w(h.getGeometry(e))})];case 7:return T=P.sent(),[2,c(new S.default(T,t,this))]}})})},e.prototype._runSpatialFilter=function(e,t){return i(this,void 0,void 0,function(){var r,s,u,a=this;return n(this,function(o){return t?this._budget?(r=0,s=new Array,u=function(){return i(a,void 0,void 0,function(){var i;return n(this,function(n){switch(n.label){case 0:return r<e.length?(i=e[r],t(i)&&s.push(i),this._budget.done?[4,this._reschedule()]:[3,2]):[3,3];case 1:return n.sent(),[2,u()];case 2:return++r,[3,0];case 3:return[2]}})})},[2,this._reschedule().then(function(){return u()}).then(function(){return s})]):[2,e.filter(function(e){return t(e)})]:[2,e]})})},e.prototype._canExecuteSoloPass=function(e,t){var r=this.geometryType,n=t.spatialRel;return Q.canQueryWithRBush(e)&&("esriSpatialRelEnvelopeIntersects"===n||"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===n||"esriSpatialRelContains"===n||"esriSpatialRelWithin"===n))},e.prototype._getQueryBBoxes=function(e){if(Q.canQueryWithRBush(e)){if(y.isExtent(e))return[d.fromValues(e.xmin,e.ymin,e.xmax,e.ymax)];if(y.isPolygon(e))return e.rings.map(function(e){return d.fromValues(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))})}return[p.getBoundsXY(d.create(),e)]},e.prototype._searchFeatures=function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];this.featureStore.forEachInBounds(n,function(e){w.add(e)})}var i=new Array(w.size),s=0;return w.forEach(function(e){return i[s++]=e}),w.clear(),i},e.prototype._checkQuerySupport=function(e){return i(this,void 0,void 0,function(){return n(this,function(t){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new s("feature-store:unsupported-query","Unsupported query options",{query:e});return[2,h.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),Q.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),g.checkProjectionSupport(this.spatialReference,e.outSR)]).then(function(){return e})]})})},e.prototype._checkAttributesQuerySupport=function(e){var t=e.outFields,r=e.orderByFields,n=e.returnDistinctValues;if(r&&r.length>0){var i=r.map(function(e){return e.indexOf(" ASC")>-1?e.split(" ASC")[0]:e.indexOf(" DESC")>-1?e.split(" DESC")[0]:e});_.validateFields(this.fieldsIndex,i,"orderByFields contains missing fields")}if(t&&t.length>0)_.validateFields(this.fieldsIndex,t,"outFields contains missing fields");else if(n)throw new s("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});_.validateWhere(this.fieldsIndex,e.where)},e.prototype._checkStatisticsQuerySupport=function(e){return i(this,void 0,void 0,function(){var t,r,i,u,a,o,c,h,l,f,d,p;return n(this,function(n){if(t=e.outStatistics,r=e.groupByFieldsForStatistics,i=e.having,u=r&&r.length,a=t&&t.length,i){if(!u||!a)throw new s("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});_.validateHaving(this.fieldsIndex,i,t)}if(a){if(o=t.some(function(e){return"exceedslimit"===e.statisticType}))return[2];for(c=t.map(function(e){return e.onStatisticField}),_.validateFields(this.fieldsIndex,c,"onStatisticFields contains missing fields"),u&&_.validateFields(this.fieldsIndex,r,"groupByFieldsForStatistics contains missing fields"),h=0,l=t;h<l.length;h++)if(f=l[h],d=f.onStatisticField,p=f.statisticType,(!u||"count"!==p)&&d&&_.hasInvalidFieldType(d,this.fieldsIndex))throw new s("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:f,query:e})}return[2]})})},e}();t.default=P;var z=f.create(),A=f.create()});