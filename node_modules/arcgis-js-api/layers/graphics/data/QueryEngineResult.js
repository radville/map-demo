// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/iteratorUtils","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","../featureConversionUtils","./AttributesBuilder","./attributeSupport","./projectionSupport","./timeSupport","./utils"],function(e,t,r,i,s,a,n,o,u,l,h,f,c,p,d,m){Object.defineProperty(t,"__esModule",{value:!0});var y=function(){function e(e,t,r){this.items=e,this.queryGeometry=t,this.definitionExpression=r.definitionExpression,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.fieldsIndex=r.fieldsIndex,this.timeInfo=r.timeInfo,this.featureAdapter=r.featureAdapter}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e.prototype.createQueryResponse=function(e){var t;if(e.outStatistics){t=e.outStatistics.some(function(e){return"exceedslimit"===e.statisticType})?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e)}else t=this._createFeatureQueryResponse(e);return e.returnQueryGeometry&&(l.isValid(e.outSR)&&!l.equals(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=m.cleanFromGeometryEngine(r({spatialReference:e.outSR},p.project(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR))):t.queryGeometry=m.cleanFromGeometryEngine(r({spatialReference:e.outSR},this.queryGeometry))),t},e.prototype.executeAttributesQuery=function(t){var r=c.getWhereClause(t.where,this.fieldsIndex);if(!r)return o.resolve(this);if(r.isStandardized){for(var i=0,s=[],a=0,n=this.items;a<n.length;a++){var u=n[a];r.testFeature(u,this.featureAdapter)&&(s[i++]=u)}var l=new e(s,this.queryGeometry,this);return l.definitionExpression=t.where,o.resolve(l)}return o.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(t){if(!t.objectIds||!t.objectIds.length)return o.resolve(this);var r=a.createSetFromValues(t.objectIds),i=this.featureAdapter.getObjectId;return o.resolve(new e(this.items.filter(function(e){return r.has(i(e))}),this.queryGeometry,this))},e.prototype.executeTimeQuery=function(t){var r=d.getTimeOperator(this.timeInfo,t.timeExtent,this.featureAdapter);if(!n.isSome(r))return o.resolve(this);var i=this.items.filter(r);return o.resolve(new e(i,this.queryGeometry,this))},e.prototype.project=function(t){return s(this,void 0,void 0,function(){var r,s,a,n=this;return i(this,function(i){switch(i.label){case 0:return!t||l.equals(this.spatialReference,t)?[2,this]:(r=this.featureAdapter,[4,p.projectMany(this.items.map(function(e){return m.getGeometry(n,r.getGeometry(e))}),this.spatialReference,t)]);case 1:return s=i.sent(),a=s.map(function(e,t){return r.cloneWithGeometry(n.items[t],h.convertFromGeometry(e,n.hasZ,n.hasM))}),[2,new e(a,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:t,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})]}})})},e.prototype._createFeatureQueryResponse=function(e){var t=this,r=this.items,i=this,s=i.geometryType,a=i.hasM,n=i.hasZ,o=i.objectIdField,l=i.spatialReference,h=e.outFields,f=e.outSR,c=e.quantizationParameters,p=e.resultRecordCount,d=e.resultOffset,y=e.returnZ,g=e.returnM,I=!1;if(null!=p&&null!=d){var v=d+p;I=r.length>v,r=r.slice(d,Math.min(r.length,v))}return{exceededTransferLimit:I,features:this._createFeatures(e,r),fields:h&&h.map(function(e){return t.fieldsIndex.get(e)}),geometryType:s,hasM:a&&g,hasZ:n&&y,objectIdFieldName:o,spatialReference:m.cleanFromGeometryEngine(f||l),transform:c&&u.toQuantizationTransform(c)||null}},e.prototype._createFeatures=function(e,t){var r=new f.default(e,this.featureAdapter,this.fieldsIndex),i=this,s=i.hasM,a=i.hasZ,n=e.orderByFields,o=e.quantizationParameters,l=e.returnGeometry,h=e.returnCentroid,c=e.maxAllowableOffset,p=e.returnZ,d=void 0!==p&&p,y=e.returnM,g=void 0!==y&&y,I=a&&d,v=s&&g,b=[],x=0;if(t.length&&n&&n.length){var F=n[0].split(" "),T=F[0],S=this.fieldsIndex.get(T),N="DESC"===F[1];t.sort(function(e,t){var i=r.getFieldValue(e,T,S),s=r.getFieldValue(t,T,S);if("number"==typeof i&&"number"==typeof s)return N?s-i:i-s;if("string"==typeof i&&"string"==typeof s){var a=i.toUpperCase(),n=s.toUpperCase();return(N?a>n:a<n)?-1:(N?a<n:a>n)?1:0}})}if(l||h){var R=u.toQuantizationTransform(o);if(l&&!h)for(var G=0,_=t;G<_.length;G++){var A=_[G];b[x++]={attributes:r.getAttributes(A),geometry:m.getGeometry(this,this.featureAdapter.getGeometry(A),c,R,I,v)}}else if(!l&&h)for(var E=0,q=t;E<q.length;E++){var A=q[E];b[x++]={attributes:r.getAttributes(A),centroid:m.transformCentroid(this,this.featureAdapter.getCentroid(A,this),R)}}else for(var M=0,V=t;M<V.length;M++){var A=V[M];b[x++]={attributes:r.getAttributes(A),centroid:m.transformCentroid(this,this.featureAdapter.getCentroid(A,this),R),geometry:m.getGeometry(this,this.featureAdapter.getGeometry(A),c,R,I,v)}}}else for(var j=0,C=t;j<C.length;j++){var A=C[j],P=r.getAttributes(A);P&&(b[x++]={attributes:P})}return b},e.prototype._createExceedsLimitQueryResponse=function(e){for(var t=!1,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=0,n=e.outStatistics;a<n.length;a++){var o=n[a];if("exceedslimit"===o.statisticType){r=null!=o.maxPointCount?o.maxPointCount:Number.POSITIVE_INFINITY,i=null!=o.maxRecordCount?o.maxRecordCount:Number.POSITIVE_INFINITY,s=null!=o.maxVertexCount?o.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)t=this.items.length>r;else if(this.items.length>i)t=!0;else{var u=this.hasZ?this.hasM?4:3:this.hasM?3:2,l=this.featureAdapter,h=this.items.reduce(function(e,t){var r=l.getGeometry(t);return e+(r&&r.coords.length||0)},0)/u;t=h>s}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}},e.prototype._createStatisticsQueryResponse=function(e){for(var t=new f.default(e,this.featureAdapter,this.fieldsIndex),r=e.outStatistics,i=[],s=[],a=e.groupByFieldsForStatistics,n=e.having,o=a&&a.length,u=o&&a[0],l=this.fieldsIndex.get(u),h=!l,c={},p={},d={},m={attributes:{}},y=0,g=r;y<g.length;y++){var I=g[y],v=I.outStatisticFieldName,b=I.statisticType,x="exceedslimit"!==b?I.onStatisticField:void 0,F=this.fieldsIndex.get(x),T=o&&(x===u||h)&&"count"===b;if(o){c[x]||(c[x]=this._calculateUniqueValues(t,u,l));var S=c[x];for(var N in S){var R=S[N],G=R.count,_=R.data,A=R.items;if(!n||t.validateItems(A,n)){var E=p[_]||{attributes:{}},q=null;if(T)q=G;else{var M=this._calculateStatistics(A,t,x,F),V="var"===b?"variance":b;q=M[V]}E.attributes[v]=q,E.attributes[h?"EXPR_1":u]=_,p[_]=E}}}else{d[x]||(d[x]=this._calculateStatistics(this.items,t,x,F));var M=d[x],V="var"===b?"variance":b;m.attributes[v]=M[V]}s.push({name:v,alias:v,type:"esriFieldTypeDouble"})}if(o)for(var j in p)i.push(p[j]);else i.push(m);return{fields:s,features:i}},e.prototype._calculateStatistics=function(e,t,r,i){for(var s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,n=null,o=null,u=null,l=null,h=[],f=0,c=0;c<e.length;c++){var p=e[c],d=t.getFieldValue(p,r,i);"string"==typeof d?f++:null==d||isNaN(d)||(n+=d,s=Math.min(s,d),a=Math.max(a,d),h.push(d),f++)}if(f){o=n/f;for(var m=0,y=0,g=h;y<g.length;y++){var d=g[y];m+=Math.pow(d-o,2)}l=f>1?m/(f-1):0,u=Math.sqrt(l)}else s=null,a=null;return{avg:o,count:f,max:a,min:s,stddev:u,sum:n,variance:l}},e.prototype._calculateUniqueValues=function(e,t,r){for(var i={},s=0,a=this.items;s<a.length;s++){var n=a[s],o=e.getFieldValue(n,t,r);(null==o||"string"==typeof o&&""===o.trim())&&(o=null),null==i[o]?i[o]={count:1,data:o,items:[n]}:(i[o].count++,i[o].items.push(n))}return i},e}();t.default=y});