// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/jsonMap","../../../core/maybe","../../../core/promiseUtils","../../../core/unitUtils","../../../geometry/support/extentUtils","../../../geometry/support/jsonUtils","../../../geometry/support/normalizeUtils","../../../geometry/support/spatialReferenceUtils","../centroid","../featureConversionUtils","../OptimizedGeometry","./projectionSupport","./spatialQuerySupport"],function(e,t,r,i,o,n,s,a,u,l,c,m,p,f,y,d,g){function h(e,t,r,i,o){void 0===i&&(i=e.hasZ),void 0===o&&(o=e.hasM);var n=e.hasZ&&i,s=e.hasM&&o;if(r){var a=f.quantizeOptimizedGeometry(P,t,e.hasZ,e.hasM,"esriGeometryPoint",r,i,o);return f.convertToPoint(a,n,s)}return f.convertToPoint(t,n,s)}function v(e,t,r){return"esriGeometryPolygon"===e.geometryType&&t&&(t.centroid||t.geometry)?(t.centroid||(t.centroid=p.getCentroidOptimizedGeometry(new y.default,t.geometry,e.hasZ,e.hasM)),h(e,t.centroid,r)):null}function S(e,t,r,i,o,n){void 0===o&&(o=e.hasZ),void 0===n&&(n=e.hasM);var s=e.hasZ&&o,a=e.hasM&&n,u=t?"coords"in t?t:t.geometry:null;if(!u)return null;if(r){var l=f.generalizeOptimizedGeometry(z,u,e.hasZ,e.hasM,e.geometryType,r,o,n);return i&&(l=f.quantizeOptimizedGeometry(P,l,s,a,e.geometryType,i)),N[e.geometryType](l,s,a)}if(i){var l=f.quantizeOptimizedGeometry(P,u,e.hasZ,e.hasM,e.geometryType,i,o,n);return N[e.geometryType](l,s,a)}return f.removeZMValues(_,u,e.hasZ,e.hasM,o,n),N[e.geometryType](_,s,a)}function R(e,t,o){return i(this,void 0,void 0,function(){var i,n,s,a,u,u,u,u;return r(this,function(r){if(i=e.outFields,n=e.orderByFields,s=e.groupByFieldsForStatistics,a=e.outStatistics,i)for(u=0;u<i.length;u++)i[u]=i[u].trim();if(n)for(u=0;u<n.length;u++)n[u]=n[u].trim();if(s)for(u=0;u<s.length;u++)s[u]=s[u].trim();if(a)for(u=0;u<a.length;u++)a[u].onStatisticField&&(a[u].onStatisticField=a[u].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),[2,G(e,t,o)]})})}function M(e,t,o){return i(this,void 0,void 0,function(){return r(this,function(r){return[2,G(e,t,o)]})})}function G(e,o,s){return i(this,void 0,void 0,function(){var i,a,m,p,f,y;return r(this,function(r){switch(r.label){case 0:return e?(i=e.where,e.where=i=i&&i.trim(),(!i||/^1 *= *1$/.test(i)||o&&o===i)&&(e.where=null),e.geometry?[4,U(e)]:[2,e]):[2,null];case 1:return a=r.sent(),e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel&&(m=e.geometry.spatialReference,a=u.getGeometryExtent(a),a.spatialReference=m),e.geometry=a,[4,d.checkProjectionSupport(a.spatialReference,s)];case 2:return r.sent(),[4,c.normalizeCentralMeridian(l.fromJSON(a))];case 3:if(p=r.sent()[0],n.isNone(p))throw t.QUERY_ENGINE_EMPTY_RESULT;return f=p.toJSON(),[4,d.project(f,f.spatialReference,s)];case 4:if(!(y=r.sent()))throw t.QUERY_ENGINE_EMPTY_RESULT;return y.spatialReference=s,e.geometry=y,[2,e]}})})}function U(e){return i(this,void 0,void 0,function(){var t,i,o,n,u,l,c,p,f,y;return r(this,function(r){switch(r.label){case 0:return t=e.geometry,(i=e.distance,o=e.units,null==i)?[2,s.resolve(t)]:(n=t.spatialReference,u=o&&E.fromJSON(o)||a.getUnitString(n),(l=n&&(m.isGeographic(n)||m.isWebMercator(n)))?(p=t,[3,3]):[3,1]);case 1:return[4,d.checkProjectionSupport(n,m.WGS84).then(function(){return d.project(t,m.WGS84)})];case 2:p=r.sent(),r.label=3;case 3:return c=p,[4,g.getGeodesicBufferOperator()];case 4:return f=r.sent(),y=f(c,i,u),[2,y?y.toJSON():null]}})})}function T(e){return e&&O in e?JSON.parse(JSON.stringify(e,w)):e}Object.defineProperty(t,"__esModule",{value:!0});var E=new o.default({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});t.QUERY_ENGINE_EMPTY_RESULT=Object.freeze({});var _=new y.default,z=new y.default,P=new y.default,N={esriGeometryPoint:f.convertToPoint,esriGeometryPolyline:f.convertToPolyline,esriGeometryPolygon:f.convertToPolygon,esriGeometryMultipoint:f.convertToMultipoint};t.transformCentroid=h,t.getCentroid=v,t.getGeometry=S,t.normalizeQuery=R,t.normalizeFilter=M,t.normalizeQueryLike=G,t.cleanFromGeometryEngine=T;var O="_geVersion",w=function(e,t){return e!==O?t:void 0}});