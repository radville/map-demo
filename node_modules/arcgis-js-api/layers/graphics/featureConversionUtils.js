// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../geometry/support/jsonUtils","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],function(e,r,t,n,o,s,a,u){function i(e,r){return e?r?4:3:r?3:2}function l(e,r,t,n){if(e){if(t)return r&&n?ce:ie;if(r&&n)return le}else if(r&&n)return ie;return ue}function c(e,r){var t=e.scale,n=e.translate;return Math.round((r-n[0])/t[0])}function h(e,r){var t=e.scale,n=e.translate;return Math.round((n[1]-r)/t[1])}function d(e,r){var t=e.scale,n=e.translate;return r*t[0]+n[0]}function g(e,r){var t=e.scale;return e.translate[1]-r*t[1]}function f(e,r,t){return e?r?t?M(e):y(e):t?I(e):v(e):null}function v(e){var r=e.coords;return{x:r[0],y:r[1]}}function m(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e}function y(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2]}}function p(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.z,e}function I(e){var r=e.coords;return{x:r[0],y:r[1],m:r[2]}}function F(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.m,e}function M(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2],m:r[3]}}function b(e,r){return e.coords[0]=r.x,e.coords[1]=r.y,e.coords[2]=r.z,e.coords[3]=r.m,e}function N(e,r,t,n){var o=v;t&&n?o=M:t?o=y:n&&(o=I);for(var s=0,a=r;s<a.length;s++){var u=a[s],i=u.geometry,l=u.attributes,c=i?o(i):null;e.push({attributes:l,geometry:c})}return e}function T(e,r){return e&&r?b:e?p:r?F:m}function w(e,r,t,n,o){for(var a=T(t,n),i=0,l=r;i<l.length;i++){var c=l[i],h=c.geometry,d=c.attributes,g=void 0;h&&(g=a(new u.default,h)),e.push(new s.default(g,d,null,d[o]))}return e}function G(e,r,t){return void 0===t&&(t=T(null!=r.z,null!=r.m)),t(e,r)}function P(e,r,t,n){for(var o=0,s=r;o<s.length;o++){var a=s[o],u=a.geometry,i=a.attributes,l=void 0;u&&(l=z(u,t,n)),e.push({attributes:i,geometry:l})}return e}function z(e,r,t){if(!e)return null;for(var n=i(r,t),o=[],s=0;s<e.coords.length;s+=n){for(var a=[],u=0;u<n;u++)a.push(e.coords[s+u]);o.push(a)}return r?t?{points:o,hasZ:r,hasM:t}:{points:o,hasZ:r}:t?{points:o,hasM:t}:{points:o}}function x(e,r,t,n,o){for(var a=i(t,n),l=0,c=r;l<c.length;l++){var h=c[l],d=h.geometry,g=h.attributes,f=void 0;d&&(f=Z(new u.default,d,a)),e.push(new s.default(f,g,null,g[o]))}return e}function Z(e,r,t){void 0===t&&(t=i(r.hasZ,r.hasM)),e.lengths[0]=r.points.length;for(var n=e.coords,o=0,s=0,a=r.points;s<a.length;s++)for(var u=a[s],l=0;l<t;l++)n[o++]=u[l];return e}function O(e,r,t,n){for(var o=0,s=r;o<s.length;o++){var a=s[o],u=a.geometry,i=a.attributes,l=void 0;u&&(l=E(u,t,n)),e.push({attributes:i,geometry:l})}return e}function E(e,r,t){if(!e)return null;for(var n=i(r,t),o=e.coords,s=e.lengths,a=[],u=0,l=0,c=s;l<c.length;l++){for(var h=c[l],d=[],g=0;g<h;g++){for(var f=[],v=0;v<n;v++)f.push(o[u++]);d.push(f)}a.push(d)}return r?t?{paths:a,hasZ:r,hasM:t}:{paths:a,hasZ:r}:t?{paths:a,hasM:t}:{paths:a}}function S(e,r,t,n,o){for(var a=i(t,n),l=0,c=r;l<c.length;l++){var h=c[l],d=h.geometry,g=h.attributes,f=void 0;d&&(f=j(new u.default,d,a)),e.push(new s.default(f,g,null,g[o]))}return e}function j(e,r,t){void 0===t&&(t=i(r.hasZ,r.hasM));for(var n=e.lengths,o=e.coords,s=0,a=0,u=r.paths;a<u.length;a++){for(var l=u[a],c=0,h=l;c<h.length;c++)for(var d=h[c],g=0;g<t;g++)o[s++]=d[g];n.push(l.length)}return e}function V(e,r,t,n){for(var o=0,s=r;o<s.length;o++){var a=s[o],u=a.geometry,i=a.attributes,l=a.centroid,c=void 0;if(u&&(c=Y(u,t,n)),l){var h=v(l);e.push({attributes:i,centroid:h,geometry:c})}else e.push({attributes:i,geometry:c})}return e}function Y(e,r,t){if(!e)return null;for(var n=i(r,t),o=e.coords,s=e.lengths,a=[],u=0,l=0,c=s;l<c.length;l++){for(var h=c[l],d=[],g=0;g<h;g++){for(var f=[],v=0;v<n;v++)f.push(o[u++]);d.push(f)}a.push(d)}return r?t?{rings:a,hasZ:r,hasM:t}:{rings:a,hasZ:r}:t?{rings:a,hasM:t}:{rings:a}}function _(e,r,t,n,o){for(var a=0,i=r;a<i.length;a++){var l=i[a],c=l.geometry,h=l.centroid,d=l.attributes,g=void 0;c&&(g=k(new u.default,c,t,n)),h?e.push(new s.default(g,d,m(new u.default,h),d[o])):e.push(new s.default(g,d,null,d[o]))}return e}function k(e,r,t,n){return void 0===t&&(t=r.hasZ),void 0===n&&(n=r.hasM),L(e,r.rings,t,n),e}function L(e,r,t,n){var o=i(t,n),s=e.lengths,a=e.coords,u=0;s.length=a.length=0;for(var l=0,c=r;l<c.length;l++){for(var h=c[l],d=0,g=h;d<g.length;d++)for(var f=g[d],v=0;v<o;v++)a[u++]=f[v];s.push(h.length)}return e}function q(e,r,t,n,o){he[0]=e;var s=A(de,he,r,t,n,o)[0];return he.length=de.length=0,s}function A(e,r,n,o,a,u){if(e.length=0,!n){for(var i=0,l=r;i<l.length;i++){var c=l[i],h=c.attributes[u];e.push(new s.default(null,c.attributes,null,h))}return e}switch(n){case"esriGeometryPoint":return w(e,r,o,a,u);case"esriGeometryMultipoint":return x(e,r,o,a,u);case"esriGeometryPolyline":return S(e,r,o,a,u);case"esriGeometryPolygon":return _(e,r,o,a,u);default:se.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'")),e.length=0}return e}function U(e,r,t,n){de[0]=e,X(he,de,r,t,n);var o=he[0];return he.length=de.length=0,o}function R(e,r,n){if(!e)return null;var s=new u.default;if("hasZ"in e&&null==r&&(r=e.hasZ),"hasM"in e&&null==n&&(n=e.hasM),o.isPoint(e)){return T(null!=r?r:null!=e.z,null!=n?n:null!=e.m)(s,e)}return o.isPolygon(e)?k(s,e,r,n):o.isPolyline(e)?j(s,e,i(r,n)):o.isMultipoint(e)?Z(s,e,i(r,n)):void se.error("convertFromGeometry:unknown-geometry",new t("Unable to parse unknown geometry type '"+e+"'"))}function B(e,r,n,o){var s=e&&("coords"in e?e:e.geometry);if(!s)return null;switch(r){case"esriGeometryPoint":var a=v;return n&&o?a=M:n?a=y:o&&(a=I),a(s);case"esriGeometryMultipoint":return z(s,n,o);case"esriGeometryPolyline":return E(s,n,o);case"esriGeometryPolygon":return Y(s,n,o);default:return void se.error("convertToGeometry:unknown-geometry",new t("Unable to parse unknown geometry type '"+r+"'"))}}function X(e,r,n,o,s){switch(e.length=0,n){case"esriGeometryPoint":return N(e,r,o,s);case"esriGeometryMultipoint":return P(e,r,o,s);case"esriGeometryPolyline":return O(e,r,o,s);case"esriGeometryPolygon":return V(e,r,o,s);default:se.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'"))}return e}function C(e){var r=e.objectIdFieldName,t=e.spatialReference,n=e.transform,o=e.fields,s=e.hasM,a=e.hasZ,u=e.features,i=e.geometryType,l=e.exceededTransferLimit,c=X([],u,i,a,s),h={features:c,fields:o,geometryType:i,objectIdFieldName:r,spatialReference:t};return n&&(h.transform=n),l&&(h.exceededTransferLimit=l),s&&(h.hasM=s),a&&(h.hasZ=a),h}function Q(e,r){var n=new a.default,o=e.hasM,s=e.hasZ,u=e.features,i=e.objectIdFieldName,l=e.spatialReference,c=e.geometryType,h=e.exceededTransferLimit,d=e.transform;return n.fields=e.fields,n.geometryType=c,n.objectIdFieldName=i||r,n.spatialReference=l,n.objectIdFieldName?(u&&A(n.features,u,c,s,o,n.objectIdFieldName),h&&(n.exceededTransferLimit=h),o&&(n.hasM=o),s&&(n.hasZ=s),d&&(n.transform=d),n):(se.error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function D(e){var r=e.transform,t=e.features,n=e.hasM,o=e.hasZ;if(!r)return e;for(var s=0,a=t;s<a.length;s++){var u=a[s];u.geometry&&te(u.geometry,u.geometry,n,o,r),u.centroid&&te(u.centroid,u.centroid,n,o,r)}return e.transform=null,e}function H(e,r){var t=r.geometryType,n=r.features,o=r.hasM,a=r.hasZ;if(!e)return r;for(var i=0;i<n.length;i++){var l=n[i],c=new s.default(new u.default,l.attributes);J(c.geometry,l.geometry,o,a,t,e),l.centroid&&(c.centroid=new u.default,J(c.centroid,l.centroid,o,a,"esriGeometryPoint",e)),n[i]=c}return r.transform=e,r}function J(e,r,t,n,o,s,a,u){if(void 0===a&&(a=t),void 0===u&&(u=n),e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var d=ae[o],g=r.coords,f=r.lengths,v=i(t,n),m=i(t&&a,n&&u),y=l(t,n,a,u);if(!f.length)return y(e.coords,g,0,0,c(s,g[0]),h(s,g[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=v,e;for(var p,I,F,M,b=0,N=0,T=N,w=0,G=f;w<G.length;w++){var P=G[w];if(!(P<d)){var z=0;N=T,F=p=c(s,g[b]),M=I=h(s,g[b+1]),y(e.coords,g,N,b,F,M),z++,b+=v,N+=m;for(var x=1;x<P;x++,b+=v)F=c(s,g[b]),M=h(s,g[b+1]),F===p&&M===I||(y(e.coords,g,N,b,F-p,M-I),N+=m,z++,p=F,I=M);z>=d&&(e.lengths.push(z),T=N)}}return e.coords.length=T,e.coords.length?e:null}function K(e,r,t,n,o,s,a,u){if(void 0===a&&(a=t),void 0===u&&(u=n),e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var c=ae[o],h=r.coords,d=r.lengths,g=i(t,n),f=i(t&&a,n&&u),v=l(t,n,a,u);if(!d.length)return v(e.coords,h,0,0,h[0],h[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=g,e;for(var m=0,y=s*s,p=0,I=d;p<I.length;p++){var F=I[p];if(F<c)m+=F*g;else{var M=e.coords.length/f,b=m,N=m+(F-1)*g;v(e.coords,h,e.coords.length,b,h[b],h[b+1]),$(e.coords,h,g,y,v,b,N),v(e.coords,h,e.coords.length,N,h[N],h[N+1]);var T=e.coords.length/f-M;T>=c?e.lengths.push(T):e.coords.length=M*f,m+=F*g}}return e.coords.length?e:null}function W(e,r,t,n){var o=e[r],s=e[r+1],a=e[t],u=e[t+1],i=e[n],l=e[n+1],c=a,h=u,d=i-c,g=l-h;if(0!==d||0!==g){var f=d*d+g*g,v=((o-c)*d+(s-h)*g)/f;v>1?(c=i,h=l):v>0&&(c+=d*v,h+=g*v)}return d=o-c,g=s-h,d*d+g*g}function $(e,r,t,n,o,s,a){for(var u,i=n,l=0,c=s+t;c<a;c+=t)(u=W(r,c,s,a))>i&&(l=c,i=u);i>n&&(l-s>t&&$(e,r,t,n,o,s,l),o(e,r,e.length,l,r[l],r[l+1]),a-l>t&&$(e,r,t,n,o,l,a))}function ee(e,r,t,n){var o=i(t,n),s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(r&&r.coords)for(var c=r.coords,h=0;h<c.length;h+=o){var d=c[h],g=c[h+1];s=Math.min(s,d),u=Math.max(u,d),a=Math.min(a,g),l=Math.max(l,g)}return e[0]=s,e[1]=a,e[2]=u,e[3]=l,e}function re(e,r,t,n){for(var o=i(t,n),s=r.lengths,a=r.coords,u=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,d=0,g=0,f=s;g<f.length;g++){var v=f[g],m=a[d],y=a[d+1];u=Math.min(m,u),l=Math.min(y,l),c=Math.max(m,c),h=Math.max(y,h),d+=o;for(var p=1;p<v;p++,d+=o){var I=a[d],F=a[d+1];m+=I,y+=F,I<0&&(u=Math.min(u,m)),I>0&&(c=Math.max(c,m)),F<0?l=Math.min(l,y):F>0&&(h=Math.max(h,y))}}return e[0]=u,e[1]=l,e[2]=c,e[3]=h,e}function te(e,r,t,n,o){var s=r.coords,a=r.lengths,u=t?n?ce:ie:n?ie:ue,l=i(t,n);if(!s.length)return e!==r&&(e.lengths.length=0,e.coords.length=0),e;if(!a.length)return u(e.coords,s,0,0,d(o,s[0]),g(o,s[1])),e!==r&&(e.lengths.length=0,e.coords.length=l),e;for(var c=o.scale,h=c[0],f=c[1],v=0,m=0;m<a.length;m++){var y=a[m];e.lengths[m]=y;var p=d(o,s[v]),I=g(o,s[v+1]);u(e.coords,s,v,v,p,I),v+=l;for(var F=1;F<y;F++,v+=l)p+=s[v]*h,I-=s[v+1]*f,u(e.coords,s,v,v,p,I)}return e!==r&&(e.lengths.length=a.length,e.coords.length=s.length),e}function ne(e,r,t,n,o,s){var a,u=i(t,n),c=l(t,n,o,s),h=r.coords;e.coords.length=0,e.lengths.length=0,(a=e.lengths).push.apply(a,r.lengths);for(var d=0;d<h.length;d+=u)c(e.coords,h,e.coords.length,d,h[d],h[d+1]);return e}function oe(e,r,t,n,o){if(!r||!r.coords||!r.coords.length)return null;for(var s=ae[t],a=r.coords,u=r.lengths,c=l(n,o,n,o),h=i(n,o),d=0,g=0,f=0,v=0,m=0,y=u;m<y.length;m++){var p=y[m];g=v,c(e.coords,a,g,d,a[d],a[d+1]),d+=h;var I=a[d],F=a[d+1],M=I,b=F,N=F/I;g+=h,c(e.coords,a,g,d,M,b),d+=h;for(var T=2;T<p;T++){I=a[d],F=a[d+1];var w=F/I,G=N===w||!isFinite(N)&&!isFinite(w),P=G&&isFinite(w)?N>=0&&w>=0||N<=0&&w<=0:b>=0&&F>=0||b<=0&&F<=0;G&&P?(M+=I,b+=F):(M=I,b=F,g+=h),c(e.coords,a,g,d,M,b),d+=h,N=w}g+=h;var z=(g-v)/h;z>=s&&(e.lengths[f]=z,v=g,f++)}return e.coords.length>g&&(e.coords.length=g),e.lengths.length>f&&(e.lengths.length=f),e.coords.length?e:null}Object.defineProperty(r,"__esModule",{value:!0});var se=n.getLogger("esri.tasks.support.optimizedFeatureSet"),ae={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},ue=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s},ie=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+2]},le=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+3]},ce=function(e,r,t,n,o,s){e[t]=o,e[t+1]=s,e[t+2]=r[n+2],e[t+3]=r[n+3]};r.quantizeX=c,r.quantizeY=h,r.hydrateX=d,r.hydrateY=g,r.convertToPoint=f,r.convertFromPoint=G,r.convertToMultipoint=z,r.convertFromMultipoint=Z,r.convertToPolyline=E,r.convertFromPolyline=j,r.convertToPolygon=Y,r.convertFromPolygon=k,r.convertFromNestedArray=L;var he=[],de=[];r.convertFromFeature=q,r.convertFromFeatures=A,r.convertToFeature=U,r.convertFromGeometry=R,r.convertToGeometry=B,r.convertToFeatures=X,r.convertToFeatureSet=C,r.convertFromFeatureSet=Q,r.hydrateOptimizedFeatureSet=D,r.quantizeOptimizedFeatureSet=H,r.quantizeOptimizedGeometry=J,r.generalizeOptimizedGeometry=K,r.getBoundsOptimizedGeometry=ee,r.getQuantizedBoundsOptimizedGeometry=re,r.hydrateOptimizedGeometry=te,r.removeZMValues=ne,r.removeCollinearVectices=oe});