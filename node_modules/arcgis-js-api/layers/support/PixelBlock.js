// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/Error","../../core/JSONSupport","../../core/lang","../../core/Logger","../../core/accessorSupport/decorators"],function(t,e,i,r,s,a,o,l,n){var p=l.getLogger("esri.layers.support.PixelBlock");return function(t){function e(e){var i=t.call(this,e)||this;return i.width=null,i.height=null,i.pixelType="f32",i.validPixelCount=null,i.mask=null,i.maskIsAlpha=!1,i.pixels=null,i.statistics=null,i}i(e,t),a=e,e.prototype.castPixelType=function(t){if(!t)return"f32";var e=t.toLowerCase();return["u1","u2","u4"].indexOf(e)>-1?e="u8":-1===["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].indexOf(e)&&(e="f32"),e},e.prototype.getPlaneCount=function(){return this.pixels&&this.pixels.length},e.prototype.addData=function(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new s("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics||{minValue:null,maxValue:null})},e.prototype.getAsRGBA=function(){var t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)},e.prototype.getAsRGBAFloat=function(){var t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t},e.prototype.updateStatistics=function(){var t=this;this.statistics=this.pixels.map(function(e){return t._calculateBandStatistics(e,t.mask)});var e=this.mask,i=0;if(e)for(var r=0;r<e.length;r++)e[r]&&i++;else i=this.width*this.height;this.validPixelCount=i},e.prototype.clamp=function(t){if(t&&"f64"!==t&&"f32"!==t){var e;switch(t){case"u8":e=[0,255];break;case"u16":e=[0,65535];break;case"u32":e=[0,4294967295];break;case"s8":e=[-128,127];break;case"s16":e=[-32768,32767];break;case"s32":e=[-2147483648,2147483647];break;default:e=[-3.4e39,3.4e39]}for(var i,r,s,a=e[0],o=e[1],l=this.pixels,n=this.width*this.height,p=l.length,h=[],u=0;u<p;u++){s=this._createEmptyBand(t,n),i=l[u];for(var c=0;c<n;c++)r=i[c],s[c]=r>o?o:r<a?a:r;h.push(s)}this.pixels=h,this.pixelType=t}},e.prototype.clone=function(){var t=new a({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});this.mask&&(this.mask instanceof Uint8Array?t.mask=new Uint8Array(this.mask):t.mask=this.mask.slice(0));var e,i=this.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];var r=this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=r?this.pixels[e].slice(0,this.pixels[e].length):new i(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=o.clone(this.statistics[e]);return t},e.prototype.getPixelArrayConstructor=function(t){var e;switch(t){case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"u32":e=Uint32Array;break;case"f32":e=Float32Array;break;case"f64":e=Float64Array;break;default:e=Float32Array}return e},e.prototype._createEmptyBand=function(t,e){return new(this.getPixelArrayConstructor(t))(e)},e.prototype._fillFrom8Bit=function(t){var e=this,i=e.mask,r=e.maskIsAlpha,s=e.pixels;if(!t||!s||!s.length)return void p.error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");var a,o,l,n;a=o=l=s[0],s.length>=3?(o=s[1],l=s[2]):2===s.length&&(o=s[1]);var h=new Uint32Array(t),u=this.width*this.height;if(a.length!==u)return void p.error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(i&&i.length===u)if(r)for(n=0;n<u;n++)i[n]&&(h[n]=i[n]<<24|l[n]<<16|o[n]<<8|a[n]);else for(n=0;n<u;n++)i[n]&&(h[n]=255<<24|l[n]<<16|o[n]<<8|a[n]);else for(n=0;n<u;n++)h[n]=255<<24|l[n]<<16|o[n]<<8|a[n]},e.prototype._fillFromNon8Bit=function(t){var e=this,i=e.pixels,r=e.mask,s=e.statistics;if(!t||!i||!i.length)return void p.error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");var a=this.pixelType,o=1,l=0,n=1;if(s&&s.length>0)l=s.map(function(t){return t.minValue}).reduce(function(t,e){return Math.min(t,e)}),n=s.map(function(t){return t.maxValue-t.minValue}).reduce(function(t,e){return Math.max(t,e)}),o=255/n;else{var h=255;"s8"===a?(l=-128,h=127):"u16"===a?h=65535:"s16"===a?(l=-32768,h=32767):"u32"===a?h=4294967295:"s32"===a?(l=-2147483648,h=2147483647):"f32"===a?(l=-3.4e39,h=3.4e39):"f64"===a&&(l=-Number.MAX_VALUE,h=Number.MAX_VALUE),o=255/(h-l)}var u,c,f,y,x,d=new Uint32Array(t),g=this.width*this.height;if(u=c=f=i[0],u.length!==g)return p.error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(i.length>=2)if(c=i[1],i.length>=3&&(f=i[2]),r&&r.length===g)for(y=0;y<g;y++)r[y]&&(d[y]=255<<24|(f[y]-l)*o<<16|(c[y]-l)*o<<8|(u[y]-l)*o);else for(y=0;y<g;y++)d[y]=255<<24|(f[y]-l)*o<<16|(c[y]-l)*o<<8|(u[y]-l)*o;else if(r&&r.length===g)for(y=0;y<g;y++)x=(u[y]-l)*o,r[y]&&(d[y]=255<<24|x<<16|x<<8|x);else for(y=0;y<g;y++)x=(u[y]-l)*o,d[y]=255<<24|x<<16|x<<8|x},e.prototype._fillFrom32Bit=function(t){var e=this,i=e.pixels,r=e.mask;if(!t||!i||!i.length)return p.error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");var s,a,o,l;s=a=o=i[0],i.length>=3?(a=i[1],o=i[2]):2===i.length&&(a=i[1]);var n=this.width*this.height;if(s.length!==n)return p.error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");var h=0;if(r&&r.length===n)for(l=0;l<n;l++)t[h++]=s[l],t[h++]=a[l],t[h++]=o[l],t[h++]=1&r[l];else for(l=0;l<n;l++)t[h++]=s[l],t[h++]=a[l],t[h++]=o[l],t[h++]=1},e.prototype._calculateBandStatistics=function(t,e){var i,r=1/0,s=-1/0,a=t.length,o=0;if(e)for(i=0;i<a;i++)e[i]&&(o=t[i],r=o<r?o:r,s=o>s?o:s);else for(i=0;i<a;i++)o=t[i],r=o<r?o:r,s=o>s?o:s;return{minValue:r,maxValue:s}};var a;return r([n.property({json:{write:!0}})],e.prototype,"width",void 0),r([n.property({json:{write:!0}})],e.prototype,"height",void 0),r([n.property({json:{write:!0}})],e.prototype,"pixelType",void 0),r([n.cast("pixelType")],e.prototype,"castPixelType",null),r([n.property({json:{write:!0}})],e.prototype,"validPixelCount",void 0),r([n.property({json:{write:!0}})],e.prototype,"mask",void 0),r([n.property({json:{write:!0}})],e.prototype,"maskIsAlpha",void 0),r([n.property({json:{write:!0}})],e.prototype,"pixels",void 0),r([n.property({json:{write:!0}})],e.prototype,"statistics",void 0),e=a=r([n.subclass("esri.layers.support.PixelBlock")],e)}(n.declared(a.JSONSupport))});