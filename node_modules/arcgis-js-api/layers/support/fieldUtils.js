// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","@dojo/framework/shim/array","../../core/Error","../../core/iteratorUtils","../../core/maybe","../../core/object","../../core/promiseUtils","./domains","../../support/arcadeOnDemand"],function(e,n,i,r,t,l,a,o,u,s,d,c,f){function g(e,i){if(null!=e&&null!=i)for(var r=0,t=Array.isArray(e)?e:[e];r<t.length;r++){var l=t[r];if(m(n.rendererFields,l,i),"visualVariables"in l&&l.visualVariables)for(var a=0,o=l.visualVariables;a<o.length;a++){var u=o[a];m(n.visualVariableFields,u,i)}}}function m(e,n,i){if(e)for(var r=0,t=e;r<t.length;r++){var l=t[r],a=s.getDeepValue(l,n),o=a&&"function"!=typeof a&&I(i,a);o&&s.setDeepValue(l,o.name,n)}}function F(e,n){if(null!=e&&null!=n)if("startField"in e){var i=I(n,e.startField),r=I(n,e.endField);e.startField=i&&i.name||null,e.endField=r&&r.name||null}else{var t=I(n,e.startTimeField),l=I(n,e.endTimeField);e.startTimeField=t&&t.name||null,e.endTimeField=l&&l.name||null}}function p(e,n){return e&&n?(ee.clear(),v(ee,e,n),o.valuesOfSet(ee).sort()):[]}function v(e,n,i){if(i)if(n&&n.length)if(l.includes(i,"*"))for(var r=0,t=n;r<t.length;r++){var a=t[r].name;e.add(a)}else for(var o=0,u=i;o<u.length;o++){var s=u[o];h(e,n,s)}else{if(l.includes(i,"*"))return e.clear(),void e.add("*");for(var d=0,c=i;d<c.length;d++){var s=c[d];e.add(s)}}}function h(e,n,i){if(n&&n.length){var r=I(n,i);return void(r&&e.add(r.name))}"string"==typeof i&&e.add(i)}function y(e,n){return n&&e?l.includes(n,"*")?e.map(function(e){return e.name}):n:[]}function b(e,n,i){if(void 0===i&&(i=1),!n||!e)return[];if(l.includes(n,"*"))return["*"];var r=p(e,n);return r.length/e.length>=i?["*"]:r}function I(e,n){if("string"!=typeof n)return null;if(null!=e){n=n.toLowerCase();for(var i=0,r=e;i<r.length;i++){var t=r[i];if(t&&t.name.toLowerCase()===n)return t}}return null}function T(e,n){if(!e||!n||"string"!=typeof n)return!1;n=n.toLowerCase();for(var i=0,r=e;i<r.length;i++){var t=r[i];if(t&&t.name.toLowerCase()===n)return!0}return!1}function V(e,n,i){return t(this,void 0,void 0,function(){var t,l,a,o,u;return r(this,function(r){switch(r.label){case 0:return i?[4,f.loadArcade()]:[2];case 1:for(t=r.sent().arcadeUtils,l=t.extractFieldNames(i),a=0,o=l;a<o.length;a++)u=o[a],h(e,n,u);return[2]}})})}function N(e){return t(this,void 0,void 0,function(){var n;return r(this,function(i){switch(i.label){case 0:return e?(n=new Set,[4,S(n,e)]):[2,[]];case 1:return i.sent(),[2,o.valuesOfSet(n).sort()]}})})}function S(e,n){return t(this,void 0,void 0,function(){var i,t;return r(this,function(r){return n?(i=n.fields,t=s.getDeepValue("elevationInfo.featureExpressionInfo",n),t?[2,t.collectRequiredFields(e,i)]:[2]):[2]})})}function E(n,i,l){return t(this,void 0,void 0,function(){var t,o;return r(this,function(r){switch(r.label){case 0:return i&&l&&(l.where&&"1=1"!==l.where||l.timeExtent)?(i.timeInfo&&l.timeExtent&&v(n,i.fields,[i.timeInfo.startField,i.timeInfo.endField]),l.where?[4,d.create(function(n){e(["../../core/sql/WhereClause"],n)})]:[3,2]):[2];case 1:if(t=r.sent(),o=t.WhereClause.create(l.where,i.fieldsIndex),!o.isStandardized)throw new a("fieldUtils:collectFilterFields","Where clause is not standardized");v(n,i.fields,o.fieldNames),r.label=2;case 2:return[2]}})})}function w(e){return t(this,void 0,void 0,function(){var n;return r(this,function(i){return e?(n="timeInfo"in e&&e.timeInfo,n?[2,p(e.fields,[e.trackIdField,n.startField,n.endField])]:[2,[]]):[2,[]]})})}function R(e){if(!e)return[];var n="editFieldsInfo"in e&&e.editFieldsInfo;return n?p(e.fields,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function D(e){if(!e)return[];var n="geometryProperties"in e&&e.geometryProperties;return n?p(e.fields,[n&&n.shapeAreaFieldName,n&&n.shapeLengthFieldName]):[]}function x(e){return t(this,void 0,void 0,function(){var n;return r(this,function(i){switch(i.label){case 0:return e?(n=new Set,[4,A(n,e)]):[2,[]];case 1:return i.sent(),[2,o.valuesOfSet(n).sort()]}})})}function A(e,n){return t(this,void 0,void 0,function(){var i,t;return r(this,function(r){switch(r.label){case 0:return i=n.labelingInfo,t=n.fields,i&&i.length?[4,d.all(i.map(function(n){return _(e,t,n)}))]:[2];case 1:return r.sent(),[2]}})})}function _(e,n,i){return t(this,void 0,void 0,function(){var t,l,a,o,u;return r(this,function(r){switch(r.label){case 0:return i?(t=i.getLabelExpression(),l=i.where,"arcade"!==t.type?[3,2]:[4,V(e,n,t.expression)]):[2];case 1:return r.sent(),[3,3];case 2:a=t.expression.match(/{[^}]*}/g),a&&a.forEach(function(i){h(e,n,i.slice(1,-1))}),r.label=3;case 3:return o=/['"]+/g,l&&(u=l.split(" "),3===u.length&&h(e,n,u[0].replace(o,"")),7===u.length&&(h(e,n,u[0].replace(o,"")),h(e,n,u[4].replace(o,"")))),[2]}})})}function L(e){var n=e.defaultValue;return void 0!==n&&P(e,n)?n:e.nullable?null:void 0}function O(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function U(e){return null===e||O(e)}function k(e){return null===e||ne(e)}function z(e){return null!=e&&"string"==typeof e}function C(e){return null===e||z(e)}function M(){return!0}function P(e,n){var i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?k:ne;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?U:O;break;case"string":case"esriFieldTypeString":i=e.nullable?C:z;break;default:i=M}return 1===arguments.length?i:i(n)}function G(e){return null!=e&&ie.has(e.type)}function H(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function j(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function q(e,n){return null===Y(e,n)}function W(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function Y(e,n){return e.nullable&&null===n?null:G(e)&&!J(e.type,Number(n))?re.OUT_OF_RANGE:P(e,n)?e.domain?c.validateDomainValue(e.domain,n):null:te.INVALID_TYPE}function J(e,n){var i="string"==typeof e?B(e):e;return!!i&&(i.isInteger?ne(n)&&n>=i.min&&n<=i.max:n>=i.min&&n<=i.max)}function X(e){var n=c.getDomainRange(e.domain);if(n)return n;if(G(e))return B(e.type)}function B(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return n.smallIntegerRange;case"esriFieldTypeInteger":case"integer":return n.integerRange;case"esriFieldTypeSingle":case"single":return n.singleRange;case"esriFieldTypeDouble":case"double":return n.doubleRange}}function K(e){if(!O(e))return null;if(ne(e)){if(e>=n.smallIntegerRange.min&&e<=n.smallIntegerRange.max)return"esriFieldTypeSmallInteger";if(e>=n.integerRange.min&&e<=n.integerRange.max)return"esriFieldTypeInteger"}return e>=n.singleRange.min&&e<=n.singleRange.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}function Q(e,n,i){switch(e){case c.DomainValidationError.INVALID_CODED_VALUE:return"Value "+i+" is not in the coded domain - field: "+n.name+", domain: "+JSON.stringify(n.domain);case c.DomainValidationError.VALUE_OUT_OF_RANGE:return"Value "+i+" is out of the range of valid values - field: "+n.name+", domain: "+JSON.stringify(n.domain);case te.INVALID_TYPE:return"Value "+i+" is not a valid value for the field type - field: "+n.name+", type: "+n.type+", nullable: "+n.nullable;case re.OUT_OF_RANGE:var r=B(n.type),t=r.min,l=r.max;return"Value "+i+" is out of range for the number type - field: "+n.name+", type: "+n.type+", value range is "+t+" to "+l}}function Z(e,n){return!$(e,n,null)}function $(e,n,i){if(!n||!n.attributes||!e){if(u.isSome(i))for(var r=0,t=e;r<t.length;r++){var l=t[r];i.add(l)}return!0}for(var a=n.attributes,o=!1,s=0,d=e;s<d.length;s++){var l=d[s];if(!(l in a)){if(o=!0,!u.isSome(i))break;i.add(l)}}return o}Object.defineProperty(n,"__esModule",{value:!0}),n.rendererFields=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],n.visualVariableFields=["field","normalizationField"],n.fixRendererFields=g,n.fixTimeInfoFields=F;var ee=new Set;n.fixFields=p,n.collectFields=v,n.collectField=h,n.unpackFieldNames=y,n.packFields=b,n.getField=I,n.hasField=T,n.collectArcadeFieldNames=V,n.getElevationFields=N,n.collectElevationFields=S,n.collectFilterFields=E,n.getTimeFields=w,n.getFeatureEditFields=R,n.getFeatureGeometryFields=D,n.getLabelingFields=x,n.collectLabelingFields=A,n.getFieldDefaultValue=L;var ne=function(){return"isInteger"in Number?Number.isInteger:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}}();n.isValueMatchingFieldType=P,n.numericTypes=["integer","small-integer","single","double"];var ie=o.createSetFromValues(n.numericTypes.concat(["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]));n.isNumericField=G,n.isStringField=H,n.isDateField=j,n.isValidFieldValue=q;var re;!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(re=n.NumericRangeValidationError||(n.NumericRangeValidationError={}));var te;!function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(te=n.TypeValidationError||(n.TypeValidationError={})),n.sanitizeNullFieldValue=W,n.validateFieldValue=Y,n.isNumberInRange=J,n.getFieldRange=X,n.getNumericTypeForValue=K,n.smallIntegerRange={min:-32768,max:32767,isInteger:!0},n.integerRange={min:-2147483648,max:2147483647,isInteger:!0},n.singleRange={min:-3.4e38,max:1.2e38,isInteger:!1},n.doubleRange={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1},n.validationErrorToString=Q,n.featureHasFields=Z,n.populateMissingFields=$});