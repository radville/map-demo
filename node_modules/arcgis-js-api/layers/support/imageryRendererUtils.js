// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../rasterRenderers","../../core/arrayUtils","../../core/lang","./RasterFunction","../../renderers/support/colorRampUtils","../../renderers/support/stretchRendererUtils"],function(e,r,t,n,a,o,i,u){function s(e){var r=e.type;return"raster-stretch"===r||"unique-value"===r||"class-breaks"===r}function l(e,r){if(!e||!r)return a.clone(e||r);var t=a.clone(e);if("none"!==r.functionName.toLowerCase()){p(t.functionArguments).Raster=r}return t}function m(e,r){switch(r=r||{},e.type){case"raster-stretch":return d(e,r);case"class-breaks":return v(e,r);case"unique-value":return b(e,r);case"raster-colormap":return R(e,r)}}function c(e,r){if(e){var n=e.attributeTable,a=e.dataType,o=e.bandCount,i=e.pixelType,u=e.colormap,s=e.statistics,l=e.histograms;r&&r.length>0&&(s=s?r.map(function(e){return s[e]}):null,l=l?r.map(function(e){return l[e]}):null);var m;if(1===o&&u&&u.length>0)m=t.RasterColormapRenderer.createFromColormap(u);else if(1===o&&n){var c=n.fields.filter(function(e){return"red"===e.name.toLowerCase()})[0],f=n.fields.filter(function(e){return"green"===e.name.toLowerCase()})[0],p=n.fields.filter(function(e){return"blue"===e.name.toLowerCase()})[0],d=n.fields.filter(function(e){return"value"===e.name})[0],v=n.fields.filter(function(e){return"classname"===e.name.toLowerCase()})[0];v||(v=n.fields.filter(function(e){return"string"===e.type})[0])||(v=d),c&&f&&p&&v&&(m=t.UniqueValueRenderer.fromJSON({field1:v.name,uniqueValueInfos:n.features.map(function(e){return{value:e.attributes[v.name],label:e.attributes[v.name],symbol:{color:[e.attributes[c.name],e.attributes[f.name],e.attributes[p.name],255],type:"esriSFS",style:"esriSFSSolid"}}})}))}else{var g=void 0,C=!1,b=void 0,R=void 0,h=void 0;"u8"===i&&"processed"===a?(g="min-max",s=s||[{min:0,max:255},{min:0,max:255},{min:0,max:255}]):"u8"===i||"elevation"===a?(g="min-max",C=!s):"scientific"===a?(g="min-max",C=!s,b=y):l&&l.length>0?(g="percent-clip",h=R=.25):s?g="min-max":(g="percent-clip",C=!0),m=t.RasterStretchRenderer.fromJSON({stretchType:g,dra:C,colorRamp:b,min:0,max:255,statistics:C?null:s,histograms:C?null:l,maxPercent:R,minPercent:h})}return m}}function f(e){var r,t,n,a,o,i,u=e.keyProperties&&e.keyProperties.BandProperties;if(e.bandCount>=3){if(u&&u.length===e.bandCount){for(r=0;r<u.length;r++)u[r].BandName&&"red"===u[r].BandName.toLowerCase()&&(n=r),u[r].BandName&&"green"===u[r].BandName.toLowerCase()&&(a=r),u[r].BandName&&"blue"===u[r].BandName.toLowerCase()&&(o=r),u[r].BandName&&"nearinfrared"===u[r].BandName.toLowerCase()&&(i=r);void 0!==n&&void 0!==a&&void 0!==o?t=[n,a,o]:void 0!==n&&void 0!==a&&void 0!==i&&(t=[i,n,a])}!t&&e.bandCount>3&&(t=[0,1,2])}return t}function p(e){var r=e.Raster;return r&&"esri.layers.support.RasterFunction"===r.declaredClass?p(r.functionArguments):e}function d(e,r){var t=new o;t.functionName="Stretch";var n=N[u.stretchTypeJSONDict.toJSON(e.stretchType)],a={StretchType:n,Statistics:e.statistics,DRA:e.dynamicRangeAdjustment,UseGamma:e.useGamma,Gamma:e.gamma,ComputeGamma:e.computeGamma};if(null!=e.outputMin&&(a.Min=e.outputMin),null!=e.outputMax&&(a.Max=e.outputMax),n===N.standardDeviation?(a.NumberOfStandardDeviations=e.numberOfStandardDeviations,t.outputPixelType="u8"):n===N.percentClip?(a.MinPercent=e.minPercent,a.MaxPercent=e.maxPercent,t.outputPixelType="u8"):n===N.minMax?t.outputPixelType="u8":n===N.sigmoid&&(a.SigmoidStrengthLevel=e.sigmoidStrengthLevel),t.functionArguments=a,t.variableName="Raster",e.colorRamp){var s=e.colorRamp,l=new o,m=i.getColorRampName(s);return m?l.functionArguments={colorRamp:m}:!r.convertColorRampToColormap||"algorithmic"!==s.type&&"multipart"!==s.type?l.functionArguments={colorRamp:e.colorRamp.toJSON()}:l.functionArguments={Colormap:i.convertColorRampToColormap(s,256)},l.variableName="Raster",l.functionName="Colormap",l.functionArguments.Raster=t,l}return t}function v(e,r){var t=[],n=[],a=[],i=[],u=r.pixelType,s=r.rasterAttributeTable,l=s&&s.features,m=C(s);if(l&&Array.isArray(l)&&e.classBreakInfos){e.classBreakInfos.forEach(function(r,t){var n,a=r.symbol.color;a.a&&l.forEach(function(o){((n=o.attributes[e.field])>=r.minValue&&n<r.maxValue||t===e.classBreakInfos.length-1&&n>=r.minValue)&&i.push([o.attributes[m],a.r,a.g,a.b])})});var c=u?g(i,u):i,f=new o;return f.functionName="Colormap",f.functionArguments={},f.functionArguments.Colormap=c,f.variableName="Raster",f}e.classBreakInfos.forEach(function(e,r){var o=e.symbol&&e.symbol.color;o.a?(0===r?t.push(e.minValue,e.maxValue+1e-6):t.push(e.minValue+1e-6,e.maxValue+1e-6),n.push(r),i.push([r,o.r,o.g,o.b])):a.push(e.minValue,e.maxValue)});var p=u?g(i,u):i,d=new o;d.functionName="Remap",d.functionArguments={InputRanges:t,OutputValues:n,NoDataRanges:a},d.variableName="Raster";var v=new o;return v.functionName="Colormap",v.functionArguments={Colormap:p,Raster:d},v}function g(e,r){var t=h[String(r).toLowerCase()];return t&&e.push([Math.floor(t[0]-1),0,0,0],[Math.ceil(t[1]+1),0,0,0]),e}function C(e){if(e){var r=e.fields,t=r&&n.find(r,function(e){return e&&e.name&&"value"===e.name.toLowerCase()});return t&&t.name}}function b(e,r){var t=[],n=r.pixelType,a=r.rasterAttributeTable,i=a&&a.features,u=C(a),s=!1;if(e.uniqueValueInfos&&e.uniqueValueInfos.forEach(function(r){var n=r.symbol.color;n.a&&(e.field!==u&&i?i&&i.forEach(function(a){String(a.attributes[e.field])===String(r.value)&&t.push([a.attributes[u],n.r,n.g,n.b])}):isNaN(r.value)?s=!0:t.push([r.value,n.r,n.g,n.b]))}),s)return null;var l=n&&t.length>0?g(t,n):t,m=new o;return m.functionName="Colormap",m.functionArguments={},m.functionArguments.Colormap=l,m.variableName="Raster",m}function R(e,r){var t=e.extractColormap();if(t&&0!==t.length){var n=r.pixelType,a=n?g(t,n):t,i=new o;return i.functionName="Colormap",i.functionArguments={},i.functionArguments.Colormap=a,i}}Object.defineProperty(r,"__esModule",{value:!0});var h={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767]},y={type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]};r.isSupportedRendererType=s,r.combineRenderingRules=l,r.convertRendererToRenderingRule=m,r.createDefaultRenderer=c,r.getDefaultBandCombination=f;var N={none:0,standardDeviation:3,histogramEqualization:4,minMax:5,percentClip:6,sigmoid:9}});