// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["./Jpg","./Zlib"],function(e,t){"use strict";var n=function(){var e=new ArrayBuffer(4),t=new Uint8Array(e),n=new Uint32Array(e);return t[0]=1,t[1]=2,t[2]=3,t[3]=4,67305985===n[0]},a=function(){var e=[];return e[254]="NEWSUBFILETYPE",e[255]="SUBFILETYPE",e[256]="IMAGEWIDTH",e[257]="IMAGELENGTH",e[258]="BITSPERSAMPLE",e[259]="COMPRESSION",e[262]="PHOTOMETRICINTERPRETATION",e[263]="THRESHHOLDING",e[264]="CELLWIDTH",e[265]="CELLLENGTH",e[266]="FILLORDER",e[269]="DOCUMENTNAME",e[270]="IMAGEDESCRIPTION",e[271]="MAKE",e[272]="MODEL",e[273]="STRIPOFFSETS",e[274]="ORIENTATION",e[277]="SAMPLESPERPIXEL",e[278]="ROWSPERSTRIP",e[279]="STRIPBYTECOUNTS",e[280]="MINSAMPLEVALUE",e[281]="MAXSAMPLEVALUE",e[282]="XRESOLUTION",e[283]="YRESOLUTION",e[284]="PLANARCONFIGURATION",e[285]="PAGENAME",e[286]="XPOSITION",e[287]="YPOSITION",e[288]="FREEOFFSETS",e[289]="FREEBYTECOUNTS",e[290]="GRAYRESPONSEUNIT",e[291]="GRAYRESPONSECURVE",e[292]="T4OPTIONS",e[293]="T6OPTIONS",e[296]="RESOLUTIONUNIT",e[297]="PAGENUMBER",e[300]="COLORRESPONSEUNIT",e[301]="TRANSFERFUNCTION",e[305]="SOFTWARE",e[306]="DATETIME",e[315]="ARTIST",e[316]="HOSTCOMPUTER",e[317]="PREDICTOR",e[318]="WHITEPOINT",e[319]="PRIMARYCHROMATICITIES",e[320]="COLORMAP",e[321]="HALFTONEHINTS",e[322]="TILEWIDTH",e[323]="TILELENGTH",e[324]="TILEOFFSETS",e[325]="TILEBYTECOUNTS",e[326]="BADFAXLINES",e[327]="CLEANFAXDATA",e[328]="CONSECUTIVEBADFAXLINES",e[330]="SUBIFD",e[332]="INKSET",e[333]="INKNAMES",e[334]="NUMBEROFINKS",e[336]="DOTRANGE",e[337]="TARGETPRINTER",e[338]="EXTRASAMPLES",e[339]="SAMPLEFORMAT",e[340]="SMINSAMPLEVALUE",e[341]="SMAXSAMPLEVALUE",e[342]="TRANSFERRANGE",e[347]="JPEGTABLES",e[512]="JPEGPROC",e[513]="JPEGIFOFFSET",e[514]="JPEGIFBYTECOUNT",e[515]="JPEGRESTARTINTERVAL",e[517]="JPEGLOSSLESSPREDICTORS",e[518]="JPEGPOINTTRANSFORM",e[519]="JPEGQTABLES",e[520]="JPEGDCTABLES",e[521]="JPEGACTABLES",e[529]="YCBCRCOEFFICIENTS",e[530]="YCBCRSUBSAMPLING",e[531]="YCBCRPOSITIONING",e[532]="REFERENCEBLACKWHITE",e[33550]="GEOPIXELSCALE",e[33922]="GEOTIEPOINTS",e[33432]="COPYRIGHT",e[42112]="GDAL_METADATA",e[42113]="GDAL_NODATA",e[50844]="RPCCOEFFICIENT",e[34735]="GEOKEYDIRECTORY",e[34736]="GEODOUBLEPARAMS",e[34737]="GEOASCIIPARAMS",e}(),r=function(e){var t=a[e];return void 0===t&&(t="unknown"+e),t},i=[0,1,1,2,4,8,1,1,2,4,8,4,8],A=function(e){var t,n=new DataView(e,0,8),a=n.getUint16(0,!1);if(18761===a)t=!0;else{if(19789!==a)throw"unexpected endianess byte";t=!1}if(42!==n.getUint16(2,t))throw"unexpected tiff identifier";return{littleEndian:t,firstIFD:n.getUint32(4,t)}},E=function(e,t){var n="UNKNOWN";return 3===e?n="F32":1===e?t<=8?n="U8":t<=16?n="U16":t<=32&&(n="U32"):2===e&&(t<=8?n="S8":t<=16?n="S16":t<=32&&(n="S32")),n},s=function(e,t,n){var a,r,A=[],E=n.fieldType,s=n.fieldValueCount,l=n.fieldValueOffset,T=l,I=i[E],S=8*I,o=s*I,f=s*i[E]*8;if(f<=32)if(t||(l>>>=32-f),1===s)A=[l];else for(r=0;r<s;r++)A.push(l<<S*r>>>32-S);else for(T=l;T<l+o;T+=I){switch(E){case 1:case 2:a=new DataView(e,T,1).getUint8(0);break;case 3:a=new DataView(e,T,2).getUint16(0,t);break;case 4:a=new DataView(e,T,4).getUint32(0,t);break;case 5:a=new DataView(e,T,4).getUint32(0,t)/new DataView(e,T+4,4).getUint32(0,t);break;case 6:a=new DataView(e,T,1).getInt8(0);break;case 8:a=new DataView(e,T,2).getInt16(0,t);break;case 9:a=new DataView(e,T,4).getInt32(0,t);break;case 10:a=new DataView(e,T,4).getInt32(0,t)/new DataView(e,T+4,4).getInt32(0,t);break;case 11:a=new DataView(e,T,4).getFloat32(0,t);break;case 12:a=new DataView(e,T,8).getFloat64(0,t);break;case 7:a=null;break;default:a=null}A.push(a)}if(2===E){var O="",N=A;for(A=[],r=0;r<N.length;r++)0===N[r]&&""!==O?(A.push(O),O=""):O+=String.fromCharCode(N[r]);""===O&&0!==A.length||A.push(O)}return A},l=function(e,t){var n,a,i,A,E,l,T,I,S,o,f,O;n=t.littleEndian,a=t.firstIFD;for(var N=[];a;){for(i=new DataView(e,a,2).getUint16(0,n),A=a+2,a=new DataView(e,A+12*i,4).getUint32(0,n),f={},E=0;E<i;E++)l=new DataView(e,A,12),T=l.getUint16(0,n),I=l.getUint16(2,n),S=l.getUint32(4,n),o=l.getUint32(8,n),A+=12,7===I||I>12||(O={fieldTag:T,fieldType:I,fieldValueCount:S,fieldValueOffset:o},O.fieldValues=s(e,n,O),f[r(T)]={type:I,values:O.fieldValues});N.push(f)}return N},T=function(a,r,i){var A,s,l,T=n()===r.littleEndian,I=i.TILEOFFSETS?i.TILEOFFSETS.values:void 0;if(void 0!==I){var S=i.TILEBYTECOUNTS.values,o=i.TILEWIDTH.values[0],f=i.TILELENGTH.values[0],O=i.IMAGEWIDTH.values[0],N=i.IMAGELENGTH.values[0],R=O*N,w=i.BITSPERSAMPLE.values[0],u=i.SAMPLESPERPIXEL.values[0],U=i.SAMPLEFORMAT?i.SAMPLEFORMAT.values[0]:1,P=E(U,w);if(1!==(i.PLANARCONFIGURATION?i.PLANARCONFIGURATION.values[0]:1))throw console.log("can only handle PLANARCONFIGURATION=1"),"can only handle PLANARCONFIGURATION=1";var L=i.COMPRESSION?i.COMPRESSION.values[0]:1;if(1!==L&&6!==L&&8!==L&&32946!==L)throw console.log("this compression is not supported at this moment"),"this compression is not supported at this moment";if(!(U>3)){3===U?(s=new Float32Array(R*u),l=Float32Array):1===U?w<=8?(s=new Uint8Array(R*u),l=Uint8Array):w<=16?(s=new Uint16Array(R*u),l=Uint16Array):w<=32&&(s=new Uint32Array(R*u),l=Uint32Array):2===U&&(w<=8?(s=new Int8Array(R*u),l=Int8Array):w<=16?(s=new Int16Array(R*u),l=Int16Array):w<=32&&(s=new Int32Array(R*u),l=Int32Array));var h,c,y,g,F,d,M,C,D,v,G,p,B,V,b,H,m,x,k=Math.ceil(O/o);if(w%8==0)for(h=0;h<I.length;h++){if(d=Math.floor(h/k)*f,M=h%k*o,C=(d*O+M)*u,"U8"===P||"S8"===P||T){if(8===L||32946===L)V=new Uint8Array(a,I[h],S[h]),m=new t(V),x=m.getBytes(),B=new ArrayBuffer(x.length),V=new Uint8Array(B),V.set(x),V.length!==o*f*u*w/8&&console.log("tile byte counts is different than expected");else if(6===L){V=new Uint8Array(a,I[h],S[h]);var Y=new e;Y.parse(V);var W=Y.getData(Y.width,Y.height);B=new ArrayBuffer(W.length),V=new Uint8Array(B),V.set(W)}else 1===L&&(S[h]!==o*f*u*w/8&&console.log("tile byte counts is different than expected"),B=a.slice(I[h],I[h]+S[h]));A=new l(B)}else{switch(8===L||32946===L?(V=new Uint8Array(a,I[h],S[h]),m=new t(V),V=m.getBytes(),B=new ArrayBuffer(V.length),b=new Uint8Array(B),V.length!==o*f*u*w/8&&console.log("tile byte counts is different than expected")):1===L&&(S[h]!==o*f*u*w/8&&console.log("tile byte counts is different than expected"),B=new ArrayBuffer(S[h]),V=new Uint8Array(a,I[h],S[h]),b=new Uint8Array(B)),P){case"U16":case"S16":for(y=0;y<V.length;y+=2)b[y]=V[y+1],b[y+1]=V[y];break;case"U32":case"S32":case"F32":for(y=0;y<V.length;y+=4)b[y]=V[y+3],b[y+1]=V[y+2],b[y+2]=V[y+1],b[y+3]=V[y]}A=new l(B)}for(v=0,D=C,p=Math.min(o,O-M),G=Math.min(f,N-d),g=0;g<G;g++)for(D=C+g*O*u,v=g*o*u,F=0;F<p*u;F++,D++,v++)s[D]=A[v]}var X={width:O,height:N,pixelType:P};if(1===u)X.pixels=[s];else for(X.pixels=[],h=0;h<u;h++){for(H=new l(R),c=0;c<R;c++)H[c]=s[c*u+h];X.pixels.push(H)}return X}}},I=function(a,r,i){var A,s,l,T=n()===r.littleEndian,I=i.STRIPOFFSETS?i.STRIPOFFSETS.values:void 0;if(void 0!==I){var S=i.STRIPBYTECOUNTS.values,o=i.ROWSPERSTRIP.values,f=i.IMAGEWIDTH.values[0],O=i.IMAGELENGTH.values[0],N=f*O,R=i.BITSPERSAMPLE.values[0],w=i.SAMPLESPERPIXEL.values[0],u=i.SAMPLEFORMAT?i.SAMPLEFORMAT.values[0]:1,U=E(u,R);if(1!==(i.PLANARCONFIGURATION?i.PLANARCONFIGURATION.values[0]:1))throw console.log("can only handle PLANARCONFIGURATION=1"),"can only handle PLANARCONFIGURATION=1";var P=i.COMPRESSION?i.COMPRESSION.values[0]:1;if(1!==P&&6!==P&&8!==P&&32946!==P)throw console.log("compressed tiff is not supported at this moment"),"compressed tiff is not supported at this moment";if(!(u>3)){3===u?(s=new Float32Array(N*w),l=Float32Array):1===u?R<=8?(s=new Uint8Array(N*w),l=Uint8Array):R<=16?(s=new Uint16Array(N*w),l=Uint16Array):R<=32&&(s=new Uint32Array(N*w),l=Uint32Array):2===u&&(R<=8?(s=new Int8Array(N*w),l=Int8Array):R<=16?(s=new Int16Array(N*w),l=Int16Array):R<=32&&(s=new Int32Array(f*O*w),l=Int32Array));var L,h,c,y,g,F,d,M,C,D,v=o;if(R%8==0)for(L=0;L<I.length;L++){if(y=L*(o*f)*w,v=(L+1)*o>O?O-L*o:o,"U8"===U||"S8"===U||T){if(8===P||32946===P)F=new Uint8Array(a,I[L],S[L]),C=new t(F),D=C.getBytes(),g=new ArrayBuffer(D.length),F=new Uint8Array(g),F.set(D),F.length!==v*f*w*R/8&&console.log("strip byte counts is different than expected");else if(6===P){F=new Uint8Array(a,I[L],S[L]);var G=new e;G.parse(F);var p=G.getData(G.width,G.height);g=new ArrayBuffer(p.length),F=new Uint8Array(g),F.set(p)}else 1===P&&(S[L]!==v*f*w*R/8&&console.log("strip byte counts is different than expected"),g=a.slice(I[L],I[L]+S[L]));A=new l(g)}else{switch(6===P||8===P||32946===P?(F=new Uint8Array(a,I[L],S[L]),C=new t(F),F=C.getBytes(),g=new ArrayBuffer(F.length),d=new Uint8Array(g),F.length!==v*f*w*R/8&&console.log("strip byte counts is different than expected")):1===P&&(S[L]!==v*f*w*R/8&&console.log("strip byte counts is different than expected"),g=new ArrayBuffer(S[L]),F=new Uint8Array(a,I[L],S[L]),d=new Uint8Array(g)),U){case"U16":case"S16":for(c=0;c<F.length;c+=2)d[c]=F[c+1],d[c+1]=F[c];break;case"U32":case"S32":case"F32":for(c=0;c<F.length;c+=4)d[c]=F[c+3],d[c+1]=F[c+2],d[c+2]=F[c+1],d[c+3]=F[c]}A=new l(g)}s.set(A,y)}var B={width:f,height:O,pixelType:U};if(1===w)B.pixels=[s];else for(B.pixels=[],L=0;L<w;L++){for(M=new l(N),h=0;h<N;h++)M[h]=s[h*w+L];B.pixels.push(M)}return B}}};return{decode:function(e){var t=A(e),n=l(e,t);if(0===n.length)throw"no valid image file directory";var a,r,i=n[0],E=void 0===i.GDAL_NODATA||null===i.GDAL_NODATA?null:parseFloat(i.GDAL_NODATA.values[0]);if(i.TILEOFFSETS?r=T(e,t,i):i.STRIPOFFSETS&&(r=I(e,t,i)),null!==E){if(r.maskData=new Uint8Array(r.width*r.height),Math.abs(E)>1e24)for(a=0;a<r.width*r.height;a++)Math.abs((r.pixels[0][a]-E)/E)<1e-6?r.maskData[a]=0:r.maskData[a]=1;else for(a=0;a<r.width*r.height;a++)r.pixels[0][a]===E?r.maskData[a]=0:r.maskData[a]=1;r.noDataValue=E}return r}}});