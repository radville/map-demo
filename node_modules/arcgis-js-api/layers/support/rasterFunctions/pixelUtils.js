// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../PixelBlock"],function(t,e,n){function r(t,e){return e&&c(t)?e&&e.some(function(e){return e>t.pixels.length})?t:new n({pixelType:t.pixelType,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:e.map(function(e){return t.pixels[e]}),statistics:t.statistics&&e.map(function(e){return t.statistics[e]})}):t}function i(t){if(t){var e=t.colormap;if(e&&0!==e.length){var n=e.sort(function(t,e){return t[0]-e[0]}),r=0;n[0][0]<0&&(r=n[0][0]);var i,a=Math.max(256,n[n.length-1][0]-r+1),l=new Uint8Array(4*a),o=[],f=0,h=0,u=5===n[0].length;if(a>65536)return n.forEach(function(t){o[t[0]-r]=u?t.slice(1):t.slice(1).concat([255])}),{indexed2DColormap:o,offset:r,alphaSpecified:u};if(t.fillUnspecified)for(i=n[h],f=i[0]-r;f<a;f++)l[4*f]=i[1],l[4*f+1]=i[2],l[4*f+2]=i[3],l[4*f+3]=u?i[4]:255,f===i[0]-r&&(i=h===n.length-1?i:n[++h]);else for(f=0;f<n.length;f++)i=n[f],h=4*(i[0]-r),l[h]=i[1],l[h+1]=i[2],l[h+2]=i[3],l[h+3]=u?i[4]:255;return{indexedColormap:l,offset:r,alphaSpecified:u}}}}function a(t,e){if(!c(t))return t;if(!e&&(e.indexedColormap||e.indexed2DColormap))return t;var n=t.clone(),r=n.pixels,i=n.mask,a=n.width*n.height;if(1!==r.length)return t;var l,o=e.indexedColormap,f=e.indexed2DColormap,h=e.offset,u=e.alphaSpecified,s=o.length-1,x=0,m=r[0],p=new Uint8Array(m.length),d=new Uint8Array(m.length),y=new Uint8Array(m.length),g=0;if(o)if(i)for(x=0;x<a;x++)i[x]&&(g=4*(m[x]-h),g<h||g>s?i[x]=0:(p[x]=o[g],d[x]=o[g+1],y[x]=o[g+2],i[x]=o[g+3]));else{for(i=new Uint8Array(a),x=0;x<a;x++)g=4*(m[x]-h),g<h||g>s?i[x]=0:(p[x]=o[g],d[x]=o[g+1],y[x]=o[g+2],i[x]=o[g+3]);n.mask=i}else if(i)for(x=0;x<a;x++)i[x]&&(l=f[m[x]],p[x]=l[0],d[x]=l[1],y[x]=l[2],i[x]=l[3]);else{for(i=new Uint8Array(a),x=0;x<a;x++)l=f[m[x]],p[x]=l[0],d[x]=l[1],y[x]=l[2],i[x]=l[3];n.mask=i}return n.pixels=[p,d,y],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=u,n}function l(t){if(!c(t))return null;var e,n,r,i,a,l,o,f,h,u,s,x,m,p,d,y=t.pixels,g=t.mask,w=t.pixelType,M=t.statistics,v=t.width*t.height,k=y.length,A=[],C=[];for(i=0;i<k;i++){if(l=new Uint32Array(256),f=y[i],"u8"===w)if(e=-.5,n=255.5,g)for(a=0;a<v;a++)g[a]&&l[f[a]]++;else for(a=0;a<v;a++)l[f[a]]++;else{if(e=M[i].minValue,n=M[i].maxValue,r=(n-e)/256,o=new Uint32Array(257),g)for(a=0;a<v;a++)g[a]&&o[Math.floor((f[a]-e)/r)]++;else for(a=0;a<v;a++)o[Math.floor((f[a]-e)/r)]++;for(a=0;a<255;a++)l[a]=o[a];l[255]=o[255]+o[256]}for(A.push({min:e,max:n,size:256,counts:l}),h=0,u=0,m=0,a=0;a<256;a++)h+=l[a],u+=a*l[a];for(p=u/h,a=0;a<256;a++)m+=l[a]*Math.pow(a-p,2);d=Math.sqrt(m/(h-1)),r=(n-e)/256,s=(p+.5)*r+e,x=d*r,C.push({min:e,max:n,avg:s,stddev:x})}return{statistics:C,histograms:A}}function o(t){var e=t.minCutOff,n=t.maxCutOff,r=t.gamma,i=t.pixelType,a=t.outMin||0,l=t.outMax||255;if(-1===["u8","u16","s8","s16"].indexOf(i))return null;var o,h,u=e.length,s=0;"s8"===i?s=-127:"s16"===i&&(s=-32767);var x=256;["u16","s16"].indexOf(i)>-1&&(x=65536);var m=[],p=[],c=l-a;for(o=0;o<u;o++)p[o]=n[o]-e[o],m[o]=c/(n[o]-e[o]);var d=r&&r.length>=u,y=[];if(d)for(o=0;o<u;o++)r[o]>1?r[o]>2?y[o]=6.5+Math.pow(r[o]-2,2.5):y[o]=6.5+100*Math.pow(2-r[o],4):y[o]=1;var g,w,M,v,k=[];if(d)for(o=0;o<u;o++){for(v=[],h=0;h<x;h++)w=h+s,g=(w-e[o])/p[o],M=1,r[o]>1&&(M-=Math.pow(1/c,g*y[o])),w<n[o]&&w>e[o]?v[h]=Math.floor(M*c*Math.pow(g,1/r[o]))+a:w>=n[o]?v[h]=l:v[h]=a;k[o]=v}else for(o=0;o<u;o++){for(v=[],h=0;h<x;h++)w=h+s,w<=e[o]?v[h]=a:w>=n[o]?v[h]=l:v[h]=Math.floor((w-e[o])/p[o]*c)+a;k[o]=v}if(null!=t.contrastOffset){var A=f(t.contrastOffset,t.brightnessOffset);for(o=0;o<u;o++)for(v=k[o],h=0;h<x;h++)v[h]=A[v[h]]}return{lut:k,offset:s}}function f(t,e){var n,r,i=Math.min(Math.max(t,-100),100),a=Math.min(Math.max(e,-100),100),l=new Uint8Array(256);for(n=0;n<256;n++)i>0&&i<100?r=(200*n-25500+510*a)/(2*(100-i))+128:i<=0&&i>-100?r=(200*n-25500+510*a)*(100+i)/2e4+128:100===i?(r=200*n-25500+256*(100-i)+510*a,r=r>0?255:0):-100===i&&(r=128),l[n]=r>255?255:r<0?0:r;return l}function h(t,e){if(!c(t))return null;var n,r,i,a,l,o=t.clone(),f=o.pixels,h=o.mask,u=e.minCutOff,s=e.maxCutOff,x=e.gamma,m=e.outMin||0,p=e.outMax||255,d=o.width*o.height,y=f.length,g=p-m,w=[],M=[];for(n=0;n<y;n++)M[n]=s[n]-u[n],w[n]=g/(s[n]-u[n]);var v=x&&x.length>=y,k=[];if(v)for(n=0;n<y;n++)x[n]>1?x[n]>2?k[n]=6.5+Math.pow(x[n]-2,2.5):k[n]=6.5+100*Math.pow(2-x[n],4):k[n]=1;if(v)if(null!=h){for(r=0;r<d;r++)if(h[r])for(n=0;n<y;n++)i=f[n][r],l=(i-u[n])/M[n],a=1,x[n]>1&&(a-=Math.pow(1/g,l*k[n])),i<s[n]&&i>u[n]?f[n][r]=Math.floor(a*g*Math.pow(l,1/x[n]))+m:i>=s[n]?f[n][r]=p:f[n][r]=m}else for(r=0;r<d;r++)for(n=0;n<y;n++)i=f[n][r],l=(i-u[n])/M[n],a=1,x[n]>1&&(a-=Math.pow(1/g,l*k[n])),i<s[n]&&i>u[n]?f[n][r]=Math.floor(a*g*Math.pow(l,1/x[n]))+m:i>=s[n]?f[n][r]=p:f[n][r]=m;else if(null!=h){for(r=0;r<d;r++)if(h[r])for(n=0;n<y;n++)i=f[n][r],i<s[n]&&i>u[n]?f[n][r]=Math.floor((i-u[n])/M[n]*g)+m:i>=s[n]?f[n][r]=p:f[n][r]=m}else for(r=0;r<d;r++)for(n=0;n<y;n++)i=f[n][r],i<s[n]&&i>u[n]?f[n][r]=Math.floor((i-u[n])/M[n]*g)+m:i>=s[n]?f[n][r]=p:f[n][r]=m;return o.pixelType="u8",o.updateStatistics(),o}function u(t,e){if(!c(t))return null;var r,i,a=t.pixels,l=t.mask,o=t.width*t.height,f=a.length,h=e.lut,u=e.offset;h&&1===h[0].length&&(h=a.map(function(){return h}));var s,x,m,p=[];if(u)if(null==l)for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(o),i=0;i<o;i++)m[i]=x[s[i]-u];p.push(m)}else for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(o),i=0;i<o;i++)l[i]&&(m[i]=x[s[i]-u]);p.push(m)}else if(null==l)for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(o),i=0;i<o;i++)m[i]=x[s[i]];p.push(m)}else for(r=0;r<f;r++){for(s=a[r],x=h[r],m=new Uint8Array(o),i=0;i<o;i++)l[i]&&(m[i]=x[s[i]]);p.push(m)}var d=new n({width:t.width,height:t.height,pixels:p,mask:l,pixelType:"u8"});return d.updateStatistics(),d}function s(t,e){if(!c(t))return null;var n,r,i,a,l,o,f=t.clone(),h=f.pixels,u=f.width*f.height,s=e.length,x=Math.floor(s/2),m=e[Math.floor(x)],p=h[0],d=!1,y=new Uint8Array(u),g=new Uint8Array(u),w=new Uint8Array(u),M=f.mask,v=4===e[0].mappedColor.length;for(M||(M=new Uint8Array(u),M.fill(v?255:1),f.mask=M),l=0;l<u;l++)if(M[l]){for(n=p[l],d=!1,o=x,r=m,i=0,a=s-1;a-i>1;){if(n===r.value){d=!0;break}n>r.value?i=o:a=o,o=Math.floor((i+a)/2),r=e[Math.floor(o)]}d||(n===e[i].value?(r=e[i],d=!0):n===e[a].value?(r=e[a],d=!0):n<e[i].value?(d=!1,r=null):n>e[i].value&&(n<e[a].value?(r=e[i],d=!0):a===s-1?(d=!1,r=null):(r=e[a],d=!0))),d?(y[l]=r.mappedColor[0],g[l]=r.mappedColor[1],w[l]=r.mappedColor[2],M[l]=r.mappedColor[3]):y[l]=g[l]=w[l]=M[l]=0}return f.pixels=[y,g,w],f.mask=M,f.pixelType="u8",f.maskIsAlpha=v,f}function x(t,e,n,r,i,a,l,o){return{xmin:i<=n*t?0:i<n*t+t?i-n*t:t,ymin:a<=r*e?0:a<r*e+e?a-r*e:e,xmax:i+l<=n*t?0:i+l<n*t+t?i+l-n*t:t,ymax:a+o<=r*e?0:a+o<r*e+e?a+o-r*e:e}}function m(t,e){if(!t||0===t.length)return null;var n=t.filter(function(t){return t.pixelBlock})[0];if(!n)return null;var r=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,i=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,a=.01*Math.min(r,i),l=t.sort(function(t,e){return Math.abs(t.extent.ymax-e.extent.ymax)>a?e.extent.ymax-t.extent.ymax:Math.abs(t.extent.xmin-e.extent.xmin)>a?t.extent.xmin-e.extent.xmin:0}),o=Math.min.apply(null,l.map(function(t){return t.extent.xmin})),f=Math.min.apply(null,l.map(function(t){return t.extent.ymin})),h=Math.max.apply(null,l.map(function(t){return t.extent.xmax})),u=Math.max.apply(null,l.map(function(t){return t.extent.ymax})),s={x:Math.round((e.xmin-o)/r),y:Math.round((u-e.ymax)/i)},x={width:Math.round((h-o)/r),height:Math.round((u-f)/i)},m={width:Math.round((e.xmax-e.xmin)/r),height:Math.round((e.ymax-e.ymin)/i)};if(Math.round(x.width/n.pixelBlock.width)*Math.round(x.height/n.pixelBlock.height)!==l.length||s.x<0||s.y<0||x.width<m.width||x.height<m.height)return null;var p=l.map(function(t){return t.pixelBlock});return{extent:e,pixelBlock:d.mosaic(p,x,s,m)}}function p(t,e,r,i){var a=t.filter(function(t){return c(t)})[0];if(null==a)return null;var l,o,f,h,u,s,m,p,d,y,g,w=i?i.width:e.width,M=i?i.height:e.height,v=a.width,k=a.height,A=e.width/v,C=e.height/k,U=r?r.x:0,T=r?r.y:0,B=a.pixelType,O=a.getPixelArrayConstructor(B),S=a.pixels.length,P=[];for(s=0;s<S;s++){for(o=new O(w*M),m=0;m<C;m++)for(p=0;p<A;p++)if(f=t[m*A+p])for(l=f.pixels[s],g=x(v,k,p,m,U,T,w,M),d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)o[h+y]=l[u+y];P.push(o)}var b,D,I=t.some(function(t){return t&&t.mask&&t.mask.length>0});if(I)for(b=new Uint8Array(w*M),m=0;m<C;m++)for(p=0;p<A;p++)if(f=t[m*A+p],D=f?f.mask:null,g=x(v,k,p,m,U,T,w,M),D)for(d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)b[h+y]=D[u+y];else if(f)for(d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)b[h+y]=1;else for(d=g.ymin;d<g.ymax;d++)for(h=(m*k+d-T)*w+(p*v-U),u=d*v,y=g.xmin;y<g.xmax;y++)b[h+y]=0;var L=new n({width:w,height:M,pixels:P,pixelType:B,mask:b});return L.updateStatistics(),L}var c=function(t){return t&&"esri.layers.support.PixelBlock"===t.declaredClass&&t.pixels&&t.pixels.length>0},d={createColormapLUT:i,createContrastBrightnessLUT:f,createStretchLUT:o,colorize:a,estimateStatisticsHistograms:l,extractBands:r,stretch:h,lookupPixels:u,remapColor:s,mosaic:p,mosaicPixelData:m};return d});