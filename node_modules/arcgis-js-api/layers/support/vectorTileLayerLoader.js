// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../config","../../request","../../core/promiseUtils","../../core/urlUtils","../../views/2d/engine/vectorTiles/style/VectorTileSource"],function(e,r,t,l,s,o,n,i,u,a){function c(e,r){return s(this,void 0,void 0,function(){var t,s,o,n,i,a;return l(this,function(l){switch(l.label){case 0:return t={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:""},s="string"==typeof e?[e,null]:[null,e.jsonUrl],o=s[0],n=s[1],i=o?u.urlToObject(o):null,[4,y(t,"esri",e,n,r)];case 1:return l.sent(),a={layerDefinition:t.validatedSource,url:o,parsedUrl:i,serviceUrl:t.sourceUrl,style:t.style,styleUrl:t.styleUrl,spriteUrl:t.style.sprite&&p(t.styleBase,t.style.sprite),glyphsUrl:t.style.glyphs&&p(t.styleBase,t.style.glyphs),sourceNameToSource:t.sourceNameToSource,primarySourceName:t.primarySourceName},f(a.spriteUrl),f(a.glyphsUrl),[2,a]}})})}function f(e){if(e){var r=u.getOrigin(e);U&&-1===U.indexOf(r)&&U.push(r)}}function p(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];for(var t=void 0,l=0;l<e.length;++l)if(u.isProtocolRelative(e[l])){if(t){var s=t.split("://")[0];t=s+":"+e[l].trim()}}else t=u.isAbsolute(e[l])?e[l]:u.join(t,e[l]);return u.removeTrailingSlash(t)}function y(e,r,o,a,c){return s(this,void 0,void 0,function(){var s,p,y,S,U,g;return l(this,function(l){switch(l.label){case 0:return i.throwIfAborted(c),"string"!=typeof o?[3,2]:(S=u.normalize(o),f(S),U=u.urlToObject(S),[4,n(U.path,t({query:{f:"json"},responseType:"json"},c))]);case 1:return y=l.sent(),s=S,p=S,[3,3];case 2:y={data:o},s=o.jsonUrl||null,p=a,l.label=3;case 3:return g=y.data,y.ssl&&(s&&(s=s.replace(/^http:/i,"https:")),p&&(p=p.replace(/^http:/i,"https:"))),d(g)?(e.styleUrl=s||null,[2,m(e,g,p,c)]):h(g)?e.sourceUrl?[2,v(e,g,p,!1,r,c)]:(e.sourceUrl=s||null,[2,v(e,g,p,!0,r,c)]):[2,i.reject("You must specify the URL or the JSON for a service or for a style.")]}})})}function d(e){return!!e.sources}function h(e){return!d(e)}function m(e,r,t,o){return s(this,void 0,void 0,function(){var s,n,a,c,d,h;return l(this,function(l){switch(l.label){case 0:return s=t?u.removeFile(t):u.appBaseUrl,(e.styleBase=s,e.style=r,e.styleUrl&&f(e.styleUrl),n=[],r.sources&&r.sources.esri)?(a=r.sources.esri,a.url?[4,y(e,"esri",p(s,a.url),void 0,o)]:[3,2]):[3,3];case 1:return l.sent(),[3,3];case 2:n.push(y(e,"esri",a,s,o)),l.label=3;case 3:for(c=0,d=Object.keys(r.sources);c<d.length;c++)"esri"!==(h=d[c])&&"vector"===r.sources[h].type&&(r.sources[h].url?n.push(y(e,h,p(s,r.sources[h].url),void 0,o)):n.push(y(e,h,r.sources[h],s,o)));return[4,i.all(n)];case 4:return l.sent(),[2]}})})}function v(e,r,t,o,n,c){return s(this,void 0,void 0,function(){var s,d,h,m;return l(this,function(l){if(s=t?u.removeTrailingSlash(t)+"/":u.appBaseUrl,d=S(r,s),h=new a(n,s,d),!o&&e.primarySourceName in e.sourceNameToSource){if(m=e.sourceNameToSource[e.primarySourceName],!m.isCompatibleWith(h))return[2,i.resolve()];null!=h.fullExtent&&(null!=m.fullExtent?m.fullExtent.union(h.fullExtent):m.fullExtent=h.fullExtent.clone()),m.tileInfo.lods.length<h.tileInfo.lods.length&&(m.tileInfo=h.tileInfo)}return o?(e.sourceBase=s,e.source=r,e.validatedSource=d,e.primarySourceName=n,e.sourceUrl&&f(e.sourceUrl)):f(s),e.sourceNameToSource[n]=h,e.style?[2]:null==r.defaultStyles?[2,i.reject()]:"string"==typeof r.defaultStyles?[2,y(e,"",p(s,r.defaultStyles,"root.json"),void 0,c)]:[2,y(e,"",r.defaultStyles,p(s,"root.json"),c)]})})}function S(e,r){if(e.hasOwnProperty("tileInfo"))return e;for(var t={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},l=78271.51696400007,s=295828763.7957775,o=[],n=e.hasOwnProperty("minzoom")?parseFloat(e.minzoom):0,i=e.hasOwnProperty("maxzoom")?parseFloat(e.maxzoom):16,u=0;u<=i;u++)u>=n&&o.push({level:u,scale:s,resolution:l}),l/=2,s/=2;for(var a=0,c=e.tiles;a<c.length;a++){f(p(r,c[a]))}return{capabilities:"TilesOnly",initialExtent:t,fullExtent:t,minScale:o[0].scale,maxScale:o[o.length-1].scale,tiles:e.tiles,tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:o,spatialReference:{wkid:102100}}}}Object.defineProperty(r,"__esModule",{value:!0});var U=o.defaults&&o.defaults.io.corsEnabledServers;r.loadMetadata=c});