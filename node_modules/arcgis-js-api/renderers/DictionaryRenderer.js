// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../Color","../request","../core/Error","../core/iteratorUtils","../core/lang","../core/Logger","../core/LRUCache","../core/maybe","../core/promiseUtils","../core/accessorSupport/decorators","../layers/support/fieldUtils","./Renderer","./mixins/VisualVariablesMixin","../support/arcadeOnDemand","../symbols/CIMSymbol"],function(e,t,r,i,o,s,n,a,l,u,c,p,h,f,y,d,m,b,g,v,S,_){var w=h.getLogger("esri.renderers.DictionaryRenderer");return function(e){function t(t){var r=e.call(this,t)||this;return r._ongoingRequests=new Map,r._symbolCache=new f(100),r.config=null,r.description=null,r.fieldMap=null,r.label=null,r.scaleExpression=null,r.url=null,r.type="dictionary",r}r(t,e),h=t,t.prototype.clone=function(){return new h({config:p.clone(this.config),scaleExpression:p.clone(this.scaleExpression),description:p.clone(this.description),fieldMap:p.clone(this.fieldMap),label:p.clone(this.label),url:p.clone(this.url),visualVariables:p.clone(this.visualVariables)})},t.prototype.collectRequiredFields=function(e,t){return n(this,void 0,void 0,function(){var r,i;return s(this,function(o){switch(o.label){case 0:return[4,this.collectVVRequiredFields(e,t)];case 1:return o.sent(),this.scaleExpression?[4,b.collectArcadeFieldNames(e,t,this.scaleExpression)]:[3,3];case 2:o.sent(),o.label=3;case 3:r=t.map(function(e){return e.name});for(i in this.fieldMap)r.indexOf(this.fieldMap[i])<0||e.add(this.fieldMap[i]);return[2]}})})},Object.defineProperty(t.prototype,"arcadeRequired",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.fetchResources=function(e){return n(this,void 0,void 0,function(){var t,r,i,n,a,p,h,f,m,b,f,g,v,_,R,M,f,x,j;return s(this,function(s){switch(s.label){case 0:return this.url?(t=y.isSome(e)?e.abortOptions:null,r=l(this.url+"/resources/styles/dictionary-info.json",o({responseType:"json",query:{f:"json"}},t)),[4,d.all([r,S.loadArcade()])]):(w.error("no valid URL!"),[2,void 0]);case 1:if(!(i=s.sent()[0].data))throw new u("esri.renderers.DictionaryRenderer","Bad dictionary data!");if(n=i.expression,a=i.authoringInfo,this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=c.createSetFromValues(i.itemsNames),this._symbolAttributes=a.symbol,p={},this.config){h=this.config;for(f in h)p[f]=h[f]}for(m=0,b=a.configuration;m<b.length;m++)f=b[m],p.hasOwnProperty(f.name)||(p[f.name]=f.value);if(g=[],y.isSome(e)&&e.fields)for(v=function(t){var r=_.fieldMap[t],i=e.fields.filter(function(e){return e.name===r});i.length>0&&g.push(o({},i[0],{name:t}))},_=this,R=0,M=this._symbolAttributes;R<M.length;R++)f=M[R],v(f);return[4,S.createDictionaryExpression(n,y.isSome(e)?e.spatialReference:null,g,p)];case 2:return x=s.sent(),j={scale:0},[2,function(e,t){var r=x.repurposeFeature({geometry:null,attributes:e});return j.scale=y.isSome(t)?t.scale:void 0,x.evaluate({$feature:r,$view:j})}]}})})},t.prototype.getSymbol=function(){return null},t.prototype.getSymbolAsync=function(e,t){return n(this,void 0,void 0,function(){var r,i,o,n,l,u,c,p,h,f,y,d,m,b,g,v,S,_,w,R,M,x,j,N,O;return s(this,function(s){switch(s.label){case 0:return this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(t)),[4,this._dictionaryPromise];case 1:for(r=s.sent(),i={},o=0,n=this._symbolAttributes;o<n.length;o++)l=n[o],u=this.fieldMap[l],u&&null!==e.attributes[u]&&void 0!==e.attributes[u]?(c=""+e.attributes[u],i[l]=c):i[l]="";if(!(p=r(i,t))||"string"!=typeof p)return[2,null];for(h=p.split(";"),f=[],y=[],d=0,m=h;d<m.length;d++)if((b=m[d])&&0!==b.length)if(-1===b.indexOf("po:"))if(-1!==b.indexOf("|"))for(R=0,M=b.split("|");R<M.length;R++)x=M[R],this._itemNames.has(x)&&f.push(x);else this._itemNames.has(b)&&f.push(b);else g=b.substr(3).split("|"),3===g.length&&(v=g[0],S=g[1],_=g[2],"DashTemplate"===S?_=_.split(" ").map(function(e){return Number(e)}):"Color"===S?(w=new a(_).toRgba(),_=[w[0],w[1],w[2],255*w[3]]):_=Number(_),y.push({primitiveName:v,propertyName:S,value:_}));return j=f.join(";")+y.map(function(e){return e.primitiveName+";"+e.propertyName+";"+e.value}),(N=this._symbolCache.get(j))?[2,N]:(O=this._cimPartsToCIMSymbol(f,y,t),this._symbolCache.put(j,O,1),[2,O])}})})},t.prototype.getSymbols=function(){return[]},t.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(e,t){return e+t.getAttributeHash()},"")},t.prototype.getMeshHash=function(){return this.url+"-"+JSON.stringify(this.fieldMap)},t.prototype._getSymbolPart=function(e,t){return n(this,void 0,void 0,function(){var r,i,n;return s(this,function(s){switch(s.label){case 0:return this._ongoingRequests.has(e)?[2,this._ongoingRequests.get(e).then(function(e){return e.data})]:(r=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),i=l(r,o({responseType:"json",query:{f:"json"}},t)),this._ongoingRequests.set(e,i),[4,i]);case 1:return n=s.sent(),[2,n.data]}})})},t.prototype._combineSymbolParts=function(e,t){var r;if(!e||0===e.length)return null;if(1===e.length)return{type:"CIMSymbolReference",symbol:e[0],primitiveOverrides:t};var i=o({},e[0]);i.symbolLayers=[];for(var s=0,n=e;s<n.length;s++){var a=n[s],l=a;(r=i.symbolLayers).unshift.apply(r,l.symbolLayers)}return{type:"CIMSymbolReference",symbol:i,primitiveOverrides:t}},t.prototype._cimPartsToCIMSymbol=function(e,t,r){return n(this,void 0,void 0,function(){var i,o,n;return s(this,function(s){switch(s.label){case 0:for(i=new Array(e.length),o=0;o<e.length;o++)i[o]=this._getSymbolPart(e[o],r);return[4,d.eachAlwaysValues(i)];case 1:return n=s.sent(),[2,new _({data:this._combineSymbolParts(n,t)})]}})})};var h;return i([m.property({type:Object,json:{write:!0}})],t.prototype,"config",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"description",void 0),i([m.property({type:Object,json:{write:!0}})],t.prototype,"fieldMap",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"label",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"scaleExpression",void 0),i([m.property({type:String,json:{write:!0}})],t.prototype,"url",void 0),t=h=i([m.subclass("esri.renderers.DictionaryRenderer")],t)}(m.declared(v.VisualVariablesMixin(g)))});