// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/assignHelper","../..","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../geometry/support/scaleUtils","./support/dotDensityUtils","./support/utils","../heuristics/outline","../statistics/spatialStatistics","../statistics/summaryStatisticsForAttributes","../statistics/support/attributeDensity","../support/utils","../symbology/dotDensity","../../support/AuthoringInfo"],function(e,t,r,i,n,a,s,l,o,u,d,c,p,m,y,b,f,v,h){function g(e){return i(this,void 0,void 0,function(){var t,i,a,l;return r(this,function(r){switch(r.label){case 0:if(!(e&&e.layer&&e.view&&e.attributes&&e.attributes.length))throw new s("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>8)throw new s("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");if(t=n({},e),i=[2,1],a=f.createLayerAdapter(t.layer,i),t.layer=a,t.dotBlendingEnabled=null==t.dotBlendingEnabled||t.dotBlendingEnabled,t.dotValueOptimizationEnabled=null==t.dotValueOptimizationEnabled||t.dotValueOptimizationEnabled,!a)throw new s("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(i).join(", "));return[4,o.all([t.view.when(),a.load()])];case 1:if(r.sent(),"polygon"!==(l=a.geometryType))throw new s("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");return[2,t]}})})}function w(e){return i(this,void 0,void 0,function(){var t,i,n,a,s;return r(this,function(r){switch(r.label){case 0:return t=e.dotDensityScheme,i=null,n=null,[4,c.getBasemapInfo(e.basemap,e.view)];case 1:return a=r.sent(),(i=l.isSome(a.basemapId)?a.basemapId:null,n=l.isSome(a.basemapTheme)?a.basemapTheme:null,t)?[2,{scheme:v.cloneScheme(t),basemapId:i,basemapTheme:n}]:(s=v.getSchemes({basemap:i,numColors:e.attributes.length,basemapTheme:n}),s&&(t=s.primaryScheme,i=s.basemapId,n=s.basemapTheme),[2,{scheme:t,basemapId:i,basemapTheme:n}])}})})}function S(e){return i(this,void 0,void 0,function(){var t,i,n,a,l,c,p,b,f,v,h,g;return r(this,function(r){switch(r.label){case 0:return t=e.view,i=e.layer,n=e.attributes,[4,i.getSampleFeatures({view:t,sampleSize:D,returnGeometry:!0})];case 1:return a=r.sent(),[4,o.all([m({features:a,geometryType:i.geometryType}),y({layer:i,attributes:n,includeZeros:!1,includeNegatives:!1,view:t})])];case 2:if(l=r.sent(),c=l[0],p=l[1],b="avgSize"in c&&c.avgSize,f=p.avg,!b)throw new s("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!f)throw new s("dot-density-renderer:insufficient-info","Average attribute value is invalid");return v=u.getResolutionForScale(t.scale,t.spatialReference),h=b*b/(v*v)*.1,g=d.roundValue(f/h),[2,{dotValue:g||1,referenceScale:t.scale,minSliderValue:1,maxSliderValue:d.roundValue(f)}]}})})}function V(e){return i(this,void 0,void 0,function(){var t,i,n,a,l,o,c,p,m,y,v,h,g,w,S,V;return r(this,function(r){switch(r.label){case 0:t=e.view,i=e.layer,n=e.attributes,a=[],l=0,o=n,r.label=1;case 1:return l<o.length?(c=o[l],[4,f.getFieldsList({field:c.field,valueExpression:c.valueExpression})]):[3,4];case 2:p=r.sent(),a.push.apply(a,p),r.label=3;case 3:return l++,[3,1];case 4:return[4,i.getSampleFeatures({view:t,sampleSize:D,requiredFields:a,returnGeometry:!0})];case 5:return m=r.sent(),[4,b({features:m,attributes:n,includeZeros:!1,includeNegatives:!1,view:t})];case 6:if(y=r.sent(),!y.avgDensity||!y.minDensity||!y.maxDensity)throw new s("dot-density-renderer:insufficient-info","Invalid density values");return v=u.getResolutionForScale(t.scale,t.spatialReference),h=v*v,g=d.roundValue(y.minDensity*h),w=d.roundValue(y.maxDensity*h),S=10,V=d.roundValue(y.avgDensity*h*S)||1,V>w&&(V=w),[2,{dotValue:V,referenceScale:t.scale,minSliderValue:g,maxSliderValue:w}]}})})}function E(e){return i(this,void 0,void 0,function(){var t,i,n,l,u,d,m,y,b,f,v,E,D,T,x,I,z;return r(this,function(r){switch(r.label){case 0:return[4,g(e)];case 1:return t=r.sent(),i=t.layer,n=i.geometryType,[4,w(t)];case 2:if(l=r.sent(),!(u=l&&l.scheme))throw new s("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");return d={layer:i,view:t.view,attributes:t.attributes},m={layer:t.layer,view:t.view},[4,o.all([t.trueDensity?V(d):S(d),t.outlineOptimizationEnabled?p(m):null])];case 3:return y=r.sent(),b=y[0],f=y[1],v=b.dotValue,E=b.referenceScale,D=b.minSliderValue,T=b.maxSliderValue,x=c.createColors(u.colors,t.attributes.length),I=t.attributes.map(function(e,t){return{field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:x[t]}}),z=new a.DotDensityRenderer({attributes:I,dotBlendingEnabled:t.dotBlendingEnabled,outline:f?c.getSymbolOutlineFromScheme(u,n,f.opacity):null,dotValue:v,referenceScale:t.dotValueOptimizationEnabled?E:null,legendOptions:t.legendOptions}),f&&f.visualVariables&&f.visualVariables.length&&(z.visualVariables=f.visualVariables.map(function(e){return e.clone()})),z.authoringInfo=new h({type:"dot-density",minSliderValue:D,maxSliderValue:T}),[2,{renderer:z,dotDensityScheme:u,basemapId:l.basemapId,basemapTheme:l.basemapTheme}]}})})}Object.defineProperty(t,"__esModule",{value:!0});var D=500;t.createRenderer=E});