// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","./size","./type","./support/utils","../heuristics/outline","../statistics/predominantCategories","../statistics/summaryStatistics","../statistics/support/predominanceUtils","../support/utils","../symbology/predominance","../../support/AuthoringInfo","../../support/AuthoringInfoVisualVariable","../../support/numberUtils","../../visualVariables/OpacityVariable"],function(e,i,a,r,n,t,l,s,o,p,u,m,d,c,y,b,f,h,v,g,w,S){function V(e){return n(this,void 0,void 0,function(){var i,n,t,s,o,p,u;return r(this,function(r){switch(r.label){case 0:if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))throw new l("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required");if(e.fields.length<2)throw new l("predominance-renderer:invalid-parameters","Minimum 2 fields are required");if(e.fields.length>10)throw new l("predominance-renderer:invalid-parameters","Maximum 10 fields are supported");if(i=a({},e),i.symbolType=i.symbolType||"2d",i.defaultSymbolEnabled=null==i.defaultSymbolEnabled||i.defaultSymbolEnabled,i.includeOpacityVariable=e.includeOpacityVariable||!1,i.includeSizeVariable=e.includeSizeVariable||!1,i.sortBy=null==i.sortBy?"count":i.sortBy,n=[0,2,1,3],t=f.createLayerAdapter(i.layer,n),i.layer=t,!t)throw new l("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+f.getLayerTypeLabels(n).join(", "));return[4,t.load()];case 1:if(r.sent(),s=t.geometryType,o=i.symbolType.indexOf("3d")>-1,i.outlineOptimizationEnabled="polygon"===s&&i.outlineOptimizationEnabled,i.includeSizeVariable||(i.sizeOptimizationEnabled=("point"===s||"multipoint"===s||"polyline"===s)&&i.sizeOptimizationEnabled),"mesh"===s)i.symbolType="3d-volumetric",i.colorMixMode=i.colorMixMode||"replace",i.edgesType=i.edgesType||"none",i.sizeOptimizationEnabled=!1;else{if(o&&("polyline"===s||"polygon"===s))throw new l("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(i.symbolType.indexOf("3d-volumetric")>-1&&(!i.view||"3d"!==i.view.type))throw new l("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}if(p=i.fields.map(function(e){return e.name}),u=m.verifyBasicFieldValidity(t,p,"predominance-renderer:invalid-parameters"))throw u;return[2,i]}})})}function z(e){return n(this,void 0,void 0,function(){var i,a,n,t,l;return r(this,function(r){switch(r.label){case 0:return i=e.predominanceScheme,a=null,n=null,[4,m.getBasemapInfo(e.basemap,e.view)];case 1:return t=r.sent(),(a=s.isSome(t.basemapId)?t.basemapId:null,n=s.isSome(t.basemapTheme)?t.basemapTheme:null,i)?[2,{scheme:h.cloneScheme(i),basemapId:a,basemapTheme:n}]:(l=h.getSchemes({basemap:a,basemapTheme:n,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view}),l&&(i=l.primaryScheme,a=l.basemapId,n=l.basemapTheme),[2,{scheme:i,basemapId:a,basemapTheme:n}])}})})}function T(e,i,a,l){return n(this,void 0,void 0,function(){var n,s,p,y,b,f,h,g,w,S,V,z,T,E,x,O,I,M,q,C,B,A,F,U,Q,W,j,k,H,L,P;return r(this,function(r){switch(r.label){case 0:return n=e.layer,s={layer:e.layer,view:e.view},h=(f=o).all,g=[c({layer:n,fields:l,view:e.view})],e.outlineOptimizationEnabled?[4,d(s)]:[3,2];case 1:return w=r.sent(),[3,3];case 2:w=null,r.label=3;case 3:return[4,h.apply(f,[g.concat([w])])];case 4:return p=r.sent(),y=p[0],b=p[1],S=y,y&&y.predominantCategoryInfos||(S={predominantCategoryInfos:l.map(function(e){return{value:e,count:0}})}),V=b&&b.opacity,[4,u.createRenderer({layer:n,basemap:e.basemap,valueExpression:i.valueExpression,valueExpressionTitle:t.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:a,statistics:{uniqueValueInfos:S.predominantCategoryInfos},legendOptions:e.legendOptions,outlineOptimizationEnabled:!1,sizeOptimizationEnabled:(!e.includeSizeVariable||!e.sizeOptimizationEnabled)&&e.sizeOptimizationEnabled,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view})];case 5:for(z=r.sent(),T=z.renderer,E=z.basemapId,x=z.basemapTheme,O=z.uniqueValueInfos,I=z.excludedUniqueValueInfos,M=T.uniqueValueInfos,q={},C=0,B=e.fields;C<B.length;C++)A=B[C],F=n.getField(A.name),q[F.name]=A.label||F&&F.alias||A.name;return M.forEach(function(e,i){var a=q[e.value];e.label=a,O[i].label=a}),e.includeSizeVariable&&(U=n.geometryType,Q=null,"polygon"===U?(W=a,j=W.sizeScheme,k=j.background,T.backgroundFillSymbol=m.createSymbol(U,{type:e.symbolType,color:k.color,outline:m.getSymbolOutlineFromScheme(k,U,V)}),Q=j.marker.size,U="point"):"polyline"===U?(H=a,Q=H.width):(L=a,Q=L.size),P=m.createColors(a.colors,M.length),M.forEach(function(i,r){var n=m.createSymbol(U,{type:e.symbolType,color:P[r],size:Q,outline:m.getSymbolOutlineFromScheme(a,U,V),meshInfo:{colorMixMode:e.colorMixMode,edgesType:e.edgesType}});i.symbol=n,O[r].symbol=n.clone()})),b&&b.visualVariables&&b.visualVariables.length&&(T.visualVariables=b.visualVariables.map(function(e){return e.clone()})),T.authoringInfo=new v({type:"predominance",fields:l.slice()}),[2,{renderer:T,predominantCategoryInfos:O,excludedCategoryInfos:I,predominanceScheme:a,basemapId:E,basemapTheme:x}]}})})}function E(e,i,a){return p.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:i.valueExpression,sqlExpression:i.statisticsQuery.sqlExpression,sqlWhere:i.statisticsQuery.sqlWhere,sizeScheme:a,sizeOptimizationEnabled:e.sizeOptimizationEnabled,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:t.sumOfCategories},view:e.view})}function x(e,i){return n(this,void 0,void 0,function(){var a,n,l,s,o,p,u,m;return r(this,function(r){switch(r.label){case 0:return[4,y({layer:e.layer,valueExpression:i.valueExpression,sqlExpression:i.statisticsQuery.sqlExpression,sqlWhere:i.statisticsQuery.sqlWhere,view:e.view})];case 1:return a=r.sent(),n=null==a.avg||null==a.stddev,l=1/e.fields.length*100,s=n?100:a.avg+1.285*a.stddev,s>100&&(s=100),o=w.round([l,s],{strictBounds:!0}),p=new S({valueExpression:i.valueExpression,stops:[{value:o[0],opacity:.15},{value:o[1],opacity:1}],legendOptions:{title:t.strengthOfPredominance}}),u=new g({type:"opacity",minSliderValue:a.min,maxSliderValue:a.max}),m=new v({visualVariables:[u]}),[2,{visualVariable:p,statistics:a,defaultValuesUsed:n,authoringInfo:m}]}})})}function O(e){return n(this,void 0,void 0,function(){var i,a,n,t,l,s,p,u,m,d,c,y,f,h,v,g;return r(this,function(r){switch(r.label){case 0:return[4,V(e)];case 1:return i=r.sent(),a=i.layer,[4,z({basemap:i.basemap,geometryType:a.geometryType,numColors:i.fields.length,predominanceScheme:i.predominanceScheme,worldScale:i.symbolType.indexOf("3d-volumetric")>-1,view:i.view})];case 2:return n=r.sent(),t=n.scheme,l=i.fields.map(function(e){return e.name}),s=b.getPredominanceExpressions(a,l),p=T(i,s.predominantCategory,t,l),u=i.includeSizeVariable?E(i,s.size,t.sizeScheme):null,m=i.includeOpacityVariable?x(i,s.opacity):null,[4,o.all([p,u,m])];case 3:return d=r.sent(),c=d[0],y=d[1],f=d[2],h=[],v=[],y&&(Array.prototype.push.apply(h,y.visualVariables.map(function(e){return e.clone()})),delete y.sizeScheme,c.size=y,Array.prototype.push.apply(v,y.authoringInfo.visualVariables.map(function(e){return e.clone()}))),f&&(h.push(f.visualVariable.clone()),c.opacity=f,Array.prototype.push.apply(v,f.authoringInfo.visualVariables.map(function(e){return e.clone()}))),h.length&&(g=c.renderer.visualVariables||[],Array.prototype.push.apply(g,h),c.renderer.visualVariables=g,c.renderer.authoringInfo.visualVariables=v),[2,c]}})})}Object.defineProperty(i,"__esModule",{value:!0}),i.createRenderer=O});