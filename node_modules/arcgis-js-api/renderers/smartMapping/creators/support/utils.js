// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../symbols","../../../../core/compilerUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../intl/date","../../heuristics/outline","../../statistics/classBreaks","../../statistics/summaryStatistics","../../support/utils","../../../support/numberUtils","../../../support/pointCloud/PointSizeSplatAlgorithm","../../../../views/support/colorUtils"],function(e,t,r,n,i,o,l,a,s,u,c,m,d,f,y,p,h,v,b){function g(e,t,r){if("string"==typeof e){var n=r.getField(e);if(n&&"date"===n.type)return n.alias||n.name}else if("number"==typeof e||e instanceof Date){var i=G.indexOf(t)>-1?"short-date-short-time":"short-date";return m.formatDate(e,m.convertDateFormatToIntlOptions(i))}return e}function w(e,t){return new s(e,t)}function S(e,t,r){var n,i,o=D({statistics:e,isDate:t});return o.defaultValuesUsed?(n=o.min,i=o.max):!r||null!=e.avg&&e.stddev||(n=e.min,i=e.max),null!=n?[n,i]:null}function D(e){var t=e&&e.statistics;t||(t={});var r,n;if(null==t.min)if(e.isDate){var i=z();r=i[0],n=i[1]}else r=0,n=100;else if(t.min===t.max)if(e.isDate){var o=z(t.min);r=o[0],n=o[1]}else t.min<0?(r=2*t.min,n=0):t.min>0?(r=0,n=2*t.min):(r=0,n=100);return{min:null!=r?r:t.min,max:null!=n?n:t.max,defaultValuesUsed:null!=r||null!=n}}function z(e){var t="number"==typeof e?new Date(e):new Date,r=t.getUTCFullYear(),n=Date.UTC(r,0,1,12,0,0,0),i=Date.UTC(r,11,31,12,0,0,0);return"number"==typeof e&&(e<n&&(n=e),e>i&&(i=e)),[n,i]}function x(e,t){for(var r=[],n=e.length,i=0;i<t;i++)r.push(new o(e[i%n]));return r}function L(e,t){void 0===t&&(t=!0);var r=e.avg,n=r-e.stddev,i=r+e.stddev;n<e.min&&(n=e.min),i>e.max&&(i=e.max),t&&(r=n+(i-n)/2);var o=h.round([n,i],{strictBounds:!0});return n=o[0],i=o[1],o=[n,n+(r-n)/2,r,r+(i-r)/2,i],h.round(o,{strictBounds:!0})}function F(e,t,r){switch(t){case"point":case"multipoint":return r?"noDataSize"in e?e.noDataSize:null:"size"in e?e.size:null;case"polyline":return r?"noDataWidth"in e?e.noDataWidth:null:"width"in e?e.width:null;case"polygon":return"size"in e?e.size:null;case"mesh":return;default:return void a.neverReached(t)}}function U(e,t,r){switch(t){case"point":case"multipoint":case"polygon":if(!("outline"in e))return null;var n={color:e.outline.color,width:e.outline.width};if(null!=r&&n.color){var i=n.color.clone();i.a=r,n.color=i}return n;case"polyline":case"mesh":return;default:return void a.neverReached(t)}}function I(e,t){var r,n=t.type,i=t.size,o=t.color,a=t.outline;switch(e){case"point":case"multipoint":if("2d"===n)r=new l.SimpleMarkerSymbol({color:o,size:i,outline:{color:a.color,width:a.width}});else if("3d-flat"===n)r=new l.PointSymbol3D({symbolLayers:[new l.IconSymbol3DLayer({size:i,resource:{primitive:"circle"},material:{color:o},outline:{color:a.color,size:a.width}})]});else if(n.indexOf("3d-volumetric")>-1){var s="3d-volumetric-uniform"===n,u=s?"sphere":"cylinder",c=new l.ObjectSymbol3DLayer({height:i,resource:{primitive:u},material:{color:o}});s||(c.width=t.widthAndDepth,c.depth=t.widthAndDepth),r=new l.PointSymbol3D({symbolLayers:[c]})}break;case"polyline":"2d"===n?r=new l.SimpleLineSymbol({color:o,width:i}):"3d-flat"===n?r=new l.LineSymbol3D({symbolLayers:[new l.LineSymbol3DLayer({size:i,material:{color:o}})]}):"3d-volumetric"===n&&(r=new l.LineSymbol3D({symbolLayers:[new l.PathSymbol3DLayer({size:i,material:{color:o}})]}));break;case"polygon":"2d"===n?r=new l.SimpleFillSymbol({color:o,outline:{color:a.color,width:a.width}}):"3d-flat"===n?r=new l.PolygonSymbol3D({symbolLayers:[new l.FillSymbol3DLayer({material:{color:o},outline:{color:a.color,size:a.width}})]}):"3d-volumetric"===n&&(r=new l.PolygonSymbol3D({symbolLayers:[new l.ExtrudeSymbol3DLayer({size:i,material:{color:o}})]}));break;case"mesh":var m=t.meshInfo&&t.meshInfo.colorMixMode,d=t.meshInfo&&t.meshInfo.edgesType;r=new l.MeshSymbol3D({symbolLayers:[new l.FillSymbol3DLayer({material:{color:o,colorMixMode:m},edges:null==d||"none"===d?null:{type:d,color:E}})]})}return r}function T(e,t,r){var n=V({layer:e,fields:t});if(n.length)return w(r,"Unknown fields: "+n.join(", ")+". You can only use fields defined in the layer schema");var i=k({layer:e,fields:t});return i.length?w(r,"Unsupported fields: "+i.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}function V(e){var t=e.layer;return e.fields.filter(function(e){return!t.getField(e)})}function k(e){var t=e.layer;return e.fields.filter(function(e){var r=t.getFieldUsageInfo(e);return!r||!r.supportsRenderer})}function B(e,t){return i(this,void 0,void 0,function(){var i,o,l,a,s,u,m;return n(this,function(n){switch(n.label){case 0:return i={layer:e.layer,view:e.view},[4,c.all([f(e),t?d(i):null])];case 1:return o=n.sent(),l=o[0],a=o[1],s=S({min:l.minValue,max:l.maxValue,avg:null,stddev:null},!1,!1),s?[4,f(r({},e,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:s[0],maxValue:s[1],normalizationTotal:s[0]+s[1]}))]:[3,3];case 2:return m=n.sent(),[3,4];case 3:m=l,n.label=4;case 4:return u=m,[2,{result:u,defaultValuesUsed:!!s,outlineResult:a}]}})})}function C(e){return y(e)}function P(e,t){var r=e.minSize,n=e.maxSize;if("height"===t){r=((n-r)/2+r)/4.6,n*=2}return{minSize:r,maxSize:n}}function M(e){return j.test(e)}function R(e){var t=e.match(j),r=Number(t[1]);if("%"===t[3])return new v.default({scaleFactor:r/100})}function A(e,t,r,n){e.startTime=t instanceof Date?t.getTime():t,e.endTime=r instanceof Date?r.getTime():r,e.units=n,e.field="string"==typeof t?t:"string"==typeof r?r:null}function O(e,t){return i(this,void 0,void 0,function(){var r,i,o;return n(this,function(n){switch(n.label){case 0:return r=null,(i=null,e||t)?(!e&&t&&(e=t&&t.get("map.basemap")),e&&(r=p.getBasemapId(e,H,!1))&&(o=p.getBasemapGroup(r),u.isSome(o)&&(i=o)),r||!t?[3,2]:[4,b.getBackgroundColorTheme(t)]):[2,{basemapId:r,basemapTheme:i}];case 1:i=n.sent(),u.isSome(i)&&(r="dark"===i?"dark-gray":"gray"),n.label=2;case 2:return[2,{basemapId:r,basemapTheme:i}]}})})}Object.defineProperty(t,"__esModule",{value:!0});var j=/^(\d+(\.\d+)?)\s*(%)$/i,E=[0,0,0,.4],G=["hours","minutes","seconds"],H=[].concat(p.defaultBasemapGroups.light).concat(p.defaultBasemapGroups.dark);t.formatDate=g,t.createError=w,t.getDefaultDataRange=S,t.createColors=x,t.createStopValues=L,t.getSymbolSizeFromScheme=F,t.getSymbolOutlineFromScheme=U,t.createSymbol=I,t.verifyBasicFieldValidity=T,t.getClassBreaks=B,t.getSummaryStatistics=C,t.getSizeRangeForAxis=P,t.isValidPointSize=M,t.getPointSizeAlgorithm=R,t.updateAgeRendererAuthoringInfoVV=A,t.getBasemapInfo=O});