// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","dojo/i18n!../../nls/smartMapping","../..","../../../pointCloudRenderers","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/promiseUtils","./support/utils","../heuristics/outline","../heuristics/sizeRange","../statistics/uniqueValues","../support/utils","../symbology/type","../../support/LegendOptions","../../support/utils"],function(e,r,t,l,i,n,a,o,s,u,c,d,p,m,y,f,b,v,h,g){function w(e){return i(this,void 0,void 0,function(){var r,i,n,a,o,c;return l(this,function(l){switch(l.label){case 0:if(!e||!e.layer||!e.field&&!e.valueExpression)throw new s("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(e.valueExpression&&!e.view)throw new s("type-renderer:missing-parameters","View is required when 'valueExpression' is specified");if(r=t({},e),r.symbolType=r.symbolType||"2d",r.numTypes=null==r.numTypes?10:r.numTypes,r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.sortBy=null==r.sortBy?"count":r.sortBy,r.sortEnabled=null==r.sortEnabled||r.sortEnabled,r.statistics=u.clone(r.statistics),i=[0,2,1,3],n=b.createLayerAdapter(r.layer,i),r.layer=n,!n)throw new s("type-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(i).join(", "));return[4,n.load()];case 1:if(l.sent(),a=n.geometryType,r.outlineOptimizationEnabled="polygon"===a&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=("point"===a||"multipoint"===a||"polyline"===a)&&r.sizeOptimizationEnabled,"mesh"===a)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if("3d-volumetric-uniform"===r.symbolType&&"point"!==a)throw new s("type-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))throw new s("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'")}return[4,b.getFieldsList({field:r.field,valueExpression:r.valueExpression})];case 2:if(o=l.sent(),c=p.verifyBasicFieldValidity(n,o,"type-renderer:invalid-parameters"))throw c;return[2,r]}})})}function T(e){return i(this,void 0,void 0,function(){var r,i,n,a,o;return l(this,function(l){switch(l.label){case 0:if(!(e&&e.layer&&e.field))throw new s("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required");if(r=t({},e),r.statistics=u.clone(r.statistics),i=[4],n=b.createLayerAdapter(r.layer,i),r.layer=n,r.density=r.density||25,r.size=r.size||"100%",!p.isValidPointSize(r.size))throw new s("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'");if(!n)throw new s("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+b.getLayerTypeLabels(i).join(", "));return[4,n.load()];case 1:return l.sent(),[4,b.getFieldsList({field:r.field})];case 2:if(a=l.sent(),o=p.verifyBasicFieldValidity(n,a,"type-point-cloud-class-renderer:invalid-parameters"))throw o;return[2,r]}})})}function S(e){return i(this,void 0,void 0,function(){var r,t,i,n,a;return l(this,function(l){switch(l.label){case 0:return r=e.typeScheme,t=null,i=null,[4,p.getBasemapInfo(e.basemap,e.view)];case 1:return n=l.sent(),(t=c.isSome(n.basemapId)?n.basemapId:null,i=c.isSome(n.basemapTheme)?n.basemapTheme:null,r)?[2,{scheme:v.cloneScheme(r),basemapId:t,basemapTheme:i}]:(a=v.getSchemes({basemap:t,basemapTheme:i,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view}),a&&(r=a.primaryScheme,t=a.basemapId,i=a.basemapTheme),[2,{scheme:r,basemapId:t,basemapTheme:i}])}})})}function E(e,r){return e.label<r.label?-1:e.label>r.label?1:0}function V(e,r){return e.value<r.value?-1:e.value>r.value?1:0}function x(e,r){var t=r.count-e.count;return 0===t&&(t=E(e,r)),t}function z(e,r){var t=r.count-e.count;return 0===t&&(t=V(e,r)),t}function I(e,r,t){var l;"count"===r?(l=z,t&&t.codedValues&&(l=x)):"value"===r&&(l=V,t&&t.codedValues&&(l=E)),l&&e.sort(l)}function M(e,r,o,s){return i(this,void 0,void 0,function(){var i,u,c,d,m,y,f,b,w,T,E,V,x,z,M,q,O,L,F,U,B,P,R,U;return l(this,function(l){switch(l.label){case 0:return i=e.uniqueValueInfos,u=r.layer,c=r.field,d=c?u.getField(c):null,m=d?u.getFieldDomain(d.name):null,y=-1===r.numTypes?i.length:r.numTypes,f=u.geometryType,[4,S({basemap:r.basemap,geometryType:f,typeScheme:r.typeScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view})];case 1:for(b=l.sent(),w=b.scheme,T=new a.UniqueValueRenderer({field:c}),E=-1,x={value:null,domain:m,fieldInfo:d},i.forEach(function(e,r){x.value=e.value,e.label=g.createUniqueValueLabel(x),null===e.value&&(E=r)}),E>-1&&(V=i.splice(E,1)[0]),!1!==r.sortEnabled&&I(i,r.sortBy,m),d&&d.type===C&&(z=i.filter(function(e,r){return r<y}),M=z.map(function(e){return e.value}),x.dateFormatInterval=g.calculateDateFormatInterval(M)),q=o&&o.opacity,O=p.createColors(w.colors,i.length),L=p.getSymbolSizeFromScheme(w,f),F=p.getSymbolOutlineFromScheme(w,f,q),i.forEach(function(e,t){x.value=e.value,e.label=g.createUniqueValueLabel(x),e.symbol=p.createSymbol(f,{type:r.symbolType,color:O[t],size:L,outline:F,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})}),r.valueExpression&&(T.valueExpression=r.valueExpression,T.valueExpressionTitle=r.valueExpressionTitle),r.legendOptions&&(T.legendOptions=new h.LegendOptions(r.legendOptions)),O=p.createColors(w.colors,y),U=0;U<y;U++)(B=i[U])&&T.addUniqueValueInfo({value:B.value,label:B.label,symbol:p.createSymbol(f,{type:r.symbolType,color:O[U],size:L,outline:F,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}})});if(r.defaultSymbolEnabled&&(T.defaultSymbol=p.createSymbol(f,{type:r.symbolType,color:w.noDataColor,size:L,outline:F,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),T.defaultLabel=n.other),V&&(V.symbol=p.createSymbol(f,{type:r.symbolType,color:w.noDataColor,size:L,outline:F,meshInfo:{colorMixMode:r.colorMixMode,edgesType:r.edgesType}}),i.push(V)),P=[],R=T.uniqueValueInfos.length===i.length?-1:T.uniqueValueInfos.length,R>-1)for(U=R;U<i.length;U++)P.push(t({},i[U]));return o&&o.visualVariables&&o.visualVariables.length&&(T.visualVariables=o.visualVariables.map(function(e){return e.clone()})),s&&s.minSize&&(T.visualVariables?T.visualVariables.push(s.minSize):T.visualVariables=[s.minSize]),[2,{renderer:T,uniqueValueInfos:i,excludedUniqueValueInfos:P,typeScheme:v.cloneScheme(w),basemapId:b.basemapId,basemapTheme:b.basemapTheme}]}})})}function q(e,r){return i(this,void 0,void 0,function(){var t,i,n,a,o;return l(this,function(l){switch(l.label){case 0:return t=e.uniqueValueInfos,[4,S({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:r})];case 1:return i=l.sent(),n=i&&i.scheme,a="point-cloud-class"===n.theme,o=a?n.colors:p.createColors(n.colors,t.length),I(t,"value"),[2,t.map(function(e,r){var t=e.value,l=null;return a?(l=o[t])||(l=o[o.length-1]):l=o[r],{values:[t],color:l,label:e.label}})]}})})}function O(e){return i(this,void 0,void 0,function(){var r,t,i,n,a,o,s,u;return l(this,function(l){switch(l.label){case 0:return[4,w(e)];case 1:return r=l.sent(),t=r.layer,i=r.view,n={layer:t,field:r.field,valueExpression:r.valueExpression,returnAllCodedValues:r.returnAllCodedValues,view:i},[4,d.all([null!=r.statistics?r.statistics:f(n),r.outlineOptimizationEnabled?m({layer:t,view:i}):null,r.sizeOptimizationEnabled?y({layer:t,view:i}):null])];case 2:return a=l.sent(),o=a[0],s=a[1],u=a[2],[2,M(o,r,s,u)]}})})}function L(e){return i(this,void 0,void 0,function(){var r,t,i,n,a,s;return l(this,function(l){switch(l.label){case 0:return[4,T(e)];case 1:return r=l.sent(),null==r.statistics?[3,2]:(i=r.statistics,[3,4]);case 2:return[4,f({layer:r.layer,field:r.field})];case 3:i=l.sent(),l.label=4;case 4:return t=i,a=o.PointCloudUniqueValueRenderer.bind,s={field:r.field,pointsPerInch:r.density,pointSizeAlgorithm:p.getPointSizeAlgorithm(r.size)},[4,q(t,r.typeScheme)];case 5:return n=new(a.apply(o.PointCloudUniqueValueRenderer,[void 0,(s.colorUniqueValueInfos=l.sent(),s)])),[2,{renderer:n}]}})})}Object.defineProperty(r,"__esModule",{value:!0});var C="date";r.createRenderer=O,r.createPCClassRenderer=L});