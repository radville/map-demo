// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/promiseUtils","../../utils","../../../../support/heatmapUtils","../../../../../support/arcadeOnDemand","../../../../../tasks/support/ClassBreaksDefinition","../../../../../tasks/support/generateRendererUtils"],function(e,n,a,t,r,i,o,l,u,s){function c(e,n){var a=e&&e.features,t=a&&a[0]&&a[0].attributes,r={};for(var i in t)r[i.replace(O,"").toLowerCase()]=t[i];return r.min===r.max&&null!=r.min&&null==r.stddev&&(r.stddev=r.variance=0),n&&(["min","max","avg","stddev","sum","variance"].forEach(function(e){null!=r[e]&&(r[e]=Math.ceil(r[e]))}),r.min===r.max&&null!=r.min&&(r.avg=r.min,r.stddev=r.variance=0)),r}function m(e,n,r){return t(this,void 0,void 0,function(){var t,i;return a(this,function(a){switch(a.label){case 0:return[4,v(e,n)];case 1:return t=a.sent(),t=f(t,e.minValue,e.maxValue),i=d(t,!e.normalizationType),r&&["avg","stddev","variance"].forEach(function(e){null!=i[e]&&(i[e]=Math.ceil(i[e]))}),[2,i]}})})}function f(e,n,a){return n=null==n?-1/0:n,a=null==a?1/0:a,e.filter(function(e){return null!=e&&k(e)&&e>=n&&e<=a})}function v(e,n){return t(this,void 0,void 0,function(){var t,r,i,o,u,s,c,m,f,v,d;return a(this,function(a){switch(a.label){case 0:return t=e.field,r="function"==typeof t,i=e.valueExpression,o=e.normalizationType,u=e.normalizationField,s=e.normalizationTotal,c=[],m=e.view,f=null,v=null,i?A?[3,2]:[4,l.loadArcade()]:[3,3];case 1:d=a.sent().arcadeUtils,A=d,a.label=2;case 2:f=A.createFunction(i),v=m&&A.getViewInfo({viewingMode:"2d"===m.type?"map":m.viewingMode,scale:m.scale,spatialReference:m.spatialReference}),a.label=3;case 3:return n?(n.forEach(function(e){var n,a=e.attributes;if(i){var l=A.createExecContext(e,v);n=A.executeFunction(f,l)}else r?n=t.call(null,e):a&&(n=a[t]);if(o&&null!=n&&k(n)){var m=a&&parseFloat(a[u]);"log"===o&&0!==n?n=Math.log(n)*Math.LOG10E:"percent-of-total"===o&&k(s)&&0!==s?n=n/s*100:"field"===o&&k(m)&&0!==m&&(n/=m)}c.push(n)}),[2,c]):[2,c]}})})}function d(e,n){for(var a=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,r=null,i=null,o=null,l=null,u=0,s=e;u<s.length;u++){var c=s[u];r+=c,a=Math.min(a,c),t=Math.max(t,c)}var m=e.length;if(m){i=r/m;for(var f=0,v=0,d=e;v<d.length;v++){var c=d[v];f+=Math.pow(c-i,2)}l=n?m>1?f/(m-1):0:m>0?f/m:0,o=Math.sqrt(l)}else a=null,t=null;return{avg:i,count:m,max:t,min:a,stddev:o,sum:r,variance:l}}function h(e){var a;for(a in e)n.statisticTypes.indexOf(a)>-1&&(k(e[a])||(e[a]=null));return e}function p(e){var n=e.field,a=e.classificationMethod||R,t=e.normalizationType,r=e.normalizationField,i=new u;return i.classificationField=n,i.breakCount=e.breakCount,i.classificationMethod=a,i.standardDeviationInterval="standard-deviation"===a?e.standardDeviationInterval||_:void 0,i.normalizationType=t,i.normalizationField="field"===t?r:void 0,i}function x(e,n,a,t,r,i){void 0===n&&(n=10);for(var l=new Float64Array(r*i),u=o.createKernel(n),s=Math.round(3*n),c=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,f=0,v=0,d=0,h=0,p=o.createValueFunction(t,a),x=0,g=e;x<g.length;x++)for(var V=g[x],F=V.geometry,b=V.attributes,T=F.x-s,y=F.y-s,z=Math.max(0,T),E=Math.max(0,y),M=Math.min(i,F.y+s),I=Math.min(r,F.x+s),S=+p(b),w=E;w<M;w++)for(var N=u[w-y],D=z;D<I;D++){var C=u[D-T],k=w*r+D,O=l[k];f=l[k]+=N*C*S;var q=f-O;v+=q,d+=q*q,f<c&&(c=f),f>m&&(m=f),h++}if(!h)return{mean:0,stddev:0,min:0,max:0,mid:0,count:0};var B=(m-c)/2;return{mean:v/h,stdDev:Math.sqrt((d-v*v/h)/h),min:c,max:m,mid:B,count:h}}function g(e,n){return t(this,void 0,void 0,function(){var t,r,i,o;return a(this,function(a){switch(a.label){case 0:return t=e.normalizationTotal,r=p({field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||B}),[4,v(e,n)];case 1:return i=a.sent(),i=f(i,e.minValue,e.maxValue),o=s.createGenerateRendererClassBreaks({definition:r,values:i,normalizationTotal:t}),[2,V(e,o)]}})})}function V(e,n){var a=n.classBreaks,t=a.length,r=a[0].minValue,i=a[t-1].maxValue,o="standard-deviation"===e.classificationMethod,l=q;return a=a.map(function(e){var n=e.label,a={minValue:e.minValue,maxValue:e.maxValue,label:n};if(o&&n){var t=n.match(l),r=t.map(function(e){return+e.trim()});2===r.length?(a.minStdDev=r[0],a.maxStdDev=r[1],r[0]<0&&r[1]>0&&(a.hasAvg=!0)):1===r.length&&(n.indexOf("<")>-1?(a.minStdDev=null,a.maxStdDev=r[0]):n.indexOf(">")>-1&&(a.minStdDev=r[0],a.maxStdDev=null))}return a}),{minValue:r,maxValue:i,classBreakInfos:a,normalizationTotal:n.normalizationTotal}}function F(e,n,a){for(var t,r=(n-e)/a,i=[],o=e,l=1;l<=a;l++)t=o+r,t=Number(t.toFixed(16)),i.push([o,t]),o=t;return i}function b(e){var n=[],a=e.classBreaks,t=a[0].minValue,r=a[a.length-1].maxValue;a.forEach(function(e){n.push([e.minValue,e.maxValue])});var i={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal};return{min:t,max:r,intervals:n,sqlExpr:T(i),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function T(e){var n=e.field,a=e.normalizationType,t=e.normalizationField,r=e.normalizationTotal,i=n;return"percent-of-total"===a?i="(("+n+" / "+r+") * 100)":"log"===a?i="(log("+n+") * "+U+")":"field"===a&&(i="("+n+" / "+t+")"),i}function y(e,n,r){return t(this,void 0,void 0,function(){var t,i,o,l,u,s,c,m,f,d,h;return a(this,function(a){switch(a.label){case 0:return t=n.min,i=n.max,o=n.normTotal,l=e.numBins||L,u=n.intervals||F(t,i,l),s=u.map(function(e,n){return{minValue:u[n][0],maxValue:u[n][1],count:0}}),[4,v(e,r)];case 1:for(c=a.sent(),m=0,f=c;m<f.length;m++)null!=(d=f[m])&&d>=t&&d<=i&&(h=z(u,d))>-1&&s[h].count++;return[2,{bins:s,minValue:t,maxValue:i,normalizationTotal:o}]}})})}function z(e,n){for(var a=-1,t=e.length-1;t>=0;t--){if(n>=e[t][0]){a=t;break}}return a}function E(e,n){var a;if(n=n.toLowerCase(),e)for(var t in e)if(t.toLowerCase()!==n){a=e[t];break}return a}function M(e,n){var a;if(n=n.toLowerCase(),e)for(var t in e)if(t.toLowerCase()===n){a=e[t];break}return a}function I(e,n,a,t,r){var i={};e&&e.features&&e.features.forEach(function(e){var n=e.attributes,a=E(n,"countOFExpr"),t=M(n,"countOFExpr");0!==a&&(i[a]=t)});var o=[];return F(n,a,t).forEach(function(e,n){var a=(n+1).toString();o.push({minValue:e[0],maxValue:e[1],count:i.hasOwnProperty(a)?i[a]:0})}),{bins:o,minValue:n,maxValue:a,normalizationTotal:r}}function S(e,n,a,t){var i=e&&e.features,o="countOF"+(a||"Expr"),l={},u=!1;if(i.forEach(function(e){var n=e.attributes,t=M(n,o),r=a?M(n,a):E(n,o);null===r&&0===t&&(u=!0),(null==r||"string"==typeof r&&""===r.trim())&&(r=null),null==l[r]?l[r]={count:t,data:r}:l[r].count=l[r].count+t}),a&&u){var s=a+" is NULL";return n.queryFeatureCount(s).then(function(e){return e=e||0,l.null.count=l.null.count+e,w(l,t)}).catch(function(){return w(l,t)})}return r.resolve(w(l,t))}function w(e,n){if(n)for(var a in e)e[a].label=n[a];return{count:e}}function N(e,n,a){var t=e.count,r=[];if(a&&n&&"coded-value"===n.type){n.codedValues.forEach(function(e){var n=e.code;t.hasOwnProperty(n)||(t[n]={data:n,count:0})})}for(var i in t){var o=t[i];r.push({value:o.data,count:o.count,label:o.label})}return{uniqueValueInfos:r}}function D(e,n,r){return t(this,void 0,void 0,function(){var t,i,o,l,u;return a(this,function(a){switch(a.label){case 0:return[4,v(e,n)];case 1:for(t=a.sent(),i={},o=0,l=t;o<l.length;o++)u=l[o],(null==u||"string"==typeof u&&""===u.trim())&&(u=null),null==i[u]?i[u]={count:1,data:u}:i[u].count++;return[2,N({count:i},r,e.returnAllCodedValues)]}})})}function C(e,n){return i.getDateDiffSQL(e,new Date(0),n,"milliseconds").sqlExpression}function k(e){return"number"==typeof e&&!isNaN(e)&&e!==1/0&&e!==-1/0}Object.defineProperty(n,"__esModule",{value:!0});var O=/_value$/i,q=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,B=5,L=10,U=Math.LOG10E,R="equal-interval",_=1;n.statisticTypes=["min","max","avg","stddev","count","sum","variance"];var A=null;n.getSummaryStatisticsFromFeatureSet=c,n.calculateStatsFromMemory=m,n.getDataValues=v,n.processSummaryStatisticsResult=h,n.createCBDefn=p,n.calculateHeatmapStats=x,n.calculateClassBreaksFromMemory=g,n.resolveCBResult=V,n.getEqualIntervalBins=F,n.generateBinParams=b,n.getFieldExpr=T,n.calculateHistogramFromMemory=y,n.getHistogramFromFeatureSet=I,n.getUniqueValuesFromFeatureSet=S,n.createUVResult=N,n.calculateUniqueValuesFromMemory=D,n.msSinceUnixEpochSQL=C,n.isValidNumber=k});