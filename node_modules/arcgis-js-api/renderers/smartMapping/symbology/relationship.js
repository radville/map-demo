// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/extendsHelper","../../../Color","./support/colors","./support/SymbologyBase","./support/utils"],function(e,o,r,a,t,s,n,i){function l(e,o,r){var a="mesh"!==e.geometryType&&e.worldScale,t=a?e.view:null,n=s[o],i=e.theme||"default";if(n){var l=i+"/"+e.basemap+"/"+o,h=[];for(var y in n)if("stops"!==y&&"name"!==y&&"tags"!==y){var d=+y,f=n[y];h.push({numClasses:d,colors:f})}switch(e.geometryType){case"point":case"multipoint":var C=r;return p({id:l,name:n.name,tags:n.tags,colorsForClassBreaks:h,noDataColor:C.noDataColor,opacity:1,outline:C.outline,size:C.size},t);case"polyline":var g=r;return c({id:l,name:n.name,tags:n.tags,colorsForClassBreaks:h,noDataColor:g.noDataColor,opacity:1,width:g.width},t);case"polygon":var w=r;return u({id:l,name:n.name,tags:n.tags,colorsForClassBreaks:h,noDataColor:w.noDataColor,opacity:w.fillOpacity,outline:w.outline});case"mesh":var b=r;return m({id:l,name:n.name,tags:n.tags,colorsForClassBreaks:h,noDataColor:b.noDataColor,opacity:b.fillOpacity})}}}function p(e,o){return{id:e.id,name:e.name,tags:e.tags.slice(),colorsForClassBreaks:h(e.colorsForClassBreaks),noDataColor:new t(e.noDataColor),outline:{color:new t(e.outline.color),width:e.outline.width},size:o?i.toWorldScale(e.size,o):e.size,opacity:e.opacity}}function c(e,o){return{id:e.id,name:e.name,tags:e.tags.slice(),colorsForClassBreaks:h(e.colorsForClassBreaks),noDataColor:new t(e.noDataColor),opacity:e.opacity,width:o?i.toWorldScale(e.width,o):e.width}}function u(e){return{id:e.id,name:e.name,tags:e.tags.slice(),colorsForClassBreaks:h(e.colorsForClassBreaks),noDataColor:new t(e.noDataColor),outline:{color:new t(e.outline.color),width:e.outline.width},opacity:e.opacity}}function m(e){return{id:e.id,name:e.name,tags:e.tags.slice(),colorsForClassBreaks:h(e.colorsForClassBreaks),noDataColor:new t(e.noDataColor),opacity:e.opacity}}function h(e){return e.map(function(e){return{numClasses:e.numClasses,colors:e.colors.map(function(e){return e.map(function(e){return new t(e)})})}})}var y={light:{color:[153,153,153,.25],width:"1px"},dark:{color:[153,153,153,.25],width:"1px"},darker:{color:[26,26,26,.25],width:"1px"}},d={lightBasemaps:{primary:"relationship-blue-orange-brown",secondary:["relationship-brewer-yellow-blue-black","relationship-brewer-pink-blue-purple","relationship-purple-green-blue","relationship-blue-green-purple","relationship-blue-orange-green","relationship-mustard-blue-wine","relationship-pink-blue-purple","relationship-olive-blue-green","relationship-yellow-cyan-blue","relationship-blue-pink-purple","relationship-purple-green-wine"]},darkBasemaps:{primary:"relationship-blue-orange-brown",secondary:["relationship-brewer-yellow-blue-black","relationship-brewer-pink-blue-purple","relationship-purple-green-blue","relationship-blue-green-purple","relationship-blue-orange-green","relationship-mustard-blue-wine","relationship-pink-blue-purple","relationship-olive-blue-green","relationship-yellow-cyan-blue","relationship-blue-pink-purple","relationship-purple-green-wine"]}},f={light:{common:{noDataColor:"#aaaaaa",outline:y.light,size:"8px"},primary:d.lightBasemaps.primary,secondary:d.lightBasemaps.secondary},dark:{common:{noDataColor:"#aaaaaa",outline:y.darker,size:"8px"},primary:d.darkBasemaps.primary,secondary:d.darkBasemaps.secondary}},C={light:{common:{noDataColor:"#aaaaaa",width:"2px"},primary:d.lightBasemaps.primary,secondary:d.lightBasemaps.secondary},dark:{common:{noDataColor:"#aaaaaa",width:"2px"},primary:d.darkBasemaps.primary,secondary:d.darkBasemaps.secondary}},g={light:{common:{noDataColor:"#aaaaaa",outline:y.light,fillOpacity:.8},primary:d.lightBasemaps.primary,secondary:d.lightBasemaps.secondary},dark:{common:{noDataColor:"#aaaaaa",outline:y.dark,fillOpacity:.8},primary:d.darkBasemaps.primary,secondary:d.darkBasemaps.secondary}},w={name:"default",label:"Default",description:"Default theme for visualizing features based on relationship between two attributes.",schemes:{point:f,polyline:C,polygon:g}},b={default:w};return new(function(e){function o(){return e.call(this,{themeDictionary:b})||this}return a(o,e),o.prototype.getSchemes=function(e){var o=this.getRawSchemes({theme:"default",basemap:e.basemap,geometryType:e.geometryType,basemapTheme:e.basemapTheme});if(o){var a=o.schemesInfo,t=o.basemapId,s=o.basemapTheme,n=r({},e,{basemap:t});return{primaryScheme:l(n,a.primary,a.common),secondarySchemes:a.secondary.map(function(e){return l(n,e,a.common)}).filter(Boolean),basemapId:t,basemapTheme:s}}},o.prototype.getSchemeByName=function(e){return this.filterSchemesByName(e)},o.prototype.getSchemesByTag=function(e){return this.filterSchemesByTag(e)},o.prototype.cloneScheme=function(e){if(e){var o=r({},e);return o.colorsForClassBreaks=o.colorsForClassBreaks.map(function(e){return{numClasses:e.numClasses,colors:e.colors.map(function(e){return e.map(function(e){return new t(e)})})}}),o.noDataColor&&(o.noDataColor=new t(o.noDataColor)),"outline"in o&&o.outline&&(o.outline={color:o.outline.color&&new t(o.outline.color),width:o.outline.width}),o}},o.prototype.flatten2DArray=function(e,o){var r=[],a=(o||"HH").split(""),t=a[0],s=a[1];"L"===t&&e.reverse();var n="H"===s;return e.forEach(function(e){n&&e.reverse(),r=r.concat(e)}),r},o.prototype.getColors=function(e,o,r){var a;return e.colorsForClassBreaks.some(function(e){return e.numClasses===o&&(a=e.colors),!!a}),a=a.map(function(e){return e.map(function(e){return new t(e)})}),a?this.flatten2DArray(a,r):null},o.prototype.flipColors=function(e,o){var r=o?e:this.cloneScheme(e);return r.colorsForClassBreaks.forEach(function(e){for(var o=e.colors.reverse(),r=[],a=0;a<e.numClasses;a++)!function(e){var a=[];o.forEach(function(o){a.push(o[e])}),r.push(a)}(a);e.colors=r}),r},o.prototype.getMatchingSchemes=function(e){var o=this,r=e.theme||"default",a=e.geometryType,t=e.colors,s=e.numClasses,n=this.themes.get(r);if(n){var i=n.supportedBasemaps,l=[];return i.forEach(function(e){var n=o.getSchemes({theme:r,basemap:e,geometryType:a});if(n){var i=o._compareColorsComprehensive(n.primaryScheme,t,s);i&&l.push(i),n.secondarySchemes.forEach(function(e){(i=o._compareColorsComprehensive(e,t,s))&&l.push(i)})}}),l}},o.prototype._compareColors=function(e,o,r,a){var t,s=this.getColors(e,r,a);if(s){1===i.hasIdenticalColors(o,s)&&(t=e)}return t},o.prototype._compareColorsByFocus=function(e,o,r,a){var t,s=1;do{(t=this._compareColors(e,o,r,a))||(e=this.flipColors(e),s++)}while(!t&&s<=4);return t},o.prototype._compareColorsComprehensive=function(e,o,r){return this._compareColorsByFocus(e,o,r,"HH")||this._compareColorsByFocus(e,o,r,"HL")||this._compareColorsByFocus(e,o,r,"LH")||this._compareColorsByFocus(e,o,r,"LL")},o}(n))});