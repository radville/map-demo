// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../Color","../../core/Logger","../../geometry/support/jsonUtils","../cim/CIMCursor","../cim/CIMEffects","../cim/CIMOperators","../cim/CIMPlacements","./CIMSymbolDrawHelper","./packingUtils"],function(e,r,a,t,i,o,s,n,l,c,f){function m(e,r){switch(r.type){case"CIMSymbolReference":var a={type:"point",x:0,y:0};e.drawSymbol(r.symbol,a);break;case"CIMPointSymbol":var a={type:"point",x:0,y:0};e.drawSymbol(r,a);break;case"CIMTextSymbol":break;case"CIMVectorMarker":var t=new l.Placement;e.drawMarker(r,t)}return e.envelope()}Object.defineProperty(r,"__esModule",{value:!0});var y=Math.PI,h=y/2,v=t.getLogger("esri.symbols.cim.CIMSymbolHelper"),S=function(){function e(){}return e.getEnvelope=function(e){var r=new c.EnvDrawHelper;if(Array.isArray(e)){for(var a=void 0,t=0,i=e;t<i.length;t++){var o=i[t];a?a.union(m(r,o)):a=m(r,o)}return a}return m(r,e)},e.getTextureAnchor=function(e){var r=this.getEnvelope(e);if(!r||r.width<=0||r.height<=0)return[0,0];var a=(r.x+.5*r.width)*(96/72),t=-(r.y+.5*r.height)*(96/72);return[a/(r.width*(96/72)+2),t/(r.height*(96/72)+2)]},e.rasterize=function(e,r,a){void 0===a&&(a=!0);var t=this.getEnvelope(r);if(!t||t.width<=0||t.height<=0)return[null,0,0,0,0];var i=(t.x+.5*t.width)*(96/72),o=(t.y+.5*t.height)*(96/72);e.width=t.width*(96/72)+2,e.height=t.height*(96/72)+2;var s=e.getContext("2d"),n=c.Transformation.createScale(96/72,-96/72);n.translate(.5*e.width-i,.5*e.height+o);var f=new c.CanvasDrawHelper(s,n);switch(r.type){case"CIMPointSymbol":var m={type:"point",x:0,y:0};f.drawSymbol(r,m);break;case"CIMVectorMarker":var y=new l.Placement;f.drawMarker(r,y)}var h=s.getImageData(0,0,e.width,e.height),v=new Uint8Array(h.data);if(a)for(var S=void 0,p=0;p<v.length;p+=4)S=v[p+3]/255,v[p]=v[p]*S,v[p+1]=v[p+1]*S,v[p+2]=v[p+2]*S;return[v,e.width,e.height,-i/e.width,-o/e.height]},e.fromSimpleMarker=function(e){var r,a,t=e.style;if("circle"===t||"esriSMSCircle"===t){var i=Math.acos(.995),o=Math.ceil(y/i/4);0===o&&(o=1),i=h/o,o*=4;var s=[];s.push([50,0]);for(var n=1;n<o;n++)s.push([50*Math.cos(n*i),-50*Math.sin(n*i)]);s.push([50,0]),r={rings:[s]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===t||"esriSMSCross"===t){var l=0;r={rings:[[[l,50],[l,l],[50,l],[50,-l],[l,-l],[l,-50],[-l,-50],[-l,-l],[-50,-l],[-50,l],[-l,l],[-l,50],[l,50]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("diamond"===t||"esriSMSDiamond"===t)r={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===t||"esriSMSSquare"===t)r={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===t||"esriSMSX"===t){var l=0;r={rings:[[[0,l],[50-l,50],[50,50-l],[l,0],[50,l-50],[50-l,-50],[0,-l],[l-50,-50],[-50,l-50],[-l,0],[-50,50-l],[l-50,50],[0,l]]]},a={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("triangle"===t||"esriSMSTriangle"===t){var c=57.735026918962575,f=-c,m=2/3*100-100;r={rings:[[[f,m],[0,2/3*100],[c,m],[f,m]]]},a={xmin:f,ymin:m,xmax:c,ymax:2/3*100}}var v;if(r&&a){var S=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&S.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});var p={type:"CIMPolygonSymbol",symbolLayers:S};v={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:a,markerGraphics:[{type:"CIMMarkerGraphic",geometry:r,symbol:p}]}]}}return v},e.getFillColor=function(r){if(!r)return null;switch(r.type){case"CIMPolygonSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getFillColor(i);if(null!=o)return o}break;case"CIMTextSymbol":return e.getFillColor(r.symbol);case"CIMSolidFill":return r.color}},e.getStrokeColor=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getStrokeColor(i);if(void 0!==o)return o}break;case"CIMTextSymbol":return e.getStrokeColor(r.symbol);case"CIMSolidStroke":return r.color}},e.getStrokeWidth=function(r){if(r)switch(r.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(r.symbolLayers)for(var a=0,t=r.symbolLayers;a<t.length;a++){var i=t[a],o=e.getStrokeWidth(i);if(void 0!==o)return o}break;case"CIMTextSymbol":return e.getStrokeWidth(r.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return r.width}},e.getSize=function(r){if(r)switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":var a=0;if(r.symbolLayers)for(var t=0,i=r.symbolLayers;t<i.length;t++){var o=i[t],s=e.getSize(o);s>a&&(a=s)}return a;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":return r.width;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":return r.size}},e.getMarkerScaleRatio=function(e){if(e)switch(e.type){case"CIMVectorMarker":if(!1!==e.scaleSymbolsProportionally&&e.frame){var r=e.frame.ymax-e.frame.ymin;return e.size/r}}return 1},e.executeEffects=function(e,r,a){void 0===a&&(a=!1);var t=e?e.length:0;t&&a&&--t;for(var i=0;i<t;++i){var o=e[i];if(o){var s=n.getEffectOperator(o);s&&(r=s.execute(r,o,96/72))}}return r},e.processEffects=function(r,a,t){var n;if(r.effects&&r.effects.length>0){var l=o.deltaEncodeGeometry(t);n=new s.SimpleGeometryCursor(l),n=e.executeEffects(r.effects,n)}var c=r.symbolLayers[a];if(c.effects&&c.effects.length>0){var f=!1;if("CIMGeometricEffectDashes"===c.effects[c.effects.length-1].type&&(f=!0),!n){var l=o.deltaEncodeGeometry(t);n=new s.SimpleGeometryCursor(l)}n=e.executeEffects(c.effects,n,f)}if(!n)return t;for(var m=[],y=n.next();y;)m.push(y),y=n.next();var h=m.length;switch(h){case 0:return null;case 1:return o.deltaEncodeGeometry(m[0]);default:for(var v=m[0],S=1;S<h;++S){var p=m[S];i.isPolygon(v)&&i.isPolygon(p)&&Array.prototype.push.apply(v.rings,p.rings),i.isPolyline(v)&&i.isPolyline(p)&&Array.prototype.push.apply(v.paths,p.paths)}return o.deltaEncodeGeometry(v)}},e}();r.CIMSymbolHelper=S;var p=function(){function e(){}return e.rasterizeSimpleFill=function(e,r){"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r||console.error("Unexpected: style does not require rasterization");e.width=8,e.height=8;var a=e.getContext("2d");a.strokeStyle="#FFFFFF",a.lineWidth=1,a.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(a.moveTo(0,0),a.lineTo(0,8)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(a.moveTo(0,0),a.lineTo(8,0)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSForwardDiagonal"!==r||(a.moveTo(0,0),a.lineTo(8,8)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSBackwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(a.moveTo(8,0),a.lineTo(0,8)),a.stroke();for(var t,i=a.getImageData(0,0,e.width,e.height),o=new Uint8Array(i.data),s=0;s<o.length;s+=4)t=o[s+3]/255,o[s]=o[s]*t,o[s+1]=o[s+1]*t,o[s+2]=o[s+2]*t;return[o,e.width,e.height]},e.rasterizeSimpleLine=function(e,r){var a;switch(r){case"butt":a="Butt";break;case"square":a="Square";break;default:a="Round"}var t,i="Butt"===a;switch(e){case"dash":case"esriSLSDash":t=i?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":t=i?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":t=i?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":t=i?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":t=i?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":t=i?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":t=i?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":t=i?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":t=i?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":t=i?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":v.error("Unexpected: style does not require rasterization"),t=[0,0];break;default:v.error("Tried to rasterize SLS, but found an unexpected style: "+e+"!"),t=[0,0]}return this.rasterizeDash(t,a)},e.rasterizeDash=function(e,r){for(var a="Butt"===r,t="Square"===r,i=!a&&!t,o=0,s=0,n=e;s<n.length;s++){var l=n[s];o+=l}for(var c=15*o,m=31*c,y=new Float32Array(m),h=i?225:15,v=0;v<m;++v)y[v]=h;for(var S=0,p=0,u=!0,d=0,M=e;d<M.length;d++){var l=M[d];S=p,p+=15*l;for(var g=S;g<p;){for(var b=0;b<31;){var v=b*c+g,C=i?(b-15)*(b-15):Math.abs(b-15);y[v]=u?a?Math.max(Math.max(S+7.5-g,C),Math.max(g-p+7.5,C)):C:i?Math.min((g-S)*(g-S)+C,(g-p)*(g-p)+C):t?Math.min(Math.max(g-S,C),Math.max(p-g,C)):Math.min(Math.max(g-S+7.5,C),Math.max(p+7.5-g,C)),b++}g++}u=!u}for(var k=y.length,I=new Uint8Array(4*k),v=0;v<k;++v){var x=(i?Math.sqrt(y[v]):y[v])/15;f.packFloatRGBA(x,I,4*v)}return[I,c,31]},e}();r.SymbolHelper=p;var u=function(){function e(){}return e.findApplicableOverrides=function(r,a,t){if(a){if(r.primitiveName){for(var i=!1,o=0,s=t;o<s.length;o++){var n=s[o];if(n.primitiveName===r.primitiveName){i=!0;break}}if(!i)for(var l=0,c=a;l<c.length;l++){var n=c[l];n.primitiveName===r.primitiveName&&t.push(n)}}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(var f=0,m=r.effects;f<m.length;f++){var y=m[f];e.findApplicableOverrides(y,a,t)}if(r.symbolLayers)for(var h=0,v=r.symbolLayers;h<v.length;h++){var S=v[h];e.findApplicableOverrides(S,a,t)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMSolidFill":case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMVectorMarker":case"CIMCharacterMarker":case"CIMPictureMarker":if(r.effects)for(var p=0,u=r.effects;p<u.length;p++){var y=u[p];e.findApplicableOverrides(y,a,t)}if(r.markerPlacement&&e.findApplicableOverrides(r.markerPlacement,a,t),"CIMVectorMarker"===r.type){if(r.markerGraphics)for(var d=0,M=r.markerGraphics;d<M.length;d++){var g=M[d];e.findApplicableOverrides(g,a,t),e.findApplicableOverrides(g.symbol,a,t)}}else"CIMCharacterMarker"===r.type?e.findApplicableOverrides(r.symbol,a,t):"CIMHatchFill"===r.type&&e.findApplicableOverrides(r.lineSymbol,a,t)}}},e.applyOverrides=function(r,a,t,i){if(a){if(r.primitiveName)for(var o=0,s=a;o<s.length;o++){var n=s[o];if(n.primitiveName===r.primitiveName){var l=function(e){return e?e.charAt(0).toLowerCase()+e.substr(1):e}(n.propertyName);if(i&&i.push({cim:r,nocapPropertyName:l,value:r[l]}),n.expression&&(n.value=e.toValue(n.propertyName,n.expression)),t){for(var c=!1,f=0,m=t;f<m.length;f++){var y=m[f];y.primitiveName===r.primitiveName&&(c=!0)}c||t.push(n)}r[l]=n.value}}switch(r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(r.effects)for(var h=0,v=r.effects;h<v.length;h++){var S=v[h];e.applyOverrides(S,a,t,i)}if(r.symbolLayers)for(var p=0,u=r.symbolLayers;p<u.length;p++){var d=u[p];e.applyOverrides(d,a,t,i)}break;case"CIMTextSymbol":break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if(r.effects)for(var M=0,g=r.effects;M<g.length;M++){var S=g[M];e.applyOverrides(S,a,t,i)}if("CIMVectorMarker"===r.type&&r.markerGraphics)for(var b=0,C=r.markerGraphics;b<C.length;b++){var k=C[b];e.applyOverrides(k,a,t,i),e.applyOverrides(k.symbol,a,t,i)}}}},e.restoreOverrides=function(e){for(var r=0,a=e;r<a.length;r++){var t=a[r];t.cim[t.nocapPropertyName]=t.value}},e.buildOverrideKey=function(e){for(var r="",a=0,t=e;a<t.length;a++){var i=t[a];void 0!==i.value&&(r+=""+i.primitiveName+i.propertyName+JSON.stringify(i.value))}return r},e.toValue=function(e,r){if("DashTemplate"===e)return r.split(" ").map(function(e){return Number(e)});if("Color"===e){var t=new a(r).toRgba();return t[3]*=255,t}return r},e}();r.OverrideHelper=u});