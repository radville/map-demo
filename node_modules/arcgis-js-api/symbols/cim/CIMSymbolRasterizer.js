// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../request","../../core/promiseUtils","../../core/screenUtils","../../geometry/support/jsonUtils","./cimAnalyzer","./Rasterizer","./TextRasterizer","./utils","../support/cimSymbolUtils","../support/Symbol3DAnchorPosition2D"],function(e,t,a,r,i,n,o,s,l,c,u,h,p,m){function g(e,t,a){return{geometryType:t,spatialReference:a,fields:(e?Object.keys(e):[]).map(function(t){return{name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"}})}}return function(){function e(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new c.default,this._textRasterizer=new u.default,this._pictureMarkerCache=new Map}return e.prototype.rasterizeCIMSymbolAsync=function(e,t,i,o,c,u){return r(this,void 0,void 0,function(){var r,h,m,f,v,d,y,z,b,_;return a(this,function(a){switch(a.label){case 0:return[4,p.expandSymbol(e)];case 1:return r=a.sent(),h=[],t?(f=null!==t.centroid?"esriGeometryPolygon":s.getJsonType(t.geometry),m=g(t.attributes,f,this._spatialReference)):(r=r.clone(),r.data.primitiveOverrides=[],m=null),v=[],v.push(l.analyzeCIMSymbol(r.data,i,m,h,this._avoidSDF)),[4,n.all(v)];case 2:a.sent(),d=[],y=0,z=h,a.label=3;case 3:return y<z.length?(b=z[y],"CIMPictureMarker"!==b.cim.type?[3,5]:[4,this.fetchPictureMarkerResource(b)]):[3,7];case 4:a.sent(),a.label=5;case 5:_=this._getRasterizedResource(b,t,o,c,u),null!=_&&d.push({cimLayer:b,rasterizedResource:_}),a.label=6;case 6:return y++,[3,3];case 7:return[2,this.getSymbolImage(d,t,o,c,u)]}})})},e.prototype.analyzeCIMSymbol=function(e,t,i,o,s){return r(this,void 0,void 0,function(){var r,c,u,h,m,f;return a(this,function(a){switch(a.label){case 0:return[4,p.expandSymbol(e,s)];case 1:return r=a.sent(),c=[],t?u=g(t,o,this._spatialReference):(r=r.clone(),r.data.primitiveOverrides=[],u=null),h=[],h.push(l.analyzeCIMSymbol(r.data,i,u,c,this._avoidSDF)),[4,n.all(h)];case 2:a.sent(),n.throwIfAborted(s),m=0,a.label=3;case 3:return m<c.length?(f=c[m],"CIMPictureMarker"!==f.cim.type?[3,5]:[4,this.fetchPictureMarkerResource(f,s)]):[3,6];case 4:a.sent(),a.label=5;case 5:return m++,[3,3];case 6:return[2,c]}})})},e.prototype.fetchPictureMarkerResource=function(e,t){return r(this,void 0,void 0,function(){var r,n,o;return a(this,function(a){switch(a.label){case 0:return r=e.materialHash,this._pictureMarkerCache.get(r)?[3,2]:[4,i(e.cim.url,{responseType:"image",signal:t.signal})];case 1:n=a.sent(),o=n.data,this._pictureMarkerCache.set(r,o),a.label=2;case 2:return[2]}})})},e.prototype.rasterizeCIMSymbol=function(e,t,a,r,i){for(var n=[],o=0,s=e;o<s.length;o++){var l=s[o];!a||"function"!=typeof a.scaleFactor||"marker"!==l.type&&"text"!==l.type||(a.scaleFactor=a.scaleFactor(t,r,i));var c=this._getRasterizedResource(l,t,a,r,i);null!=c&&n.push({cimLayer:l,rasterizedResource:c})}return this.getSymbolImage(n,t,a,r,i)},e.prototype.getSymbolImage=function(e,t,a,r,i){for(var n=document.createElement("canvas"),s=n.getContext("2d"),l=0,c=0,u=0,p=0,g=[],f=0;f<e.length;f++){var v=e[f],d=v.rasterizedResource;if(d){var y=v.cimLayer;if("line"!==y.type&&"fill"!==y.type){var z=a.targetSize?a.targetSize/y.referenceSize:a.scaleFactor?a.scaleFactor:1,b=d.size,_=h.evaluateValueOrFunction(y.offsetX,t,r,i)*z,C=h.evaluateValueOrFunction(y.offsetY,t,r,i)*z;_=_||0,C=C||0;var F=v.rasterizedResource.anchorX,S=v.rasterizedResource.anchorY,x=!1,w=y.type,M=void 0;if("marker"===y.type&&(M=h.evaluateValueOrFunction(y.rotation,t,r,i),x=!!y.rotateClockwise&&y.rotateClockwise),"text"===y.type){if(M=h.evaluateValueOrFunction(y.angle,t,r,i),void 0!==y.horizontalAlignment)switch(y.horizontalAlignment){case"left":F=-.5;break;case"right":F=.5;break;default:F=0}if(void 0!==y.verticalAlignment)switch(y.verticalAlignment){case"top":S=.5;break;case"bottom":S=-.5;break;case"baseline":S=-.25;break;default:S=0}}var I=o.pt2px(_)-b[0]*(.5+F),R=o.pt2px(C)-b[1]*(.5+S),O=I+b[0],k=R+b[1];if(M){x&&(M=-M);var D=Math.sin(M*Math.PI/180),A=Math.cos(M*Math.PI/180),P=I*A-R*D,V=I*D+R*A,T=I*A-k*D,X=I*D+k*A,Y=O*A-k*D,H=O*D+k*A,U=O*A-R*D,E=O*D+R*A;I=Math.min(P,T,Y,U),R=Math.min(V,X,H,E),O=Math.max(P,T,Y,U),k=Math.max(V,X,H,E)}l=I<l?I:l,c=R<c?R:c,u=O>u?O:u,p=k>p?k:p;var J=s.createImageData(d.size[0],d.size[1]);J.data.set(new Uint8ClampedArray(d.image.buffer));var L=J,N={offsetX:_,offsetY:C,rotateClockwise:x,type:w,angle:M,rasterizedImage:L,anchorX:F,anchorY:S};g.push(N)}}}n.width=u-l,n.height=p-c;for(var j=-l,q=p,f=0;f<g.length;f++){var N=g[f],G=this._imageDataToCanvas(N.rasterizedImage),B=N.rasterizedImage.width,K=N.rasterizedImage.height,Q=j-B*(.5+N.anchorX),W=q-K*(.5-N.anchorY);if(N.angle){var Z=(360-N.angle)*Math.PI/180;s.save(),s.translate(o.pt2px(N.offsetX),-o.pt2px(N.offsetY)),s.translate(j,q),s.rotate(Z),s.translate(-j,-q),s.drawImage(G,Q,W),s.restore()}else s.drawImage(G,Q+o.pt2px(N.offsetX),W-o.pt2px(N.offsetY))}var $=new m.default({x:j/n.width-.5,y:q/n.height-.5});return{imageData:s.getImageData(0,0,n.width,n.height),anchorPosition:$}},e.prototype._imageDataToCanvas=function(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t},e.prototype._imageTo32Array=function(e,t,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var r=this._imageDataCanvas,i=r.getContext("2d");return r.width=t,r.height=a,i.drawImage(e,0,0,t,a),new Uint32Array(i.getImageData(0,0,t,a).data.buffer)},e.prototype._getRasterizedResource=function(e,t,a,r,i){var n,s;if("text"===e.type)n=e.cim,s=this._rasterizeTextResource(e,t,a,r,i);else{var c=this._resourceCache,u=void 0;if("function"==typeof e.materialHash){u=(0,e.materialHash)(t,r,i),n=l.analyzeCIMResource(e.cim,e.materialOverrides)}else u=e.materialHash,a&&(u+=JSON.stringify(a)),n=e.cim;if(c.has(u))return c.get(u);var p=a.targetSize?a.targetSize/e.referenceSize:a.scaleFactor?a.scaleFactor:1;if(n.size*=p,"CIMPictureMarker"===e.cim.type){var m=h.evaluateValueOrFunction(e.cim.size,t,r,i)*p,g=this._pictureMarkerCache.get(e.materialHash);if(!g)return null;var f=g.height/g.width,v=f>1?o.pt2px(m):o.pt2px(m)/f,d=f>1?o.pt2px(m)*f:o.pt2px(m);s={image:this._imageTo32Array(g,v,d),size:[v,d],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0}}else s=this._rasterizer.rasterizeJSONResource(n,this._avoidSDF);c.set(u,s)}return s},e.prototype._rasterizeTextResource=function(e,t,a,r,i){var n=a.targetSize?a.targetSize/e.referenceSize:a.scaleFactor?a.scaleFactor:1,o=h.evaluateValueOrFunction(e.text,t,r,i);if(!o||0===o.length)return null;var s=h.evaluateValueOrFunction(e.fontName,t,r,i),l=h.evaluateValueOrFunction(e.style,t,r,i),c=h.evaluateValueOrFunction(e.weight,t,r,i),u=h.evaluateValueOrFunction(e.decoration,t,r,i),p=h.evaluateValueOrFunction(e.size,t,r,i)*n,m=h.evaluateValueOrFunction(e.horizontalAlignment,t,r,i),g=h.evaluateValueOrFunction(e.verticalAlignment,t,r,i),f=h.colorToArray(h.evaluateValueOrFunction(e.color,t,r,i)),v=h.colorToArray(h.evaluateValueOrFunction(e.outlineColor,t,r,i)),d=h.evaluateValueOrFunction(e.outlineSize,t,r,i),y={color:f,size:p,horizontalAlignment:m,verticalAlignment:g,font:{family:s,style:l,weight:c,decoration:u},halo:{size:d||0,color:v,style:l},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,y)},e}()});