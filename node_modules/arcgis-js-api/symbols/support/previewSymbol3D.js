// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/colorUtils","../../core/compilerUtils","../../core/Error","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/screenUtils","./gfxUtils","./IconSymbol3DLayerResource","./ObjectSymbol3DLayerResource","./previewUtils","./renderUtils","./styleUtils","./utils"],function(e,a,r,t,s,l,i,o,n,h,p,u,c,m,f,v,y){function d(e){var a=e.outline,r=o.isSome(e.material)?e.material.color:null,t=o.isSome(r)?r.toRgba().toString():null;if(o.isNone(a))return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var s=h.pt2px(a.size)||0;return{color:"rgba("+(o.isSome(a.color)?a.color.toRgba():"255,255,255,1")+")",width:Math.min(s,H)}}function b(e,a){var r=a&&a.resource,t=r&&r.href;return e.thumbnail&&e.thumbnail.url?n.resolve(e.thumbnail.url):t&&"object"!==a.type?n.resolve(y.getIconHref(e,a)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?v.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal},"webRef").catch(function(e){return e}).then(function(e){return e&&e.thumbnail&&e.thumbnail.url||P}):n.resolve(P)}function g(e,a){void 0===a&&(a=1);var r=e.a,s=t.toHSV(e),l=s.h,i=s.s/a,o=100-(100-s.v)/a,n=t.toRGB({h:l,s:i,v:o});return[n.r,n.g,n.b,r]}function x(e,a){return Math.round(Math.min(Math.max(e+255*a*.75,0),255))}function k(e){return"water"===e.type?o.isNone(e.color)?null:e.color:o.isNone(e.material)||o.isNone(e.material.color)?null:e.material.color}function M(e,a){void 0===a&&(a=0);var r=k(e);if(!r){var t=p.defaultThematicColor.r,s=x(t,a);return[s,s,s,100]}for(var l=r.toRgba(),i=0;i<3;i++)l[i]=x(l[i],a);return l}function S(e){return e.outline?d(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function w(e,a){var r=k(e);if(!r)return null;var t="rgba(";return t+=x(r.r,a)+",",t+=x(r.g,a)+",",(t+=x(r.b,a)+",")+r.a+");"}function L(e,a){var r=w(e,a);return r?{color:r,width:Math.min(e.size?h.pt2px(e.size):.75,H)}:{}}function z(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function U(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&t<r}function j(e,a,r){var t=[];if(!e)return t;switch(e.type){case"icon":var l=a,i=a,o=e.resource&&e.resource.primitive||u.defaultPrimitive;switch(o){case"circle":t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:M(e,0),stroke:d(e)});break;case"square":t.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[0,0]},{command:"L",values:[l,0]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:M(e,0),stroke:d(e)});break;case"triangle":t.push({shape:{type:"path",path:[{command:"M",values:[0,i]},{command:"L",values:[.5*l,0]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:M(e,0),stroke:d(e)});break;case"cross":t.push({shape:{type:"path",path:[{command:"M",values:[.5*l,0]},{command:"L",values:[.5*l,i]},{command:"M",values:[0,.5*i]},{command:"L",values:[l,.5*i]}]},stroke:S(e)});break;case"x":t.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[l,i]},{command:"M",values:[l,0]},{command:"L",values:[0,i]}]},stroke:S(e)});break;case"kite":t.push({shape:{type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[.5*l,0]},{command:"L",values:[l,.5*i]},{command:"L",values:[.5*l,i]},{command:"Z",values:[]}]},fill:M(e,0),stroke:d(e)});break;default:s.neverReached(o)}break;case"object":var o=e.resource&&e.resource.primitive||c.defaultPrimitive;switch(o){case"cone":var n=M(e,0),h=M(e,-.6),p=r?A:a,f=z(n,h,p),v=m.getConeShapes(a,r);t.push({shape:v[0],fill:f}),t.push({shape:v[1],fill:f});break;case"inverted-cone":var y=M(e,0),b=M(e,-.6),g=z(y,b,a),x=m.getInvertedConeShapes(a);t.push({shape:x[0],fill:g}),t.push({shape:x[1],fill:y});break;case"cube":var k=m.getCubeShapes(a,r);t.push({shape:k[0],fill:M(e,0)}),t.push({shape:k[1],fill:M(e,-.3)}),t.push({shape:k[2],fill:M(e,-.5)});break;case"cylinder":var w=M(e,0),L=M(e,-.6),U=r?A:a,j=z(w,L,U),D=m.getCylinderShapes(a,r);t.push({shape:D[0],fill:j}),t.push({shape:D[1],fill:j}),t.push({shape:D[2],fill:M(e,0)});break;case"diamond":var R=m.getDiamondShapes(a);t.push({shape:R[0],fill:M(e,-.3)}),t.push({shape:R[1],fill:M(e,0)}),t.push({shape:R[2],fill:M(e,-.3)}),t.push({shape:R[3],fill:M(e,-.7)});break;case"sphere":var I=M(e,0),C=M(e,-.6),O=z(I,C);O.x1=0,O.y1=0,O.x2=.25*a,O.y2=.25*a,t.push({shape:{type:"circle",cx:0,cy:0,r:.5*a},fill:O});break;case"tetrahedron":var P=m.getTetrahedronShapes(a);t.push({shape:P[0],fill:M(e,-.3)}),t.push({shape:P[1],fill:M(e,0)}),t.push({shape:P[2],fill:M(e,-.6)});break;default:s.neverReached(o)}}return t}function D(e){return"icon"===e.type?"multiply":"tint"}function R(e,a){var r,t=a&&a.size?h.pt2px(a.size):null,s=a&&a.maxSize?h.pt2px(a.maxSize):null,l=a&&a.disableUpsampling,i=e.symbolLayers,o=[],p=0,u=0,c=i.getItemAt(i.length-1);return c&&"icon"===c.type&&(r=c.size&&h.pt2px(c.size)),i.forEach(function(i){if("icon"===i.type||"object"===i.type){var c="icon"===i.type?i.size&&h.pt2px(i.size):0,m=t||c?Math.ceil(Math.min(t||c,s||E)):N;if(i&&i.resource&&i.resource.href){var v=b(e,i).then(function(e){var a=i.get("material.color"),r=D(i);return f.tintImageWithColor(e,m,a,r,l)}).then(function(e){var a=e.width,r=e.height;return p=Math.max(p,a),u=Math.max(u,r),[{shape:{type:"image",x:0,y:0,width:a,height:r,src:e.url},fill:null,stroke:null}]});o.unshift(v)}else{var y=m;"icon"===i.type&&r&&t&&(y=m*(c/r));var d=a&&"tall"===a.symbolConfig||"object"===i.type&&U(i);p=Math.max(p,d?A:y),u=Math.max(u,y),o.unshift(n.resolve(j(i,y,d)))}}}),n.eachAlways(o).then(function(e){var r=[];return e.forEach(function(e){e.value?r.push(e.value):e.error&&T.warn("error while building swatchInfo!",e.error)}),f.renderSymbol(r,[p,u],{node:a&&a.node,scale:!1,opacity:a&&a.opacity})})}function I(e,a){var t,s=e.symbolLayers,l=[],i=y.isVolumetricSymbol(e),o=a&&a.size?h.pt2px(a.size):null,p=a&&a.maxSize?h.pt2px(a.maxSize):null,u=p||H,c=0,v=0;return s.forEach(function(e,a){if(e&&("line"===e.type||"path"===e.type)){var s=[];switch(e.type){case"line":var i=L(e,0),n=i&&i.width||0;0===a&&(t=n);var h=Math.min(o||n,u),p=0===a?h:o?h*(n/t):h,f=p>q/2?2*p:q;v=Math.max(v,p),c=Math.max(c,f),i.width=p,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*v]},{command:"L",values:[c,.5*v]}]},stroke:i});break;case"path":var y=Math.min(o||N,u),d=M(e,0),b=M(e,-.2),g=w(e,-.4),i=g?{color:g,width:1}:{};if("quad"===e.profile){var x=e.width||e.size,k=e.height||e.size,S=x&&k?x/k:1,z=m.getPathSymbolShapes(S),U=r({},i,{join:"bevel"});s.push({shape:z[0],fill:b,stroke:U}),s.push({shape:z[1],fill:b,stroke:U}),s.push({shape:z[2],fill:d,stroke:U})}else s.push({shape:m.shapes.pathSymbol3DLayer[0],fill:b,stroke:i}),s.push({shape:m.shapes.pathSymbol3DLayer[1],fill:d,stroke:i});v=Math.max(v,y),c=v}l.push(s)}}),n.resolve(f.renderSymbol(l,[c,v],{node:a&&a.node,scale:i,opacity:a&&a.opacity}))}function C(e,a){for(var t=e.type,s="mesh-3d"===t,l=e.symbolLayers,i=a&&a.size?h.pt2px(a.size):null,o=a&&a.maxSize?h.pt2px(a.maxSize):null,p=i||N,u=[],c=0,v=0,y=!1,b=0;b<l.length;b++){var x=l.getItemAt(b),S=[];if(!s||"fill"===x.type){var w=m.shapes.fill[0];switch(x.type){case"fill":var z=d(x),U=Math.min(p,o||E);c=Math.max(c,U),v=Math.max(v,U),y=!0,S.push({shape:w,fill:M(x,0),stroke:z});break;case"line":var j=L(x,0),D={stroke:j,shape:w};c=Math.max(c,N),v=Math.max(v,N),S.push(D);break;case"extrude":var R=r({join:"round"},L(x,-.4)),I=M(x,0),C=M(x,-.2),O=Math.min(p,o||E),P=m.getExtrudeSymbolShapes(O);R.width=1,S.push({shape:P[0],fill:C,stroke:R}),S.push({shape:P[1],fill:C,stroke:R}),S.push({shape:P[2],fill:I,stroke:R});var H=N,q=.7*N+.5*O;c=Math.max(c,H),v=Math.max(v,q);break;case"water":var A=k(x),I=g(A),T=g(A,2),W=g(A,3),Z=m.getWaterSymbolShapes();y=!0,S.push({shape:Z[0],fill:I}),S.push({shape:Z[1],fill:T}),S.push({shape:Z[2],fill:W});var U=Math.min(p,o||E);c=Math.max(c,U),v=Math.max(v,U)}u.push(S)}}return n.resolve(f.renderSymbol(u,[c,v],{node:a&&a.node,scale:y,opacity:a&&a.opacity}))}function O(e,a){if(0===e.symbolLayers.length)return n.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var r=null;switch(e.type){case"point-3d":r=R(e,a);break;case"line-3d":r=I(e,a);break;case"polygon-3d":case"mesh-3d":r=C(e,a)}return r||n.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}Object.defineProperty(a,"__esModule",{value:!0});var P=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),N=22,E=120,H=80,q=40,A=20,T=i.getLogger("esri.symbols.support.previewSymbol3D");a.getSymbolLayerFill=M,a.previewSymbol3D=O});