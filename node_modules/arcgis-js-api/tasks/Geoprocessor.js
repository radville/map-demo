// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../request","../core/compilerUtils","../core/promiseUtils","../core/accessorSupport/decorators","../geometry/Extent","../geometry/SpatialReference","../geometry/support/normalizeUtils","../layers/support/Field","../layers/support/MapImage","./Task","./support/DataFile","./support/FeatureSet","./support/GPMessage","./support/JobInfo","./support/LinearUnit","./support/ParameterValue","./support/RasterData"],function(e,t,r,a,o,n,u,s,i,c,l,p,f,v,d,m,h,b,y,S,G,g,P,R){return function(t){function h(e){var r=t.call(this,e)||this;return r._timers=new Map,r.outSpatialReference=null,r.processExtent=null,r.processSpatialReference=null,r.returnFeatureCollection=!1,r.returnM=!1,r.returnZ=!1,r}return a(h,t),h.prototype.destroy=function(){this._timers.forEach(function(e){clearInterval(e)})},h.prototype.cancelJob=function(e,t){var a=this.parsedUrl.path,o=r({},this.requestOptions,t,{query:{f:"json"}});return this._clearTimer(e),s(a+"/jobs/"+e+"/cancel",o).then(function(e){return G.fromJSON(e.data)})},h.prototype.checkJobStatus=function(e,t){var a=this.parsedUrl.path,o=r({},this.requestOptions,t,{query:{f:"json"}});return s(a+"/jobs/"+e,o).then(function(e){return G.fromJSON(e.data)})},h.prototype.execute=function(e,t){var r=this;return this._constructRequest("execute",e,t).then(function(e){var t=e.data.results||[],a=e.data.messages||[];return{results:t.map(r._decode),messages:a.map(function(e){return S.fromJSON(e)})}})},h.prototype.getResultData=function(e,t,a){var o=this,n=this,u=n.returnFeatureCollection,i=n.returnM,c=n.returnZ,l=n.outSpatialReference,p=n.parsedUrl,f=p.path,v={returnFeatureCollection:u||void 0,returnM:i||void 0,returnZ:c||void 0,outSR:l,returnType:"data",f:"json"},d=this._gpEncode(v,null),m=r({},this.requestOptions,a,{query:d});return s(f+"/jobs/"+e+"/results/"+t,m).then(function(e){return o._decode(e.data)})},h.prototype.getResultImage=function(e,t,a,o){var n=this,u=this.parsedUrl.path,i=r({},a.toJSON(),{f:"json"}),c=this._gpEncode(i),l=r({},this.requestOptions,o,{query:c});return s(u+"/jobs/"+e+"/results/"+t,l).then(function(e){return n._decode(e.data)})},h.prototype.getResultMapImageLayer=function(t){return u(this,void 0,void 0,function(){var r,a,o,u,s;return n(this,function(n){switch(n.label){case 0:return r=this.parsedUrl.path,a=r.indexOf("/GPServer/"),o=r.substring(0,a),u=o+"/MapServer/jobs/"+t,[4,c.create(function(t){return e(["../layers/MapImageLayer"],t)})];case 1:return s=n.sent(),[2,new s({url:u})]}})})},h.prototype.submitJob=function(e,t){return this._constructRequest("submitJob",e,t).then(function(e){return G.fromJSON(e.data)})},h.prototype.waitForJobCompletion=function(e,t){var r=this;void 0===t&&(t={});var a=t.interval,o=void 0===a?1e3:a,n=t.signal,u=t.statusCallback;return c.create(function(t,a){c.onAbort(n,function(){r._clearTimer(e),a(c.createAbortError())}),r._clearTimer(e);var s=setInterval(function(){r._timers.has(e)||a(c.createAbortError()),r._getJobStatus(e,r.requestOptions).then(function(o){var n=o.jobStatus;switch(n){case"job-succeeded":r._clearTimer(e),t(o);break;case"job-submitted":case"job-executing":case"job-waiting":case"job-new":u&&u(o);break;case"job-cancelled":case"job-cancelling":case"job-deleted":case"job-deleting":case"job-timed-out":case"job-failed":r._clearTimer(e),a(o);break;default:i.neverReached(n)}})},o);r._timers.set(e,s)})},h.prototype._clearTimer=function(e){this._timers.has(e)&&(clearInterval(this._timers.get(e)),this._timers.delete(e))},h.prototype._constructRequest=function(e,t,a){var o=this,n={},u={},i=[];return this._collectGeometries(t,i,n),v.normalizeCentralMeridian(i).then(function(i){var c=o,l=c.outSpatialReference,p=c.parsedUrl,f=c.processExtent,v=c.processSpatialReference,d=c.returnFeatureCollection,m=c.returnM,h=c.returnZ,b=p.path;for(var y in n){var S=n[y];u[y]=i.slice(S[0],S[1])}var G=l?l.wkid||l:null,g=v?v.wkid||v:null,P=f?{context:{extent:f,outSR:G,processSR:g}}:{"env:outSR":G,"env:processSR":g},R="execute"===e?{returnFeatureCollection:d||void 0,returnM:m||void 0,returnZ:h||void 0}:null,_=r({},P,t,R,{f:"json"}),J=o._gpEncode(_,null,u),O=r({},o.requestOptions,a,{query:J});return s(b+"/"+e,O)})},h.prototype._collectGeometries=function(e,t,r){for(var a in e){var o=e[a];if(o&&"object"==typeof o&&o instanceof y){var n=o.features;r[a]=[t.length,t.length+n.length],n.forEach(function(e){t.push(e.geometry)})}}},h.prototype._decode=function(e){var t=e.dataType,r=P.fromJSON(e);switch(t){case"GPBoolean":case"GPDouble":case"GPLong":case"GPString":return r;case"GPDate":r.value=new Date(r.value);break;case"GPDataFile":r.value=b.fromJSON(r.value);break;case"GPLinearUnit":r.value=g.fromJSON(r.value);break;case"GPFeatureRecordSetLayer":case"GPRecordSet":var a=e.value.url;r.value=a?b.fromJSON(r.value):y.fromJSON(r.value);break;case"GPRasterData":case"GPRasterDataLayer":var o=e.value.mapImage;r.value=o?m.fromJSON(o):R.fromJSON(r.value);break;case"GPField":r.value=d.fromJSON(r.value);break;case"GPMultiValue:GPBoolean":case"GPMultiValue:GPDouble":case"GPMultiValue:GPLong":case"GPMultiValue:GPString":return r;case"GPMultiValue:GPDate":var n=r.value;r.value=n.map(function(e){return new Date(e)});break;case"GPMultiValue:GPDataFile":r.value=r.value.map(function(e){return b.fromJSON(e)});break;case"GPMultiValue:GPLinearUnit":r.value=r.value.map(function(e){return g.fromJSON(e)});break;case"GPMultiValue:GPFeatureRecordSetLayer":case"GPMultiValue:GPRecordSet":r.value=r.value.map(function(e){return y.fromJSON(e)});break;case"GPMultiValue:GPRasterData":case"GPMultiValue:GPRasterDataLayer":r.value=r.value.map(function(e){return e?m.fromJSON(e):R.fromJSON(r.value)});break;case"GPMultiValue:GPField":r.value=r.value.map(function(e){return d.fromJSON(e)});break;default:i.neverReached(t)}return r},h.prototype._gpEncode=function(e,t,r){var a=this;for(var o in e){var n=e[o];Array.isArray(n)?e[o]=JSON.stringify(n.map(function(e){return a._gpEncode({item:e},!0).item},this)):n instanceof Date&&(e[o]=n.getTime())}return this._encode(e,t,r)},h.prototype._getJobStatus=function(e,t){var a=this.parsedUrl.path,o=a+"/jobs/"+e,n=r({},this.requestOptions,t,{query:{f:"json"}});return s(o,n).then(function(e){return G.fromJSON(e.data)})},o([l.property({type:f})],h.prototype,"outSpatialReference",void 0),o([l.property({type:p})],h.prototype,"processExtent",void 0),o([l.property({type:f})],h.prototype,"processSpatialReference",void 0),o([l.property({nonNullable:!0})],h.prototype,"returnFeatureCollection",void 0),o([l.property({nonNullable:!0})],h.prototype,"returnM",void 0),o([l.property({nonNullable:!0})],h.prototype,"returnZ",void 0),h=o([l.subclass("esri/tasks/Geoprocessor")],h)}(l.declared(h))});