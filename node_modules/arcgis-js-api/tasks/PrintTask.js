// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/generatorHelper","dojox/gfx/canvas","../kernel","../request","../core/iteratorUtils","../core/jsonMap","../core/lang","../core/promiseUtils","../core/screenUtils","../core/urlUtils","../core/accessorSupport/decorators","../geometry/Polygon","../renderers/visualVariables/support/visualVariableUtils","./Geoprocessor","./Task","./support/fileFormat","./support/layoutTemplate","./support/printTaskUtils","./support/PrintTemplate","./support/Query"],function(e,t,r,a,i,n,s,o,l,u,c,y,p,d,f,h,m,g,S,b,v,_,L,x,O,w){function N(e){return e&&(e.path||"image/svg+xml"===e.contentType)}var J={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},M=new y.default({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),T=new y.default({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),I=new w({returnGeometry:!0});return function(e){function t(t){var r=e.call(this,t)||this;return r._ssExtent=null,r._legendLayers=[],r._legendLayerNameMap={},r._gpServerUrl=null,r._cimVersion=null,r._is11xService=!1,r._gpMetadata=null,r.updateDelay=1e3,r}return i(t,e),Object.defineProperty(t.prototype,"_geoprocessor",{get:function(){return new b({url:this.url})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){return this._gpMetadata&&this._gpMetadata.executionType?T.fromJSON(this._gpMetadata.executionType):"sync"},enumerable:!0,configurable:!0}),t.prototype.execute=function(e,t){var r=this,a=this.url,i=a.lastIndexOf("/GPServer/");return i>0&&(a=a.slice(0,i+9)),d.resolve().then(function(){return r._gpServerUrl===a?{data:r._gpMetadata}:(r._gpServerUrl=a,u(a,{query:{f:"json"}}))}).then(function(t){return r._gpMetadata=t.data,r._cimVersion=r._gpMetadata.cimVersion,r._is11xService=!!r._cimVersion,r._getGpPrintParams(e)}).then(function(e){var a=function(e){return"sync"===r.mode?e.results&&e.results[0]&&e.results[0].value:r._geoprocessor.getResultData(e.jobId,"Output_File",t).then(function(e){return e.value})};return"async"===r.mode?r._geoprocessor.submitJob(e,t).then(function(e){return r._geoprocessor.waitForJobCompletion(e.jobId,{interval:r.updateDelay}).then(a)}):r._geoprocessor.execute(e,t).then(a)})},t.prototype._createOperationalLayers=function(e,t){return a(this,void 0,void 0,function(){var r,a,i,n,o,l,u,c,y,y;return s(this,function(s){switch(s.label){case 0:r=[],a={layerView:null,printTemplate:t,view:e},i=0,t.preserveScale&&(i=t.outScale||e.scale),n=x.getVisibleLayerViews(e,i),o=0,l=n,s.label=1;case 1:return o<l.length?(u=l[o],c=u.layer,!c.loaded||x.isGroupLayer(c)?[3,26]:(y=void 0,a.layerView=u,x.isBingMapsLayer(c)?(y=this._createBingMapsLayerJSON(c),[3,25]):[3,2])):[3,27];case 2:return x.isCSVLayer(c)?[4,this._createCSVLayerJSON(c,a)]:[3,4];case 3:return y=s.sent(),[3,25];case 4:return x.isFeatureLayer(c)?[4,this._createFeatureLayerJSON(c,a)]:[3,6];case 5:return y=s.sent(),[3,25];case 6:return x.isGraphicsLayer(c)?[4,this._createGraphicsLayerJSON(c,a)]:[3,8];case 7:return y=s.sent(),[3,25];case 8:return x.isImageryLayer(c)?(y=this._createImageryLayerJSON(c),[3,25]):[3,9];case 9:return x.isKMLLayer(c)?[4,this._createKMLLayerJSON(c,a)]:[3,11];case 10:return y=s.sent(),[3,25];case 11:return x.isMapImageLayer(c)?(y=this._createMapImageLayerJSON(c,a),[3,25]):[3,12];case 12:return x.isMapNotesLayer(c)?[4,this._createMapNotesLayerJSON(a)]:[3,14];case 13:return y=s.sent(),[3,25];case 14:return x.isOpenStreetMapLayer(c)?(y=this._createOpenStreetMapLayerJSON(),[3,25]):[3,15];case 15:return x.isStreamLayer(c)?[4,this._createStreamLayerJSON(c,a)]:[3,17];case 16:return y=s.sent(),[3,25];case 17:return x.isTileLayer(c)?(y=this._createTileLayerJSON(c),[3,25]):[3,18];case 18:return x.isVectorTileLayer(c)?[4,this._createVectorTileLayerJSON(c,a)]:[3,20];case 19:return y=s.sent(),[3,25];case 20:return x.isWebTileLayer(c)?(y=this._createWebTileLayerJSON(c),[3,25]):[3,21];case 21:return x.isWMSLayer(c)?(y=this._createWMSLayerJSON(c),[3,25]):[3,22];case 22:return x.isWMTSLayer(c)?(y=this._createWMTSLayerJSON(c),[3,25]):[3,23];case 23:return[4,this._createScreenshotJSON(c,a)];case 24:y=s.sent(),s.label=25;case 25:y&&(Array.isArray(y)?r.push.apply(r,y):(y.id=c.id,y.title=this._legendLayerNameMap[c.id]||c.title,y.opacity=c.opacity,y.minScale=c.minScale||0,y.maxScale=c.maxScale||0,r.push(y))),s.label=26;case 26:return o++,[3,1];case 27:return i&&r.forEach(function(e){e.minScale=0,e.maxScale=0}),e.graphics&&e.graphics.length?[4,this._createFeatureCollectionJSON(null,e.graphics,t)]:[3,29];case 28:y=s.sent(),y&&r.push(y),s.label=29;case 29:return[2,r]}})})},t.prototype._createBingMapsLayerJSON=function(e){return{culture:e.culture,key:e.key,type:"BingMaps"+("aerial"===e.style?"Aerial":"hybrid"===e.style?"Hybrid":"Road")}},t.prototype._createCSVLayerJSON=function(e,t){var r=t.layerView,i=t.printTemplate;return a(this,void 0,void 0,function(){var t,a;return s(this,function(n){switch(n.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),this._is11xService?(t={type:"CSV"},e.write(t,{origin:"web-map"}),delete t.popupInfo,delete t.layerType,t.showLabels=i.showLabels&&e.labelsVisible,[3,3]):[3,1];case 1:return[4,this._getGraphics(r)];case 2:return a=n.sent(),[2,this._createFeatureCollectionJSON(e,a,i)];case 3:return[2,t]}})})},t.prototype._createFeatureCollectionJSON=function(e,t,r){return a(this,void 0,void 0,function(){var a,i,n,o,l,u,y,p,d,f,h,m,S,b,v,_,L,O,w=this;return s(this,function(J){switch(J.label){case 0:return a=e,(i=x.createPolygonLayer(),n=x.createPolylineLayer(),o=x.createPointLayer(),l=x.createMultipointLayer(),u=x.createPointLayer(),u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,a&&("esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass?i.layerDefinition.name=n.layerDefinition.name=o.layerDefinition.name=l.layerDefinition.name=this._legendLayerNameMap[a.id]||a.get("arcgisProps.title")||a.title:"esri.layers.GraphicsLayer"===a.declaredClass&&(t=a.graphics.items)),a&&a.renderer?(y=a.renderer.toJSON(),i.layerDefinition.drawingInfo.renderer=y,n.layerDefinition.drawingInfo.renderer=y,o.layerDefinition.drawingInfo.renderer=y,l.layerDefinition.drawingInfo.renderer=y):(delete i.layerDefinition.drawingInfo,delete n.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo),d=a&&a.fields,f=a&&a.renderer,d&&f&&"function"==typeof f.collectRequiredFields)?(h=new Set,[4,f.collectRequiredFields(h,d)]):[3,2];case 1:J.sent(),p=c.valuesOfSet(h),J.label=2;case 2:d&&(m=d.map(function(e){return e.toJSON()}),i.layerDefinition.fields=m,n.layerDefinition.fields=m,o.layerDefinition.fields=m,l.layerDefinition.fields=m),S=t&&t.length,v=function(e){var c,y,d,f,h;return s(this,function(s){switch(s.label){case 0:return c=t[e]||t.getItemAt(e),!1!==c.visible&&c.geometry?(b=c.toJSON(),b.hasOwnProperty("popupTemplate")&&delete b.popupTemplate,b.geometry&&b.geometry.z&&delete b.geometry.z,b.symbol&&b.symbol.outline&&"esriCLS"===b.symbol.outline.type&&!_._is11xService?[2,"continue"]:(!_._is11xService&&b.symbol&&b.symbol.outline&&b.symbol.outline.color&&b.symbol.outline.color[3]&&(b.symbol.outline.color[3]=255),y=a&&a.renderer&&("valueExpression"in a.renderer&&a.renderer.valueExpression||"hasVisualVariables"in a.renderer&&a.renderer.hasVisualVariables()),!b.symbol&&a&&a.renderer&&y&&!_._is11xService?(d=a.renderer,[4,d.getSymbolAsync(c)]):[3,2])):[2,"continue"];case 1:if(!(f=s.sent()))return[2,"continue"];b.symbol=f.toJSON(),"hasVisualVariables"in d&&d.hasVisualVariables()&&x.applyVisualVariables(b.symbol,{renderer:d,graphic:c,symbol:f}),s.label=2;case 2:return b.symbol&&(b.symbol.angle||delete b.symbol.angle,N(b.symbol)?b.symbol=_._convertSvgToPictureMarkerSymbolJson(b.symbol):b.symbol.text&&delete b.attributes),r&&r.forceFeatureAttributes||!p||!p.length||(h={},p.forEach(function(e){b.attributes&&b.attributes.hasOwnProperty(e)&&(h[e]=b.attributes[e])}),b.attributes=h),"polygon"===c.geometry.type?i.featureSet.features.push(b):"polyline"===c.geometry.type?n.featureSet.features.push(b):"point"===c.geometry.type?b.symbol&&b.symbol.text?u.featureSet.features.push(b):o.featureSet.features.push(b):"multipoint"===c.geometry.type?l.featureSet.features.push(b):"extent"===c.geometry.type&&(b.geometry=g.fromExtent(c.geometry).toJSON(),i.featureSet.features.push(b)),[2]}})},_=this,L=0,J.label=3;case 3:return L<S?[5,v(L)]:[3,6];case 4:J.sent(),J.label=5;case 5:return L++,[3,3];case 6:return O=[i,n,l,o,u].filter(function(e){return e.featureSet.features.length>0}),O.forEach(function(e){var t=e.featureSet.features.every(function(e){return e.symbol});!t||r&&r.forceFeatureAttributes||e.featureSet.features.forEach(function(e){delete e.attributes}),t&&delete e.layerDefinition.drawingInfo,e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&w._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)}),[2,O.length?{featureCollection:{layers:O}}:null]}})})},t.prototype._createFeatureLayerJSON=function(e,t){return a(this,void 0,void 0,function(){var r,a,i,n,o,l,u,c,y,p;return s(this,function(s){switch(s.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),(a=e.renderer,e.featureReduction||a&&"dot-density"===a.type)?[2,this._createScreenshotJSON(e,t)]:(i=t.layerView,n=t.printTemplate,o=t.view,l=a&&("valueExpression"in a&&a.valueExpression||"hasVisualVariables"in a&&a.hasVisualVariables()),u=e.source&&"feature-layer"!==e.source.type,!this._is11xService&&l||e.featureReduction||u||!a||"field"in a&&null!=a.field&&("string"!=typeof a.field||!e.getField(a.field))?[3,1]:(r={},this._setURLandToken(r,e),e.write(r,{origin:"web-map"}),delete r.layerType,delete r.popupInfo,delete r.visibility,r.showLabels=n.showLabels&&e.labelsVisible,r.layerDefinition&&r.layerDefinition.drawingInfo&&r.layerDefinition.drawingInfo.renderer&&(this._convertSvgRenderer(r.layerDefinition.drawingInfo.renderer),"visualVariables"in a&&a.visualVariables&&a.visualVariables[0]&&(c=a.visualVariables[0],"size"===c.type&&c.maxSize&&"number"!=typeof c.maxSize&&c.minSize&&"number"!=typeof c.minSize&&(y=S.getSizeRangeAtScale(c,o.scale),r.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=y.minSize,r.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=y.maxSize))),[3,4]));case 1:return[4,this._getGraphics(i)];case 2:return p=s.sent(),[4,this._createFeatureCollectionJSON(e,p,n)];case 3:r=s.sent(),s.label=4;case 4:return[2,r]}})})},t.prototype._createGraphicsLayerJSON=function(e,t){var r=t.printTemplate;return a(this,void 0,void 0,function(){return s(this,function(t){return[2,this._createFeatureCollectionJSON(e,null,r)]})})},t.prototype._createImageryLayerJSON=function(e){this._legendLayers&&this._legendLayers.push({id:e.id});var t={bandIds:e.bandIds,compressionQuality:e.compressionQuality,format:e.format,interpolation:e.interpolation};if((e.mosaicRule||e.definitionExpression)&&(t.mosaicRule=e.exportImageServiceParameters.mosaicRule.toJSON()),e.renderingRule||e.renderer)if(this._is11xService)e.renderingRule&&(t.renderingRule=e.renderingRule.toJSON()),e.renderer&&(t.layerDefinition=t.layerDefinition||{},t.layerDefinition.drawingInfo=t.layerDefinition.drawingInfo||{},t.layerDefinition.drawingInfo.renderer=e.renderer.toJSON());else{var r=e.exportImageServiceParameters.combineRendererWithRenderingRule();r&&(t.renderingRule=r.toJSON())}return this._setURLandToken(t,e),t},t.prototype._createKMLLayerJSON=function(e,t){return a(this,void 0,void 0,function(){var a,i,n,o,l,u,c;return s(this,function(s){switch(s.label){case 0:return a=t.printTemplate,this._is11xService?(i={type:"kml"},e.write(i,{origin:"web-map"}),delete i.layerType,i.url=h.normalize(e.url),[2,i]):(n=[],o=t.layerView,o.allVisibleMapImages.forEach(function(t,r){var a={id:e.id+"_image"+r,type:"image",title:e.id,minScale:e.minScale||0,maxScale:e.maxScale||0,opacity:e.opacity,extent:t.extent};"data:image/png;base64,"===t.href.substr(0,22)?a.imageData=t.href.substr(22):a.url=t.href,n.push(a)}),l=o.allVisiblePoints.items.concat(o.allVisiblePolylines.items,o.allVisiblePolygons.items),c=[{id:e.id}],[4,this._createFeatureCollectionJSON(null,l,a)]);case 1:return u=r.apply(void 0,c.concat([s.sent()])),n.push(u),[2,n]}})})},t.prototype._createMapImageLayerJSON=function(e,t){var r,a=t.view,i={id:e.id,subLayerIds:[]},n=[],s=a.scale,o=function(e){var t=0===s,r=0===e.minScale||s<=e.minScale,a=0===e.maxScale||s>=e.maxScale;if(e.visible&&(t||r&&a))if(e.sublayers)e.sublayers.forEach(o);else{var l=e.toExportImageJSON().drawingInfo,u=e.toJSON();u.layerDefinition.drawingInfo=l,n.unshift(u),i.subLayerIds.push(e.id)}};return e.sublayers&&e.sublayers.forEach(o),n.length&&(n=n.map(function(e){return{id:e.id,name:e.name,layerDefinition:e.layerDefinition}}),r={layers:n,visibleLayers:i.subLayerIds},this._setURLandToken(r,e),this._legendLayers.push(i)),r},t.prototype._createMapNotesLayerJSON=function(e){var t=e.layerView,r=e.printTemplate;return a(this,void 0,void 0,function(){var e,a,i,n,o;return s(this,function(s){switch(s.label){case 0:e=[],a=0,i=t.graphicsViews,s.label=1;case 1:return a<i.length?(n=i[a],[4,this._createFeatureCollectionJSON(n,n.graphics,r)]):[3,4];case 2:o=s.sent(),o&&e.push.apply(e,o.featureCollection.layers),s.label=3;case 3:return a++,[3,1];case 4:return[2,{featureCollection:{layers:e}}]}})})},t.prototype._createOpenStreetMapLayerJSON=function(){return{type:"OpenStreetMap"}},t.prototype._createScreenshotJSON=function(e,t){var r=t.printTemplate,i=t.view;return a(this,void 0,void 0,function(){var t,a,n,o,l,u,c,y,p,d;return s(this,function(s){switch(s.label){case 0:return t={type:"image"},a={format:"png",ignoreBackground:!0,layers:[e],rotation:0},n=this._ssExtent||i.extent.clone(),o=96,l=!0,u=!0,r.exportOptions&&(c=r.exportOptions,c.dpi>0&&(o=c.dpi),c.width>0&&(l=c.width%2==i.width%2),c.height>0&&(u=c.height%2==i.height%2)),"map-only"!==r.layout||!r.preserveScale||r.outScale&&r.outScale!==i.scale||96!==o||l&&u||(a.area={x:0,y:0,width:i.width,height:i.height},l||(a.area.width-=1),u||(a.area.height-=1),this._ssExtent||(y=i.toMap(f.createScreenPoint(a.area.width,a.area.height)),n.ymin=y.y,n.xmax=y.x,this._ssExtent=n)),t.extent=n.clone()._normalize(!0).toJSON(),[4,i.takeScreenshot(a)];case 1:return p=s.sent(),d=h.dataComponents(p.dataUrl),t.imageData=d.data,[2,t]}})})},t.prototype._createStreamLayerJSON=function(e,t){var r=t.layerView,i=t.printTemplate;return a(this,void 0,void 0,function(){var t;return s(this,function(a){switch(a.label){case 0:return this._legendLayers&&this._legendLayers.push({id:e.id}),[4,this._getGraphics(r)];case 1:return t=a.sent(),[2,this._createFeatureCollectionJSON(e,t,i)]}})})},t.prototype._createTileLayerJSON=function(e){var t={};return this._setURLandToken(t,e),t},t.prototype._createVectorTileLayerJSON=function(e,t){return a(this,void 0,void 0,function(){var r,a,i;return s(this,function(n){return this._is11xService&&e.serviceUrl&&e.styleUrl&&(r=l.id&&l.id.findCredential(e.styleUrl),a=l.id&&l.id.findCredential(e.serviceUrl),!r&&!a||"2.1.0"!==this._cimVersion)?(i={type:"VectorTileLayer"},i.styleUrl=h.normalize(e.styleUrl),r&&(i.token=r.token),a&&a.token!==i.token&&(i.additionalTokens=[{url:e.serviceUrl,token:a.token}]),[2,i]):[2,this._createScreenshotJSON(e,t)]})})},t.prototype._createWebTileLayerJSON=function(e){var t=e.urlTemplate.replace(/\${/g,"{"),r={type:"WebTiledLayer",urlTemplate:t,credits:e.copyright};return e.subDomains&&e.subDomains.length>0&&(r.subDomains=e.subDomains),r},t.prototype._createWMSLayerJSON=function(e){var t,r=[],a=function(e){e.visible&&(e.sublayers?e.sublayers.forEach(a):e.name&&r.unshift(e.name))};return e.sublayers&&e.sublayers.forEach(a),r.length&&(t={type:"wms",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,transparentBackground:e.imageTransparency,visibleLayers:r,url:h.normalize(e.url),version:e.version}),t},t.prototype._createWMTSLayerJSON=function(e){var t=e.activeLayer;return{type:"wmts",customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,format:t.imageFormat,layer:t.id,style:t.styleId,tileMatrixSet:t.tileMatrixSetId,url:h.normalize(e.url)}},t.prototype._setURLandToken=function(e,t){if(t.url){e.url=h.normalize(t.url);var r=l.id&&l.id.findCredential(t.url);r&&(e.token=r.token)}},t.prototype._convertSvgToPictureMarkerSymbolJson=function(e){this._canvasParent?(this._canvasSurface.clear(),this._canvasSurface.setDimensions(1024,1024)):(this._canvasParent=document.createElement("div"),this._canvasSurface=o.createSurface(this._canvasParent,1024,1024));var t;t="image/svg+xml"===e.contentType?this._canvasSurface.createObject(o.Image,{src:"data:image/svg+xml;base64,"+e.imageData,width:f.pt2px(e.width),height:f.pt2px(e.height),x:0,y:0}):this._canvasSurface.createObject(o.Path,e.path).setFill(e.color).setStroke(e.outline),"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var r=this._canvasSurface.rawNode.getContext("2d"),a=t.getBoundingBox(),i=Math.ceil(a.width+a.x),n=Math.ceil(a.height+a.y),s=r.getImageData(a.x,a.y,i,n);r.canvas.width=i,r.canvas.height=n,r.putImageData(s,0,0);return{type:"esriPMS",imageData:r.canvas.toDataURL("image/png").substr(22),angle:e.angle,contentType:"image/png",height:e.size?e.size:n-a.y,width:e.size?e.size:i-a.x,xoffset:e.xoffset,yoffset:e.yoffset}},t.prototype._convertSvgRenderer=function(e){var t=this,r=e.type;if("simple"===r&&N(e.symbol))e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol);else if("unique-value"===r||"class-breaks"===r){N(e.defaultSymbol)&&(e.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol));var a="unique-value"===r?"uniqueValueInfos":"classBreakInfos",i=e[a];i&&i.forEach(function(e){N(e.symbol)&&(e.symbol=t._convertSvgToPictureMarkerSymbolJson(e.symbol))})}},t.prototype._getGraphics=function(e){return e.queryFeatures(I).then(function(e){return e.features})},t.prototype._getPrintDefinition=function(e,t){return a(this,void 0,void 0,function(){var r,a,i,n,o;return s(this,function(s){switch(s.label){case 0:return r=e.view,a=r.spatialReference,n={},[4,this._createOperationalLayers(r,t)];case 1:return n.operationalLayers=s.sent(),i=n,o=this._ssExtent||e.extent||r.extent,a&&a.isWrappable&&(o=o.clone()._normalize(!0),a=o.spatialReference),i.mapOptions={extent:o&&o.toJSON(),spatialReference:a&&a.toJSON(),showAttribution:t.attributionVisible},this._ssExtent=null,r.rotation&&(i.mapOptions.rotation=-r.rotation),t.preserveScale&&(i.mapOptions.scale=t.outScale||r.scale),[2,i]}})})},t.prototype._getGpPrintParams=function(e){return a(this,void 0,void 0,function(){var t,r,a,i,n,o,l,u,c,y,d,f,h,m,g,S,b,v,x,w=this;return s(this,function(s){switch(s.label){case 0:return t=e.template||new O,null==t.showLabels&&(t.showLabels=!0),r=t.exportOptions,i=L.toJSON(t.layout),r&&(n=r.dpi,a={dpi:n},"map_only"!==i.toLowerCase()&&""!==i||(o=r.width,l=r.height,a.outputSize=[o,l])),u=t.layoutOptions,u&&(y=void 0,d=void 0,"Miles"===u.scalebarUnit||"Kilometers"===u.scalebarUnit?(y="Kilometers",d="Miles"):"Meters"!==u.scalebarUnit&&"Feet"!==u.scalebarUnit||(y="Meters",d="Feet"),c={titleText:u.titleText,authorText:u.authorText,copyrightText:u.copyrightText,customTextElements:u.customTextElements,scaleBarOptions:{metricUnit:M.toJSON(y),metricLabel:J[y],nonMetricUnit:M.toJSON(d),nonMetricLabel:J[d]}}),f=null,u&&u.legendLayers&&(f=u.legendLayers.map(function(e){w._legendLayerNameMap[e.layerId]=e.title;var t={id:e.layerId};return e.subLayerIds&&(t.subLayerIds=e.subLayerIds),t})),[4,this._getPrintDefinition(e,t)];case 1:return h=s.sent(),h.operationalLayers&&(g=new RegExp("[\\u4E00-\\u9FFF\\u0E00-\\u0E7F\\u0900-\\u097F\\u3040-\\u309F\\u30A0-\\u30FF\\u31F0-\\u31FF]"),S=/[\u0600-\u06FF]/,b=function(e){var t=e.text,r=e.font,a=r&&r.family&&r.family.toLowerCase();t&&r&&("arial"===a||"arial unicode ms"===a)&&(r.family=g.test(t)?"Arial Unicode MS":"Arial","normal"!==r.style&&S.test(t)&&(r.family="Arial Unicode MS"))},h.operationalLayers.forEach(function(e){e.featureCollection&&e.featureCollection.layers&&e.featureCollection.layers.forEach(function(e){e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&e.layerDefinition.drawingInfo.renderer.symbol&&(m=e.layerDefinition.drawingInfo.renderer,"esriTS"===m.symbol.type&&b(m.symbol)),e.featureSet&&e.featureSet.features&&e.featureSet.features.forEach(function(e){e.symbol&&"esriTS"===e.symbol.type&&b(e.symbol)})})})),e.outSpatialReference&&(h.mapOptions.spatialReference=e.outSpatialReference.toJSON()),p.mixin(h,{exportOptions:a,layoutOptions:c}),p.mixin(h.layoutOptions,{legendOptions:{operationalLayers:null!=f?f:this._legendLayers.slice()}}),this._legendLayers.length=0,v=JSON.stringify(h),x={Web_Map_as_JSON:v,Format:_.toJSON(t.format),Layout_Template:i},e.extraParameters&&p.mixin(x,e.extraParameters),[2,x]}})})},n([m.property({dependsOn:["url"]})],t.prototype,"_geoprocessor",null),n([m.property()],t.prototype,"_gpMetadata",void 0),n([m.property({dependsOn:["_gpMetadata"],readOnly:!0})],t.prototype,"mode",null),n([m.property()],t.prototype,"updateDelay",void 0),t=n([m.subclass("esri.tasks.PrintTask")],t)}(m.declared(v))});