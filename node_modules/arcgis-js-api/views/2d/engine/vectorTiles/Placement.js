// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","./Conflict","./GeometryUtils","../webgl/Geometry"],function(t,e,n,o,i){Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,o,i){void 0===n&&(n=0),void 0===o&&(o=-1),void 0===i&&(i=s),this.x=t,this.y=e,this.angle=n,this.segment=o,this.minzoom=i}return t}();e.Anchor=r;var a=function(){function t(t,e,n,i,r,a,l){void 0===r&&(r=!1),void 0===a&&(a=s),void 0===l&&(l=o.C_INFINITY),this.anchor=t,this.labelAngle=e,this.glyphAngle=n,this.page=i,this.upsideDown=r,this.minzoom=a,this.maxzoom=l}return t}(),l=function(){function t(t,e,n,o,i,r,a,l,h,s){this.tl=t,this.tr=e,this.bl=n,this.br=o,this.mosaicRect=i,this.labelAngle=r,this.anchor=a,this.minzoom=l,this.maxzoom=h,this.page=s}return t}();e.PlacedSymbol=l;var h=function(){function t(t,e){this.footprint=t,this.shapes=e}return t}();e.Placement=h;var s=.5,c=function(){function t(){this.mapAngle=0,this._conflictEngine=new n.ConflictEngine}return t.prototype.reset=function(){this._conflictEngine.reset()},t.prototype.setAngle=function(t){this.mapAngle=t},t.prototype.getIconPlacement=function(t,e,r,a,c){var p=r.width/r.pixelRatio,g=r.height/r.pixelRatio,m=c.offset[0]-p/2,f=c.offset[1]-g/2,u=m+p,I=f+g,d=r.rect,x=2/r.pixelRatio,w=m-x,y=f-x,_=w+d.width/r.pixelRatio,v=y+d.height/r.pixelRatio,N=new i.Point(w,y),P=new i.Point(_,v),A=new i.Point(w,v),T=new i.Point(_,y),b=c.rotate*o.C_DEG_TO_RAD,E=1===c.rotationAlignment;if(t.segment>=0&&!E&&(b+=t.angle),0!==b){var C=Math.cos(b),M=Math.sin(b);N.rotate(C,M),P.rotate(C,M),A.rotate(C,M),T.rotate(C,M)}var z=8*c.padding,F=new i.Point(t.x,t.y),Y=new n.Footprint(this.mapAngle,z,E);Y.addBox(F,new n.Box(m,f,u,I),a,b,e,s,o.C_INFINITY);var B=new l(N,T,A,P,d,0,F,s,o.C_INFINITY,0),G=new h(Y,[B]),R=s;return c.allowOverlap||(R=this._conflictEngine.getMinZoom(G.footprint,R)),Y.minzoom=R,G},t.prototype.getTextPlacement=function(t,e,r,c,p,g,m){for(var f,u=new i.Point(t.x,t.y),I=m.rotate*o.C_DEG_TO_RAD,d=0===m.rotationAlignment,x=m.keepUpright,w=s,y=!d,_=y?0:t.angle,v=t.segment>=0&&d,N=8*m.padding,P=new n.Footprint(this.mapAngle,N,y),A=[],T=!v,b=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,C=b,M=E,z=v?x:d&&x,F=0,Y=c;F<Y.length;F++){var B=Y[F],G=B.glyphMosaicItem;if(G&&!G.rect.isEmpty){var R=G.rect,O=G.metrics,D=G.page;T&&(f&&f!==B.y&&(P.addBox(u,new n.Box(b,C,E,M),p,I,e,s,o.C_INFINITY),b=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,C=b,M=E),f=B.y);var q=[];if(v){var V=.5*G.metrics.width,S=(r.x+B.x+O.left-4+V)*p;if(w=this._placeGlyph(t,w,S,g,t.segment,1,D,q),x&&(w=this._placeGlyph(t,w,S,g,t.segment,-1,D,q)),w>=2)break}else q.push(new a(u,_,_,D)),d&&x&&q.push(new a(u,_+o.C_PI,_+o.C_PI,D,!0));for(var k=B.x+r.x+O.left,U=B.y+r.y-O.top,Z=k+O.width,j=U+O.height,H=new i.Point(k-4,U-4),J=new i.Point(H.x+R.width,H.y+R.height),K=new i.Point(H.x,J.y),L=new i.Point(J.x,H.y),Q=0,W=q;Q<W.length;Q++){var X=W[Q],$=H.clone(),tt=K.clone(),et=L.clone(),nt=J.clone(),ot=U,it=j,rt=X.glyphAngle+I;if(0!==rt){var at=Math.cos(rt),lt=Math.sin(rt);$.rotate(at,lt),nt.rotate(at,lt),tt.rotate(at,lt),et.rotate(at,lt)}A.push(new l($,et,tt,nt,R,X.labelAngle,X.anchor,X.minzoom,X.maxzoom,X.page)),z&&!this._legible(X.labelAngle)||(T?(k<b&&(b=k),ot<C&&(C=ot),Z>E&&(E=Z),it>M&&(M=it)):X.minzoom<2&&P.addBox(X.anchor,new n.Box(k,ot,Z,it),p,rt,e,X.minzoom,X.maxzoom))}}}if(w>=2)return null;T&&P.addBox(u,new n.Box(b,C,E,M),p,I,e,s,o.C_INFINITY);var ht=new h(P,A);return m.allowOverlap||(w=this._conflictEngine.getMinZoom(ht.footprint,w)),P.minzoom=w,ht},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var e=o.radToByte(t);return e<65||e>=193},t.prototype._placeGlyph=function(t,e,n,r,l,h,s,c){var p=h,g=p<0?o.positiveMod(t.angle+o.C_PI,o.C_2PI):t.angle,m=this._legible(g),f=0;n<0&&(p*=-1,n*=-1,f=o.C_PI),p>0&&++l;var u=new i.Point(t.x,t.y),I=r[l],d=o.C_INFINITY;if(r.length<=l)return d;for(;;){var x=I.x-u.x,w=I.y-u.y,y=Math.sqrt(x*x+w*w),_=Math.max(n/y,e),v=x/y,N=w/y,P=o.positiveMod(Math.atan2(N,v)+f,o.C_2PI);if(c.push(new a(u,g,P,s,m,_,d)),_<=e)return _;u=I.clone();do{if(l+=p,r.length<=l||l<0)return _;I=r[l]}while(u.isEqual(I));var A=I.x-u.x,T=I.y-u.y,b=Math.sqrt(A*A+T*T);A*=y/b,T*=y/b,u.x-=A,u.y-=T,d=_}},t}();e.PlacementEngine=c});