// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojox/string/BidiEngine","./Bucket","./GeometryUtils","./Placement","./style/StyleLayer","../webgl/Geometry","../webgl/TextShaping"],function(t,e,a,n,o,i,r,s,l,h){function c(t,e){return t.iconMosaicItem&&e.iconMosaicItem?t.iconMosaicItem.page===e.iconMosaicItem.page?0:t.iconMosaicItem.page<e.iconMosaicItem.page?-1:1:t.iconMosaicItem&&!e.iconMosaicItem?1:!t.iconMosaicItem&&e.iconMosaicItem?-1:0}!function(){function t(){}}();return function(t){function e(e,a,n,o,i,r,s,l){var h=t.call(this,e,a)||this;if(h._markerMap=new Map,h._glyphMap=new Map,h._glyphBufferDataStorage=new Map,h._sdfMarkers=!1,e.hasDataDrivenIcon!==n.isDataDriven())throw new Error("incompatible icon buffer");if(e.hasDataDrivenText!==i.isDataDriven())throw new Error("incompatible text buffer");return h._iconVertexBuffer=n,h._iconIndexBuffer=o,h._textVertexBuffer=i,h._textIndexBuffer=r,h._placementEngine=s,h._workerTileHandler=l,h}return a(e,t),Object.defineProperty(e.prototype,"markerPageMap",{get:function(){return this._markerMap},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"glyphsPageMap",{get:function(){return this._glyphMap},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sdfMarker",{get:function(){return this._sdfMarkers},enumerable:!0,configurable:!0}),e.prototype.copy=function(t,a,n,o,i){var r=new e(this.layer,this.zoom,t,a,n,o,i,this._workerTileHandler);return r.layerIndex=this.layerIndex,r.layerExtent=this.layerExtent,r._iconIndexStart=a.index,r._textIndexStart=o.index,r._iconIndexCount=0,r._textIndexCount=0,r._symbolInstances=this._symbolInstances,r._workerTileHandler=this._workerTileHandler,r._fontArray=this._fontArray,r._textLayout=this._textLayout,r._iconLayout=this._iconLayout,r._isLinePlacement=this._isLinePlacement,r._avoidEdges=this._avoidEdges,r},e.prototype.getResources=function(t,a,n){var o=this.layer,i=this.zoom,r=o.hasDataDrivenIcon,s=o.hasDataDrivenText;t&&t.setExtent(this.layerExtent);for(var l=o.getLayoutProperty("icon-image"),h=o.getLayoutProperty("text-field"),c=o.getLayoutValue("text-font",i),d=o.getLayoutValue("text-transform",i),x=[],u=[1,1,1,1],y=1,p=1,f=[1,1,1,1],g=1,m=1,_=0,v=this._features;_<v.length;_++){var I=v[_],b=I.getGeometry(t);if(b&&0!==b.length){var M=void 0;l&&(M=o.getLayoutValue("icon-image",i,I),l.isDataDriven||(M=this._replaceKeys(M,I.values)),M&&a.add(M));var z=void 0,L=!1;if(h&&(z=o.getLayoutValue("text-field",i,I),h.isDataDriven||(z=this._replaceKeys(z,I.values)),z=z.replace(/\\n/g,"\n"))){switch(d){case 2:z=z.toLowerCase();break;case 1:z=z.toUpperCase()}if(e._bidiEngine.hasBidiChar(z)){var P=e._bidiEngine.checkContextual(z),D=void 0;D="rtl"===P?"IDNNN":"ICNNN",z=e._bidiEngine.bidiTransform(z,D,"VLYSN"),L=!0}var V=z.length;if(V>0)for(var A=0,S=c;A<S.length;A++){var w=S[A],T=n[w];T||(T=n[w]=new Set);for(var k=0;k<V;k++){var E=z.charCodeAt(k);T.add(E)}}}if(M||z){var C=o.getLayoutValue("icon-size",i,I),B=o.getLayoutValue("text-size",i,I);o.hasDataDrivenIconColor&&(u=o.getPaintValue("icon-color",i,I)),o.hasDataDrivenIconOpacity&&(y=o.getPaintValue("icon-opacity",i,I)),o.hasDataDrivenIconSize&&(p=C),o.hasDataDrivenTextColor&&(f=o.getPaintValue("text-color",i,I)),o.hasDataDrivenTextOpacity&&(g=o.getPaintValue("text-opacity",i,I)),o.hasDataDrivenTextSize&&(m=B);var N={sprite:M,label:z,rtl:L,type:I.type,geometry:b,iconSize:C,iconRotate:o.getLayoutValue("icon-rotate",i,I),ddIconValues:r?{color:u,opacity:y,size:p}:null,textSize:B,textRotate:o.getLayoutValue("text-rotate",i,I),ddTextValues:s?{color:f,opacity:g,size:m}:null};x.push(N)}}}this._symbolFeatures=x},e.prototype.processFeatures=function(t){t&&t.setExtent(this.layerExtent);var a,n,o=this.layer,l=this.zoom,d=this._isLinePlacement=1===o.getLayoutValue("symbol-placement",l),x=8*o.getLayoutValue("symbol-spacing",l),u=o.getLayoutProperty("icon-image"),y=o.getLayoutProperty("text-field"),p=this._workerTileHandler;u&&(this._iconLayout=new s.IconLayout(o,l,d),a=p.getSpriteItems(),n=this._getTranslate(!0));var f,g,m;if(y){var _=this._textLayout=new s.TextLayout(o,l,d);this._fontArray=_.fontArray;var v=.5;switch(_.anchor){case 5:case 1:case 7:v=0;break;case 6:case 2:case 8:v=1}var I=.5;switch(_.anchor){case 5:case 3:case 6:I=0;break;case 7:case 4:case 8:I=1}var b=.5;switch(_.justify){case 0:b=0;break;case 2:b=1}var M=24*_.letterSpacing,z=d?0:24*_.maxWidth,L=24*_.lineHeight,P=[24*_.offset[0],24*_.offset[1]];f=this._fontArray.map(function(t){return p.getGlyphItems(t)}),g=new h.TextShaping(f,z,L,M,P,v,I,b),m=this._getTranslate(!1)}this._iconIndexStart=this._iconIndexBuffer.index,this._textIndexStart=this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();var D=[];this._symbolInstances=D;var V=this._textLayout,A=1;V&&V.size&&(A=V.size/24);for(var S=V?V.maxAngle*i.C_DEG_TO_RAD:0,w=V?8*V.size:0,T=0,k=this._symbolFeatures;T<k.length;T++){var E=k[T],C=void 0;E.sprite&&(C=a[E.sprite])&&C.sdf&&(this._sdfMarkers=!0);var B=void 0,N=E.label,R=0;if(N&&(B=g.getShaping(N,E.rtl))&&B.length>0){for(var G=1e30,F=-1e30,H=0,O=B;H<O.length;H++){var j=O[H];G=Math.min(G,j.x),F=Math.max(F,j.x)}R=(F-G+48)*A*8}for(var q=0,K=E.geometry;q<K.length;q++){var Y=K[q],U=void 0;if(d){if(B&&B.length>0&&V&&V.size){var W=8*V.size*(2+Math.min(2,4*Math.abs(V.offset[1])));e._smoothVertices(Y,W)}U=e._findAnchors(Y,x,R)}else U=3===E.type?e._findCentroid(Y):[new r.Anchor(Y[0].x,Y[0].y)];for(var J=0,Q=U;J<Q.length;J++){var X=Q[J];X.x<0||X.x>4096||X.y<0||X.y>4096||(d&&R>0&&0===V.rotationAlignment&&!e._honorsTextMaxAngle(Y,X,R,S,w)||D.push({shaping:B,line:Y,iconMosaicItem:C,anchor:X,iconSize:E.iconSize,iconRotate:E.iconRotate,ddIconValues:E.ddIconValues,textSize:E.textSize,textRotate:E.textRotate,ddTextValues:E.ddTextValues}))}}}D.sort(c);for(var Z=0,$=D;Z<$.length;Z++){var tt=$[Z];this._processFeature(tt,n,m)}this._addPlacedGlyphs()},e.prototype.updateSymbols=function(){this._iconIndexStart=this._iconIndexBuffer.index,this._textIndexStart=this._textIndexBuffer.index,this._iconIndexCount=0,this._textIndexCount=0,this._markerMap.clear(),this._glyphMap.clear();var t,e=this.layer,a=e.getLayoutProperty("icon-image");a&&(t=this._getTranslate(!0));var n,o=e.getLayoutProperty("text-field");o&&(n=this._getTranslate(!1));for(var i=this._symbolInstances,r=0,s=i;r<s.length;r++){var l=s[r];this._processFeature(l,t,n)}this._addPlacedGlyphs()},e.prototype.assignBufferInfo=function(){},e.prototype._getTranslate=function(t){var e=this.layer.getPaintValue(t?"icon-translate":"text-translate",this.zoom);if(0!==e[0]||0!==e[1]){var a=this._placementEngine.mapAngle;if(0!==a&&0===this.layer.getPaintValue(t?"icon-translate-anchor":"text-translate-anchor",this.zoom)){var n=Math.sin(a),o=Math.cos(a);return[8*(e[0]*o-e[1]*n),8*(e[0]*n+e[1]*o)]}return[8*e[0],8*e[1]]}},e.prototype._replaceKeys=function(t,e){return t.replace(/{([^{}]+)}/g,function(t,a){return a in e?e[a]:""})},e.prototype._processFeature=function(t,e,a){var n=t.line,o=t.iconMosaicItem,r=t.shaping,s=t.anchor,h=this._iconLayout,c=h&&!!o,d=!0,x=1;if(c){h.size=t.iconSize,h.rotate=t.iconRotate;x=8*h.size,d=h.optional||!o}var u=this._textLayout,y=u&&r&&r.length>0,p=1,f=p,g=!0;y&&(u.size=t.textSize,u.rotate=t.textRotate,p=u.size/24,f=8*p,g=u.optional||!r||0===r.length);var m,_=new l.Point(0,-17);if(c&&(m=this._placementEngine.getIconPlacement(s,e,o,x,h),s.minzoom>m.footprint.minzoom&&(m.footprint.minzoom=s.minzoom),m.footprint.minzoom===i.C_INFINITY&&(m=null)),m||d){var v;if(y&&(v=this._placementEngine.getTextPlacement(s,a,_,r,f,n,u))&&(s.minzoom>v.footprint.minzoom&&(v.footprint.minzoom=s.minzoom),v.footprint.minzoom===i.C_INFINITY&&(v=null)),v||g){if(m&&v||(g||d?g||v?d||m||(v=null):m=null:(m=null,v=null)),m&&v&&!g&&!d){var I=Math.max(m.footprint.minzoom,v.footprint.minzoom);m.footprint.minzoom=I,v.footprint.minzoom=I}v&&(u.ignorePlacement||this._placementEngine.add(v),this._storePlacedGlyphs(v.shapes,v.footprint.minzoom,this.zoom,t.ddTextValues)),m&&(h.ignorePlacement||this._placementEngine.add(m),this._addPlacedIcons(m.shapes,m.footprint.minzoom,this.zoom,o.page,t.ddIconValues))}}},e.prototype._addPlacedIcons=function(t,e,a,n,o){for(var r=Math.max(a+i.log2(e),0),s=this._iconVertexBuffer,l=this._iconIndexBuffer,h=0,c=t;h<c.length;h++){var d=c[h],x=Math.max(a+i.log2(d.minzoom),r),u=Math.min(a+i.log2(d.maxzoom),25);if(!(u<=x)){var y=d.tl,p=d.tr,f=d.bl,g=d.br,m=d.mosaicRect,_=d.labelAngle,v=d.anchor,I=s.index,b=m.x,M=m.y,z=b+m.width,L=M+m.height;s.add(v.x,v.y,y.x,y.y,b,M,_,x,u,r,o),s.add(v.x,v.y,p.x,p.y,z,M,_,x,u,r,o),s.add(v.x,v.y,f.x,f.y,b,L,_,x,u,r,o),s.add(v.x,v.y,g.x,g.y,z,L,_,x,u,r,o),l.add(I+0,I+1,I+2),l.add(I+1,I+2,I+3),this._markerMap.has(n)?this._markerMap.get(n)[1]+=6:this._markerMap.set(n,[this._iconIndexStart+this._iconIndexCount,6]),this._iconIndexCount+=2}}},e.prototype._addPlacedGlyphs=function(){var t=this,e=this._textVertexBuffer,a=this._textIndexBuffer;this._glyphBufferDataStorage.forEach(function(n,o){for(var i=0,r=n;i<r.length;i++){var s=r[i],l=e.index;e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tl[0],s.tl[1],s.xmin,s.ymin,s.labelAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.tr[0],s.tr[1],s.xmax,s.ymin,s.labelAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.bl[0],s.bl[1],s.xmin,s.ymax,s.labelAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),e.add(s.glyphAnchor[0],s.glyphAnchor[1],s.br[0],s.br[1],s.xmax,s.ymax,s.labelAngle,s.minLod,s.maxLod,s.placementLod,s.ddValues),a.add(l+0,l+1,l+2),a.add(l+1,l+2,l+3),t._glyphMap.has(o)?t._glyphMap.get(o)[1]+=6:t._glyphMap.set(o,[t._textIndexStart+t._textIndexCount,6]),t._textIndexCount+=2}}),this._glyphBufferDataStorage.clear()},e.prototype._storePlacedGlyphs=function(t,e,a,n){for(var o=Math.max(a+i.log2(e),0),r=0,s=t;r<s.length;r++){var l=s[r],h=Math.max(a+i.log2(l.minzoom),o),c=Math.min(a+i.log2(l.maxzoom),25);if(!(c<=h)){var d=l.tl,x=l.tr,u=l.bl,y=l.br,p=l.labelAngle,f=l.anchor,g=l.mosaicRect;this._glyphBufferDataStorage.has(l.page)||this._glyphBufferDataStorage.set(l.page,[]);this._glyphBufferDataStorage.get(l.page).push({glyphAnchor:[f.x,f.y],tl:[d.x,d.y],tr:[x.x,x.y],bl:[u.x,u.y],br:[y.x,y.y],xmin:g.x,ymin:g.y,xmax:g.x+g.width,ymax:g.y+g.height,labelAngle:p,minLod:h,maxLod:c,placementLod:o,ddValues:n})}}},e._findAnchors=function(t,e,a){e+=a;for(var n=0,o=t.length-1,s=0;s<o;s++)n+=l.Point.distance(t[s],t[s+1]);var h=a||e;if(h*=.5,n<=h)return[];var c=h/n;e=n/Math.max(Math.round(n/e),1);for(var d=0,x=-e/2,u=[],y=t.length-1,s=0;s<y;s++){for(var p=t[s],f=t[s+1],g=f.x-p.x,m=f.y-p.y,_=Math.sqrt(g*g+m*m),v=void 0;x+e<d+_;){x+=e;var I=(x-d)/_,b=i.interpolate(p.x,f.x,I),M=i.interpolate(p.y,f.y,I);void 0===v&&(v=Math.atan2(m,g)),u.push(new r.Anchor(b,M,v,s,c))}d+=_}return u},e._deviation=function(t,e,a){var n=(e.x-t.x)*(a.x-e.x)+(e.y-t.y)*(a.y-e.y),o=(e.x-t.x)*(a.y-e.y)-(e.y-t.y)*(a.x-e.x);return Math.atan2(o,n)},e._honorsTextMaxAngle=function(t,e,a,n,o){for(var i=0,r=a/2,s=new l.Point(e.x,e.y),h=e.segment+1;i>-r;){if(--h<0)return!1;i-=l.Point.distance(t[h],s),s=t[h]}i+=l.Point.distance(t[h],t[h+1]);for(var c=[],d=0,x=t.length;i<r;){var u=t[h],y=h,p=void 0;do{if(++y===x)return!1;p=t[y]}while(p.isEqual(u));var f=y,g=void 0;do{if(++f===x)return!1;g=t[f]}while(g.isEqual(p));var m=this._deviation(u,p,g);for(c.push({deviation:m,distToAnchor:i}),d+=m;i-c[0].distToAnchor>o;)d-=c.shift().deviation;if(Math.abs(d)>n)return!1;i+=l.Point.distance(p,g),h=y}return!0},e._smoothVertices=function(t,e){if(!(e<=0)){var a=t.length;if(!(a<3)){var n=[],o=0;n.push(0);for(var i=1;i<a;i++)o+=l.Point.distance(t[i],t[i-1]),n.push(o);e=Math.min(e,.2*o);var r=[];r.push(t[0].x),r.push(t[0].y);var s=t[a-1].x,h=t[a-1].y,c=l.Point.sub(t[0],t[1]);c.normalize(),t[0].x+=e*c.x,t[0].y+=e*c.y,c.assignSub(t[a-1],t[a-2]),c.normalize(),t[a-1].x+=e*c.x,t[a-1].y+=e*c.y;for(var i=1;i<a;i++)n[i]+=e;n[a-1]+=e;for(var d=.5*e,i=1;i<a-1;i++){for(var x=0,u=0,y=0,p=i-1;p>=0&&!(n[p+1]<n[i]-d);p--){var f=d+n[p+1]-n[i],g=n[p+1]-n[p],m=n[i]-n[p]<d?1:f/g;if(Math.abs(m)<1e-6)break;var _=m*m,v=m*f-.5*_*g,I=m*g/e,b=t[p+1],M=t[p].x-b.x,z=t[p].y-b.y;x+=I/v*(b.x*m*f+.5*_*(f*M-g*b.x)-_*m*g*M/3),u+=I/v*(b.y*m*f+.5*_*(f*z-g*b.y)-_*m*g*z/3),y+=I}for(var p=i+1;p<a&&!(n[p-1]>n[i]+d);p++){var f=d-n[p-1]+n[i],g=n[p]-n[p-1],m=n[p]-n[i]<d?1:f/g;if(Math.abs(m)<1e-6)break;var _=m*m,v=m*f-.5*_*g,I=m*g/e,b=t[p-1],M=t[p].x-b.x,z=t[p].y-b.y;x+=I/v*(b.x*m*f+.5*_*(f*M-g*b.x)-_*m*g*M/3),u+=I/v*(b.y*m*f+.5*_*(f*z-g*b.y)-_*m*g*z/3),y+=I}r.push(x/y),r.push(u/y)}r.push(s),r.push(h);for(var i=0,p=0;i<a;i++)t[i].x=r[p++],t[i].y=r[p++]}}},e._findCentroid=function(t){var e=t.length-1,a=0,n=0,o=0,i=t[0].x,s=t[0].y;i>4096&&(i=4096),i<0&&(i=0),s>4096&&(s=4096),s<0&&(s=0);for(var l=1;l<e;l++){var h=t[l].x,c=t[l].y,d=t[l+1].x,x=t[l+1].y;h>4096&&(h=4096),h<0&&(h=0),c>4096&&(c=4096),c<0&&(c=0),d>4096&&(d=4096),d<0&&(d=0),x>4096&&(x=4096),x<0&&(x=0);var u=(h-i)*(x-s)-(d-i)*(c-s);a+=u*(i+h+d),n+=u*(s+c+x),o+=u}return a/=3*o,n/=3*o,isNaN(a)||isNaN(n)?[]:[new r.Anchor(a,n)]},e._bidiEngine=new n,e}(o)});