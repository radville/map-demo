// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../request","../../../../core/has","../../../../core/ItemCache","../../../../core/maybe","../../../../core/MemCache","../../../../core/promiseUtils","../../../../core/requireUtils","../../../../core/workers","../../../../geometry/support/aaBoundingRect","../vectorTiles/VectorTile","./GeometryUtils","./GlyphMosaic","./GlyphSource","./SpriteMosaic","./TileIndex","../../tiling/TileKey","module"],function(e,t,o,r,i,n,s,a,l,u,c,h,p,d,f,y,g,_,T,v,b,m){Object.defineProperty(t,"__esModule",{value:!0});var M=new a(10),R=new Map,C=function(){function t(e,t,o,r,i){this._vectorTileLayer=e,this.devicePixelRatio=t,this.allowUpdates=o,this._container=r,this._memCache=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._updateToAbortController=new Map,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map}return t.prototype.destroy=function(){this._updateToAbortController&&this._updateToAbortController.forEach(function(e){return e.abort()}),this._ongoingTileRequests&&this.abortAll(),this._connection&&(this._connection.close(),this._connection=null),this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)},Object.defineProperty(t.prototype,"spriteMosaic",{get:function(){var e=this;return this._spriteSourcePromise.then(function(){return e._spriteMosaic})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0}),t.prototype.start=function(t){return i(this,void 0,void 0,function(){var i,n,a,l,u,d=this;return r(this,function(r){i=this._vectorTileLayer.sourceNameToSource,n=[];for(a in i)n.push(this._fetchTileMap(i[a],t));return this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,t),this._spriteSourcePromise.then(function(e){d._spriteMosaic=new T(1024,1024,250),d._spriteMosaic.setSpriteSource(e),s("stable-symbol-rendering")&&d._spriteMosaic.preloadSpriteItems()}),l=this._vectorTileLayer.styleRepository,u=new _(l.glyphs),this._glyphMosaic=new g(1024,1024,u),this._broadcastPromise=p.open(h.getAbsMid("../vectorTiles/WorkerTileHandler",e,m),{client:this,scheduler:t.scheduler,signal:t.signal}).then(function(e){return d._connection=e,c.all(d._connection.broadcast("setLayers",l.styleJSON,o({},t)))}),[2,c.all(n)]})})},t.prototype.updateStyle=function(){return i(this,void 0,void 0,function(){var e,t=this;return r(this,function(o){switch(o.label){case 0:return[4,this._broadcastPromise];case 1:return o.sent(),this._updateToAbortController.forEach(function(e){return e.abort()}),this._updateToAbortController.clear(),e=this._vectorTileLayer.styleRepository,this._broadcastPromise=c.create(function(o,r){c.all(t._connection.broadcast("updateStyle",e.styleJSON)).then(o,r)}),[2,this._broadcastPromise]}})})},t.prototype.abortTileUpdate=function(e){if(this._updateToAbortController.has(e)){this._updateToAbortController.get(e).abort(),this._updateToAbortController.delete(e)}},t.prototype.updateTile=function(e,t){return i(this,void 0,void 0,function(){var o,i,n,s,a=this;return r(this,function(r){switch(r.label){case 0:return this.allowUpdates&&e.isReady?[4,this._broadcastPromise]:[2];case 1:return r.sent(),(o=Math.round(y.degToByte(t.state.rotation)),e.rotation===o)?[2,null]:(n=e.key,this._updateToAbortController.has(n.id)&&(i=this._updateToAbortController.get(n.id),i.abort(),this._updateToAbortController.delete(n.id)),i=c.createAbortController(),e.rotation=o,s=e.client.invoke("updateSymbols",{key:e.id,rotation:o},{signal:i.signal}).then(function(t){a._updateToAbortController.delete(n.id),e.isReady&&e.updateSymbolData(t)}).catch(function(e){c.isAbortError(e)||a._updateToAbortController.delete(n.id)}),this._updateToAbortController.set(e.id,i),[2,s])}})})},t.prototype.updateTileData=function(e){for(var t,o=e.tileId,r=this._container.children,i=0;i<r.length;i++)if(t=r[i],t.id===o){t.updateTileData(e.tileData);break}},t.prototype.getVectorTile=function(e,t,o){return i(this,void 0,void 0,function(){var i,n,s,a,c,h,p;return r(this,function(r){switch(r.label){case 0:return i=new b(e,t,o,0),l.isSome(this._memCache)&&(n=this._memCache.get(i.id))?(n.reference(),[2,n]):[4,this._getVectorTileData(i,null)];case 1:return s=r.sent(),l.isSome(this._memCache)&&(a=this._memCache.get(i.id))?(a.reference(),[2,a]):(c=this._vectorTileLayer.tileInfo,h=c.getTileBounds(d.create(),i),p=new f.VectorTile(i,this._vectorTileLayer.styleRepository,h,[512,512]),s&&s.tileData?(p.setData(s.tileData,s.client),l.isSome(this._memCache)&&(p.reference(),this._memCache.put(p.key.id,p,p.getMemoryUsage()*p.referenced,u.MIN_PRIORITY))):p.setData(null,null),[2,p])}})})},t.prototype.releaseVectorTile=function(e){l.isNone(this._memCache)||e.release()||this._memCache.updateSize(e.key.id,e,e.getMemoryUsage()*e.referenced)},t.prototype.fetchTileData=function(e,t){return i(this,void 0,void 0,function(){var o,i,n,s;return r(this,function(r){switch(r.label){case 0:return[4,this._getRefKeys(e,t)];case 1:o=r.sent(),i=this._vectorTileLayer.sourceNameToSource,n=[];for(s in i)n.push(s);return[2,this._getSourcesData(n,o,t)]}})})},t.prototype.parseTileData=function(e,t,n){return i(this,void 0,void 0,function(){var i,a,l,u,c,h,p,d;return r(this,function(r){switch(r.label){case 0:return(i=e&&e.data)?(a=i.sourceName2DataAndRefKey,l=i.transferList,0===Object.keys(a).length?[2,null]:[4,this._broadcastPromise]):[2,null];case 1:return r.sent(),u=Math.round(y.degToByte(t)),c=this._connection.getAvailableClient(),[4,c.invoke("createTileAndParse",{key:e.key.id,rotation:u,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:a},o({},n,{transferList:l})).catch(function(){return c.invoke("destructTileData",e.key.id),null})];case 2:if(h=r.sent(),s("esri-vector-tiles-debug")){p={};for(d in a)p[d]=a[d].refKey;return[2,{tileData:h,client:c,refKeys:p}]}return[2,{tileData:h,client:c}]}})})},Object.defineProperty(t.prototype,"updating",{get:function(){return this._ongoingTileRequests.size>0},enumerable:!0,configurable:!0}),t.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(e){return e.abort()}),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()},t.prototype.getSprites=function(e){return i(this,void 0,void 0,function(){return r(this,function(t){switch(t.label){case 0:return[4,this._spriteSourcePromise];case 1:return t.sent(),[2,this._spriteMosaic.getSpriteItems(e)]}})})},t.prototype.getGlyphs=function(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)},t.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository},t.prototype._getTilePayload=function(e,t,s){return i(this,void 0,void 0,function(){var i,a,l,u,c;return r(this,function(r){switch(r.label){case 0:return i=b.pool.acquire(e.id),a=this._vectorTileLayer.sourceNameToSource,l=a[t],u=l.getSourceTileUrl(i.level,i.row,i.col),b.pool.release(i),[4,n(u,o({responseType:"array-buffer"},s))];case 1:return c=r.sent(),[2,{protobuff:c.data,sourceName:t}]}})})},t.prototype._fetchTileMap=function(e,t){if(e.capabilities.operations.supportsTileMap&&e.tileIndex)return c.resolve();if(!e.tileMapURL)return c.resolve();var o=M.get(e.tileMapURL);if(o)return e.tileIndex=o,c.resolve();if(R.has(e.tileMapURL))return R.get(e.tileMapURL).then(function(t){e.tileIndex=new v(t.data)});var r=n(e.tileMapURL,t);return r.then(function(t){e.tileIndex=new v(t.data),R.delete(e.tileMapURL),M.put(e.tileMapURL,e.tileIndex)}),R.set(e.tileMapURL,r),r},t.prototype._getRefKeys=function(e,t){return i(this,void 0,void 0,function(){var o,i,n,s,a;return r(this,function(r){o=this._vectorTileLayer.sourceNameToSource,i=new Array;for(n in o)s=o[n],a=s.getRefKey(e,t),i.push(a);return[2,c.eachAlways(i)]})})},t.prototype._getSourcesData=function(e,t,o){return i(this,void 0,void 0,function(){var i,n,s,a,l,u,n,h;return r(this,function(r){switch(r.label){case 0:for(i=[],n=0;n<t.length;n++)null==t[n].value||null==e[n]?i.push(null):(s=this._getTilePayload(t[n].value,e[n],o),i.push(s));return[4,c.eachAlways(i)];case 1:for(a=r.sent(),l={},u=[],n=0;n<a.length;n++)a[n].value&&a[n].value&&a[n].value.protobuff&&a[n].value.protobuff.byteLength>0&&(h=t[n].value.id,l[a[n].value.sourceName]={refKey:h,protobuff:a[n].value.protobuff},u.push(a[n].value.protobuff));return[2,{sourceName2DataAndRefKey:l,transferList:u}]}})})},t.prototype._getVectorTileData=function(e,t){return i(this,void 0,void 0,function(){var o,i,n,s,a,l=this;return r(this,function(r){return o=e.id,this._ongoingTileRequests.has(o)?[2,this._ongoingTileRequests.get(o)]:(i=new AbortController,n={signal:i.signal},s=t&&t.signal,a=this._getParsedVectorTileData(e,n).then(function(e){return l._ongoingTileRequests.delete(o),l._ongoingRequestToController.delete(o),e}).catch(function(){return l._ongoingTileRequests.delete(o),l._ongoingRequestToController.delete(o),null}),this._ongoingTileRequests.set(o,a),this._ongoingRequestToController.set(o,i),s&&c.onAbort(s,function(){i.abort(),l._ongoingTileRequests.delete(o),l._ongoingRequestToController.delete(o)}),[2,a])})})},t.prototype._getParsedVectorTileData=function(e,t){return i(this,void 0,void 0,function(){var o;return r(this,function(r){switch(r.label){case 0:return[4,this.fetchTileData(e,t)];case 1:return o=r.sent(),[2,this.parseTileData({key:e,data:o},0,t)]}})})},t}();t.TileHandler=C});