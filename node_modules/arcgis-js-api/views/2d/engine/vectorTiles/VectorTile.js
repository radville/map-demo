// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/now","../../../webgl","./RenderBucket","../webgl/TiledDisplayObject"],function(e,t,r,a,i,f,n){Object.defineProperty(t,"__esModule",{value:!0});var o=(i.enums.Usage,function(e){function t(t,r,a,i){var f=e.call(this,t,a,i,[4096,4096])||this;return f._referenced=0,f._symbolFadeHold=null,f._vectorTileData=null,f._setData=!1,f._symbolUpdateData=null,f._memoryUsed=c,f.rotation=0,f.layerData={},f.status="loading",f._referenced=1,f.styleLayers=r,f.id=t.id,f}return r(t,e),Object.defineProperty(t.prototype,"hasSymbolBuckets",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isHoldingForFade",{get:function(){return null!==this._symbolFadeHold},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSymbolFadeDone",{get:function(){return!this._symbolFadeHold||this._symbolFadeHold<a()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wasRequested",{get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status},enumerable:!0,configurable:!0}),t.prototype.setData=function(e,t,r){this._vectorTileData=e,this.client=t,this.refKeys=r,this._memoryUsed=c,this.ready(),this._setData=!0},t.prototype.updateSymbolData=function(e){e&&(this._symbolUpdateData=e,this.requestRender())},t.prototype.updateTileData=function(e){this._vectorTileData=e,this.stage.requestRender(),this._memoryUsed=c},t.prototype.clearSymbolFadeHold=function(){this._symbolFadeHold=null},t.prototype.setSymbolHoldDuration=function(e){this._symbolFadeHold=a()+e},t.prototype.hasData=function(){return Object.keys(this.layerData).length>0},t.prototype.dispose=function(){this._deleteBufferMemory(),this.destroy(),this._memoryUsed=c},t.prototype.release=function(){return 0==--this._referenced&&(this.dispose(),this.attached=!1,this.stage=null,!0)},t.prototype.reference=function(){++this._referenced},Object.defineProperty(t.prototype,"referenced",{get:function(){return this._referenced},enumerable:!0,configurable:!0}),t.prototype.getMemoryUsage=function(){var e=this;return this._memoryUsed===c&&(this._memoryUsed=s.reduce(function(t,r){return e[r]?t+e[r].size:t},0),this.texture&&(this._memoryUsed+=this.texture.descriptor.width*this.texture.descriptor.height*4),this._vectorTileData&&this._vectorTileData.bufferData&&(this._memoryUsed+=this._vectorTileData.bufferData.reduce(function(e,t){return e+t.byteLength},this._vectorTileData.bufferDataInfo.byteLength+this._vectorTileData.bucketDataInfo.byteLength))),this._memoryUsed/(this._referenced||1)},t.prototype.commitChanges=function(){if(this._vectorTileData||this._symbolUpdateData)return this._vectorTileData?(this._deleteBufferMemory(),this._createRenderBuckets(),this._createBufferObjects(),void(this._vectorTileData=null)):void(this._symbolUpdateData&&(this._updateSymbolData(this._symbolUpdateData),this._symbolUpdateData=null))},t.prototype._deleteBufferMemory=function(){for(var e=["fillVertexArrayObject","fillDDVertexArrayObject","outlineVertexArrayObject","lineVertexArrayObject","lineDDVertexArrayObject","iconVertexArrayObject","iconDDVertexArrayObject","textVertexArrayObject","textDDVertexArrayObject","circleVertexArrayObject","fillVertexBuffer","fillDDVertexBuffer","fillIndexBuffer","outlineVertexBuffer","outlineDDVertexBuffer","outlineIndexBuffer","lineVertexBuffer","lineDDVertexBuffer","lineIndexBuffer","iconVertexBuffer","iconDDVertexBuffer","iconIndexBuffer","textVertexBuffer","textDDVertexBuffer","textIndexBuffer","circleVertexBuffer","circleIndexBuffer","texture"],t=0,r=e;t<r.length;t++){var a=r[t];this[a]&&(this[a].dispose(),this[a]=null)}this.layerData={},this.triangleCount=0},t.prototype._createRenderBuckets=function(){for(var e=new Uint32Array(this._vectorTileData.bucketDataInfo),t=e.length,r=0;r<t;){var a=e[r];switch(e[r+1]){case 0:(new f.BackgroundRenderBucket).layerID=a,r+=2;break;case 1:var i=new f.FillRenderBucket;i.layerID=a,i.triangleElementStart=e[r+2],i.triangleElementCount=e[r+3],i.outlineElementStart=e[r+4],i.outlineElementCount=e[r+5],0===i.triangleElementCount&&0===i.outlineElementCount||(this.layerData[a]=i),r+=6;break;case 2:var n=new f.LineRenderBucket;n.layerID=a,n.triangleElementStart=e[r+2],n.triangleElementCount=e[r+3],n.triangleElementCount>0&&(this.layerData[a]=n),r+=4;break;case 3:var o=new f.SymbolRenderBucket;o.layerID=a,o.isSDF=0!==e[r+2];var c=r+3,s=e[c];c++;for(var u=0;u<s;u++){var l=e[c],h=e[c+1],x=e[c+2];o.iconPerPageElementsMap.set(l,[h,x]),c+=3}var d=c,D=e[d];d++;for(var u=0;u<D;u++){var l=e[d],h=e[d+1],x=e[d+2];o.glyphPerPageElementsMap.set(l,[h,x]),d+=3}(o.iconPerPageElementsMap.size>0||o.glyphPerPageElementsMap.size>0)&&(this.layerData[a]=o),r+=5+3*s+3*D;break;case 4:var y=new f.CircleRenderBucket;y.layerID=a,y.triangleElementStart=e[r+2],y.triangleElementCount=e[r+3],y.triangleElementCount>0&&(this.layerData[a]=y),r+=4;break;default:console.error("Bad bucket type!"),r+=2}}},t.prototype.attach=function(){return this._setData},t.prototype.attachWithContext=function(e){this.stage={context:e},this.attached=this.attach()},t.prototype.detach=function(){this.isReady&&this.client&&this.client.invoke("destructTileData",this.id),this.dispose(),e.prototype.detach.call(this)},t.prototype._updateSymbolData=function(e){if(!e||!e.bucketDataInfo)return!0;var t=new Uint32Array(e.bucketDataInfo),r=t.length;if(0===r)return!0;if(!this.isReady)return this.requestRender(),!1;for(var a=this.stage.context,n=new Uint32Array(e.bufferDataInfo),o=n.length,c=0,s=0;s<o;s+=2,c++){switch(n[s]){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconVertexBuffer=i.BufferObject.createVertex(a,35044,e.bufferData[c]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null),this.iconDDVertexBuffer=i.BufferObject.createVertex(a,35044,e.bufferData[c]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.iconIndexBuffer=i.BufferObject.createIndex(a,35044,e.bufferData[c]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textVertexBuffer=i.BufferObject.createVertex(a,35044,e.bufferData[c]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null),this.textDDVertexBuffer=i.BufferObject.createVertex(a,35044,e.bufferData[c]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=i.BufferObject.createIndex(a,35044,e.bufferData[c])}}var u={};for(var l in this.layerData)3!==this.layerData[l].type&&(u[l]=this.layerData[l]);this.layerData=u;for(var h,x=this.styleLayers.layers,d=0;d<r;){var l=t[d];h=new f.SymbolRenderBucket,h.layerID=l,h.isSDF=0!==t[d+2],x.length>h.layerID&&x[h.layerID].type===h.type&&(u[h.layerID]=h);var D=d+3,y=t[D];D++;for(var b=0;b<y;b++){var B=t[D],p=t[D+1],V=t[D+2];h.iconPerPageElementsMap.set(B,[p,V]),D+=3}var v=D,m=t[v];v++;for(var b=0;b<m;b++){var B=t[v],p=t[v+1],V=t[v+2];h.glyphPerPageElementsMap.set(B,[p,V]),v+=3}d+=5+3*y+3*m}return this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null),!0},t._createBufferToObject=function(){var e=[];return e[1]={create:i.BufferObject.createVertex,var:"fillVertexBuffer"},e[2]={create:i.BufferObject.createVertex,var:"fillDDVertexBuffer"},e[3]={create:i.BufferObject.createIndex,var:"fillIndexBuffer"},e[4]={create:i.BufferObject.createVertex,var:"outlineVertexBuffer"},e[5]={create:i.BufferObject.createVertex,var:"outlineDDVertexBuffer"},e[6]={create:i.BufferObject.createIndex,var:"outlineIndexBuffer"},e[7]={create:i.BufferObject.createVertex,var:"lineVertexBuffer"},e[8]={create:i.BufferObject.createVertex,var:"lineDDVertexBuffer"},e[9]={create:i.BufferObject.createIndex,var:"lineIndexBuffer"},e[10]={create:i.BufferObject.createVertex,var:"iconVertexBuffer"},e[11]={create:i.BufferObject.createVertex,var:"iconDDVertexBuffer"},e[12]={create:i.BufferObject.createIndex,var:"iconIndexBuffer"},e[13]={create:i.BufferObject.createVertex,var:"textVertexBuffer"},e[14]={create:i.BufferObject.createVertex,var:"textDDVertexBuffer"},e[15]={create:i.BufferObject.createIndex,var:"textIndexBuffer"},e[16]={create:i.BufferObject.createVertex,var:"circleVertexBuffer"},e[17]={create:i.BufferObject.createIndex,var:"circleIndexBuffer"},e},t.prototype._createBufferObjects=function(){for(var e=this.stage.context,r=new Uint32Array(this._vectorTileData.bufferDataInfo),a=r.length,i=0;i<a;i+=2){var f=r[i+1],n=i/2;if(!(f<=0||0===this._vectorTileData.bufferData[n].byteLength)){var o=r[i],c=t.bufferToObject[o];c?this[c.var]?this[c.var].setData(this._vectorTileData.bufferData[n]):this[c.var]=c.create(e,35044,this._vectorTileData.bufferData[n]):console.error("Bad buffer type "+o)}}},t.bufferToObject=t._createBufferToObject(),t}(n.TiledDisplayObject));t.VectorTile=o;var c=-1,s=["fillVertexBuffer","fillDDVertexBuffer","fillIndexBuffer","outlineVertexBuffer","outlineDDVertexBuffer","outlineIndexBuffer","lineVertexBuffer","lineDDVertexBuffer","lineIndexBuffer","iconVertexBuffer","iconDDVertexBuffer","iconIndexBuffer","textVertexBuffer","textDDVertexBuffer","textIndexBuffer","circleVertexBuffer","circleIndexBuffer"]});