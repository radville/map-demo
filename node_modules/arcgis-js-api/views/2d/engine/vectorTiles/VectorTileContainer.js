// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/iteratorUtils","../../../../core/maybe","../../../../core/promiseUtils","../../../../geometry/support/aaBoundingRect","../../../webgl","../../engine","../vectorTiles/VectorTile","./FadeRecorder","../webgl/definitions","../webgl/enums","../webgl/TiledDisplayObject","../../tiling/TileCoverage","../../tiling/TileKey"],function(e,t,r,s,i,o,a,n,l,d,p,c,h,u,y,f,_,v,g){Object.defineProperty(t,"__esModule",{value:!0});var m=(p.enums.BlendFactor,p.enums.CompareFunction,p.enums.StencilOperation,function(e){function t(t,r){var s=e.call(this,t,r)||this;return s._backgroundTiles=[],s._fadeRecorder=new u.FadeRecorder(400),s._pointToCallbacks=new Map,s._parsedDataQueue=new Map,s}return r(t,e),t.prototype.destroy=function(){this.removeAllChildren(),this.children.forEach(function(e){return e.destroy()})},t.prototype.dispose=function(){this._spriteMosaic&&this._spriteMosaic.dispose(),this._glyphMosaic&&this._glyphMosaic.dispose(),e.prototype.dispose.call(this)},t.prototype.setStyleResources=function(e,t,r){this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=r},t.prototype.hitTest=function(e,t){return o(this,void 0,void 0,function(){var r,s;return i(this,function(i){return r=[e,t],s=l.createResolver(),this._pointToCallbacks.set(r,s),this.requestRender(),[2,s.promise]})})},t.prototype.setTileData=function(e,t){var r=this.stage;return r.dataUploadCounter<y.MAX_GPU_UPLOADS_PER_FRAME&&t?(e.setData(t.tileData,t.client,t.refKeys),void r.dataUploadCounter++):t?void this._parsedDataQueue.set(e,t):void e.setData(null,null)},t.prototype.createRenderParams=function(t){return s({},e.prototype.createRenderParams.call(this,t),{renderPass:null,styleLayer:null,styleLayerId:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,fadeRecorder:this._fadeRecorder,hasClipping:!!this._clippingInfos})},t.prototype.doRender=function(t){!this.visible||t.drawPhase!==f.WGLDrawPhase.MAP&&t.drawPhase!==f.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||e.prototype.doRender.call(this,t)},t.prototype.createTile=function(e){var t=this._tileInfoView.getTileBounds(d.create(),e),r=new h.VectorTile(e,this._styleRepository,t,[512,512]);return r.rotation=this.stage.state.rotation,r},t.prototype.destroyTile=function(e){e.destroy()},t.prototype.removeChild=function(t){return this._parsedDataQueue.has(t)&&this._parsedDataQueue.delete(t),e.prototype.removeChild.call(this,t)},t.prototype.renderChildren=function(t){if(t.drawPhase===f.WGLDrawPhase.DEBUG)return void e.prototype.renderChildren.call(this,t);var r=this.stage;if(this._parsedDataQueue.size>0&&r.dataUploadCounter<y.MAX_GPU_UPLOADS_PER_FRAME)for(var s=a.pairsOfMap(this._parsedDataQueue),i=0;i<s.length&&r.dataUploadCounter<y.MAX_GPU_UPLOADS_PER_FRAME;i++){var o=s[i][0],n=s[i][1];o.setData(n.tileData,n.client,n.refKeys),this._parsedDataQueue.delete(o),r.dataUploadCounter++}if(this._fadeRecorder.recordLevel(t.displayLevel),this._doRender(t),(this._parsedDataQueue.size>0||this._fadeRecorder.needsRedraw())&&this.requestRender(),this._pointToCallbacks.size>0){var l=t.context,d=l.getBoundFramebufferObject();t.drawPhase=f.WGLDrawPhase.HITTEST;var p=t.painter.effects.hittest;p.bind(t),this._doRender(t),p.draw(t,this._pointToCallbacks,6),l.bindFramebuffer(d)}},t.prototype.removeAllChildren=function(){this._parsedDataQueue.clear();for(var t=0;t<this.children.length;t++){this.children[t].dispose()}e.prototype.removeAllChildren.call(this)},t.prototype._doRender=function(t){var r=t.context,s=this._styleRepository,i=s.layers;s.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,s.backgroundBucketIds)),e.prototype.renderChildren.call(this,t);for(var o=this.children.filter(function(e){return e.visible}),a=0,n=o;a<n.length;a++){var l=n[a];l.triangleCount=0,l.commitChanges()}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(7680,7680,7681),r.setStencilTestEnabled(!0),r.setBlendingEnabled(!1),r.setDepthTestEnabled(!0),r.setDepthWriteEnabled(!0),r.setDepthFunction(515),r.setClearDepth(1),r.clear(r.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(var d=i.length-1;d>=0;d--)this._renderStyleLayer(d,t,o);r.setDepthWriteEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunctionSeparate(1,771,1,771),t.renderPass="translucent";for(var d=0;d<i.length;d++)this._renderStyleLayer(d,t,o);r.setDepthTestEnabled(!1),t.renderPass="symbol";for(var d=0;d<i.length;d++)this._renderStyleLayer(d,t,o);r.bindVAO(),r.setStencilTestEnabled(!0)},t.prototype._renderStyleLayer=function(e,t,r){var s=t.painter,i=t.renderPass,o=this._styleRepository,a=o.layers[e];if(void 0!==a){var n;switch(a.type){case 0:return;case 1:if("opaque"!==i&&"translucent"!==t.renderPass)return;n="vtlFill";break;case 2:if("translucent"!==i)return;n="vtlLine";break;case 4:if("symbol"!==i)return;n="vtlCircle";break;case 3:if("symbol"!==i)return;n="vtlSymbol"}var l=t.displayLevel;if(!(0===r.length||void 0!==a.minzoom&&a.minzoom>=l+1e-6||void 0!==a.maxzoom&&a.maxzoom<l-1e-6)){t.styleLayerId=e,t.styleLayer=a;for(var d=0,p=r;d<p.length;d++){if(p[d].layerData[e]){s.renderObjects(t,r,n);break}}}}},t.prototype._renderBackgroundLayers=function(e,t){var r=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),s=r.spans,i=r.lodInfo,o=i.level,a=this._styleRepository,l=e.context,p=e.displayLevel,c=e.painter,h=e.state,u=d.create(),y=[];if(this._renderPasses){var f=this._renderPasses[0];n.isSome(this._clippingInfos)&&(f.brushes[0].prepareState(e,this._clippingInfos[0]),f.brushes[0].drawMany(e,this._clippingInfos))}for(var m,b=this._backgroundTiles,T=0,D=0,C=s;D<C.length;D++)for(var R=C[D],P=R.row,w=R.colFrom,M=R.colTo,S=w;S<=M;S++){if(T<b.length)m=b[T],m.key.set(o,P,i.normalizeCol(S),i.getWorldForColumn(S)),this._tileInfoView.getTileBounds(u,m.key,!1),m.bounds=u,m.coords[0]=u[0],m.coords[1]=u[3];else{var k=new g(o,P,i.normalizeCol(S),i.getWorldForColumn(S));m=new _.TiledDisplayObject(k,this._tileInfoView.getTileBounds(d.create(),k),[512,512],[4096,4096]),b.push(m)}m.setTransform(h,this._tileInfoView.getTileResolution(m.key)),y.push(m),T++}l.setStencilWriteMask(0),l.setColorMask(!0,!0,!0,!0),l.setStencilOp(7680,7680,7681),l.setStencilFunction(514,0,255),l.setStencilTestEnabled(!0);for(var L=0,E=t;L<E.length;L++){var B=E[L],F=a.layers[B];!F||void 0!==F.minzoom&&F.minzoom>=p+1e-6||void 0!==F.maxzoom&&F.maxzoom<p-1e-6||(e.styleLayerId=B,e.styleLayer=F,c.renderObjects(e,y,"vtlBackground"))}v.pool.release(r)},t}(c.TileContainer));t.VectorTileContainer=m});