// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/libs/gl-matrix-2/mat3f32","../../../../../core/libs/gl-matrix-2/vec4f32","../../../../webgl","../definitions","../enums","../number","./WGLBrush"],function(t,e,r,i,a,s,I,z,p,o){Object.defineProperty(e,"__esModule",{value:!0});s.enums.DataType,s.enums.PrimitiveType,s.enums.TextureSamplingMode;var L=1/65536,U=[1,1,1,1],l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._fillVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]},t._fillVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:4,stride:8,normalized:!0,divisor:0}]},t._outlineVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}]},t._outlineVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:12,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:12,normalized:!0,divisor:0}]},t._color=a.vec4f32.create(),t._outlineColor=a.vec4f32.create(),t._fillProgramOptions={id:!1,dd:!1,pattern:!1},t._outlineProgramOptions={id:!1,dd:!1},t._patternMatrix=i.mat3f32.create(),t}return r(t,e),t.prototype.dispose=function(){},t.prototype.drawMany=function(t,e){var r=t.displayLevel,i=t.drawPhase,a=t.renderPass,o=t.styleLayerId,l=t.styleLayer,n=l.getPaintValue("fill-pattern",r),s=l.hasDataDrivenColor?U:l.getPaintValue("fill-color",r),u=l.hasDataDrivenOpacity?1:l.getPaintValue("fill-opacity",r),f=u*s[3],d=void 0!==n||f<1||l.hasDataDrivenFill;if(!d||"opaque"!==a){var _;this._color[0]=f*s[0],this._color[1]=f*s[1],this._color[2]=f*s[2],this._color[3]=f,i===z.WGLDrawPhase.HITTEST&&(_=p.u32to4Xu8(o));var m=l.getPaintValue("fill-translate",r),c=l.getPaintValue("fill-translate-anchor",r);this._drawFill(t,o,l,e,m,c,n,d,_),this._drawOutline(t,o,l,e,m,c,n,_,u)}},t.prototype._drawFill=function(t,e,r,i,a,o,l,n,s){var u=t.context,f=t.displayLevel,d=t.drawPhase,_=t.pixelRatio,m=t.renderPass,c=t.spriteMosaic,p=t.state;if(n||"translucent"!==m){var v,y=void 0!==l,h=_>I.VTL_HIGH_RES_CUTOFF?2:1,x=r.hasDataDrivenFill,g=t.painter.getVectorTileProgramCach(),V=d===z.WGLDrawPhase.HITTEST,D=(V?1:0)<<2|(x?1:0)<<1|(y?1:0),b=this._fillProgramOptions;b.id=V,b.dd=x,b.pattern=y;var O=g.getProgram(1,D,b);if(u.bindProgram(O),y){if(!(v=c.getMosaicItemPosition(l,!0)))return void u.bindProgram();O.setUniform2f("u_pattern_tl",v.tl[0],v.tl[1]),O.setUniform2f("u_pattern_br",v.br[0],v.br[1]),O.setUniform1i("u_texture",I.VTL_TEXTURE_BINDING_UNIT_SPRITES),c.bind(u,9729,v.page,I.VTL_TEXTURE_BINDING_UNIT_SPRITES)}O.setUniformMatrix3fv("u_displayMat3",1===o?p.displayMat3:p.displayViewMat3),O.setUniform2fv("u_fillTranslation",a),O.setUniform1f("u_depth",r.z+L),O.setUniform4fv("u_color",this._color),V&&O.setUniform4f("u_id",s[0],s[1],s[2],s[3]);for(var A=0,P=i;A<P.length;A++){var T=P[A];if(T.layerData[e]){var M=this._getFillVAO(u,T,x,g);if(M){var C=T.layerData[e];if(u.bindVAO(M),O.setUniformMatrix3fv("u_dvsMat3",T.transforms.dvs),y){var U=Math.max(Math.pow(2,Math.round(f)-T.key.level),1),w=T.coordRange[0]/(h*T.size[0]*U),j=1/(v.size[0]*w),E=1/(v.size[1]*w);this._patternMatrix[0]=j,this._patternMatrix[4]=E,O.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}u.setStencilFunction(514,T.stencilRef,255),u.drawElements(4,C.triangleElementCount,5125,12*C.triangleElementStart),T.triangleCount+=C.triangleElementCount/3}}}}},t.prototype._drawOutline=function(t,e,r,i,a,o,l,n,s){var u=t.context,f=t.displayLevel,d=t.drawPhase,_=t.renderPass,m=t.pixelRatio,c=t.state;if("opaque"!==_){var p=void 0!==l;if(r.getPaintValue("fill-antialias",f)&&!p||r.hasDataDrivenOutlineColor){var v=t.painter.getVectorTileProgramCach(),y=r.hasDataDrivenOutline;if(r.outlineUsesFillColor){if(1!==this._color[3])return;this._outlineColor[0]=this._color[0],this._outlineColor[1]=this._color[1],this._outlineColor[2]=this._color[2],this._outlineColor[3]=this._color[3]}else{var h=r.hasDataDrivenOutlineColor?U:r.getPaintValue("fill-outline-color",f),x=s*h[3];this._outlineColor[0]=x*h[0],this._outlineColor[1]=x*h[1],this._outlineColor[2]=x*h[2],this._outlineColor[3]=x}var g=.75/m,V=d===z.WGLDrawPhase.HITTEST,D=(V?1:0)<<1|(y?1:0),b=this._outlineProgramOptions;b.id=V,b.dd=y;var O=v.getProgram(2,D,b);u.bindProgram(O),O.setUniformMatrix3fv("u_displayMat3",1===o?c.displayMat3:c.displayViewMat3),O.setUniform2fv("u_fillTranslation",a),O.setUniform1f("u_depth",r.z+L),O.setUniform1f("u_outline_width",g),O.setUniform4fv("u_color",this._outlineColor),V&&O.setUniform4f("u_id",n[0],n[1],n[2],n[3]);for(var A=0,P=i;A<P.length;A++){var T=P[A];if(T.layerData[e]){var M=T.layerData[e],C=this._getOutlineVAO(u,T,y,v);if(!C)return;u.bindVAO(C),O.setUniformMatrix3fv("u_dvsMat3",T.transforms.dvs),u.setStencilFunction(514,T.stencilRef,255),u.drawElements(4,M.outlineElementCount,5125,12*M.outlineElementStart),T.triangleCount+=M.outlineElementCount/3}}}}},t.prototype._getFillVAO=function(t,e,r,i){if(r){if(e.fillDDVertexArrayObject)return e.fillDDVertexArrayObject;var a=e.fillDDVertexBuffer,o=e.fillIndexBuffer;return a&&o?(e.fillDDVertexArrayObject=new s.VertexArrayObject(t,i.getProgramAttributes(1),this._fillVertexAttributesDD,{geometry:a},o),e.fillDDVertexArrayObject):null}if(e.fillVertexArrayObject)return e.fillVertexArrayObject;var l=e.fillVertexBuffer,n=e.fillIndexBuffer;return l&&n?(e.fillVertexArrayObject=new s.VertexArrayObject(t,i.getProgramAttributes(1),this._fillVertexAttributes,{geometry:l},n),e.fillVertexArrayObject):null},t.prototype._getOutlineVAO=function(t,e,r,i){if(r){if(e.outlineDDVertexArrayObject)return e.outlineDDVertexArrayObject;var a=e.outlineDDVertexBuffer,o=e.outlineIndexBuffer;return a&&o?(e.outlineDDVertexArrayObject=new s.VertexArrayObject(t,i.getProgramAttributes(2),this._outlineVertexAttributesDD,{geometry:a},o),e.outlineDDVertexArrayObject):null}if(e.outlineVertexArrayObject)return e.outlineVertexArrayObject;var l=e.outlineVertexBuffer,n=e.outlineIndexBuffer;return l&&n?(e.outlineVertexArrayObject=new s.VertexArrayObject(t,i.getProgramAttributes(2),this._outlineVertexAttributes,{geometry:l},n),e.outlineVertexArrayObject):null},t}(o.default);e.WGLBrushVTLFill=l});