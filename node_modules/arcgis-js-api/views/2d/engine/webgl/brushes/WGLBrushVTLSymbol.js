// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/libs/gl-matrix-2/vec2f32","../../../../../core/libs/gl-matrix-2/vec4f32","../../../../webgl","../definitions","../enums","../GeometryUtils","../number","./WGLBrush"],function(e,t,r,X,a,f,q,Y,J,s,i){Object.defineProperty(t,"__esModule",{value:!0});f.enums.DataType,f.enums.PrimitiveType,f.enums.TextureSamplingMode;var K=[1,1,1,1],o=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]},e._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}]},e._iconProgramOptions={id:!1,dd:!1,sdf:!1},e._sdfProgramOptions={id:!1,dd:!1},e._spritesTextureSize=X.vec2f32.create(),e._haloColor=a.vec4f32.create(),e._sdfColor=a.vec4f32.create(),e._color=a.vec4f32.create(),e}return r(e,t),e.prototype.dispose=function(){},e.prototype.drawMany=function(e,t){var r,a=e.drawPhase,i=e.styleLayerId,o=e.styleLayer,n=e.fadeRecorder.getFadeValues();a===Y.WGLDrawPhase.HITTEST&&(r=s.u32to4Xu8(i)),this._drawIcons(e,o,t,n,r),this._drawText(e,o,t,n,r)},e.prototype._drawIcons=function(a,e,t,r,i){for(var o,n=this,s=a.context,f=a.displayLevel,l=a.drawPhase,u=a.painter,d=a.state,c=a.styleLayerId,m=!1,_=0,y=t;_<y.length;_++){if((E=y[_]).layerData[c]&&0<(o=E.layerData[c]).iconPerPageElementsMap.size){m=!0;break}}if(m){var p=e.hasDataDrivenIconSize?1:e.getLayoutValue("icon-size",f),g=e.hasDataDrivenIconColor?K:e.getPaintValue("icon-color",f),h=e.hasDataDrivenIconOpacity?1:e.getPaintValue("icon-opacity",f),v=e.getPaintValue("icon-translate",f),x=e.getPaintValue("icon-translate-anchor",f),V=u.getVectorTileProgramCach(),D=g[3]*h;this._color[0]=D*g[0],this._color[1]=D*g[1],this._color[2]=D*g[2],this._color[3]=D;var U=e.getLayoutValue("icon-rotation-alignment",f);2===U&&(U=1===e.getLayoutValue("symbol-placement",f)?0:1);var T=o.isSDF,P=e.hasDataDrivenIcon,b=l===Y.WGLDrawPhase.HITTEST,A=(b?1:0)<<2|(P?1:0)<<1|(T?1:0),I=this._iconProgramOptions;I.id=b,I.dd=P,I.sdf=T;var L=V.getProgram(4,A,I);if(s.bindProgram(L),T){var O=e.getPaintValue("icon-halo-color",f),S=e.getPaintValue("icon-halo-width",f);L.setUniform4f("u_outlineColor",O[0],O[1],O[2],O[3]),L.setUniform1f("u_outlineSize",S)}L.setUniformMatrix3fv("u_displayViewMat3",0===U?d.displayViewMat3:d.displayMat3),L.setUniformMatrix3fv("u_displayMat3",1===x?d.displayMat3:d.displayViewMat3),L.setUniform2fv("u_iconTranslation",v),L.setUniform1f("u_depth",e.z),L.setUniform1f("u_mapRotation",J.degToByte(d.rotation)),L.setUniform1f("u_keepUpright",0),L.setUniform1f("u_level",10*f),L.setUniform1f("u_fadeSpeed",10*r.fadeSpeed),L.setUniform1f("u_minfadeLevel",10*r.minfadeLevel),L.setUniform1f("u_maxfadeLevel",10*r.maxfadeLevel),L.setUniform1f("u_fadeChange",10*(f+r.fadeChange)),L.setUniform1i("u_texture",q.VTL_TEXTURE_BINDING_UNIT_SPRITES),L.setUniform1f("u_size",p),L.setUniform4fv("u_color",this._color),b&&L.setUniform4fv("u_id",i);for(var z=function(r){if(!r.layerData[c])return"continue";if(0===(o=r.layerData[c]).iconPerPageElementsMap.size)return"continue";var e=M._getIconVAO(s,r,P,V);if(!e)return"continue";s.bindVAO(e),L.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs),o.iconPerPageElementsMap.forEach(function(e,t){n._renderIconRange(a,L,e,t,r)})},M=this,w=0,C=t;w<C.length;w++){var E;z(E=C[w])}}},e.prototype._renderIconRange=function(e,t,r,a,i){var o=e.context,n=e.hasClipping,s=e.requiredLevel,f=e.spriteMosaic;this._spritesTextureSize[0]=f.getWidth(a)/4,this._spritesTextureSize[1]=f.getHeight(a)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),f.bind(o,9729,a,q.VTL_TEXTURE_BINDING_UNIT_SPRITES);var l=!0;s!==i.key.level||n?o.setStencilFunction(514,i.stencilRef,255):l=!1,o.setStencilTestEnabled(l),o.drawElements(4,r[1],5125,12*r[0]),i.triangleCount+=r[1]/3},e.prototype._drawText=function(e,t,r,a,i){for(var o,n=this,s=e.context,f=e.displayLevel,l=e.drawPhase,u=e.glyphMosaic,d=e.hasClipping,c=e.painter,m=e.pixelRatio,_=e.requiredLevel,y=e.state,p=e.styleLayerId,g=!1,h=0,v=r;h<v.length;h++){if((F=v[h]).layerData[p]&&0<(o=F.layerData[p]).glyphPerPageElementsMap.size){g=!0;break}}if(g){var x=t.getLayoutValue("text-rotation-alignment",f);2===x&&(x=1===t.getLayoutValue("symbol-placement",f)?0:1);var V=0===x,D=t.getLayoutValue("text-keep-upright",f)&&V,U=l===Y.WGLDrawPhase.HITTEST,T=.8*3/m,P=t.hasDataDrivenTextSize?1:t.getLayoutValue("text-size",f),b=t.hasDataDrivenTextColor?K:t.getPaintValue("text-color",f),A=t.hasDataDrivenTextOpacity?1:t.getPaintValue("text-opacity",f),I=t.getPaintValue("text-halo-color",f),L=t.getPaintValue("text-halo-width",f),O=3*t.getPaintValue("text-halo-blur",f),S=3*L,z=c.getVectorTileProgramCach(),M=b[3]*A;this._sdfColor[0]=M*b[0],this._sdfColor[1]=M*b[1],this._sdfColor[2]=M*b[2],this._sdfColor[3]=M;var w=I[3]*A;this._haloColor[0]=w*I[0],this._haloColor[1]=w*I[1],this._haloColor[2]=w*I[2],this._haloColor[3]=w,this._glyphTextureSize||(this._glyphTextureSize=X.vec2f32.fromValues(u.width/4,u.height/4));var C=t.getPaintValue("text-translate",f),E=t.getPaintValue("text-translate-anchor",f),j=t.hasDataDrivenText,B=(U?1:0)<<1|(j?1:0),R=this._sdfProgramOptions;R.id=U,R.dd=j;var G=z.getProgram(6,B,R);s.bindProgram(G),G.setUniformMatrix3fv("u_displayViewMat3",0===x?y.displayViewMat3:y.displayMat3),G.setUniformMatrix3fv("u_displayMat3",1===E?y.displayMat3:y.displayViewMat3),G.setUniform2fv("u_textTranslation",C),G.setUniform1f("u_depth",t.z+1/65536),G.setUniform2fv("u_mosaicSize",this._glyphTextureSize),G.setUniform1f("u_mapRotation",J.degToByte(y.rotation)),G.setUniform1f("u_keepUpright",D?1:0),G.setUniform1f("u_level",10*f),G.setUniform1f("u_fadeSpeed",10*a.fadeSpeed),G.setUniform1f("u_minfadeLevel",10*a.minfadeLevel),G.setUniform1f("u_maxfadeLevel",10*a.maxfadeLevel),G.setUniform1f("u_fadeChange",10*(f+a.fadeChange)),G.setUniform1i("u_texture",q.VTL_TEXTURE_BINDING_UNIT_GLYPHS),G.setUniform1f("u_size",P),G.setUniform1f("u_antialiasingWidth",T),U&&G.setUniform4f("u_id",i[0],i[1],i[2],i[3]);for(var N=function(r){if(!r.layerData[p])return"continue";if(0===(o=r.layerData[p]).glyphPerPageElementsMap.size)return"continue";var e=k._getSDFVAO(s,r,j,z);if(!e)return"continue";s.bindVAO(e),G.setUniformMatrix3fv("u_dvsMat3",r.transforms.dvs);var t=!0;_!==r.key.level||d?s.setStencilFunction(514,r.stencilRef,255):t=!1,s.setStencilTestEnabled(t),o.glyphPerPageElementsMap.forEach(function(e,t){n._renderGlyphRange(s,e,t,u,G,I[3],L,O,S,r)})},k=this,H=0,W=r;H<W.length;H++){var F;N(F=W[H])}}},e.prototype._renderGlyphRange=function(e,t,r,a,i,o,n,s,f,l){a.bind(e,9729,r,q.VTL_TEXTURE_BINDING_UNIT_GLYPHS),0<o&&0<n&&(i.setUniform4fv("u_color",this._haloColor),i.setUniform1f("u_halo",1),i.setUniform1f("u_edgeDistance",f),i.setUniform1f("u_edgeBlur",s),e.drawElements(4,t[1],5125,12*t[0]),l.triangleCount+=t[1]/3),0<this._sdfColor[3]&&(i.setUniform4fv("u_color",this._sdfColor),i.setUniform1f("u_halo",0),i.setUniform1f("u_edgeDistance",0),i.setUniform1f("u_edgeBlur",0),e.drawElements(4,t[1],5125,12*t[0]),l.triangleCount+=t[1]/3)},e.prototype._getIconVAO=function(e,t,r,a){if(r){if(t.iconDDVertexArrayObject)return t.iconDDVertexArrayObject;var i=t.iconDDVertexBuffer,o=t.iconIndexBuffer;return i&&o?(t.iconDDVertexArrayObject=new f.VertexArrayObject(e,a.getProgramAttributes(4),this._vertexAttributesDD,{geometry:i},o),t.iconDDVertexArrayObject):null}if(t.iconVertexArrayObject)return t.iconVertexArrayObject;var n=t.iconVertexBuffer,s=t.iconIndexBuffer;return n&&s?(t.iconVertexArrayObject=new f.VertexArrayObject(e,a.getProgramAttributes(4),this._vertexAttributes,{geometry:n},s),t.iconVertexArrayObject):null},e.prototype._getSDFVAO=function(e,t,r,a){if(r){if(t.textDDVertexArrayObject)return t.textDDVertexArrayObject;var i=t.textDDVertexBuffer,o=t.textIndexBuffer;return i&&o?(t.textDDVertexArrayObject=new f.VertexArrayObject(e,a.getProgramAttributes(6),this._vertexAttributesDD,{geometry:i},o),t.textDDVertexArrayObject):null}if(t.textVertexArrayObject)return t.textVertexArrayObject;var n=t.textVertexBuffer,s=t.textIndexBuffer;return n&&s?(t.textVertexArrayObject=new f.VertexArrayObject(e,a.getProgramAttributes(6),this._vertexAttributes,{geometry:n},s),t.textVertexArrayObject):null},e}(i.default);t.WGLBrushVTLSymbol=o});