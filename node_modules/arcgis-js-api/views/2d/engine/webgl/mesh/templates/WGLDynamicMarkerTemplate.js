// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/mat2d","../../../../../../core/libs/gl-matrix-2/mat2df32","../../../../../../core/libs/gl-matrix-2/vec2","../../../../../../core/libs/gl-matrix-2/vec2f32","../../../../../../symbols/cim/enums","../../color","../../number","../../materialKey/MaterialKey","./util","./WGLBaseMarkerTemplate","./WGLDynamicMeshTemplate","../../util/Result"],function(t,e,o,B,i,R,W,r,X,C,m,y,G,K,d,a,s,O){Object.defineProperty(e,"__esModule",{value:!0});var S=C.vec2f32.create(),q=r.mat2df32.create(),U=i.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate"),n=function(i){function r(t,r,o){var e=i.call(this,r)||this;e._cimMarkerLayer=r;var a=0;d.isFunction(r.color)||(a=y.premultiplyAlphaRGBA(r.color));e._dynamicPropertyMap.set("_fillColor",function(t,e,i){return d.isFunction(r.color)?y.premultiplyAlphaRGBA(r.color(t,e,i)):a});var s=0;d.isFunction(r.outlineColor)||(s=y.premultiplyAlphaRGBA(r.outlineColor));var n;e._dynamicPropertyMap.set("_outlineColor",function(t,e,i){return d.isFunction(r.outlineColor)?y.premultiplyAlphaRGBA(r.outlineColor(t,e,i)):s}),d.isFunction(r.size)||(n=R.pt2px(r.size));var c;e._dynamicPropertyMap.set("_size",function(t,e,i){return d.isFunction(r.size)?R.pt2px(r.size(t,e,i)):n}),d.isFunction(r.scaleX)||(c=r.scaleX);var l;e._dynamicPropertyMap.set("_scaleX",function(t,e,i){return d.isFunction(r.scaleX)?r.scaleX(t,e,i):c}),d.isFunction(r.offsetX)||(l=R.pt2px(r.offsetX));var h;e._dynamicPropertyMap.set("xOffset",function(t,e,i){return d.isFunction(r.offsetX)?R.pt2px(r.offsetX(t,e,i)):l}),d.isFunction(r.offsetY)||(h=R.pt2px(r.offsetY));var u;e._dynamicPropertyMap.set("yOffset",function(t,e,i){return d.isFunction(r.offsetY)?R.pt2px(r.offsetY(t,e,i)):h}),d.isFunction(r.outlineWidth)||(u=R.pt2px(r.outlineWidth));var p;e._dynamicPropertyMap.set("_outlineWidth",function(t,e,i){return d.isFunction(r.outlineWidth)?R.pt2px(r.outlineWidth(t,e,i)):u}),d.isFunction(r.rotation)||(p=r.rotation);e._dynamicPropertyMap.set("_angle",function(t,e,i){return d.isFunction(r.rotation)?r.rotation(t,e,i):p});var f=1;d.isFunction(o)||(f=o);return e._dynamicPropertyMap.set("_scaleFactor",function(t,e,i){return d.isFunction(o)?o(t,e,i):f}),e._bitSet=(r.alignment===m.Alignment.MAP?1:0)|(r.colorLocked?1:0)<<1|(r.scaleSymbolsProportionally?1:0)<<3,e._materialKey=K.createMaterialKey(e.geometryType,t,!1),e}return o(r,i),r.fromCIMMarker=function(t,e,i){return new r(t,e,i)},r.prototype.bindFeature=function(i,r,o){var a=this,t=this._dynamicPropertyMap;t&&t.forEach(function(t,e){a[e]=t(i,r,o)});var e=this._cimMarkerLayer.materialHash,s="function"==typeof e?e(i,r,o):e,n=this._materialCache.get(s);if(n&&O.ok(n.spriteMosaicItem)&&n.spriteMosaicItem){var c=n.spriteMosaicItem,l=this._cimMarkerLayer.sizeRatio,h=c.width/c.height*this._scaleX,u=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,p=this._size,f=p*h,m=this.xOffset*this._scaleFactor,y=this.yOffset*this._scaleFactor,d=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/R.pt2px(this._cimMarkerLayer.frameHeight):1,_=this._outlineWidth*d,M=R.pt2px(this._cimMarkerLayer.referenceSize),g=0,v=0,x=this._cimMarkerLayer.anchorPoint;x&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(g=-x.x/(this._size*h),v=x.y/this._size):(g=x.x,v=x.y)),this._sizeOutlineWidth=G.i8888to32(Math.round(Math.sqrt(256*f)),Math.round(Math.sqrt(256*p)),Math.round(Math.sqrt(256*_)),Math.round(Math.sqrt(256*M))),W.mat2d.identity(q),W.mat2d.translate(q,q,C.vec2f32.fromValues(m,-y)),u&&W.mat2d.rotate(q,q,3.14159265359/180*u);var F=c.rect.x,L=c.rect.y,k=F+c.rect.width,b=L+c.rect.height;g=.5-((.5+g)*c.width+1)/c.rect.width,v=.5-((.5+v)*c.height+1)/c.rect.height,f*=l,p*=l,f*=this._scaleFactor,p*=this._scaleFactor;var P=Math.round(64*l),w=(g-.5)*(f*=c.rect.width/c.width),z=(v-.5)*(p*=c.rect.height/c.height);this._bitestAndDistRatio=G.i8888to32(0,0,this._bitSet,P),X.vec2.set(S,w,z),X.vec2.transformMat2d(S,S,q),this._offsetUpperLeft=G.i1616to32(16*S[0],16*S[1]),this._texUpperLeft=G.i1616to32(F,L),X.vec2.set(S,w+f,z),X.vec2.transformMat2d(S,S,q),this._offsetUpperRight=G.i1616to32(16*S[0],16*S[1]),this._texUpperRight=G.i1616to32(k,L),X.vec2.set(S,w,z+p),X.vec2.transformMat2d(S,S,q),this._offsetBottomLeft=G.i1616to32(16*S[0],16*S[1]),this._texBottomLeft=G.i1616to32(F,b),X.vec2.set(S,w+f,z+p),X.vec2.transformMat2d(S,S,q),this._offsetBottomRight=G.i1616to32(16*S[0],16*S[1]),this._texBottomRight=G.i1616to32(k,b);var A=K.MarkerMaterialKey.load(this._materialKey);A.sdf=c.sdf,A.pattern=!0,A.textureBinding=c.textureBinding,this._materialKey=A.data}else U.error(new B("mapview-cim","Encountered an error when binding feature"))},r}(a.default(s.default));e.default=n});