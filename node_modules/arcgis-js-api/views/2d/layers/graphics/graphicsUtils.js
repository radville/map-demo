// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat2d","../../../../core/libs/gl-matrix-2/mat2df32","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f32","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/boundsUtils","../../../../geometry/support/intersects","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/spatialReferenceUtils","../../engine"],function(e,t,r,a,n,i,s,m,c,o,l,x,v,f,u,p,h){function g(e,t,r,a,n,i,s){if(!a||!r)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;var m=a;if(!v.isPoint(m)){l.getBoundsXY(e,m);var c=t[0];0===c&&(c=w(r,n),t[0]=c);var o=i*c,x=o/2;return e[0]-=x,e[1]-=x,e[2]+=x,e[3]+=x,e}var f=m.x,u=m.y;return"text"===r.type&&0===t[2]&&0===t[3]&&X(t,r,n),P(e,f,u,r,t,i,s),e}function d(e){return"simple-marker"===e||"picture-marker"===e||"text"===e}function y(e){switch(r.expect(e.geometry).type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}function M(e,t,r,a){s.vec2.set(j,t,r);for(var n,i,m,c,o,l,x,v,f,u=e.paths,p=1/0,h=0;h<u.length;h++){var g=u[h];if(!(g.length<2))for(var d=1;d<g.length;d++)n=g[d-1][0],m=g[d-1][1],i=g[d][0],c=g[d][1],o=Math.min(n,i)-a,l=Math.min(m,c)-a,x=Math.max(n,i)+a,v=Math.max(m,c)+a,t<o||t>x||r<l||r>v||(s.vec2.set(O,n,m),s.vec2.set(Y,i,c),s.vec2.subtract(F,Y,O),s.vec2.subtract(K,O,j),s.vec2.scale(Q,F,s.vec2.dot(F,K)/s.vec2.dot(F,F)),s.vec2.subtract(V,K,Q),f=s.vec2.dot(V,V),p>f&&(p=f))}return Math.sqrt(p)<=a}function b(e,t,r,i,m){var c,o,l=a.pt2px(r.xoffset),x=a.pt2px(r.yoffset),v=L*r.angle,f=L*m;switch(r.type){case"simple-marker":var u=r;c=o=a.pt2px(u.size);break;case"picture-marker":var p=r;c=a.pt2px(p.width),o=a.pt2px(p.height)}var h=n.mat2d.identity(C);n.mat2d.translate(h,h,s.vec2.set(q,e,t)),n.mat2d.rotate(h,h,f-v),n.mat2d.scale(h,h,s.vec2.set(q,i,-i)),n.mat2d.translate(h,h,s.vec2.set(q,l,-x));var g=[0,0];s.vec2.transformMat2d(g,s.vec2.set(q,-.5*c,-.5*o),h);var d=[0,0];s.vec2.transformMat2d(d,s.vec2.set(q,-.5*c,.5*o),h);var y=[0,0];s.vec2.transformMat2d(y,s.vec2.set(q,.5*c,-.5*o),h);var M=[0,0];return s.vec2.transformMat2d(M,s.vec2.set(q,.5*c,.5*o),h),{rings:[[g,y,M,d,g]]}}function I(e,t,r,i,m){var c=h.CIMSymbolHelper.getEnvelope(r.data);if(!c)return null;var o=a.pt2px(c.width),l=a.pt2px(c.height),x=a.pt2px(c.x),v=a.pt2px(c.y),f=0*L,u=L*m,p=n.mat2d.identity(C);n.mat2d.translate(p,p,s.vec2.set(q,e,t)),n.mat2d.rotate(p,p,u-f),n.mat2d.scale(p,p,s.vec2.set(q,i,i));var g=[0,0];s.vec2.transformMat2d(g,s.vec2.set(q,x,v+l),p);var d=[0,0];s.vec2.transformMat2d(d,s.vec2.set(q,x,v),p);var y=[0,0];s.vec2.transformMat2d(y,s.vec2.set(q,x+o,v+l),p);var M=[0,0];return s.vec2.transformMat2d(M,s.vec2.set(q,x+o,v),p),{rings:[[g,y,M,d,g]]}}function T(e,t,r,i,m,c){var o=h.alignmentUtils.getYAnchorDirection(r.verticalAlignment||"baseline"),l="baseline"===(r.verticalAlignment||"baseline"),x=a.pt2px(r.xoffset),v=a.pt2px(r.yoffset),f=a.pt2px(r.font.size)/24,u=4*f,p=l?25*f:i[1]+(1+o)*i[3]*.5,g=L*r.angle,d=L*c,y=n.mat2d.identity(C);n.mat2d.translate(y,y,s.vec2.set(q,e,t)),n.mat2d.rotate(y,y,d-g),n.mat2d.scale(y,y,s.vec2.set(q,m,-m)),n.mat2d.translate(y,y,s.vec2.set(q,x,-v)),n.mat2d.translate(y,y,s.vec2.set(q,-u,-u-p));var M=[0,0];s.vec2.transformMat2d(M,s.vec2.set(q,i[0],i[1]),y);var b=[0,0];s.vec2.transformMat2d(b,s.vec2.set(q,i[0],i[1]+i[3]),y);var I=[0,0];s.vec2.transformMat2d(I,s.vec2.set(q,i[0]+i[2],i[1]),y);var T=[0,0];return s.vec2.transformMat2d(T,s.vec2.set(q,i[0]+i[2],i[1]+i[3]),y),{rings:[[M,I,T,b,M]]}}function S(e){var t,r,a,n,i,s,m,c,o=null;if(!e)return null;t=e.spatialReference,r=u.getInfo(t),a=t.isWebMercator,s=a?102100:4326,n=$[s].maxX,i=$[s].minX,m=$[s].plus180Line,c=$[s].minus180Line;var f,p=e.toJSON();if(!r)return p;if("mesh"===e.type)f=p;else if(v.isPoint(p))f=H(p,n,i);else if(v.isMultipoint(p))p.points=p.points.map(function(e){return H(e,n,i)}),f=p;else if(v.isExtent(p))f=N(p,r);else if(v.isPolygon(p)||v.isPolyline(p)){var h=J;l.getBoundsXY(h,p);var g={xmin:h[0],ymin:h[1],xmax:h[2],ymax:h[3]},d=A(g.xmin,i),y=d*(2*n),M=0===y?p:E(p,y);g.xmin+=y,g.xmax+=y,x.extentIntersectsPolyline(g,m)&&g.xmax!==n?o=M:x.extentIntersectsPolyline(g,c)&&g.xmin!==i?o=M:f=M}else f=e.clone();if(null!==o){return(new ee).cut(o,n)}return f}function w(e,t){var r=0;switch(e.type){case"simple-fill":case"picture-fill":var a=e.outline;if(!a)return 0;r=a.width;break;case"simple-line":r=e.width;break;case"simple-marker":r=e.size;break;case"picture-marker":r=Math.max(e.width,e.height);break;case"text":var n=[0,0,0,0];X(n,e,t),r=Math.max(n[0],n[1]);break;case"cim":var i=h.CIMSymbolHelper.getEnvelope(e.data);r=Math.sqrt(i.width*i.width+i.height*i.height)}return r}function X(e,t,r){if(!r||0===r.glyphMosaicItems.length)return e;var n=h.bidiText(t.text),i=n[0],s=n[1],m=h.alignmentUtils.getJustification(t.horizontalAlignment||"center"),c=h.alignmentUtils.getXAnchorDirection(t.horizontalAlignment||"center"),o=r.glyphMosaicItems,l=new h.TextShapingNew([o],h.definitions.TEXT_MAX_WIDTH,h.definitions.TEXT_LINE_HEIGHT,h.definitions.TEXT_SPACING,[0,.5*-G],.5*(1-c),0,m),x=l.getShaping(i,s),v=h.fontUtils.getFontDecorationTop(t.font.decoration);isNaN(v)||h.TextShapingNew.addDecoration(x,v);var f=h.TextShapingNew.getBox(x),u=a.pt2px(t.font.size),p=u/Z;return e[0]=p*f.x,e[1]=p*f.y,e[2]=p*f.width,e[3]=p*f.height,e}function k(e,t,r){var n=h.bidiText(t.text),i=n[0],s=n[1],m=h.alignmentUtils.getJustification(t.horizontalAlignment||"center"),c=h.alignmentUtils.getXAnchorDirection(t.horizontalAlignment||"center"),o=new h.TextShapingNew([],D,G,W,[0,.5*-G],.5*(1-c),0,m),l=o.getEstimatedShaping(i,s,r),x=h.TextShapingNew.getBox(l),v=a.pt2px(t.font.size),f=v/Z;return e[0]=f*x.x,e[1]=f*x.y,e[2]=f*x.width,e[3]=f*x.height,e}function P(e,t,r,a,n,i,s){var m;switch(a.type){case"simple-marker":case"picture-marker":m=b(t,r,a,i,0);break;case"text":m=T(t,r,a,n,i,0);break;case"cim":m=I(t,r,a,i,0)}for(var c,o,l=0,x=0;x<m.rings[0].length-1;x++)o=m.rings[0][x],c=(t-o[0])*(t-o[0])+(r-o[1])*(r-o[1]),l=Math.max(l,c);l=Math.sqrt(l);var v=f.normalizeMapX(t-l,s),u=f.normalizeMapX(t+l,s);if(v>u){var h=p.getInfo(s);if(h){var g=h.valid,d=g[0],y=g[1];v=d,u=y}}return e[0]=v,e[1]=r-l,e[2]=u,e[3]=r+l,e}function z(e){return v.isPolygon(e)?e.rings:e.paths}function A(e,t){return Math.ceil((e-t)/(2*t))}function E(e,t){for(var r=z(e),a=0,n=r;a<n.length;a++)for(var i=n[a],s=0,m=i;s<m.length;s++){var c=m[s];c[0]+=t}return e}function N(e,t){if(!t)return e;var r=U(e,t).map(function(e){return e.extent});return r.length<2?r[0]||e:r.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:r.map(function(e){return[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]})}}function U(e,t){var r,a=[],n=e.ymin,i=e.ymax,s=e.xmax-e.xmin,m=e.xmin,c=e.xmax,o=t.valid,l=o[0],x=o[1];r=_(e.xmin,t);var v=r.x,f=r.frameId;r=_(e.xmax,t);var u=r.x,p=r.frameId,h=v===u&&s>0;if(s>2*x){var g={xmin:m<c?v:u,ymin:n,xmax:x,ymax:i},d={xmin:l,ymin:n,xmax:m<c?u:v,ymax:i},y={xmin:0,ymin:n,xmax:x,ymax:i},M={xmin:l,ymin:n,xmax:0,ymax:i},b=[],I=[];B(g,y)&&b.push(f),B(g,M)&&I.push(f),B(d,y)&&b.push(p),B(d,M)&&I.push(p);for(var T=f+1;T<p;T++)b.push(T),I.push(T);a.push({extent:g,frameIds:[f]},{extent:d,frameIds:[p]},{extent:y,frameIds:b},{extent:M,frameIds:I})}else v>u||h?a.push({extent:{xmin:v,ymin:n,xmax:x,ymax:i},frameIds:[f]},{extent:{xmin:l,ymin:n,xmax:u,ymax:i},frameIds:[p]}):a.push({extent:{xmin:v,ymin:n,xmax:u,ymax:i},frameIds:[f]});return a}function _(e,t){var r,a=t.valid,n=a[0],i=a[1],s=2*i,m=0;return e>i?(r=Math.ceil(Math.abs(e-i)/s),e-=r*s,m=r):e<n&&(r=Math.ceil(Math.abs(e-n)/s),e+=r*s,m=-r),{x:e,frameId:m}}function B(e,t){var r=t.xmin,a=t.ymin,n=t.xmax,i=t.ymax;return R(e,r,a)&&R(e,r,i)&&R(e,n,i)&&R(e,n,a)}function R(e,t,r){return t>=e.xmin&&t<=e.xmax&&r>=e.ymin&&r<=e.ymax}function H(e,t,r){if(Array.isArray(e)){var a=e[0];if(a>t){var n=A(a,t);e[0]=a+n*(-2*t)}else if(a<r){var n=A(a,r);e[0]=a+n*(-2*r)}}else{var a=e.x;if(a>t){var n=A(a,t);e.x+=n*(-2*t)}else if(a<r){var n=A(a,r);e.x+=n*(-2*r)}}return e}Object.defineProperty(t,"__esModule",{value:!0});var L=Math.PI/180,D=h.definitions.TEXT_MAX_WIDTH,G=h.definitions.TEXT_LINE_HEIGHT,W=h.definitions.TEXT_SPACING,C=i.mat2df32.create(),q=m.vec2f32.create(),J=o.create();t.getBounds=g,t.isMarkerSymbol=d,t.graphicGeometryToNumber=y;var O=m.vec2f32.create(),Y=m.vec2f32.create(),j=m.vec2f32.create(),F=m.vec2f32.create(),K=m.vec2f32.create(),Q=m.vec2f32.create(),V=m.vec2f32.create();t.isPointOnPolyline=M,t.getMarkerSymbolBounds=b,t.getCIMMarkerBounds=I,t.getTextSymbolBounds=T,t.normalizeCentralMeridian=S;var Z=24;t.getTextSymbolSize=X,t.getTextSymbolEstimatedSize=k;var $={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:{paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator},minus180Line:{paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:c.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:c.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],spatialReference:c.WGS84}}},ee=function(){function e(){}return e.prototype.cut=function(e,t){var r;if(e.rings)this.closed=!0,r=e.rings,this.minPts=4;else{if(!e.paths)return null;this.closed=!1,r=e.paths,this.minPts=2}for(var a=r.length,n=-2*t,i=0;i<a;i++){var s=r[i];if(s&&s.length>=this.minPts){for(var m=[],c=0,o=s;c<o.length;c++){var l=o[c];m.push([l[0]+n,l[1]])}r.push(m)}}return this.closed?e.rings=r:e.paths=r,e},e}()});