// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../geometry/Extent","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/spatialReferenceUtils","../../../../layers/support/TileInfo","../../engine","../../viewStateUtils","../../tiling/TileInfoView","../../tiling/TileKey"],function(e,t,r,o,i,a,n,p,s,u,l,c,d,h,g,m,f,y){var x=c.create(),v=[0,0],S=new y(0,0,0,0),M={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};return function(e){function t(t){var r=e.call(this,t)||this;return r._imagePromise=null,r.hidpi=M.hidpi,r.imageMaxWidth=M.imageMaxWidth,r.imageMaxHeight=M.imageMaxHeight,r.imageRotationSupported=M.imageRotationSupported,r.imageNormalizationSupported=M.imageNormalizationSupported,r.update=s.debounce(function(e,t){return i(r,void 0,void 0,function(){var r,i,a,n,p,s,u,l,c,h=this;return o(this,function(o){return r=e.state,i=d.getInfo(r.spatialReference),a=this.hidpi?e.pixelRatio:1,!e.stationary||this.destroyed?[2]:(this.imageRotationSupported?(v[0]=r.size[0],v[1]=r.size[1]):m.getOuterSize(v,r),n=Math.floor(v[0]*a)>this.imageMaxWidth||Math.floor(v[1]*a)>this.imageMaxHeight,p=i&&(r.extent.xmin<i.valid[0]||r.extent.xmax>i.valid[1]),s=!this.imageNormalizationSupported&&p,u=!n&&!s,l=this.imageRotationSupported?r.rotation:0,u?this._imagePromise=this._singleExport(r,v,l,a,t):(c=Math.min(this.imageMaxWidth,this.imageMaxHeight),s&&(c=Math.min(r.worldScreenWidth,c)),this._imagePromise=this._tiledExport(r,c,l,a,t)),[2,this._imagePromise.then(function(e){h._imagePromise=null;var t=h.container.children.slice();h.container.removeAllChildren(),e.forEach(h.container.addChild,h.container),h.disposeSource&&t.forEach(function(e){h.disposeSource(e.source)},h)}).catch(function(e){throw h._imagePromise=null,e})])})})},5e3),r}return a(t,e),t.prototype.destroy=function(){},Object.defineProperty(t.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!0,configurable:!0}),t.prototype.updateExports=function(e){for(var t=0,r=this.container.children;t<r.length;t++){var o=r[t];if(!o.visible||!o.attached)return;e(o)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(o.invalidateTexture(),o.requestRender())}},t.prototype._export=function(e,t,r,o,i,a){var n=this;return s.resolve().then(function(){return n.fetchSource(e,Math.floor(t*i),Math.floor(r*i),{rotation:o,pixelRatio:i,signal:a})}).then(function(r){var a=new g.Bitmap(r);return a.x=e.xmin,a.y=e.ymax,a.resolution=e.width/t,a.rotation=o,a.pixelRatio=i,a})},t.prototype._singleExport=function(e,t,r,o,i){m.getBBox(x,e.center,e.resolution,t);var a=new l(x[0],x[1],x[2],x[3],e.spatialReference);return this._export(a,t[0],t[1],r,o,i).then(function(e){return[e]})},t.prototype._tiledExport=function(e,t,r,o,i){var a=this,n=h.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),p=new f(n),u=p.getTileCoverage(e);if(!u)return null;var c=[];return u.forEach(function(n,s,u,d){S.set(n,s,u,d),p.getTileBounds(x,S);var h=new l(x[0],x[1],x[2],x[3],e.spatialReference);c.push(a._export(h,t,t,r,o,i))}),s.all(c)},n([u.property()],t.prototype,"_imagePromise",void 0),n([u.property()],t.prototype,"container",void 0),n([u.property()],t.prototype,"disposeSource",void 0),n([u.property()],t.prototype,"fetchSource",void 0),n([u.property()],t.prototype,"hidpi",void 0),n([u.property()],t.prototype,"imageMaxWidth",void 0),n([u.property()],t.prototype,"imageMaxHeight",void 0),n([u.property()],t.prototype,"imageRotationSupported",void 0),n([u.property()],t.prototype,"imageNormalizationSupported",void 0),n([u.property()],t.prototype,"requestUpdate",void 0),n([u.property({dependsOn:["_imagePromise"]})],t.prototype,"updating",null),t=n([u.subclass("esri.views.2d.layers.support.ExportStrategy")],t)}(u.declared(p))});