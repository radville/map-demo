// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Viewpoint","../../core/Collection","../../core/maybe","../../core/promiseUtils","../../core/unitUtils","../../core/wgs84Constants","../../core/libs/gl-matrix-2/common","../../core/libs/gl-matrix-2/mat2d","../../core/libs/gl-matrix-2/mat2df64","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec2f64","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils"],function(e,t,r,n,a,c,o,i,s,u,l,f,m,v,y,g,d,p,x,b,h,M){function w(e,t,r){var n=l.common.toDegree(t[0]/X);return v.vec2.set(e,r?n:n-360*Math.floor((n+180)/360),l.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/X))))}function S(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(l.common.toRadian(r)),v.vec2.set(e,l.common.toRadian(t[0])*X,.5*X*Math.log((1+r)/(1-r)))}function R(e,t,r,n){return n&&r&&!n.equals(r)&&h.canProject(n,r)&&n.isWebMercator?n.isWebMercator?S(e,t):w(e,t):v.vec2.copy(e,t)}function A(e){return e.wkid?e:e.spatialReference||x.WGS84}function G(e,t){return t.type?v.vec2.set(e,t.x,t.y):v.vec2.copy(e,t)}function P(e){return s.getMetersPerUnitForSR(e)}function j(e,t){return Math.max(e.width/t[0],e.height/t[1])*E(e.spatialReference)}function T(e,t,a,s){return n(this,void 0,void 0,function(){var n,u,l,f,m,v,y,x,b,M,w,S,R,A,G,P,j,B,z,x,k,q,F,N,V,W,I,O,E;return r(this,function(r){switch(r.label){case 0:if(!e)return[2,null];if(Array.isArray(e)&&!e.length)return[2,null];if(c.isCollection(e)&&(e=e.toArray()),!Array.isArray(e)||!e.length||"object"!=typeof e[0])return[3,7];if(u=e.every(function(e){return"attributes"in e}),l=e.some(function(e){return!e.geometry}),f=e,!(u&&l&&t&&t.allLayerViews))return[3,2];for(m=new Map,v=0,y=e;v<y.length;v++)x=y[v],b=x.layer,M=m.get(b)||[],w=x.attributes[b.objectIdField],null!=w&&M.push(w),m.set(b,M);return S=[],m.forEach(function(e,r){var n=t.allLayerViews.find(function(e){return e.layer.id===r.id});if("queryFeatures"in n){var a=r.createQuery();a.objectIds=e,a.returnGeometry=!0,S.push(n.queryFeatures(a))}}),[4,i.all(S)];case 1:for(R=r.sent(),A=[],G=0,P=R;G<P.length;G++)if((j=P[G])&&j.features&&j.features.length)for(B=0,z=j.features;B<z.length;B++)x=z[B],o.isSome(x.geometry)&&A.push(x.geometry);f=A,r.label=2;case 2:k=0,q=f,r.label=3;case 3:return k<q.length?(F=q[k],[4,T(F,t,a,s)]):[3,6];case 4:s=r.sent(),r.label=5;case 5:return k++,[3,3];case 6:return[2,s];case 7:return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]?(n=new p(e),[3,12]):[3,8];case 8:return e instanceof d?(n=e,[3,12]):[3,9];case 9:return"geometry"in e?e.geometry?(n=e.geometry,[3,12]):[3,10]:[3,12];case 10:return e.layer?(N=e.layer,"queryFeatures"in(V=t.allLayerViews.find(function(e){return e.layer.id===N.id}))?(W=N.createQuery(),W.objectIds=[e.attributes[N.objectIdField]],W.returnGeometry=!0,[4,V.queryFeatures(W)]):[3,12]):[3,12];case 11:I=r.sent(),n=o.get(I,"features",0,"geometry"),r.label=12;case 12:if(o.isNone(n))return[2,null];if(!(O="point"===n.type?new g({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent))return[2,null];if(E=h.canProject(O,a),!O.spatialReference.equals(a)&&E)O=h.project(O,a);else if(!E)return[2,null];return s=s?s.union(O):O.clone(),[2,s]}})})}function B(e){if(e&&(!Array.isArray(e)||"number"!=typeof e[0])&&("object"==typeof e||Array.isArray(e)&&"object"==typeof e[0])){if("layer"in e&&e.layer&&e.layer.minScale&&e.layer.maxScale){var t=e.layer;return{min:t.minScale,max:t.maxScale}}if(Array.isArray(e)&&e.length&&e.every(function(e){return"layer"in e})){for(var r=0,n=0,a=0,c=e;a<c.length;a++){var o=c[a],t=o.layer;t&&t.minScale&&t.maxScale&&(r=t.minScale<r?t.minScale:r,n=t.maxScale>n?t.maxScale:n)}return r&&n?{min:r,max:n}:null}}}function z(e,t){return n(this,void 0,void 0,function(){var n,c,o,i,s,u,l,f,m,v,d,x,b,w,S,P;return r(this,function(r){switch(r.label){case 0:return e&&t?(n=t.spatialReference,c=t.size,o=t.viewpoint,i=t.constraints,s=null,e instanceof a?s=e:e.viewpoint?s=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(s=e.target),u=null,s&&s.targetGeometry?(u=s.targetGeometry,[3,10]):[3,1]):[2,new a({targetGeometry:new p,scale:0,rotation:0})];case 1:return e instanceof g?(u=e,[3,10]):[3,2];case 2:return e||e&&("center"in e||"extent"in e||"target"in e)?[4,T(e.center,t,n)]:[3,10];case 3:return m=r.sent(),m?[3,5]:[4,T(e.extent,t,n)];case 4:m=r.sent(),r.label=5;case 5:return f=m,f?[3,7]:[4,T(e.target,t,n)];case 6:f=r.sent(),r.label=7;case 7:return l=f,l?[3,9]:[4,T(e,t,n)];case 8:l=r.sent(),r.label=9;case 9:u=l,r.label=10;case 10:return!u&&o&&o.targetGeometry?u=o.targetGeometry:!u&&t.extent&&(u=t.extent),(v=A(u),n||(n=A(t.spatialReference||t.extent||u)),M.canProject(u,n)||!v||v.equals(n))?(d=G(y.vec2f64.create(),u.center?u.center:u),x=new p(R(d,d,v,n),n),b=null,b=s&&s.targetGeometry&&"point"===s.targetGeometry.type?s.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&i&&i.effectiveLODs?i.zoomToScale(e.zoom):Array.isArray(u)||"point"===u.type||"extent"===u.type&&0===u.width&&0===u.height?t.extent&&h.canProject(t.extent,n)?j(h.project(t.extent,n),c):t.extent?j(t.extent,c):o.scale:h.canProject(u.extent,n)?j(h.project(u.extent,n),c):j(u.extent,c),w=B(e),w&&(w.min&&w.min>b?b=w.min:w.max&&w.max<b&&(b=w.max)),S=0,s?S=s.rotation:e.hasOwnProperty("rotation")?S=e.rotation:o&&(S=o.rotation),P=new a({targetGeometry:x,scale:b,rotation:S}),i&&(P=i.fit(P),i.rotationEnabled||(P.rotation=S)),[2,P]):[2,null]}})})}function k(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function q(e,t,r){return r?v.vec2.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):v.vec2.scale(e,t,.5)}function F(e,r,n,a,c){return t.centerAt(e,r,n.center),e.scale=j(n,a),c&&c.constraints&&c.constraints.constrain(e),e}function N(e,r,n,a){return t.getTransform(e,r,n,a),f.mat2d.invert(e,e)}function V(e,t,r){var n=O(t),a=Math.abs(Math.cos(n)),c=Math.abs(Math.sin(n));return v.vec2.set(e,Math.round(r[1]*c+r[0]*a),Math.round(r[1]*a+r[0]*c))}function W(e){return e.scale*I(e.targetGeometry.spatialReference)}function I(e){return b.isValid(e)?1/(P(e)*K*96):1}function O(e){return l.common.toRadian(e.rotation)||0}function E(e){return b.isValid(e)?P(e)*K*96:1}function U(e,t){return v.vec2.scale(e,t,.5)}function C(e){if(e.isWrappable){var t=b.getInfo(e);return t.valid[1]-t.valid[0]}return 0}function L(e,t){return Math.round(C(e)/t)}function D(e,t){return z(e,t)}function H(e,t){return W(t)}function Q(e,t,r){return k(e,t),e.rotation+=r,e}function _(e,t,r){return k(e,t),e.rotation=r,e}function J(e,t,r){return k(e,t),e.scale=r,e}Object.defineProperty(t,"__esModule",{value:!0});var K=39.37,X=u.wgs84Radius,Y=180/Math.PI;t.extentToScale=j,t.create=z,t.copy=k,t.getAnchor=q,t.getExtent=function(){var e=y.vec2f64.create();return function(t,r,n){var a=r.targetGeometry;G(e,a);var c=.5*W(r);return t.xmin=e[0]-c*n[0],t.ymin=e[1]-c*n[1],t.xmax=e[0]+c*n[0],t.ymax=e[1]+c*n[1],t.spatialReference=a.spatialReference,t}}(),t.setExtent=F,t.getOuterExtent=function(){var e=y.vec2f64.create(),t=y.vec2f64.create();return function(r,n,a){G(e,n.targetGeometry),V(t,n,a);var c=.5*W(n),o=e[0]-c*t[0],i=e[1]-c*t[1],s=e[0]+c*t[0],u=e[1]+c*t[1],l=n.targetGeometry.spatialReference;return r.set({xmin:o,ymin:i,xmax:s,ymax:u,spatialReference:l}),r}}(),t.getOuterSize=V,t.getPaddingScreenTranslation=function(){var e=y.vec2f64.create();return function(t,r,n){return v.vec2.sub(t,U(t,r),q(e,r,n))}}(),t.getPaddingMapTranslation=function(){var e=m.mat2df64.create(),r=y.vec2f64.create();return function(n,a,c,o){var i=W(a),s=O(a);return v.vec2.set(r,i,i),f.mat2d.fromScaling(e,r),f.mat2d.rotate(e,e,s),f.mat2d.translate(e,e,t.getPaddingScreenTranslation(r,c,o)),f.mat2d.translate(e,e,[0,o.top-o.bottom]),v.vec2.set(n,e[4],e[5])}}(),t.getResolution=W,t.getResolutionToScaleFactor=E,t.getMatrix=function(){var e=y.vec2f64.create(),t=y.vec2f64.create(),r=y.vec2f64.create();return function(n,a,c,o,i,s){return v.vec2.negate(e,a),v.vec2.scale(t,c,.5*s),v.vec2.set(r,1/o*s,-1/o*s),f.mat2d.identity(n),f.mat2d.translate(n,n,t),i&&f.mat2d.rotate(n,n,i),f.mat2d.scale(n,n,r),f.mat2d.translate(n,n,e),n}}(),t.getTransform=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=W(n),i=O(n);return G(e,n.targetGeometry),t.getMatrix(r,e,a,o,i,c)}}(),t.getTransformNoRotation=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=W(n);return G(e,n.targetGeometry),t.getMatrix(r,e,a,o,0,c)}}(),t.getWorldWidth=C,t.getWorldScreenWidth=L,t.createAsync=D,t.angleBetween=function(){var e=y.vec2f64.create(),t=y.vec2f64.create(),r=[0,0,0];return function(n,a,c){v.vec2.subtract(e,n,a),v.vec2.normalize(e,e),v.vec2.subtract(t,n,c),v.vec2.normalize(t,t),v.vec2.cross(r,e,t);var o=Math.acos(v.vec2.dot(e,t)/(v.vec2.length(e)*v.vec2.length(t)))*Y;return r[2]<0&&(o=-o),isNaN(o)&&(o=0),o}}(),t.addPadding=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return k(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x+=e[0],o.y+=e[1],r}}(),t.removePadding=function(){var e=y.vec2f64.create();return function(r,n,a,c){var o=r.targetGeometry;return k(r,n),t.getPaddingMapTranslation(e,n,a,c),o.x-=e[0],o.y-=e[1],r}}(),t.centerAt=function(){var e=y.vec2f64.create();return function(t,r,n){k(t,r);var a=t.targetGeometry,c=A(n),o=A(a);return G(e,n),R(e,e,c,o),a.x=e[0],a.y=e[1],t}}(),t.pixelSizeAt=H,t.resize=function(){var e=y.vec2f64.create();return function(r,n,a,c,o){o||(o="center"),v.vec2.sub(e,a,c),v.vec2.scale(e,e,.5);var i=e[0],s=e[1];switch(o){case"center":v.vec2.set(e,0,0);break;case"left":v.vec2.set(e,-i,0);break;case"top":v.vec2.set(e,0,s);break;case"right":v.vec2.set(e,i,0);break;case"bottom":v.vec2.set(e,0,-s);break;case"top-left":v.vec2.set(e,-i,s);break;case"bottom-left":v.vec2.set(e,-i,-s);break;case"top-right":v.vec2.set(e,i,s);break;case"bottom-right":v.vec2.set(e,i,-s)}return t.translateBy(r,n,e),r}}(),t.rotateBy=Q,t.rotateTo=_,t.scaleBy=function(){var e=y.vec2f64.create();return function(r,n,a,c,o){return k(r,n),isNaN(a)||0===a||(t.toMap(e,c,n,o),r.scale=n.scale*a,t.toScreen(e,e,r,o),t.translateBy(r,r,v.vec2.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.scaleTo=J,t.scaleAndRotateBy=function(){var e=y.vec2f64.create();return function(r,n,a,c,o,i){return k(r,n),isNaN(a)||0===a||(t.toMap(e,o,n,i),r.scale=n.scale*a,r.rotation+=c,t.toScreen(e,e,r,i),t.translateBy(r,r,v.vec2.set(e,e[0]-o[0],o[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=function(){var e=y.vec2f64.create(),r=y.vec2f64.create();return function(n,a,c,o,i,s,u){return t.getPaddingScreenTranslation(r,s,u),v.vec2.add(e,i,r),o?t.scaleAndRotateBy(n,a,c,o,e,s):t.scaleBy(n,a,c,e,s)}}(),t.toMap=function(){var e=m.mat2df64.create();return function(t,r,n,a){return v.vec2.transformMat2d(t,r,N(e,n,a,1))}}(),t.toScreen=function(){var e=m.mat2df64.create();return function(r,n,a,c){return v.vec2.transformMat2d(r,n,t.getTransform(e,a,c,1))}}(),t.translateBy=function(){var e=y.vec2f64.create(),t=m.mat2df64.create();return function(r,n,a){k(r,n);var c=W(n),o=r.targetGeometry;return f.mat2d.fromRotation(t,O(n)),f.mat2d.scale(t,t,y.vec2f64.fromValues(c,c)),v.vec2.transformMat2d(e,a,t),o.x+=e[0],o.y+=e[1],r}}()});