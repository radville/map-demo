// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../geometry","../../../core/compilerUtils","../../../core/Evented","../../../core/maybe","../../../core/screenUtils","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingRect","../../../layers/graphics/dehydratedFeatures","../../3d/support/geometryUtils","../../3d/support/projectionUtils","../../3d/support/stack","../../3d/webgl-engine/lib/Camera","../../3d/webgl-engine/lib/Layer","../../3d/webgl-engine/lib/Object3D"],function(e,t,i,r,n,o,a,s,c,l,h,d,u,f,_,g,v,p,m,b,y,S,L,j){function O(e){return 0!==e[12]||0!==e[13]||0!==e[14]}Object.defineProperty(t,"__esModule",{value:!0});var w=function(){function e(e){this.camera=new S.default,this._elevation={offset:0,override:0},this._hideOnGrab=!1,this.collisionType={type:"point"},this.collisionPriority=0,this.renderObjects=[],this.autoScaleRenderObjects=!0,this._visible=!0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=u.mat4f64.create(),this._worldFrame=null,this._renderLocation=g.vec3f64.create(),this._renderLocationDirty=!0,this._elevationAlignedLocation=new n.Point,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new a({target:this}),this._screenLocation={screenPointArray:c.createScreenPointArray(),renderScreenPointArray:c.createRenderScreenPointArray3(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayerId=null,this._materialIdReferences=null,this._location=new n.Point({x:0,y:0,z:0,spatialReference:e.view.spatialReference});for(var t in e)this[t]=e[t];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}return e.prototype.destroy=function(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null},Object.defineProperty(e.prototype,"elevationInfo",{get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hideOnGrab",{get:function(){return this._hideOnGrab},set:function(e){this._hideOnGrab!==e&&(this._hideOnGrab=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(e){e!==this._visible&&(this._visible=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"worldSized",{get:function(){return this._worldSized},set:function(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"modelTransform",{get:function(){return this._modelTransform},set:function(e){O(e)&&(this._screenLocationDirty=!0),d.mat4.copy(this._modelTransform,e),this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderLocation",{get:function(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=u.mat4f64.create()),b.computeLinearTransformation(this.view.renderSpatialReference,this._renderLocation,this._worldFrame,this.view.renderSpatialReference),this._worldFrame[12]=0,this._worldFrame[13]=0,this._worldFrame[14]=0):this._worldFrame&&(this._worldFrame=null)),this._renderLocation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"location",{get:function(){return this._location},set:function(e){p.clonePoint(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"elevationAlignedLocation",{get:function(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this.elevationAlignedLocation},set:function(e){p.clonePoint(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject()},enumerable:!0,configurable:!0}),e.prototype._updateElevationAlignedLocation=function(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;var e=s.isSome(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0},Object.defineProperty(e.prototype,"grabbing",{get:function(){return this._grabbing},set:function(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hovering",{get:function(){return this._hovering},set:function(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"selected",{get:function(){return this._selected},set:function(e){e!==this._selected&&(this._selected=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this._state},set:function(e){e!==this._state&&(this._state=e,this._updateEngineObject())},enumerable:!0,configurable:!0}),e.prototype._setFocused=function(e){e!==this._focused&&(this._focused=e,this.events.emit("focus",{action:!0===e?"focus":"unfocus"}))},Object.defineProperty(e.prototype,"focused",{get:function(){return this._focused},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"screenLocation",{get:function(){return this.ensureScreenLocation(),this._screenLocation},enumerable:!0,configurable:!0}),e.prototype.ensureScreenLocation=function(){if(this._screenLocationDirty){this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;var e,t=O(this._modelTransform);if(t){var i=this._calculateModelTransformOffset(C);e=_.vec3.add(i,i,this.renderLocation)}else e=this.renderLocation;this.camera.projectPoint(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}},e.prototype.intersectionDistance=function(e,t){if(!this.visible)return null;var i=c.screenPointObjectToArray(e,R),r=this._getCollisionRadius(t),n=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(f.vec2.squaredDistance(this.screenLocation.screenPointArray,i)<r*r)return this.screenLocation.renderScreenPointArray[2]+n;break;case"line":for(var a=this.collisionType.paths,s=this._getWorldToScreenObjectScale(),h=this._calculateObjectTransform(s,D),d=r*this.screenLocation.pixelSize,u=m.ray.fromScreen(this.camera,i,A),g=0,v=a;g<v.length;g++){var p=v[g];if(0!==p.length)for(var b=_.vec3.transformMat4(F,p[0],h),S=1;S<p.length;S++){var L=_.vec3.transformMat4(M,p[S],h),j=m.lineSegment.closestRayDistance2(m.lineSegment.fromPoints(b,L,P),u);if(null!=j&&j<d*d){var O=_.vec3.add(y.sv3d.get(),b,L);_.vec3.scale(O,O,.5);var w=c.castRenderScreenPointArray(y.sv3d.get());return this.camera.projectPoint(O,w),w[2]+n}_.vec3.copy(b,L)}}break;case"disc":var E=this.collisionType.direction,s=this._getWorldToScreenObjectScale(),h=this._calculateObjectTransform(s,D),d=r*this.screenLocation.pixelSize,u=m.ray.fromScreen(this.camera,i,A),C=l.mat3.fromMat4(T,h),G=_.vec3.transformMat3(z,E,C),N=this._calculateModelTransformPosition(k);m.plane.fromPositionAndNormal(N,G,I);var W=x;if(m.plane.intersectRay(I,u,W)&&_.vec3.squaredDistance(W,N)<d*d)return this.screenLocation.renderScreenPointArray[2]+n;break;case"ribbon":var B=this.collisionType,a=B.paths,E=B.direction,s=this._getWorldToScreenObjectScale(),h=this._calculateObjectTransform(s,D),d=r*this.camera.computeScreenPixelSizeAt(this.renderLocation),u=m.ray.fromScreen(this.camera,i,A),C=l.mat3.fromMat4(T,h),G=_.vec3.transformMat3(z,E,C),N=this._calculateModelTransformPosition(k);m.plane.fromPositionAndNormal(N,G,I);var W=x;if(!m.plane.intersectRay(I,u,W))break;for(var H=0,U=a;H<U.length;H++){var p=U[H];if(0!==p.length)for(var b=_.vec3.transformMat4(F,p[0],h),S=1;S<p.length;S++){var L=_.vec3.transformMat4(M,p[S],h),j=m.lineSegment.distance2(m.lineSegment.fromPoints(b,L,P),W);if(null!=j&&j<d*d){var O=_.vec3.add(y.sv3d.get(),b,L);_.vec3.scale(O,O,.5);var w=c.castRenderScreenPointArray(y.sv3d.get());return this.camera.projectPoint(O,w),w[2]+n}_.vec3.copy(b,L)}}break;default:o.neverReached(this.collisionType)}return null},e.prototype.attach=function(e){if(void 0===e&&(e={manipulator3D:{}}),this.view._stage){var t=e.manipulator3D;if(this._engineLayerId=t.engineLayerId,s.isNone(this._engineLayerId)){var i=new L("manipulator-3d",{isPickable:!1});this.view._stage.add(0,i),this.view._stage.addToViewContent([i.id]),this._engineLayerId=i.id,t.engineLayerId=i.id}t.engineLayerReferences=(t.engineLayerReferences||0)+1,this._materialIdReferences=t.materialIdReferences,s.isNone(this._materialIdReferences)&&(this._materialIdReferences=new Map,t.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),b.canProject(this._location.spatialReference,this.view.spatialReference)||(this.location=new n.Point({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}},e.prototype.detach=function(e){void 0===e&&(e={manipulator3D:{}});var t=e.manipulator3D;t.engineLayerReferences--;var i=0===t.engineLayerReferences;i&&(t.engineLayerId=null),this._removeResourcesFromStage(i),this._engineResources=null,this._engineLayerId=null,this._materialIdReferences=null,this._attached=!1},e.prototype.onViewChange=function(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()},e.prototype.onElevationChange=function(e){v.containsPointObject(e.extent,this.location)&&(this._elevationAlignedLocationDirty=!0,this._updateEngineObject())},e.prototype._evaluateElevationAlignment=function(e){if(void 0===e&&(e=this.location),s.isNone(this.elevationInfo))return!1;var t=null,i=0;switch(this.elevationInfo.mode){case"on-the-ground":t=this.view.elevationProvider.getElevation(e,"ground")||0;break;case"relative-to-ground":i=(this.view.elevationProvider.getElevation(e,"ground")||0)+(this.elevationInfo.offset||0);break;case"relative-to-scene":i=(this.view.elevationProvider.getElevation(e,"scene")||0)+(this.elevationInfo.offset||0);break;case"absolute-height":i=this.elevationInfo.offset||0}return(i!==this._elevation.offset||t!==this._elevation.override)&&(this._elevation.offset=i,this._elevation.override=t,!0)},e.prototype._updateEngineObject=function(){if(this._attached){if(!1===this.visible)return void this._removeResourcesFromStage();var e=this._getWorldToScreenObjectScale(),t=D;if(!0===this.autoScaleRenderObjects){var i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);for(var r=this._ensureEngineResources().objectsByState,n=(this.focused?2:1)|(this.selected?8:4),o=this.hideOnGrab&&this.grabbing,a=0,s=r;a<s.length;a++){var c=s[a],l=c.stateMask,h=c.objects;if(o)for(var d=0,u=h;d<u.length;d++){var f=u[d];f.hideAllComponents()}else{var _=0!=(15&l),g=0!=(65520&l),v=!_||(n&l)==(15&l),p=!g||(this.state&l)==(65520&l);if(v&&p)for(var m=0,b=h;m<b.length;m++){var f=b[m];f.unhideAllComponents(),f.objectTransformation=t}else for(var y=0,S=h;y<S.length;y++){var f=S[y];f.hideAllComponents()}}}}},e.prototype._ensureEngineResources=function(){if(s.isNone(this._engineResources)){var e=this.view._stage.getContent(0,s.expect(this._engineLayerId)),t=[],i=new Set;this.renderObjects.forEach(function(e){var r=e.material;i.has(r)||(t.push(r),i.add(r))});var r=function(e,t){var i=t.geometry,r=t.material,n=t.transform;Array.isArray(i)?i.forEach(function(t){return e.addGeometry(t,r,n)}):e.addGeometry(i,r,n)},n=new Map;this.renderObjects.forEach(function(e){var t=new j({idHint:"manipulator"});r(t,e);var i=e.stateMask||0,o=n.get(i)||[];o.push(t),n.set(i,o)});var o=[];n.forEach(function(e,t){o.push({stateMask:t,objects:e})}),this._engineResources={objectsByState:o,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources},e.prototype._addResourcesToStage=function(){var e=this;if(!this._engineResourcesAddedToStage&&!s.isNone(this._engineResources)){var t=this._engineResources,i=t.objectsByState,r=t.layer;t.materials.forEach(function(t){var i=s.expect(e._materialIdReferences),r=i.get(t.id)||0;0===r&&e.view._stage.add(3,t),i.set(t.id,r+1)}),i.forEach(function(t){t.objects.forEach(function(t){r.addObject(t),e.view._stage.add(1,t)})}),this._engineResourcesAddedToStage=!0}},e.prototype._removeResourcesFromStage=function(e){var t=this;if(void 0===e&&(e=!1),this._engineResourcesAddedToStage&&!s.isNone(this._engineResources)){var i=this._engineResources,r=i.objectsByState,n=i.layer,o=i.materials;r.forEach(function(e){e.objects.forEach(function(e){n.removeObject(e),t.view._stage.remove(1,e.id)})}),o.forEach(function(e){var i=s.expect(t._materialIdReferences),r=i.get(e.id);1===r?(t.view._stage.remove(3,e.id),i.delete(e.id)):i.set(e.id,r-1)}),e&&this.view._stage.remove(0,n.id),this._engineResourcesAddedToStage=!1}},e.prototype._getCollisionRadius=function(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)},e.prototype._getFocusedSize=function(e,t){return e*(t?this.focusMultiplier:1)},e.prototype._getWorldToScreenObjectScale=function(){return this._worldSized?1:this.screenLocation.pixelSize},e.prototype._calculateModelTransformPosition=function(e){var t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,E);return _.vec3.set(e,i[12],i[13],i[14])},e.prototype._calculateModelTransformOffset=function(e){var t=this._calculateModelTransformPosition(e);return _.vec3.subtract(e,t,this.renderLocation)},e.prototype._calculateObjectTransform=function(e,t){return d.mat4.set(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),d.mat4.multiply(t,t,this._modelTransform),this._worldFrame&&d.mat4.multiply(t,t,this._worldFrame),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,t},e}();t.Manipulator3D=w;var R=c.createScreenPointArray(),P=m.lineSegment.create(),A=m.ray.create(),T=h.mat3f64.create(),E=u.mat4f64.create(),D=u.mat4f64.create(),I=m.plane.create(),F=g.vec3f64.create(),M=g.vec3f64.create(),x=g.vec3f64.create(),z=g.vec3f64.create(),k=g.vec3f64.create(),C=g.vec3f64.create()});