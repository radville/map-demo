// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/clock","../../../../../core/Collection","../../../../../core/collectionUtils","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/scheduling","../../../../../core/screenUtils","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../layers/Layer","../../../../../layers/buildingSublayers/BuildingComponentSublayer","../../manipulatorUtils","./sliceToolConfig","./sliceToolUtils","./sliceToolUtils","../../../support/geometryUtils","../../../support/stack","../../../webgl-engine/lib/Intersector","../../../../interactive/InteractiveToolBase","../../../../interactive/interactiveToolUtils"],function(e,t,i,a,n,r,o,s,l,p,u,c,h,d,v,_,f,y,P,g,M,m,b,w,S,O,T,R){function L(e,t,i,a){var n=m.createShiftPlane(i,a.plane,e.direction,w.plane.create()),r=f.vec3f64.create();return w.plane.intersectRay(n,e,r)?{type:"shift",creatingPointerId:t,shiftPlane:n,depth:0,startPoint:r}:null}function k(e){return"mouse"!==e.pointerType||0===e.button}var E=l.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool"),C=function(e){function t(t){var i=e.call(this,t)||this;return i.clock=n.default,i.deferCreation=!0,i.cursor=null,i.layersMode="none",i.shiftManipulator=null,i.rotateManipulator=null,i.resizeManipulators=null,i.disableEngineLayers=!1,i._handles=new s,i._viewHandles=new s,i._frameTask=null,i._prevPointerMoveTimeout=null,i._previewOutlineManipulator=null,i._previewOutlineMaterial=null,i._outlineManipulator=null,i._gridManipulator=null,i._gridMaterial=null,i._startPlane=w.boundedPlane.create(),i._previewPlane=null,i._activeKeyModifiers={},i._lastCursorPosition=c.createScreenPoint(),i._baseOpacity=1,i._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],i._intersector=new O(t.view.viewingMode),i._intersector.options.store=0,i}i(t,e),l=t,t.prototype.initialize=function(){var e=this,t=h.init(this,"state",function(t){"ready"!==t&&e.create(),"sliced"===t&&e.complete()},!0);this._handles.add([t,this.view.state.watch("camera",function(){e._updateManipulators()}),this.excludedLayers.on("before-add",function(t){var i=t.item;null!=i&&(i instanceof y||i instanceof P)?i instanceof y&&m.isAlwaysDrapedLayer(i)?(E.error("excludedLayers","Layer '"+i.title+", id:"+i.id+"' of type '"+i.type+"' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead."),t.preventDefault()):e.excludedLayers.includes(i)&&t.preventDefault():(E.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})]);var i=function(t,i){e._setSingleManipulatorInteractive(t,i),i||(e.plane&&w.boundedPlane.copy(e.plane,e._startPlane),e.inputState=null)};this.shiftManipulator=m.createShiftManipulator(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab",function(t){e._onShiftGrab(t)}),this.shiftManipulator.events.on("drag",function(t){e._onShiftDrag(t)}),this._handles.add(this.shiftManipulator.watch("grabbing",function(t){i(e.shiftManipulator,t)},!0)),this.rotateManipulator=m.createRotateManipulator(this.view),this.manipulators.add(this.rotateManipulator),this.rotateManipulator.events.on("grab",function(t){e._onRotateGrab(t)}),this.rotateManipulator.events.on("drag",function(t){e._onRotateDrag(t)}),this._handles.add(this.rotateManipulator.watch("grabbing",function(t){i(e.rotateManipulator,t)},!0)),this.resizeManipulators=this._resizeHandles.map(function(t,a){var n=m.createResizeManipulator(e.view,t);return n.events.on("grab",function(t){e._onResizeGrab(t,a)}),n.events.on("drag",function(t){e._onResizeDrag(t)}),e._handles.add(n.watch("grabbing",function(e){i(n,e)},!0)),n}),this.manipulators.addMany(this.resizeManipulators);var a=m.createOutlineManipulator(this.view),n=a.manipulator,r=a.material;this._previewOutlineManipulator=n,this._previewOutlineMaterial=r,this.manipulators.add(this._previewOutlineManipulator,2),this._outlineManipulator=m.createOutlineManipulator(this.view).manipulator,this.manipulators.add(this._outlineManipulator,1);var o=m.createGridManipulator(this.view),s=o.manipulator,l=o.material;this._gridManipulator=s,this._gridMaterial=l,this.manipulators.add(this._gridManipulator,2)},t.prototype.destroy=function(){this.detach(),this._handles.destroy(),this._handles=null,this._viewHandles.destroy(),this._viewHandles=null,this._removeFrameTask(),this._clearPointerMoveTimeout()},Object.defineProperty(t.prototype,"state",{get:function(){var e=!!this.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"plane",{set:function(e){this._set("plane",e),this.visible&&this.attached&&this.view&&(this._updateLayerViews(),this.view.slicePlane=e,this._updateManipulators(),e&&this._unsetOtherToolPlanes())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"excludedLayers",{get:function(){return this._get("excludedLayers")||new r},set:function(e){this._set("excludedLayers",o.referenceSetter(e,this._get("excludedLayers")))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"excludeGroundSurface",{set:function(e){this._set("excludeGroundSurface",e),this.view&&this._updateLayerViews()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inputState",{get:function(){return this._get("inputState")},set:function(e){this._set("inputState",e),this._updateMaterials()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_isTargeting",{get:function(){return!this.inputState&&!this.plane&&this.active},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_creatingPointerId",{get:function(){return this.inputState&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null},enumerable:!0,configurable:!0}),t.prototype.enterExcludeLayerMode=function(){this.created&&(this._set("layersMode","exclude"),R.setActive(this,!0))},t.prototype.exitExcludeLayerMode=function(){this.created&&(this._set("layersMode","none"),R.setActive(this,!1))},t.prototype.deactivate=function(){this._updateMouseCursor(),this._set("layersMode","none"),this._updatePreviewPlane(null)},t.prototype.onDetach=function(){this.plane=null,this._set("layersMode","none")},t.prototype.onShow=function(){var e=this;this._updateMouseCursor(),this._updateLayerViews(),this._updateManipulators();var t=this.view;t.slicePlane=this.plane,0===this._viewHandles.size&&this._viewHandles.add([t.allLayerViews.on("change",function(){e._updateLayerViews()}),this.excludedLayers.on("change",function(){e._updateLayerViews()})])},t.prototype.onHide=function(){this._updateMouseCursor(),this._updateLayerViews(),this.view.slicePlane=null,this._viewHandles.removeAll(),this._clearPointerMoveTimeout()},t.prototype.onInputEvent=function(e){switch(e.type){case"pointer-down":if(!k(e))return;this._onPointerDown(e)&&(e.stopPropagation(),this._updateMouseCursor());break;case"pointer-drag":if(!k(e))return;this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e),this._updateMouseCursor();break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"click":if(!k(e))return;this._onClick(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}},t.prototype._updateLayerViews=function(){var e=function(e){return e instanceof l&&!!e.plane&&e.visible},t=e(this.view.activeTool)||this.view.tools.some(e),i=[],a=function(e){"layers"in e?e.layers.forEach(a):i.push(e)};this.excludedLayers.forEach(a),this.view.allLayerViews.forEach(function(e){"slicePlaneEnabled"in e&&(e.slicePlaneEnabled=t&&i.indexOf(e.layer)<0),"componentLayerViews"in e&&e.componentLayerViews.forEach(function(e){e.slicePlaneEnabled=t&&i.indexOf(e.layer)<0})}),this.view.basemapTerrain.slicePlaneEnabled=t&&!this.excludeGroundSurface},t.prototype._onPointerDown=function(e){if("exclude"===this.layersMode)return!0;if(this._isTargeting){var t=w.boundedPlane.create();if(this._pickPlane(c.createScreenPointFromEvent(e),!1,this._activeKeyModifiers,t)){w.boundedPlane.copy(t,this._startPlane);var i=this._calculatePickRay(c.createScreenPointFromEvent(e));return this.inputState=L(i,e.pointerId,t.origin,t),this.plane=t,!0}}return!1},t.prototype._onPointerDrag=function(e){if(e.pointerId===this._creatingPointerId){var t=c.createScreenPointFromEvent(e);return this.shiftManipulator.events.emit("drag",{action:"start",start:t,screenPoint:t}),!0}return!1},t.prototype._onPointerMove=function(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),"touch"!==e.pointerType&&this._updatePreviewPlane(c.createScreenPointFromEvent(e),this._activeKeyModifiers)},t.prototype._onPointerUp=function(e){return e.pointerId===this._creatingPointerId&&(w.boundedPlane.copy(this.plane,this._startPlane),this.inputState=null,!0)},t.prototype._onClick=function(e){var t=this;return!("exclude"!==this.layersMode||!this.created)&&(this.view.hitTest(c.createScreenPointFromEvent(e)).then(function(e){if(e.results.length){var i=e.results[0],a=i&&i.graphic;if(a){var n=a.sourceLayer||a.layer;n&&t.excludedLayers.push(n)}}else t.excludeGroundSurface=!0}),this._set("layersMode","none"),R.setActive(this,!1),!0)},t.prototype._onKeyDown=function(e){return(e.key===M.forceVerticalModifier||e.key===M.forceHorizontalModifier)&&(this._activeKeyModifiers[e.key]=!0,p.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._onKeyUp=function(e){return!(e.key!==M.forceVerticalModifier&&e.key!==M.forceHorizontalModifier||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],p.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._onShiftGrab=function(e){if("start"===e.action){var t=this._calculatePickRay(e.screenPoint);w.boundedPlane.copy(this.plane,this._startPlane),this.inputState=L(t,null,this.shiftManipulator.position,this.plane)}},t.prototype._onShiftDrag=function(e){if(this.inputState&&"shift"===this.inputState.type){var t=this._calculatePickRay(e.screenPoint),i=S.sv3d.get();if(w.plane.intersectRay(this.inputState.shiftPlane,t,i)){var a=Math.min((1-Math.abs(_.vec3.dot(this.plane.plane,t.direction)))/.001,1),n=-w.plane.signedDistance(this._startPlane.plane,i),r=-w.plane.signedDistance(this._startPlane.plane,this.inputState.startPoint);this.inputState.depth=this.inputState.depth*(1-a)+n*a-r;var o=_.vec3.copy(S.sv3d.get(),this._startPlane.origin),s=_.vec3.copy(S.sv3d.get(),this._startPlane.plane);_.vec3.scale(s,s,-this.inputState.depth),_.vec3.add(s,s,o),w.boundedPlane.fromValues(s,this.plane.basis1,this.plane.basis2,this.plane),this.plane=this.plane}}},t.prototype._onRotateGrab=function(e){if("start"===e.action){var t=m.createRotatePlane(this.plane,this.view.renderCoordsHelper,w.plane.create()),i=this._calculatePickRay(e.screenPoint),a=f.vec3f64.create();w.plane.intersectRay(t,i,a)&&(w.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}},t.prototype._onRotateDrag=function(e){if(this.inputState&&"rotate"===this.inputState.type){var t=this._calculatePickRay(e.screenPoint),i=S.sv3d.get();if(w.plane.intersectRay(this.inputState.rotatePlane,t,i)){var a=this.inputState.rotatePlane,n=g.calculateInputRotationTransform(this.inputState.startPoint,i,this.plane.origin,a),r=v.mat4.identity(S.sm4d.get());v.mat4.rotate(r,r,n,a);var o=_.vec3.transformMat4(S.sv3d.get(),this._startPlane.basis1,r),s=_.vec3.transformMat4(S.sv3d.get(),this._startPlane.basis2,r);w.boundedPlane.fromValues(this.plane.origin,o,s,this.plane),this.plane=this.plane}}},t.prototype._onResizeGrab=function(e,t){if("start"===e.action){var i=this._calculatePickRay(e.screenPoint),a=S.sv3d.get();w.plane.intersectRay(this.plane.plane,i,a)&&(w.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:f.vec3f64.clone(a)})}},t.prototype._onResizeDrag=function(e){if(this.inputState&&"resize"===this.inputState.type){var t=this._calculatePickRay(e.screenPoint),i=S.sv3d.get();if(w.plane.intersectRay(this.plane.plane,t,i)){var a=this._resizeHandles[this.inputState.activeHandleIdx];this.plane=m.resizePlane(a,this.inputState.startPoint,i,this.view._stage.getCamera(),this._startPlane,this.plane)}}},t.prototype._updatePreviewPlane=function(e,t){var i=this;void 0===t&&(t={});var a=this._previewPlane;if(this._previewPlane=null,p.isNone(e))return this._removeFrameTask(),void this._updateManipulators();if(!this.plane&&this.active){var n=p.isSome(a)?a:w.boundedPlane.create();if(a=p.isSome(a)?w.boundedPlane.copy(a,x):null,this._pickPlane(e,!0,t,n)){var r=M.PREVIEW_FADE_DOT_THRESHOLD,o=!1;p.isSome(a)&&(o=_.vec3.dot(a.plane,n.plane)<r||_.vec3.dot(_.vec3.normalize(S.sv3d.get(),a.basis1),_.vec3.normalize(S.sv3d.get(),n.basis1))<r),o&&(this._baseOpacity=0),this._previewPlane=n}}p.isSome(this._previewPlane)&&p.isNone(this._frameTask)&&0===this._baseOpacity?this._frameTask=u.addFrameTask({update:function(e){var t=e.deltaTime;i._baseOpacity=Math.min(i._baseOpacity+t/(1e3*M.PREVIEW_FADE_DURATION_SECONDS),1),i._updateManipulators(),1===i._baseOpacity&&i._removeFrameTask()}}):p.isNone(this._frameTask)&&(this._removeFrameTask(),this._updateManipulators())},t.prototype._removeFrameTask=function(){p.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)},t.prototype._calculatePickRay=function(e){var t=w.ray.create(),i=c.screenPointObjectToArray(e,D);return w.ray.fromScreen(this.view.state.camera,i,t),_.vec3.normalize(t.direction,t.direction),t},t.prototype._pickMinResult=function(e){var t=c.screenPointObjectToArray(e,S.sv2d.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min},t.prototype._pickPlane=function(e,t,i,a){var n=this._pickMinResult(e),r=S.sv3d.get();if(!n.getIntersectionPoint(r))return!1;var o=n.getTransformedNormal(S.sv3d.get()),s=this.view._stage.getCamera();_.vec3.dot(o,s.viewForward)>0&&_.vec3.scale(o,o,-1);var l=m.calculatePlaneHalfSize(r,s),p=(t?1:-1)*l*M.INITIAL_DEPTH_OFFSET_FRAC,u=_.vec3.scale(S.sv3d.get(),o,p);_.vec3.add(u,u,r);var c=i[M.forceVerticalModifier]?"vertical":i[M.forceHorizontalModifier]?"horizontal":null;return m.createPlane(u,o,0,l,l,s,c,this.view.renderCoordsHelper,a),!0},t.prototype._updateMouseCursor=function(){this._set("cursor",null),this._isTargeting||"exclude"===this.layersMode?this._set("cursor","crosshair"):this._creatingPointerId&&this._set("cursor","grabbing")},t.prototype._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)},t.prototype._resetPointerMoveTimeout=function(){var e=this;this._clearPointerMoveTimeout(),this.shiftManipulator.state|=b.DidPointerMoveRecentlyFlag,this.rotateManipulator.state|=b.DidPointerMoveRecentlyFlag,this._prevPointerMoveTimeout=this.clock.setTimeout(function(){e.shiftManipulator.state&=~b.DidPointerMoveRecentlyFlag,e.rotateManipulator.state&=~b.DidPointerMoveRecentlyFlag},M.POINTER_MOVE_TIMER_MS)},t.prototype._unsetOtherToolPlanes=function(){var e=this;this.view.tools.forEach(function(t){t!==e&&t instanceof l&&t._set("plane",null)})},t.prototype._updateManipulators=function(){var e=this;if(!this.disableEngineLayers){var t=this.plane||p.isSome(this._previewPlane)&&this._previewPlane,i=null!=t&&t===this.plane,a=null!=t&&t===this._previewPlane,n=t?m.calculateBoundedPlaneTranslateRotate(t,S.sm4d.get()):null;if(this.shiftManipulator.visible=i,this.rotateManipulator.visible=i,this.resizeManipulators.forEach(function(e){e.visible=i}),i&&(m.updateShiftRestartHandle(this.shiftManipulator,n,this.plane,this.view.renderCoordsHelper,this.view._stage.getCamera()),m.updateRotateHeadingHandle(this.rotateManipulator,n,this.plane,this.view.renderCoordsHelper),this.resizeManipulators.forEach(function(t,i){m.updateResizeHandle(t,e._resizeHandles[i],n,e.plane)})),this._previewOutlineManipulator.visible=a,this._outlineManipulator.visible=i,this._gridManipulator.visible=!!t,t){var r=_.vec3.set(S.sv3d.get(),_.vec3.length(t.basis1),_.vec3.length(t.basis2),1),o=v.mat4.fromScaling(S.sm4d.get(),r),s=v.mat4.multiply(o,n,o);s[12]=0,s[13]=0,s[14]=0;var l=_.vec3.set(S.sv3d.get(),n[12],n[13],n[14]);this._previewOutlineManipulator.modelTransform=s,this._previewOutlineManipulator.position=l,this._outlineManipulator.modelTransform=s,this._outlineManipulator.position=l,this._gridManipulator.modelTransform=s,this._gridManipulator.position=l,this._updateMaterials()}}},t.prototype._updateMaterials=function(){var e=[M.PLANE_OUTLINE_COLOR[0],M.PLANE_OUTLINE_COLOR[1],M.PLANE_OUTLINE_COLOR[2],M.PLANE_OUTLINE_COLOR[3]*this._baseOpacity];this._previewOutlineMaterial.setParameterValues({color:e});var t=[M.PLANE_BACKGROUND_COLOR[0],M.PLANE_BACKGROUND_COLOR[1],M.PLANE_BACKGROUND_COLOR[2],M.PLANE_BACKGROUND_COLOR[3]*this._baseOpacity],i=this.inputState&&"resize"===this.inputState.type,a=i?M.GRID_COLOR:[0,0,0,0];this._gridMaterial.setParameterValues({backgroundColor:t,gridColor:a})},t.prototype._setSingleManipulatorInteractive=function(e,t){if(!t)return this.shiftManipulator.interactive=!0,this.rotateManipulator.interactive=!0,void this.resizeManipulators.forEach(function(e){e.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateManipulator.interactive=this.rotateManipulator===e,this.resizeManipulators.forEach(function(t){t.interactive=t===e})};var l;return a([d.property()],t.prototype,"clock",void 0),a([d.property({constructOnly:!0})],t.prototype,"view",void 0),a([d.property({dependsOn:["plane","inputState"],readOnly:!0})],t.prototype,"state",null),a([d.property({dependsOn:["view.type"],readOnly:!0})],t.prototype,"isSupported",null),a([d.property({readOnly:!0})],t.prototype,"cursor",void 0),a([d.property({value:null})],t.prototype,"plane",null),a([d.property({readOnly:!0})],t.prototype,"layersMode",void 0),a([d.property({cast:o.castForReferenceSetter})],t.prototype,"excludedLayers",null),a([d.property({type:Boolean,value:!1})],t.prototype,"excludeGroundSurface",null),a([d.property({value:null})],t.prototype,"inputState",null),t=l=a([d.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],t)}(d.declared(T.InteractiveToolBase)),x=w.boundedPlane.create(),D=c.createScreenPointArray();return C});