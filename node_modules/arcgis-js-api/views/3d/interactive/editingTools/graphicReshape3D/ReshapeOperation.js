// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/compilerUtils","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/maybe","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/vec3","../../../../../layers/graphics/dehydratedFeatures","../../../../../support/elevationInfoUtils","../../Manipulator3D","../../manipulatorUtils","../../dragUtils/projectScreenToMap","../manipulatorUtils","./reshapeUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../../interactive/dragUtils/dragHandlers","../../../../interactive/dragUtils/screenDragToMap"],function(e,t,a,r,i,o,n,p,s,l,h,u,c,d,v,m,_,g,f,M,y,b,x,H){function S(e){return"vertex"===e.handle.type}function G(e){return"edge"===e.handle.type}Object.defineProperty(t,"__esModule",{value:!0});var w=function(e){function t(t){var a=e.call(this,t)||this;return a._vertexManipulatorMaterial=m.createManipulatorMaterial([1,.5,0],1),a._edgeManipulatorMaterial=m.createManipulatorMaterial([.5,.5,.5],1),a._selectedManipulatorMaterial=m.createManipulatorMaterial([1,1,1],1),a._manipulatorGeometry=new y(b.createSphereGeometry(1,16,16),"reshape-manipulator"),a._handles=new p,a._manipulatorHandles=new p,a._manipulatorInfos=[],a._reshapeHelper=null,a._moveManipulator=null,a._moveZManipulator=null,a._numGrabbing=0,a._reshapeEventState=0,a.view=null,a.graphic=null,a.outputGeometry=null,a.manipulators=null,a._emitter.target=null,a}return r(t,e),t.prototype.initialize=function(){var e=this;this._handles.add(this.watch(["graphic.visible","graphic.layer.visible"],function(){for(var t=e.graphic.visible&&e.graphic.layer.visible,a=0,r=e._manipulatorInfos;a<r.length;a++){r[a].manipulator.visible=!!t}s.isSome(e._moveZManipulator)&&(e._moveZManipulator.visible=!!t)}))},t.prototype.destroy=function(){this._clear(),this._handles.destroy()},Object.defineProperty(t.prototype,"inputGeometry",{get:function(){return s.isSome(this._reshapeHelper)?this._reshapeHelper.geometry:null},set:function(e){this._recreateManipulators(e)},enumerable:!0,configurable:!0}),t.prototype.removeSelectedVertices=function(){var e=this._manipulatorInfos.filter(function(e){return e.manipulator.selected&&"vertex"===e.handle.type});this._removeVertices(e)},t.prototype.manipulatorSelectionChanged=function(){this._updateMoveZManipulatorPosition()},t.prototype._clear=function(){this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[],this._moveManipulator=null,this._reshapeHelper=null,this._numGrabbing=0},t.prototype._recreateManipulators=function(e){if(this._clear(),this._reshapeHelper=f.createReshapeHelper(e,"global"===this.view.viewingMode),!s.isNone(this._reshapeHelper)){for(var t=d.getGraphicEffectiveElevationInfo(this.graphic),a=0,r=this._reshapeHelper.components;a<r.length;a++){for(var i=r[a],o=0,n=i.vertices;o<n.length;o++){var p=n[o];this._createPerVertexManipulator(p,t)}for(var l=0,h=i.edges;l<h.length;l++){var u=h[l];this._createPerVertexManipulator(u,t)}}this._createGraphicMoveManipulators()}},t.prototype._perGraphicManipulatorDragAction=function(e,t){if("end"!==t.action){for(var a=[],r=this._manipulatorInfos.some(function(e){return"vertex"===e.handle.type&&e.manipulator.selected}),i=1===e&&r,o=s.expect(this._reshapeHelper),n=0,p=this._manipulatorInfos;n<p.length;n++){var l=p[n];"vertex"===l.handle.type&&(l.manipulator.grabbing||i&&!l.manipulator.selected||(s.expect(o).addDelta(l.handle,t.deltaDeltaX,t.deltaDeltaY,t.deltaDeltaZ),a.push(l.handle.pos),this._updateManipulatorPosition(l)))}if(0!==a.length){for(var h=0,u=this._manipulatorInfos;h<u.length;h++){var l=u[h];"vertex"!==l.handle.type&&this._updateManipulatorPosition(l)}this.outputGeometry=o.commit();a.length===this._manipulatorInfos.length?(this._updateEventState(1),this.emit("move",{type:"move",dx:t.screenDeltaDeltaX,dy:t.screenDeltaDeltaY,mover:this.graphic})):(this._updateEventState(2),this.emit("reshape",{type:"reshape",mover:this.graphic}))}}},t.prototype._perVertexManipulatorDragAction=function(e,t){var a=G(e)?this._splitEdgeManipulator(e):e;this._updateEventState(2),!1===e.manipulator.selected&&(this._clearManipulatorSelection(),this._updateMoveZManipulatorPosition());var r=t.deltaDeltaX,i=t.deltaDeltaY,o=t.deltaDeltaZ;if(r||i||o){for(var n=[],p=0,l=this._manipulatorInfos;p<l.length;p++){var h=l[p];S(h)&&(h.manipulator.selected&&!h.manipulator.grabbing||h===a)&&n.push(h)}for(var u=s.expect(this._reshapeHelper),c=0,d=n;c<d.length;c++){var v=d[c],m=v.handle;u.addDelta(m,r,i,o),this._updateManipulatorPosition(v)}this.outputGeometry=u.commit();for(var _=0,g=n;_<g.length;_++){var v=g[_],m=v.handle;this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(m.left)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(m.right))}this.emit("reshape",{type:"reshape",mover:this.graphic})}},t.prototype._updateEventState=function(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}var t=this._reshapeEventState!==e;return this._reshapeEventState=e,t},t.prototype._createGraphicMoveManipulators=function(){var e=this;this._moveManipulator=g.createGraphicMoveXYManipulator(this.view,this.graphic),this._manipulatorHandles.add(x.createManipulatorDragHandler(this._moveManipulator,function(t,a){return H.withScreenHistoryInfo(H.withHistoryInfo(g.createGraphicMoveXYScreenDragToMap(e.view,t,a)))},function(t){return e._perGraphicManipulatorDragAction(0,t)})),this._manipulatorHandles.add(this._watchAndUpdateGrabState(this._moveManipulator)),this._moveManipulator.events.on("immediate-click",function(t){e.emit("immediate-click"),t.stopPropagation()}),this.manipulators.add(this._moveManipulator),this._moveZManipulator=g.createGraphicMoveZManipulator({view:this.view,graphic:this.graphic}),s.isSome(this._moveZManipulator)&&(this._manipulatorHandles.add(x.createManipulatorDragHandler(this._moveZManipulator,function(t){return H.withScreenHistoryInfo(H.withHistoryInfo(g.createGraphicMoveZScreenDragToMap(e.view,t)))},function(t){return e._perGraphicManipulatorDragAction(1,t)})),this._manipulatorHandles.add(this._watchAndUpdateGrabState(this._moveZManipulator)),this.manipulators.add(this._moveZManipulator),this._manipulatorHandles.add(l.init(this.graphic,"geometry",function(){return e._updateMoveZManipulatorPosition()})))},t.prototype._clearManipulatorSelection=function(){for(var e=0,t=this._manipulatorInfos;e<t.length;e++){t[e].manipulator.selected=!1}this._updateMoveZManipulatorPosition()},t.prototype._createPerVertexManipulator=function(e,t){var a=this;void 0===t&&(t=d.getGraphicEffectiveElevationInfo(this.graphic));var r=new v.Manipulator3D({view:this.view,renderObjects:[{geometry:this._manipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|P.Vertex},{geometry:this._manipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:4|P.Edge},{geometry:this._manipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8}],radius:5,elevationInfo:t,visible:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(r,e);var i={manipulator:r,handle:e};return this._manipulatorInfos.push(i),this.manipulators.add(r),this._updateManipulatorPosition(i),this._manipulatorHandles.add(this._watchAndUpdateGrabState(r),r),this._manipulatorHandles.add(x.createManipulatorDragHandler(r,function(e){return H.withHistoryInfo(H.createXYConstrainedFromProject(_.createForGraphicAtLocation(a.view,a.graphic,e.elevationAlignedLocation),e.location.spatialReference))},function(e){return a._perVertexManipulatorDragAction(i,e)})),r.events.on("immediate-click",function(e){return a._manipulatorClickCallback(e,i)}),r},t.prototype._setTypeSpecificManipulatorSettings=function(e,t){switch(t.type){case"vertex":e.state=P.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.hideOnGrab=!0;break;case"edge":e.state=P.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=1,e.hideOnGrab=!1;break;default:o.neverReached(t)}},t.prototype._watchAndUpdateGrabState=function(e){var t=this;return e.events.on("grab",function(e){"start"===e.action?t._numGrabbing++:(t._numGrabbing--,t._updateEventState(0))})},t.prototype._removeManipulator=function(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator))},t.prototype._getManipulatorInfoFromHandle=function(e){if(e)for(var t=0,a=this._manipulatorInfos;t<a.length;t++){var r=a[t];if(e===r.handle)return r}return null},t.prototype._updateManipulatorPosition=function(e){if(e){var t=s.expect(this._reshapeHelper);"vertex"===e.handle.type?e.manipulator.location=t.getVertexPositionAsPoint(e.handle,E):"edge"===e.handle.type&&(e.manipulator.location=t.getEdgePositionAsPoint(e.handle,.5,E))}},t.prototype._splitEdgeManipulator=function(e){var t=s.expect(this._reshapeHelper).splitEdge(e.handle,.5),a=e;return a.handle=t,this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle),t.left&&this._createPerVertexManipulator(t.left),t.right&&this._createPerVertexManipulator(t.right),a},t.prototype._updateMoveZManipulatorPosition=function(){if(!s.isNone(this._moveZManipulator)){var e=M.sv3d.get();u.vec3.set(e,0,0,0);for(var t=0,a=0,r=this._manipulatorInfos;a<r.length;a++){var i=r[a];S(i)&&i.manipulator.selected&&(t++,u.vec3.add(e,e,i.manipulator.renderLocation))}if(0!==t&&(u.vec3.scale(e,e,1/t),E.spatialReference=s.expect(this._reshapeHelper).geometry.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(e,E)))return void(this._moveZManipulator.elevationAlignedLocation=E);m.placeManipulatorAtGraphic(this._moveZManipulator,this.graphic)}},t.prototype._removeVertices=function(e){for(var t=[],a=s.expect(this._reshapeHelper),r=0,i=e;r<i.length;r++){var o=i[r];if("vertex"===o.handle.type&&a.canRemoveVertex(o.handle)){t.push(o.handle.unnormalizedPos),this._removeManipulator(o),this._removeManipulator(this._getManipulatorInfoFromHandle(o.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(o.handle.right));var n=a.removeVertex(o.handle);n&&this._createPerVertexManipulator(n)}}if(t.length>0){this.outputGeometry=a.commit();var p=this._updateEventState(2);this.emit("vertex-remove",{type:"vertex-remove",removed:t}),p&&this._updateEventState(0),this._updateMoveZManipulatorPosition()}},t.prototype._manipulatorClickCallback=function(e,t){if("vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),G(t)&&0===e.button){var a=this._splitEdgeManipulator(t);this.outputGeometry=s.expect(this._reshapeHelper).commit();var r=this._updateEventState(2);this.emit("vertex-add",{type:"vertex-add",added:[a.handle.unnormalizedPos]}),r&&this._updateEventState(0)}e.stopPropagation()},a([h.property({constructOnly:!0})],t.prototype,"view",void 0),a([h.property({constructOnly:!0})],t.prototype,"graphic",void 0),a([h.property()],t.prototype,"inputGeometry",null),a([h.property()],t.prototype,"outputGeometry",void 0),a([h.property({constructOnly:!0})],t.prototype,"manipulators",void 0),t=a([h.subclass("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],t)}(h.declared(n.EventedAccessor));t.ReshapeOperation=w;var P,E=c.makeDehydratedPoint(0,0,null,null);!function(e){e.Vertex=16,e.Edge=32}(P||(P={}))});