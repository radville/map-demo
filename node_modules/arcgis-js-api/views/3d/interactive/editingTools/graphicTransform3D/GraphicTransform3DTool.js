// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Evented","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/math/common","../../../../../support/elevationInfoUtils","../../../../../support/featureFlags","../isSupportedGraphicUtils","../manipulatorUtils","./GraphicScaleRotateTransform","./GraphicXYAxisTransform","./GraphicXYTransform","./GraphicZTransform","./isSupportedGraphic","../../../support/stack","../../../../interactive/InteractiveToolBase"],function(t,e,r,a,o,i,s,n,l,c,p,h,u,m,f,d,y,g,T,x,v,S,b,R,M,A){Object.defineProperty(e,"__esModule",{value:!0});var G=l.getLogger("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransform3DTool"),w=function(t){function e(e){var r=t.call(this,e)||this;return r.enableRotation=!0,r.enableScaling=!0,r.type="transform-3d",r.handles=new n,r.zTransform=null,r.scaleRotate=null,r}return a(e,t),e.prototype.initialize=function(){if(this.xyTransform=new S.GraphicXYTransform({tool:this}),this.xyAxisTransform=new v.GraphicXYAxisTransform({tool:this}),this.enableScaling||this.enableRotation){var t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new x.GraphicScaleRotateTransform({tool:this,mode:t})}y.enableEditing3D()&&T.canMoveZ(this.graphic,d.getGraphicEffectiveElevationInfo(this.graphic))&&(this.zTransform=new b.GraphicZTransform({tool:this})),this._recreateManipulators()},e.prototype.destroy=function(){this._clear(),this.xyTransform.destroy(),this.xyTransform=null,this.xyAxisTransform.destroy(),this.xyAxisTransform=null,c.isSome(this.scaleRotate)&&(this.scaleRotate.destroy(),this.scaleRotate=null),c.isSome(this.zTransform)&&(this.zTransform.destroy(),this.zTransform=null),this._set("view",null),this._set("graphic",null)},Object.defineProperty(e.prototype,"graphic",{set:function(t){if(null==t)return void G.error("invalid graphic");var e=R.isSupportedGraphic(t);if(0!==e)return G.error("Transform tool not supported for graphic ("+g.isSupportedGraphicResultMessage(e)+")."),void this._set("graphic",null);this._set("graphic",t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"symbolRotationAngle",{get:function(){var t=this.graphic.symbol;if(t){var e=t.symbolLayers.find(function(t){return"object"===t.type}),r=e&&e.heading||0;return f.toRadian(-r)}return 0},enumerable:!0,configurable:!0}),e.prototype.reset=function(){},e.prototype.onDetach=function(){c.isSome(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()},e.prototype.onHide=function(){c.isSome(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()},e.prototype._clear=function(){this.handles.removeAll()},e.prototype._recreateManipulators=function(){var t=this;this._clear();var e=c.unwrap(this.graphic);this.xyTransform.recreateManipulators(),this.xyAxisTransform.recreateManipulators(),c.isSome(this.scaleRotate)&&this.scaleRotate.recreateManipulators(),c.isSome(this.zTransform)&&this.zTransform.recreateManipulators(),this.handles.add([p.watch(e,"geometry",function(){return t.updateManipulators()})]),this.updateManipulators()},e.prototype.updateManipulators=function(){var t=this.view.renderCoordsHelper.basisMatrixAtPosition(this.xyTransform.renderLocation,M.sm4d.get()),e="none";this.xyTransform.focused?e="xy":this.xyAxisTransform.focused?e="xy-axis":c.isSome(this.scaleRotate)&&this.scaleRotate.getFocused()&&(e="scale-rotate"),c.isSome(this.zTransform)&&this.zTransform.dragging&&(e="z"),c.isSome(this.scaleRotate)&&this.scaleRotate.dragging&&(e="scale-rotate"),this.xyAxisTransform.dragging&&(e="xy-axis"),this.xyTransform.dragging&&(e="xy");var r=t;if(c.isSome(this.scaleRotate)){this.scaleRotate.updateManipulators(t,"scale-rotate"===e);var a=this.scaleRotate.getScale(),o=u.mat4.fromScaling(M.sm4d.get(),m.vec3.set(M.sv3d.get(),a,a,a));r=u.mat4.multiply(M.sm4d.get(),t,o)}this.xyTransform.updateManipulators(r,"none"===e||"xy"===e),this.xyAxisTransform.updateManipulators(r,"xy"===e||"xy-axis"===e,"xy-axis"===e),c.isSome(this.zTransform)&&this.zTransform.updateManipulators(r)},r([h.property({constructOnly:!0,nonNullable:!0})],e.prototype,"view",void 0),r([h.property({value:null})],e.prototype,"graphic",null),r([h.property()],e.prototype,"enableRotation",void 0),r([h.property()],e.prototype,"enableScaling",void 0),r([h.property({readOnly:!0})],e.prototype,"type",void 0),e=r([h.subclass("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransform3DTool")],e)}(h.declared(s.EventedMixin(A.InteractiveToolBase)));e.GraphicTransform3DTool=w});