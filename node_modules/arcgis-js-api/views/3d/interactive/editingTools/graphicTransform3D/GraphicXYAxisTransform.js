// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Handles","../../../../../core/has","../../../../../core/maybe","../../../../../core/watchUtils","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../Manipulator3D","../../manipulatorUtils","../../dragUtils/projectScreenToMap","./graphicTransform3DToolConfig","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/materials/ColorMaterial","../../../../interactive/dragUtils/dragActions","../../../../interactive/dragUtils/dragHandlers","../../../../interactive/dragUtils/screenDragToMap"],function(t,a,r,e,o,i,n,l,s,c,p,u,g,h,m,d,f,v,M,A,y,b,w,_,R){function S(t){return"local"===t.viewingMode||t.scale<v.ALIGN_ARROWS_SCALE_THRESHOLD}Object.defineProperty(a,"__esModule",{value:!0});var I;!function(t){t.Highlighted=512,t.Visible=1024}(I||(I={}));var E=function(){function t(t){this._handles=new n,this.arrowManipulatorInfos=[],this.tool=t.tool}return t.prototype.destroy=function(){this._clear()},t.prototype._clear=function(){var t=this;this._handles.removeAll(),this.arrowManipulatorInfos.forEach(function(a){t.tool.manipulators.remove(a.manipulator)}),this.arrowManipulatorInfos=[]},Object.defineProperty(t.prototype,"focused",{get:function(){return this.arrowManipulatorInfos.some(function(t){return t.manipulator.focused})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dragging",{get:function(){return this.arrowManipulatorInfos.some(function(t){return t.manipulator.dragging})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arrowRotationAngle",{get:function(){return"local"===this.tool.view.viewingMode||this.tool.view.scale<v.ALIGN_ARROWS_SCALE_THRESHOLD?this.tool.symbolRotationAngle:0},enumerable:!0,configurable:!0}),t.prototype.createDragAction=function(){var t=this,a=w.createGraphicDragAction(this.tool.graphic);return function(r){switch("start"===r.action&&t.tool.emit("graphic-translate-start",{graphic:t.tool.graphic}),a(r),r.action){case"update":t.tool.emit("graphic-translate",{graphic:t.tool.graphic,dx:r.deltaX,dy:r.deltaY,dz:r.deltaZ,type:"translate"});break;case"end":t.tool.emit("graphic-translate-stop",{graphic:t.tool.graphic})}}},t.prototype.recreateManipulators=function(){var t=this;this._clear();for(var a=[],r=0;r<4;r++){var e=this.createArrowManipulator(r);a.push(e),this.tool.manipulators.add(e.manipulator);var o=this.createDragAction(),i=_.createManipulatorDragHandler(e.manipulator,this.createDragEventMappingFunction(r),o);this._handles.add(i),this._handles.add([e.manipulator.events.on("focus",function(){t.tool.updateManipulators()}),e.manipulator.events.on("immediate-click",function(t){t.stopPropagation()})])}this.arrowManipulatorInfos=a,this.arrowManipulatorInfos.forEach(function(a){d.placeManipulatorAtGraphic(a.manipulator,t.tool.graphic)}),this._handles.add([c.init(this.tool.graphic,"geometry",function(){t.arrowManipulatorInfos.forEach(function(a){d.placeManipulatorAtGraphic(a.manipulator,t.tool.graphic)})}),c.init(this.tool.graphic,["visible","layer.visible"],function(){var a=t.tool.graphic.visible&&t.tool.graphic.layer.visible;t.arrowManipulatorInfos.forEach(function(t){t.manipulator.visible=a})})])},t.prototype.updateManipulators=function(t,a,r){var e=this.tool.symbolRotationAngle,o=p.mat4.identity(M.sm4d.get());0!==e&&p.mat4.rotate(o,o,e,h.vec3f64.fromValues(0,0,1));var i=p.mat4.multiply(M.sm4d.get(),t,o),n=S(this.tool.view)?i:t,s=this.dragging,c=a||l("esri-mobile")?I.Visible:0;this.arrowManipulatorInfos.forEach(function(t){var a=p.mat4.multiply(M.sm4d.get(),n,t.transform);t.manipulator.state=s?c|(t.manipulator.dragging?I.Highlighted:0):c|(t.manipulator.focused&&r?I.Highlighted:0),t.manipulator.modelTransform=a})},t.prototype.createArrowManipulator=function(t){var a=Math.sqrt(v.DISC_TRANSLATE_ARROW_SIZE*v.DISC_TRANSLATE_ARROW_SIZE*3/4),r=y.createExtrudedTriangle(a,v.DISC_TRANSLATE_ARROW_SIZE/2,v.DISC_TRANSLATE_ARROW_SIZE/2,v.DISC_HEIGHT);y.transformInPlace(r,p.mat4.fromTranslation(M.sm4d.get(),g.vec3.set(M.sv3d.get(),0,-a/3,0)));var e=new A(r,"graphic-transform-disc-arrow"+t),o=this.createMaterial(),i=this.createMaterial(.5),n=this.createMaterial(0),l=new m.Manipulator3D({view:this.tool.view,renderObjects:[{geometry:e,material:o,stateMask:I.Visible|I.Highlighted},{geometry:e,material:i,stateMask:I.Visible},{geometry:e,material:n,stateMask:0}],autoScaleRenderObjects:!1,radius:a,focusMultiplier:1,touchMultiplier:1,elevationInfo:{mode:"on-the-ground",offset:0},collisionType:{type:"disc",direction:h.vec3f64.fromValues(0,0,1)}}),s=p.mat4.identity(M.sm4d.get());p.mat4.fromZRotation(s,t*Math.PI/2);var c=p.mat4.identity(M.sm4d.get());p.mat4.fromTranslation(c,g.vec3.set(M.sv3d.get(),0,v.DISC_TRANSLATE_ARROW_OFFSET,0));var d=u.mat4f64.create();return p.mat4.multiply(d,s,c),{manipulator:l,transform:d}},t.prototype.createMaterial=function(t){void 0===t&&(t=1);var a=v.HANDLE_COLOR.concat([t]),r=new b({color:a,transparent:1!==t,cullFace:2},"graphic-transform");return r.renderOccluded=2,r},t.prototype.createDragEventMappingFunction=function(t){var a=this;return function(r){var e=a.arrowRotationAngle,o=[Math.cos(e),Math.sin(e),0],i=[-o[1],o[0],0],n=R.createMapAxisConstrainedScreenToMapDrag(f.createForGraphicAtLocation(a.tool.view,a.tool.graphic,r.elevationAlignedLocation),t%2==0?i:o,s.expect(a.tool.graphic.geometry).spatialReference);return s.isNone(n)?null:function(t){var a=n(t);return s.isNone(a)?null:a}}},t}();a.GraphicXYAxisTransform=E});