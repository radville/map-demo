// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/asyncUtils","../../../core/Logger","../../../core/promiseUtils","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4f64","../../../geometry/Extent","../../../geometry/support/aaBoundingRect","./LayerView3D","./support/overlayImageUtils","./support/projectExtentUtils","../support/debugFlags","../webgl-engine/lib/RenderGeometry","../webgl-engine/lib/Texture","../webgl-engine/materials/DefaultMaterial","../../layers/LayerView","../../layers/RefreshableLayerView"],function(e,t,r,i,a,n,o,s,l,d,u,h,c,p,g,m,y,f,v,w,x,_,b,S,R){var D=l.getLogger("esri.views.3d.layers.DynamicLayerView3D"),E=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.supportsDraping=!0,t.hasDraped=!0,t.fullExtentInLocalViewSpatialReference=null,t.overlayUpdating=!1,t.maximumDataResolution=null,t._images=[],t._extents=[],t.updateWhenStationary=!0,t}return r(t,e),Object.defineProperty(t.prototype,"drawingOrder",{get:function(){return this._get("drawingOrder")},set:function(e){if(e!==this._get("drawingOrder")){this._set("drawingOrder",e);var t=new Set;this._images.forEach(function(r){r&&r.material&&(r.material.renderPriority=e,t.add(r.material.id))}),t.size>0&&(this.view._stage.renderView.getDrapedRenderer().updateRenderOrder(t),this.emit("draped-data-change"))}},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this.addResolvingPromise(v.toViewIfLocal(this).then(function(t){return e._set("fullExtentInLocalViewSpatialReference",t)})),this.updatingHandles.add(this,"suspended",function(){return e._suspendedChangeHandler()}),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(function(){e._isScaleRangeActive()&&e.notifyChange("suspended")},function(){})),this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",function(){return e.notifyChange("suspended")}),this.updatingHandles.add(this,"fullOpacity",function(t){return e._opacityChangeHandler(t)})},t.prototype.destroy=function(){this.clear()},t.prototype.setDrapingExtent=function(e,t,r,i,a,n){var o=this._clippedExtent(t,L),s=f.computeImageExportSize(t,o,i);if(n*=this.view.pixelRatio,"imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){var l=this.layer.imageMaxWidth,d=this.layer.imageMaxHeight;if(s.width>l){var u=l/s.width;s.height=Math.floor(s.height*u),s.width=l,n*=u}if(s.height>d){var u=d/s.height;s.width=Math.floor(s.width*u),s.height=d,n*=u}}var h=this._extents[e];h&&m.equals(h.extent,o)&&!this._imageSizeDiffers(o,h.imageSize,s)||(this._extents[e]={extent:m.create(o),spatialReference:r,imageSize:s,renderLocalOrigin:a,pixelRatio:n},this.suspended||this._fetch(e))},t.prototype.getGraphicFromGraphicUid=function(){return null},t.prototype.clear=function(){for(var e=0;e<this._images.length;e++)this._clearImage(e)},t.prototype.doRefresh=function(e){return o(this,void 0,void 0,function(){var t,r;return n(this,function(i){switch(i.label){case 0:if(this.suspended)return[2];for(t=[],r=0;r<this._extents.length;r++)this._extents[r]&&t.push(this._fetch(r,e));return[4,d.eachAlways(t)];case 1:return i.sent(),[2]}})})},t.prototype.canResume=function(){if(!this.inherited(arguments))return!1;if(this._isScaleRangeLayer()){var e=this.layer,t=e.minScale,r=e.maxScale;if(t>0||r>0){var i=this.view.scale;if(i<r||t>0&&i>t)return!1}}return!0},t.prototype.isUpdating=function(){if(this.overlayUpdating)return!0;for(var e=0,t=this._images;e<t.length;e++){if(t[e].loadingPromise)return!0}return!1},t.prototype.processResult=function(e,t,r){return o(this,void 0,void 0,function(){return n(this,function(r){return(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement)&&(e.image=t),[2]})})},t.prototype.findExtentInfoAt=function(e){for(var t=0,r=this._extents;t<r.length;t++){var i=r[t],a=i.extent;if(new g(a[0],a[1],a[2],a[3],i.spatialReference).contains(e))return i}return null},t.prototype.getFetchOptions=function(){},t.prototype.redraw=function(e,t){return o(this,void 0,void 0,function(){var r=this;return n(this,function(i){switch(i.label){case 0:return[4,s.forEach(this._images,function(i,a){return o(r,void 0,void 0,function(){return n(this,function(r){switch(r.label){case 0:return i?[4,e(i,t)]:[2];case 1:return r.sent(),this._createStageObjects(a,i.image),this.emit("draped-data-change"),[2]}})})})];case 1:return i.sent(),[2]}})})},t.prototype._imageSizeDiffers=function(e,t,r){if(!this.maximumDataResolution)return!0;if(w.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;var i=m.width(e)/this.maximumDataResolution.x,a=m.height(e)/this.maximumDataResolution.y,n=i/t.width,o=a/t.height,s=i/r.width,l=a/r.height,d=Math.abs(n-s),u=Math.abs(o-l);return d>1.5||u>1.5},t.prototype._fetch=function(e,t){return o(this,void 0,void 0,function(){var r,i,o,s,l,h,c,p,y=this;return n(this,function(n){switch(n.label){case 0:return this.suspended?[2]:(r=this._extents[e],i=r.extent,o=new g(i[0],i[1],i[2],i[3],r.spatialReference),this._images[e]||(this._images[e]={texture:null,material:null,rendergeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:m.create(i)}),s=this._images[e],s.loadingAbortController&&(s.loadingAbortController.abort(),s.loadingAbortController=null),0===o.width||0===o.height?(this._clearImage(e),[2]):(l=d.createAbortController(),s.loadingAbortController=l,d.onAbort(t,function(){return l.abort()}),h=l.signal,c=this._waitFetchReady(h).then(function(){var e=a({requestAsImageElement:!0,pixelRatio:r.pixelRatio},y.getFetchOptions(),{signal:h}),t=r.imageSize,i=t.height,n=t.width;return y.layer.fetchImage(o,n,i,e)}).then(function(e){if(u.isAborted(h))throw D.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),u.createAbortError();return y.processResult(s,e)}),s.loadingPromise=c,d.always(c,function(){c===s.loadingPromise&&(s.loadingPromise=null,s.loadingAbortController=null)}),p=c.then(function(){m.set(s.renderExtent,i),y._createStageObjects(e,s.image),y.notifyChange("updating"),y.emit("draped-data-change")}).catch(function(e){throw e&&!d.isAbortError(e)&&D.error(e),y.notifyChange("updating"),e}),this.notifyChange("updating"),[4,p]));case 1:return n.sent(),[2]}})})},t.prototype._clearImage=function(e){var t=this._images[e],r=this.view._stage;t&&(t.rendergeometry&&(r.renderView.getDrapedRenderer().removeRenderGeometries([t.rendergeometry]),t.rendergeometry=null),t.texture&&(r.remove(4,t.texture.id),t.texture=null),t.material&&(r.remove(3,t.material.id),t.material=null),t.loadingAbortController&&(t.loadingAbortController.abort(),t.loadingAbortController=null),t.loadingPromise=null,t.image=null,t.pixelData=null)},t.prototype._createStageObjects=function(e,t){var r=this.view._stage,i=this._images[e];i.texture&&(r.remove(4,i.texture.id),i.texture=null),t?(i.texture=new _(t,"dynamicLayer",{width:t.width,height:t.height,wrap:{s:33071,t:33071}}),r.add(4,i.texture)):i.material&&(r.remove(3,i.material.id),i.material=null),!i.material&&i.texture?(i.material=new b({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.fullOpacity,textureId:i.texture.id,receiveSSAO:!1},"dynamicLayer"),i.material.renderPriority=this.drawingOrder,r.add(3,i.material)):i.material&&t&&i.material.setParameterValues({textureId:i.texture.id});var a=r.renderView.getDrapedRenderer();if(i.material){var n=void 0,o=this._extents[e].renderLocalOrigin;if(0===e)n=f.createGeometryForExtent(i.renderExtent,-1);else{if(1!==e)return void console.error("DynamicLayerView3D._createStageObjects: Invalid extent idx");var s=this._images[0].renderExtent;if(!s)return;n=f.createOuterImageGeometry(s,i.renderExtent,-1)}var l=new x(n);l.material=i.material,l.origin=o,l.transformation=p.mat4f64.create(),l.name="dynamicLayer",l.uniqueName="dynamicLayer#"+n.id,a.addRenderGeometries([l]),i.rendergeometry&&a.removeRenderGeometries([i.rendergeometry]),i.rendergeometry=l}else i.rendergeometry&&(a.removeRenderGeometries([i.rendergeometry]),i.rendergeometry=null)},t.prototype._isScaleRangeLayer=function(){return"minScale"in this.layer&&"maxScale"in this.layer},t.prototype._isScaleRangeActive=function(){return!!this._isScaleRangeLayer()&&(this.layer.minScale>0||this.layer.maxScale>0)},t.prototype._clippedExtent=function(e,t){if("local"!==this.view.viewingMode)return m.set(t,e);var r=this.view.basemapTerrain,i=r.extent;return r.ready&&i?m.intersection(e,i,t):m.set(t,e)},t.prototype._opacityChangeHandler=function(e){for(var t=0,r=this._images;t<r.length;t++){var i=r[t];i&&i.material&&i.material.setParameterValues({opacity:e})}this.emit("draped-data-change")},t.prototype._suspendedChangeHandler=function(){this.suspended?(this.clear(),this.emit("draped-data-change")):this.refresh()},t.prototype._waitFetchReady=function(e){return o(this,void 0,void 0,function(){return n(this,function(t){switch(t.label){case 0:return this.updateWhenStationary?[4,h.whenOnce(this.view,"stationary",e)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},i([c.property()],t.prototype,"layer",void 0),i([c.property({dependsOn:["view.scale","layer.minScale","layer.maxScale"]})],t.prototype,"suspended",void 0),i([c.property({type:Boolean})],t.prototype,"supportsDraping",void 0),i([c.property({type:Boolean})],t.prototype,"hasDraped",void 0),i([c.property({value:0,type:Number})],t.prototype,"drawingOrder",null),i([c.property({readOnly:!0})],t.prototype,"fullExtentInLocalViewSpatialReference",void 0),i([c.property()],t.prototype,"overlayUpdating",void 0),i([c.property({dependsOn:["overlayUpdating"]})],t.prototype,"updating",void 0),t=i([c.subclass("esri.views.3d.layers.DynamicLayerView3D")],t)}(c.declared(R.RefreshableLayerView(y.LayerView3D(S)))),L=m.create();return E});