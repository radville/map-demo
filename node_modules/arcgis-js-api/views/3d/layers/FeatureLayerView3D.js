// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/compilerUtils","../../../core/Error","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../layers/graphics/dehydratedFeatures","../../../layers/graphics/controllers/FeatureTileController3D","./FeatureLikeLayerView3D","./LayerView3D","./support/FeatureTileFetcher3DLayerViewContext","./support/layerViewUpdatingProperties","../support/EventedSet","../../layers/FeatureLayerView","../../layers/LayerView","../../layers/RefreshableLayerView"],function(e,t,r,i,o,s,a,n,u,l,p,c,h,d,y,m,f,g,v,F,b,x){return function(e){function t(t){var r=e.call(this,t)||this;return r._controllerTotal=0,r._graphicsCoreTotal=0,r.suspendResumeExtentMode="data",r}return r(t,e),t.prototype.destroy=function(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)},Object.defineProperty(t.prototype,"updatingProgressValue",{get:function(){var e=1;if(this.controller&&this.controller.updating){var t=this.controller.updatingRemaining,r=this.controller.updatingTotal;r>0&&(this._controllerTotal=Math.max(r,this._controllerTotal),e=(r-t)/r)}var i=1;if(this.graphics3d&&this.graphics3d.graphicsCore){var t=this.graphics3d.graphicsCore.updatingRemaining,r=this.graphics3d.graphicsCore.updatingTotal;r>0&&(this._graphicsCoreTotal=Math.max(r,this._graphicsCoreTotal),i=(r-t)/r)}return 1===e&&1===i&&(this._controllerTotal=0,this._graphicsCoreTotal=0),.5*(e+i)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"asyncGraphicsUpdates",{get:function(){if(this.controller)switch(this.controller.mode){case"snapshot":return this.controller.serviceDataCount>5e3;case"tiles":return!0;default:n.neverReached(this.controller.mode)}return!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasZ",{get:function(){var e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasM",{get:function(){var e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM},enumerable:!0,configurable:!0}),t.prototype.fetchPopupFeatures=function(e,t){return a(this,void 0,void 0,function(){var e;return s(this,function(r){return e=this.validateFetchPopupFeatures(t),e?[2,l.reject(e)]:[2,this.fetchClientPopupFeatures(t)]})})},t.prototype.setVisibility=function(e,t){this.graphics3d.graphicsCore.setObjectIdVisibility(e,t)},t.prototype.createQuery=function(){return this.inherited(arguments)},t.prototype.queryFeatures=function(e,t){var r=this,i=arguments,o=function(){return r.inherited(i,[e,t])};return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),o):o()},t.prototype.createController=function(){return a(this,void 0,void 0,function(){var e,t=this;return s(this,function(r){return this.fetcherContext=new f.FeatureTileFetcher3DLayerViewContext({layerView:this,returnZ:this.hasZ,returnM:this.hasM}),e=new d({layerView:this,context:this.fetcherContext,graphics:new v.EventedSet,extent:this.clippingExtent}),this.updatingHandles.add(e,"serviceDataExtent",function(e){t.graphics3d&&(t.graphics3d.dataExtent=e)},2),this.handles.add(p.init(this,"suspended",function(t){t?e.suspend():e.resume()},!0)),this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",function(){return t.updateDisplayFeatureLimit(e)},2),this.handles.add(this.view.resourceController.memoryController.events.on("quality-changed",function(){return t.updateDisplayFeatureLimit()})),[2,e]})})},t.prototype.doRefresh=function(){return a(this,void 0,void 0,function(){return s(this,function(e){return!this.suspended&&this.controller&&this.controller.refetch(),[2]})})},t.prototype.getStats=function(){var e=this.inherited(arguments);if(this.controller&&e.features){var t=this.controller.debug;e.features+="/"+t.storedFeatures+"/"+t.totalFeatures,e.totalVertices=t.totalVertices}var r=this.controller&&this.controller.displayFeatureLimit,i=r&&r.maximumSymbolComplexity;e.numTiles=this.controller?this.controller.tileDescriptors.length:0,e.partial=this.maximumNumberOfFeaturesExceeded,e.mode=this.controller?this.controller.mode:"n/a",e.symbolComplexity=i?"f:"+i.primitivesPerFeature+",v:"+i.primitivesPerCoordinate:"n/a";var o=this.graphics3d&&this.graphics3d.graphicsCore,s=o?o.unprocessedMemoryEstimate:0,a=this.controller?this.controller.expectedFeatureDiff*o.usedMemoryPerGraphic:0,n=function(e){return""+(e/1024/1024).toFixed(1)};return e.memory="u:"+n(this.getUsedMemory())+", pc:"+n(s)+", pf:"+n(a)+" MB",e},t.prototype.getUsedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)},t.prototype.getUnloadedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*e.usedMemoryPerGraphic:0)},t.prototype.ignoresMemoryFactor=function(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride},t.prototype.updateDisplayFeatureLimit=function(e){if(void 0===e&&(e=this.controller),e&&this.graphics3d&&this.graphics3d.graphicsCore){var t=this.graphics3d.graphicsCore.displayFeatureLimit,r=this.view.resourceController.memoryController.memoryFactor;if(1===r)e.displayFeatureLimit=t;else{var i=Math.ceil(t.maximumNumberOfFeatures*r),s=Math.ceil(t.maximumTotalNumberOfFeatures*r),a=Math.ceil(t.minimumTotalNumberOfFeatures*r);e.displayFeatureLimit=o({},t,{maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:a})}}},t.prototype._queryFeaturesMesh=function(e,t){return a(this,void 0,void 0,function(){var r,i,o,a,n,u,l,p;return s(this,function(s){switch(s.label){case 0:return[4,this._validateQueryFeaturesMesh(e)];case 1:return s.sent(),[4,t()];case 2:if(r=s.sent(),e&&e.outStatistics)return[2,r];for(i=this.layer.objectIdField,o=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,a=[],n=0,u=r.features;n<u.length;n++)l=u[n],l.geometry?(p=o.get(l.attributes[i]))&&(l.geometry=h.hydrateGeometry(p.graphic.geometry),a.push(l)):a.push(l);return r.features=a,[2,r]}})})},t.prototype._validateQueryFeaturesMesh=function(e){return a(this,void 0,void 0,function(){var t,r,i,o,a;return s(this,function(s){if(!e)return[2];for(t=function(e){throw new u("feature-layer-view:unsupported-query","Queries on Mesh feature collection layers do not support '"+e+"'")},r=["quantizationParameters","geometryPrecision","maxAllowableOffset"],i=0,o=r;i<o.length;i++)a=o[i],null!=e[a]&&t(a);return"returnM"in e&&e.returnM&&t("returnM"),"returnCentroid"in e&&e.returnCentroid&&t("returnCentroid"),e.outSpatialReference&&!e.outSpatialReference.equals(this.view.spatialReference)&&t("outSpatialReference"),[2]})})},i([c.property()],t.prototype,"layer",void 0),i([c.property()],t.prototype,"controller",void 0),i([c.property({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining","graphics3d.graphicsCore.updatingTotal"]})],t.prototype,"updatingProgressValue",null),i([c.property({aliasOf:"controller.maximumNumberOfFeatures",set:null,get:null})],t.prototype,"maximumNumberOfFeatures",void 0),i([c.property({dependsOn:["suspended","controller.maximumNumberOfFeaturesExceeded"]})],t.prototype,"maximumNumberOfFeaturesExceeded",null),i([c.property(g.updatingProgress)],t.prototype,"updatingProgress",void 0),i([c.property({readOnly:!0,dependsOn:["controller.mode"]})],t.prototype,"asyncGraphicsUpdates",null),i([c.property({readOnly:!0})],t.prototype,"hasZ",null),i([c.property({readOnly:!0})],t.prototype,"hasM",null),i([c.property()],t.prototype,"suspendResumeExtentMode",void 0),t=i([c.subclass("esri.views.3d.layers.FeatureLayerView3D")],t)}(c.declared(x.RefreshableLayerView(F.FeatureLayerView(y.FeatureLikeLayerView3D(m.LayerView3D(b))))))});