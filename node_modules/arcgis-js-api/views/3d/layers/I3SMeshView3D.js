// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Color","../../../Graphic","../../../core/Collection","../../../core/has","../../../core/iteratorUtils","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/promiseUtils","../../../core/requireUtils","../../../core/scheduling","../../../core/typedArrayUtil","../../../core/unitUtils","../../../core/watchUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f32","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../geometry/support/aaBoundingBox","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/layerUtils","../../../renderers/visualVariables/support/visualVariableUtils","../../../support/arcadeOnDemand","../../../symbols/Symbol3D","../../../symbols/support/unitConversionUtils","./I3SMeshViewLabeler","./SceneLayerWorker","./graphics/graphicUtils","./i3s/Highlights","./i3s/I3SElevationProvider","./i3s/I3SGeometryUtil","./i3s/I3SIntersectionHandler","./i3s/I3SUtil","./i3s/IDBCache","./support/attributeUtils","./support/edgeUtils","./support/layerViewUpdatingProperties","./support/symbolColorUtils","../support/debugFlags","../support/orientedBoundingBox","../support/projectionUtils","../support/buffer/glUtil","../webgl-engine/collections/Component/SourceGeometry","../webgl-engine/core/material/RenderTexture","../webgl-engine/lib/Texture","../webgl-engine/lib/TextureBackedBuffer/BufferManager","module","@dojo/framework/shim/Promise"],function(e,t,r,i,n,o,a,s,l,d,u,c,h,p,f,g,_,m,y,b,v,x,I,C,S,M,w,O,D,T,E,V,A,j,P,F,R,H,N,G,B,U,L,k,q,K,z,W,J,Q,X,Y,Z,$,ee,te,re,ie){function ne(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function oe(e,t,r){if(f.isNone(e))return null;for(var i=0;i<e.length;i++){var n=e[i];if(f.isSome(n)&&0!=(n.usage&r))return t[i].id}return null}function ae(e){return f.isSome(e)&&y.isArrayBuffer(e.data)}function se(e,t){for(var r=1024,i=0,n=e;i<n.length;i++){var o=n[i];r+=o.interleavedVertexData.byteLength+(o.indices?o.indices.byteLength:0),r+=o.positionData.data.byteLength+o.positionData.indices.byteLength}if(f.isSome(t))for(var a=0,s=t;a<s.length;a++){var l=s[a];f.isSome(l)&&y.isArrayBuffer(l.data)&&(r+=l.data.byteLength)}return r}function le(e,t){return t.byteSize>he?(de.warn("Node is too big to store in IndexedDB cache: "+e.id+" ("+t.byteSize+" bytes)"),!1):t.byteSize>0}Object.defineProperty(t,"__esModule",{value:!0});var de=h.getLogger("esri.views.3d.layers.SceneLayerView3D"),ue=[1,1,1,1],ce=function(){function e(){this.cachedSymbolInfos=[],this.cachedSymbolColors=null}return e}(),he=104857600;t.I3SMeshView3D=function(t){return function(t){function s(){var e=null!==t&&t.apply(this,arguments)||this;return e._elevationProvider=null,e._intersectionHandler=null,e._worker=new H,e._workerThread=null,e._nodeId2Meta=new Map,e._addTasks=new Map,e._rendererVersion=0,e._rendererFields=null,e._colorVariable=null,e._opacityVariable=null,e._symbolInfos=new Map,e._idbCache=new q.IDBCache("esri-scenelayer-cache","geometries"),e._labeler=null,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._layerUrl="",e._cacheKeySuffix=null,e._arcade=null,e._tmpAttributeOnlyGraphic=new l(null,null,{}),e}return i(s,t),Object.defineProperty(s.prototype,"layerUid",{get:function(){return this.layer&&this.layer.uid},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"sublayerUid",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"updatingMeshView3D",{get:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||f.isSome(this._labeler)&&this._labeler.updating},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"rendererTextureUsage",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)?31:12},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=b.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=F.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!u("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.renderView.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),s.prototype.initialize=function(){var t=this;if(x.open(_.getAbsMid("./SceneLayerWorker",e,ie)).then(function(e){t.destroyed?e.close():t._workerThread=e}),k.checkSceneLayerValid(this.layer),k.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUrl=this.layer.parsedUrl.path,this._controller=new E({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new G({collection:this._collection,forAllFeatures:function(e){return t._forAllFeatures(e,null,1)},forAllFeaturesOfNode:function(e,r){return t._forAllFeaturesOfNode(e,r)}}),this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(e){return t._deleteComponentObject(e)}),this._intersectionHandler=new L.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,forEach:function(e){return t._nodeId2Meta.forEach(function(t){return e(t.node,t.objectHandle)})}}),this._elevationProvider=new B({layerView:this,intersectionHandler:this._intersectionHandler}),this.updatingHandles.add(this,"view.clippingArea",function(){return t._clippingAreaChanged()},2),this.updatingHandles.add(this,"fullOpacity",function(e){return t._opacityChange(e)}),this.updatingHandles.add(this,"slicePlaneEnabled",function(e){return t._slicePlaneEnabledChange(e)}),this.updatingHandles.add(this,"elevationOffset",function(e,r){return t._reloadAll(r)}),this.updatingHandles.add(this,"filter",function(){return t._filterChange()},2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",function(){return t._updatePBR()});var i=function(){t._reloadAll(),t._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",i),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",i),this.updatingHandles.add(this,"suspended",function(e){return t._suspendedChange(e)},2),this.updatingHandles.add(this.layer,"labelsVisible",function(){return t._labelsVisibleChange()},2),this.updatingHandles.add(this.layer,"labelingInfo",function(){return t._labelsVisibleChange()},2),this.handles.add(v.init(Q,"I3S_TREE_SHOW_TILES",function(r){if(r&&!t._treeDebugger){var i=t._controller.crsIndex;new Promise(function(t,r){e(["./support/I3STreeDebugger"],t,r)}).then(function(e){var r=e.I3STreeDebugger;!t._treeDebugger&&Q.I3S_TREE_SHOW_TILES&&(t._treeDebugger=new r({lv:t,view:t.view,nodeSR:i}))})}else r||!t._treeDebugger||Q.I3S_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)})),this._cacheKeySuffix=k.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch(function(e){return de.warn("Failed to initialize IndexedDB cache: "+e)}),this._componentColorManager=this._hasSymbolColors?new re.BufferManager(this._stage.renderView.renderingContext):null},s.prototype.destroy=function(){this._clearAddTasks(),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._collection=null,this._stage=null,f.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},s.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequired();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},s.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequired();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},s.prototype.memEstimateGeometryAdded=function(e){var t=this._collection.getObjectMemoryUsageGPU(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},s.prototype.memEstimateGeometryRemoved=function(e){var t=this._collection.getObjectMemoryUsageGPU(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},s.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e)},s.prototype.getUsedMemory=function(){var e=0;return this._nodeId2Meta.forEach(function(t){return e+=t.node.memory}),e},s.prototype.getUnloadedMemory=function(){return this._controller?this._controller.unloadedMemoryEstimate:0},s.prototype.ignoresMemoryFactor=function(){return!1},s.prototype._labelsVisibleChange=function(){var e=this;if(f.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null),V.areLabelsVisible(this.layer)&&this._supportsLabeling){var t=new R.default({view:this.view,layer:this.layer,collection:this._collection});this._nodeId2Meta.forEach(function(r){e._addMetaToLabeler(t,r)}),this._labeler=t}},s.prototype._addMetaToLabeler=function(e,t){var r=this;e.addNodeMeta(t,function(e,t){return r._createAttributes(e,t)})},s.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))},s.prototype.getStats=function(){var e={index:0,nodes:this._nodeId2Meta.size.toString(),"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._cachingEnabled()&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},s.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},s.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},s.prototype.setAttributeData=function(e,t){var r=this,i=this._nodeId2Meta.get(e);i&&(i.attributeInfo=t,i.cachedRendererVersion=this._getInvalidRendererVersion(),i.filteredIds=null,f.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(i,function(e,t){return r._createAttributes(e,t)}),this._updateEngineObject(i))},s.prototype.getLoadedNodeIds=function(){var e=[];return this._nodeId2Meta.forEach(function(t){return e.push(t.node.id)}),e.sort()},s.prototype.getLoadedNodes=function(){var e=new Array;return this._nodeId2Meta.forEach(function(t){return e.push(t.node)}),e},s.prototype.getLoadedNodeIndices=function(e){this._nodeId2Meta.forEach(function(t,r){return e.push(r)})},s.prototype._createTexture=function(e,t,r,i){if(f.isNone(r)||null==r.data)return null;var n,o=r.data,a=r.encoding,s=t.wrapTextures,l=1&r.usage?"opaque"===t.alphaMode?3:4:3,d=!0;if(a===k.DDS_ENCODING_STRING)n=te.DDS_ENCODING;else{var u=o;d=p.isPowerOfTwo(u.width)&&p.isPowerOfTwo(u.height)}var c=i,h=(c?this._enableAtlasMipMaps:this._enableMipMaps)&&d,g=c||!s,_=c&&h&&this._disableAtlasAnisotropy,m=g?{s:33071,t:33071}:{s:10497,t:10497},y={mipmap:h,wrap:m,disableAnisotropy:_,encoding:n,noUnpackFlip:!0,components:l},b=new te(o,e.id+"/"+r.id,y);return this._stage.add(4,b),e.memory+=this.memEstimateTextureAdded(b),b},s.prototype._getVertexBufferLayout=function(e,t){var r=e.params.material,i={hasTexture:ne(r),hasNormals:null!=t.vertexAttributes.normal,hasRegions:null!=t.vertexAttributes.uvRegion};return Z.glLayout($.createVertexBufferLayout(this._getGeometryParameters(i)))},s.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},s.prototype._findGraphicNodeAndIndex=function(e){var t=K.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return c.someMap(this._nodeId2Meta,function(e){var i=e.featureIds.indexOf(t);return-1!==i&&(r={node:e.node,index:i},!0)}),r},s.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.index);if(!r)return[];for(var i=[],n=this._getObjectIdField(),o=0,a=t;o<a.length;o++){var s=a[o],l=K.attributeLookup(s.attributes,n),d=r.featureIds.indexOf(l);-1!==d&&i.push(d)}return i},s.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return g.reject();var r=this._nodeId2Meta.get(t.node.index).objectHandle,i=U.boundingBoxCornerPoints(t.index,this._collection,r,new Float64Array(24)),n=this.view.renderSpatialReference,o=this.view.spatialReference;if(Y.bufferToBuffer(i,n,0,i,o,0,8)){var a=T.empty();return T.expandWithBuffer(a,i,0,8),g.resolve({boundingBox:a,screenSpaceObjects:[]})}},s.prototype.whenGraphicAttributes=function(e,t){var r=this,i=function(e){for(var t=new Map,i=[],n=0,o=e;n<o.length;n++){var a=o[n],s=r._findGraphicNodeAndIndex(a),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},i.push(l)),l.indices.push(s.index),l.graphics.push(a)}return i};return k.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,i,{populateObjectId:!0})},s.prototype.getGraphicFromIntersectorMetadata=function(e){if(null==e.nodeIndex||null==e.componentIndex)return null;var t=this._nodeId2Meta.get(e.nodeIndex);return null==t||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)},s.prototype._getCacheKey=function(e){return this._layerUrl+"/v9/"+e.id+this._cacheKeySuffix},s.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},s.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},s.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.index))},s.prototype.loadMissingTextures=function(e,t,r,i){var n=this,o=e.filter(function(e,r){if(0==(e.usage&n.rendererTextureUsage))return!1;if(f.isNone(t))return!0;var i=k.selectEncoding(e.encodings,n.useCompressedTextures),o=t[r];return!!(f.isNone(o)||null==o.data||i&&o.encoding!==i.encoding)});return 0===o.length?g.resolve(!1):r(o,i).then(function(r){for(var i=0,n=0;n<e.length;n++)i<r.length&&r[i].id===e[n].id&&(t[n]=r[i],i++);return!0})},s.prototype.loadCachedNodeData=function(e,t,r){var i=this;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e),t).then(function(n){return null==n?null:n.nodeVersion!==e.version?(i._idbCache.remove(i._getCacheKey(e)),null):(e.obb||(e.obb=X.clone(n.nodeObb),e.isComputedObb=!0,i._controller.updateVisibility(e.index)),i.loadMissingTextures(n.requiredTextures,n.textureData,r,t).then(function(r){return r&&i._idbCache.initialized&&f.isSome(n.textureData)&&(n.byteSize=se(n.transformedGeometries,n.textureData),n.textureData.every(ae)&&le(e,n)&&i._idbCache.put(i._getCacheKey(e),n).catch(function(t){return de.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)})),g.throwIfAborted(t),n}))}):g.resolve(null)},s.prototype.addNodeData=function(e,t){var i=this;return 0===t.allGeometryData.length||0===t.allGeometryData[0].geometries.length?g.resolve():(1!==t.allGeometryData.length&&de.warn("Node with",t.allGeometryData.length,"geometries is unsupported"),this._addData(e,t.attributeDataInfo,function(){return i._transformNode(e,t).then(function(t){return i._controller.reschedule(e.index,t)}).then(function(n){e.obb||(e.obb=n.obb,e.isComputedObb=!0,i._controller.updateVisibility(e.index)),t.allGeometryData[0].componentOffsets=n.componentOffsets,n.featureIds&&(t.allGeometryData[0].featureIds=Array.prototype.slice.call(n.featureIds));var o={geometryData:t.allGeometryData[0],transformedGeometries:n.transformedGeometries,requiredTextures:t.requiredTextures,textureData:t.textureData,nodeVersion:e.version,nodeObb:e.obb,byteSize:i._cachingEnabled()?se(n.transformedGeometries,t.textureData):0};if(le(e,o)&&i._idbCache.initialized){var a=f.isSome(o.textureData)?o.textureData.map(function(e){return ae(e)?e:null}):null;i._idbCache.put(i._getCacheKey(e),r({},o,{textureData:a})).catch(function(t){return de.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return i._addCachedNodeData(e,o)})}))},s.prototype._transformNode=function(e,t){for(var r=this,i=t.allGeometryData[0].geometries,n=new Array(i.length),o=0;o<i.length;++o)n[o]=this._getVertexBufferLayout(i[o],t.geometryIndex);var a={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData[0],geometryIndex:t.geometryIndex,layouts:n,mbs:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",a,{transferList:[t.geometryBuffer]}):H.ensureDracoDecoder(a).then(function(){return r._controller.reschedule(e.index,a).then(function(e){return r._worker.transform(e)})})},s.prototype.addCachedGPUData=function(e,t,r){if(!this._controller.isGeometryVisible(e)){var i=this._controller.indexDepth-e.level;return void this._memCache.put(this._getMemCacheKey(e.index),t,e.memory,i)}f.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,t),this._addNodeMeta(e.index,t),this.updateNodeStatus(e.index,r),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._updateEngineObject(t),this._highlights.objectCreated(t),this._treeDebugger&&this._treeDebugger.update()},s.prototype.addCachedNodeData=function(e,t,r){var i=this;return this._addData(e,r,function(){return i._addCachedNodeData(e,t)})},s.prototype._addCachedNodeData=function(e,t){var r=this;if(this.suspended||!this._controller.isGeometryVisible(e))return g.resolve();var i=t.geometryData,n=t.transformedGeometries,o=f.isSome(t.textureData)?t.textureData.filter(function(e){return f.isSome(e)&&0!=(e.usage&r.rendererTextureUsage)}):null;e.memory=0;var a=i.componentOffsets,s=i.geometries,l=i.featureIds,d=null,u=null;if(this._hasSymbolColors){d=this._componentColorManager.getBuffer(l.length),u=new Uint16Array(l.length);for(var c=0;c<l.length;c++)u[c]=d.acquireIndex()}var h=this._collection,p=s[0],_=n[0],m=this._materialParameters(p,_.layout),y=a||new Uint16Array([0,_.indices?_.indices.length:_.interleavedVertexData.byteLength/_.layout[0].stride]),b={vertices:{data:_.interleavedVertexData,count:_.interleavedVertexData.byteLength/_.layout[0].stride,layoutParameters:m.geometryParams},positionData:{positions:_.positionData.data,indices:_.positionData.indices},indices:_.indices,primitiveType:4,componentOffsets:y},v=p.transformation?w.mat4f64.clone(p.transformation):w.mat4f64.create();M.mat4.multiply(v,_.corMatrices.globalTrafo,v);var x=M.mat4.getTranslation(O.vec3f64.create(),v),I=C.mat3.fromMat4(S.mat3f32.create(),v),D=h.createObject({geometry:b,obb:e.renderObb,transform:{position:x,rotationScale:I},visible:!1}),T=f.isSome(o)?o.map(function(t){return r._createTexture(e,m.material,t,2===m.geometryParams.textureCoordinates)}):[];this._configureMaterial(D,p.params.material,T,o),e.memory+=this.memEstimateGeometryAdded(D);var E=this._addTasks.get(e.index),V=new ce;V.node=e,V.featureIds=l,V.objectHandle=D,V.cachedRendererVersion=this._getInvalidRendererVersion(),V.attributeInfo=E.attributeInfo,V.material={alphaMode:p.params.material.alphaMode,isSchematic:p.params.material.isSchematic},V.textures=T,E.meta=V,!this._hasTextures&&t.requiredTextures.some(function(e){return 0!=(19&e.usage)})&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||_.hasColors,this._hasTextures=this._hasTextures||!!e.resources.texture,this.notifyChange("hasTexturesOrVertexColors");var A=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(V).then(function(t){var i=r._addTasks.get(e.index);if(i){if(f.isSome(r._labeler)&&r._addMetaToLabeler(r._labeler,V),r._addNodeMeta(e.index,V),r.suspended)return void r._removeNodeStageData(e.index,r.elevationOffset);h.setObjectVisibility(D,!0),V.attributeInfo=i.attributeInfo;var n=V.cachedRendererVersion!==r._rendererVersion,o=A!==r.slicePlaneEnabled;r._setObjectSymbology(V);var a=r._applyFiltersToNode(V);(n||t&&(o||a))&&r._addOrUpdateEdgeRendering(V),r.visibleGeometryChanged(V),r._highlights.objectCreated(V),r._updateMaterial(V),r._markParentsAsHole(e.index),r._treeDebugger&&r._treeDebugger.update()}})},s.prototype._addNodeMeta=function(e,t){this._nodeId2Meta.has(e)&&(de.error("Removing duplicated node"),this._deleteComponentObject(this._nodeId2Meta.get(e))),this._nodeId2Meta.set(e,t)},s.prototype._materialParameters=function(e,t){var r=e.params.material,i=t.some(function(e){return"uvRegion"===e.name}),n=t.some(function(e){return"normalCompressed"===e.name}),o=ne(r);return{geometryParams:this._getGeometryParameters({hasTexture:o,hasNormals:n,hasRegions:i}),material:r}},s.prototype._configureMaterial=function(e,t,r,i){var n=this,o=this.rendererTextureUsage,a=function(e){return 0!=(e&o)?oe(i,r,e):null};this._collection.updateMaterial(e,function(e){var r=n._isIntegratedMesh,i=t.metallicRoughness.baseColorFactor,o=p.clamp(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[i[0],i[1],i[2],o],e.objectOpacity=n.fullOpacity,e.roughnessFactor=t.metallicRoughness.roughnessFactor,e.metallicFactor=t.metallicRoughness.metallicFactor,e.emissiveFactor=t.emissiveFactor,e.reflectanceFactor=t.isSchematic?.2:.5,e.usePBR=n._usePBR(t.isSchematic),e.isIntegratedMesh=n._isIntegratedMesh;var s=n._stage.renderView.textureRepository,l=a(1);l&&(e.baseColorTexture=new ee.RenderTexture(s,l));var d=a(2);d&&(e.metallicRoughnessTexture=new ee.RenderTexture(s,d));var u=a(16);u&&(e.emissionTexture=new ee.RenderTexture(s,u));var c=a(8);c&&(e.occlusionTexture=new ee.RenderTexture(s,c));var h=a(4);h&&(e.normalTexture=new ee.RenderTexture(s,h)),e.commonMaterialParameters.slicePlaneEnabled=n.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.transparencyHint=null,r?(e.commonMaterialParameters.receiveAmbientOcclusion=!1,e.transparencyHint=!1):n.fullOpacity*o==1&&"blend"!==t.alphaMode?e.transparencyHint=!1:"blend"===t.alphaMode&&(e.transparencyHint=!0)})},s.prototype._getGeometryParameters=function(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}},s.prototype._addData=function(e,t,i){var n=this,o=this._addTasks.get(e.index);return o?o.attributeInfo=t:(o=r({},g.createResolver(),{attributeInfo:t,meta:null}),this._addTasks.set(e.index,o),i().then(o.resolve,o.reject).then(function(){return n._addTasks.delete(e.index)}).catch(function(t){throw n._addTasks.delete(e.index),t})),o.promise},s.prototype._clearAddTasks=function(){var e=this;this._addTasks.forEach(function(t){f.isSome(t.meta)&&e._deleteComponentObject(t.meta)}),this._addTasks.clear()},s.prototype._markParentsAsHole=function(e){if(this._isIntegratedMesh)for(var t=this._controller,r=t.getParentIndex(e);r;r=t.getParentIndex(r))this.updateNodeStatus(r,"hole")},s.prototype._clippingAreaChanged=function(){var e=T.create();Y.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},s.prototype._filterChange=function(){this._applyFilters(!1)},s.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(e){t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e))})},s.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)}),t},s.prototype.addSqlFilter=function(e,t,r,i){var n=this;t&&r&&e.push(function(e,o){return n._sqlFilter(e,o,t,r,i)})},s.prototype._sqlFilter=function(e,t,r,i,n){var o={},a=this._createLayerGraphic(o),s=this.layer.objectIdField,l=t.featureIds,d=t.attributeInfo.attributeData;i.every(function(e){return null!=d[e]||e===s})&&k.filterInPlace(e,l,function(e){o[s]=l[e];for(var t=0,u=i;t<u.length;t++){var c=u[t];c!==s&&(o[c]=k.getCachedAttributeValue(d[c],e))}try{return r.testFeature(a)}catch(e){return n(e),!1}})},s.prototype._boundingboxNodeTest=function(e,t){return Y.mbsToMbs(e.node.mbs,this._controller.crsIndex,me,this.view.renderSpatialReference),k.intersectBoundingBoxWithMbs(t,me)},s.prototype._boundingboxFeatureTest=function(e,t,r){return T.intersects(r,this._collection.getComponentAABB(e.objectHandle,t,pe))},s.prototype._boundingboxFilter=function(e,t,r){var i=this,n=this._collection,o=this._boundingboxNodeTest(t,r);if(3!==o){if(0===o)return void(e.length=0);var a=n.getComponentCount(t.objectHandle);if(a.invisible+a.visible===t.featureIds.length){var s=this._transformAABB(fe,r,t.objectHandle);k.filterInPlace(e,t.featureIds,function(e){return i._boundingboxFeatureTest(t,e,s)})}}},s.prototype._transformAABB=function(e,t,r){var i=this._collection.getObjectTransform(r),n=i.position,o=i.rotationScale;return e[0]=(t[0]-n[0])/o[0],e[1]=(t[1]-n[1])/o[4],e[2]=(t[2]-n[2])/o[8],e[3]=(t[3]-n[0])/o[0],e[4]=(t[4]-n[1])/o[4],e[5]=(t[5]-n[2])/o[8],e},s.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return g.resolve();var r=e.objectHandle,i=this._edgeView.hasObject(r),n=this._extractObjectEdgeMaterials(e),o=n.hasEdges,a=n.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};return o?i?(this._edgeView.updateAllComponentMaterials(r,a,s,t),this._edgeView.updateObjectVisibility(r,!0),g.resolve(!0)):this._collection.addEdges(r,this._edgeView,a,s).then(function(){return!0}):(i&&this._edgeView.removeObject(r),g.resolve(!1))},s.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)},s.prototype._applyFiltersToNode=function(e){return!!this._applyFiltersToNodeComponents(e)&&(f.isSome(this._labeler)&&this._labeler.applyFilterChange(e),!0)},s.prototype._applyFiltersToNodeComponents=function(e){var t=this._collection,r=t.getComponentCount(e.objectHandle),i=0===r.invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!i;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!i;var n=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,n),!0},s.prototype._updateCachedFilteredIds=function(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)},s.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,i=this._filters;r<i.length;r++){if((0,i[r])(t,e),0===t.length)break}return t.length===e.featureIds.length?e.featureIds:t},s.prototype._computeFilteredComponentIndices=function(e){var t=new Array;return e.featureIds.forEach(function(r,i){e.filteredIds[t.length]===r&&t.push(i)}),t},s.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach(function(r,i){return t._removeNodeStageData(i,e)})},s.prototype.removeNodeData=function(e,t){for(var r=this.elevationOffset;e.length>0&&!t.done;){var i=e.pop();this._removeNodeStageData(i,r),t.madeProgress()}},s.prototype._removeNodeStageData=function(e,t){var r=this._nodeId2Meta.get(e);if(r){this._collection.setObjectVisibility(r.objectHandle,!1),this.visibleGeometryChanged(r),this._removeEdgeRendering(r),f.isSome(this._labeler)&&this._labeler.removeNodeMeta(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(r);var i=this._controller.indexDepth-r.node.level+1;this._memCache.put(this._getMemCacheKey(e,t),r,r.node.memory,i),this._treeDebugger&&this._treeDebugger.update()}},s.prototype._deleteComponentObject=function(e){if(this._edgeView&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(var t=0,r=e.textures;t<r.length;t++){var i=r[t];this.memEstimateTextureRemoved(i),this._stage.remove(4,i.id)}},s.prototype.updateNodeStatus=function(e,t){var r=this._nodeId2Meta.get(e);r&&this._collection.updateMaterial(r.objectHandle,function(e){e.polygonOffsetEnabled="hole"===t})},s.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)},s.prototype._rendererChange=function(e){return a(this,void 0,void 0,function(){var t,r,i,n,a,s,l,d,u;return o(this,function(o){switch(o.label){case 0:return this._currentRenderer=e,(this.notifyChange("rendererTextureUsage"),this._rendererVersion=k.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,e)?(t=this,r=k.findFieldsCaseInsensitive,[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,[o.sent(),this.layer.fields]),
o.label=2;case 2:return!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired?(i=this,[4,j.loadArcade()]):[3,4];case 3:i._arcade=o.sent(),o.label=4;case 4:if(e&&"visualVariables"in e&&e.visualVariables)for(n=0,a=e.visualVariables;n<a.length;n++)s=a[n],"color"===s.type?this._colorVariable=s:"opacity"===s.type?this._opacityVariable=s:de.warn("Unsupported visual variable type for 3D Object Scene Services: "+s.type);if(e)for(l=0,d=e.getSymbols();l<d.length;l++)u=d[l],"mesh-3d"!==u.type&&de.error("Symbols of type '"+u.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}})})},s.prototype._getSymbolInfos=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedSymbolInfos},s.prototype._getSymbolColors=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),function(t,r){var i=5*t;D.vec4.set(r.externalColor,e.cachedSymbolColors[i+0]/255,e.cachedSymbolColors[i+1]/255,e.cachedSymbolColors[i+2]/255,e.cachedSymbolColors[i+3]/255),r.externalColorMixMode=3&e.cachedSymbolColors[i+4],r.castShadows=0!=(16&e.cachedSymbolColors[i+4])}},s.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t={},r=this._currentRenderer,i=e.attributeInfo.attributeData,n=null!=e.featureIds?this.layer.objectIdField:null,o=null!=i?this._rendererFields:null;e.cachedSymbolColors||(e.cachedSymbolColors=new Uint8Array(5*e.featureIds.length));for(var a=0,s=0;s<e.featureIds.length;s++){var l=this._tmpAttributeOnlyGraphic;if(l.attributes=t,null!=n&&(t[n]=e.featureIds[s]),null!=o)for(var d=0,u=o;d<u.length;d++){var c=u[d];i[c]&&(t[c]=k.getCachedAttributeValue(i[c],s))}var h=r&&r.getSymbol(l,{arcade:this._arcade}),p=null;h instanceof P&&(this._symbolInfos.has(h.id)||this._symbolInfos.set(h.id,k.getSymbolInfo(h)),p=this._symbolInfos.get(h.id)),e.cachedSymbolInfos[s]=p;var g=null,_=null,m=!0,y=1;if(r&&"visualVariables"in r){if(this._colorVariable){var b=A.getColor(this._colorVariable,l,{color:_e,arcade:this._arcade});b&&(g=ge,g[0]=b.r/255,g[1]=b.g/255,g[2]=b.b/255,this._opacityVariable||null===b.a||(_=b.a))}this._opacityVariable&&(_=A.getOpacity(this._opacityVariable,l,{arcade:this._arcade}))}if(p&&p.material){var v=p.material;g=f.isNone(g)||f.isNone(_)?N.overrideColor(g,_,v.color,v.alpha,ue,ge):N.overrideColor(g,_,null,null,ue,ge),y=J.parseColorMixMode(v.colorMixMode)}m=!p||p.castShadows,e.cachedSymbolColors[a+0]=f.isSome(g)?Math.round(255*g[0]):255,e.cachedSymbolColors[a+1]=f.isSome(g)?Math.round(255*g[1]):255,e.cachedSymbolColors[a+2]=f.isSome(g)?Math.round(255*g[2]):255,e.cachedSymbolColors[a+3]=f.isSome(g)?Math.round(255*g[3]):255,e.cachedSymbolColors[a+4]=y|+m<<4,a+=5}}},s.prototype._extractObjectEdgeMaterials=function(e){var t=e.objectHandle,r=e.featureIds?e.featureIds.length:1,i=new Array(r),n=z.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),o={opacity:this.fullOpacity,objectTransparency:2};this._collection.updateMaterial(t,function(e){o.objectTransparency=e.hasVisibleComponents?e.hasTransparency?1:2:0});for(var a=!1,s=null,l=null,d=this._getSymbolInfos(e),u=0;u<r;u++)i[u]=n;return this._collection.forEachVisibleComponent(t,function(e){var t=d[e];return!t||(l!==t&&(l=t,(s=z.createMaterialFromEdges(t.edges,o))&&(a=!0)),i[e]=f.isSome(s)?s:n,!0)}),{hasEdges:a,perFeatureEdgeMaterials:i}},s.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors){var t=e.objectHandle,r=this._getSymbolColors(e);this._collection.setComponentData(t,r),this._stage.renderView.setNeedsRender(),this._updateEdgeRendering(e)}},s.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},s.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(r){t._collection.updateMaterial(r.objectHandle,function(i){return t._updateMaterialOpacity(i,r.material,e)}),t._updateEdgeRendering(r)})},s.prototype._updateMaterial=function(e){var t=this;this._collection.updateMaterial(e.objectHandle,function(r){r.commonMaterialParameters.slicePlaneEnabled=t.slicePlaneEnabled,r.usePBR=t._usePBR(e.material.isSchematic),t._updateMaterialOpacity(r,e.material,t.fullOpacity)})},s.prototype._updateMaterialOpacity=function(e,t,r){e.objectOpacity=r,this._isIntegratedMesh||"blend"===t.alphaMode||(e.transparencyHint=r*e.baseColor[3]!=1&&null)},s.prototype._updateEngineObject=function(e){this._setObjectSymbology(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e)},s.prototype._slicePlaneEnabledChange=function(e){var t=this;this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),f.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach(function(r){t._collection.updateMaterial(r.objectHandle,function(t){t.commonMaterialParameters.slicePlaneEnabled=e}),t._updateEdgeRendering(r,!1)})},s.prototype._updatePBR=function(){var e=this;this._nodeId2Meta.forEach(function(t){e._collection.updateMaterial(t.objectHandle,function(r){r.usePBR=e._usePBR(t.material.isSchematic)})})},s.prototype._usePBR=function(e){return!this._isIntegratedMesh&&(!e||this.view.qualitySettings.physicallyBasedRenderingEnabled)},s.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)},s.prototype._forAllFeatures=function(e,t,r){var i=this;void 0===r&&(r=0),c.someMap(this._nodeId2Meta,function(n){if(f.isSome(t)){switch(t(n)){case 0:return!0;case 2:return!1}}var o=1;switch(r){case 1:o=i._forAllFeaturesOfNode(n,e);break;case 0:o=i._forVisibleFeaturesOfNode(n,e);break;case 2:o=i._forAllFeaturesOfNodeInClippingArea(n,e)}return 0===o})},s.prototype._forAllFeaturesOfNode=function(e,t){for(var r=1,i=e.featureIds,n=0;n<i.length;n++)if(0===(r=t(i[n],n,e)))return r;return r},s.prototype._forVisibleFeaturesOfNode=function(e,t){var r=1,i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,function(n){return 1===(r=t(i[n],n,e))}),r},s.prototype._forAllFeaturesOfNodeInClippingArea=function(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);var r=this._boundingboxNodeTest(e,this._clippingArea);if(0===r)return 1;if(3===r)return this._forAllFeaturesOfNode(e,t);for(var i=e.featureIds,n=e.objectHandle,o=k.getClipAABB(this._clippingArea,this._collection.getObjectTransform(n)),a=0;a<i.length;a++)if(this._boundingboxFeatureTest(e,a,o)){var s=t(i[a],a,e);if(0===s)return s}return 1},s.prototype._createAttributes=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var i=t.attributeInfo.attributeData;if(null!=i)for(var n=0,o=Object.keys(i);n<o.length;n++){var a=o[n];r[a]=k.getCachedAttributeValue(i[a],e)}return r},s.prototype._createGraphic=function(e,t){return this._createLayerGraphic(this._createAttributes(e,t))},s.prototype.highlight=function(e,t){var r=this;void 0===t&&(t={});var i=this._highlights;if("number"==typeof e?e=[e]:e instanceof l?e=[e]:e instanceof d&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof l){var n=e,o=n.map(function(e){return K.attributeLookup(e.attributes,r._getObjectIdField())}),a=i.acquireSet(t),s=a.set,u=a.handle;return i.setFeatureIds(s,o),u}if("number"==typeof e[0]){var o=e,c=i.acquireSet(t),s=c.set,u=c.handle;return i.setFeatureIds(s,o),u}}return ye},s.prototype.visibleGeometryChanged=function(e){var t=this;this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=m.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null})))},s.prototype.test=function(){var e=this;return{controller:this._controller,get visibleObjectIds(){var t=[];return e._forAllFeatures(function(e){return t.push(e),1},null,0),t.sort(function(e,t){return e-t}),t},get numNodes(){return e._nodeId2Meta.size}}},n([I.property()],s.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),n([I.property()],s.prototype,"view",void 0),n([I.property()],s.prototype,"layer",void 0),n([I.property()],s.prototype,"_controller",void 0),n([I.property()],s.prototype,"_labeler",void 0),n([I.property({dependsOn:["updatingMeshView3D"]})],s.prototype,"updating",void 0),n([I.property({dependsOn:["_controller.updating","_visibleGeometryChangedSchedulerHandle","_labeler.updating"]})],s.prototype,"updatingMeshView3D",null),n([I.property({dependsOn:["_controller.rootNodeVisible"]})],s.prototype,"suspended",void 0),n([I.property(W.updatingProgress)],s.prototype,"updatingProgress",void 0),n([I.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],s.prototype,"updatingProgressValue",void 0),n([I.property({readOnly:!0})],s.prototype,"hasTexturesOrVertexColors",null),n([I.property({readOnly:!0})],s.prototype,"rendererTextureUsage",null),n([I.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],s.prototype,"elevationOffset",null),n([I.property({type:Boolean})],s.prototype,"slicePlaneEnabled",void 0),n([I.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],s.prototype,"uncompressedTextureDownsamplingEnabled",null),n([I.property({dependsOn:["layer.version"]})],s.prototype,"useCompressedTextures",null),s=n([I.subclass("esri.views.3d.layers.I3SMeshView3D")],s)}(I.declared(t))};var pe=T.create(),fe=T.create(),ge=[0,0,0,0],_e=new s([0,0,0,0]),me=[0,0,0,0],ye={remove:function(){},pause:function(){},resume:function(){}}});