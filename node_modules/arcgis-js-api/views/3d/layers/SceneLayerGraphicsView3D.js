// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/assignHelper","../../../Graphic","../../../core/arrayUtils","../../../core/iteratorUtils","../../../core/Logger","../../../core/maybe","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/contains","../../../layers/graphics/dehydratedFeatures","../../../layers/graphics/controllers/I3SOnDemandController","../../../layers/support/fieldUtils","../../../renderers/support/renderingInfoUtils","../../../tasks/support/Query","./LayerView3D","./graphics/Graphics3DFeatureLikeLayerView","./graphics/Graphics3DVerticalScale","./graphics/QueryEngine","./i3s/I3SUtil","./support/DefinitionExpressionSceneLayerView","./support/fieldProperties","./support/layerViewUpdatingProperties","./support/PopupSceneLayerView","../../3d/support/debugFlags","../support/GraphicsMap","../support/orientedBoundingBox","../support/projectionUtils","../../layers/LayerView","../../layers/support/FeatureFilter","../../support/Scheduler","@dojo/framework/shim/Promise"],function(e,t,r,i,o,n,a,s,d,u,p,l,c,h,g,y,f,v,_,b,m,x,E,S,I,D,F,w,O,C,A,N,T,G,R,V,M,L,U,q){function j(e,t){for(var r=0;r<e.length;r++)for(var i=e[r],o=0,n=i.graphics;o<n.length;o++){var a=n[o];if(a.attributes||(a.attributes={}),t&&t.loadedAttributes)for(var s=0,d=t.loadedAttributes;s<d.length;s++){var u=d[s].name;t.attributeData[u]&&(a.attributes[u]=O.getCachedAttributeValue(t.attributeData[u],r))}}}function P(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}var H=p.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),Q=A.defineFieldProperties(),B=function(t){function p(e){var r=t.call(this,e)||this;return r._nodesAddedToStage=new Map,r.overlayUpdating=!1,r.supportsDraping=!0,r._queryEngine=null,r._memCache=null,r.loadedGraphics=new R.GraphicsMap,r.progressiveLoadFactor=1,r.supportsHeightUnitConversion=!0,r._coordinatesOutsideExtentErrors=0,r._maxCoordinatesOutsideExtentErrors=20,r}return r(p,t),p.prototype.initialize=function(){var t=this;O.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);for(var r=0,i=["layer.renderer","layer.labelingInfo","layer.labelsVisible","definitionExpressionFields","filter"];r<i.length;r++){var o=i[r];this.updatingHandles.add(this,o,function(){return t._updateRequiredFields()})}this.updatingHandles.add(this.layer,"rangeInfos",function(e){return t._rangeInfosChanged(e)},2),this.updatingHandles.add(this.layer,"renderer",function(e,r){return t._rendererChange(e,r)}),this.updatingHandles.add(this,"layer.objectIdFilter",function(){return t._filterChange()}),this.updatingHandles.add(this,"parsedDefinitionExpression",function(){return t._filterChange()}),this.handles.add(h.init(G,"I3S_TREE_SHOW_TILES",function(r){if(r&&!t._treeDebugger){var i=t._controller.crsIndex;new Promise(function(t,r){e(["./support/I3STreeDebugger"],t,r)}).then(function(e){var r=e.I3STreeDebugger;!t._treeDebugger&&G.I3S_TREE_SHOW_TILES&&(t._treeDebugger=new r({lv:t,view:t.view,nodeSR:i}))})}else r||!t._treeDebugger||G.I3S_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)})),this._updateRequiredFields(),this._set("graphics3d",new D({owner:this,layer:this.layer,preferredUpdatePolicy:1,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:this.layer.fullExtent,updateClippingExtent:function(e){return t._updateClippingExtent(e)}})),this.graphics3d.elevationAlignment&&this.graphics3d.elevationAlignment.events.on("invalidate-elevation",function(e){return t._invalidateElevation(e.extent,e.spatialReference)}),this.supportsHeightUnitConversion&&(this._verticalScale=new F({sourceSpatialReference:this.layer.spatialReference,destSpatialReference:this.view.spatialReference})),this.addResolvingPromise(this.graphics3d.setup()),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid),this._controller=new m({layerView:this,scaleVisibilityEnabled:!1}),this.when(function(){t._queryEngine=new w.default({layerView:t,task:q.Task.FEATURE_QUERY_ENGINE}),t.updatingHandles.add(t,"maximumNumberOfFeatures",function(e){return t._controller.featureTarget=e},2),t.updatingHandles.add(t,"suspended",function(e){e&&t._removeAllNodeData()})})},p.prototype.destroy=function(){this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this.graphics3d&&(this.graphics3d.destroy(),this._set("graphics3d",null)),this._controller&&(this._controller.destroy(),this._controller=null),this._queryEngine&&(this._queryEngine.destroy(),this._queryEngine=null),this._memCache.destroy(),this._memCache=null,this._nodesAddedToStage=null},Object.defineProperty(p.prototype,"maximumNumberOfFeatures",{get:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return e?e.maximumNumberOfFeatures:0},set:function(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!this.suspended&&(!!this._controller&&!this._controller.leafsReached)},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,"hasM",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(p.prototype,"hasZ",{get:function(){return!0},enumerable:!0,configurable:!0}),p.prototype.whenGraphicAttributes=function(e,t){return n(this,void 0,void 0,function(){var r,i=this;return o(this,function(o){return r=function(e){for(var t=new Map,r=[],o=0,n=e;o<n.length;o++){var a=n[o],s=i._findGraphicNodeAndIndex(a),d=t.get(s.node);d||(d={node:s.node,indices:[],graphics:[]},r.push(d)),d.indices.push(s.index),d.graphics.push(a)}return r},[2,O.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,r,{populateObjectId:!0})]})})},p.prototype.getGraphicFromGraphicUid=function(e){if(!this.loadedGraphics)return null;var t=b.hydrateGraphic(this.loadedGraphics.find(function(t){return t.uid===e}),this.layer),r=this._getObjectIdField();return t&&t.attributes&&t.attributes[r]?(t.layer=this.layer,t.sourceLayer=this.layer,t):null},p.prototype.whenGraphicBounds=function(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)},p.prototype.computeAttachmentOrigin=function(e,t){return this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t)},p.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},p.prototype.isUpdating=function(){return this.overlayUpdating||this._controller&&this._controller.updating||this.graphics3d&&this.graphics3d.updating},p.prototype.getRenderingInfo=function(e,t,r){var i=E.getRenderingInfo(e,{renderer:t,arcade:r});if(i&&i.color){var o=i.color;o[0]=o[0]/255,o[1]=o[1]/255,o[2]=o[2]/255}return i},p.prototype.getRenderingInfoAsync=function(e,t,r,i){return n(this,void 0,void 0,function(){return o(this,function(o){return[2,E.getRenderingInfoAsync(e,a({renderer:t,arcade:r},i))]})})},Object.defineProperty(p.prototype,"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0}),p.prototype._findGraphicNodeAndIndex=function(e){for(var t=e.attributes[this.layer.objectIdField],r=0,i=d.keysOfMap(this._nodesAddedToStage);r<i.length;r++){var o=i[r],n=this._nodesAddedToStage.get(o),a=this._findGraphicIndex(n.bundle,t);if(a>=0)return{node:n.node,index:a}}return null},p.prototype._findGraphicIndex=function(e,t){for(var r=0;r<e.length;r++)for(var i=0,o=e[r].featureIds;i<o.length;i++){var n=o[i];if(n===t)return r}return-1},p.prototype.highlight=function(e,t){return void 0===t&&(t={}),this.graphics3d.highlight(e,t,this.layer.objectIdField)},p.prototype.addNodeData=function(e,t){if(this._nodesAddedToStage.has(e.index))return void H.error("I3S node "+e.id+" already added");for(var r=t.allGeometryData,i=t.attributeDataInfo,o=this._controller.crsIndex,n=this._controller.crsVertex,a=this.view.spatialReference,d=[0,0,0],u=this._getObjectIdField(),p=[],h=this.layer.fullExtent&&P(this.layer.fullExtent.clone(),.5),g=[],y=[],f=0;f<r.length;f++){var v=r[f],m=v.featureDataPosition,x=m.length,E=v.geometries||[k[x]],S=v.featureIds;h&&!_.extentContainsCoords3D(h,m)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&H.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&H.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var I=0;I<E.length;I++){var D=E[I];if("points"===D.params.type){var F=[],w=I<S.length?I:0,O=S[w],C={};null!=O&&(C[u]=O);var A=null==O?s.generateUID():O,N=void 0;"Embedded"===D.type&&(N=D.params.vertexAttributes.position);for(var T=0;T<N.length;T+=x){for(var G=0;G<x;G++)d[G]=m[G]+N[T+G];var R=3===x;e.obb||y.push(d[0],d[1],R?d[2]:0),M.bufferToBuffer(d,n,0,z,a,0,1);var L=b.makeDehydratedPoint(z[0],z[1],R?z[2]:void 0,a),U=A,q=this.loadedGraphics.get(U);l.isSome(q)?F.push(q):F.push({objectId:A,uid:s.generateUID(),geometry:L,attributes:C,visible:!0})}g.push.apply(g,F),p.push({featureIds:v.featureIds,graphics:F})}}}e.numFeatures=g.length,this._updateNodeMemory(e);var Q={bundle:p,attributeInfo:i,node:e};if(j(Q.bundle,Q.attributeInfo),y.length>0){var B=o.isGeographic?this.view.renderSpatialReference:o;M.bufferToBuffer(y,n,0,y,B,0,y.length/3);var K={data:y,size:3,offsetIdx:0,strideIdx:3};e.obb=V.compute(K),o.isGeographic&&M.vectorToVector(e.obb.center,B,e.obb.center,o),this._controller.updateVisibility(e.index)}return this._controller.isGeometryVisible(e)?(this._verticalScale&&this._verticalScale.adjust(g),this._nodesAddedToStage.set(e.index,Q),this.loadedGraphics.addManyAndDeduplicate(g),this._filterNode(Q),this._treeDebugger&&this._treeDebugger.update(),c.resolve()):(this._cacheNodeData(Q),c.resolve())},p.prototype.isNodeLoaded=function(e){return this._nodesAddedToStage.has(e)},p.prototype._updateNodeMemory=function(e){e.memory=4096+e.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic},p.prototype._cacheNodeData=function(e){var t=e.bundle.reduce(function(e,t){return t.graphics.reduce(function(e,t){return b.estimateSize(t)+e},512+8*t.featureIds.length+e)},1024);this._memCache.put(this._getMemCacheKey(e.node),e,t)},p.prototype._getMemCacheKey=function(e){return""+e.index},p.prototype._removeAllNodeData=function(){var e=this;this._nodesAddedToStage.forEach(function(t){if(t){var r=t.node;e._updateNodeMemory(r),e._cacheNodeData(t)}}),this._nodesAddedToStage.clear(),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()},p.prototype.removeNodeData=function(e,t){for(;e.length>0&&!t.done;){var r=e.pop(),i=this._removeNodeStageData(r);i&&(this._updateNodeMemory(i.node),this._cacheNodeData(i)),t.madeProgress()}},p.prototype._removeNodeStageData=function(e){var t=this._nodesAddedToStage.get(e);if(!t)return null;for(var r=0,i=t.bundle;r<i.length;r++){var o=i[r];this.loadedGraphics.removeMany(o.graphics)}return this._nodesAddedToStage.delete(e),this._treeDebugger&&this._treeDebugger.update(),t},p.prototype.loadCachedNodeData=function(e){return c.resolve(this._memCache.pop(this._getMemCacheKey(e)))},p.prototype.addCachedNodeData=function(e,t,r){if(this._nodesAddedToStage.has(e.index))return void H.error("I3S node "+e.id+" already added");for(var i=0,o=t.bundle;i<o.length;i++){var n=o[i];this.loadedGraphics.addManyAndDeduplicate(n.graphics)}return this._nodesAddedToStage.set(e.index,t),this._updateNodeMemory(e),this.setAttributeData(e.index,r),this._filterNode(t),this._treeDebugger&&this._treeDebugger.update(),c.resolve()},p.prototype.getLoadedNodeIds=function(){var e=[];return this._nodesAddedToStage.forEach(function(t){return e.push(t.node.id)}),e.sort()},p.prototype.getLoadedNodes=function(){var e=new Array;return this._nodesAddedToStage.forEach(function(t){return e.push(t.node)}),e},p.prototype.getLoadedNodeIndices=function(e){this._nodesAddedToStage.forEach(function(t,r){return e.push(r)})},p.prototype.getLoadedAttributes=function(e){var t=this._nodesAddedToStage.get(e);if(t&&t.attributeInfo)return t.attributeInfo.loadedAttributes},p.prototype.getAttributeData=function(e){var t=this._nodesAddedToStage.get(e);if(t&&t.attributeInfo)return t.attributeInfo.attributeData},p.prototype.setAttributeData=function(e,t){var r=this._nodesAddedToStage.get(e);if(r&&(r.attributeInfo=t,j(r.bundle,t),this._filterNode(r),this.graphics3d.graphicsCore.labelsEnabled)){var i=r.bundle.map(function(e){return e.graphics.length&&e.graphics[0].uid});this.graphics3d.graphicsCore.updateLabelingInfo(i)}},p.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},p.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},p.prototype._rendererChange=function(e,t){return n(this,void 0,void 0,function(){var r,i,n,a;return o(this,function(o){switch(o.label){case 0:return r=this.layer.fields,i=new Set,e?[4,e.collectRequiredFields(i,r)]:[3,2];case 1:return o.sent(),n=u.valuesOfSet(i).sort(),[3,3];case 2:n=[],o.label=3;case 3:return i.clear(),t?[4,t.collectRequiredFields(i,r)]:[3,5];case 4:return o.sent(),a=u.valuesOfSet(i).sort(),[3,6];case 5:a=[],o.label=6;case 6:return n.length===a.length&&n.every(function(e,t){return n[t]===a[t]})?[2]:(this._reloadAllNodes(),[2])}})})},p.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&H.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},p.prototype._filterChange=function(){var e=this;this._nodesAddedToStage.forEach(function(t){return e._filterNode(t)})},p.prototype._reloadAllNodes=function(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()},p.prototype._filterNode=function(e){var t=this._getObjectIdField(),r=null;if(this.layer.objectIdFilter){var i=this.layer.objectIdFilter.ids,o="include"===this.layer.objectIdFilter.method;r=function(e){return i.indexOf(e)>=0===o}}for(var n=this.parsedDefinitionExpression,a=0,s=e.bundle;a<s.length;a++)for(var d=s[a],u=0,p=d.graphics;u<p.length;u++){var l=p[u],c=l.visible;r&&!r(l.attributes[t])?l.visible=!1:l.visible=!n||this._evaluateClause(n,l),c!==l.visible&&(K.graphic=l,K.property="visible",K.oldValue=c,K.newValue=l.visible,this.graphics3d.graphicsCore.graphicUpdateHandler(K))}},p.prototype._updateRequiredFields=function(){return n(this,void 0,void 0,function(){var e,t,r,i,n,a,s,d,p;return o(this,function(o){switch(o.label){case 0:return e=this,t=e.layer,r=e.layer,i=r.fields,n=r.renderer,a=r.labelsVisible,s=e.filter,d=e.definitionExpressionFields,p=new Set,n?[4,n.collectRequiredFields(p,i)]:[3,2];case 1:o.sent(),o.label=2;case 2:return a?[4,x.collectLabelingFields(p,t)]:[3,4];case 3:o.sent(),o.label=4;case 4:return l.isSome(s)?[4,x.collectFilterFields(p,t,s)]:[3,6];case 5:o.sent(),o.label=6;case 6:return x.collectFields(p,i,d),this._set("requiredFields",u.valuesOfSet(p).sort()),[2]}})})},p.prototype._invalidateElevation=function(e,t){var r=this._controller.crsIndex;M.boundingRectToBoundingRect(e,t,Z,r);var i=W;f.fromRect(i,Z),i[2]=-1/0,i[5]=1/0,this._controller.updateElevationChanged(i,r)},p.prototype.createQuery=function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return l.isSome(this.filter)?this.filter.createQuery(e):new S(e)},p.prototype.queryFeatures=function(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),t&&t.signal)},p.prototype.queryObjectIds=function(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),t&&t.signal)},p.prototype.queryFeatureCount=function(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),t&&t.signal)},p.prototype.queryExtent=function(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t&&t.signal)},p.prototype._ensureQuery=function(e){return this._addDefinitionExpressionToQuery(l.isNone(e)?this.createQuery():S.from(e))},p.prototype.getUsedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return e?e.usedMemory:0},p.prototype.getUnloadedMemory=function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(e?e.unprocessedMemoryEstimate:0))},p.prototype.ignoresMemoryFactor=function(){return this._controller&&this._controller.fixedFeatureTarget},p.prototype.getNumberOfNodes=function(){return this._nodesAddedToStage.size},p.prototype.getNumberOfFeatures=function(){return this.loadedGraphics.length},p.prototype.getStats=function(){var e=this.graphics3d.graphicsCore.getStats();return e.nodes=this.getNumberOfNodes(),e.features=this.loadedGraphics.length,this._controller&&this._controller.updateStats(e),e},i([g.property()],p.prototype,"graphics3d",void 0),i([g.property()],p.prototype,"drawingOrder",void 0),i([g.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],p.prototype,"hasDraped",void 0),i([g.property({type:Boolean})],p.prototype,"overlayUpdating",void 0),i([g.property({type:Boolean})],p.prototype,"supportsDraping",void 0),i([g.property({type:U})],p.prototype,"filter",void 0),i([g.property()],p.prototype,"loadedGraphics",void 0),i([g.property()],p.prototype,"layer",void 0),i([g.property()],p.prototype,"_controller",void 0),i([g.property({dependsOn:["_controller.updating","graphics3d.updating","overlayUpdating"]})],p.prototype,"updating",void 0),i([g.property({dependsOn:["_controller.rootNodeVisible"]})],p.prototype,"suspended",void 0),i([g.property(N.updatingProgress)],p.prototype,"updatingProgress",void 0),i([g.property({aliasOf:"_controller.updatingProgress"})],p.prototype,"updatingProgressValue",void 0),i([g.property(Q.requiredFields)],p.prototype,"requiredFields",void 0),i([g.property(Q.availableFields)],p.prototype,"availableFields",void 0),i([g.property({type:Number,dependsOn:["graphics3d.graphicsCore.displayFeatureLimit"]})],p.prototype,"maximumNumberOfFeatures",null),i([g.property({readOnly:!0,dependsOn:["suspended","_controller.leafsReached"]})],p.prototype,"maximumNumberOfFeaturesExceeded",null),i([g.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],p.prototype,"lodFactor",void 0),i([g.property({readOnly:!0})],p.prototype,"hasM",null),i([g.property({readOnly:!0})],p.prototype,"hasZ",null),p=i([g.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],p)}(g.declared(C.DefinitionExpressionSceneLayerView(T.PopupSceneLayerView(I.LayerView3D(L))))),k={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},z=y.vec3f64.create(),K={graphic:null,property:null,oldValue:null,newValue:null},W=f.create(),Z=v.create();return B});