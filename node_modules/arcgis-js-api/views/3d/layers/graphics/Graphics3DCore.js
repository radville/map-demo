// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../geometry","../../../../renderers","../../../../symbols","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/compilerUtils","../../../../core/Error","../../../../core/Handles","../../../../core/iteratorUtils","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/scheduling","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../core/accessorSupport/diffUtils","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/Layer","../../../../layers/graphics/dehydratedFeatures","../../../../renderers/support/rendererConversion","../../../../support/arcadeOnDemand","../../../../symbols/support/defaults3D","../../../../symbols/support/symbolConversion","./ElevationQuery","./featureExpressionInfoUtils","./Graphics3DFeatureStore","./Graphics3DGraphic","./Graphics3DSymbolCreationContext","./Graphics3DSymbolFactory","./Graphics3DWebStyleSymbol","./graphicUtils","./SpatialIndex2D","./symbolComplexity","../support/StageLayerElevationProvider","../../support/projectionUtils","../../support/PropertiesPool","../../webgl-engine/lib/GridLocalOriginFactory","../../webgl-engine/lib/Layer","../../../support/index"],function(e,t,i,r,n,a,o,s,l,h,p,d,c,y,u,g,m,b,f,v,C,S,w,G,x,P,D,R,_,E,I,O,U,L,V,A,F,M,z,B,W,j,T,q,H,N,k,Z,Q,J,K){var X=new o.Point,Y=D.vec3f64.create(),$=R.create(),ee=g.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),te=function(e){function t(t){var i=e.call(this,t)||this;return i.propertiesPool=new Z.PropertiesPool({computedExtent:o.Extent},i),i.computedExtent=null,i.currentRenderer=null,i.rendererHasGeometryOperations=!1,i.symbolCreationContext=new B.Graphics3DSymbolCreationContext,i.graphics3DGraphics=new Map,i.stageLayer=null,i.stage=null,i.graphicsDrapedUids=new Set,i.graphicsBySymbol=new Map,i.symbolConversionCache=new Map,i.symbols=new Map,i.graphicsWithoutSymbol=new Map,i.graphicsWaitingForSymbol=new Set,i.handles=new y,i.suspendSymbolCleanup=!1,i._spatialReference=null,i.arcadeOnDemand=null,i.rendererChangeAbortController=null,i.elevationInfoChangeAbortController=null,i.elevationAlignment=null,i.scaleVisibility=null,i.filterVisibility=null,i._spatialIndex=null,i._updatingPendingLoadedGraphicsChange=null,i.featureStore=null,i.deconflictor=null,i.labeler=null,i.highlights=null,i.viewElevationProvider=null,i.stageLayerElevationProvider=null,i.sharedSymbolResourcesOwnerHandle=null,i.whenGraphics3DGraphicRequests={},i.pendingUpdates=new Map,i.numberOfGraphics=0,i.numberOfGraphicsProvidingElevation=0,i.pendingAdds=0,i.pendingRemoves=0,i.pendingUpdatesPool=new v({allocator:function(e){return e||{add:null,renderingInfo:null,abortController:null,state:0,remove:null}},deallocator:function(e){return e.add=null,e.renderingInfo=null,e.remove=null,e.state=0,e.abortController=null,e}}),i.symbolWarningLogged=!1,i.geometryWarningLogged=!1,i.objectIdInvisibleSet=new Set,i._whenSymbolRemoved=new v,i.preferredUpdatePolicy=0,i._asyncUpdates=!1,i.elevationFeatureExpressionEnabled=!0,i.owner=null,i.layer=null,i.hasDraped=!1,i.graphicSymbolSupported=!0,i.getRenderingInfoWithoutRenderer=!1,i.hasZ=null,i.hasM=null,i._usedMemory=0,i._visible=void 0,i._startCreateGraphics=!1,i.maxPendingUpdates=0,i}i(t,e),h=t,Object.defineProperty(t.prototype,"spatialIndex",{get:function(){if(!this._spatialIndex){this._spatialIndex=new q.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM});var e=0,t=new Array(this.graphics3DGraphics.size);this.graphics3DGraphics.forEach(function(i){return t[e++]=i}),this._spatialIndex.addMany(t)}return this._spatialIndex},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"asyncUpdates",{get:function(){return this._asyncUpdates},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsWaitingForSymbol.size>0||this.needsUpdate()||this.elevationAlignment&&this.elevationAlignment.updating||this.scaleVisibility&&this.scaleVisibility.updating||this.filterVisibility&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingRemaining",{get:function(){return this.updating?this.pendingUpdates.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingTotal",{get:function(){return this.updating?this.maxPendingUpdates:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayFeatureLimit",{get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,n=this.maxSymbolComplexity,a=Math.max(t,Math.min(i,Math.ceil(r/Math.max(1,n?n.primitivesPerFeature:1)))),o=this._get("displayFeatureLimit");return o&&o.minimumTotalNumberOfFeatures===t&&o.maximumTotalNumberOfFeatures===i&&o.maximumTotalNumberOfPrimitives===r&&o.maximumSymbolComplexity===n&&o.maximumNumberOfFeatures===a?o:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,maximumSymbolComplexity:n,maximumNumberOfFeatures:a}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSymbolComplexity",{get:function(){for(var e=null,t=this.symbolComplexities,i=this._get("maxSymbolComplexity"),r=!1,n=0,a=t;n<a.length;n++){var o=a[n];(!e||0===e.primitivesPerCoordinate&&o.primitivesPerFeature>e.primitivesPerFeature||0!==e.primitivesPerCoordinate&&o.primitivesPerCoordinate>e.primitivesPerCoordinate)&&(e=o),r=r||o.estimated}return!e||r&&i&&(i.primitivesPerFeature>=e.primitivesPerFeature||i.primitivesPerCoordinate>=e.primitivesPerCoordinate)||i&&i.primitivesPerFeature===e.primitivesPerFeature&&i.primitivesPerCoordinate===e.primitivesPerCoordinate?i:e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this._spatialReference},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemory",{get:function(){var e=this.maxSymbolComplexity&&this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemoryPerGraphic",{get:function(){if(this._usedMemory&&this.numberOfGraphics)return this._usedMemory/this.numberOfGraphics;if(this.maxSymbolComplexity){var e=this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.maxSymbolComplexity.memory.bytesPerFeature+e}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unprocessedMemoryEstimate",{get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"symbolComplexities",{get:function(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()},enumerable:!0,configurable:!0}),t.prototype.getConvertedSymbol=function(e){if("web-style"===e.type)return e.clone();var t=this.symbolConversionCache.get(e.id);if(void 0!==t)return t;var i=V.to3D(e,!0,!1,this.hasLabelingContext(e)),r=i.symbol||null;return r||i.error&&ee.error(i.error.message),this.symbolConversionCache.set(e.id,r),r},t.prototype.getSymbolComplexitiesUsedOrRenderer=function(e){if(b.isNone(e))return[];var t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];var r=[],n=this.getSymbolComplexityUsedOrRenderer(i);b.isSome(n)&&r.push(n);for(var a=0,o=t;a<o.length;a++){var s=o[a],l=this.getSymbolComplexityUsedOrRenderer(s);b.isSome(l)&&r.push(l)}return r},t.prototype.getSymbolComplexityUsedOrRenderer=function(e){if(b.isNone(e))return null;var t=this.symbols.get(e.id);if(t)return t.complexity;var i=this.getConvertedSymbol(e);return i?H.defaultSymbolComplexity(i):null},t.prototype.getSymbolComplexitiesUsed=function(){var e=[];return this.symbols.forEach(function(t){t&&e.push(t.complexity)}),e},t.prototype.initialize=function(){var e=this;this._spatialReference=this.owner.view.spatialReference,this._set("featureStore",new M.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:function(){return e.spatialIndex},forAllGraphics:function(t){return e.graphics3DGraphics.forEach(t)}}))},t.prototype.setup=function(e){return a(this,void 0,void 0,function(){var t,i,r,a,o,s=this;return n(this,function(n){switch(n.label){case 0:return this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("deconflictor",e.deconflictor),this._set("labeler",e.labeler),this._set("highlights",e.highlights),t=this.owner.view,this.viewElevationProvider=new A.ViewElevationProvider(this._spatialReference,t),this.initializeStage(t,this.layer.uid),this.symbolCreationContext.sharedResources=t.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=t.sharedSymbolResources.addGraphicsOwner(this.owner),b.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=t.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderSpatialReference=t.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=t.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=new Q,this.symbolCreationContext.elevationProvider=t.elevationProvider,i=F.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),r=this.symbolCreationContext,[4,F.createContext(i,this._spatialReference,ee)];case 1:return r.featureExpressionInfoContext=n.sent(),this.symbolCreationContext.screenSizePerspectiveEnabled=t.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled,this.handles.add(this.owner.watch("suspended",function(){return s.updateLayerVisibility()})),a="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled",this.handles.add([this.owner.watch(a,function(){var e=t.screenSizePerspectiveEnabled&&s.layer.screenSizePerspectiveEnabled;e!==s.symbolCreationContext.screenSizePerspectiveEnabled&&(s.symbolCreationContext.screenSizePerspectiveEnabled=e,s.recreateAllGraphics())}),w.init(this,"preferredUpdatePolicy",function(){return s.updateUpdatePolicy()},!0),this.owner.watch("slicePlaneEnabled",function(e){return s.slicePlaneEnabledChange(!!e)}),this.owner.view.watch("pixelRatio",function(){return s.pixelRatioChange()}),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",function(e){return s.physicalBasedRenderingChange(e)}),w.when(t.basemapTerrain,"tilingScheme",function(e){e.spatialReference.equals(s.symbolCreationContext.overlaySR)||(s.symbolCreationContext.overlaySR=t.basemapTerrain.spatialReference),s.handles.has("loaded-graphics")?s.recreateAllGraphics():s.handles.add([w.on(s.owner,"loadedGraphics","change",function(e){return s.graphicsCollectionChanged(e)},function(){return s.recreateAllGraphics()}),w.on(s.owner,"loadedGraphics","after-changes",function(){return s._signalUpdatingDuringAsyncLoadedGraphicsChange()},function(){return s._signalUpdatingDuringAsyncLoadedGraphicsChange()})],"loaded-graphics")}),t.resourceController.scheduler.registerTask(K.Task.GRAPHICS_CORE,function(e){return s.update(e)},function(){return s.needsUpdate()})]),this.owner.layer&&"featureReduction"in this.owner.layer&&this.handles.add(this.owner.watch("layer.featureReduction",function(){return s.deconflictor.featureReductionChange()})),o=this.rendererChange(this.layer.renderer),this.notifyChange("maxSymbolComplexity"),[2,o.catch(function(){})]}})})},t.prototype.destroy=function(){this.abortRendererChange(),this.abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange&&(this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=null),this.clear(),this.stage&&(this.stage.removeFromViewContent([this.stageLayer.id]),this.stage.remove(0,this.stageLayer.id),this.stageLayer=null,this.stage=null),this.handles.destroy(),this.handles=null,this._spatialReference=null,this._set("owner",null);for(var e in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new c("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex&&(this._spatialIndex.destroy(),this._spatialIndex=null),this.featureStore&&(this.featureStore.destroy(),this._set("featureStore",null))},t.prototype.clear=function(){this.highlights&&this.highlights.allGraphicsDeleted(),this.graphics3DGraphics.forEach(function(e){return e.destroy()}),this._spatialIndex&&this._spatialIndex.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this.updateLayerVisibility(),this.symbols.forEach(function(e){e&&e.destroy()}),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this.pendingAdds=0,this.pendingRemoves=0,this._set("hasDraped",!1),this.notifyChange("updating"),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")},t.prototype.initializeStage=function(e,t){this.stage=e._stage,this.stageLayer=new J(t,{isPickable:!this.owner.suspended},t),this.stage.add(0,this.stageLayer),this.stage.addToViewContent([this.stageLayer.id])},t.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var t=new Set;this.symbols.forEach(function(i){i&&i.setDrawOrder(e,t)}),t.size>0&&this.stage.renderView.getDrapedRenderer().updateRenderOrder(t)},t.prototype.updateLayerVisibility=function(){var e=!!this.owner.suspended,t=this.numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*ae,i=!e&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())},t.prototype.updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)},t.prototype.getGraphics3DGraphicById=function(e){return this.graphics3DGraphics.get(e)},t.prototype._getGraphicObjectID=function(e,t){return void 0===t&&(t=this.owner.layer&&this.owner.layer.objectIdField),I.getObjectId(e,t)},Object.defineProperty(t.prototype,"graphics3DGraphicsByObjectID",{get:function(){var e=this,t=this.owner.layer&&this.owner.layer.objectIdField;if(!t)return null;var i=new Map;return this.graphics3DGraphics.forEach(function(r){if(r){var n=r.graphic,a=e._getGraphicObjectID(n,t);b.isSome(a)&&i.set(a,r)}}),i},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelsEnabled",{get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())},enumerable:!0,configurable:!0}),t.prototype.updateLabelingInfo=function(e){return a(this,void 0,void 0,function(){var t,i;return n(this,function(r){switch(r.label){case 0:return t=this.deconflictor&&this.deconflictor.labelingInfoChange(e),i=this.labeler&&this.labeler.labelingInfoChange(e),[4,C.eachAlways([t,i])];case 1:return r.sent(),[2]}})})},t.prototype.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){var e=this;if(this.pendingUpdates.size>0)return"unknown";var t=0,i=0;return u.someMap(this.symbols,function(r,n){if(r){var a=r.getFastUpdateStatus();if(a.loading>0)return!0;e.graphicsBySymbol.has(n)&&(i+=a.fast,t+=a.slow)}return!1})?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"},enumerable:!0,configurable:!0}),t.prototype.needsUpdate=function(){return this.pendingUpdates.size>0},t.prototype.update=function(e){this._applyPendingUpdates(e),this.needsUpdate()||this.notifyChange("updating")},t.prototype.setObjectIdVisibility=function(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);var i=this._findGraphics3DGraphicByObjectId(e);b.isSome(i)&&this._updateUserVisibility(i)},t.prototype._findGraphics3DGraphicByObjectId=function(e){var t,i=this;return u.someMap(this.graphics3DGraphics,function(r){return i._getGraphicObjectID(r.graphic)===e&&(t=r,!0)}),t},t.prototype._updateUserVisibility=function(e){if(b.isNone(e))return!1;var t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(b.isNone(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(0,r,0)},t.prototype.whenGraphics3DGraphic=function(e){var t=this.graphics3DGraphics.get(e.uid);if(t)return C.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=C.createDeferred();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise},t.prototype.boundsForGraphics3DGraphic=function(e,t){return a(this,void 0,void 0,function(){var i,r,a,o,s,l,h,p,d,c;return n(this,function(n){switch(n.label){case 0:return i=this._spatialReference,r=this.owner.view.renderSpatialReference,a=this.owner.view.basemapTerrain.spatialReference,o=function(e,t,n){return k.bufferToBuffer(e,r,t,e,i,t,n)},s=function(e,t,r){return k.bufferToBuffer(e,a,t,e,i,t,r)},l=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:b.isSome(t)&&t.useViewElevation,minDemResolution:b.isSome(t)&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,[4,e.getProjectedBoundingBox(o,s,l,b.get(t,"signal"))];case 1:return(h=n.sent())?(p=h.boundingBox,h.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&(R.center(p,Y),X.x=Y[0],X.y=Y[1],X.z=void 0,X.spatialReference=i,c=d.getElevation(X)||0,p[2]=Math.min(p[2],c),p[5]=Math.max(p[5],c)),[2,{boundingBox:p,screenSpaceObjects:h.screenSpaceObjects}]):[2,null]}})})},t.prototype.whenGraphicBounds=function(e,t){var i=this;return w.whenOnce(this.owner,"loadedGraphics").then(function(){var t=i.owner.layer&&i.owner.layer.objectIdField,r=i.owner.loadedGraphics.find(function(i){return i===e||t&&i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]});if(r)return i.whenGraphics3DGraphic(r);throw new c("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return i.boundsForGraphics3DGraphic(e,t)})},t.prototype.computeAttachmentOrigin=function(e,t){var i=this.graphics3DGraphics.get(e.uid);if(!i)return null;var r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;P.vec3.set(oe,0,0,0);var n=0;if(r.render.num>0){if(!k.vectorToVector(r.render.origin,this.symbolCreationContext.renderSpatialReference,se,t))return null;P.vec3.add(oe,oe,se),n++}if(r.draped.num>0){var a=r.draped.origin,s=a[0],l=a[1],h=this.viewElevationProvider.getElevation(s,l,"ground")||0;if(P.vec3.set(se,s,l,h),!k.vectorToVector(se,this.viewElevationProvider.spatialReference,se,t))return null;P.vec3.add(oe,oe,se),n++}return n>1&&P.vec3.scale(oe,oe,1/n),new o.Point({x:oe[0],y:oe[1],z:oe[2],spatialReference:t})},t.prototype.getSymbolLayerSize=function(e,t){var i=this.symbols.get(e.id);if(null==i)throw new c("internal:symbol-not-part-of-view","Symbol is not part of this view");var r=e.symbolLayers.indexOf(t);if(-1===r)throw new c("internal:missing-symbol-layer","Symbol layer is not in symbol");var n=i.getSymbolLayerSize(r);if(null==n)throw new c("internal:missing-size","Symbol layer has no valid size");return n},t.prototype.graphicsCollectionChanged=function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))},t.prototype.graphicUpdateHandler=function(e){var t=e.graphic.uid,i=this.graphics3DGraphics.get(t),r=this.graphicsWithoutSymbol.get(t);if(i||r)switch(e.property){case"visible":this.graphicUpdateVisibleHandler(i);break;case"geometry":this.graphicUpdateGeometryHandler(i,e);break;case"symbol":this.graphicUpdateSymbolHandler(i,e);break;case"attributes":break;default:d.neverReached(e)}},t.prototype.graphicUpdateGeometryHandler=function(e,t){var i=t.graphic.geometry;if(b.isNone(i))return void this.recreateGraphic(t.graphic);if(b.isNone(e)){var r=t.graphic.symbol&&t.graphic.symbol.id;if(r){var n=this.symbols.get(r);if(n&&0===n.loadStatus)return}return void this.recreateGraphic(t.graphic)}e.graphics3DSymbol.updateGeometry(e,t.newValue)||this.recreateGraphic(e.graphic),this.expandComputedExtent(i)},t.prototype.graphicUpdateSymbolHandler=function(e,t){var i=t.graphic,r=b.isSome(e)?e.graphics3DSymbol:t.oldValue&&this.symbols.get(t.oldValue.id);if(!r)return void this.recreateGraphic(i);var n=r.symbol,a=this.getConvertedSymbol(t.newValue);if(a.type!==n.type||"web-style"===a.type||"web-style"===n.type)return void this.recreateGraphic(i);var o=this.graphicsBySymbol.get(n.id);if(o&&1!==o.size)return void this.recreateGraphic(i);var s=x.diff(n,a);if(b.isNone(s))return void this.updateSymbolMapping(n.id,a);var l={diff:s,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!x.isEmpty(l.diff))return void this.recreateGraphic(i);for(var h=0,p=l.symbolStatePatches;h<p.length;h++){var d=p[h];d()}var c=this._getRenderingInfo(i);if(b.isSome(e))for(var y=0,u=l.graphics3DGraphicPatches;y<u.length;y++){var d=u[y];d(e,c)}this.updateSymbolMapping(n.id,a)},t.prototype.graphicUpdateVisibleHandler=function(e){var t=this._updateUserVisibility(e);t&&this.labeler&&this.owner.view.labeler.setDirty(),t&&this.owner.view.deconflictor.setDirty()},t.prototype.recreateGraphic=function(e){var t=[e];this.suspendSymbolCleanup=!0,this.remove(t),this.add(t),this.suspendSymbolCleanup=!1,this.asyncUpdates||this._cleanupSymbols()},t.prototype._beginGraphicUpdate=function(e){this.graphicsWaitingForSymbol.add(e.uid),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),this._get("symbolsUpdating")||this._set("symbolsUpdating",!0)},t.prototype._endGraphicUpdate=function(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"),this._get("symbolsUpdating")&&(this.owner.view.flushDisplayModifications(),this._set("symbolsUpdating",!1))))},t.prototype.expandComputedExtent=function(e){var t=$,i=e.spatialReference;I.computeAABB(e,t);var r=this._spatialReference,n=h.tmpVec;if(i.equals(r)||k.xyzToVector(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],k.xyzToVector(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),m.isFinite(t[0])&&m.isFinite(t[3])&&m.isFinite(t[1])&&m.isFinite(t[4])){var a=this.computedExtent,o=null,s=m.isFinite(t[2])&&m.isFinite(t[5]),l=s&&(!a||null==a.zmin||t[2]<a.zmin),p=s&&(!a||null==a.zmax||t[5]>a.zmax);if(a){(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||l||p)&&(o=this.propertiesPool.get("computedExtent"),o.xmin=Math.min(t[0],a.xmin),o.ymin=Math.min(t[1],a.ymin),o.xmax=Math.max(t[3],a.xmax),o.ymax=Math.max(t[4],a.ymax),o.spatialReference=r)}else o=this.propertiesPool.get("computedExtent"),o.xmin=t[0],o.ymin=t[1],o.xmax=t[3],o.ymax=t[4],o.spatialReference=r;o&&(l&&(o.zmin=t[2]),p&&(o.zmax=t[5]),this._set("computedExtent",o))}},t.prototype.updateHasDraped=function(){var e=this.graphicsDrapedUids.size>0;this._set("hasDraped",e)},t.prototype.abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)},t.prototype.elevationInfoChange=function(){return a(this,void 0,void 0,function(){var e,t,i,r=this;return n(this,function(n){switch(n.label){case 0:return this.abortElevationInfoChange(),e=C.createAbortController(),this.elevationInfoChangeAbortController=e,t=F.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),i=this.symbolCreationContext,[4,F.createContext(t,this._spatialReference,ee)];case 1:return i.featureExpressionInfoContext=n.sent(),C.throwIfAborted(e),this.elevationInfoChangeAbortController=null,this.labeler&&this.labeler.elevationInfoChange(),this.forEachGraphics3DSymbol(function(e,t,i){e.globalPropertyChanged("elevationInfo",t)?t.forEach(function(e){for(var t=e.graphic,i=e._labelGraphics,r=0;r<i.length;r++){var n=i[r];n.graphics3DSymbolLayer.updateGraphicElevationContext(t,n)}}):r._recreateSymbol(i)}),this.updateStageLayerElevationProvider(),this.elevationAlignment&&this.elevationAlignment.elevationInfoChange(),[2]}})})},t.prototype.updateStageLayerElevationProvider=function(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new N.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))},t.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.filterVisibility&&this.filterVisibility.clear(),this.labeler&&this.labeler.reset(),this.deconflictor&&this.deconflictor.clear(),this.elevationAlignment&&this.elevationAlignment.clear(),this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)},t.prototype.startCreateGraphics=function(){this._startCreateGraphics=!0,this.recreateAllGraphics()},t.prototype.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))},t.prototype._recreateSymbol=function(e){var t=this,i=this.graphicsBySymbol.get(e),r=[];i.forEach(function(e,i){var n=e.usedMemory;t._conditionalRemove(e,i),t._spatialIndex&&t._spatialIndex.remove(e),r.push(e.graphic),e.destroy(),t.removeGraphics3DGraphic(i,n),t.updateLayerVisibility(),t.featureStore.events.emit("changed")}),this.graphicsBySymbol.set(e,new Map);var n=this.symbols.get(e);n&&n.destroy(),this.symbols.delete(e),this.updateHasDraped(),this.add(r)},t.prototype._conditionalRemove=function(e,t){e.isDraped()&&this.graphicsDrapedUids.delete(t),this.highlights&&this.highlights.removeGraphic(e),this.labeler&&this.labeler.removeGraphic(e),this.deconflictor&&this.deconflictor.removeGraphic(e)},t.prototype.add=function(e){if(e&&0!==e.length){if(!this.owner.view.basemapTerrain||!this.owner.view.basemapTerrain.tilingScheme)return void ee.error("#add()","Cannot add graphics before terrain surface has been initialized");this.asyncUpdates?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")}},t.prototype._addImmediate=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,ie.clear();for(var i=0,r=e;i<r.length;i++){var n=r[i];this._startAddGraphic(n,this._getRenderingInfo(n,ee),ie)}ie.forEach(function(e){return t._finishAddGraphics(e)}),ie.clear(),this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty(),this._cleanupSymbols()},t.prototype._addDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=r.uid,a=this.pendingUpdates.get(n);a?a.add?0!==a.state&&a.abortController.abort():this.pendingAdds++:(a=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(n,a)),a.add=r}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype.remove=function(e){this.asyncUpdates?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")},t.prototype._removeImmediate=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._removeGraphic(r)}this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty()},t.prototype._removeDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],n=r.uid,a=this.pendingUpdates.get(n);if(a)a.add&&(a.remove?a.add=null:this.pendingUpdates.delete(n),1===a.state&&a.abortController.abort(),this.pendingAdds--);else{var o=this.pendingUpdatesPool.pushNew();o.remove=r,this.pendingUpdates.set(n,o),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype._finishPendingUpdates=function(){this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&ee.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0},t.prototype._applyPendingUpdates=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;var i=e.idleFrame?1e3:100,r=0;ie.clear(),u.someMap(this.pendingUpdates,function(n,a){if(n.add&&0===n.state&&t._startAddRenderingInfo(n),!n.remove||n.add&&2!==n.state||(t.pendingRemoves--,t._removeGraphic(n.remove),n.remove=null),n.add)switch(n.state){case 2:t._startAddGraphic(n.add,n.renderingInfo,ie)&&r++,n.add=null,t.pendingAdds--;break;case 3:n.add=null,t.pendingAdds--}return r>i&&(ie.forEach(function(e){return t._finishAddGraphics(e)}),ie.clear(),r=0),null==n.remove&&null==n.add&&(t.pendingUpdates.delete(a),e.madeProgress()),e.done}),ie.forEach(function(e){return t._finishAddGraphics(e)}),ie.clear(),0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.updateHasDraped()},t.prototype._startAddRenderingInfo=function(e){var t=this;b.isSome(this.layer.renderer)&&"dictionary"===this.layer.renderer.type?(e.state=1,e.abortController=C.createAbortController(),this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal}).then(function(i){b.isNone(i)||b.isNone(i.symbol)?(ee&&!t.symbolWarningLogged&&(t.symbolWarningLogged=!0,
ee.warn("Graphic in layer "+t.layer.id+" has no symbol and will not render")),e.renderingInfo=null):e.renderingInfo=i,e.state=2},function(t){e.abortController=null,C.isAbortError(t)?e.state=0:e.state=3})):(e.renderingInfo=this._getRenderingInfo(e.add,ee),e.state=2)},t.prototype._startAddGraphic=function(e,t,i){if(this.graphicsWithoutSymbol.set(e.uid,e),!t||b.isNone(t.symbol)||!I.hasGeometry(e))return!1;var r=t.symbol,n=this.getOrCreateGraphics3DSymbol(r,t.renderer);if(!n)return!1;this.expandComputedExtent(e.geometry),this._beginGraphicUpdate(e);var a={graphic:e,renderingInfo:t,layer:this.layer},o=n.symbol.id,s=i.get(o);if(s)s.graphics.push(a);else{var l=ne.acquire();l.clear(),l.push(a),i.set(o,{asyncSymbol:n,graphics:l})}return!0},t.prototype._finishAddGraphics=function(e){var t=this,i=!1,r=function(t){t===e.asyncSymbol.symbol.id&&(i=!0)};this._whenSymbolRemoved.push(r),e.asyncSymbol.load().then(function(){t._whenSymbolRemoved.removeUnordered(r),re.clear();for(var n=0;n<e.graphics.length;n++){var a=e.graphics.data[n],o=a.graphic;if(!(i||e.asyncSymbol.destroyed||t.graphicSymbolSupported&&o.symbol&&o.symbol.id!==e.asyncSymbol.symbol.id)){if(t.graphicsWaitingForSymbol.has(o.uid)){var s=t.createGraphics3DGraphic(e.asyncSymbol,a);t._spatialIndex&&s&&re.push(s)}t._endGraphicUpdate(o)}--e.asyncSymbol.referenced}re.length>0&&(t._spatialIndex.addMany(re.data,re.length),re.clear()),t.featureStore.events.emit("changed"),e.graphics.clear(),ne.release(e.graphics),t.labeler&&t.owner.view.labeler.setDirty()},function(){t._whenSymbolRemoved.removeUnordered(r);if(!i&&!e.asyncSymbol.destroyed)for(var n=0;n<e.graphics.length;n++)t._endGraphicUpdate(e.graphics.data[n].graphic);e.graphics.clear(),ne.release(e.graphics)})},t.prototype._removeGraphic=function(e){var t=e.uid,i=this.graphics3DGraphics.get(t);if(i){i.graphics3DSymbol.onRemoveGraphic(i);var r=i.usedMemory,n=i.isElevationSource;this._conditionalRemove(i,t),this._spatialIndex&&this._spatialIndex.remove(i);var a=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(a).delete(t),this.graphicsWithoutSymbol.delete(t),this.removeGraphics3DGraphic(t,r,n),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t)},t.prototype.hasLabelingContext=function(e){if(e instanceof l.LabelSymbol3D||e instanceof l.TextSymbol){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(function(t){return t.symbol===e})}return!1},t.prototype.hasValidSymbolCreationContext=function(e){return!(e instanceof l.LabelSymbol3D&&!this.hasLabelingContext(e))||(ee.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)},t.prototype._getRenderingInfo=function(e,t){var i=e.geometry;if(b.isNone(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!this.graphicSymbolSupported&&b.isSome(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var r,n=this.rendererHasGeometryOperations?I.hydrateGraphic(e,this.layer):e;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||b.isSome(this.currentRenderer)))r=this.owner.getRenderingInfo(n,this.currentRenderer,b.unwrap(this.arcadeOnDemand));else{r={symbol:n.symbol||L.getDefaultSymbol3D(n.geometry)}}return!r||b.isNone(r.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render")),null):r},t.prototype._getRenderingInfoAsync=function(e,t){var i=e.geometry;if(b.isNone(i))return ee&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,ee.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!this.graphicSymbolSupported&&b.isSome(e.symbol))return ee&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,ee.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var r=this.rendererHasGeometryOperations?I.hydrateGraphic(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,b.unwrap(this.currentRenderer),b.unwrap(this.arcadeOnDemand),t)},t.prototype.createGraphics3DSymbol=function(e,t){var i=this;if(!this.hasValidSymbolCreationContext(e))return null;var r=this.getConvertedSymbol(e);if(!r)return null;var n;if(b.isSome(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var a=V.to3D(t.backgroundFillSymbol,!1,!0);a.symbol&&"web-style"!==a.symbol.type&&(n=a.symbol.symbolLayers)}var o=W.make(r,this.symbolCreationContext,n);return o.load().then(function(){return i.notifyChange("maxSymbolComplexity")},function(){}),o},t.prototype.getOrCreateGraphics3DSymbol=function(e,t){var i=this,r=this.symbols.get(e.id);return void 0===r&&(r=e instanceof l.WebStyleSymbol?new j(e,function(e){return i.createGraphics3DSymbol(e,t)}):this.createGraphics3DSymbol(e,t),this.symbols.set(e.id,r)),r&&++r.referenced,r},t.prototype.addGraphics3DGraphic=function(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()},t.prototype.removeGraphics3DGraphic=function(e,t,i){void 0===i&&(i=!1),this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()},t.prototype.createGraphics3DGraphic=function(e,t){var i=t.graphic;if(this.graphicsWithoutSymbol.delete(i.uid),!this.symbols.has(e.symbol.id))return void this.add([i]);if(!this.graphics3DGraphics.has(i.uid)){var r=e.createGraphics3DGraphic(t),n=e.symbol.id;this.addGraphics3DGraphic(r),this.graphicsBySymbol.has(n)||this.graphicsBySymbol.set(n,new Map),this.graphicsBySymbol.get(n).set(i.uid,r);r.isDraped()&&(this.graphicsDrapedUids.add(i.uid),this._set("hasDraped",!0)),r.centroid=null,b.isSome(i.geometry)&&"point"!==i.geometry.type&&r instanceof z&&(r.centroid=T.computeCentroid(i.geometry,this._spatialReference)),this._updateUserVisibility(r),this.scaleVisibility&&this.scaleVisibility.updateVisibility(r),this.filterVisibility&&this.filterVisibility.updateVisibility(r),this.deconflictor&&this.deconflictor.addGraphic(r),this.labeler&&this.labeler.addGraphic(r),this.highlights&&this.highlights.addGraphic(r),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stageLayer,this.stage);var a=this.whenGraphics3DGraphicRequests[i.uid];return a&&(delete this.whenGraphics3DGraphicRequests[i.uid],a.resolve(r)),r}},t.prototype.abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)},t.prototype.rendererChange=function(e){return a(this,void 0,void 0,function(){var t,i;return n(this,function(r){switch(r.label){case 0:return this.abortRendererChange(),e===this.currentRenderer?[2]:(this.validateRenderer(e),O.isSupportedRenderer3D(e)?b.isSome(e)&&e.arcadeRequired?(t=C.createAbortController(),this.rendererChangeAbortController=t,[4,this.ensureArcade()]):[3,4]:(this.currentRendererChange(null,!1),[2]));case 1:return i=r.sent().arcadeUtils,C.throwIfAborted(t),i.hasGeometryOperations(e)?[4,i.enableGeometryOperations()]:[3,3];case 2:r.sent(),C.throwIfAborted(t),r.label=3;case 3:return this.rendererChangeAbortController=null,this.currentRendererChange(e,!0),[3,5];case 4:this.currentRendererChange(e,!1),r.label=5;case 5:return[2]}})})},t.prototype.ensureArcade=function(){return a(this,void 0,void 0,function(){var e;return n(this,function(t){switch(t.label){case 0:return b.isNone(this.arcadeOnDemand)?(e=this,[4,U.loadArcade()]):[3,2];case 1:return e.arcadeOnDemand=t.sent(),[2,this.arcadeOnDemand];case 2:return[2,this.arcadeOnDemand]}})})},t.prototype.currentRendererChange=function(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=b.unwrap(this.arcadeOnDemand);var i=this.symbolCreationContext.renderer;if(e!==i){if(this.updateUpdatePolicy(),this.symbolConversionCache.clear(),b.isNone(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphics();var r=x.diff(i,e);this.updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,b.isNone(r)||("complete"===r.type?this.recreateAllGraphics():"partial"===r.type&&(this.applyRendererDiff(r,e,i)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("maxSymbolComplexity"))}},t.prototype.diffHasSymbolChange=function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1},t.prototype.applySymbolSetDiff=function(e,t,i){var r=this;e=e||[],t=t||[];for(var n=[],a=this,o=0,s=t;o<s.length;o++){var l=s[o];!function(t){var o=a.graphicsBySymbol.get(t.id);o&&o.forEach(function(a,s){var l=a.graphic,h=r.layer instanceof E?r.layer:null,p=b.unwrap(r.arcadeOnDemand);if(t!==i.defaultSymbol||i.getSymbol(I.hydrateGraphic(l,h),{arcade:p})!==i.defaultSymbol){var d=a.usedMemory;e.length||i.defaultSymbol?n.push(l):r.graphicsWithoutSymbol.set(s,l);var c=r.graphics3DGraphics.get(s);r._conditionalRemove(c,s),a.destroy(),o.delete(s),r.removeGraphics3DGraphic(s,d),r.updateLayerVisibility()}}),a._whenSymbolRemoved.forEach(function(e){return e(t.id)})}(l)}(e.length||n.length)&&(this.graphicsWithoutSymbol.forEach(function(e){return n.push(e)}),this.graphicsWithoutSymbol.clear(),this.add(n)),this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty()},t.prototype.applyUniqueValueRendererDiff=function(e,t,i){var r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){var a=n?n.added.map(function(e){return e.symbol}):[],o=n?n.removed.map(function(e){return e.symbol}):[];if(n)for(var s=0;s<n.changed.length;s++)a.push(n.changed[s].newValue.symbol),o.push(n.changed[s].oldValue.symbol);return r?(i.defaultSymbol&&o.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&o.push(t.defaultSymbol),this.applySymbolSetDiff(a,o,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},t.prototype.calculateUnchangedSymbolMapping=function(e,t,i){var r=function(e){return b.isSome(e)?e.id:null};if(t instanceof s.UniqueValueRenderer&&i instanceof s.UniqueValueRenderer&&(b.isNone(e)||"partial"===e.type)){var n=e&&e.diff,a=n&&n.defaultSymbol,o=n&&n.uniqueValueInfos,l=void 0;return l=o?o.unchanged.map(function(e){return{oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}}):i.uniqueValueInfos.map(function(e,i){return{oldId:r(e.symbol),newId:r(t.uniqueValueInfos[i].symbol)}}),!a&&i.defaultSymbol&&l.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),l}return[]},t.prototype.updateSymbolMapping=function(e,t){var i=t?"string"==typeof t?t:t.id:null,r="string"==typeof t?null:t;if(e&&e!==i){var n=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==n&&this.graphicsBySymbol.set(i,n);var a=this.symbols.get(e);this.symbols.delete(e),void 0!==a&&(this.symbols.set(i,a),r?a.symbol=r:a.symbol.id=i)}},t.prototype.updateUnchangedSymbolMappings=function(e,t,i){for(var r=this.calculateUnchangedSymbolMapping(e,t,i),n=0,a=r;n<a.length;n++){var o=a[n],s=o.oldId,l=o.newId;this.updateSymbolMapping(s,l)}},t.prototype.applyRendererDiff=function(e,t,i){var r=this;return!this.diffHasSymbolChange(e)&&(!!(t instanceof s.UniqueValueRenderer&&i instanceof s.UniqueValueRenderer&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)||!u.someMap(this.graphicsBySymbol,function(i,n){var a=r.symbols.get(n);return a&&!a.applyRendererDiff(e,t)}))},t.prototype.opacityChange=function(){this.forEachGraphics3DSymbol(function(e,t){return e.globalPropertyChanged("opacity",t)}),this.updateStageLayerVisibility()},t.prototype.updateUpdatePolicy=function(){var e=b.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type;this._asyncUpdates=1===this.preferredUpdatePolicy||e,this.symbolCreationContext.isAsync=this._asyncUpdates,this._asyncUpdates||this.update(K.noBudget)},t.prototype.slicePlaneEnabledChange=function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(function(e,t){return e.globalPropertyChanged("slicePlaneEnabled",t)}),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())},t.prototype.physicalBasedRenderingChange=function(e){e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(function(e,t){return e.globalPropertyChanged("physicalBasedRenderingEnabled",t)}))},t.prototype.pixelRatioChange=function(){var e=this;this.forEachGraphics3DSymbol(function(t,i,r){t.globalPropertyChanged("pixelRatio",i)||e._recreateSymbol(r)})},t.prototype._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){var e=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=S.schedule(function(){e._updatingPendingLoadedGraphicsChange=null})},t.prototype.setClippingExtent=function(e,t){var i=this.symbolCreationContext.clippingExtent,r=_.create();return k.extentToBoundingRect(e,r,t)?this.symbolCreationContext.clippingExtent=[r[0],r[1],-1/0,r[2],r[3],1/0]:this.symbolCreationContext.clippingExtent=null,!p.equals(this.symbolCreationContext.clippingExtent,i)},t.prototype.notifyVisibilityChanged=function(){this.owner.view.deconflictor.setDirty(),this.owner.view.labeler.setDirty()},t.prototype.modifyGraphics3DGraphicVisibilities=function(e){var t=!1;this.graphics3DGraphics.forEach(function(i){e(i)&&(t=!0)}),t&&this.notifyVisibilityChanged()},t.prototype.forEachGraphics3DSymbol=function(e){var t=this;this.graphicsBySymbol.forEach(function(i,r){var n=t.symbols.get(r);n&&e(n,i,r)})},t.prototype.updateAllGraphicsVisibility=function(){var e=this;this.filterVisibility&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities(function(t){var i=e._updateUserVisibility(t),r=e.scaleVisibility&&e.scaleVisibility.updateVisibility(t);return i||r})},t.prototype.hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(function(e){return e.setVisibilityFlag(0,!1,0)})},t.prototype.validateRenderer=function(e){var t=O.validateTo3D(e);if(t){var i="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";ee.warn(i,t.message)}},t.prototype.volatileGraphicsUpdated=function(){this.labeler&&this.labeler.reset(),this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")},t.prototype._cleanupSymbols=function(){var e=this;if(!(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)){var t=!1;this.symbols.forEach(function(i,r){if(i&&!(i.referenced>0)){var n=e.graphicsBySymbol.get(r);n&&0!==n.size||(e.graphicsBySymbol.delete(r),e.symbols.delete(r),i&&i.destroy(),t=!0)}}),t&&this.notifyChange("maxSymbolComplexity")}},t.prototype.snapshotInternals=function(){var e=this;return{graphics:p.keysOfMap(this.graphics3DGraphics).sort(),symbols:p.keysOfMap(this.symbols).sort(),graphicsBySymbol:p.keysOfMap(this.graphicsBySymbol).sort().map(function(t){return{symbolId:t,graphics:p.keysOfMap(e.graphicsBySymbol.get(t)).sort()}}),graphicsWithoutSymbol:p.keysOfMap(this.graphicsWithoutSymbol).sort(),graphicsDrapedUids:p.keysOfSet(this.graphicsDrapedUids).sort(),pendingUpdates:this.pendingUpdates}},Object.defineProperty(t.prototype,"test",{get:function(){return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size}},enumerable:!0,configurable:!0}),t.prototype.getStats=function(){return{"core.visible":this.graphics3DGraphics.size,"core.missing":this.graphicsWithoutSymbol.size,"core.pending":this.pendingUpdates.size}};var h;return t.tmpVec=D.vec3f64.create(),r([G.property({readOnly:!0})],t.prototype,"computedExtent",void 0),r([G.property()],t.prototype,"currentRenderer",void 0),r([G.property()],t.prototype,"rendererHasGeometryOperations",void 0),r([G.property()],t.prototype,"rendererChangeAbortController",void 0),r([G.property()],t.prototype,"elevationInfoChangeAbortController",void 0),r([G.property({readOnly:!0})],t.prototype,"elevationAlignment",void 0),r([G.property({readOnly:!0})],t.prototype,"scaleVisibility",void 0),r([G.property({readOnly:!0})],t.prototype,"filterVisibility",void 0),r([G.property()],t.prototype,"_updatingPendingLoadedGraphicsChange",void 0),r([G.property({readOnly:!0})],t.prototype,"featureStore",void 0),r([G.property({readOnly:!0})],t.prototype,"deconflictor",void 0),r([G.property({readOnly:!0})],t.prototype,"labeler",void 0),r([G.property({readOnly:!0})],t.prototype,"highlights",void 0),r([G.property()],t.prototype,"preferredUpdatePolicy",void 0),r([G.property({constructOnly:!0})],t.prototype,"elevationFeatureExpressionEnabled",void 0),r([G.property({constructOnly:!0})],t.prototype,"owner",void 0),r([G.property({constructOnly:!0})],t.prototype,"layer",void 0),r([G.property({readOnly:!0})],t.prototype,"hasDraped",void 0),r([G.property({readOnly:!0})],t.prototype,"symbolsUpdating",void 0),r([G.property({constructOnly:!0})],t.prototype,"graphicSymbolSupported",void 0),r([G.property({constructOnly:!0})],t.prototype,"getRenderingInfoWithoutRenderer",void 0),r([G.property({readOnly:!0,dependsOn:["elevationAlignment.updating","scaleVisibility.updating","filterVisibility.updating","rendererChangeAbortController","elevationInfoChangeAbortController","_updatingPendingLoadedGraphicsChange"]})],t.prototype,"updating",null),r([G.property({readOnly:!0})],t.prototype,"updatingRemaining",null),r([G.property({readOnly:!0})],t.prototype,"updatingTotal",null),r([G.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","maxSymbolComplexity"]})],t.prototype,"displayFeatureLimit",null),r([G.property({readOnly:!0})],t.prototype,"maxSymbolComplexity",null),r([G.property({constructOnly:!0})],t.prototype,"hasZ",void 0),r([G.property({constructOnly:!0})],t.prototype,"hasM",void 0),t=h=r([G.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],t)}(G.declared(h)),ie=new Map,re=new v,ne=new f(v),ae=(function(){function e(){this.add=null,this.renderingInfo=null,this.state=0,this.remove=null}}(),10),oe=D.vec3f64.create(),se=D.vec3f64.create();return te});