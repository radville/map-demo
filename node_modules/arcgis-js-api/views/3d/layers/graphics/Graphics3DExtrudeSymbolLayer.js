// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/Error","../../../../core/maybe","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../layers/graphics/dehydratedFeatures","../../../../renderers/support/renderingInfoUtils","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/edgeUtils","../../support/projectionUtils","../../support/buffer/BufferView","../../support/buffer/math/vec3","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(e,t,r,a,n,i,o,s,l,c,p,u,h,d,f,y,g,m,v,b,E,_,x,S,A,P,w,C,L,D,M){function R(e,t,r,a,n,i,o,s,l,c,p,u,h,d){var f=r.length/3,y=0;p+=2*a.count,T(e,t,a.index,a.count,r,0,f,n,i,o,s,l,c,p,u,h,d),l+=2*a.count,p+=2*f,p-=2*a.count+2*f,O(n,i,s,o,y,a.pathLengths[0],a.count,l,c,p,u),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],y+=a.pathLengths[0];for(var g=1;g<a.pathLengths.length;++g)O(n,i,s,o,y,a.pathLengths[g],a.count,l,c,p,u),l+=4*a.pathLengths[g],p+=2*a.pathLengths[g],y+=a.pathLengths[g]}function T(e,t,r,a,n,i,o,s,l,c,p,u,h,f,y,g,m){d.vec3.copy(I,g);for(var v=y>0?1:-1,b=3*r,E=u,_=3*E,x=u+a,S=3*x,A=0;A<a;++A)m&&(I[0]=e[b+0],I[1]=e[b+1],I[2]=e[b+2],d.vec3.normalize(I,I)),s[_+0]=e[b+0],s[_+1]=e[b+1],s[_+2]=e[b+2],l[_+0]=t[b+0],l[_+1]=t[b+1],l[_+2]=t[b+2],c[_+0]=-v*I[0],c[_+1]=-v*I[1],c[_+2]=-v*I[2],p[E]=0,s[S+0]=e[b+0]+y*I[0],s[S+1]=e[b+1]+y*I[1],s[S+2]=e[b+2]+y*I[2],l[S+0]=t[b+0],l[S+1]=t[b+1],l[S+2]=t[b+2],c[S+0]=v*I[0],c[S+1]=v*I[1],c[S+2]=v*I[2],p[x]=y,_+=3,S+=3,b+=3,E+=1,x+=1;b=3*i,_=3*f,S=3*(f+o);_=3*(f+o),S=3*f;var P=U,w=F;y<0&&(P=F,w=U);for(var A=0;A<o;++A)h[_+0]=n[b+P[0]],h[_+1]=n[b+P[1]],h[_+2]=n[b+P[2]],h[S+0]=n[b+w[0]]+a,h[S+1]=n[b+w[1]]+a,h[S+2]=n[b+w[2]]+a,_+=3,S+=3,b+=3}function G(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function O(e,t,r,a,n,i,o,s,l,c,p){var u=n,h=n+1,d=n+o,f=n+o+1,y=s,g=s+1,m=s+2*i,v=s+2*i+1;p<0&&(u=n+o+1,f=n),c*=3;for(var b=0;b<i;++b)b===i-1&&(p>0?(h=n,f=n+o):(h=n,u=n+o)),V(e,u,h,d,Y),G(e,t,a,r,Y,y,u),G(e,t,a,r,Y,g,h),G(e,t,a,r,Y,m,d),G(e,t,a,r,Y,v,f),l[c++]=y,l[c++]=m,l[c++]=v,l[c++]=y,l[c++]=v,l[c++]=g,u++,h++,d++,f++,y+=2,g+=2,m+=2,v+=2}function V(e,t,r,a,n){t*=3,r*=3,a*=3,d.vec3.set(Z,e[t++],e[t++],e[t++]),d.vec3.set(k,e[r++],e[r++],e[r++]),d.vec3.set(q,e[a++],e[a++],e[a++]),d.vec3.subtract(W,k,Z),d.vec3.subtract(J,q,Z),d.vec3.cross(n,J,W),d.vec3.normalize(n,n)}function B(e,t,r,a){var n=e.stageObject;N.spatialReference=r.spatialReference;for(var i=n.geometryRecords,o=i.length,s="absolute-height"!==t.mode,l=0,c=n.objectTransformation,p=u.mat4.invert(h.mat4f64.create(),c),f=0;f<o;f++){var y=i[f].geometry;y.invalidateBoundingInfo();for(var g=y.data.getVertexAttr(),m=g[L.VertexAttrConstants.POSITION].data,b=g[L.VertexAttrConstants.SIZE].data,E=g.mapPos.data,_=m.length/3,x=0,S=0,A=!1,P=0,w=0;w<_;w++){N.x=E[S],N.y=E[S+1],N.z=E[S+2],K[0]=m[x],K[1]=m[x+1],K[2]=m[x+2];var C=v.computeElevation(r,N,t,a,s?H:null);s&&(P+=H.terrainElevation),d.vec3.set(z,m[x+0],m[x+1],m[x+2]),d.vec3.transformMat4(z,z,c),a.setAltitude(C+b[x/3],z),d.vec3.transformMat4(z,z,p),m[x]=z[0],m[x+1]=z[1],m[x+2]=z[2];var D=.01/a.unitInMeters;(Math.abs(K[0]-m[x])>D||Math.abs(K[1]-m[x+1])>D||Math.abs(K[2]-m[x+2])>D)&&(A=!0),S+=3,x+=3}A&&n.geometryVertexAttrsUpdated(f),l+=P/_}return l/o}Object.defineProperty(t,"__esModule",{value:!0});var z=f.vec3f64.create(),I=f.vec3f64.create(),U=[0,2,1],F=[0,1,2],N=y.makeDehydratedPoint(0,0,0,null),H={verticalDistanceToGround:0,terrainElevation:0},j=function(e){function t(t,r,a,n){return e.call(this,t,r,a,n)||this}return r(t,e),t.prototype.doLoad=function(){return n(this,void 0,void 0,function(){var e,t,r,n,l,c;return a(this,function(a){if(!this._drivenProperties.size&&(e=E.validateSymbolLayerSize(this._getSymbolSize())))throw new o("graphics3dextrudesymbollayer:invalid-size",e);return t=s.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(t),n=f.vec3f64.fromArray(r),l=r[3],c={diffuse:n,ambient:n,opacity:l,transparent:l<1||this.needsDrivenTransparentPass,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},this._material=new D(i({},M.getDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled),c,{offsetTransparentBackfaces:!0}),this._getIdHint("_3dlinemat")),this._context.stage.add(3,this._material),[2]})})},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&this._context.stage.remove(3,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var r=e.graphic;if(!this._validateGeometryType(r.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(r.geometry))return null;var a="graphic"+r.uid,n=this._getVertexOpacityAndColor(e.renderingInfo,Float32Array,255),i=this.getGraphicElevationContext(r);return this._createAs3DShape(r,e.renderingInfo,n,i,a,r.uid)},t.prototype.layerOpacityChanged=function(e,t){var r=this,a=s.get(this.symbolLayer,"material","color"),n=this._getCombinedOpacity(a),i=n<1||this.needsDrivenTransparentPass;this._material.setParameterValues({opacity:n,transparent:i});var o=this._getLayerOpacity();return e.forEach(function(e){var a=t(e);s.isSome(a)&&a.layerOpacityChanged(o,r._context.isAsync)}),!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,v.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach(function(e){var a=t(e);s.isSome(a)&&a.slicePlaneEnabledChanged(r._context.slicePlaneEnabled,r._context.isAsync)}),!0},t.prototype.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled}),!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._drivenProperties.size?g.getDriverAxisSizeValue(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbolLayer.size||1},t.prototype._createAs3DShape=function(e,t,r,a,n,i){var o=v.getGeometryAsPolygon(e.geometry),d=o.rings,y=[],g=[],b=[],_=new Array(6),w=this._context.renderSpatialReference===x.SphericalECEFSpatialReference,L=this._getExtrusionSize(t),D=f.vec3f64.create();w||this._context.renderCoordsHelper.worldUpAtPosition(null,D);var M=v.getGeometryVertexData3D(d,o.hasZ,o.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,a,1);if(this._logGeometryCreationWarnings(M,d,"rings","ExtrudeSymbol3DLayer"),0===d.length||!d.some(function(e){return e.length>0}))return null;var T=E.computeCentroid(o);if(s.isNone(T))return null;var G=h.mat4f64.create();x.computeLinearTransformation(o.spatialReference,[T.x,T.y,0],G,this._context.renderSpatialReference);var O=h.mat4f64.create();u.mat4.invert(O,G);var V=p.mat3f64.create();c.mat3.normalFromMat4(V,O);for(var z=M.geometryData.polygons,I=M.eleVertexData,U=M.vertexData,F=U.length/3,N=new Float64Array(3*F*6),H=new Float64Array(3*F*6),j=new Float64Array(3*F*6),Y=new Float64Array(1*F*6),Z=0,k=this,q=0;q<z.length;++q)!function(e){var t=z[e],a=t.count,i=t.index;if(k._context.clippingExtent&&(v.computeBoundingBox(I,i,a,_),v.boundingBoxClipped(_,k._context.clippingExtent)))return"continue";var o=new Float64Array(I.buffer,3*i*N.BYTES_PER_ELEMENT,3*a),s=t.holeIndices.map(function(e){return e-i}),c=l(o,s,3);if(0===c.length)return"continue";var p=3*a*2+2*c.length,u=new Uint32Array(p),d=6*a,f=3*N.BYTES_PER_ELEMENT,m=new S.BufferViewVec3f64(N.buffer,Z*f,f,(Z+d)*f),E=3*H.BYTES_PER_ELEMENT,x=new S.BufferViewVec3f64(H.buffer,Z*E,E,(Z+d)*E),C=new Float64Array(j.buffer,3*Z*j.BYTES_PER_ELEMENT,3*d),M=new Float64Array(Y.buffer,1*Z*Y.BYTES_PER_ELEMENT,1*d);R(U,I,c,t,m.typedBuffer,C,x.typedBuffer,M,0,u,0,L,D,w),A.transformMat4(m,m,O),A.transformMat3(x,x,V),Z+=6*a;var T=k._createExtrudeGeometry(u,{positions:m.typedBuffer,elevation:C,normals:x.typedBuffer,heights:M},r),G=new P(T,n+"path"+e);G.singleUse=!0,y.push(G),g.push(k._material),b.push(h.mat4f64.create())}(q);if(0===y.length)return null;var W=new C({geometries:y,materials:g,transformations:b,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0},idHint:n});W.objectTransformation=G;var J=B,K=this._createEdgeMaterial(),Q=s.isSome(K)?{baseMaterial:this._material,edgeMaterials:[K],slicePlaneEnabled:this._context.slicePlaneEnabled}:null,X=new m(this,W,y,null,null,J,a,Q);return X.alignedTerrainElevation=M.terrainElevation,X.needsElevationUpdates=v.needsElevationUpdates3D(a.mode),X},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[L.VertexAttrConstants.POSITION]=n,s[L.VertexAttrConstants.NORMAL]=n,s[L.VertexAttrConstants.COLOR]=i,l[L.VertexAttrConstants.POSITION]={size:3,data:t.positions},l[L.VertexAttrConstants.NORMAL]={size:3,data:t.normals},l[L.VertexAttrConstants.COLOR]={size:4,data:r},l[L.VertexAttrConstants.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new w.GeometryData(l,s)},t.prototype._createEdgeMaterial=function(){var e={opacity:this._getLayerOpacity()};return _.createMaterial(this.symbolLayer,e)},t.validGeometryTypes=["polygon","extent"],t}(b.default);t.Graphics3DExtrudeSymbolLayer=j;var Y=f.vec3f64.create(),Z=f.vec3f64.create(),k=f.vec3f64.create(),q=f.vec3f64.create(),W=f.vec3f64.create(),J=f.vec3f64.create(),K=f.vec3f64.create();t.default=j});