// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Graphic","../../../../core/Accessor","../../../../core/asyncUtils","../../../../core/compilerUtils","../../../../core/Handles","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../core/accessorSupport/diffUtils","../../../../geometry/support/webMercatorUtils","../../../../tasks/support/Query","./constants","./Graphics3DCore","./Graphics3DElevationAlignment","./Graphics3DFilterVisibility","./Graphics3DFrustumVisibility","./Graphics3DHighlights","./Graphics3DScaleVisibility","./graphicUtils","../support/attributeUtils","../../../support/WatchUpdatingTracking"],function(t,i,e,r,s,n,a,l,o,p,h,u,c,d,g,y,f,b,m,v,w,E,V,x,C,U){var R=function(t){function i(i){var e=t.call(this,i)||this;return e._handles=new h,e.highlights=new E,e.watchUpdatingTracking=new U.WatchUpdatingTracking,e.suspendResumeExtentMode="computed",e.dataExtent=null,e.suspendResumeExtent=null,e}return e(i,t),Object.defineProperty(i.prototype,"suspended",{get:function(){return this.scaleVisibility&&this.scaleVisibility.suspended||this.frustumVisibility&&this.frustumVisibility.suspended},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"updating",{get:function(){return!!(this.graphicsCore&&this.graphicsCore.updating||this.frustumVisibility&&this.frustumVisibility.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)},enumerable:!0,configurable:!0}),i.prototype.normalizeCtorArgs=function(t){var i=t.frustumVisibilityEnabled?new w:null,e=t.scaleVisibilityEnabled?new V:null,r=(t.filterVisibilityEnabled||t.timeExtentVisibilityEnabled)&&"multipatch"!==t.layer.geometryType?new v.Graphics3DFilterVisibility:null,s=t.elevationAlignmentEnabled?new m:null;return{graphicsCore:new b({owner:t.owner,layer:t.layer,preferredUpdatePolicy:t.preferredUpdatePolicy,elevationFeatureExpressionEnabled:t.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:t.owner.hasZ,hasM:t.owner.hasM}),frustumVisibility:i,scaleVisibility:e,filterVisibility:r,elevationAlignment:s,updateClippingExtent:t.updateClippingExtent,suspendResumeExtentMode:t.suspendResumeExtentMode,dataExtent:t.dataExtent}},i.prototype.initialize=function(){var t=this;this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",function(){return t.scaleVisibility.layerMinMaxScaleChangeHandler()}),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",function(){return t.filterVisibility.filterChanged()}),this.watchUpdatingTracking.add(this.owner,"timeExtent",function(){return t.filterVisibility.filterChanged()})),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",function(i,e){d.diff(i,e)&&t.watchUpdatingTracking.addPromise(t.graphicsCore.elevationInfoChange())}),this.watchUpdatingTracking.add(this.layer,"labelsVisible",function(){return t.graphicsCore.updateVisibilityInfo()}),this.watchUpdatingTracking.add(this.layer,"labelingInfo",function(i,e){d.diff(i,e)&&t.graphicsCore.updateLabelingInfo()})},i.prototype.setup=function(){return n(this,void 0,void 0,function(){var t,i,e,r,n=this;return s(this,function(s){switch(s.label){case 0:return this.frustumVisibility&&this.frustumVisibility.setup(this.owner),t=this.owner,i=this.owner.view.basemapTerrain,e=function(t,i,e){return n.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,i,e)},this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,e,this.graphicsCore,i),this.filterVisibility&&("filter"in t||"timeExtent"in t)&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment&&(r=t.view.elevationProvider,this.elevationAlignment.setup(t,e,this.graphicsCore,r)),this.highlights&&this.highlights.setup(this.graphicsCore),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),[4,o.result(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,highlights:this.highlights}))];case 1:return s.sent(),this.watchUpdatingTracking.add(this.layer,"renderer",function(t){return n.watchUpdatingTracking.addPromise(n.graphicsCore.rendererChange(t))}),this.watchUpdatingTracking.add(t,"fullOpacity",function(){return n.graphicsCore.opacityChange()}),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(t.view,"clippingArea",function(){return n._updateClippingExtent()}),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled?[4,o.result(this.graphicsCore.updateLabelingInfo())]:[3,3];case 2:s.sent(),s.label=3;case 3:return[2]}})})},i.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);for(var t=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","highlights","graphicsCore"],i=0,e=t;i<e.length;i++){var r=e[i],s=this[r];s&&(s.destroy(),this._set(r,null))}this._set("layer",null),this._set("owner",null)},i.prototype.highlight=function(t,i,e){var r=this;if(t instanceof y){var s=this.highlights.acquireSet(i,e),n=s.set,l=s.handle;return this.owner.queryObjectIds(t).then(function(t){return r.highlights.setObjectIds(n,t)}),l}if("number"==typeof t)return this.highlight([t],i,e);if(t instanceof a)return this.highlight([t],i,e);if("toArray"in t&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof a){var o=t;if(!e||!o[0].attributes||null===C.attributeLookup(o[0].attributes,e)){var p=o.map(function(t){return t.uid}),h=this.highlights.acquireSet(i,null),u=h.set,l=h.handle;return this.highlights.setUids(u,p),l}t=o.map(function(t){return C.attributeLookup(t.attributes,e)})}if("number"==typeof t[0]){var c=t,d=this.highlights.acquireSet(i,e),u=d.set,l=d.handle;return this.highlights.setObjectIds(u,c),l}}return k},i.prototype._updateClippingExtent=function(){var t=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(t,this.owner.view.spatialReference)&&(this.updateClippingExtent(t)||this.graphicsCore.recreateAllGraphics())},i.prototype.setupSuspendResumeExtent=function(){var t=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(u.init(this,"suspendResumeExtentMode",function(){switch(t._handles.remove(T),t.suspendResumeExtentMode){case"computed":t._handles.add(u.init(t.graphicsCore,"computedExtent",function(i){return t.updateSuspendResumeExtent(i)}),T);break;case"data":t._handles.add(u.init(t,"dataExtent",function(i){return t.updateSuspendResumeExtent(i)}),T);break;default:p.neverReached(t.suspendResumeExtentMode)}}))},i.prototype.updateSuspendResumeExtent=function(t){t?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(t,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)},i.prototype.extentToSuspendResumeRect=function(t,i){var e=this.owner.view.spatialReference;if(!t.spatialReference.equals(e)){if(!g.canProject(t,e))return;t=g.project(t,e)}return x.enlargeExtent(t,i,f.SUSPEND_RESUME_EXTENT_OPTIMISM)},i.prototype.suspendResumeExtentChanged=function(t){this.frustumVisibility&&this.frustumVisibility.setExtent(t),this.scaleVisibility&&this.scaleVisibility.setExtent(t)},r([c.property({aliasOf:"graphicsCore.layer"})],i.prototype,"layer",void 0),r([c.property({aliasOf:"graphicsCore.owner"})],i.prototype,"owner",void 0),r([c.property({constructOnly:!0})],i.prototype,"updateClippingExtent",void 0),r([c.property({constructOnly:!0})],i.prototype,"graphicsCore",void 0),r([c.property({constructOnly:!0})],i.prototype,"scaleVisibility",void 0),r([c.property({constructOnly:!0})],i.prototype,"filterVisibility",void 0),r([c.property({constructOnly:!0})],i.prototype,"elevationAlignment",void 0),r([c.property({constructOnly:!0})],i.prototype,"frustumVisibility",void 0),r([c.property({readOnly:!0})],i.prototype,"deconfliction",void 0),r([c.property({readOnly:!0})],i.prototype,"labeling",void 0),r([c.property({readOnly:!0})],i.prototype,"highlights",void 0),r([c.property({readOnly:!0})],i.prototype,"watchUpdatingTracking",void 0),r([c.property()],i.prototype,"suspendResumeExtentMode",void 0),r([c.property()],i.prototype,"dataExtent",void 0),r([c.property({readOnly:!0,dependsOn:["scaleVisibility.suspended","frustumVisibility.suspended"]})],i.prototype,"suspended",null),r([c.property({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],i.prototype,"updating",null),i=r([c.subclass("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],i)}(c.declared(l)),T="suspendResumeExtentMode",k={remove:function(){},pause:function(){},resume:function(){}};return R});