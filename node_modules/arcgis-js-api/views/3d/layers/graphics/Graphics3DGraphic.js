// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","../../../../layers/graphics/featureConversionUtils","./featureExpressionInfoUtils","../../support/projectionUtils"],function(e,t,i,r,o,n,a,s,c,h,p,u,l,y,f,d,g,m){function b(e,t){for(var i=new Array(e),r=0;r<i.length;r++)i[r]=new Array(t);return i}var v=new a(Array,function(e){return l.set(e,l.ZERO)},null,10,5),G=y.create();return function(){function e(e,t,i,r,o){this._labelGraphics=[],this._auxiliaryGraphics=[],this._visibilityFlags=b(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this.extent=null,this.isElevationSource=!1,++t.referenced,this.graphics3DSymbol=t,this.graphic=e,this._graphics=i,this._featureExpressionFeature=o?g.createFeature(o,e,r):null;for(var a=0,s=this._graphics;a<s.length;a++){var c=s[a];n.isSome(c)&&(this.isElevationSource=this.isElevationSource||c.isElevationSource)}}return e.prototype.initialize=function(e,t){var i=this;this._layer=e,this._stage=t,this.forEachSymbolLayerGraphic(function(r){r.initialize(e,t),r.setVisibility(i.isVisible())})},e.prototype.destroy=function(){this.forEachSymbolLayerGraphic(function(e){return e.destroy()}),this._graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null},Object.defineProperty(e.prototype,"destroyed",{get:function(){return null==this._graphics},enumerable:!0,configurable:!0}),e.prototype.clearLabelGraphics=function(){this.forEachLabelGraphic(function(e){return e.destroy()}),this._labelGraphics.length=0},e.prototype.addLabelGraphic=function(e,t,i){this._labelGraphics.push(e),e.initialize(t,i),e.setVisibility(this.isVisible(1))},e.prototype.addAuxiliaryGraphic=function(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._layer,this._stage),e.setVisibility(this.isVisible()))},e.prototype.isDraped=function(){var e=!1;return this.forEachSymbolLayerGraphic(function(t){"draped"===t.type&&(e=!0)}),e},e.prototype.isVisible=function(e,t){void 0===e&&(e=0);for(var i=0;i<=e;i++)for(var r=this._visibilityFlags[i],o=0;o<r.length;++o)if(!1===r[o]&&o!==t)return!1;return!0},e.prototype.hasVisibilityFlag=function(e,t){return null!=this._visibilityFlags[t][e]},e.prototype.setVisibilityFlag=function(e,t,i){var r=this.isVisible(i);this._visibilityFlags[i][e]=t;var o=this.isVisible(i);if(r===o)return!1;if(1===i)this.forEachLabelGraphic(function(e){return e.setVisibility(o)});else{this.forEachSymbolLayerGraphic(function(e){return e.setVisibility(o)});var n=this.isVisible(1);this.forEachLabelGraphic(function(e){return e.setVisibility(n)})}return!0},e.prototype.clearVisibilityFlag=function(e,t){return void 0===t&&(t=0),this.setVisibilityFlag(e,void 0,t)},e.prototype.getBSRadius=function(){var e=0;return this.forEachSymbolLayerGraphic(function(t){e=Math.max(e,t.getBSRadius())}),e},e.prototype.getCenterObjectSpace=function(e){if(void 0===e&&(e=p.vec3f64.create()),0===this._graphics.length)return h.vec3.set(e,0,0,0),e;var t=this._graphics[0];return n.isSome(t)?t.getCenterObjectSpace(e):e},e.prototype.computeExtent=function(e){if(!this.extent){this.extent=y.create();var t=this.graphic.geometry;if(n.isNone(t))return this.extent=null,!1;var i=t.spatialReference;if(f.computeAABR(t,this.extent),!i.equals(e)&&!m.boundingRectToBoundingRect(this.extent,i,this.extent,e))return this.extent=null,!1}return!0},e.prototype.getAsOptimizedGeometry=function(e,t){return this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t?this._optimizedGeometry.geometry:(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t,this._optimizedGeometry.geometry)},e.prototype._convertGraphicToOptimizedGeometry=function(e,t,i){var r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=u.fromExtent("mesh"===r.type?r.extent:r)),d.convertFromGeometry(r,t,i)},Object.defineProperty(e.prototype,"usedMemory",{get:function(){var e=this,t=f.estimateAttributesObjectSize(this.graphic.attributes);return this.forEachSymbolLayerGraphic(function(i){var r=i.graphics3DSymbolLayer.complexity,o="draped"===i.type?r.memory.draped:r.memory;t+=o.bytesPerFeature,o.bytesPerCoordinate&&(t+=f.numVertices(e.graphic.geometry)*o.bytesPerCoordinate)}),t},enumerable:!0,configurable:!0}),e.prototype.computeAttachmentOrigin=function(){for(var e={render:{origin:p.vec3f64.create(),num:0},draped:{origin:c.vec2f64.create(),num:0}},t=0,i=this._graphics;t<i.length;t++){var r=i[t];n.isNone(r)||r.computeAttachmentOrigin(e)}return e.render.num&&h.vec3.scale(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&s.vec2.scale(e.draped.origin,e.draped.origin,1/e.draped.num),e},e.prototype.getProjectedBoundingBox=function(e,t,a,s,c){return r(this,void 0,void 0,function(){var h=this;return i(this,function(p){switch(p.label){case 0:return c||(c={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),c.boundingBox?l.empty(c.boundingBox):c.boundingBox=l.empty(),c.requiresDrapedElevation=!1,[4,o.forEach(this._graphics,function(o){return r(h,void 0,void 0,function(){var r,h,p;return i(this,function(i){switch(i.label){case 0:return n.isNone(o)?[2]:(r="draped"===o.type?t:e,h=v.acquire(),[4,o.getProjectedBoundingBox(r,a,c.screenSpaceObjects,s,h)]);case 1:return p=i.sent(),isFinite(p[2])&&isFinite(p[5])||(c.requiresDrapedElevation=!0),p&&l.expand(c.boundingBox,h),v.release(h),[2]}})})})];case 1:return p.sent(),l.allFinite(c.boundingBox)||y.allFinite(l.toRect(c.boundingBox,G))?[2,c]:[2,null]}})})},e.prototype.needsElevationUpdates=function(){for(var e=0,t=this._graphics;e<t.length;e++){var i=t[e];if(n.isSome(i)&&("object3d"===i.type||"lod-instance"===i.type)&&i.needsElevationUpdates)return!0}for(var r=0,o=this._labelGraphics;r<o.length;r++){var i=o[r];if(i&&i.needsElevationUpdates)return!0}return!1},e.prototype.alignWithElevation=function(e,t,i){var r=this;this.forEachRenderedGraphic(function(o){"object3d"!==o.type&&"lod-instance"!==o.type||o.alignWithElevation(e,t,r._featureExpressionFeature,i)})},e.prototype.addHighlight=function(e,t){this.forEachSymbolLayerGraphic(function(i){return i.addHighlight(e,t)})},e.prototype.removeHighlight=function(e){this.forEachSymbolLayerGraphic(function(t){return t.removeHighlight(e)})},e.prototype.forEachGraphicList=function(e,t){e.forEach(function(e,i){return e&&t(e,i)})},e.prototype.forEachSymbolLayerGraphic=function(e){this.forEachGraphicList(this._graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)},e.prototype.forEachLabelGraphic=function(e){this.forEachGraphicList(this._labelGraphics,e)},e.prototype.forEachRenderedGraphic=function(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)},e}()});