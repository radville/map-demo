// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../symbols","../../../../core/asyncUtils","../../../../core/compilerUtils","../../../../core/Error","../../../../core/has","../../../../core/lang","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../../../support/arcadeOnDemand","../../../../symbols/cim/CIMSymbolRasterizer","../../../../symbols/support/IconSymbol3DLayerResource","../../../../symbols/support/utils","../../../2d/arcade/utils","./constants","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./sdfPrimitives","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,i,a,s,o,n,l,c,u,h,d,p,m,_,f,y,v,g,b,S,x,M,P,z,R,T,I,w,E,C,O,U,D,A,L,F,G,V,H){function N(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}function k(e){return!!p.isSome(e)&&("cross"===e||"x"===e)}function q(e){var t,r=W,i=r*Z;switch(e){case"circle":t=U.createCircle(r,i);break;case"square":t=U.createSquare(r,i);break;case"kite":t=U.createKite(r,i);break;case"cross":t=U.createCross(r,i);break;case"x":t=U.createX(r,i);break;case"triangle":t=U.createTriangle(r,i);break;default:c.neverReached(e)}return new V(t,"sdf_"+e,{mipmap:!1,wrap:{s:33071,t:33071},width:W,height:W,components:4,noUnpackFlip:!0})}Object.defineProperty(t,"__esModule",{value:!0});var B=y.mat4f64.create(),j=g.vec3f64.fromValues(0,0,1),W=128,Z=.5,J=[Z/2,Z/2,1-Z/2,1-Z/2],K=[W*Z,W*Z],X=function(e){function t(t,r,i,a){var s=e.call(this,t,r,i,a)||this;return s._cimLayers=null,s._cimSymbolMaterials=new Map,s._cimSymbolDrapedMaterials=new Map,s._cimSymbolTextures=new Map,s._cimMaterialParametersInfo=null,s._cimRequiredFields=null,s._cimScaleFactorOrFunction=null,s._size=null,s._symbolTextureRatio=1,s._outlineSize=0,s._texture=null,s._drapedMaterial=null,s._releaseTexture=null,s._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},s}return i(t,e),t.prototype.getCachedSize=function(){return{size:this._getIconSize()}},t.prototype.doLoad=function(e){return s(this,void 0,void 0,function(){var t,r,i,s;return a(this,function(a){switch(a.label){case 0:return this._validateOrThrow(),(t=this._prepareMaterialParameters(),r=this._getPrimitive(),p.isSome(r))?(this._prepareResourcesPrimitive(t,r),[3,5]):[3,1];case 1:return i=P.getIconHref(this.symbol,this.symbolLayer),s=f.dataComponents(i),s&&"application/json"===s.mediaType?[4,this._prepareResourcesCIM(t,JSON.parse(s.data),e)]:[3,3];case 2:return a.sent(),[3,5];case 3:return[4,this._prepareResourcesHref(t,i,e)];case 4:a.sent(),a.label=5;case 5:return[2]}})})},t.prototype._validateOrThrow=function(){if(!this._drivenProperties.size){var e=O.validateSymbolLayerSize(this._getIconSize());if(e)throw new u("graphics3diconsymbollayer:invalid-size",e)}},t.prototype._getIconSize=function(){var e=this.symbolLayer,t=Math.round(null!=e.size?_.pt2px(e.size):16);return this._drivenProperties.size?Math.max(t,64):t},t.prototype._generateTextureCIM=function(e){var t=this._getGraphicHash(e),r=""===t?null:this._cimSymbolTextures.get(t);if(!r){var i={scaleFactor:this._cimScaleFactorOrFunction},a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,i);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",a.anchorPosition);var s={width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:2};r=new V(a.imageData,"symbol",s),this._cimSymbolTextures.set(t,r),this._context.stage.add(4,r)}return r},t.prototype._computeSize=function(e,t){var r=e.width/e.height;return r>1?[t,Math.round(t/r)]:[Math.round(t*r),t]},t.prototype._prepareMaterialParameters=function(){var e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(N(t)){var r=t.verticalOffset,i=r.screenLength,a=r.minWorldLength,s=r.maxWorldLength;e.verticalOffset={screenLength:_.pt2px(i),minWorldLength:a||0,maxWorldLength:null!=s?s:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e},t.prototype._prepareResourcesPrimitive=function(e,t){var r=this,i=this._getOutlineSize();if(k(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;var a=this._context.sharedResources.textures.fromData(t,function(){return q(t)});this._texture=a.texture,this._releaseTexture=function(){return r._context.sharedResources.textures.release(a.uid)},e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=J,e.textureId=this._texture.id;var s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/Z,this._createMaterialsAndAddToStage(e,this._context.stage)},t.prototype._prepareResourcesHref=function(e,t,r){return s(this,void 0,void 0,function(){var i,s,o,n,i,c,d,p,_,y=this;return a(this,function(a){switch(a.label){case 0:if(!h("esri-canvas-svg-support")&&f.isSVG(t))throw i="IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)",new u("graphics3diconsymbollayer:unsupported-image-format",i);return this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1,s=this._getIconSize(),o=s*this._context.layerView.view.pixelRatio,[4,l.result(this._context.sharedResources.textures.fromUrl(t,o,{signal:r}))];case 1:if(n=a.sent(),!1===n.ok)throw m.throwIfAbortError(n.error),i="Failed to load (Request for icon resource failed: "+t+")",new u("graphics3diconsymbollayer:request-failed",i);return c=n.value,d=c.uid,p=c.texture,this._releaseTexture=function(){return y._context.sharedResources.textures.release(d)},_=p.params,this._size=this._computeSize(_,s),e.textureId=p.id,this._createMaterialsAndAddToStage(e,this._context.stage),[2]}})})},t.prototype._prepareResourcesCIM=function(e,t,r){return s(this,void 0,void 0,function(){var i,s,o,l,c,u,h,d,p,_,f;return a(this,function(a){switch(a.label){case 0:return i=new n.CIMSymbol({data:t}),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new x(this._context.renderSpatialReference,!0)),s=this._context.layer.fields?this._context.layer.fields.map(function(e){return e.toJSON()}):null,o=this,[4,this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(i,s,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r})];case 1:return o._cimLayers=a.sent(),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression?(u=this._context.renderer,isNaN(u.scaleExpression)?(h=u.scaleExpression,[4,S.createRendererExpression(h,this._context.layer.spatialReference,s)]):[3,3]):[3,4];case 2:return d=a.sent(),c=function(e,t,r){var i=z.callWithFeature(d,e,{$view:r},"esriGeometryPoint",t);return null!==i?i:1},[3,4];case 3:l=Number(u.scaleExpression),a.label=4;case 4:return this._cimScaleFactorOrFunction=l||c||1,this._context.renderer?[3,5]:(_=[],[3,7]);case 5:return[4,this._context.renderer.getRequiredFields(this._context.layer.fields)];case 6:_=a.sent(),a.label=7;case 7:return p=_,m.throwIfAborted(r),f=this._context.layer.fieldsIndex,this._cimRequiredFields=p.map(function(e){return f.get(e).name}),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1,[2]}})})},t.prototype._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||M.defaultPrimitive},t.prototype._getOutlineSize=function(){var e=0,t=this.symbolLayer;return p.isSome(t.outline)&&null!=t.outline.size?Math.max(_.pt2px(t.outline.size),0):(e=k(this._getPrimitive())?1.5:0,Math.max(e,0))},t.prototype._getOutlineColor=function(){var e=this._getLayerOpacity(),t=this.symbolLayer,r=p.get(t,"outline","color");if(p.isSome(r)){var i=o.toUnitRGB(r),a=r.a*e;return[i[0],i[1],i[2],a]}return[0,0,0,0]},t.prototype._getFillColor=function(){if(k(this._getPrimitive()))return R.TRANSPARENT;var e=p.isNone(this._getPrimitive()),t=p.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})},t.prototype._getAnchorPos=function(e,t){return"relative"===e?v.vec2f64.fromValues((t.x||0)+.5,.5-(t.y||0)):e in O.namedAnchorToHUDMaterialAnchorPos?O.namedAnchorToHUDMaterialAnchorPos[e]:O.namedAnchorToHUDMaterialAnchorPos.center},t.prototype._createMaterialsAndAddToStage=function(e,t){this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=D.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&d.mixin(e,this._fastUpdates.materialParameters);var i=r({},e);if(i.verticalOffset=null,i.screenSizePerspective=null,i.occlusionTest=!1,i.slicePlaneEnabled=!1,i.shaderPolygonOffset=0,e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,this._cimLayers){var a=this._cimSymbolMaterials.get(e.textureId),s=this._cimSymbolDrapedMaterials.get(e.textureId);return s||(s=new H(i,this._getIdHint("_iconDraped")),this._cimSymbolDrapedMaterials.set(e.textureId,s),t.add(3,s)),a||(a=new H(e,this._getIdHint("_icon")),this._cimSymbolMaterials.set(e.textureId,a),t.add(3,a)),[a,s]}return this._drapedMaterial=new H(i,this._getIdHint("_iconDraped")),t.add(3,this._drapedMaterial),this._material=new H(e,this._getIdHint("_icon")),t.add(3,this._material),[this._material,this._drapedMaterial]},t.prototype.destroy=function(){var t=this;e.prototype.destroy.call(this),this._forEachMaterial(0,function(e){t._context.stage.remove(3,e.id)}),this._material&&(this._material=null),this._cimSymbolMaterials.clear(),this._drapedMaterial&&(this._drapedMaterial=null),this._cimSymbolDrapedMaterials.clear(),this._cimSymbolTextures.forEach(function(e){t._context.stage.remove(4,e.id)}),this._cimSymbolTextures.clear(),this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)},t.prototype._getScaleFactor=function(e,t){if(this._drivenProperties.size&&e.size){for(var r=0;r<3;r++){var i=e.size[r];i&&"symbolValue"!==i&&"proportional"!==i&&(e.size[r]=_.pt2px(i))}if("symbolValue"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1},t.prototype.createGraphics3DGraphic=function(e){var t,i,a,s,o=e.renderingInfo,n=e.graphic;if(this._cimLayers){var l=this._generateTextureCIM(n),c=r({textureId:l.id},this._cimMaterialParametersInfo);t=this._createMaterialsAndAddToStage(c,this._context.stage),a=t[0],s=t[1],i=[l.params.width,l.params.height]}else i=this._size,a=this._material,s=this._drapedMaterial;if(!this._validateGeometry(n.geometry))return null;var u=E.placePointOnGeometry(n.geometry);if(p.isNone(u))return this.logger.warn("unsupported geometry type for icon symbol: "+n.geometry.type),null;var h="graphic"+n.uid,d=this._getVertexOpacityAndColor(o),m=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){var _=i[0]>i[1]?i[0]:i[1];m=this._getScaleFactor(o,_)}m*=this._symbolTextureRatio;var f=[i[0]*m,i[1]*m],y=this.getGraphicElevationContext(n);return"on-the-ground"===y.mode?this._createAsOverlay(n,u,s,d,f,h,e.layer.uid):this._createAs3DShape(n,u,a,d,f,y,h,n.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial(0,function(r){r.setParameterValues({color:e}),r.setParameterValues({outlineColor:t})}),!0},t.prototype.layerElevationInfoChanged=function(e,r,i){var a=this._elevationContext.mode,s=E.elevationModeChangeUpdateType(t.elevationModeChangeTypes,i,a);if(s!==E.SymbolUpdateType.UPDATE)return s;var o=E.needsElevationUpdates2D(a)||"absolute-height"===a;return this.updateGraphics3DGraphicElevationInfo(e,r,function(){return o})},t.prototype.slicePlaneEnabledChanged=function(){var e=this;return this._forEachMaterial(1,function(t){t.setParameterValues({slicePlaneEnabled:e._context.slicePlaneEnabled})}),!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!!this._getPrimitive()},t.prototype.applyRendererDiff=function(e,t){for(var r in e.diff)switch(r){case"visualVariables":if(!D.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._material&&this._material.setParameterValues(this._fastUpdates.materialParameters),this._drapedMaterial&&this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},t.prototype.setDrawOrder=function(e,t,r){this.updateSymbolLayerOrder(e,t),this._forEachMaterial(2,function(t){t.renderPriority=e,r.add(t.id)})},t.prototype._defaultElevationInfoNoZ=function(){return $},t.prototype._createAs3DShape=function(e,t,r,i,a,s,o,n){var l=this,c=this.getFastUpdateAttrValues(e),u=c?function(e){return D.evaluateModelTransform(l._fastUpdates.materialParameters,c,e)}:null,h=F.createPointGeometry(j,null,i,a,Q,null,c),d=new L(h,o),p=[d],m=E.createStageObjectForPoint(this._context,t,p,[r],null,null,s,o,this._context.layer.uid,n,!0,u);if(null===m)return null;var _=T.perObjectElevationAligner,f=new w(this,m.object,p,null,null,_,s);return f.alignedTerrainElevation=m.terrainElevation,f.needsElevationUpdates=E.needsElevationUpdates2D(s.mode)||"absolute-height"===s.mode,f.getScreenSize=this._createScreenSizeGetter(a,u),f.calculateRelativeScreenBounds=function(e){return r.calculateRelativeScreenBounds(f.getScreenSize(),1,e)},E.extendPointGraphicElevationContext(f,t,this._context.elevationProvider),f},t.prototype._createAsOverlay=function(e,t,r,i,a,s,o){var n=this;r.renderPriority=this._symbolLayerOrder;var l=g.vec3f64.create();A.pointToVector(t,l,this._context.overlaySR),l[2]=this._getDrapedZ();var c=this._context.clippingExtent;if(c&&!E.pointInBox2D(l,c))return null;var u=this.getFastUpdateAttrValues(e),h=u?function(e){return D.evaluateModelTransform(n._fastUpdates.materialParameters,u,e)}:null,d=F.createPointGeometry(j,l,i,a,null,null,u),p=new G(d);p.material=r,p.center=l,p.bsRadius=0,p.transformation=B,p.name=s,p.uniqueName=s+"#"+d.id,p.data.layerUid=o,p.data.graphicUid=e.uid,p.calculateShaderTransformation=h;var m=new I(this,[p],null);return m.getScreenSize=this._createScreenSizeGetter(a,h),m.calculateRelativeScreenBounds=function(e){return r.calculateRelativeScreenBounds(m.getScreenSize(),1,e)},m},t.prototype._createScreenSizeGetter=function(e,t){var r=this._outlineSize+2;if(this._fastUpdates.enabled){var i=e[0]/this._symbolTextureRatio,a=e[1]/this._symbolTextureRatio;return function(e){void 0===e&&(e=v.vec2f64.create());var s=t(B);return e[0]=s[0]*i+r,e[1]=s[5]*a+r,e}}var s=e[0]/this._symbolTextureRatio+r,o=e[1]/this._symbolTextureRatio+r;return function(e){return void 0===e&&(e=v.vec2f64.create()),e[0]=s,e[1]=o,e}},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=g.vec3f64.fromValues(e,e,e),r=_.px2pt(1),i=e*r;return{modelSize:t,symbolSize:g.vec3f64.fromValues(i,i,i),unitInMeters:r,transformation:{anchor:g.vec3f64.ZEROS,scale:g.vec3f64.ONES,rotation:g.vec3f64.ZEROS}}},t.prototype._getGraphicHash=function(e){for(var t="",r=0,i=this._cimRequiredFields;r<i.length;r++){var a=i[r];t+=a+e.attributes[a]}return t},t.prototype._forEachMaterial=function(e,t){switch(e){case 0:this._forEachMaterial(1,t),this._forEachMaterial(2,t);break;case 1:this._material&&t(this._material),this._cimSymbolMaterials.forEach(t);break;case 2:this._drapedMaterial&&t(this._drapedMaterial),this._cimSymbolDrapedMaterials.forEach(t);break;default:c.neverReached(e)}},t.PRIMITIVE_SIZE=K,t.elevationModeChangeTypes={definedChanged:E.SymbolUpdateType.UPDATE,staysOnTheGround:E.SymbolUpdateType.NONE,onTheGroundChanged:E.SymbolUpdateType.RECREATE},t}(C.default);t.Graphics3DIconSymbolLayer=X;var $={mode:"relative-to-ground",offset:0},Q=b.vec4f64.fromValues(0,0,0,1);t.default=X});