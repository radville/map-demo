// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../Color","../../../../core/Error","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f32","../../../../geometry/support/aaBoundingBox","../../../../renderers/support/renderingInfoUtils","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./lineUtils","../support/FastSymbolUpdates","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/RibbonLineMaterial","../../webgl-engine/shaders/RibbonLineTechnique"],function(e,t,i,r,a,n,s,o,l,p,d,h,c,u,y,b,g,f,m,v,_,x,A,E,S,C,M,U,T,R,P){Object.defineProperty(t,"__esModule",{value:!0});var O=function(e){function t(t,i,r,a){var n=e.call(this,t,i,r,a)||this;return n._lineWidthLOD=1,n}return i(t,e),t.prototype.doLoad=function(){return a(this,void 0,void 0,function(){var e;return r(this,function(t){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=S.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){if((e=null!=this.symbolLayer.size?this.symbolLayer.size:d.px2pt(1))<0)throw new o("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");"round"===this.symbolLayer.join&&(this._lineWidthLOD=1.863798+-2.0062872/Math.pow(1+e/18.2313,.8856294))}return[2]})})},t.prototype.getMaterialParameters=function(e){var t=this._getCombinedOpacityAndColor(p.get(this.symbolLayer,"material","color")),i=t[3],r={width:1,color:t,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:this.symbolLayer.cap||"butt",transparent:i<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:this.symbolLayer.stipplePattern?T.createStipplePattern(this.symbolLayer.stipplePattern.map(d.pt2px)):null,stippleOffColor:this.symbolLayer.stippleOffColor?s.toUnitRGBA(this.symbolLayer.stippleOffColor):null,stippleIntegerRepeats:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(r.width=d.pt2px(1));else{var a=null!=this.symbolLayer.size?this.symbolLayer.size:d.px2pt(1);r.width=d.pt2px(a)}return this._fastUpdates&&this._fastUpdates.visualVariables?n({},r,this._fastUpdates.materialParameters):r},Object.defineProperty(t.prototype,"lineMaterial",{get:function(){return p.isNone(this._lineMaterial)&&(this._lineMaterial=new R(this.getMaterialParameters(!1),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._lineMaterial)),this._lineMaterial},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ringMaterial",{get:function(){return p.isNone(this._ringMaterial)&&(this._ringMaterial=new R(this.getMaterialParameters(!0),this._getIdHint("_ribbonlinemat")),this._context.stage.add(3,this._ringMaterial)),this._ringMaterial},enumerable:!0,configurable:!0}),t.prototype.destroy=function(){e.prototype.destroy.call(this),p.isSome(this._lineMaterial)&&(this._context.stage.remove(3,this._lineMaterial.id),this._lineMaterial=null),p.isSome(this._ringMaterial)&&(this._context.stage.remove(3,this._ringMaterial.id),this._ringMaterial=null)},t.prototype.setDrawOrder=function(t,i,r){e.prototype.setDrawOrder.call(this,t,i,r),p.isSome(this._lineMaterial)&&(this._lineMaterial.renderPriority=t,r.add(this._lineMaterial.id)),p.isSome(this._ringMaterial)&&(this._ringMaterial.renderPriority=t,r.add(this._ringMaterial.id))},t.prototype.getDrivenSize=function(e){var t=new Float32Array(1);return this._drivenProperties.size&&e.size?t[0]=d.pt2px(f.getDriverAxisSizeValue(e.size)):t[0]=1,t},t.prototype.getSizeFeatureAttribute=function(e){var t=new Float32Array(1);return t[0]=A.getAttributeValue(this._fastUpdates.visualVariables.size.field,e),t},t.prototype.getDrivenColor=function(e){var t=b.vec4f32.fromValues(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t},t.prototype.getColorFeatureAttribute=function(e){var t=new Float32Array(1);return t[0]=A.getAttributeValue(this._fastUpdates.visualVariables.color.field,e),t},t.prototype.getOpacityFeatureAttribute=function(e){var t=new Float32Array(1);return t[0]=A.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,e),t},t.prototype.createGraphics3DGraphic=function(e){var i=e.graphic,r=i.geometry;if(!this._validateGeometryType(i.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(r))return null;var a="polygon"===r.type||"extent"===r.type?"rings":"paths",n="graphic"+i.uid,s=this.getGraphicElevationContext(i);return"on-the-ground"===s.mode?this._createAsOverlay(e,a,n,this._context.layer.uid):this._createAs3DShape(e,a,s,n,i.uid)},t.prototype.applyRendererDiff=function(e,t){for(var i in e.diff)switch(i){case"visualVariables":if(!S.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;p.isSome(this._lineMaterial)&&this._lineMaterial.setParameterValues(this._fastUpdates.materialParameters),p.isSome(this._ringMaterial)&&this._ringMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},t.prototype.layerOpacityChanged=function(){return p.isSome(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),p.isSome(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0},t.prototype.updateMaterialLayerOpacity=function(e){var t=e.getParameters().color,i=p.get(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i),a=r<1||this.needsDrivenTransparentPass,n=[t[0],t[1],t[2],r];e.setParameterValues({color:n,transparent:a})},t.prototype.layerElevationInfoChanged=function(e,i,r){var a=this._elevationContext.mode,n=x.elevationModeChangeUpdateType(t.elevationModeChangeTypes,r,a);if(n!==x.SymbolUpdateType.UPDATE)return n;var s=x.needsElevationUpdates2D(a);return this.updateGraphics3DGraphicElevationInfo(e,i,function(){return s})},t.prototype.slicePlaneEnabledChanged=function(){return p.isSome(this._lineMaterial)&&this._lineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),p.isSome(this._ringMaterial)&&this._ringMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype._createAs3DShape=function(e,t,i,r,a){var n=e.graphic,s=x.getGeometryAsPoly(n.geometry),o=s[t],l=[],p=[],d=[],u=y.vec3f64.create(),b=new Array(6),g=x.getGeometryVertexData3D(o,s.hasZ,s.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,i,"rings"===t?1:0);if(this._logGeometryCreationWarnings(g,o,t,"LineSymbol3DLayer"),o.length>0){for(var f=g.geometryData.outlines,v=g.eleVertexData,A=g.vertexData,E=0;E<f.length;++E){var S=f[E];if(!(S.count<=1)){var U=S.index,T=S.count;if(!this._context.clippingExtent||(x.computeBoundingBox(v,U,T,b),!x.boundingBoxClipped(b,this._context.clippingExtent))){x.applyOrigin(A,U,T,u);var R=new Float64Array(v.buffer,3*U*v.BYTES_PER_ELEMENT,3*T),P=new Float64Array(A.buffer,3*U*A.BYTES_PER_ELEMENT,3*T),O=this._createGeometryData(e,P,R,t),I=new C(O,r+"path"+E);I.singleUse=!0,l.push(I),p.push("rings"===t?this.ringMaterial:this.lineMaterial);var D=c.mat4f64.create();h.mat4.translate(D,D,u),d.push(D)}}}if(l.length>0){var V=new M({geometries:l,materials:p,transformations:d,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a},idHint:r}),L=m.perVertexElevationAligner,w=new _(this,V,l,null,null,L,i);return w.alignedTerrainElevation=g.terrainElevation,w.needsElevationUpdates=x.needsElevationUpdates2D(i.mode),w}}return null},t.prototype._createGeometryData=function(e,t,i,r){var a="rings"===r?1:0,n=E.createPolylineGeometryData(t,i,a);if("round"===this.symbolLayer.join){var s=n.vertexAttributes[P.RibbonVertexAttributeConstants.POSITION].data,o=s.length/3,p=new Float32Array(o),d=I,h=D;u.vec3.set(d,0,0,0);for(var c=-1;c<o;++c){var y=c<0?o+c:c,b=(c+1)%o;if(u.vec3.set(h,s[3*b+0]-s[3*y+0],s[3*b+1]-s[3*y+1],s[3*b+2]-s[3*y+2]),u.vec3.normalize(h,h),c>=0){var g=Math.PI-l.acosClamped(u.vec3.dot(d,h)),f=g*V,m=1*f*this._lineWidthLOD;p[c]=Math.max(Math.floor(m),0)}u.vec3.scale(d,h,-1)}n.vertexAttributes[P.RibbonVertexAttributeConstants.SUBDIVISIONS]={size:1,data:p,offsetIdx:0,strideIdx:1},n.indices[P.RibbonVertexAttributeConstants.SUBDIVISIONS]=n.indices[P.RibbonVertexAttributeConstants.POSITION]}var v=new Uint32Array(n.vertexAttributes[P.RibbonVertexAttributeConstants.POSITION].data.length);return n.indices[P.RibbonVertexAttributeConstants.SIZE]=v,this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?(n.vertexAttributes[P.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]={size:1,data:this.getSizeFeatureAttribute(e.graphic),offsetIdx:0,strideIdx:1},n.indices[P.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE]=v):(n.vertexAttributes[P.RibbonVertexAttributeConstants.SIZE]={size:1,data:this.getDrivenSize(e.renderingInfo),offsetIdx:0,strideIdx:1},n.indices[P.RibbonVertexAttributeConstants.SIZE]=v),this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?(n.vertexAttributes[P.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE]={size:1,data:this.getColorFeatureAttribute(e.graphic),offsetIdx:0,strideIdx:1},n.indices[P.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE]=v):(n.vertexAttributes[P.RibbonVertexAttributeConstants.COLOR]={size:4,data:this.getDrivenColor(e.renderingInfo),offsetIdx:0,strideIdx:4},n.indices[P.RibbonVertexAttributeConstants.COLOR]=v),this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity&&(n.vertexAttributes[P.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]={size:1,data:this.getOpacityFeatureAttribute(e.graphic),offsetIdx:0,strideIdx:1},n.indices[P.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE]=v),n},t.prototype._createAsOverlay=function(e,t,i,r){var a=e.graphic,n=x.getGeometryAsPoly(a.geometry),s=n[t],o="rings"===t?this.ringMaterial:this.lineMaterial;o.renderPriority=this._symbolLayerOrder;var l=[],p=new Array(6),d=g.empty(),u=y.vec3f64.create(),b=x.getGeometryVertexDataDraped(s,n.spatialReference,this._context.overlaySR,"rings"===t?1:0);if(this._logGeometryCreationWarnings(b,s,t,"LineSymbol3DLayer"),s.length>0){for(var f=b.vertexData,m=b.geometryData.outlines,_=0;_<m.length;++_){var A=m[_],E=A.index,S=A.count;if(x.computeBoundingBox(f,E,S,p),!x.boundingBoxClipped(p,this._context.clippingExtent)){g.expand(d,p),x.applyOrigin(f,E,S,u),x.setZ(f,E,S,this._getDrapedZ());var C=new Float64Array(f.buffer,3*E*f.BYTES_PER_ELEMENT,3*S),M=c.mat4f64.create();h.mat4.translate(M,M,u);var T=this._createGeometryData(e,C,null,t),R=new U(T);R.data.layerUid=r,R.data.graphicUid=a.uid,R.material=o,R.center=[.5*(p[0]+p[3]),.5*(p[1]+p[4]),0],R.bsRadius=.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1])),R.transformation=M,R.name=i,R.uniqueName=i+"#"+T.id,l.push(R)}}return new v(this,l,d)}return null},t.validGeometryTypes=["polyline","polygon","extent"],t.elevationModeChangeTypes={definedChanged:x.SymbolUpdateType.RECREATE,staysOnTheGround:x.SymbolUpdateType.NONE,onTheGroundChanged:x.SymbolUpdateType.RECREATE},t}(A.Graphics3DSymbolLayer);t.Graphics3DLineSymbolLayer=O;var I=y.vec3f64.create(),D=y.vec3f64.create(),V=4/Math.PI;t.default=O});