// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/lang","../../../../core/mathUtils","../../../../core/maybe","../../../../core/libs/gl-matrix-2/mat2","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/FastSymbolUpdates","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/PathMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(e,t,a,r,i,s,o,n,l,c,h,p,d,u,m,v,f,g,y,_,b,S,x,D,w,R,P,U){function C(e,t,a){switch(t){case"world":for(var r=0,i=e.vertices;r<i.length;r++){var s=i[r];u.vec3.add(G,s.pos,e.offset),a.worldUpAtPosition(G,N),s.setFrameFromUpVector(N),s.computeRotationAxisAndAngleFromUpVector()}break;case"path":u.vec3.add(G,e.vertices[0].pos,e.offset),a.worldUpAtPosition(G,N),w.computeMinimumRotationTangentFrame(e,N);for(var o=0,n=e.vertices;o<n.length;o++){var s=n[o],c=l.sign(u.vec3.dot(s.frame.right,s.vRight));u.vec3.cross(s.rotationFrame.up,s.vRight,s.vLeft),u.vec3.scale(s.rotationFrame.up,s.rotationFrame.up,c),u.vec3.normalize(s.rotationFrame.up,s.rotationFrame.up);var p=u.vec3.dot(s.rotationFrame.up,s.frame.up),d=u.vec3.dot(s.rotationFrame.up,s.frame.right);if(u.vec3.scale(G,s.frame.up,-d),u.vec3.scale(M,s.frame.right,p),u.vec3.add(G,G,M),u.vec3.normalize(s.rotationFrame.right,G),w.vertexSpaceToProfileSpace(s.rotationRight,s.frame,s.rotationFrame.right),u.vec3.negate(G,s.vLeft),s.rotationAngle=-c*(Math.PI-l.acosClamped(u.vec3.dot(G,s.vRight))),Math.abs(s.rotationAngle)>0){var m=1/Math.cos(.5*s.rotationAngle);h.mat2.set(s.miterStretch,1+(m-1)*s.rotationRight[0]*s.rotationRight[0],(m-1)*s.rotationRight[0]*s.rotationRight[1],(m-1)*s.rotationRight[0]*s.rotationRight[1],1+(m-1)*s.rotationRight[1]*s.rotationRight[1])}var v=Math.PI-s.rotationAngle;s.maxStretchDistance=Math.abs(Math.min(s.vLeftLength,s.vRightLength)/Math.cos(.5*v))}}}function E(e,t,a){switch(e){case"symbolValue":return a;case"proportional":return t;default:return e}}function V(e,t,a,r){for(var i=0,s=0,o=e.vertices;s<o.length;s++){var n=o[s];z.x=n.posES[0],z.y=n.posES[1],z.z=n.posES[2];var l=y.computeElevation(a,z,t,r,B);i+=B.terrainElevation,u.vec3.add(N,n.pos,e.offset),r.setAltitude(l,N),u.vec3.subtract(n.pos,N,e.offset)}return e.updatePathVertexInformation(),i/e.vertices.length}function I(e,t,a,r){var i=e.stageObject,s=i.geometryRecords,o=s.length,n=0;z.spatialReference=a.spatialReference,A.spatialReference=r.spatialReference;for(var l=0;l<o;l++){var c=s[l],h=c.geometry,p=h.metadata,d=p.pathGeometry,u=d.builder.path,m=p.geometrySR;O.spatialReference=m,n+=V(u,t,a,r),"world"!==u.upVector&&C(u,p.upVectorAlignment,r),d.onPathChanged(),h.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(l)}return n/o}Object.defineProperty(t,"__esModule",{value:!0});var L=function(e){function r(t,a,r,i){var s=e.call(this,t,a,r,i)||this;return s._intrinsicSize=d.vec2f64.fromValues(1,1),s.upVectorAlignment="path",s.stencilWidth=.1,s}return a(r,e),r.prototype.doLoad=function(){return s(this,void 0,void 0,function(){var e,a,r,s,l,h,d,u,m,f,g,y,_,x;return i(this,function(i){switch(e=c.isSome(this.symbolLayer.width)?this.symbolLayer.width:c.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size,a=c.isSome(this.symbolLayer.height)?this.symbolLayer.height:e,this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,a],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=S.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},r=this.symbolLayer.anchor||"center",this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world"),s=this.symbolLayer.profile||"circle"){case"circle":default:this._profile=w.Profile.circle(t.NUM_CIRCLE_PROFILE_SUBDIVISIONS);break;case"quad":this._profile=w.Profile.rect()}switch(l=[0,0],"center"!==r&&(l={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(l[0],l[1])),h=this.symbolLayer.join||"simple"){case"round":this._extruder=new w.MiterExtruder(0,t.NUM_ROUND_JOIN_SUBDIVISIONS);break;case"bevel":this._extruder=new w.MiterExtruder(0,1);break;case"miter":this._extruder=new w.MiterExtruder(.8*Math.PI,1);break;case"simple":default:this._extruder=new w.SimpleExtruder}switch(d=this.symbolLayer.cap||"butt"){case"none":this._startCap=new w.NoCapBuilder,this._endCap=new w.NoCapBuilder;break;case"butt":default:this._startCap=new w.TriangulationCapBuilder(this._profile,0),this._endCap=new w.TriangulationCapBuilder(this._profile,0,!0);break;case"square":this._startCap=new w.TriangulationCapBuilder(this._profile,-.5),this._endCap=new w.TriangulationCapBuilder(this._profile,.5,!0);break;case"round":u="quad"===s,this._startCap=new w.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:u,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new w.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:u,subdivisions:t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}if(m=this._getIdHint(),f=c.get(this.symbolLayer,"material","color"),g=this._getCombinedOpacityAndColor(f),y=v.vec3f64.fromArray(g),_=g[3],x={diffuse:y,ambient:y,opacity:_,transparent:_<1||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===d?0:void 0,offsetTransparentBackfaces:!0},!this._drivenProperties.size&&(p.vec2.set(this._intrinsicSize,e,a),!b.isValidSize(this._intrinsicSize[0])||!b.isValidSize(this._intrinsicSize[1])))throw new o("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||p.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(n.mixin(x,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new P(x,m+"_pathmat")):(x.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new R(x,m+"_pathmat")),this._material.setParameterValues(U.getDefaultPBRMaterialParameters(this._context.physicalBasedRenderingEnabled)),this._context.stage.add(3,this._material),[2]})})},r.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)},r.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if(!this._validateGeometryType(t.geometry,r.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(t.geometry))return null;var a="graphic"+t.uid,i=this.getGraphicElevationContext(t),s=e.renderingInfo;return this._createAs3DShape(t,s,i,a,t.uid)},r.prototype.layerOpacityChanged=function(){var e=c.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),a=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({opacity:t,transparent:a}),!0},r.prototype.layerElevationInfoChanged=function(e,t){var a=this;return e.forEach(function(e){var r=t(e);if(c.isSome(r)){var i=e.graphic,s=a.getGraphicElevationContext(i);r.needsElevationUpdates=y.needsElevationUpdates3D(s.mode),r.elevationContext.set(s)}}),y.SymbolUpdateType.UPDATE},r.prototype.slicePlaneEnabledChanged=function(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},r.prototype.physicalBasedRenderingChanged=function(){return this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled}),!0},r.prototype.pixelRatioChanged=function(){return!0},r.prototype.applyRendererDiff=function(e,t){for(var a in e.diff)switch(a){case"visualVariables":if(!S.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},r.prototype.getVertexData=function(e){for(var t=0,a=e.paths,r=[],i=e.spatialReference,s=this._context.elevationProvider.spatialReference,o=this._context.renderSpatialReference,n=0,l=a;n<l.length;n++){var c=l[n];t+=c.length}for(var h=new Float64Array(3*t),p=new Float64Array(3*t),d=new Float64Array(3*t),u=0,m=0,v=a;m<v.length;m++){var c=v[m];r.push({index:u,numVertices:c.length});for(var f=0,g=c;f<g.length;f++){var _=g[f];h[u++]=_[0],h[u++]=_[1],h[u++]=e.hasZ?_[2]:0}}var b=!0;return i.equals(s)?y.copyVertices(h,0,p,0,t):b=y.reproject(h,0,i,p,0,s,t),s.equals(o)?y.copyVertices(p,0,d,0,t):y.reproject(p,0,s,d,0,o,t),{pathVertexDataInfos:r,vertexDataGS:h,vertexDataES:p,vertexDataRS:d,projectionSuccess:b,terrainElevation:0}},r.prototype._createAs3DShape=function(e,t,a,r,i){var s=e.geometry,o=[],n=[],l=[],c=s.spatialReference,h=this._context.elevationProvider.spatialReference,p=new Array(6),d=this._context.renderCoordsHelper;O.spatialReference=c,z.spatialReference=h;var m=this.getVertexData(s);if(!m.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(m.pathVertexDataInfos.length>0){for(var v=0;v<m.pathVertexDataInfos.length;++v){var f=m.pathVertexDataInfos[v],b=f.index,S=f.numVertices;if(S<2)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else if(!this._context.clippingExtent||(y.computeBoundingBox(m.vertexDataES,b,S,p),!y.boundingBoxClipped(p,this._context.clippingExtent))){for(var R=[],P=b;P<b+3*S;){var U=P++,V=P++,L=P++,A=new w.PathVertex;u.vec3.set(A.posGS,m.vertexDataGS[U],m.vertexDataGS[V],m.vertexDataGS[L]),u.vec3.set(A.posES,m.vertexDataES[U],m.vertexDataES[V],m.vertexDataES[L]),z.x=A.posES[0],z.y=A.posES[1],z.z=A.posES[2];var G=y.computeElevation(this._context.elevationProvider,z,a,d,null);u.vec3.set(N,m.vertexDataRS[U],m.vertexDataRS[V],m.vertexDataRS[L]),d.setAltitude(G,N),u.vec3.set(A.pos,N[0],N[1],N[2]),R.push(A)}var M=new w.Path(R);C(M,this.upVectorAlignment,this._context.renderCoordsHelper);var B=new w.Builder(M,this._profile,this._extruder,this._startCap,this._endCap),F=null;if(this._fastUpdates.enabled){var T=this._fastUpdates.visualVariables,k=T.size?_.getAttributeValue(T.size.field,e):0,j=T.color?_.getAttributeValue(T.color.field,e):0,H=T.opacity?_.getAttributeValue(T.opacity.field,e):0;F=new w.FastUpdatePathGeometry(B,k,j,H)}else{var q=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(q[0]*=E(t.size[0],t.size[2],this.symbolLayer.width),q[1]*=E(t.size[2],t.size[0],this.symbolLayer.height));var W=null;this._drivenProperties.color&&(W=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(W=W?[W[0],W[1],W[2],t.opacity]:[1,1,1,t.opacity]);var X=new w.StaticPathGeometry(B);X.bake(q),W&&X.bakeVertexColors(W),F=X}var J=F.createGeometryData(),Z=new x(J,r+"path"+v),K={pathGeometry:F,geometrySR:c,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};Z.singleUse=!0,Z.metadata=K,o.push(Z),n.push(this._material),l.push(F.xform)}}var Q={layerUid:this._context.layer.uid,graphicUid:i};if(o.length>0){var Y=new D({geometries:o,materials:n,transformations:l,castShadow:!0,metadata:Q,idHint:r}),$=I,ee=new g(this,Y,o,null,null,$,a);return ee.alignedTerrainElevation=m.terrainElevation,ee.needsElevationUpdates=y.needsElevationUpdates3D(a.mode),ee}}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null},r.validGeometryTypes=["polyline"],r}(_.Graphics3DSymbolLayer);t.Graphics3DPathSymbolLayer=L;var A=f.makeDehydratedPoint(0,0,0,null),z=f.makeDehydratedPoint(0,0,0,null),O=f.makeDehydratedPoint(0,0,0,null),N=v.vec3f64.create(),G=m.vec3f32.create(),M=m.vec3f32.create();t.NUM_ROUND_JOIN_SUBDIVISIONS=3,t.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3,t.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;var B={verticalDistanceToGround:0,terrainElevation:0};t.default=L});