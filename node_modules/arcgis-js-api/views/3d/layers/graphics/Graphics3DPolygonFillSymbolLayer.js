// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../Color","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","./constants","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","./polygonUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/ColorMaterial","../../webgl-engine/materials/lineStippleUtils","../../webgl-engine/materials/NativeLineMaterial","../../webgl-engine/materials/RibbonLineMaterial"],function(e,t,a,i,r,n,o,l,s,u,p,c,d,h,y,m,g,_,f,v,x,E,b,O,D,P,G,C,M,T){Object.defineProperty(t,"__esModule",{value:!0});var A=function(e){function t(t,a,i,r){var n=e.call(this,t,a,i,r)||this;return n._hasOutline=!1,n}return a(t,e),t.prototype.doLoad=function(){return r(this,void 0,void 0,function(){return i(this,function(e){return this._prepareFillResources(),this._prepareOutlineResources(),[2]})})},t.prototype._prepareFillResources=function(){var e=l.get(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=new G({color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},this._getIdHint("_colormat")),this._context.stage.add(3,this._material)},t.prototype._prepareOutlineResources=function(){var e=this,t=this.symbolLayer.outline;if(this._isValidOutline(t)){this._hasOutline=!0;this._outlineMaterial=function(a){var i=t.stipplePattern?C.createStipplePattern(t.stipplePattern.map(s.pt2px)):null,r=t.stippleOffColor?o.toUnitRGBA(t.stippleOffColor):null;return a>1.5?new T({width:a,color:e._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:e._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},e._getIdHint("_outline_ribbonlinemat")):new M({color:e._getOutlineColor(),slicePlaneEnabled:e._context.slicePlaneEnabled,width:a,stipplePattern:i,stippleIntegerRepeats:!0,stippleOffColor:r},e._getIdHint("_outline_nativelinemat"))}(s.pt2px(t.size)),this._context.stage.add(3,this._outlineMaterial)}},t.prototype._isValidOutline=function(e){return l.isSome(e)&&e.size&&e.size>0&&l.isSome(e.color)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null),this._outlineMaterial&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)},t.prototype.createGraphics3DGraphic=function(e){var a=e.graphic;if(!this._validateGeometryType(a.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(a.geometry))return null;var i="graphic"+a.uid,r=this._getVertexOpacityAndColor(e.renderingInfo,Uint8Array,255),n=this.getGraphicElevationContext(a);return"on-the-ground"===n.mode?this._createAsOverlay(a,r,i):this._createAs3DShape(a,r,n,i,a.uid)},t.prototype.layerOpacityChanged=function(){var e=this._material.getParameters().color,t=l.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(t);if(this._material.setParameterValues({color:[e[0],e[1],e[2],a],transparent:a<1||this.needsDrivenTransparentPass}),this._outlineMaterial){var i=this._outlineMaterial.getParameters().color;this._outlineMaterial.setParameterValues({color:[i[0],i[1],i[2],this._getOutlineOpacity()]})}return!0},t.prototype.layerElevationInfoChanged=function(e,a,i){var r=this._elevationContext.mode,n=f.elevationModeChangeUpdateType(t.elevationModeChangeTypes,i,r);if(n!==f.SymbolUpdateType.UPDATE)return n;var o=f.needsElevationUpdates2D(r);return this.updateGraphics3DGraphicElevationInfo(e,a,function(){return o})},t.prototype.slicePlaneEnabledChanged=function(){if(this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._outlineMaterial){var e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(e)}return!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype.setDrawOrder=function(e,t,a){this.updateSymbolLayerOrder(e,t),this._material&&(this._material.renderPriority=e+t/2,a.add(this._material.id)),this._outlineMaterial&&(this._outlineMaterial.renderPriority=e,a.add(this._outlineMaterial.id))},t.prototype._createAs3DShape=function(e,t,a,i,r){var n=f.getGeometryAsPolygon(e.geometry),o=f.getGeometryVertexData3D(n.rings,n.hasZ,n.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,a,1);U.idHint=i,U.color=t,U.data=o;var l;if(this._hasOutline&&(l=new Float64Array(o.vertexData)),U.outNum=0,U.outGeometries=[],U.outTransforms=[],U.outMaterials=[],this._createAs3DShapeFill(U),U.data.vertexData=l,this._createAs3DShapeOutline(U),this._logGeometryCreationWarnings(U.data,n.rings,"rings","FillSymbol3DLayer"),0===U.outNum)return null;var s=new D({geometries:U.outGeometries,materials:U.outMaterials,transformations:U.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r},idHint:i}),u=m.perVertexElevationAligner,p=new _(this,s,U.outGeometries,null,null,u,a);return p.alignedTerrainElevation=o.terrainElevation,p.needsElevationUpdates=f.needsElevationUpdates2D(a.mode),p},t.prototype._createAs3DShapeFill=function(e){for(var t=e.data.geometryData.polygons,a=e.data.eleVertexData,i=e.data.vertexData,r=this,n=0;n<t.length;++n)!function(n){var o=t[n],l=o.count,s=o.index;if(r._context.clippingExtent&&(f.computeBoundingBox(a,s,l,S),f.boundingBoxClipped(S,r._context.clippingExtent)))return"continue";var d=new Float64Array(a.buffer,3*s*a.BYTES_PER_ELEMENT,3*l),h=o.holeIndices.map(function(e){return e-s}),y=u(d,h,3);if(0===y.length)return"continue";f.applyOrigin(i,s,l,B);var m=new Uint32Array(y),g=new Float64Array(i.buffer,3*s*i.BYTES_PER_ELEMENT,3*l),_=b.createPolygonGeometryData({indices:m,vertices:g,color:e.color,eleVertices:d}),v=new O(_,e.idHint);v.singleUse=!0;var x=c.mat4f64.create();p.mat4.translate(x,x,B),e.outGeometries.push(v),e.outMaterials.push(r._material),e.outTransforms.push(x),e.outNum++}(n)},t.prototype._createAs3DShapeOutline=function(e){if(this._hasOutline)for(var t=e.data.geometryData.outlines,a=e.data.eleVertexData,i=e.data.vertexData,r=0;r<t.length;++r){var n=t[r],o=n.index,l=n.count;if(!this._context.clippingExtent||(f.computeBoundingBox(a,o,l,S),!f.boundingBoxClipped(S,this._context.clippingExtent))){f.applyOrigin(i,o,l,B);var s=new Float64Array(a.buffer,3*o*a.BYTES_PER_ELEMENT,3*l),u=new Float64Array(i.buffer,3*o*i.BYTES_PER_ELEMENT,3*l),d=this._outlineMaterial instanceof M,h=E.createPolylineGeometry(u,s,y.WHITE,1,d?0:1),m=new O(h,e.idHint+"outline"+r);m.singleUse=!0;var g=c.mat4f64.create();p.mat4.translate(g,g,B),e.outGeometries.push(m),e.outMaterials.push(this._outlineMaterial),e.outTransforms.push(g),e.outNum++}}},t.prototype._createAsOverlay=function(e,t,a){var i=f.getGeometryAsPolygon(e.geometry);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2,this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);var r=f.getGeometryVertexDataDraped(i.rings,i.spatialReference,this._context.overlaySR,1);U.idHint=a,U.color=t,U.data=r;var n;return this._hasOutline&&(n=new Float64Array(r.vertexData)),U.outNum=0,U.outGeometries=[],U.outBoundingBox=h.empty(),U.layerUid=this._context.layer.uid,U.graphicsUid=e.uid,this._createAsOverlayFill(U),U.data.vertexData=n,this._createAsOverlayOutline(U),this._logGeometryCreationWarnings(U.data,i.rings,"rings","FillSymbol3DLayer"),U.outNum>0?new g(this,U.outGeometries,U.outBoundingBox):null},t.prototype._createAsOverlayFill=function(e){for(var t=e.data.vertexData,a=e.data.geometryData.polygons,i=this,r=0;r<a.length;++r)!function(r){var n=a[r],o=n.count,l=n.index;if(f.computeBoundingBox(t,l,o,S),f.boundingBoxClipped(S,i._context.clippingExtent))return"continue";var s=new Float64Array(t.buffer,3*l*t.BYTES_PER_ELEMENT,3*o),d=n.holeIndices.map(function(e){return e-l}),y=u(s,d,3);if(0===y.length)return"continue";h.expand(e.outBoundingBox,S),f.applyOrigin(t,l,o,B),f.setZ(t,l,o,i._getDrapedZ());for(var m=new Uint32Array(y.length),g=0;g<y.length;g++)m[g]=y[g]+l;var _=b.createPolygonGeometryData({indices:m,vertices:t,color:e.color}),v=new P(_);v.data.layerUid=e.layerUid,v.data.graphicUid=e.graphicsUid,v.material=i._material;var x=S;v.center=[.5*(x[0]+x[3]),.5*(x[1]+x[4]),0],v.bsRadius=.5*Math.sqrt((x[3]-x[0])*(x[3]-x[0])+(x[4]-x[1])*(x[4]-x[1]));var E=c.mat4f64.create();p.mat4.translate(E,E,B),v.transformation=E,v.name=e.idHint,v.uniqueName=e.idHint+"#"+_.id,e.outGeometries.push(v),e.outNum++}(r)},t.prototype._createAsOverlayOutline=function(e){if(this._hasOutline)for(var t=e.data.vertexData,a=e.data.geometryData.outlines,i=0;i<a.length;++i){var r=a[i],n=r.index,o=r.count;if(f.computeBoundingBox(t,n,o,S),!f.boundingBoxClipped(S,this._context.clippingExtent)){h.expand(e.outBoundingBox,S),f.applyOrigin(t,n,o,B),f.setZ(t,n,o,this._getDrapedZ());var l=new Float64Array(t.buffer,3*n*t.BYTES_PER_ELEMENT,3*o),s=this._outlineMaterial instanceof M,u=E.createPolylineGeometry(l,null,y.WHITE,1,s?0:1),d=new P(u);d.data.layerUid=e.layerUid,d.data.graphicUid=e.graphicsUid,d.material=this._outlineMaterial;var m=S;d.center=[.5*(m[0]+m[3]),.5*(m[1]+m[4]),0],d.bsRadius=.5*Math.sqrt((m[3]-m[0])*(m[3]-m[0])+(m[4]-m[1])*(m[4]-m[1]));var g=c.mat4f64.create();p.mat4.translate(g,g,B),d.transformation=g,d.name=e.idHint+"outline",d.uniqueName=e.idHint+"outline#"+u.id,e.outGeometries.push(d),e.outNum++}}},t.prototype._getOutlineOpacity=function(){var e=l.get(this.symbolLayer,"outline","color");return this._getLayerOpacity()*(l.isSome(e)?e.a:0)},t.prototype._getOutlineColor=function(){var e=l.get(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return x.mixinColorAndOpacity(l.isSome(e)?n.toUnitRGB(e):null,t)},t.validGeometryTypes=["polyline","polygon","extent"],t.elevationModeChangeTypes={definedChanged:f.SymbolUpdateType.RECREATE,staysOnTheGround:f.SymbolUpdateType.NONE,onTheGroundChanged:f.SymbolUpdateType.RECREATE},t}(v.default);t.Graphics3DPolygonFillSymbolLayer=A;var S=h.create(),B=d.vec3f64.create(),U={idHint:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null,color:null};t.default=A});