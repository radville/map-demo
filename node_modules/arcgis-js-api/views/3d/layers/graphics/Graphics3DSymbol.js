// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/maybe","../../../../core/promiseUtils","./Graphics3DGraphic","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolLayerFactory","./Loadable","./symbolComplexity"],function(e,r,t,o,s,a,n,i,y,l,c,h,u){return function(e){function r(r,t,o){var s=e.call(this)||this;return s._symbol=r,s._context=t,s._backgroundLayers=o,s._destroyed=!1,s.symbolLayers=[],s.referenced=0,s}return t(r,e),Object.defineProperty(r.prototype,"symbol",{get:function(){return this._symbol},set:function(e){if(this._symbol=e,this.symbolLayers)for(var r=0;r<e.symbolLayers.length;r++){var t=this.symbolLayers[r];n.isNone(t)||(t.symbol=e,t.symbolLayer=e.symbolLayers.items[r])}},enumerable:!0,configurable:!0}),r.prototype.doLoad=function(e){return s(this,void 0,void 0,function(){var r,t,y,l,h,u,p=this;return o(this,function(f){switch(f.label){case 0:for(r=this._symbol.symbolLayers,this._backgroundLayers&&(r=this._backgroundLayers.concat(r)),t=r.length;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);for(this.symbolLayers.length=r.length,y=this._context.layerOrder,l=function(o){var s=r.getItemAt(o);if(!1===s.enabled)return"continue";h._context.layerOrder=y+(1-(1+o)/t),h._context.layerOrderDelta=1/t;var a=c.make(h.symbol,s,h._context,s._ignoreDrivers);i.onAbortOrThrow(e,function(){p.symbolLayers[o]=null,a.destroy()}),h.symbolLayers[o]=a},h=this,u=0;u<t;u++)l(u);return this._context.layerOrder=y,[4,a.forEach(this.symbolLayers,function(e,r){return s(p,void 0,void 0,function(){var t;return o(this,function(o){switch(o.label){case 0:if(!n.isSome(e))return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,e.load()];case 2:return o.sent(),[3,4];case 3:return t=o.sent(),this.symbolLayers[r]=null,[3,4];case 4:return[2]}})})})];case 1:if(f.sent(),this.symbolLayers.length&&!this.symbolLayers.some(function(e){return!!e}))throw new Error;return[2]}})})},r.prototype.getSymbolLayerSize=function(e){var r=this.symbolLayers[e];return n.isSome(r)?r.getCachedSize():null},r.prototype.createGraphics3DGraphic=function(e,r){for(var t=e.graphic,o=new Array(this.symbolLayers.length),s=0;s<this.symbolLayers.length;s++){var a=this.symbolLayers[s];o[s]=n.isSome(a)?a.createGraphics3DGraphic(e):null}var i=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new y(t,r||this,o,e.layer,i)},Object.defineProperty(r.prototype,"complexity",{get:function(){return u.totalSymbolComplexities(this.symbolLayers.map(function(e){return n.isSome(e)&&e.complexity}))},enumerable:!0,configurable:!0}),r.prototype.globalPropertyChanged=function(e,r){for(var t=this.symbolLayers.length,o=this,s=0;s<t;s++){var a=function(t){var s=o.symbolLayers[t],a=function(e){var r=e._graphics[t];return r instanceof l?r:null};if(n.isSome(s)&&!s.globalPropertyChanged(e,r,a))return{value:!1}}(s);if("object"==typeof a)return a.value}return!0},r.prototype.applyRendererDiff=function(e,r){return 1===this.loadStatus&&this.symbolLayers.reduce(function(t,o){return t&&(n.isNone(o)||o.applyRendererDiff(e,r))},!0)},r.prototype.prepareSymbolPatch=function(e){if(2!==this.loadStatus&&"partial"===e.diff.type){var r=e.diff.diff;if(r.symbolLayers&&"partial"===r.symbolLayers.type){var t=r.symbolLayers.diff;this.symbolLayers.forEach(function(r,o){var s;if(!n.isNone(r)){var a=t[o];if(a){var i={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};r.prepareSymbolLayerPatch(i),(s=e.symbolStatePatches).push.apply(s,i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(function(e,r){var t=e._graphics[o];n.isSome(t)&&i.graphics3DGraphicPatches.forEach(function(e){return e(t,r)})})}}})}}},r.prototype.updateGeometry=function(e,r){for(var t=0;t<this.symbolLayers.length;t++){var o=this.symbolLayers[t];if(!n.isNone(o)){var s=e._graphics[t];if(n.isSome(s)&&!o.updateGeometry(s,r))return!1}}return!0},r.prototype.onRemoveGraphic=function(e){for(var r=0;r<this.symbolLayers.length;r++){var t=this.symbolLayers[r];if(!n.isNone(t)){var o=e._graphics[r];n.isSome(o)&&t.onRemoveGraphic(o)}}},r.prototype.getFastUpdateStatus=function(){var e=0,r=0,t=0;return this.symbolLayers.forEach(function(o){n.isNone(o)||(0===o.loadStatus?e++:o.isFastUpdatesEnabled()?t++:r++)}),{loading:e,slow:r,fast:t}},r.prototype.setDrawOrder=function(e,r){for(var t=this.symbolLayers.length,o=1/t,s=0;s<t;s++){var a=this.symbolLayers[s];if(n.isSome(a)){var i=e+(1-(1+s)/t);a.setDrawOrder(i,o,r)}}},r.prototype.destroy=function(){if(this.destroyed)return void console.error("Graphics3DSymbol.destroy called when already destroyed!");this.abortLoad();for(var e=0,r=this.symbolLayers;e<r.length;e++){var t=r[e];n.isSome(t)&&t.destroy()}this.symbolLayers.length=0,this._destroyed=!0},Object.defineProperty(r.prototype,"destroyed",{get:function(){return this._destroyed},enumerable:!0,configurable:!0}),r}(h.Loadable)});