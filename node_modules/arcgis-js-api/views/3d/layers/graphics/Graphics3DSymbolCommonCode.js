// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../geometry","../../../../core/compilerUtils","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/coordsUtils","../../../../geometry/support/triangulationUtils","../../../../layers/graphics/dehydratedFeatures","./graphicUtils","../../support/projectionUtils","../../webgl-engine/lib/Object3D"],function(e,t,r,n,a,o,i,l,u,c,s,f,v){function d(e,t,r,n,a,i,l,u,c,s,f,d){var p=r?r.length:0,g=e.clippingExtent;if(R(t,_,e.elevationProvider.spatialReference),g&&!N(_,g))return null;R(t,_,e.renderSpatialReference);for(var y=e.localOriginFactory.getOrigin(_),h=!!f,E=new v({castShadow:!1,metadata:{layerUid:c,graphicUid:s,usesVerticalDistanceToGround:h},idHint:u}),b=0;b<p;b++){var x=a?a[b]:o.mat4f64.IDENTITY;E.addGeometry(r[b],n[b],x,i,y,d)}return{object:E,terrainElevation:m(E,t,l,e.renderSpatialReference,e.elevationProvider,e.renderCoordsHelper).terrainElevation}}function p(e,t,r){var n=e.elevationContext,a=r.spatialReference;R(t,_,a),n.centerPointInElevationSR=c.makeDehydratedPoint(_[0],_[1],t.hasZ?_[2]:0,a)}function g(e){switch(e.type){case"point":return e;case"polygon":case"extent":return s.computeCentroid(e);case"polyline":var t=e.paths[0];if(!t||0===t.length)return null;var r=l.getPointOnPath(t,l.getPathLength(t)/2);return c.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference);case"mesh":return e.extent.center}return null}function y(e,t,r,a,o){var i=t.z||0,l=r.featureExpressionInfoContext;switch(r.mode){case"on-the-ground":var u=e.getElevation(t,"ground")||0;return o&&(o.verticalDistanceToGround=0,o.terrainElevation=u),u;case"relative-to-ground":var c=e.getElevation(t,"ground")||0,u=r.calculateOffsetRenderUnits(a);return null==l&&(u+=i),o&&(o.verticalDistanceToGround=u,o.terrainElevation=c),u+c;case"relative-to-scene":var c=e.getElevation(t,"scene")||0,u=r.calculateOffsetRenderUnits(a);return o&&(o.verticalDistanceToGround=u,o.terrainElevation=c),u+c;case"absolute-height":var u=r.calculateOffsetRenderUnits(a);if(null==l&&(u+=i),o){var c=e.getElevation(t,"ground")||0;o.verticalDistanceToGround=u-c,o.terrainElevation=c}return u;default:n.neverReached(r.mode)}return 0}function h(e,t,r,n,a,o,i,l){var u=l.mode,c=0,s=0,f=0,v=l.calculateOffsetRenderUnits(i),d=l.featureExpressionInfoContext;k.spatialReference=e.spatialReference,r*=3,a*=3;for(var p=0;p<o;++p){switch(k.x=t[r+0],k.y=t[r+1],k.z=t[r+2],u){case"on-the-ground":c=e.getElevation(k)||0,s=c,f+=c;break;case"relative-to-ground":c=e.getElevation(k)||0,s=c+v,null==d&&(s+=k.z),f+=c;break;case"relative-to-scene":c=e.getElevation(k,"scene")||0,s=c+v,f+=c;break;case"absolute-height":s=v,null==d&&(s+=k.z)}n[a+0]=t[r+0],n[a+1]=t[r+1],n[a+2]=s,r+=3,a+=3}return f/=o,{terrainElevation:f}}function m(e,t,r,n,o,i){var l,u=0;if(e.metadata.usesVerticalDistanceToGround)u=y(o,t,r,i,q),s.updateVertexAttributeAuxpos1w(e,q.verticalDistanceToGround),l=q.terrainElevation;else{var c="absolute-height"!==r.mode;u=y(o,t,r,i,c?q:null),c&&(l=q.terrainElevation)}var v=a.mat4.copy(B,e.objectTransformation);return _[0]=t.x,_[1]=t.y,_[2]=u,f.computeLinearTransformation(t.spatialReference,_,v,n)?e.objectTransformation=v:console.warn("Could not locate symbol object properly, it might be misplaced"),{terrainElevation:l}}function E(e,t,r){var n=u.pathsToTriangulationInfo(e,t,r);return{vertexData:n.position,polygons:n.polygons,outlines:n.outlines}}function b(e,t,r,n,a){t*=3,n*=3;for(var o=0;o<a;++o)r[n++]=e[t++],r[n++]=e[t++],r[n++]=e[t++]}function x(e,t,r,n){var a=Math.floor(t+(r-1)/2);n[0]=e[3*a+0],n[1]=e[3*a+1],n[2]=e[3*a+2],t*=3;for(var o=0;o<r;++o)e[t++]-=n[0],e[t++]-=n[1],e[t++]-=n[2]}function D(e,t,r,n){t*=3;for(var a=0;a<r;++a)e[t+2]=n,t+=3}function T(e,t,r,n){t*=3;for(var a=0;a<r;++a)e[t+2]+=n,t+=3}function A(e,t,r,n){t*=3;for(var a=0;a<r;++a)e[t+2]*=n,t+=3}function U(e,t,r){var n=[];t*=3;for(var a=0;a<r;++a)n.push([e[t++],e[t++],e[t++]]);return n}function P(e,t,r,n,a,o,i){return f.bufferToBuffer(e,r,t,n,o,a,i)}function R(e,t,r){f.pointToVector(e,t,r)}function G(e,t,r,n,a,o,i,l){var u=a.spatialReference,c=E(e,t,l),s=c.vertexData,f=s.length/3,v=new Float64Array(s.length),d=!0;r.equals(u)?b(s,0,v,0,s.length):d=P(s,0,r,v,0,u,f);var p=h(a,v,0,s,0,f,o,i);return u.equals(n)||P(s,0,u,s,0,n,f),{geometryData:c,vertexData:s,projectionSuccess:d,eleVertexData:v,terrainElevation:p.terrainElevation}}function O(e,t,r,n){var a=E(e,!1,n),o=a.vertexData,i=o.length/3,l=!0;return t.equals(r)||(l=f.bufferToBuffer(o,t,0,o,r,0,i)),{geometryData:a,vertexData:o,projectionSuccess:l}}function V(e,t,r,n){n[0]=Number.MAX_VALUE,n[1]=Number.MAX_VALUE,n[2]=Number.MAX_VALUE,n[3]=-Number.MAX_VALUE,n[4]=-Number.MAX_VALUE,n[5]=-Number.MAX_VALUE,t*=3;for(var a=0;a<r;++a){var o=e[t++],i=e[t++],l=e[t++];o<n[0]&&(n[0]=o),i<n[1]&&(n[1]=i),l<n[2]&&(n[2]=l),o>n[3]&&(n[3]=o),i>n[4]&&(n[4]=i),l>n[5]&&(n[5]=l)}return n}function C(e,t,r){return null==t||null==r?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===r?e.staysOnTheGround:t===r||"on-the-ground"!==t&&"on-the-ground"!==r?X.UPDATE:e.onTheGroundChanged}function j(e){switch(e.type){case"extent":return r.Polygon.fromExtent(e);case"polygon":return e}return null}function w(e){switch(e.type){case"extent":return r.Polygon.fromExtent(e);case"polygon":case"polyline":return e}return null}function N(e,t){return!(e[0]>t[3]||e[0]<t[0]||e[1]>t[4]||e[1]<t[1])}function M(e,t){return!(t[0]>e[3]||t[3]<e[0]||t[1]>e[4]||t[4]<e[1])}function S(e,t){return!!t&&!M(e,t)}function I(e){return"relative-to-ground"===e||"relative-to-scene"===e}function L(e){return"absolute-height"!==e}Object.defineProperty(t,"__esModule",{value:!0});var _=i.vec3f64.create(),k=c.makeDehydratedPoint(0,0,0,null);t.createStageObjectForPoint=d,t.extendPointGraphicElevationContext=p,t.placePointOnGeometry=g,t.computeElevation=y,t.applyElevation=h;var B=o.mat4f64.create();t.copyPathData=E,t.copyVertices=b,t.applyOrigin=x,t.setZ=D,t.offsetZ=T,t.scaleZ=A,t.flatArrayToArrayOfArrays=U,t.reproject=P,t.reprojectPoint=R,t.getGeometryVertexData3D=G,t.getGeometryVertexDataDraped=O,t.computeBoundingBox=V;var X;!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(X=t.SymbolUpdateType||(t.SymbolUpdateType={})),t.elevationModeChangeUpdateType=C,t.getGeometryAsPolygon=j,t.getGeometryAsPoly=w,t.pointInBox2D=N,t.boxesIntersect2D=M,t.boundingBoxClipped=S,t.needsElevationUpdates2D=I,t.needsElevationUpdates3D=L;var q={verticalDistanceToGround:0,terrainElevation:0}});