// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/Error","../../../../core/maybe","../../../../core/ObjectPool","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2f64","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextRenderParameters","../../webgl-engine/lib/TextTexture","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,n,o,i,a,l,s,c,p,d,u,h,f,y,g,m,v,b,x,S){function P(e,t,r){e&&e.forEach(function(e){var n=t(e);a.isSome(n)&&r(n,e.graphic)})}Object.defineProperty(t,"__esModule",{value:!0});var O=[0,0,1],_=function(e){function t(t,r,n,o){var i=e.call(this,t,r,n,o)||this;return i._geometryDataPool=new l(m.GeometryData,function(e,t,r){var n=t.translation,o=a.isSome(r)?[r.displayWidth,r.displayHeight]:[0,0],i=t.centerOffset;if(0===e.indexCount){var l=O,s=[0,0];v.createPointGeometry(l,n,null,o,i,s,null,e)}else v.updatePointGeometry(null,n,null,o,i,null,null,e)}),i._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},i}return r(t,e),t.prototype.doLoad=function(){return o(this,void 0,void 0,function(){var e;return n(this,function(t){if(!this._drivenProperties.size&&(e=y.validateSymbolLayerSize(this.symbolLayer.size)))throw new i("graphics3dtextsymbollayer:invalid-size",e);return this._createTextRenderParameters(),[2]})})},t.prototype._createTextRenderParameters=function(){var e=this._context.layerView.view.pixelRatio;this._textRenderParameters=b.default.fromSymbol(this.symbolLayer,e)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._geometryDataPool.destroy()},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic,r=h.placePointOnGeometry(t.geometry);if(a.isNone(r))return this.logger.warn("unsupported geometry type for text symbol: "+t.geometry.type),null;var n=this.symbolLayer.text;if(!n)return null;var o=p.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,r,n,o)},t.prototype.onRemoveGraphic=function(e){this._geometryDataPool.release(e.stageObject.geometries[0].data)},t.prototype.createLabel=function(e,t,r,n){var o=e.graphic,i=h.placePointOnGeometry(o.geometry);if(a.isNone(i))return this.logger.warn("unsupported geometry type for label: "+o.geometry.type),null;var l=t.text;return l?this._createAs3DShape(o,i,l,t,t,r,n):null},t.prototype.getGraphicElevationContext=function(t,r){void 0===r&&(r=0);var n=e.prototype.getGraphicElevationContext.call(this,t);return n.addOffsetRenderUnits(r),n},t.prototype.layerOpacityChanged=function(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},t.prototype.layerElevationInfoChanged=function(e,t){var r=this;return P(e,t,function(e,t){r.updateGraphicElevationContext(t,e)}),h.SymbolUpdateType.UPDATE},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return P(e,t,function(e){for(var t=0,n=e.stageObject.geometryRecords;t<n.length;t++){n[t].material.setParameterValues({slicePlaneEnabled:r._context.slicePlaneEnabled})}}),!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!1},t.prototype.updateGraphicElevationContext=function(e,t){var r=this.getGraphicElevationContext(e,t.metadata.elevationOffset);t.elevationContext.set(r),t.needsElevationUpdates=h.needsElevationUpdates2D(r.mode)||"absolute-height"===r.mode},t.prototype._defaultElevationInfoNoZ=function(){return E},t.prototype._createAs3DShape=function(e,t,r,n,o,i,l){void 0===o&&(o=w);var p=this.getGraphicElevationContext(e,o.elevationOffset),f=this._context.layer.id+"_label_"+e.uid,m="polyline"===a.get(e.geometry,"type"),v=e.uid,b=this._context.stage.renderView.renderingContext,P=o.anchor in y.namedAnchorToHUDMaterialAnchorPos?o.anchor:"center",O=y.namedAnchorToHUDMaterialAnchorPos[P],_=a.isNone(l)?new x(b,r,this._textRenderParameters,f):null,E={occlusionTest:!0,screenOffset:o.screenOffset,anchorPos:O,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:o.centerOffsetUnits,debugDrawBorder:o.debugDrawBorder,drawInSecondSlot:!0};if(a.isSome(_)&&(E.textureId=_.id,E.texCoordScale=_.texcoordScale),a.isSome(l)&&(E.textureId=l.textureId),a.isSome(n)&&a.isSome(n.verticalOffset)){var D=n.verticalOffset,G=D.screenLength,C=D.minWorldLength,L=D.maxWorldLength;E.verticalOffset={screenLength:s.pt2px(G),minWorldLength:C||0,maxWorldLength:null!=L?L:1/0}}if(this._context.screenSizePerspectiveEnabled){var U=this._context.sharedResources,T=U.screenSizePerspectiveSettings,R=U.screenSizePerspectiveSettingsLabels;E.screenSizePerspective=R.overridePadding(this._textRenderParameters.haloSize),E.screenSizePerspectiveAlignment=T}m&&(E.shaderPolygonOffset=1e-4),E.slicePlaneEnabled=this._context.slicePlaneEnabled;var A=null,z=JSON.stringify(E);a.isSome(i)?null==(A=i.getMaterial(z))&&(A=new S(E,f),i.addMaterial(z,A)):A=new S(E,f);var j=[A],H=this._geometryDataPool.acquire(o,_),W=[new g(H,f)],I=this._context.layer.uid,M=h.createStageObjectForPoint(this._context,t,W,j,null,null,p,f,I,v,!0);if(null===M)return null;var N=d.perObjectElevationAligner,V=new u(this,M.object,W,a.isNone(i)?j:null,a.isSome(_)?[_]:null,N,p);V.alignedTerrainElevation=M.terrainElevation,V.needsElevationUpdates=h.needsElevationUpdates2D(p.mode)||"absolute-height"===p.mode;var B=a.isSome(_)?_:o,q=B.displayWidth,F=B.displayHeight;V.getScreenSize=function(e){return void 0===e&&(e=c.vec2f64.create()),e[0]=q,e[1]=F,e};var J={labelText:r,elevationOffset:o.elevationOffset};return V.metadata=J,h.extendPointGraphicElevationContext(V,t,this._context.elevationProvider),V},t}(f.default);t.Graphics3DTextSymbolLayer=_;var E={mode:"relative-to-ground",offset:0},w={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};t.default=_});