// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../Color","../../../../core/maybe","../../../../core/unitUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4","../../../../core/libs/gl-matrix-2/math/common","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./polygonUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/materials/WaterMaterial","../../webgl-engine/materials/internal/waterMaterialUtils"],function(e,t,r,a,i,o,n,s,l,d,u,c,p,h,y,m,g,v,f,_,x,b,E,D,S,w,G,P,T,C){Object.defineProperty(t,"__esModule",{value:!0});var M=function(e){function t(t,r,a,i){return e.call(this,t,r,a,i)||this}return a(t,e),t.prototype.doLoad=function(){return o(this,void 0,void 0,function(){var e,t;return i(this,function(a){return e=C.waterParameterDefaultsLocal,t=r({},e),this._updateMaterialParameters(t),t.isDraped=!0,this._drapedMaterial=new T.WaterMaterial(t,"waterDraped"),this._context.stage.add(3,this._drapedMaterial),this._updateMaterialParameters(e),this._material=new T.WaterMaterial(e,"water"),this._context.stage.add(3,this._material),[2]})})},t.prototype.destroy=function(){e.prototype.destroy.call(this),this._material&&(this._context.stage.remove(3,this._material.id),this._material=null),this._drapedMaterial&&(this._context.stage.remove(3,this._drapedMaterial.id),this._drapedMaterial=null)},t.prototype.createGraphics3DGraphic=function(e){var r=e.graphic;if(!this._validateGeometryType(r.geometry,t.validGeometryTypes,this.symbolLayer.type))return null;if(!this._validateGeometry(r.geometry))return null;var a="graphic"+r.uid,i=this.getGraphicElevationContext(r);return"on-the-ground"===i.mode?this._createAsOverlay(r,a):this._createAs3DShape(r,i,a,r.uid)},t.prototype.layerOpacityChanged=function(){var e=this._material.getParameters().color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;return this._material.setParameterValues({color:[e[0],e[1],e[2],t],transparent:r}),this._drapedMaterial.setParameterValues({color:[e[0],e[1],e[2],t],transparent:r}),!0},t.prototype.layerElevationInfoChanged=function(e,r,a){var i=this._elevationContext.mode,o=E.elevationModeChangeUpdateType(t.elevationModeChangeTypes,a,i);if(o!==E.SymbolUpdateType.UPDATE)return o;var n=E.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(e,r,function(){return n})},t.prototype.slicePlaneEnabledChanged=function(){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._drapedMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.physicalBasedRenderingChanged=function(){return!0},t.prototype.pixelRatioChanged=function(){return!0},t.prototype.setDrawOrder=function(e,t,r){this.updateSymbolLayerOrder(e,t),this._material&&(this._material.renderPriority=e+t/2,r.add(this._material.id)),this._drapedMaterial&&(this._drapedMaterial.renderPriority=e+t/2,r.add(this._drapedMaterial.id))},t.prototype._createAs3DShape=function(e,t,r,a){var i=E.getGeometryAsPolygon(e.geometry),o=E.getGeometryVertexData3D(i.rings,i.hasZ,i.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,t,1),n=o.vertexData.length/3;if(o.uvCoords=new Float64Array(2*n),L.idHint=r,L.data=o,L.outNum=0,L.outGeometries=[],L.outTransforms=[],L.outMaterials=[],this._create3DShapeGeometries(L),this._logGeometryCreationWarnings(L.data,i.rings,"rings","WaterSymbol3DLayer"),0===L.outNum)return null;this._createUVCoordsFromVertices(L.data.uvCoords,L.data.eleVertexData,n,this._context.elevationProvider.spatialReference);var s=new G({geometries:L.outGeometries,materials:L.outMaterials,transformations:L.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a},idHint:r}),l=_.perVertexElevationAligner,d=new b(this,s,L.outGeometries,null,null,l,t);return d.alignedTerrainElevation=o.terrainElevation,d.needsElevationUpdates=E.needsElevationUpdates2D(t.mode),d},t.prototype._createUVCoordsFromVertices=function(e,r,a,i){var o=l.getMetersPerUnitForSR(i);f.empty(A);for(var n=0;n<a;n++)p.vec2.set(R,r[3*n+0],r[3*n+1]),f.expandPointInPlace(A,R);m.vec4.scale(A,A,o);var s=A[0]%t.unitSizeOfTexture,d=A[1]%t.unitSizeOfTexture;U[0]=A[0]-s,U[1]=A[1]-d;for(var n=0;n<a;n++)e[2*n+0]=(r[3*n+0]*o-U[0])/t.unitSizeOfTexture,e[2*n+1]=(r[3*n+1]*o-U[1])/t.unitSizeOfTexture},t.prototype._create3DShapeGeometries=function(e){for(var t=e.data.geometryData.polygons,r=e.data.eleVertexData,a=e.data.vertexData,i=e.data.uvCoords,o=0,n=t;o<n.length;o++){var s=n[o],l=s.count,d=s.index;if(!this._context.clippingExtent||(E.computeBoundingBox(r,d,l,B),!E.boundingBoxClipped(B,this._context.clippingExtent))){var p=new Float64Array(r.buffer,3*d*r.BYTES_PER_ELEMENT,3*l),h=this._runEarcut(p,s);if(0!==h.length){var y=new Uint32Array(h);E.applyOrigin(a,d,l,O);var m=new Float64Array(a.buffer,3*d*a.BYTES_PER_ELEMENT,3*l),g=new Float64Array(i.buffer,2*d*i.BYTES_PER_ELEMENT,2*l),v=S.createPolygonGeometryData({indices:y,vertices:m,uv0:g,eleVertices:p}),f=new w(v,e.idHint);f.singleUse=!0;var _=c.mat4f64.create();u.mat4.translate(_,_,O),e.outGeometries.push(f),e.outMaterials.push(this._material),e.outTransforms.push(_),e.outNum++}}}},t.prototype._updateMaterialParameters=function(e){var r=this.symbolLayer.color;s.isSome(r)&&(e.color=n.toUnitRGBA(r));var a=this._getCombinedOpacity(r,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],a],e.transparent=a<1||this.needsDrivenTransparentPass,e.waveDirection=s.isSome(this.symbolLayer.waveDirection)?t.headingVectorFromAngle(this.symbolLayer.waveDirection):h.vec2f64.fromValues(0,0);var i=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,o=C.wavePresets[i];e.waveStrength=o.waveStrength,e.waveTextureRepeat=o.textureRepeat,e.waveVelocity=o.waveVelocity,e.flowStrength=o.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled},t.prototype._createAsOverlay=function(e,t){var r=E.getGeometryAsPolygon(e.geometry);this._drapedMaterial.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;var a=E.getGeometryVertexDataDraped(r.rings,r.spatialReference,this._context.overlaySR,1);L.idHint=t,L.data=a;var i=a.vertexData.length/3;return a.uvCoords=new Float64Array(2*i),L.outNum=0,L.outGeometries=[],L.outBoundingBox=v.empty(),L.layerUid=this._context.layer.uid,L.graphicsUid=e.uid,this._createAsOverlayWater(L),this._logGeometryCreationWarnings(L.data,r.rings,"rings","WaterSymbol3DLayer"),0===L.outNum?null:(this._createUVCoordsFromVertices(L.data.uvCoords,L.data.vertexData,i,r.spatialReference),L.outNum>0?new x(this,L.outGeometries,L.outBoundingBox):null)},t.prototype._runEarcut=function(e,t){var r=t.holeIndices.map(function(e){return e-t.index});return d(e,r,3)},t.prototype._createAsOverlayWater=function(e){for(var t=e.data.vertexData,r=e.data.uvCoords,a=e.data.geometryData.polygons,i=0,o=a;i<o.length;i++){var n=o[i],s=n.count,l=n.index;if(E.computeBoundingBox(t,l,s,B),!E.boundingBoxClipped(B,this._context.clippingExtent)){v.expand(e.outBoundingBox,B);var d=new Float64Array(t.buffer,3*l*t.BYTES_PER_ELEMENT,3*s),p=this._runEarcut(d,n);if(0!==p.length){var h=new Uint32Array(p);E.applyOrigin(t,l,s,O),E.setZ(t,l,s,this._getDrapedZ());var y=new Float64Array(r.buffer,2*l*r.BYTES_PER_ELEMENT,2*s),m=S.createPolygonGeometryData({indices:h,vertices:d,uv0:y}),g=new P(m);g.data.layerUid=e.layerUid,g.data.graphicUid=e.graphicsUid,g.material=this._drapedMaterial;var f=B;g.center=[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0],g.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]));var _=c.mat4f64.create();u.mat4.translate(_,_,O),g.transformation=_,g.name=e.idHint,g.uniqueName=e.idHint+"#"+m.id,e.outGeometries.push(g),e.outNum++}}}},t.headingVectorFromAngle=function(e){var t=h.vec2f64.create(),r=g.toRadian(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{create3DShape:function(t){return e._createAs3DShape(t.graphic,t.elevationContext,t.idHint,t.graphicUid)}}},enumerable:!0,configurable:!0}),t.validGeometryTypes=["polyline","polygon","extent"],t.unitSizeOfTexture=100,t.elevationModeChangeTypes={definedChanged:E.SymbolUpdateType.RECREATE,staysOnTheGround:E.SymbolUpdateType.NONE,onTheGroundChanged:E.SymbolUpdateType.RECREATE},t}(D.default);t.Graphics3DWaterSymbolLayer=M;var U=h.vec2f64.create(),A=f.create(),R=h.vec2f64.create(),B=v.create(),O=y.vec3f64.create(),L={idHint:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};t.default=M});