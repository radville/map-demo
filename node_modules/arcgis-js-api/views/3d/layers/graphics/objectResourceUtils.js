// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/tsSupport/assignHelper","../../../../core/devEnvironmentUtils","../../../../core/mathUtils","../../../../core/maybe","../../../../core/string","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../glTF/DefaultLoadingContext","../../glTF/esriProvidedModelParameters","../../glTF/loader","../../glTF/internal/indexUtils","./wosrLoader","../../support/buffer/BufferView","../../support/buffer/math","../../support/buffer/utils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(e,t,r,o,i,s,a,u,n,l,c,f,m,d,g,p,x,v,b,h,w,B,M,S,y,T,R,V,C,E){function O(e,t){return void 0===t&&(t={}),i(this,void 0,void 0,function(){var r,i,u,n,l,c,f,m,d,g,p;return o(this,function(o){switch(o.label){case 0:return r=A(a.adjustStaticAGOUrl(e)),"wosr"!==r.fileType?[3,2]:[4,B.load(r.url,t)];case 1:return i=o.sent(),[2,{lods:[i],referenceBoundingBox:i.boundingBox,isEsriSymbolResource:!1,isWosr:!0}];case 2:return u=new v.DefaultLoadingContext(t.streamDataRequester),[4,h.load(u,r.url,t)];case 3:return n=o.sent(),(_(n),P(n),l=L(n,t.usePBR),c=s({},t.materialParamsMixin,{treeRendering:n.customMeta.esriTreeRendering}),null!=r.specifiedLodIndex)?(f=F(n,l,c,r.specifiedLodIndex),m=f[0].boundingBox,0!==r.specifiedLodIndex&&(d=F(n,l,c,r.specifiedLodIndex),m=d[0].boundingBox),[2,{lods:f,referenceBoundingBox:m,isEsriSymbolResource:n.meta.isEsriSymbolResource,isWosr:!1}]):(g=F(n,l,c),p=g[0].boundingBox,[2,{lods:g,referenceBoundingBox:p,isEsriSymbolResource:n.meta.isEsriSymbolResource,isWosr:!1}])}})})}function A(e){var t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function L(e,t){return e.meta.isEsriSymbolResource?E.getDefaultPBRMaterialParameters(t,e.customMeta.esriTreeRendering):{usePBR:!0}}function F(e,t,r,o){var i=e.model,a=f.mat3f64.create(),u=new Array,l=new Map,m=new Map;return i.lods.forEach(function(e,f){if(void 0===o||f===o){var d=0,g={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:n.isSome(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:x.empty()};u.push(g),e.parts.forEach(function(o){var u=o.material+(o.attributes.normal?"_normal":"")+(o.attributes.color?"_color":"")+(o.attributes.texCoord0?"_texCoord0":"")+(o.attributes.tangent?"_tangent":""),f=i.materials.get(o.material),p=n.isSome(o.attributes.texCoord0),v=n.isSome(o.attributes.normal);if(!l.has(u)){if(p){if(n.isSome(f.textureColor)&&!m.has(f.textureColor)){var b=i.textures.get(f.textureColor),h=s({},b.parameters,{preMultiplyAlpha:!0});m.set(f.textureColor,new V(b.data,f.textureColor,h))}if(n.isSome(f.textureNormal)&&!m.has(f.textureNormal)){var b=i.textures.get(f.textureNormal),h=s({},b.parameters,{preMultiplyAlpha:!0});m.set(f.textureNormal,new V(b.data,f.textureNormal,h))}if(n.isSome(f.textureOcclusion)&&!m.has(f.textureOcclusion)){var b=i.textures.get(f.textureOcclusion),h=s({},b.parameters,{preMultiplyAlpha:!0});m.set(f.textureOcclusion,new V(b.data,f.textureOcclusion,h))}if(n.isSome(f.textureEmissive)&&!m.has(f.textureEmissive)){var b=i.textures.get(f.textureEmissive),h=s({},b.parameters,{preMultiplyAlpha:!0});m.set(f.textureEmissive,new V(b.data,f.textureEmissive,h))}if(n.isSome(f.textureMetallicRoughness)&&!m.has(f.textureMetallicRoughness)){var b=i.textures.get(f.textureMetallicRoughness),h=s({},b.parameters,{preMultiplyAlpha:!0});m.set(f.textureMetallicRoughness,new V(b.data,f.textureMetallicRoughness,h))}}var w=C.COLOR_GAMMA,B=Math.pow(f.color[0],1/w),E=Math.pow(f.color[1],1/w),O=Math.pow(f.color[2],1/w),A=Math.pow(f.emissiveFactor[0],1/w),L=Math.pow(f.emissiveFactor[1],1/w),F=Math.pow(f.emissiveFactor[2],1/w);l.set(u,new C(s({},t,{transparent:"BLEND"===f.alphaMode,textureAlphaMode:I(f.alphaMode),textureAlphaCutoff:f.alphaCutoff,diffuse:[B,E,O],ambient:[B,E,O],opacity:f.opacity,doubleSided:f.doubleSided,doubleSidedType:"winding-order",cullFace:f.doubleSided?0:2,vertexColors:!!o.attributes.color,vertexTangents:!!o.attributes.tangent,normals:v?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:n.isSome(f.textureColor)&&p?m.get(f.textureColor).id:void 0,colorMixMode:f.colorMixMode,normalTextureId:n.isSome(f.textureNormal)&&p?m.get(f.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:n.isSome(f.textureOcclusion)&&p?m.get(f.textureOcclusion).id:void 0,emissiveTextureId:n.isSome(f.textureEmissive)&&p?m.get(f.textureEmissive).id:void 0,metallicRoughnessTextureId:n.isSome(f.textureMetallicRoughness)&&p?m.get(f.textureMetallicRoughness).id:void 0,emissiveFactor:[A,L,F],metallicFactor:f.metallicFactor,roughnessFactor:f.roughnessFactor},r),u))}var N=D(o.indices||o.attributes.position.count,o.primitiveType),_={},P={},U=o.attributes.position.count,z=y.createBuffer(M.BufferViewVec3f,U);if(S.vec3.transformMat4(z,o.attributes.position,o.transform),P.position={data:z.typedBuffer,size:z.elementCount},_.position=N,n.isSome(o.attributes.normal)){var G=y.createBuffer(M.BufferViewVec3f,U);c.mat3.normalFromMat4(a,o.transform),S.vec3.transformMat3(G,o.attributes.normal,a),P.normal={data:G.typedBuffer,size:G.elementCount},_.normal=N}if(n.isSome(o.attributes.tangent)){var j=y.createBuffer(M.BufferViewVec4f,U);c.mat3.normalFromMat4(a,o.transform),S.vec4.transformMat3(j,o.attributes.tangent,a),P.tangent={data:j.typedBuffer,size:j.elementCount},_.tangent=N}if(n.isSome(o.attributes.texCoord0)){var H=y.createBuffer(M.BufferViewVec2f,U);y.vec2.normalizeIntegerBuffer(H,o.attributes.texCoord0),P.uv0={data:H.typedBuffer,size:H.elementCount},_.uv0=N}if(n.isSome(o.attributes.color)){var W=y.createBuffer(M.BufferViewVec4u8,U);if(4===o.attributes.color.elementCount)o.attributes.color instanceof M.BufferViewVec4f?S.vec4.scale(W,o.attributes.color,255):o.attributes.color instanceof M.BufferViewVec4u8?y.vec4.copy(W,o.attributes.color):o.attributes.color instanceof M.BufferViewVec4u16&&S.vec4.scale(W,o.attributes.color,1/256);else{y.vec4.fill(W,255,255,255,255);var q=new M.BufferViewVec3u8(W.buffer,0,4);o.attributes.color instanceof M.BufferViewVec3f?S.vec3.scale(q,o.attributes.color,255):o.attributes.color instanceof M.BufferViewVec3u8?y.vec3.copy(q,o.attributes.color):o.attributes.color instanceof M.BufferViewVec3u16&&S.vec3.scale(q,o.attributes.color,1/256)}P.color={data:W.typedBuffer,size:W.elementCount},_.color=N}var k=new T(new R.GeometryData(P,_),"gltf_"+e.name+"_"+d++);g.stageResources.geometries.push(k),g.stageResources.materials.push(l.get(u)),p&&(n.isSome(f.textureColor)&&g.stageResources.textures.push(m.get(f.textureColor)),n.isSome(f.textureNormal)&&g.stageResources.textures.push(m.get(f.textureNormal)),n.isSome(f.textureOcclusion)&&g.stageResources.textures.push(m.get(f.textureOcclusion)),n.isSome(f.textureEmissive)&&g.stageResources.textures.push(m.get(f.textureEmissive)),n.isSome(f.textureMetallicRoughness)&&g.stageResources.textures.push(m.get(f.textureMetallicRoughness))),g.numberOfVertices+=U;var $=k.boundingInfo;x.expand(g.boundingBox,$.getBBMin()),x.expand(g.boundingBox,$.getBBMax())})}}),u}function I(e){switch(e){case"BLEND":return"blend";case"MASK":return"mask";case"OPAQUE":return"opaque";default:return"blend"}}function D(e,t){switch(t){case 4:return w.trianglesToTriangles(e);case 5:return w.triangleStripToTriangles(e);case 6:return w.triangleFanToTriangles(e)}}function N(e,t){void 0===e&&(e=""),void 0===t&&(t="");var r=l.endsWith(e,"Imposter"),o=e.split("__")[0];if(-1!==t.indexOf("/RealisticTrees/")){var i=b.treeParamsTable[o];if(i)return{crownCenter:i.center,crownDimensions:i.radius,imposter:r}}}function _(e){if(e.meta.isEsriSymbolResource)for(var t=0,r=e.model.lods;t<r.length;t++){var o=r[t],i=N(o.name,e.meta.uri);if(!i)return;e.customMeta.esriTreeRendering=!0;for(var s=0,a=o.parts;s<a.length;s++){var l=a[s],c=l.attributes.normal;if(n.isNone(c))return;for(var f=l.attributes.position,x=f.count,v=p.vec3f64.create(),b=p.vec3f64.create(),h=p.vec3f64.create(),w=y.createBuffer(M.BufferViewVec4u8,x),B=y.createBuffer(M.BufferViewVec3f,x),S=m.mat4.invert(d.mat4f64.create(),l.transform),T=g.vec3.transformMat4(p.vec3f64.create(),i.crownCenter,S),R=g.vec3.transformMat4(p.vec3f64.create(),i.crownDimensions,S),V=0;V<x;V++){f.getVec(V,b),c.getVec(V,v),g.vec3.subtract(h,b,T),g.vec3.divide(h,h,R);var C=u.clamp(g.vec3.length(h),0,1),E=.6+.4*C*C;g.vec3.lerp(h,h,v,.2),B.setVec(V,h),w.set(V,0,255*E),w.set(V,1,255*E),w.set(V,2,255*E),w.set(V,3,255)}l.attributes.normal=B,l.attributes.color=w}}}function P(e){var t=e.model.lods.length;e.meta.isEsriSymbolResource&&e.model.lods.forEach(function(e){if(!n.isSome(e.lodThreshold)){var r=(e.name||"").replace("Imposter","Realistic_LOD0"),o=r.split("_LOD")[0],i=e.parts.reduce(function(e,t){return e+t.attributes.position.count},0);e.lodThreshold=U(o,i,t)}})}function U(e,t,r){if(void 0===e&&(e=""),1===r)return null;if(e in b.lodThresholdLUT){var o=b.lodThresholdLUT[e].vertexCounts,i=b.lodThresholdLUT[e].thresholds,s=o.length,a=t;if(s<=1)return null;if(a<=o[0]){var u=(o[1]-o[0])/(i[1]-i[0]),n=a-o[0];return Math.max(0,i[0]+n*u)}if(a>=o[s-1]){var u=(o[s-1]-o[s-2])/(i[s-1]-i[s-2]),n=a-o[s-1];return i[s-1]+n*u}for(var l=1;l<o.length;++l){var c=o[l-1],f=o[l],m=i[l-1],d=i[l];if(a<f){var g=(a-c)/(f-c);return m*(1-g)+d*g}}}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.fetch=O,t.parseUrl=A,t.gltfToEngineResources=F});