// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/arrayUtils","../../../../core/promiseUtils","../../../../core/libs/gl-matrix-2/vec2f32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f32","../../../../core/libs/gl-matrix-2/vec3f64","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/meshUtils/deduplicate","../../support/projectionUtils","../../webgl-engine/lib/Util"],function(e,r,t,n,a,o,i,s,c,f,u,d,l,v,p){function E(e,r,t,n,a){void 0===n&&(n=[]),void 0===a&&(a=[]);var o=e.params.vertexAttributes,i=o.position.count;if(!T(t[0].stride))throw w("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var s=t[0].stride/Uint32Array.BYTES_PER_ELEMENT,c=new Uint32Array(s*i);t=t.slice(0).sort(function(e,r){return e.offset-r.offset});for(var f=0,u=t;f<u.length;f++){var d=u[f];!function(e){if(-1!==a.indexOf(e.name))return"continue";var t=o[e.name],s=m(e.type),f=void 0,u=!1;if(null==t){var d=n.filter(function(r){return r.name===e.name})[0];if(!d)throw w("Geometry definition is missing attribute");t={valueType:b(e.type),byteOffset:0,count:i,valuesPerElement:e.count};for(var l=0;l<C.length;l++)C[l]=d.byteValue;f=C.buffer,u=!0}else f=r;if(b(e.type)!==t.valueType)throw w("Geometry definition type must match attribute type");if(!h(t.byteOffset)||!h(e.offset))throw w(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!T(t.valuesPerElement*s.BYTES_PER_ELEMENT)||!T(e.count*s.BYTES_PER_ELEMENT))throw w(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var v=new Uint32Array(f),p=t.byteOffset/Uint32Array.BYTES_PER_ELEMENT,E=t.valuesPerElement*s.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,A=e.offset/Uint32Array.BYTES_PER_ELEMENT,S=e.stride/Uint32Array.BYTES_PER_ELEMENT;u?y(v[0],E,c,A,S,i):g(v,p,E,c,A,S,i)}(d)}return c.buffer}function g(e,r,t,n,a,o,i){switch(t){case 1:for(var s=0;s<i;s++)n[a]=e[r],r+=1,a+=o;break;case 2:for(var s=0;s<i;s++)n[a]=e[r],n[a+1]=e[r+1],r+=2,a+=o;break;case 3:for(var s=0;s<i;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],r+=3,a+=o;break;case 4:for(var s=0;s<i;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],n[a+3]=e[r+3],r+=4,a+=o;break;default:throw w("Unhandled stride size "+t)}}function y(e,r,t,n,a,o){switch(r){case 1:for(var i=0;i<o;i++)t[n]=e,n+=a;break;case 2:for(var i=0;i<o;i++)t[n]=e,t[n+1]=e,n+=a;break;case 3:for(var i=0;i<o;i++)t[n]=e,t[n+1]=e,t[n+2]=e,n+=a;break;case 4:for(var i=0;i<o;i++)t[n]=e,t[n+1]=e,t[n+2]=e,t[n+3]=e,n+=a;break;default:throw w("Unhandled stride size "+r)}}function m(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}function b(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function h(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function T(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function w(e){return new Error("I3SGeometryUtil processing failed: "+e)}function A(e,r,t,n){if("none"===e)S(n);else{var a="earth-centered"===e?t:null;I(r,n.normals,a)}}function S(e){var r=e.normals,t=e.positions,n=e.normalInd,a=e.positionInd;p.assert(e.normalInd.length===e.positionInd.length);for(var o=c.vec3f32.create(),f=c.vec3f32.create(),u=i.vec2f32.create(),d=t.data,l=t.offsetIdx,v=t.strideIdx,E=r.data,g=r.offsetIdx,y=r.strideIdx,m=0;m<a.length;m+=3){var b=a[m],h=l+v*b,T=d[h],w=d[h+1],A=d[h+2];b=a[m+1],h=l+v*b,o[0]=d[h]-T,o[1]=d[h+1]-w,o[2]=d[h+2]-A,b=a[m+2],h=l+v*b,f[0]=d[h]-T,f[1]=d[h+1]-w,f[2]=d[h+2]-A,s.vec3.cross(o,o,f),p.encodeNormal(o,u);for(var S=0;S<3;S++){var I=n[m+S],M=g+y*I;E[M]=p.encodeInt16(u[0]),E[M+1]=p.encodeInt16(u[1])}}}function I(e,r,t){var n=e.length/3,a=r.data,o=r.offsetIdx,i=r.strideIdx;if(null!=t)for(var s=t,c=s[0],f=s[1],u=s[2],d=s[4],l=s[5],v=s[6],E=s[8],g=s[9],y=s[10],m=0;m<n;m++){var b=e[3*m],h=e[3*m+1],T=e[3*m+2];W[0]=c*b+f*h+u*T,W[1]=d*b+l*h+v*T,W[2]=E*b+g*h+y*T,p.encodeNormal(W,q),a[o+m*i]=p.encodeInt16(q[0]),a[o+m*i+1]=p.encodeInt16(q[1])}else for(var m=0;m<n;m++)W[0]=e[3*m],W[1]=e[3*m+1],W[2]=e[3*m+2],p.encodeNormal(W,q),a[o+m*i]=p.encodeInt16(q[0]),a[o+m*i+1]=p.encodeInt16(q[1])}function M(e,r,t){var n=r[0];if(null==n||"position"!==n.name||5126!==n.type)return null;for(var a=new Float32Array(e),o=n.stride/4,i=n.offset/4,s=3*a.length/o,c=new Float32Array(s),f=0;f<s/3;f++)c[3*f]=a[f*o+i],c[3*f+1]=a[f*o+i+1],c[3*f+2]=a[f*o+i+2];var u=l.default(c.buffer,3,{originalIndices:t});return u.uniqueCount<O?{data:new Float32Array(u.buffer),indices:new Uint16Array(u.indices)}:{data:new Float32Array(u.buffer),indices:u.indices}}function U(){return!!G}function _(){return n(this,void 0,void 0,function(){return t(this,function(r){switch(r.label){case 0:return U()?[2,G]:[4,o.create(function(r){return e(["../../../../geometry/geometryEngine"],r)})];case 1:return G=r.sent(),[2,G]}})})}function B(e,r){if(!e)return null;if("disjoint"===r&&"polygon"===e.type){for(var t=new Array(e.rings.length),n=0;n<e.rings.length;++n){var o=d.fromValues(1/0,1/0,-1/0,-1/0);d.expandWithNestedArray(o,e.rings[n]),t[n]={type:"polygon",rings:[e.rings[n]],spatialReference:e.spatialReference,aabr:o}}t.sort(function(e,r){return e.aabr[0]-r.aabr[0]});for(var i=new Set,s=new a.PositionHint,n=0;n<t.length;++n)!function(e){for(var r=t[e],n=e+1;n<t.length;++n){var o=t[n];if(o.aabr[0]>=r.aabr[2])break;i.add(o)}i.forEach(function(e){if(r!==e){if(e.aabr[2]<=r.aabr[0])return void i.delete(e);if(G.intersects(r,e)){r.rings=r.rings.concat(e.rings),d.expand(r.aabr,e.aabr),delete r._geVersion,i.delete(e);var n=a.indexOf(t,e,t.length,s);t.splice(n,1)}}}),i.add(r)}(n);for(var c=0,f=t;c<f.length;c++){delete f[c].aabr}return t}return[e]}function R(e,r,t,n,a){var o=r.renderSpatialReference,i=new Map,s={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:t};s.rings[0][3]=s.rings[0][0];var c,f,u={indices:null,data:null,stride:0,startIndex:0,endIndex:0};switch(e){case"intersects":c=function(e,r){return G.intersects(e,r)?0:2},f=k;break;case"contains":c=function(e,r){return G.contains(e,r)?2:1},f=k;break;case"disjoint":default:c=function(e,r){return G.disjoint(e,r)?2:1},f=N}return{collection:n,object:a,type:e,maskSR:t,renderSR:o,aabbCache:i,triangle:s,positions:u,triangleTest:c,geometryTest:f}}function x(e,r){var t={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:r.maskSR};return r.maskSR.isWGS84||r.maskSR.isWebMercator?G.geodesicBuffer(t,e[3],1,!0):G.buffer(t,e[3],1,!0)}function P(e,r,t){switch(t){case"intersects":case"contains":return k(e,r);case"disjoint":return N(e,r)}}function k(e,r){return G.intersects(e,r)?G.contains(e,r)?0:2:1}function N(e,r){return G.intersects(e,r)?G.contains(e,r)?1:2:0}function L(e,r,t){var n=t.collection,a=t.object,o=t.renderSR,i=t.maskSR,c=t.geometryTest,f=t.aabbCache,u=f.get(r);if(!u){var d=n.getObjectTransform(a);n.getComponentAABB(a,r,V);for(var l=[[V[0],V[1],0],[V[0],V[4],0],[V[3],V[4],0],[V[3],V[1],0]],p=0;p<4;++p)s.vec3.transformMat3(l[p],l[p],d.rotationScale),s.vec3.add(l[p],l[p],d.position),v.vectorToVector(l[p],o,l[p],i);u={rings:[l],hasZ:!1,hasM:!1,type:"polygon",spatialReference:i},u.rings[0][4]=u.rings[0][0],f.set(r,u)}switch(c(e,u)){case 1:return!1;case 0:return!0}var E=t.triangle,g=t.triangleTest,y=t.positions,m=E.rings[0][0],b=E.rings[0][1],h=E.rings[0][2],T=n.getObjectTransform(a);n.getComponentPositions(a,r,y);for(var w=y.indices,A=y.data,S=y.stride,I=y.startIndex,M=y.endIndex,p=I;p<M;p+=3){var U=S*w[p+0],_=S*w[p+1],B=S*w[p+2];s.vec3.set(m,A[U+0],A[U+1],A[U+2]),s.vec3.set(b,A[_+0],A[_+1],A[_+2]),s.vec3.set(h,A[B+0],A[B+1],A[B+2]),s.vec3.transformMat3(m,m,T.rotationScale),s.vec3.transformMat3(b,b,T.rotationScale),s.vec3.transformMat3(h,h,T.rotationScale),s.vec3.add(m,m,T.position),s.vec3.add(b,b,T.position),s.vec3.add(h,h,T.position),v.vectorToVector(m,o,m,i),v.vectorToVector(b,o,b,i),v.vectorToVector(h,o,h,i);var R=b[0]-m[0],x=b[1]-m[1],P=h[0]-m[0],k=h[1]-m[1];if(!(Math.abs(R*k-x*P)<F))switch(delete E._geVersion,g(e,E)){case 1:return!1;case 0:return!0}}switch(t.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}}function j(e,r,t,n){for(var a=r.getComponentAABB(t,e,V),o=r.getObjectTransform(t),i=0;i<8;++i)H[0]=1&i?a[0]:a[3],H[1]=2&i?a[1]:a[4],H[2]=4&i?a[2]:a[5],s.vec3.transformMat3(H,H,o.rotationScale),s.vec3.add(H,H,o.position),n[3*i]=H[0],n[3*i+1]=H[1],n[3*i+2]=H[2];return n}function Y(e,r,t,n){var a=r.getComponentAABB(t,e,V),o=r.getObjectTransform(t);n[0]=0,n[1]=0,n[2]=0;for(var i=0;i<8;++i)H[0]=1&i?a[0]:a[3],H[1]=2&i?a[1]:a[4],H[2]=a[5],s.vec3.transformMat3(H,H,o.rotationScale),s.vec3.add(H,H,o.position),n[0]+=H[0],n[1]+=H[1],n[2]+=H[2];return n[0]/=8,n[1]/=8,n[2]/=8,n}Object.defineProperty(r,"__esModule",{value:!0});var C=new Uint8Array(64);r.interleaveGeometryBuffer=E,r.processAndInterleaveNormals=A,r.computeCompressedNormals=S;var O=65536;r.extractPositionData=M;var G;r.isGeometryEngineLoaded=U,r.loadGeometryEngine=_,r.processFilterGeometry=B,r.acquireMaskFilterContext=R,r.computeMaskNodeMBS=x,r.testMaskWithGeometry=P;var F=Math.pow(2,-32);r.filterWithMask=L,r.boundingBoxCornerPoints=j,r.boundingBoxTop=Y;var V=u.create(),W=c.vec3f32.create(),q=i.vec2f32.create(),H=f.vec3f64.create()});