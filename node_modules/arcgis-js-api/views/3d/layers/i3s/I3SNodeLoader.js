// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../libs/draco/DracoDecoder","./I3SBinaryReader","./I3SMaterialUtil","./I3SUtil"],function(e,t,r,i,n,o,a,s,u,l,d,f){function c(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&(e=o.clone(e),delete e.vertexAttributes.region),e}function m(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return r;for(var o=0;o<i.length;o++)if(null==i[o].compressedAttributes)r.bufferIndex=o,r.bufferDefinition=i[o];else if("draco"===i[o].compressedAttributes.encoding&&u.isSupported()&&!n("disable-feature:i3s-draco"))return r.bufferIndex=o,r.bufferDefinition=i[o],r;return r}var h=function(){function e(e,t,r,i,n,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=n,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map(function(e){return d.getMaterialAndTextures(a,e)})}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(i,"binary",r).then(function(e){return l.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t,r){var i=this;return a.eachAlways(t.map(function(t){return i.loadAttribute(e,t.attributeStorageInfo,r)})).then(function(r){for(var n={},o=0;o<t.length;++o)r[o].value?n[t[o].name]=r[o].value:a.isAbortError(r[o].error)||i.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'");return n})},e.prototype.loadNodeData=function(e,t){return i(this,void 0,void 0,function(){var i,n,o,s,u,f,h,g,p,y,b,D,x,v,A,I,T,S,F,G,w;return r(this,function(r){switch(r.label){case 0:return i=null!=this.requiredAttributes&&e.resources.attributes?this.loadAttributes(e,this.requiredAttributes,t):a.resolve({}),n=m(this.geometryDefinitions,e),o=n.bufferDefinition,s=n.bufferIndex,u=e.resources.geometry?this.loadGeometry(e,s,t):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return h=r.sent(),[3,3];case 2:h=null,r.label=3;case 3:return f=h,g=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=f?d.getMaterialAndTexturesFromShared(f):null,p=g&&g.material,y=g&&g.textures,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return D=r.sent(),[3,6];case 5:D=null,r.label=6;case 6:return b=D,x=this.options.loadFeatureData?this.collectGeometries(b):this.meshPyramidGeometryData(p),v=null!=y&&y.length>0?this.loadTextures(e,y,t):null,A=null,I=null,u?[4,u]:[3,8];case 7:A=r.sent(),T=c(this.defaultGeometrySchema,f),S=!(!o||!o.compressedAttributes||"draco"!==o.compressedAttributes.encoding),I=S?l.createGeometryIndexFromAttributes(o.compressedAttributes.attributes):o?l.createGeometryIndexFromDefinition(o,e.vertexCount,e.numFeatures):l.createGeometryIndexFromSchema(A,T),r.label=8;case 8:return[4,v];case 9:return F=r.sent(),[4,i];case 10:return G=r.sent(),w=G?{attributeData:G,loadedAttributes:this.requiredAttributes}:null,[2,{allGeometryData:x,attributeDataInfo:w,geometryBuffer:A,geometryIndex:I,requiredTextures:y,textureData:F}]}})})},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++)for(var o=n[i],a=0,u=r[o].images;a<u.length;a++){var l=u[a];Array.isArray(l.href)?l.hrefConcat=l.href.map(function(e){return s.makeAbsolute(e,t)}):l.hrefConcat=s.makeAbsolute(l.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var o=i.encoding[n];"data:"===o.substring(0,5)&&(i.encoding[n]=o.substring(5))}else{var o=i.encoding;"data:"===o.substring(0,5)&&(i.encoding=o.substring(5))}}},e.prototype.loadShared=function(t,r){var i=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(i,"json",r).then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t})},e.prototype.loadTexture=function(e,t,r,i,n,o){return n===f.DDS_ENCODING_STRING?this.load(e,"binary",o).then(function(e){return{id:t,usage:r,data:e,encoding:n}}):this.load(e,"image",o).then(function(e){var o=e;if(i&&e.width*e.height>=4096){var a=Math.ceil(e.width/2),s=Math.ceil(e.height/2),u=document.createElement("canvas");u.width=a,u.height=s;u.getContext("2d").drawImage(e,0,0,a,s),o=u}return{id:t,usage:r,data:o,encoding:n}})},e.prototype.loadTextures=function(t,r,i){var n=this,o=this.options.textureFormat===e.TextureFormat.Compressed,s=this.options.textureFormat===e.TextureFormat.Downsampled,u=this.options.textureUsageMask;return a.all(r.map(function(e){if(0==(e.usage&u))return null;var r=f.selectEncoding(e.encodings,o);if(null==r)return n.logger.error("No known encoding for texture found on node "+t.id),a.reject();var l=t.resources.texture||t.id,d=n.layerUrl+"/nodes/"+l+"/textures/"+r.name;return n.loadTexture(d,e.id,e.usage,s,r.encoding,i)}))},e.prototype.meshPyramidGeometryData=function(e){return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e){for(var t=new Array,r=0,i=e.featureData;r<i.length;r++){var n=i[r],o=n.geometries;if(null!=o)for(var a=0,s=o;a<s.length;a++){var u=s[a];t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:[u]})}else null!=n.position&&t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}return t},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(i,"binary",r)},e}();return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(h||(h={})),h});