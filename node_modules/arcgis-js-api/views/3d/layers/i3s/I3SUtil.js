// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../request","../../../../core/arrayUtils","../../../../core/Error","../../../../core/maybe","../../../../core/promiseUtils","../../../../core/typedArrayUtil","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/quat","../../../../core/libs/gl-matrix-2/quatf32","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../../../geometry/SpatialReference","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/webMercatorUtils","../../../../tasks/QueryTask","../../../../tasks/support/Query","./I3SBinaryReader","../../support/projectionUtils"],function(e,t,r,n,a,o,i,l,u,s,c,f,h,p,d,g,v,m,y,b,S){function w(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function x(e,r){if(r)for(var n=0;n<e.length;n++)if(e[n].encoding===t.DDS_ENCODING_STRING)return e[n];for(var n=0;n<e.length;n++)if(t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[n].encoding)>-1)return e[n];return null}function M(e,t,r,n,a,o){a.traverse(r,function(r){var a=r.mbs;t!==n&&(a=te,S.mbsToMbs(r.mbs,n,a,t));var i=C(e,a);if(0!==i)return o(r,i),!0})}function R(e,t,r){for(var n=0,a=0,o=0;o<t.length&&n<e.length;o++)e[n]===t[o]&&(r(o)&&(e[a]=e[n],a++),n++);e.length=a}function I(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return ee[0]=(e[0]-t.position[0])/t.rotationScale[0],ee[1]=(e[1]-t.position[1])/t.rotationScale[4],ee[2]=(e[2]-t.position[2])/t.rotationScale[8],ee[3]=(e[3]-t.position[0])/t.rotationScale[0],ee[4]=(e[4]-t.position[1])/t.rotationScale[4],ee[5]=(e[5]-t.position[2])/t.rotationScale[8],ee}function C(e,t){var r=t[0],n=t[1],a=t[2],o=t[3],i=e[0]-r,l=r-e[3],u=e[1]-n,s=n-e[4],c=e[2]-a,f=a-e[5],h=Math.max(i,l,0),p=Math.max(u,s,0),d=Math.max(c,f,0),g=h*h+p*p+d*d;return g>o*o?0:g>0?1:-Math.max(i,l,u,s,c,f)>o?3:2}function T(e,t,r){for(var n=[],a=r&&r.missingFields,o=r&&r.originalFields,i=0,l=e;i<l.length;i++){for(var u=l[i],s=u.toLowerCase(),c=!1,f=0,h=t;f<h.length;f++){var p=h[f];if(s===p.name.toLowerCase()){n.push(p.name),c=!0,o&&o.push(u);break}}!c&&a&&a.push(u)}return n}function q(e,t,r,o,l,u){if(!0===(u&&u.populateObjectId)&&(o=A(o,r)),0===t.length)return i.resolve(t);var s=e.associatedLayer,c=e.attributeStorageInfo;if(s)return E(s,t,r,o);if(c){var f=l(t);if(!f)return i.reject(new a("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"));var h=e.parsedUrl.path;return i.all(f.map(function(e){return k(h,c,e.node,e.indices,o).then(function(t){for(var r=0;r<e.graphics.length;r++){var n=e.graphics[r],a=t[r];if(n.attributes)for(var o in n.attributes)o in a||(a[o]=n.attributes[o]);n.attributes=a}return e.graphics})})).then(n.flatten)}return i.reject(new a("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))}function A(e,t){return e.filter(function(e){return e!==t}).concat([t])}function E(e,t,r,n){t.sort(function(e,t){return e.attributes[r]-t.attributes[r]});var a=t.map(function(e){return e.attributes[r]}),o=[],i=T(n,e.fields,{originalFields:o});return G(e,a,i).then(function(e){for(var r=0;r<t.length;r++){var n=t[r],a=e[r],l={};if(n.attributes)for(var u in n.attributes)l[u]=n.attributes[u];for(var s=0;s<o.length;s++)l[o[s]]=a[i[s]];n.attributes=l}return t})}function G(e,t,r){var n=e.capabilities.query.maxRecordCount;if(null!=n&&t.length>n){var o=F(t,n);return i.all(o.map(function(t){return G(e,t,r)})).then(O)}var l=new y({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return new m(e.parsedUrl.path).execute(l).then(function(e){if(e&&e.features&&e.features.length===t.length)return e.features.map(function(e){return e.attributes});throw new a("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function k(e,t,n,a,o){for(var l=[],u=0,s=t;u<s.length;u++){var c=s[u];if(c&&-1!==o.indexOf(c.name)){var f=e+"/nodes/"+n.resources.attributes+"/attributes/"+c.key+"/0";l.push({url:f,storageInfo:c})}}return i.eachAlways(l.map(function(e){return r(e.url,{responseType:"array-buffer"}).then(function(t){return b.readBinaryAttribute(e.storageInfo,t.data)})})).then(function(e){for(var t=[],r=0,n=a;r<n.length;r++){for(var o=n[r],i={},u=0;u<e.length;u++)null!=e[u].value&&(i[l[u].storageInfo.name]=N(e[u].value,o));t.push(i)}return t})}function N(e,t){if(!e)return null;var r=e[t];return l.isInt16Array(e)?r===re?null:r:l.isInt32Array(e)?r===ne?null:r:r!==r?null:r}function F(e,t){for(var r=e.length,n=Math.ceil(r/t),a=[],o=0;o<n;o++){var i=Math.floor(r*o/n),l=Math.floor(r*(o+1)/n);a.push(e.slice(i,l))}return a}function O(e){for(var t=[],r=0,n=e;r<n.length;r++){var a=n[r];t=t.concat(a)}return t}function _(e,t,r){for(var n=null!=t?t:e.length/r,o=new Uint32Array(n+1),i=0;i<n;i++){var l=e[i*r],u=3*l;o[i]=u;var s=(i-1)*r+1;if(s>=0&&l-1!==e[s])throw new a("Face ranges are not continuous")}var c=e[(n-1)*r+1],f=3*(c+1);return o[o.length-1]=f,o}function B(e){var t=new d(w(e.store.indexCRS||e.store.geographicCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function j(e){var t=new d(w(e.store.vertexCRS||e.store.projectedCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function L(e,t){return t===S.SphericalECEFSpatialReference?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function P(e,t,r){if(!v.canProject(e,t))throw new a("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new a("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function D(e,t,r){var n=B(e),a=j(e);P(n,t,r),P(a,t,r)}function U(e){return(null==e.geometryType||"triangles"===e.geometryType)&&((null==e.topology||"PerAttributeArray"===e.topology)&&(null!=e.vertexAttributes&&null!=e.vertexAttributes.position))}function z(e){if(null==e.store||null==e.store.defaultGeometrySchema||!U(e.store.defaultGeometrySchema))throw new a("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{})}function W(e,t){D(e,t.spatialReference,t.viewingMode)}function V(e){return null!=e.geometryType&&"points"===e.geometryType&&((null==e.topology||"PerAttributeArray"===e.topology)&&((null==e.encoding||""===e.encoding||"lepcc-xyz"===e.encoding)&&(null!=e.vertexAttributes&&null!=e.vertexAttributes.position)))}function Q(e){if(null==e.store||null==e.store.defaultGeometrySchema||!V(e.store.defaultGeometrySchema))throw new a("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function K(e,t){P(e.spatialReference,t.spatialReference,t.viewingMode)}function H(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}function J(e){return"mesh-3d"===e.type}function X(e){if(null==e||!H(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;for(var r=0,n=t;r<n.length;r++){var a=n[r];if(!J(a)||0===a.symbolLayers.length)return!0;for(var i=0,l=a.symbolLayers.items;i<l.length;i++){var u=l[i];if("fill"!==u.type||o.isNone(u.material)||o.isNone(u.material.color)||"replace"!==u.material.colorMixMode)return!0}}return!1}function Y(e){for(var t=new ae,r=!1,n=!1,a=0,i=e.symbolLayers.items;a<i.length;a++){var l=i[a];if("fill"===l.type&&l.enabled){var u=l.material,s=l.edges;if(o.isSome(u)&&!r){var c=u.color,f=u.colorMixMode;o.isSome(c)?t.material={color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:f}:t.material={color:[1,1,1],alpha:1,colorMixMode:"multiply"},t.castShadows=l.castShadows,r=!0}o.isSome(s)&&!n&&(t.edges=s,n=!0)}}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:"multiply"}),t}function Z(e,t){return(0|e)+(0|t)|0}function $(e,t,r,n,a){if(void 0===a&&(a=0),f.vec3.set(r.center,e.center[0],e.center[1],e.center[2]+a),t===S.SphericalECEFSpatialReference||n!==S.SphericalECEFSpatialReference||t.isGeographic)S.bufferToBuffer(r.center,t,0,r.center,n,0,1),s.quat.copy(r.quaternion,e.quaternion),f.vec3.copy(r.halfSize,e.halfSize);else{for(var o=0;o<8;o++)f.vec3.set(oe,e.halfSize[0]*(1==(1&o)?-1:1),e.halfSize[1]*(2==(2&o)?-1:1),e.halfSize[2]*(4==(4&o)?-1:1)),f.vec3.transformQuat(oe,oe,e.quaternion),f.vec3.add(oe,oe,r.center),ue[3*o+0]=oe[0],ue[3*o+1]=oe[1],ue[3*o+2]=oe[2];S.computeLinearTransformation(t,r.center,ie,n);var i=2*Math.sqrt(1+ie[0]+ie[5]+ie[10]);le[0]=(ie[6]-ie[9])/i,le[1]=(ie[8]-ie[2])/i,le[2]=(ie[1]-ie[4])/i,le[3]=.25*i,s.quat.multiply(r.quaternion,le,e.quaternion),f.vec3.set(r.center,ie[12],ie[13],ie[14]),S.bufferToBuffer(ue,t,0,ue,n,0,8),s.quat.conjugate(le,r.quaternion);for(var l=0,u=0,c=0,o=0;o<8;o++)f.vec3.set(oe,ue[3*o+0],ue[3*o+1],ue[3*o+2]),f.vec3.sub(oe,oe,r.center),f.vec3.transformQuat(oe,oe,le),l=Math.max(l,Math.abs(oe[0])),u=Math.max(u,Math.abs(oe[1])),c=Math.max(c,Math.abs(oe[2]));f.vec3.set(r.halfSize,l,u,c)}}Object.defineProperty(t,"__esModule",{value:!0}),t.DDS_ENCODING_STRING="image/vnd-ms.dds",t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],t.extractWkid=w,t.selectEncoding=x,t.findIntersectingNodes=M,t.filterInPlace=R;var ee=g.create();t.getClipAABB=I;var te=p.vec4f64.create();t.intersectBoundingBoxWithMbs=C,t.findFieldsCaseInsensitive=T,t.whenGraphicAttributes=q;var re=-Math.pow(2,15),ne=-Math.pow(2,31);t.getCachedAttributeValue=N,t.convertFlatRangesToOffsets=_,t.getIndexCrs=B,t.getVertexCrs=j,t.getCacheKeySuffix=L,t.checkSpatialReference=P,t.checkSpatialReferences=D,t.checkSceneLayerValid=z,t.checkSceneLayerCompatibleWithView=W,t.checkPointCloudLayerValid=Q,t.checkPointCloudLayerCompatibleWithView=K,t.rendererNeedsTextures=X;var ae=function(){function e(){this.edges=null,this.material=null,this.castShadows=!0}return e}();t.SymbolInfo=ae,t.getSymbolInfo=Y,t.addWraparound=Z,t.transformObb=$;var oe=h.vec3f64.create(),ie=u.mat4f64.create(),le=c.quatf32.create(),ue=new Float64Array(24)});