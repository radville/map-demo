// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/maybe","../../../../renderers/PointCloudClassBreaksRenderer","../../../../renderers/PointCloudStretchRenderer","../../../../renderers/PointCloudUniqueValueRenderer","./I3SBinaryReader","./LEPCC"],function(e,r,t,n,o,l,a,i){function u(e){var r=e.renderer,t=r&&r.type,n=r&&e.renderer.toJSON()||null,o=null,l=!1;"point-cloud-unique-value"===t?o=m(e.attributeStorageInfo,r.field):"point-cloud-stretch"===t?o=m(e.attributeStorageInfo,r.field):"point-cloud-class-breaks"===t?o=m(e.attributeStorageInfo,r.field):"point-cloud-rgb"===t?(o=p(e.attributeStorageInfo,r.field),l=null!=o):(o=p(e.attributeStorageInfo,"RGB"),l=null!=o);var a=null;return r&&r.colorModulation&&(a=m(e.attributeStorageInfo,r.colorModulation.field)),{rendererJSON:n,isRGBRenderer:l,primaryAttribute:o,modulationAttribute:a}}function f(e){var r=e.filters;return r?r.map(function(r){return{filterJSON:r.toJSON(),attributeInfo:m(e.attributeStorageInfo,r.field)}}):[]}function s(e,r,t,a){var i=e.rendererJSON,u=e.isRGBRenderer,f=null,s=null;if(r&&u)f=r;else if(r&&"pointCloudUniqueValueRenderer"===i.type){s=l.fromJSON(i);var d=s.colorUniqueValueInfos;f=new Uint8Array(3*a);for(var c=h(s.fieldTransformType),v=0;v<a;v++)for(var g=c?c(r[v]):r[v],b=g+"",p=0;p<d.length;p++)if(d[p].values.indexOf(b)>=0){f[3*v]=d[p].color.r,f[3*v+1]=d[p].color.g,f[3*v+2]=d[p].color.b;break}}else if(r&&"pointCloudStretchRenderer"===i.type){s=o.fromJSON(i);var m=s.stops;f=new Uint8Array(3*a);for(var c=h(s.fieldTransformType),v=0;v<a;v++){var g=c?c(r[v]):r[v],y=m.length-1;if(g<m[0].value)f[3*v]=m[0].color.r,f[3*v+1]=m[0].color.g,f[3*v+2]=m[0].color.b;else if(g>=m[y].value)f[3*v]=m[y].color.r,f[3*v+1]=m[y].color.g,f[3*v+2]=m[y].color.b;else for(var p=1;p<m.length;p++)if(g<m[p].value){var S=(g-m[p-1].value)/(m[p].value-m[p-1].value);f[3*v]=m[p].color.r*S+m[p-1].color.r*(1-S),f[3*v+1]=m[p].color.g*S+m[p-1].color.g*(1-S),f[3*v+2]=m[p].color.b*S+m[p-1].color.b*(1-S);break}}}else if(r&&"pointCloudClassBreaksRenderer"===i.type){s=n.fromJSON(i);var I=s.colorClassBreakInfos;f=new Uint8Array(3*a);for(var c=h(s.fieldTransformType),v=0;v<a;v++)for(var g=c?c(r[v]):r[v],p=0;p<I.length;p++)if(g>=I[p].minValue&&g<=I[p].maxValue){f[3*v]=I[p].color.r,f[3*v+1]=I[p].color.g,f[3*v+2]=I[p].color.b;break}}else{f=new Uint8Array(3*a);for(var v=0;v<f.length;v++)f[v]=255}if(t&&s&&s.colorModulation)for(var A=s.colorModulation.minValue,C=s.colorModulation.maxValue,v=0;v<a;v++){var g=t[v],R=g>=C?1:g<=A?.3:.3+.7*(g-A)/(C-A);f[3*v]=R*f[3*v],f[3*v+1]=R*f[3*v+1],f[3*v+2]=R*f[3*v+2]}return f}function d(e,r,t,n,o){for(var l=e.length/3,a=0,i=0;i<l;i++){for(var u=!0,f=0;f<n.length&&u;f++){var s=n[f].filterJSON,d=o[f].values[i];switch(s.type){case"pointCloudValueFilter":var v="exclude"===s.mode;-1!==s.values.indexOf(d)===v&&(u=!1);break;case"pointCloudBitfieldFilter":var g=c(s.requiredSetBits),b=c(s.requiredClearBits);(d&g)===g&&0==(d&b)||(u=!1);break;case"pointCloudReturnFilter":for(var p=15&d,m=d>>>4&15,y=m>1,S=1===p,h=p===m,I=!1,A=0,C=s.includedReturns;A<C.length;A++){var R=C[A];if("last"===R&&h||"firstOfMany"===R&&S&&y||"lastOfMany"===R&&h&&y||"single"===R&&!y){I=!0;break}}I||(u=!1)}}u&&(t[a]=i,e[3*a]=e[3*i],e[3*a+1]=e[3*i+1],e[3*a+2]=e[3*i+2],r[3*a]=r[3*i],r[3*a+1]=r[3*i+1],r[3*a+2]=r[3*i+2],a++)}return a}function c(e){for(var r=0,t=0,n=e||[];t<n.length;t++){r|=1<<n[t]}return r}function v(e){var r=e&&e.pointSizeAlgorithm;return r&&"splat"===r.type?r:null}function g(e){var r=e&&e.pointSizeAlgorithm;return r&&"fixed-size"===r.type?r:null}function b(e){var r=e&&e.pointSizeAlgorithm;return!(!r||!r.type)&&"fixed-size"===r.type}function p(e,r){for(var t=0,n=e;t<n.length;t++){var o=n[t];if(o.name===r&&null!=o.attributeValues&&"UInt8"===o.attributeValues.valueType&&3===o.attributeValues.valuesPerElement)return{name:r,storageInfo:o,useElevation:!1}}return null}function m(e,r){for(var t=0,n=e;t<n.length;t++){var o=n[t];if(o.name===r){var l="embedded-elevation"===o.encoding;return{name:r,storageInfo:l?null:o,useElevation:l}}}return"elevation"===r.toLowerCase()?{name:r,storageInfo:null,useElevation:!0}:null}function y(e,r){for(var t=new Float64Array(r),n=0;n<r;n++)t[n]=e[3*n+2];return t}function S(e,r,n){return t.isSome(e)&&e.attributeInfo.useElevation?y(r,n):t.isSome(e)?a.readBinaryAttribute(e.attributeInfo.storageInfo,e.buffer,n):null}function h(e){return null==e||"none"===e?null:"low-four-bit"===e?function(e){return 15&e}:"high-four-bit"===e?function(e){return(240&e)>>4}:"absolute-value"===e?function(e){return Math.abs(e)}:"modulo-ten"===e?function(e){return e%10}:null}function I(e,r){if(null==e.encoding||""===e.encoding){for(var t=a.createGeometryIndexFromSchema(r,e),n=a.createTypedView(r,t.vertexAttributes.position),o=t.header.fields,l=[o.offsetX,o.offsetY,o.offsetZ],u=[o.scaleX,o.scaleY,o.scaleZ],f=n.length/3,s=new Float64Array(3*f),d=0;d<f;d++)s[3*d]=n[3*d]*u[0]+l[0],s[3*d+1]=n[3*d+1]*u[1]+l[1],s[3*d+2]=n[3*d+2]*u[2]+l[2];return s}if("lepcc-xyz"===e.encoding)return i.decodeXYZ(r).result}Object.defineProperty(r,"__esModule",{value:!0}),r.getRendererInfo=u,r.getFilterInfo=f,r.evaluateRenderer=s,r.filterInPlace=d,r.getSplatSizeAlgorithm=v,r.getFixedSizeAlgorithm=g,r.rendererUsesFixedSizes=b,r.getAttributeInfo=m,r.elevationFromPositions=y,r.getAttributeValues=S,r.readGeometry=I});