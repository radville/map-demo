// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/mathUtils","../../../../../core/screenUtils","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec2","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../camera/constraintUtils","../../../input/util","../InteractiveController","../momentum/PanPlanarMomentumController","../momentum/PanSphericalMomentumController","../momentum/RotationMomentumController","../momentum/ZoomPlanarMomentumController","../momentum/ZoomSphericalMomentumController","../../utils/navigationUtils","../../utils/navigationUtils","../../../support/geometryUtils","../../../support/mathUtils","../../../webgl-engine/lib/Camera","../../../../navigation/PanPlanarMomentumEstimator","../../../../navigation/PanSphericalMomentumEstimator","../../../../navigation/RotationMomentumEstimator","../../../../navigation/ZoomMomentumEstimator"],function(t,e,i,n,a,r,o,s,c,h,m,p,l,u,P,d,g,v,M,S,b,y,C,A,f,w,x){Object.defineProperty(e,"__esModule",{value:!0});var O={aboveGround:.25,belowGround:.025},E=function(t){function e(e,i){var n=t.call(this)||this;return n.view=e,n.intersectionHelper=i,n.smoothRotation=new p.ExponentialFalloff(.05),n.rotationAxis=h.vec3f64.create(),n.panningPlane=b.plane.create(),n.smoothScaling=new p.ExponentialFalloff(.05),n.zoomCenterScreen=a.createScreenPointArray(),n.zoomMomentumEstimator=new x.ZoomMomentumEstimator,n.rotationMomentumEstimator=new w.RotationMomentumEstimator,n.panSphericalMomentumEstimator=new f.PanSphericalMomentumEstimator,n.panPlanarMomentumEstimator=new A.PanPlanarMomentumEstimator,n.adjustedSphere=b.sphere.create(),n.tmp3d=h.vec3f64.create(),n.tmpMat=o.mat4f64.create(),n.tmpAxisAngle=b.axisAngle.create(),n.tmpScreenPointArray=a.createScreenPointArray(),n.beginScreenPoint=a.createScreenPointArray(),n.beginScenePoint=h.vec3f64.create(),n.screenPickPoint=a.createScreenPointArray(),n.panMode=S.PanMode.Horizontal,n.tmpInteractionDirection=h.vec3f64.create(),n.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new C.default,interactionDirection:null,tiltMode:0},n}return i(e,t),e.prototype.begin=function(t){if(this.active){var e=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=e,this.rotationMomentumEstimator.enabled=e,this.panPlanarMomentumEstimator.enabled=e,this.panSphericalMomentumEstimator.enabled=e,this.beginHeading=-y.cyclicalPI.normalize(n.deg2rad(this.view.camera.heading)),this.beginRadius=t.radius,this.pointerCount=t.pointers.size,this.beginAngle=t.angle,this.smoothRotation.reset(),a.screenPointObjectToArray(t.center,this.screenPickPoint),s.vec2.copy(this.beginScreenPoint,this.screenPickPoint);var i=M.pickPointAndInitSphere(this.intersectionHelper,this.beginCamera,this.screenPickPoint,!0);this.scenePickPoint=i.scenePickPoint,this.sphere=i.sphere,c.vec3.copy(this.beginScenePoint,this.scenePickPoint),this.panMode=M.decidePanMode(this.beginCamera,this.sphere,this.scenePickPoint),this.panMode===S.PanMode.Vertical&&(this.beginCamera.aboveGround?this.preparePlanarPanModeOverground(t):this.preparePlanarPanMode(t)),this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}},e.prototype.preparePlanarPanModeOverground=function(t){var e=c.vec3.negate(this.tmp3d,this.beginCamera.viewForward);b.plane.fromPositionAndNormal(this.scenePickPoint,e,this.panningPlane);var i=a.createScreenPointArray(this.screenPickPoint[0],0),n=h.vec3f64.create(),r=c.vec3.length(this.beginCamera.eye);this.adjustedSphere.radius=r<this.sphere.radius?r-100:this.sphere.radius,M.sphereOrPlanePointFromScreenPoint(this.adjustedSphere,this.beginCamera,i,n);var o=a.createRenderScreenPointArray3();this.beginCamera.projectPoint(n,o);var s=.9*o[1];this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],s),this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint)&&b.plane.fromPositionAndNormal(this.scenePickPoint,this.panningPlane,this.panningPlane);var m=a.screenPointObjectToArray(t.center,this.tmpScreenPointArray);M.intersectPlaneFromScreenPoint(this.panningPlane,this.beginCamera,m,this.beginScenePoint)},e.prototype.preparePlanarPanMode=function(t){var e=c.vec3.negate(this.tmp3d,this.beginCamera.viewForward);b.plane.fromPositionAndNormal(this.scenePickPoint,e,this.panningPlane);var i=b.sphere.angleToSilhouette(this.sphere,this.currentCamera.eye),n=b.axisAngle.fromPoints(this.currentCamera.eye,this.scenePickPoint,this.tmpAxisAngle),o=this.currentCamera.aboveGround?O.aboveGround:O.belowGround,s=-n[3]-o*i;if(s>0){var h=r.mat4.identity(this.tmpMat);r.mat4.rotate(h,h,-s,n),c.vec3.subtract(this.scenePickPoint,this.scenePickPoint,this.sphere.center),c.vec3.transformMat4(this.scenePickPoint,this.scenePickPoint,h),c.vec3.add(this.scenePickPoint,this.scenePickPoint,this.sphere.center),b.plane.setOffsetFromPoint(this.panningPlane,this.scenePickPoint,this.panningPlane);var m=a.screenPointObjectToArray(t.center,this.tmpScreenPointArray);M.intersectPlaneFromScreenPoint(this.panningPlane,this.beginCamera,m,this.beginScenePoint)}},e.prototype.update=function(t){if(this.active){this.currentCamera.copyFrom(this.beginCamera);var e=t.pointers.size,i=e>1;this.panMode===S.PanMode.Horizontal?(i&&this.zoomSpherical(t),this.panningSpherical(t),i&&this.rotateSpherical(t)):(i&&this.zoomPlanar(t),this.panningPlanar(t),i&&this.rotatePlanar(t)),this.currentCamera.markViewDirty()}},e.prototype.end=function(t){t.pointers.size===this.pointerCount&&this.update(t),this.finishController();var e=this.zoomMomentumEstimator.evaluateMomentum();if(e)return this.panMode===S.PanMode.Horizontal?new v.ZoomSphericalMomentumController(this.view,e,this.zoomCenterScreen,this.beginScenePoint,this.sphere.radius):new g.ZoomPlanarMomentumController(this.view,e,this.beginScenePoint);var i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new d.RotationMomentumController(this.view,i,this.sphere.center,this.rotationAxis);if(this.panMode===S.PanMode.Horizontal){var n=this.panSphericalMomentumEstimator.evaluateMomentum();if(n)return new P.PanSphericalMomentumController(this.view,n)}else{var n=this.panPlanarMomentumEstimator.evaluateMomentum();if(n)return new u.PanPlanarMomentumController(this.view,n)}return null},e.prototype.zoomSpherical=function(t){var e=this.beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(e),M.applyZoomOnSphere(this.sphere,this.currentCamera,this.smoothScaling.value),a.screenPointObjectToArray(t.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=m.pixelDistanceToInteractionFactor(t.radius-this.beginRadius),m.applyAll(this.view,this.currentCamera,this.constraintOptions)},e.prototype.panningSpherical=function(t){var e=a.screenPointObjectToArray(t.center,this.tmpScreenPointArray);M.sphereOrPlanePointFromScreenPoint(this.sphere,this.currentCamera,e,this.tmp3d),M.preserveHeadingThreshold(this.beginScenePoint,c.vec3.dot(this.currentCamera.up,this.beginScenePoint),this.sphere.radius,this.beginHeading,this.view.camera.tilt,this.beginCamera)?(M.applyPanSphericalPreserveHeading(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(e,this.tmp3d,.001*t.timestamp,this.beginCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(M.applyPanSphericalDirectRotation(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(e,this.tmp3d,.001*t.timestamp,this.beginCamera,this.sphere.radius,this.view.camera.tilt)),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=m.pixelDistanceToInteractionFactor(this.screenPickPoint,e),m.applyAll(this.view,this.currentCamera,this.constraintOptions)},e.prototype.rotateSpherical=function(t){c.vec3.normalize(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||c.vec3.negate(this.rotationAxis,this.rotationAxis);var e=this.smoothRotation.value,i=M.normalizeRotationDelta(t.angle-e),n=e+i,a=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=a,this.smoothRotation.update(n);var r=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(r,.001*t.timestamp),M.applyRotation(this.currentCamera,this.sphere.center,b.axisAngle.wrapAxisAngle(this.rotationAxis,r)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=m.pixelDistanceToInteractionFactor(t.radius*n),m.applyAll(this.view,this.currentCamera,this.constraintOptions)},e.prototype.panningPlanar=function(t){var e=a.screenPointObjectToArray(t.center,this.tmpScreenPointArray);M.intersectPlaneFromScreenPoint(this.panningPlane,this.currentCamera,e,this.tmp3d)&&(M.applyPanPlanar(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(e,this.tmp3d,.001*t.timestamp),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=m.pixelDistanceToInteractionFactor(this.beginScreenPoint,e),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),m.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)},e.prototype.zoomPlanar=function(t){var e=this.beginRadius/t.radius,i=.001875*Math.min(Math.max(t.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(e),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*t.timestamp),M.applyZoomToPoint(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=m.pixelDistanceToInteractionFactor(t.radius-this.beginRadius),m.applyAll(this.view,this.currentCamera,this.constraintOptions)},e.prototype.rotatePlanar=function(t){c.vec3.copy(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||c.vec3.negate(this.rotationAxis,this.rotationAxis);var e=this.smoothRotation.value,i=t.angle-e;i=M.normalizeRotationDelta(i);var n=e+i,a=.00125*Math.min(Math.max(t.radius,40),120);this.smoothRotation.gain=a,this.smoothRotation.update(n);var r=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(r,.001*t.timestamp),M.applyRotation(this.currentCamera,this.sphere.center,b.axisAngle.wrapAxisAngle(this.rotationAxis,r)),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=m.pixelDistanceToInteractionFactor(t.radius*r),m.applyAll(this.view,this.currentCamera,this.constraintOptions)},e}(l.InteractiveController);e.PinchAndPanController=E});