// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/decorateHelper","../../../core/tsSupport/declareExtendsHelper","../../../request","../../../core/Accessor","../../../core/arrayUtils","../../../core/Error","../../../core/lang","../../../core/maybe","../../../core/now","../../../core/promiseUtils","../../../core/accessorSupport/decorators","./AsyncWorkerQueue","../webgl-engine/lib/Util","../../../views/support/Scheduler"],function(e,t,r,s,o,a,n,u,i,l,c,d,p,h,f,y){Object.defineProperty(t,"__esModule",{value:!0});var k=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tasks=new Map,t.doneQueue=[],t.updating=!1,t}return s(t,e),t.prototype.setup=function(e,t,r){var s=this;this.loadQueue=new h.AsyncWorkerQueue(function(e,t){return s.startLoading(e,t)},function(e,t){return s.doneLoadingCallback(e,t)},e,t),r&&(this.taskHandle=r.registerTask(y.Task.STREAM_DATA_LOADER,function(e){return s.update(e)},function(){return s.doneQueue.length>0}))},t.prototype.destroy=function(){this.taskHandle&&(this.taskHandle.remove(),this.taskHandle=null),this.tasks.forEach(function(e){e.abortController&&e.abortController.abort()}),this.loadQueue.clear(),this.loadQueue=null,this.doneQueue=null,this.tasks=null},Object.defineProperty(t.prototype,"busy",{get:function(){return this.loadQueue.busy},enumerable:!0,configurable:!0}),t.prototype.request=function(e,t,r,s){var o=this,a=d.createResolver();a.__signal=l.isSome(s)?s.signal:null;var n=l.isSome(s)&&s.uid||e,u=this.createOrUpdateTask(e,t,r,n,a);return d.onAbort(s,function(){return o.cancelRequest(u,a)}),a.promise},t.prototype.createTask=function(e,t,r,s,o){var a={url:e,docType:t,clientType:r,key:s,result:null,status:1,resourceRequest:null,abortController:null,resolvers:[],_cancelledInQueue:!1,startTime:0,duration:0,size:0};return this.updateTask(a,o),this.tasks.set(s,a),1===this.tasks.size&&this._set("updating",!0),this.loadQueue.push(a),a},t.prototype.cancelRequest=function(e,t){n.removeUnordered(e.resolvers,t),t.reject(d.createAbortError()),0===e.resolvers.length&&(2===e.status&&(e.status=4,this.loadQueue.cancel(e),e.abortController.abort(),e.resourceRequest=null,e.abortController=null),e.status=4,this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1))},t.prototype.taskKey=function(e,t,r){return e+":"+t+":"+r},t.prototype.updateTask=function(e,t){e.resolvers.push(t)},t.prototype.createOrUpdateTask=function(e,t,r,s,o){var a=this.taskKey(s,t,r),n=this.tasks.get(a);return n?(this.updateTask(n,o),n):this.createTask(e,t,r,a,o)},t.prototype.doneLoadingCallback=function(e,t){f.assert(2===e.status),e.status=3,this.taskHandle?this.doneQueue.push({task:e,err:t}):this.doneLoading(e,t)},t.prototype.update=function(e){for(;!e.done&&this.doneQueue.length>0;){var t=this.doneQueue.shift();3!==t.task.status&&(t.err=t.err||d.createAbortError()),this.doneLoading(t.task,t.err),e.madeProgress()}},t.prototype.doneLoading=function(e,t){for(var r=e.result instanceof HTMLImageElement?0:e.resolvers.length,s=0,o=e.resolvers;s<o.length;s++){var a=o[s];if(t)d.isAbortError(t)?a.reject(t):a.reject(new u("stream-data-loader:request-error","Failed to request resource at '"+e.url+"'. "+t,{url:e.url,error:t}));else{--r;var n=r<=0?e.result:i.clone(e.result);a.resolve(n)}}this.tasks.delete(e.key),0===this.tasks.size&&this._set("updating",!1)},t.prototype.startLoading=function(e,t){if(4===e.status)return!1;e.status=2;var r,s;switch(e.docType){case"binary":s="array-buffer",r=0;break;case"image":s="image";break;default:s="json"}return e.startTime=c(),e.abortController=d.createAbortController(),e.resourceRequest=o(e.url,{responseType:s,timeout:r,signal:e.abortController.signal}),e.resourceRequest.then(function(r){e.duration=c()-e.startTime,e.size="binary"===e.docType?r.data.byteLength:0,e.result=r.data,e.abortController=null,t(e)},function(r){2===e.status&&t(e,r)}),!0},Object.defineProperty(t.prototype,"test",{get:function(){return{loadQueue:this.loadQueue}},enumerable:!0,configurable:!0}),r([p.property({readOnly:!0})],t.prototype,"updating",void 0),t=r([p.subclass("esri.views.3d.support.StreamDataLoader")],t)}(p.declared(a));t.StreamDataLoader=k,t.default=k});