// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Camera","../../../core/Logger","../../../core/mathUtils","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/Point","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../camera/intersectionUtils","./cameraUtilsPlanar","./cameraUtilsSpherical","./earthUtils","./mathUtils","./projectionUtils","../../support/spatialReferenceSupport"],function(e,t,r,n,i,a,o,c,l,s,u,v,f,d,p,m,g,h,T,y,S){function x(e){return e.spatialReference||f.WGS84}function M(e){return"global"===e.viewingMode?g:m}function R(e,t,r,n,i){return M(e).headingTiltToDirectionUp(t,r,n,i)}function w(e,t){var r=e.renderSpatialReference,n=M(e).headingTiltToDirectionUp,i=u.vec3f64.create();if(!y.pointToVector(t.position,i,r))return null;var a=n(i,t.heading,t.tilt);s.vec3.scale(a.direction,a.direction,e.state.camera.distance),s.vec3.add(a.direction,a.direction,i);var o=p.cameraOnContentAlongViewDirection(e,i,a.direction,a.up);return o.fov=c.deg2rad(t.fov),o}function C(e,t,r){var n=e.renderSpatialReference,i=s.vec3.copy(le,t.viewForward),o=D(e,t.eye,i,t.up,se),l=x(e);return y.vectorToVector(t.eye,n,oe,l)||(l=f.WGS84,y.vectorToVector(t.eye,n,oe,l)),r?(r.position.x=oe[0],r.position.y=oe[1],r.position.z=oe[2],r.position.spatialReference=l,r.heading=o.heading,r.tilt=o.tilt,r.fov=c.rad2deg(t.fov),r):new a(new v(oe,l),o.heading,o.tilt,c.rad2deg(t.fov))}function b(e,t,r){var n=e.state.camera,i=n.fovX,a=n.width/2/n.pixelRatio;return"global"===e.viewingMode&&null!=r&&(t*=Math.cos(c.deg2rad(r))),t/=e.renderCoordsHelper.unitInMeters,a/(te*ee/t)/Math.tan(i/2)}function U(e,t,r){var n=e.state.camera,i=n.fovX,a=t*Math.tan(i/2),o=n.width/2/n.pixelRatio,l=o/a,s=te*ee,u=s/l;return"global"===e.viewingMode&&(u/=Math.cos(c.deg2rad(r))),u*=e.renderCoordsHelper.unitInMeters}function z(e,t,r,n,i,a){return A(e,t,b(e,r,t.latitude),n,i,a)}function A(e,t,r,n,i,a){if(B(a)){var o=N(a.signal);return L(e,n.heading,n.tilt,t,r,i,o),void o.resolver.promise.then(function(t){return a.resolver.resolve(K(e,t,n.fov))},function(e){return a.resolver.reject(e)})}var c=L(e,n.heading,n.tilt,t,r,i);return K(e,c,n.fov,a)}function D(e,t,r,n,i){return M(e).directionToHeadingTilt(t,r,n,i)}function E(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,ue,e.spatialReference)&&e.basemapTerrain.getElevation(ue)>ue.z-ae)}function P(e,t,r){return i(this,void 0,void 0,function(){var i;return n(this,function(n){switch(n.label){case 0:return e.renderCoordsHelper.fromRenderCoords(t,ue,e.spatialReference)?[4,e.elevationProvider.queryElevation(ue,r)]:[2,!1];case 1:return i=n.sent(),[2,i>ue.z-ae]}})})}function H(e,t,r){return i(this,void 0,void 0,function(){var i,a;return n(this,function(n){switch(n.label){case 0:return i=u.vec3f64.create(),t?[3,1]:(s.vec3.copy(i,e.state.camera.center),[3,5]);case 1:return t instanceof v?(y.pointToVector(t,i,e.renderSpatialReference),null!=t.z||null==e.basemapTerrain?[3,3]:[4,e.elevationProvider.queryElevation(t,r)]):[3,4];case 2:return a=n.sent(),null!=a&&e.renderCoordsHelper.setAltitude(a,i),[2,i];case 3:return[3,5];case 4:s.vec3.copy(i,t),n.label=5;case 5:return[2,i]}})})}function O(e,t){var r=u.vec3f64.create();if(t&&t instanceof v){if(y.pointToVector(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){var n=e.elevationProvider.getElevation(t);null!=n&&e.renderCoordsHelper.setAltitude(n,r)}}else t?s.vec3.copy(r,t):s.vec3.copy(r,e.state.camera.center);return r}function L(e,t,r,n,i,a,o){var c=n&&n instanceof v?n:null;if(B(o))return void H(e,n,o.signal).then(function(n){V(e,t,r,c,n,i,a,o)},function(e){return o.resolver.reject(e)});var l=O(e,n);return V(e,t,r,c,l,i,a,o)}function V(e,t,r,n,i,a,o,c){if(!n){var l=e.renderSpatialReference,s=x(e);n=y.vectorToPoint(i,l,s)}a=Math.max(a,e.state.constraints.minimumPoiDistance);var v=q(e,t,r,i,a,o),f=M(e).eyeForCenterWithHeadingTilt,d=f(i,a,v.heading,v.tilt);if(o===Q.ADJUST&&"global"===e.viewingMode&&r>0){var p=function(){var l=W(e,i,a,J(e,a,r,i));return o=r-l<1?Q.LOCKED:Q.ADJUST,V(e,t,l,n,i,a,o,c)};if(E(e,d.eye))return p();if(B(c))return void P(e,d.eye,c.signal).then(function(e){if(e)return p();c.resolver.resolve({eye:d.eye,up:d.up,center:u.vec3f64.clone(i),heading:d.heading,tilt:d.tilt})})}var m=!c||B(c)?{center:u.vec3f64.create(),eye:u.vec3f64.create(),up:u.vec3f64.create(),tilt:0,heading:0}:c;return m.eye=d.eye,m.up=d.up,m.center=u.vec3f64.clone(i),m.heading=d.heading,m.tilt=d.tilt,B(c)&&c.resolver.resolve(m),m}function I(e,t,r,n,i,a){var o,c=0;null!=t.zmax&&null!=t.zmin&&(o=(t.zmax+t.zmin)/2,c=t.zmax-t.zmin);var l,s,u;if("global"===e.viewingMode){if(!S.isSpatialReferenceSupported(t.spatialReference,"global"))return B(a)&&a.resolver.reject(),null;var f=new v(t.xmin,t.ymin,t.spatialReference),d=new v(t.xmax,t.ymax,t.spatialReference),p=t.spatialReference.isGeographic?fe:ve;l=new v(p.center(f.x,d.x),(d.y+f.y)/2,t.spatialReference),null!=o&&(l.z=o);var m=h.getGreatCircleSpanAt(l,f,d);s=m.lon,u=m.lat,p.diff(f.x,d.x)>p.range/2&&(s+=h.halfEarthCircumference),s=Math.min(s,h.halfEarthCircumference),u=Math.min(u,h.halfEarthCircumference)}else{var g=x(e);s=t.xmax-t.xmin,u=t.ymax-t.ymin,l=new v({x:t.xmin+.5*s,y:t.ymin+.5*u,z:o,spatialReference:g})}var T=e.state.camera,y=1/Math.tan(T.fovX/2),M=1/Math.tan(T.fovY/2),R=1/Math.tan(T.fov/2),w=Math.max(.5*s*y,.5*u*M,.5*c*R)/re;if(B(a)){var C=N(a.signal);return L(e,r,n,l,w,i,C),void C.resolver.promise.then(function(t){return a.resolver.resolve(K(e,t,e.camera.fov))},function(e){return a.resolver.reject(e)})}var b=L(e,r,n,l,w,i);return K(e,b,e.camera.fov,a)}function j(e,t,r){var n=e.renderSpatialReference,i=s.vec3.dist(t.eye,r),a=y.vectorToPoint(r,n,x(e)),o=Math.tan(t.fovX/2),c=Math.tan(t.fovY/2),l=2*i*o*re,u=2*i*c*re;return"global"===e.viewingMode?g.toExtent(e,a,l,u):m.toExtent(e,a,l,u)}function F(e,t,r){var n=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/n)/Math.LN2>ne)return!0;var i=e.renderSpatialReference,a=x(e),o=y.vectorToPoint(t,i,a),c=y.vectorToPoint(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a),l=Math.tan(.5*e.state.camera.fov)*n;return c.distance(o)/l>ie}function q(e,t,r,n,i,a){var o=0;return a===Q.ADJUST&&F(e,n,i)?(t=0,o=G(e,i,r,n)):o=X(e,n,i,r),o=e.state.constraints.clampTilt(i,o),r=W(e,n,i,o),{heading:t,tilt:r}}function G(e,t,r,n){var i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);var a=i.min*(1-de)+i.max*de,o=X(e,n,t,r);return Math.min(o,a)}function J(e,t,r,n){var i=e.state.constraints.tilt(t),a=X(e,n,t,r);return a=Math.min(a,.5*Math.PI),i.min*(1-de)+a*de}function W(e,t,r,n){return M(e).lookAtTiltToEyeTilt(n,t,r)}function X(e,t,r,n){return M(e).eyeTiltToLookAtTilt(n,t,r)}function K(e,t,r,n){var i=e.renderSpatialReference,o=x(e),c=y.vectorToPoint(t.eye,i,o);return c?n?(n.position=c,n.heading=t.heading,n.tilt=t.tilt,n.fov=r,n):new a(c,t.heading,t.tilt,r):null}function k(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.levelAtScale(t):void $.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function Y(e,t){var r=e.basemapTerrain&&e.basemapTerrain.tilingScheme;return r?r.scaleAtLevel(t):void $.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Z(e,t){return e.spatialReference?d.getResolutionForScale(t,e.spatialReference):void 0}function _(e,t,r){var n=e.renderSpatialReference;t||(t=e.state.camera);var i,o,c=f.WGS84;return t instanceof a?(i=t.position.latitude,y.pointToVector(t.position,oe,n),y.pointToVector(r,ce,n),o=s.vec3.distance(oe,ce)):(y.vectorToVector(t.center,n,ce,c),i=ce[1],o=t.distance),U(e,o,i)}function N(e){return{resolver:l.createResolver(),signal:e}}function B(e){return e&&"resolver"in e}Object.defineProperty(t,"__esModule",{value:!0});var Q,$=o.getLogger("esri.views.3d.support.cameraUtils"),ee=39.37,te=96,re=1,ne=8,ie=5,ae=1,oe=u.vec3f64.create(),ce=u.vec3f64.create(),le=u.vec3f64.create(),se={heading:0,tilt:0},ue=new v,ve=new T.Cyclical(-20037508.342788905,20037508.342788905),fe=new T.Cyclical(-180,180);!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(Q=t.OrientationMode||(t.OrientationMode={})),t.headingTiltToDirectionUp=R,t.externalToInternal=w,t.internalToExternal=C,t.scaleToDistance=b,t.distanceToScale=U,t.fromCenterScale=z,t.fromCenterDistance=A,t.directionToHeadingTilt=D,t.getObserverForPointAtDistance=L,t.fromExtent=I,t.toExtent=j;var de=.7;t.observerToCamera=K,t.scaleToZoom=k,t.zoomToScale=Y,t.scaleToResolution=Z,t.computeScale=_,t.createAsyncContext=N,t.isAsyncContext=B});