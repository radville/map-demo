// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/generatorHelper","../../../core/tsSupport/awaiterHelper","../../../Camera","../../../geometry","../../../Graphic","../../../Viewpoint","../../../core/asyncUtils","../../../core/compilerUtils","../../../core/Error","../../../core/maybe","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/mat3","../../../core/libs/gl-matrix-2/mat3f64","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../geometry/support/aaBoundingBox","../../../geometry/support/aaBoundingRect","../../../geometry/support/webMercatorUtils","../camera/intersectionUtils","./cameraUtils","./geometryUtils","./mathUtils","./projectionUtils"],function(e,t,n,r,a,i,o,c,s,l,u,m,f,p,v,g,d,h,y,x,b,w,R,T,S,G){function A(e){return 360-S.cyclicalDeg.normalize(e)}function M(e){return S.cyclicalDeg.normalize(360-e)}function E(e,t){return e&&e.resolver&&(null==t?e.resolver.reject():e.resolver.resolve(t)),t}function O(e,t,n,r){if(!t)return E(r);var a=e.spatialReference||i.SpatialReference.WGS84;if(t.camera){var o=t.get("camera.position.spatialReference");if(!b.canProject(o,a))return E(r);var c=t.camera.clone();return o.equals(a)||(c.position=b.project(c.position,a)),E(r,c)}var s=t.get("targetGeometry.spatialReference");if(s&&!b.canProject(s,a))return E(r);var l=R.internalToExternal(e,e.state.camera),u=R.OrientationMode.ADJUST;if(null!=t.rotation&&(l.heading=A(t.rotation),u=R.OrientationMode.LOCKED),null!=n&&(l.tilt=n),"point"===t.targetGeometry.type){var m=t.targetGeometry,f=void 0,p=t.targetGeometry.clone();return f=null!=t.scale?R.scaleToDistance(e,t.scale,m.latitude):e.state.camera.distance,R.fromCenterDistance(e,p,f,l,u,r)}var v=t.targetGeometry.extent;return R.fromExtent(e,v,l.heading,l.tilt,u,r)}function z(e,t,n){return n||(n=new c({camera:new a})),R.internalToExternal(e,t,n.camera),U(e,t,n)}function C(e,t,n){return n||(n=new c),n.camera=t.clone(),U(e,null,n)}function D(e,t,o){return r(this,void 0,void 0,function(){var r,s,l,m,f,p,v,g,d,f,h,b,w,R;return n(this,function(n){switch(n.label){case 0:if(!(r=W(e,t)))throw new u("viewpointutils-create:no-target","Missing target for creating viewpoint");return s=new c({camera:new a({fov:e.camera.fov})}),r.target instanceof c?[4,k(e,r.target,r,o,s)]:[3,2];case 1:return l=n.sent(),[2,Y(l)];case 2:return r.target instanceof a?[2,Y(L(e,r.target,s))]:(m=null!=r.scale||null!=r.zoom,r.target instanceof i.Extent?(f=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax,m||f?(p=Y,[4,I(e,r,r.target.center,o,s)]):[3,4]):[3,6]);case 3:return[2,p.apply(void 0,[n.sent()])];case 4:return v=Y,[4,q(e,r,r.target,o,s)];case 5:return[2,v.apply(void 0,[n.sent()])];case 6:return g={boundingBox:y.empty(),hasZ:!1,screenSpaceObjects:[]},d=m?F(e,r):void 0,[4,Z(e,r.target,d,g)];case 7:return n.sent(),isFinite(g.boundingBox[0])?(y.center(g.boundingBox,Q),ce.x=Q[0],ce.y=Q[1],ce.z=Q[2],ce.spatialReference=e.spatialReference,f=void 0,isFinite(ce.z)&&g.hasZ?f=y.isPoint(g.boundingBox):(ce.z=void 0,f=x.isPoint(y.toRect(g.boundingBox,ne))),m||f?(h=Y,[4,I(e,r,ce,o,s)]):[3,9]):[3,11];case 8:return[2,h.apply(void 0,[n.sent()])];case 9:return b=X(e,g.screenSpaceObjects),w=Y,[4,K(e,r,ce,g.boundingBox,b,o,s)];case 10:return[2,w.apply(void 0,[n.sent()])];case 11:return r.position?[2,Y(H(e,r,s))]:(R=Y,[4,N(e,r,o,s)]);case 12:return[2,R.apply(void 0,[n.sent()])]}})})}function B(e,t){return null==t.scale&&null!=t.zoom?R.zoomToScale(e,t.zoom):t.scale}function F(e,t){return R.scaleToResolution(e,B(e,t))}function P(e,t){var n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=A(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function U(e,t,n){var r=e.spatialReference||i.SpatialReference.WGS84;return t=t||R.externalToInternal(e,n.camera),n.targetGeometry=G.vectorToPoint(t.center,e.renderSpatialReference,r),n.scale=R.computeScale(e,t),n.rotation=M(n.camera.heading),n}function V(e,t,n){if(t){if(!b.canProject(t.spatialReference,e.spatialReference))throw new u("viewpointutils:incompatible-spatialreference","Spatial reference ("+(t.spatialReference?t.spatialReference.wkid:"unknown")+") is incompatible with the view ("+e.spatialReference.wkid+")",{geometry:t});var r=[];if(!t.hasZ&&e.basemapTerrain){var a=void 0;switch(t.type){case"point":a=t;break;case"multipoint":case"polyline":case"mesh":a=t.extent.center;break;case"extent":a=t.center;break;case"polygon":a=t.centroid;break;default:l.neverReached(t)}a&&b.canProject(a,e.basemapTerrain.spatialReference)?Q[2]=e.basemapTerrain.getElevation(a)||0:Q[2]=0}(0,se[t.type])(t,function(e){r.push(e[0],e[1],e[2])},Q);var i=r.length/3;if(0!==i){var o=new Array(r.length);if(G.bufferToBuffer(r,t.spatialReference,0,o,e.spatialReference,0,i)){t.hasZ&&(n.hasZ=!0);for(var c=0;c<o.length;c+=3)t.hasZ?(Q[0]=o[c+0],Q[1]=o[c+1],Q[2]=o[c+2]):(Q[0]=o[c+0],Q[1]=o[c+1]),y.expand(n.boundingBox,Q)}}}}function j(e,t,a,i){return r(this,void 0,void 0,function(){var r,o,c,l,u,f;return n(this,function(n){switch(n.label){case 0:return[4,s.result(e.whenViewForGraphic(t))];case 1:return r=n.sent(),!1!==r.ok&&!m.isNone(r.value)&&"whenGraphicBounds"in r.value?(o=r.value,[4,s.result(o.whenGraphicBounds(t,{minDemResolution:a}))]):(V(e,t.geometry,i),[2]);case 2:return c=n.sent(),!1===c.ok?(V(e,t.geometry,i),[2]):(l=c.value,u=l.screenSpaceObjects,f=l.boundingBox,y.expand(i.boundingBox,f),u&&u.forEach(function(e){i.screenSpaceObjects.push(e)}),isFinite(f[2])&&(i.hasZ=!0),[2])}})})}function Z(e,t,a,c){return r(this,void 0,void 0,function(){var r,s;return n(this,function(n){switch(n.label){case 0:return Array.isArray(t)&&2===t.length&&(r=t[0],s=t[1],"number"==typeof r&&"number"==typeof s)?(ce.x=r,ce.y=s,ce.z=void 0,ce.spatialReference=e.spatialReference.isGeographic?e.spatialReference:i.SpatialReference.WGS84,V(e,ce,c),[2]):t&&"function"==typeof t.map?[4,f.eachAlways(t.map(function(t){return Z(e,t,a,c)}))]:[3,2];case 1:return n.sent(),[2];case 2:return t instanceof i.BaseGeometry?(V(e,t,c),[3,5]):[3,3];case 3:return t instanceof o?[4,j(e,t,a,c)]:[3,5];case 4:n.sent(),n.label=5;case 5:return[2]}})})}function k(e,t,a,i,o){return r(this,void 0,void 0,function(){var r,c,s;return n(this,function(n){switch(n.label){case 0:return t.camera?[2,L(e,t.camera,o)]:(o.scale=t.scale,o.rotation=t.rotation,o.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,o.camera=null,null!=a.heading?o.rotation=M(a.heading):null!=a.rotation&&(o.rotation=a.rotation),r=B(e,a),null!=r&&(o.scale=r),c=R.createAsyncContext(i),O(e,o,a.tilt,c),s=o,[4,c.resolver.promise]);case 1:return s.camera=n.sent(),[2,o]}})})}function L(e,t,n){n.camera=t.clone(),n.camera.fov=e.camera.fov;var r=e.spatialReference,a=n.camera.position.spatialReference;return b.canProject(a,r)?(a.equals(r)||(n.camera.position=b.project(n.camera.position,r)),U(e,null,n)):null}function _(e,t,n,r,a){var o=e.renderSpatialReference;return G.pointToVector(n.position,ae,o),G.pointToVector(t,ie,o),a.targetGeometry=new i.Point(t),a.camera.position=new i.Point(n.position),d.vec3.subtract(re,ie,ae),R.directionToHeadingTilt(e,ae,re,r.up,a.camera),a.scale=R.distanceToScale(e,d.vec3.distance(ae,ie),a.targetGeometry.latitude),a.rotation=M(a.camera.heading),a}function I(e,t,a,i,o){return r(this,void 0,void 0,function(){var r,c,s,l,m,f;return n(this,function(n){switch(n.label){case 0:if(!a)throw new u("createfromcenter","invalid point");return o.targetGeometry=a.clone(),(r=w.cameraOnContentAlongViewDirection(e),t.position)?[2,_(e,o.targetGeometry,t,r,o)]:(t.zoomFactor&&(c=r.distance/t.zoomFactor,s=d.vec3.scale(Q,r.viewForward,-c),d.vec3.add(r.eye,r.center,s),r.markViewDirty(),o.scale=R.distanceToScale(e,c,a.latitude)),R.internalToExternal(e,r,o.camera),l=P(o.camera,t)?R.OrientationMode.LOCKED:R.OrientationMode.ADJUST,t.zoomFactor?[3,2]:(o.scale=B(e,t),null==o.scale&&(G.pointToVector(a,Q,e.renderSpatialReference),T.frustum.intersectsPoint(r.frustum.planes,Q)?o.scale=R.distanceToScale(e,d.vec3.distance(r.eye,Q),a.latitude):o.scale=R.computeScale(e,r)),m=R.createAsyncContext(i),R.fromCenterScale(e,o.targetGeometry,o.scale,o.camera,l,m),f=o,[4,m.resolver.promise]));case 1:f.camera=n.sent(),n.label=2;case 2:return[2,o]}})})}function H(e,t,n){var r=w.cameraOnContentAlongViewDirection(e);return d.vec3.copy(re,r.viewForward),R.directionToHeadingTilt(e,r.eye,re,r.up,oe),n.camera.position=new i.Point(t.position),n.camera.heading=null!=t.heading?t.heading:oe.heading,n.camera.tilt=null!=t.tilt?t.tilt:oe.tilt,U(e,null,n)}function N(e,t,a,i){return r(this,void 0,void 0,function(){var r,o;return n(this,function(n){return r=w.cameraOnContentAlongViewDirection(e),o=G.vectorToPoint(r.center,e.renderSpatialReference,ce,e.spatialReference),[2,I(e,t,o,a,i)]})})}function q(e,t,a,i,o){return r(this,void 0,void 0,function(){var r,c,s,l;return n(this,function(n){switch(n.label){case 0:return o.targetGeometry=a.clone(),r=w.cameraOnContentAlongViewDirection(e),R.internalToExternal(e,r,o.camera),c=P(o.camera,t)?R.OrientationMode.LOCKED:R.OrientationMode.ADJUST,s=R.createAsyncContext(i),R.fromExtent(e,a,o.camera.heading,o.camera.tilt,c,s),l=o,[4,s.resolver.promise];case 1:return l.camera=n.sent(),[2,o]}})})}function J(e,t,n,r,a){var i=0;n.hasZ?i=n.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(n)),d.vec3.set(Q,n.x,n.y,i),G.computeLinearTransformation(e.spatialReference,Q,$,e.renderSpatialReference),p.mat3.fromMat4(ee,$),p.mat3.transpose(ee,ee),y.empty(te);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var s=o[c],l=r[s[2]];isFinite(l)||(l=i),d.vec3.set(Q,r[s[0]],r[s[1]],l),G.vectorToVector(Q,e.spatialReference,Q,e.renderSpatialReference),y.expand(te,d.vec3.transformMat3(Q,Q,ee))}var u=y.width(te),m=y.height(te),f=y.depth(te),v=1/Math.tan(t.fovX/2),g=1/Math.tan(t.fovY/2),h=Math.sqrt(u*u+f*f),x=.5*h*Math.max(g,v)+.5*m,b=.5*m*g+.5*Math.max(u,f);return Math.max(x,b)/a}function K(e,t,a,i,o,c,s){return r(this,void 0,void 0,function(){var r,l,u,m,f;return n(this,function(n){switch(n.label){case 0:return s.targetGeometry=a.clone(),r=w.cameraOnContentAlongViewDirection(e),l=J(e,r,a,i,o),R.internalToExternal(e,r,s.camera),u=P(s.camera,t)?R.OrientationMode.LOCKED:R.OrientationMode.ADJUST,s.scale=R.distanceToScale(e,l,s.targetGeometry.latitude),m=R.createAsyncContext(c),R.fromCenterScale(e,s.targetGeometry,s.scale,s.camera,u,m),f=s,[4,m.resolver.promise];case 1:return f.camera=n.sent(),[2,s]}})})}function W(e,t){if(!t||!e.spatialReference)return null;var n={target:null};if("declaredClass"in t||Array.isArray(t))n.target=t;else{for(var r in t)n[r]=t[r];t.center&&!n.target&&(n.target=t.center)}return n}function Y(e){return e&&(e.rotation=M(e.camera.heading)),e}function X(e,n){var r=t.DEFAULT_FRAME_COVERAGE;if(!n.length)return r;for(var a=Number.NEGATIVE_INFINITY,i=0;i<n.length;i++){var o=n[i].screenSpaceBoundingRect;a=Math.max(a,Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2]),Math.abs(o[3]))}return r-a/Math.min(e.width,e.height)*2}Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_FRAME_COVERAGE=.66,t.rotationToHeading=A,t.headingToRotation=M,t.toCamera=O,t.fromInternalCamera=z,t.fromCamera=C,t.create=D;var Q=h.vec3f64.create(),$=g.mat4f64.create(),ee=v.mat3f64.create(),te=y.create(),ne=x.create(),re=h.vec3f64.create(),ae=h.vec3f64.create(),ie=h.vec3f64.create(),oe={heading:0,tilt:0},ce=new i.Point,se={point:function(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},polygon:function(e,t,n){for(var r=e.hasZ,a=0;a<e.rings.length;a++)for(var i=e.rings[a],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],r&&(n[2]=i[o][2]),t(n)},polyline:function(e,t,n){for(var r=e.hasZ,a=0;a<e.paths.length;a++)for(var i=e.paths[a],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],r&&(n[2]=i[o][2]),t(n)},multipoint:function(e,t,n){for(var r=e.points,a=e.hasZ,i=0;i<r.length;i++)n[0]=r[i][0],n[1]=r[i][1],a&&(n[2]=r[i][2]),t(n)},extent:function(e,t,n){e.hasZ?(t(d.vec3.set(n,e.xmin,e.ymin,e.zmin)),t(d.vec3.set(n,e.xmax,e.ymin,e.zmin)),t(d.vec3.set(n,e.xmin,e.ymax,e.zmin)),t(d.vec3.set(n,e.xmax,e.ymax,e.zmin)),t(d.vec3.set(n,e.xmin,e.ymin,e.zmax)),t(d.vec3.set(n,e.xmax,e.ymin,e.zmax)),t(d.vec3.set(n,e.xmin,e.ymax,e.zmax)),t(d.vec3.set(n,e.xmax,e.ymax,e.zmax))):(t(d.vec3.set(n,e.xmin,e.ymin,n[2])),t(d.vec3.set(n,e.xmax,e.ymin,n[2])),t(d.vec3.set(n,e.xmin,e.ymax,n[2])),t(d.vec3.set(n,e.xmax,e.ymax,n[2])))},mesh:function(e,t,n){var r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(var a=0;a<r.length;a+=3)t(d.vec3.set(n,r[a+0],r[a+1],r[a+2]))}}});