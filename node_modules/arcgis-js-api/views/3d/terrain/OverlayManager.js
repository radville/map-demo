// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../Graphic","../../../core/Accessor","../../../core/Handles","../../../core/has","../../../core/mathUtils","../../../core/mathUtils","../../../core/maybe","../../../core/scheduling","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/Point","../../../geometry/support/aaBoundingRect","../../../layers/support/timeUtils","../../../symbols/SimpleMarkerSymbol","../state/utils/viewUtils","../support/animationUtils","../support/debugFlags","../support/debugFlags","../support/earthUtils","../support/geometryUtils","../support/mathUtils","../support/projectionUtils","../webgl-engine/lib/Intersector","../webgl-engine/lib/localOrigin","../../support/Scheduler"],function(e,t,r,i,a,n,s,o,l,c,h,d,y,u,p,v,_,g,f,w,m,O,x,T,R,S,D,M,I,V,C,b,E){function U(e,t){var r=Math.max(e,t)+256;return l.nextHighestPowerOfTwo(r)}function P(e,t){for(var r=R.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),i=0;i<4;i++)if(Math.abs(t[i]-e[i])>r)return!0;return!1}Object.defineProperty(t,"__esModule",{value:!0});var L,H=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new s,t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._connectedLayers=new Map,t._overlays=null,t._renderedAltitude=0,t._placementDirty=!1,t._drawTexturesDirty=!1,t._drawTexturesAnimateDirty=!1,t._isSpherical=!1,t._longitudeCyclical=null,t._latestOriginId=0,t._maxResolution=o("esri-mobile")?2048:4096,t._animationTimeLast=0,t.opacity=0,t}return r(t,e),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this._renderer=this._stage.renderView.getDrapedRenderer(),this._renderer.onHasHighlightsChanged=function(){return e.onHasHighlightsChanged()},this._renderer.onContentChanged=function(){return e.setDrawTexturesDirty()},this._renderer.onUpdatingChanged=function(){return e._setOverlayUpdating()},this._renderer.forceUpdate=function(t){e.updateOverlays(t),e._drawOverlayTextures()},this.groundIntersector=new C(this.view.viewingMode),this.groundIntersector.options.backfacesTerrain=!0,this.groundIntersector.options.invisibleTerrain=!0,this.groundIntersector.options.hud=!1,this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],function(){return e.setOverlayPlacementDirty()}),this.terrainSurface.on("elevation-change",function(){return e.setOverlayPlacementDirty()}),this.view.on("resize",function(){return e.setOverlayPlacementDirty()}),this.watch("suspended",function(){return e._setOverlayUpdating()},!0),d.addFrameTask({preRender:function(t){e.hasOverlays()&&(e._dispatchRendererUpdate(t),e._drawOverlayTextures())}}),this.view.resourceController.scheduler.registerTask(E.Task.OVERLAY_MANAGER,function(){return e.updateOverlays()},function(){return e.needsUpdate()})])},t.prototype.destroy=function(){var e=this;this._connectedLayers.forEach(function(t){var r=t.layerView;return e._unregisterLayerView(r)}),this._disposeOverlays(),this._handles&&(this._handles.destroy(),this._handles=null)},t.prototype.onHasHighlightsChanged=function(){this.setOverlayPlacementDirty(),this.notifyChange("hasHighlights")},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,this._longitudeCyclical=null,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,t&&(this._longitudeCyclical=e.isWebMercator?new I.Cyclical(-20037508.342787,20037508.342787):new I.Cyclical(-180,180),this._renderer.longitudeCyclical=this._longitudeCyclical)):this._disposeOverlays()},t.prototype.updateLayerViews=function(e){for(var t=this,r=0,i=this.view.allLayerViews.items;r<i.length;r++){var a=i[r];"supportsDraping"in a&&a.supportsDraping&&!this._connectedLayers.has(a.uid)&&this._registerLayerView(a)}this._connectedLayers.forEach(function(r,i){var a=r.layerView;e.has(i)||t._unregisterLayerView(a)})},t.prototype._registerLayerView=function(e){var t=this,r=e.uid,i=e.on("draped-data-change",function(){return t.setOverlayPlacementDirty()});this._connectedLayers.set(r,{eventHandles:[i],layerView:e}),e.setDrapingExtent&&this._overlays&&this._overlays.forEach(function(r,i){e.setDrapingExtent(i,r.extent,t._overlaySR,r.resolution,r.renderLocalOrigin,r.pixelRatio)}),this.setOverlayPlacementDirty(),this._setLayerViewOverlayUpdating(e,this.layerViewOverlayUpdating)},t.prototype._unregisterLayerView=function(e){var t=this;this._connectedLayers.forEach(function(r,i){if(r.layerView===e){if(r.eventHandles)for(var a=0;a<r.eventHandles.length;a++)r.eventHandles[a].remove();t._connectedLayers.delete(i),t.setOverlayPlacementDirty(),e.destroyed||t._setLayerViewOverlayUpdating(e,!1)}})},t.prototype.setOverlayPlacementDirty=function(){this._placementDirty||(this._placementDirty=!0,this._setOverlayUpdating())},t.prototype.updateOverlays=function(e){if(void 0===e&&(e=this.view.state.camera),this._overlaySR){var t=U(e.fullWidth,e.fullHeight),r=Math.min(t,this._maxResolution);this._computeOverlayExtents(e,t,B),this._initOverlays(),this._updateOverlay(0,B.inner,r,1),this._updateOverlay(1,B.outer,r,w.width(B.inner)/w.width(B.outer)),this.opacity=1,this.terrainSurface.updateTileOverlayParams(),this._placementDirty=!1,this.setDrawTexturesDirty(),this.terrainSurface.updateOverlayOpacity()}},t.prototype._updateOverlay=function(e,t,r,i){var a=this,n=this._overlays[e];if(P(t,n.extent)||r!==n.resolution||n.pixelRatio!==i){w.set(n.extent,t),n.resolution=r,n.pixelRatio=i;var s=w.center(n.extent);n.renderLocalOrigin=b.fromValues(s[0],s[1],0,"OV_"+this._latestOriginId++),this._connectedLayers.forEach(function(i){var s=i.layerView;s.setDrapingExtent&&s.setDrapingExtent(e,t,a._overlaySR,r,n.renderLocalOrigin,n.pixelRatio)})}},t.prototype.needsUpdate=function(){return this._placementDirty&&(this._connectedLayers.size>0||this.view.graphics.length>0||S.OVERLAY_DRAW_TEST_TEXTURE)&&!!this._overlaySR&&!this._get("suspended")&&this.terrainSurface.ready},t.prototype.updateOpacity=function(e){return this._overlays?this._getAltitudeBasedOpacity(e,this._renderedAltitude):1},t.prototype._getAltitudeBasedOpacity=function(e,t){if(3.5*e<t){var r=(e-t/10)/(t/3.5-t/10);return Math.sqrt(l.clamp(r,0,1))}return 1},t.prototype.setTileParameters=function(e,t,r){if(this._overlays){var i=this._overlays[0],a=this._overlays[1],n=w.intersection(e.extent,e.surface.extent,G);this._rectInsideRect(n,i.extent)?(this._setTileOverlayData(n,i,t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1])):this._rectanglesOverlap(n,i.extent)?(this._setTileOverlayData(n,i,t.overlays[0]),this._setTileOverlayData(n,a,t.overlays[1])):this._rectanglesOverlap(n,a.extent)?(this._setTileOverlayData(n,a,t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1])):(this._invalidateTileOverlayData(t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1]))}else this._invalidateTileOverlayData(t.overlays[0]),this._invalidateTileOverlayData(t.overlays[1]);t.overlayOpacity=void 0!==r?r:1},t.prototype.overlayPixelSizeInMapUnits=function(e){if(!this._overlays)return 0;var t=this._overlays[0],r=this._overlays[1],i=this._pointIsInExtent(e,t.extent)?t:r;return(i.extent[2]-i.extent[0])/i.resolution},t.prototype._setTileOverlayData=function(e,t,r){var i=t.extent;r.texScale[0]=(e[2]-e[0])/(i[2]-i[0]),r.texScale[1]=(e[3]-e[1])/(i[3]-i[1]);var a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(i[0],a);var n=this._longitudeCyclical.minimalMonotonic(i[0],e[2]);a>n&&(a=n-(e[2]-e[0]))}r.texOffset[0]=(a-i[0])/(i[2]-i[0]),r.texOffset[1]=(e[1]-i[1])/(i[3]-i[1]),r.renderTargetId=t.valid?t.renderTargetId:null,r.highlightRenderTargetId=t.highlightValid?t.highlightRenderTargetId:null,r.waterMaskRenderTargetId=t.waterMaskValid?t.waterMaskRenderTargetId:null},t.prototype._invalidateTileOverlayData=function(e){e.renderTargetId=null,e.highlightRenderTargetId=null,e.waterMaskRenderTargetId=null},t.prototype._createEmptyOverlay=function(e){var t=this._renderer.createRenderTarget("overlay"+e,!0,8,9987),r=this._renderer.createRenderTarget("overlayHighlight"+e,!1,8,9987),i=this._renderer.createRenderTarget("overlayWaterMask"+e,!0,8,9987);return{extent:w.create(),resolution:0,renderTargetId:t,valid:!1,highlightRenderTargetId:r,highlightValid:!1,waterMaskRenderTargetId:i,waterMaskValid:!1,renderLocalOrigin:b.fromValues(0,0,0,"O"),pixelRatio:1}},t.prototype._initOverlays=function(){this._overlays||(this._overlays=[this._createEmptyOverlay(0),this._createEmptyOverlay(1)])},t.prototype._disposeOverlays=function(){var e=this;this._overlays&&(this._overlays.forEach(function(t){e._renderer.disposeRenderTarget(t.renderTargetId),e._renderer.disposeRenderTarget(t.highlightRenderTargetId),e._renderer.disposeRenderTarget(t.waterMaskRenderTargetId)}),this._overlays=null)},t.prototype._dispatchRendererUpdate=function(e){var t=m.Milliseconds(e.time-this._animationTimeLast);if(!(t<T.DESIRED_DRAPED_ANIMATION_MS)){this._animationTimeLast=e.time;this._renderer.updateLogic({dt:t,camera:this._stage.getCamera()})&&(this._drawTexturesAnimateDirty=!0)}},t.prototype.setDrawTexturesDirty=function(){this._overlays?this._drawTexturesDirty||(this._drawTexturesDirty=!0,this._setOverlayUpdating()):this.setOverlayPlacementDirty()},t.prototype._intersectGroundFromView=function(e,t,r,i){var a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,z,t,r),n=a.origin,s=p.vec3.add(q,a.origin,a.direction);return this.groundIntersector.reset(n,s),this.groundIntersector.intersect([],null,e),this.view.basemapTerrain.intersect(this.groundIntersector,null,n,s),this.groundIntersector.results.min.getIntersectionPoint(i)},t.prototype._setLayerViewOverlayUpdating=function(e,t){"overlayUpdating"in e&&(e.overlayUpdating=t)},Object.defineProperty(t.prototype,"layerViewOverlayUpdating",{get:function(){return this.needsUpdate()||this._drawTexturesDirty||this._renderer.updating},enumerable:!0,configurable:!0}),t.prototype._setOverlayUpdating=function(){var e=this,t=this.layerViewOverlayUpdating;this._connectedLayers.forEach(function(r){var i=r.layerView;return e._setLayerViewOverlayUpdating(i,t)});var r=this.view.graphicsView;h.isSome(r)&&(r.overlayUpdating=t)},t.prototype._findHorizonBasedPointOfInterest=function(e,t,r){var i=.5;if("global"===this.view.viewingMode){var a=v.vec3f64.clone(e.eye);p.vec3.normalize(a,a),p.vec3.negate(a,a);var n=p.vec3.length(t),s=Math.asin(n/p.vec3.length(e.eye)),o=Math.acos(p.vec3.dot(e.viewForward,a)),c=s-(o-.5*e.fovY),h=l.clamp(c/e.fovY,0,1),d=-s-(o-.5*e.fovY),y=l.clamp(d/e.fovY,0,1);i=1===h&&0===y?.5:y+.55*(h-y)}else{var u=.5*Math.PI-Math.acos(-e.viewForward[2]),f=Math.tan(u),w=g.vec4f64.fromValues(0,f,1,0),m=_.vec4.transformMat4(w,w,e.projectionMatrix)[1],O=l.clamp(.5+.5*m,0,1);i=1===O||0===O?.5:e.eye[2]>0?.55*O:1-.55*(1-O)}return!!this._intersectGroundFromView(e,.5,i,r)},t.prototype._computeOverlayExtents=function(e,t,r){var i=this.terrainSurface.extent,n=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=v.vec3f64.create();this._findHorizonBasedPointOfInterest(e,n,s)||p.vec3.copy(s,n),this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(e.eye);var o=p.vec3.distance(e.eye,s),l=x.viewAngle(this.view.renderCoordsHelper,n,e.eye),h=Math.PI/2-Math.abs(l-Math.PI/2);if(S.OVERLAY_SHOW_CENTER){var d=new O({color:[255,0,0],outline:{color:[255,255,255],width:2}}),y=new f;V.vectorToPoint(s,this._renderSR,y,this._overlaySR);var g=new a({geometry:y,symbol:d});void 0!==L&&this.view.graphics.remove(L),this.view.graphics.add(g),L=g}this._overlaySREqualsRenderSR||V.vectorToVector(s,this._renderSR,s,this._overlaySR);var m=t*e.perRenderPixelRatio*o/2,T=!1,R=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(m/=Math.cos(V.webMercator.y2lat(s[1])),R=this.terrainSurface.extent[3],R*=.999):(T=!0,m/=D.metersPerDegree,R=90),m>=R&&(m=R,s[1]=0,this._overlaySR.isWebMercator&&(s[0]=0)));var M=1;T&&(M=1/Math.max(.2,Math.cos(Math.abs(c.deg2rad(s[1])))),m*M>180&&(M=180/m));var I=m*M,C=r.inner;C[0]=s[0]-I,C[1]=s[1]-m,C[2]=s[0]+I,C[3]=s[1]+m,this._isSpherical&&this._shiftExtentToFitBounds(C,1/0,R);var b=r.outer;if(w.set(b,C),6*I>i[2]-i[0])w.set(b,i);else if(h<=.25*Math.PI)b[0]-=I,b[1]-=m,b[2]+=I,b[3]+=m;else{V.vectorToVector(e.eye,this._renderSR,q,this._overlaySR),u.vec2.subtract(F,s,q);var E=-Math.atan2(F[1],F[0])+.125*Math.PI;E<0&&(E+=2*Math.PI);var U=Math.floor(E/(.25*Math.PI));_.vec4.scale(F,H[U],2*m),F[0]*=M,F[2]*=M,_.vec4.add(b,b,F)}if(this._isSpherical&&(b[0]=this._longitudeCyclical.clamp(b[0]),b[2]=this._longitudeCyclical.clamp(b[2]),b[1]=Math.max(b[1],-R),b[3]=Math.min(b[3],R)),!this._isSpherical&&i){var P=w.intersection(C,i,G),A=w.intersection(b,i,W);w.contains(P,A)&&(b[2]=b[0],b[3]=b[1])}},t.prototype._drawOverlayTextures=function(){if(this._drawTexturesDirty||this._drawTexturesAnimateDirty){var e=this._drawOverlay(0),t=this._drawOverlay(1);0!==e&&0!==t||this.terrainSurface.updateTileOverlayParams(),this._drawTexturesDirty?(this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._setOverlayUpdating(),this.terrainSurface.requestRender(),this.terrainSurface.setPendingUpdates()):(this._drawTexturesAnimateDirty=!1,this._setOverlayUpdating(),this.terrainSurface.requestRender(0))}},t.prototype._setupGeometryViewsCyclical=function(e,t,r){this._setupGeometryViewsDirect(e,t,r);var i=.001*this._longitudeCyclical.range;if(t[0]-i<=this._longitudeCyclical.min){var a=e.views[e.numViews++];_.vec4.set(a.viewport,0,0,r,r),w.offset(t,this._longitudeCyclical.range,0,a.extent)}if(t[2]+i>=this._longitudeCyclical.max){var a=e.views[e.numViews++];_.vec4.set(a.viewport,0,0,r,r),w.offset(t,-this._longitudeCyclical.range,0,a.extent)}},t.prototype._setupGeometryViewsDirect=function(e,t,r){e.numViews=1;var i=e.views[0];w.set(i.extent,t),_.vec4.set(i.viewport,0,0,r,r)},t.prototype._drawOverlay=function(e){var t=this._overlays[e],r=t.valid,i=t.highlightValid,a=t.waterMaskValid,n=t.extent,s=t.resolution,o=t.pixelRatio;this._longitudeCyclical?this._setupGeometryViewsCyclical(k,n,s):this._setupGeometryViewsDirect(k,n,s),k.width=s,k.height=s,k.pixelRatio=o*this.view.state.camera.pixelRatio,k.index=e;var l=this._renderer,c=l.draw(t.renderTargetId,k),h=l.drawHighlights(t.highlightRenderTargetId,k),d=l.drawNormals(t.waterMaskRenderTargetId,k),y=c!==r||h!==i||d!==a?0:1;return t.valid=c,t.highlightValid=h,t.waterMaskValid=d,y},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):w.intersects(e,t)},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:w.contains(t,e)},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var r=e.x,i=e.y;return r>t[0]&&r<t[2]&&i>t[1]&&i<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,r){var i=0,a=0;e[0]<-t?i=e[0]+t:e[2]>t&&(i=t-e[2]),e[1]<-r?a=e[1]+r:e[3]>r&&(a=r-e[3]),w.offset(e,i,a)},Object.defineProperty(t.prototype,"test",{get:function(){return{overlays:this._overlays,renderer:this._renderer}},enumerable:!0,configurable:!0}),i([y.property()],t.prototype,"view",void 0),i([y.property()],t.prototype,"terrainSurface",void 0),i([y.property({readOnly:!0,aliasOf:"terrainSurface.suspended"})],t.prototype,"suspended",void 0),i([y.property({type:Boolean})],t.prototype,"hasHighlights",null),t=i([y.subclass("esri.views.3d.terrain.OverlayManager")],t)}(y.declared(n));t.OverlayManager=A;var k={width:0,height:0,pixelRatio:0,views:[{viewport:w.create(),extent:w.create()},{viewport:w.create(),extent:w.create()},{viewport:w.create(),extent:w.create()}],numViews:0,index:0},F=g.vec4f64.create(),q=v.vec3f64.create(),B={inner:w.create(),outer:w.create()},G=w.create(),W=w.create(),z=M.ray.create()});