// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/maybe","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4","../../../geometry/support/aaBoundingBox","../support/earthUtils","../support/buffer/BufferPool","../support/buffer/InterleavedLayout","./ElevationData","./TerrainConst","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil"],function(e,r,t,a,n,o,i,u,s,f,c,v,m,l,g){function p(){V.clear(),b.clear()}function y(e){V.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}function E(e,r,a,n,o,f,c){var l=o[0],g=o[1],p=o[2],y=o[3],E=.1*s.earthRadius*(y-g),I=e.numVertsPerRow-1,T=e.numVertsPerRow-1,P=e.numVertsPerRow*e.numVertsPerRow,S=2*I+2*T,h=V.acquire(P+S),M=h.position.typedBuffer,b=h.uv0.typedBuffer,x=n.geometryInfo.boundingBox;u.empty(x);for(var C=r[2]-r[0],L=r[3]-r[1],X=p-l,k=a[0],G=a[1],U=a[2],N=0;N<=I;N++){var H=N/I,Y=l+H*X;_[N]=Math.sin(Y),O[N]=Math.cos(Y),B[N]=H,D[N]=r[0]+H*C}for(var q=f&&!!(1&c),j=f&&!!(2&c),W=0,z=0;z<=T;z++){var F=z/T,J=t.lerp(g,y,F),K=Math.cos(J),Q=Math.sin(J),Z=void 0;f?(Z=s.halfEarthRadius*Math.log((1+Q)/(1-Q)),F=(Z-r[1])/L):Z=180*J/Math.PI;for(var N=0;N<=I;N++){var H=B[N],$=_[N],ee=O[N],re=s.earthRadius;e.samplerData&&(re+=v.ElevationData.sample(D[N],Z,e.samplerData)||0);var te=ee*K*re,ae=$*K*re,ne=Q*re,oe=te-k,ie=ae-G,ue=ne-U;d(oe,ie,ue,x);var se=m.GEOMETRY_VERTEX_STRIDE*W;M[se+0]=oe,M[se+1]=ie,M[se+2]=ue,b[se+0]=H,b[se+1]=F;var fe=A(N,z,I,T);if(fe>-1){var ce=m.GEOMETRY_VERTEX_STRIDE*(P+fe),ve=q&&0===z?-1:j&&z===T?1:0,me=0===ve?oe:-k,le=0===ve?ie:-G,ge=0===ve?ue:s.earthRadius*ve-U;M[ce+0]=me,M[ce+1]=le,M[ce+2]=ge,b[ce+0]=0===ve?w(H,F):H,b[ce+1]=0===ve?E:F,0!==ve&&d(me,le,ge,x)}++W}}n.geometryInfo.numVertsPerRow=e.numVertsPerRow,n.geometryInfo.vertexAttributes=h,n.geometryInfo.skirtLength=E,i.vec4.set(n.geometryInfo.uvOffsetAndScale,0,0,1,1),R(n.geometryInfo,e.numVertsPerRow,f?c:0,e.wireframe)}function I(e,r,t,a){var n=r[0],o=r[1],s=r[2]-n,f=r[3]-o,c=e.clippingArea,l=c?Math.max(0,(c[0]-r[0])/s):0,g=c?Math.max(0,(c[1]-r[1])/f):0,p=c?Math.min(1,(c[2]-r[0])/s):1,y=c?Math.min(1,(c[3]-r[1])/f):1,E=p>l?1/(p-l):1,I=y>g?1/(y-g):1,T=-l*E,P=-g*I,S=.1*s,h=e.numVertsPerRow-1,M=e.numVertsPerRow-1,b=e.numVertsPerRow*e.numVertsPerRow,x=2*h+2*M,_=V.acquire(b+x),O=_.position.typedBuffer,B=_.uv0.typedBuffer,D=a.geometryInfo.boundingBox;u.empty(D);for(var C=0,L=0;L<=M;L++){var X=L/M,k=P+X*I,G=o+X*f;c&&(G<c[1]?(G=c[1],k=0):G>c[3]&&(G=c[3],k=1));for(var U=0;U<=h;U++){var N=U/h,H=T+N*E,Y=n+N*s;c&&(Y<c[0]?(Y=c[0],H=0):Y>c[2]&&(Y=c[2],H=1));var q=e.samplerData?v.ElevationData.sample(Y,G,e.samplerData)||0:0,j=Y-t[0],W=G-t[1],z=q-t[2];d(j,W,z,D);var F=m.GEOMETRY_VERTEX_STRIDE*C;O[F+0]=j,O[F+1]=W,O[F+2]=z,B[F+0]=H,B[F+1]=k;var J=A(U,L,h,h);if(J>-1){var K=m.GEOMETRY_VERTEX_STRIDE*(b+J);O[K+0]=j,O[K+1]=W,O[K+2]=z,B[K+0]=w(H,k),B[K+1]=S}++C}}a.geometryInfo.numVertsPerRow=e.numVertsPerRow,a.geometryInfo.vertexAttributes=_,a.geometryInfo.skirtLength=S,i.vec4.set(a.geometryInfo.uvOffsetAndScale,l,g,p-l,y-g),R(a.geometryInfo,e.numVertsPerRow,0,e.wireframe)}function R(e,r,t,a){var n=(2&t)>0,o=r+(a?1024:0)+(n?2048:0),i=b.get(o);i||(i=T(r,n,a),b.set(o,i)),e.indices=i.values,e.numSurfaceIndices=i.numSurfaceIndices,e.numSkirtIndices=i.numSkirtIndices,e.numWithoutSkirtIndices=e.numSurfaceIndices+(t?6*(r-1)*(a?2:1):0)}function T(e,r,t){var a=e-1,n=e-1,o=e*e,i=2*a+2*n,u=a*n*2*3,s=6*i,f=6*(2*a+n-1);t&&(u*=2,s*=2,f*=2);for(var c,v,m,l,g=o+i>M?new Uint32Array(u+s):new Uint16Array(u+s),p=0,y=0,E=u,I=0,R=0;R<=n;R++){r&&(I=0===R?f:R===n?-f:0),E+=I;for(var T=0;T<=a;T++){var d=A(T,R,a,n);if(d>-1){var w=P(T,R,a,n);0!==w&&(c=p,v=o+d,m=o+(0===T&&1===R?0:d+1),l=p+w,t?(g[E+0]=c,g[E+1]=v,g[E+2]=v,g[E+3]=m,g[E+4]=m,g[E+5]=c,g[E+6]=m,g[E+7]=l,g[E+8]=l,g[E+9]=c,g[E+10]=c,g[E+11]=m,E+=12):(g[E+0]=c,g[E+1]=v,g[E+2]=m,g[E+3]=m,g[E+4]=l,g[E+5]=c,E+=6))}++p,T<a&&R<n&&(c=R*(a+1)+T,v=c+1,m=v+(a+1),l=m-1,t?(g[y+0]=c,g[y+1]=v,g[y+2]=v,g[y+3]=m,g[y+4]=m,g[y+5]=c,g[y+6]=m,g[y+7]=l,g[y+8]=l,g[y+9]=c,g[y+10]=c,g[y+11]=m,y+=12):(g[y+0]=c,g[y+1]=v,g[y+2]=m,g[y+3]=m,g[y+4]=l,g[y+5]=c,y+=6))}E-=I}return{values:g,numSurfaceIndices:u,numSkirtIndices:s}}function d(e,r,t,a){e<a[0]&&(a[0]=e),e>a[3]&&(a[3]=e),r<a[1]&&(a[1]=r),r>a[4]&&(a[4]=r),t<a[2]&&(a[2]=t),t>a[5]&&(a[5]=t)}function w(e,r){var t=r>e?1:0;return 2+4*t+(1-2*t)*(e+r)}function A(e,r,t,a){return 0===r?e:e===t?t+r:r===a?t+a+(t-e):0===e&&r>0?2*t+a+(a-r):-1}function P(e,r,t,a){return 0===r&&e!==t?1:e===t&&r!==a?t+1:r===a&&0!==e?-1:0===e&&0!==r?-(t+1):0}function S(e,r,t,o,i,u,s,f,c){var v,m,l,p=u.position,y=u.uv0,E=e[0],I=e[1],R=e[2],T=r[0],d=r[1],w=r[2],A=T-E,P=d-I,S=w-R;t*=3,o*=3;for(var h=t;h<o;h+=3){var V=i[h],M=i[h+1],b=i[h+2],_=p.get(V,0),O=p.get(V,1),B=p.get(V,2),D=p.get(M,0),X=p.get(M,1),k=p.get(M,2),G=p.get(b,0),U=p.get(b,1),N=p.get(b,2),H=y.get(V,0),Y=y.get(M,0),q=y.get(b,0);H>=2&&(n.vec3.set(C,_,O,B),s(C),_+=C[0],O+=C[1],B+=C[2]),Y>=2&&(n.vec3.set(C,D,X,k),s(C),D+=C[0],X+=C[1],k+=C[2]),q>=2&&(n.vec3.set(C,G,U,N),s(C),G+=C[0],U+=C[1],N+=C[2]),a.isSome(f)&&(v=f.applyToVertex(_,O,B),_=v[0],O=v[1],B=v[2],m=f.applyToVertex(D,X,k),D=m[0],X=m[1],k=m[2],l=f.applyToVertex(G,U,N),G=l[0],U=l[1],N=l[2]);var j=D-_,W=X-O,z=k-B,F=G-_,J=U-O,K=N-B,Q=P*K-J*S,Z=S*F-K*A,$=A*J-F*P,ee=j*Q+W*Z+z*$,re=E-_,te=I-O,ae=R-B,ne=te*z-W*ae,oe=ae*j-z*re,ie=re*W-j*te;if(ee>x){var ue=re*Q+te*Z+ae*$;if(ue<0||ue>ee)continue;var se=A*ne+P*oe+S*ie;if(se<0||ue+se>ee)continue}else{if(!(ee<-x))continue;var ue=re*Q+te*Z+ae*$;if(ue>0||ue<ee)continue;var se=A*ne+P*oe+S*ie;if(se>0||ue+se<ee)continue}var fe=(F*ne+J*oe+K*ie)/ee;if(fe>=0){c(fe,g.computeNormal(j,W,z,F,J,K,L))}}}Object.defineProperty(r,"__esModule",{value:!0});var h=c.newLayout().vec3f(l.VertexAttrConstants.POSITION).vec2f(l.VertexAttrConstants.UV0),V=new f.BufferPool(function(e){return h.createBuffer(e)},function(e){return e.count});r.clearCaches=p,r.releaseGeometry=y;var M=65536;r.createSphericalGlobePatch=E,r.createPlanarGlobePatch=I;var b=new Map,x=Math.pow(2,-52);r.intersectSkirts=S;var _=new Array(m.MAX_PATCH_TESSELATION+1),O=new Array(m.MAX_PATCH_TESSELATION+1),B=new Array(m.MAX_PATCH_TESSELATION+1),D=new Array(m.MAX_PATCH_TESSELATION+1),C=o.vec3f64.create(),L=o.vec3f64.create()});