// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../Color","../../../core/Accessor","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/mathUtils","../../../core/maybe","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/scheduling","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/mat4","../../../core/libs/gl-matrix-2/mat4f64","../../../core/libs/gl-matrix-2/vec3","../../../core/libs/gl-matrix-2/vec3f64","../../../core/libs/gl-matrix-2/vec4f64","../../../geometry/support/aaBoundingRect","../../../layers/support/LercWorker","../../../layers/support/TilemapCache","../../2d/engine/vectorTiles/VectorTile","../support/debugFlags","../support/geometryUtils","../support/projectionUtils","./ElevationBounds","./ElevationData","./ElevationTileAgent","./MapTileAgent","./OverlayManager","./PlanarPatch","./SphericalPatch","./SurfaceExtentHelper","./SurfaceTilingSchemeLogic","./TerrainConst","./TerrainRenderer","./terrainUtils","./Tile","./TilemapOnlyTile","./tileUtils","./tileUtils","./UpsampleInfo","../../support/index","../../webgl/Texture","../../webgl/Util","@dojo/framework/shim/Promise"],function(e,t,i,r,n,a,s,l,o,d,h,u,p,c,_,y,g,f,v,m,T,w,L,b,S,E,P,x,R,O,I,M,C,A,D,V,U,k,j,q,B,H,F,W,N,G,X,Z,z,Y,K,J){function Q(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function $(e,t){var i=!1;t=t||e;for(var r=0,n=e.children;r<n.length;r++){var a=n[r];if(a){for(var s=0;s<a.layerInfo.length;s++)for(var l=0,o=a.layerInfo[s];l<o.length;l++){var d=o[l],h=d.upsampleInfo;if(h&&h.tile===t)return!0}i=i||$(a,t)}}return i}function ee(e){return null!=e.refreshInterval}function te(e){return!e.isLeaf&&(e.children[0].shouldRender||e.children[1].shouldRender||e.children[2].shouldRender||e.children[3].shouldRender||te(e.children[0])||te(e.children[1])||te(e.children[2])||te(e.children[3]))}function ie(e){return e.isLeaf&&e.parent&&e.parent.shouldRender}var re=u.getLogger("esri.views.3d.terrain.TerrainSurface"),ne=function(t){function s(e){var i=t.call(this,e)||this;return i.defaultTileBackground=H.DEFAULT_TILE_BACKGROUND,i.hideSkirtsDistanceFromExtentMargin=ae,i.hideSkirtsMinimumCameraTilt=se,i.hideSkirtsMaximumCameraTilt=le,i._clippingExtent=null,i._dataExtent=null,i._elevationBounds=new C.ElevationBounds,i._rootExtent=E.create(),i._iteratorPool=new _(Z.IteratorPreorder),i._postorderIterator=new Z.IteratorPostorder,i._visible=!1,i._pendingUpdates=!1,i._asyncWorkItems=0,i._usedMemory=oe,i._isFrameProcessing=!1,i._viewChangeUpdateDirty=!1,i._overlayOpacity=1,i._eyePosRenderSR=b.vec3f64.create(),i._eyePosSurfaceSR=b.vec3f64.create(),i._splitLimits=new N.SplitLimits,i._snapLevel=1/0,i._frustum=I.frustum.create(),i._viewProjectionMatrix=w.mat4f64.create(),i._layerViews=[new Array,new Array],i._layerIndexByLayerViewId=[new Map,new Map],i._basemapLayerViewHandles=new Map,i._handles=new h,i._allTiles=new y,i._topLevelTilemapOnlyTiles=new Array,i._upsampleInfoPool=new _(z),i._visibleLevels=new y({deallocator:null}),i._getElevationData={spatialReference:null,rootTiles:null},i.maxTextureScale=1.2,i.rootTiles=null,i.backgroundImage=H.DEFAULT_TILE_BACKGROUND,i.backgroundColor=null,i._scheduledLayerViewChangesHandle=null,i}return r(s,t),s.prototype.initialize=function(){var t=this;this._stage=this.view._stage,this._lercWorker=P.acquireInstance(this.view.resourceController.scheduler),this._tilePool=new _("planar"===this.manifold?k.PlanarPatch:j.SphericalPatch),this._upsampleMapCache=this.view.resourceController.memoryController.getMemCache("esri.views.3d.terrain.upsample",function(e){return e.unloadMapData()}),this._renderer=new F({manifold:this.manifold}),this._renderer.install(this.view._stage),v.init(this,"_background",function(){t._renderer.setTileBackground(t._background)},!0),this._handles.add([this.view.watch("pointsOfInterest",function(e){t._renderer.pointsOfInterest=e}),v.init(O,"TERRAIN_TILE_TREE_SHOW_TILES",function(i){i&&!t._treeDebugger?new Promise(function(t,i){e(["../layers/support/TerrainTileTree3DDebugger"],t,i)}).then(function(e){var i=e.TerrainTileTree3DDebugger;!t._treeDebugger&&O.TERRAIN_TILE_TREE_SHOW_TILES&&(t._treeDebugger=new i({view:t.view}))}):i||!t._treeDebugger||O.TERRAIN_TILE_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)})]),this._set("overlayManager",new U.OverlayManager({terrainSurface:this,view:this.view})),this._handles.add(this.watch("overlayManager.hasHighlights",function(e){return t._handleHasHighlights(e)}),"overlayManager");var i={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper="spherical"===this.manifold?new q.SurfaceExtentHelperGlobal(i):new q.SurfaceExtentHelperLocal(i),this._handles.add(v.init(this.extentHelper,"stencilEnabledExtents",function(e){return t._renderer.setStencilEnabledLayerExtents(e)}),"extentHelper");var r=this.view.defaultsFromMap?new o({root:this.view.map,rootCollectionNames:this.view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(e){return e.layers}}):this.view.map.allLayers,n=new B({layers:r,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",n),this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",function(){return t._updateTilingSchemeAndExtent()},!0),this.tilingSchemeLogic.watch("extent",function(){return t._updateTilingSchemeAndExtent()},!0)],"tilingSchemeLogic"),this._updateTilingSchemeAndExtent(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);var a=this.view.resourceController.scheduler;this._handles.add(a.registerTask(Y.Task.TERRAIN_SURFACE,function(e){return t._frame(e)},function(){return t.updating})),this.view.resourceController.memoryController.events.on("quality-changed",function(){return t._viewChangeUpdate()}),this._handles.add([this.view.on("resize",function(){return t._viewChangeUpdate()}),this.view.watch("state.camera",function(){return t._viewChangeUpdate()},!0),this.view.watch("qualitySettings.tiledSurface.lodBias",function(){return t._viewChangeUpdate()}),this.view.watch("lodSnapping",function(){return t._viewChangeUpdate()}),this.view.watch("clippingArea",function(){return t._clippingChanged()})]),this._handles.add(this.view.allLayerViews.on("after-changes",function(){return t._scheduleLayerViewChangesUpdate()})),this._handleLayerViewChanges(),this._updateClippingExtent(),this.notifyChange("extent")},s.prototype.destroy=function(){var e=this;this._handles.destroy(),P.releaseInstance(this._lercWorker),this._lercWorker=null,this._removeAllTiles(),this._upsampleMapCache.destroy(),this._upsampleMapCache=null,this.tilingSchemeLogic.destroy(),this._set("tilingSchemeLogic",null),this.extentHelper.destroy(),this.extentHelper=null,this._basemapLayerViewHandles.forEach(function(t,i){return e._unregisterTiledLayerView(i)}),this._elevationDataRequester=null,this._mapDataRequester=null,this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null)),this._tilePool.destroy(),this._tilePool=null,D.Pool.prune(0),V.Pool.prune(0),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer.uninstall(this._stage),this._renderer.destroy(),this._renderer=null,this._iteratorPool.destroy(),this._iteratorPool=null,this._set("view",null),this._stage=null,this._upsampleInfoPool.destroy(),this._upsampleInfoPool=null},Object.defineProperty(s.prototype,"renderer",{get:function(){return this._renderer},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"frustum",{get:function(){return this._frustum},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"snapLevel",{get:function(){return Math.round(this._snapLevel)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"upsampleInfoPool",{get:function(){return this._upsampleInfoPool},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"upsampleMapCache",{get:function(){return this._upsampleMapCache},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"cullBackFaces",{set:function(e){this._renderer.cullBackFaces=e,this._set("cullBackFaces",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"updating",{get:function(){return!(!(this._pendingUpdates||this._renderer.updating||this._scheduledLayerViewChangesHandle)||!this.ready||this._get("suspended"))},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"baseOpacity",{set:function(e){var t=this._renderer.opaque;this._renderer.opaque=e>=1,this._set("baseOpacity",e);var i=t!==this._renderer.opaque;this._updateTileTextures(i)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"renderOrder",{set:function(e){this._renderer.renderOrder=e,this._set("renderOrder",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"skirtScale",{set:function(e){this._renderer.skirtScale=e,this._set("skirtScale",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"spatialReference",{get:function(){var e=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=e,e},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"_background",{get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"slicePlaneEnabled",{set:function(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"velvetOverground",{set:function(e){e!==this.velvetOverground&&(this._renderer.velvetOvergroundEnabled=e),this._set("velvetOverground",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"wireframe",{set:function(e){this._renderer.setWireframe(e),this._set("wireframe",e)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"visible",{set:function(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)},enumerable:!0,configurable:!0}),s.prototype.isOpaque=function(){return this._renderer.opaque},Object.defineProperty(s.prototype,"suspended",{set:function(e){this._set("suspended",e),this._viewChangeUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"lodSnapping",{get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?0:1},enumerable:!0,configurable:!0}),s.prototype.intersect=function(e,t,i,r){this._renderer.intersect(e,t,i,r)},s.prototype.getElevation=function(e){var t=this._getElevationData.rootTiles;if(!t||!t.length)return null;if(0===t[0].layerInfo[0].length)return null;var i=de;if(Array.isArray(e))i=e;else{var r=e;if("point"===r.type&&!M.pointToVector(r,i,this._getElevationData.spatialReference))return re.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null}for(var n=0,a=t;n<a.length;n++){var s=a[n];if(s.containsPoint(i)){for(;s&&!s.rendered&&!s.isLeaf;){var l=0;i[0]>.5*(s.extent[0]+s.extent[2])&&(l+=1),i[1]<.5*(s.extent[1]+s.extent[3])&&(l+=2),s=s.children[l]}var o=s.renderData,d=o&&o.geometryState?o.geometryState.samplerData:null;return d?A.ElevationData.sample(i[0],i[1],d):null}}return null},Object.defineProperty(s.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!0,configurable:!0}),s.prototype.getScale=function(e){if(this.tilingScheme){if(!M.pointToVector(e,de,this.spatialReference))return re.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;var t=this.rootTiles;if(t)for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.containsPoint(de)){for(;null!=n.children[0];){var a=0;de[0]>n.children[0].extent[2]&&(a+=1),de[1]<n.children[0].extent[1]&&(a+=2),n=n.children[a]}return this._getLodBiasCorrectedScale(n.level)}}}return 1e100},s.prototype.queryVisibleScaleRange=function(e,t,i,r){var n=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,s=this._getLodBias();this._renderer.queryVisibleLevelRange(e,n+s,a+s,r)},s.prototype._updateTilingSchemeAndExtent=function(){var e=this.tilingSchemeLogic.extent,t=e&&!E.equals(e,this._dataExtent);t&&(this._dataExtent?E.set(this._dataExtent,e):this._dataExtent=E.create(e));var i=this.tilingSchemeLogic.tilingScheme,r=i!==this.tilingScheme;r&&(W.weakAssert(!!i,"tiling scheme cannot be reset to undefined"),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference,"spherical"===this.manifold))),(t||r)&&this._updateRootTiles()},s.prototype._acquireTile=function(e,t,i,r){var n=this._tilePool.acquire();return ue[0]=e,ue[1]=t,ue[2]=i,n.init(ue,r,this),n},s.prototype._updateRootTiles=function(){var e=this,t=this._clippingExtent||this._dataExtent,i=this.tilingScheme;if(t&&i){var r=he,n=i.rootTilesInExtent(t,r,1/0),a=function(t){var i=e._acquireTile(0,t[1],t[2],null);return 1===i.shouldSplit(e._splitLimits,e._eyePosRenderSR,e.lodSnapping)&&i.setPendingUpdate(1),e._loadTile(i),i};if(this.rootTiles){if(n.length>H.MAX_ROOT_TILES)return void re.warn(H.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);var s=this.rootTiles.map(function(e){return e.lij}),o=l.difference(s,n,Q);if(o.removed.length>0||o.added.length>0){var d=this.rootTiles.filter(function(t){return!(l.findIndex(o.removed,Q.bind(null,t.lij))>-1&&(e._purgeTile(t),1))});o.added.forEach(function(e){return d.push(a(e))}),this._setRootTiles(d)}}else n.length>H.MAX_ROOT_TILES&&(re.warn(H.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),n=i.rootTilesInExtent(t,r,H.MAX_ROOT_TILES)),this._setRootTiles(n.map(function(e){return a(e)}));E.equals(r,this._rootExtent)||(this._rootExtent=E.create(r),this._hasFixedExtent()||this.notifyChange("extent")),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setOverlayPlacementDirty(),this.notifyChange("ready")}},s.prototype._setRootTiles=function(e){this._set("rootTiles",e),this._allTiles.clear(),e&&this._allTiles.pushArray(e),this._getElevationData.rootTiles=e,this._renderer.setRootTiles(this.rootTiles),this._updateTiles(e)},s.prototype._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())},s.prototype._viewChangeUpdate=function(){if(this._stage&&!this.suspended&&this.tilingScheme&&this._visible){if(this._isFrameProcessing)return void(this._viewChangeUpdateDirty=!0);this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTiles(this.rootTiles)}},s.prototype._updateClippingStatus=function(e){e.updateClippingStatus(this._clippingExtent)&&e.resetPendingUpdate(16)&&this._updateTileGeometry(e)},s.prototype._updateTiles=function(e){if(e){var t=this._iteratorPool.acquire();t.reset(e);var i,r;for(X.hasVisibleSiblings(e)?(i=this._elevationBounds.min,r=this._elevationBounds.max):(i=1/0,r=-1/0);!t.done;){var n=t.next();if(this._updateClippingStatus(n),n.updateVisibility(),n.setPendingUpdate(8),n.visible){n.updateScreenDepth(this._viewProjectionMatrix),n.renderData&&(i=Math.min(n.elevationBounds[0],i),r=Math.max(n.elevationBounds[1],r));var a=n.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(1===a){n.resetPendingUpdate(4),n.isLeaf&&(n.setPendingUpdate(1),t.skipSubtree()),this._pendingUpdates=this._pendingUpdates||n.updating;continue}n.resetPendingUpdate(1)&&n.updateAgentSuspension(),2===a&&n.updateAgents(0)}if(t.skipSubtree(),!n.isLeaf){n.setPendingUpdate(4),n.resetPendingUpdate(1);var s=this._iteratorPool.acquire();for(s.resetOne(n);!s.done;){var l=s.next();this._updateClippingStatus(l),l.updateVisibility(),l.visible&&l.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(s)}this._pendingUpdates=this._pendingUpdates||n.updating}this._iteratorPool.release(t),isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}},s.prototype._updateViewDependentParameters=function(){var e=this.view.state.camera,t=Math.tan(.5*e.fovX),i=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,n=Math.pow(2,-this._getLodBias())*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=i,this._splitLimits.relativeWidthLimit=r/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=r/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,I.frustum.copy(e.frustum,this._frustum),T.mat4.multiply(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),L.vec3.copy(this._eyePosRenderSR,e.eye),M.vectorToVector(this._eyePosRenderSR,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)},s.prototype._updateSnapLevel=function(){if(1!==this.lodSnapping){var e=O.TESTS_DISABLE_UPDATE_THRESHOLDS?0:.1,t=this._findSnapLevel();if(!(Math.abs(this._snapLevel-t)<e)){var i=this.snapLevel;this._snapLevel=t,i!==this.snapLevel&&this._updateTiles(this.rootTiles)}}},s.prototype._findSnapLevel=function(){if(this._visibleLevels.length<=0)return this._snapLevel;var e=Math.abs(this.view.camera.tilt-90)/90*.4+.3,t=this._visibleLevels,i=Math.round(t.length*e);if(i>=t.length)return this._snapLevel;t.sort(function(e,t){return e-t});for(var r=0,n=i;n<t.length;++n)r+=t.getItemAt(n);var a=t.getItemAt(Math.round(.95*t.length)-1),s=r/(t.length-i);return Math.max(s,a-1)},s.prototype._updateSkirts=function(){var e=this.view.state.camera,t=this.view.state.constraints.collision.enabled?0:1.11*e.near;W.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,t)},s.prototype._updateRender=function(e){e.rendered&&!e.shouldRender&&(te(e)?this._loadChildren(e):ie(e)&&this._loadParent(e))},s.prototype._updateTileGeometry=function(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._elevationUpdate(e),this._usedMemory=oe},s.prototype._elevationUpdate=function(e){ce.spatialReference=this.spatialReference,ce.tile=e,ce.extent=e.extent,this.emit("elevation-change",ce),E.containsPoint(e.extent,this._eyePosSurfaceSR)&&this._updateSkirts()},s.prototype._frame=function(e){var t=this;this._isFrameProcessing=!0,this._frameTraversal(e),e.run(function(){return t._processElevation(e)}),e.run(function(){return t._processTextures(e)}),0!==this._asyncWorkItems&&(this._pendingUpdates=!0),this._isFrameProcessing=!1,this._runViewChangeUpdateIfDirty(),this.notifyChange("updating")},s.prototype._frameTraversal=function(e){var t=this;if(!this.suspended&&this._pendingUpdates){var i=this._eyePosRenderSR,r=0,n=!1;this._pendingUpdates=!1,this._visibleLevels.clear();for(var a=function(){},s=0===this.lodSnapping?function(e){e.visible&&1!==e.shouldSplit(t._splitLimits,i,1)&&e.parent&&1===e.parent.shouldSplit(t._splitLimits,i,1)&&t._visibleLevels.push(e.level)}:a;!e.done;){var l=!this._allTiles.some(function(i){return r+=i.usedMemory,s(i),i.resetPendingUpdate(4)?(t._mergeTile(i),n=!0,e.madeProgress()):i.resetPendingUpdate(1)&&(t._splitTile(i),n=!0,e.madeProgress()),i.resetPendingUpdate(8)&&(t._updateRender(i),e.madeProgress()),t._pendingUpdates=t._pendingUpdates||i.updating,e.done});if(this._pendingUpdates=this._pendingUpdates||!l,l&&s!==a&&this._updateSnapLevel(),s=a,n)this._pendingUpdates=!0,n=!1,X.sortTiles(this._renderer.renderOrder,this._allTiles),this._treeDebugger&&this._treeDebugger.update();else if(l){this._usedMemory=r;break}}this._visibleLevels.clear()}},s.prototype._processElevation=function(e){var t=this;return this._allTiles.some(function(i){return i.resetPendingUpdate(16)&&(t._updateTileGeometry(i),e.madeProgress()),e.done}),e.hasProgressed},s.prototype._processTextures=function(e){var t=this;return this._allTiles.some(function(i){return i.resetPendingUpdate(32)&&(t._renderer.updateTileTexture(i),t._usedMemory=oe,e.madeProgress()),e.done}),e.hasProgressed},s.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var e=E.create(),t=null;return M.extentToBoundingRect(this.view.clippingArea,e,this.spatialReference)&&(t=e),!E.equals(t,this._clippingExtent)&&(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),this.updateTileOverlayParams(),this.overlayManager.setOverlayPlacementDirty(),!0)},s.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()},s.prototype._getLodBias=function(){var e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*H.MAX_MEMORY_LOD_BIAS},s.prototype._getLodBiasCorrectedScale=function(e){var t=this.tilingScheme.levels,i=p.clamp(e-this._getLodBias(),0,t.length-1),r=Math.floor(i),n=i-r;return t[Math.floor(i)].scale*(1-n)+t[Math.ceil(i)].scale*n},s.prototype._cancelTilemapRequests=function(e){for(var t=0,i=e.layerInfo;t<i.length;t++){var r=i[t];if(r)for(var n=0,a=r;n<a.length;n++){var s=a[n];s.abortTilemapRequest()}}},s.prototype._removeAllTiles=function(){var e=this;this.rootTiles&&(this.rootTiles.forEach(function(t){return e._purgeTile(t)}),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear();for(var t=0,i=this._topLevelTilemapOnlyTiles;t<i.length;t++){var r=i[t];c.isSome(r)&&this._cancelTilemapRequests(r)}this.visible=!1},s.prototype._purgeChildTiles=function(e){if(e.isLeaf)return!1;var t=this._purgeTile(e.children[0]);return t=this._purgeTile(e.children[1])||t,t=this._purgeTile(e.children[2])||t,t=this._purgeTile(e.children[3])||t,e.unsetChildren(),t},s.prototype._purgeTile=function(e){var t=this._purgeChildTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),e.unload(this._renderer),this._cancelTilemapRequests(e),this._tilePool.release(e),t},s.prototype._splitTile=function(e){W.weakAssert(e.isLeaf,"tile that is already split should not be split again!");var t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];return e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(8),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),_e.spatialReference=this.spatialReference,_e.extent=e.extent,_e.scale=this._getLodBiasCorrectedScale(t),this._pendingUpdates=!0,this.emit("scale-change",_e),e.children[0].hasPendingUpdate(1)||e.children[1].hasPendingUpdate(1)||e.children[2].hasPendingUpdate(1)||e.children[3].hasPendingUpdate(1)},s.prototype._createTile=function(e,t,i,r){W.weakAssert(!!r,"_createTile sanity check");var n=this._acquireTile(e,t,i,r);return n.updateClippingStatus(this._clippingExtent),n.visible&&(n.updateScreenDepth(this._viewProjectionMatrix),1===n.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&n.setPendingUpdate(1)),n},s.prototype._mergeTile=function(e){W.weakAssert(!e.hasPendingUpdate(1),"_mergeTile sanity check"),this._purgeChildTiles(e)&&(W.weakAssert(!e.renderData,"_mergeTile sanity check"),this._loadTile(e)),_e.spatialReference=this.spatialReference,_e.extent=e.extent,_e.scale=this._getLodBiasCorrectedScale(e.level),this._pendingUpdates=!0,this.emit("scale-change",_e)},s.prototype._loadChildren=function(e){W.weakAssert(e.rendered,"parent should be rendered"),e.unload(this._renderer),this._loadTile(e.children[0]),this._loadTile(e.children[1]),this._loadTile(e.children[2]),this._loadTile(e.children[3])},s.prototype._loadParent=function(e){var t=e.parent;this._unloadChildren(t),this._loadTile(t)},s.prototype._unloadChildren=function(e){e.isLeaf||(this._unloadChildren(e.children[0]),e.children[0].unload(this._renderer),this._unloadChildren(e.children[1]),e.children[1].unload(this._renderer),this._unloadChildren(e.children[2]),e.children[2].unload(this._renderer),this._unloadChildren(e.children[3]),e.children[3].unload(this._renderer))},s.prototype._loadTile=function(e){e.load(this._renderer),e.setPendingUpdate(8),this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setTileParameters(e,e.renderData,this._overlayOpacity),this._elevationUpdate(e)},s.prototype._handleHasHighlights=function(e){this._renderer.setNeedsHighlight(e)},s.prototype._elevationDataArrived=function(e,t,i){var r=new A.ElevationData(e.lij,e.extent,i);e.dataArrived(t,0,r);var n=[e],a=e.level,s=this._iteratorPool.acquire();for(s.reset(n);!s.done;){var l=s.next();l.findElevationBoundsForLayer(t,a),l.computeElevationBounds()}this._iteratorPool.release(s),this._updateTiles(n)},s.prototype._scheduleLayerViewChangesUpdate=function(){var e=this;this._scheduledLayerViewChangesHandle||(this._scheduledLayerViewChangesHandle=f.schedule(function(){return e._handleLayerViewChanges()}),this._handles.add(this._scheduledLayerViewChangesHandle,"scheduledLayerViewChangesHandle"))},s.prototype._handleLayerViewChanges=function(){var e=this;this._handles.remove("scheduledLayerViewChangesHandle"),this._scheduledLayerViewChangesHandle=null;for(var t=!1,i=new Set,r=-1,n=0,a=this.view.allLayerViews.items;n<a.length;n++){var s=a[n];if(i.add(s.uid),W.isTiledLayerView(s))if(this._basemapLayerViewHandles.has(s.uid)){var l=this.layerClassFromLayerView(s),o=this._layerIndexByLayerViewId[l].get(s.uid);o<r&&(t=!0),r=o}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(function(r,n){i.has(n)||(e._unregisterTiledLayerView(n),t=!0)}),this.overlayManager&&this.overlayManager.updateLayerViews(i),t&&this._updateTiledLayers()},s.prototype.layerClassFromLayerView=function(e){return W.isElevationLayerView(e)?0:1},s.prototype._registerTiledLayerView=function(e){var t=this,i=[],r=this.layerClassFromLayerView(e);i.push(e.watch("suspended",function(){return t._updateTiledLayers()})),i.push(e.watch("fullOpacity",function(){return t._updateTileTextures(!1)})),i.push(e.layer.watch("scaleRangeId",function(){return t._restartAllAgents(r)})),e.on("data-changed",function(){var i=t._layerIndexByLayerViewId[r].get(e.uid);null!=i&&t._invalidateLayerData(i,r)}),this._basemapLayerViewHandles.set(e.uid,i)},s.prototype._unregisterTiledLayerView=function(e){var t=this._basemapLayerViewHandles.get(e);if(t){for(var i=0;i<t.length;i++)t[i].remove();this._basemapLayerViewHandles.delete(e)}},s.prototype._updateTiledLayers=function(){var e=this;if(this.tilingScheme&&!this.view.suspended){var t=this.view.allLayerViews,i=[[],[]],r=null,n=E.empty();t.forEach(function(t){var a=t.layer;if(a&&!t.suspended&&W.isTiledLayerView(t)){var s=t.fullExtent;if(!s)return void re.warn("Terrain: Map or elevation layer does not have fullExtent: "+a.id);if(!e.tilingScheme.compatibleWith(t.tileInfo))return void re.warn("Terrain: tiling scheme of layer "+a.id+" is incompatible with other tiled layers, will not be drawn");E.expand(n,s);var l=e.layerClassFromLayerView(t);if(1===l){var o=t.displayLevelRange;o.maxLevel!==1/0&&(null===r||o.maxLevel>r)&&(r=o.maxLevel)}i[l].push(t)}});for(var a=0;a<2;a++){var s=this._layerViews[a],l=i[a];l.reverse();var o=l.length,d=s.length!==o,h=new Array(o),u=new Array(s.length);this._layerIndexByLayerViewId[a].clear();for(var p=0;p<o;p++){var _=l[p].uid;this._layerIndexByLayerViewId[a].set(_,p);var y=s.indexOf(l[p]);h[p]=y,p!==y&&(d=!0),y>-1&&(u[y]=p)}if(d){for(var g=0,f=this._topLevelTilemapOnlyTiles;g<f.length;g++){var v=f[g];c.isSome(v)&&v.modifyLayers(u,h,a)}var m=this._postorderIterator;for(m.reset(this.rootTiles);!m.done;)m.next().modifyLayers(u,h,a);this._layerViews[a]=l,this._restartAllAgents(a),this._updateTiles(this.rootTiles)}}this.tilingScheme.ensureMaxLod(r)&&this._viewChangeUpdate()}},s.prototype._restartAllAgents=function(e){var t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){var i=t.next();i.restartAgents(e),0===e&&i.computeElevationBounds()}},s.prototype._hasFixedExtent=function(){return!!this._clippingExtent},s.prototype.layerViewByIndex=function(e,t){return this._layerViews[t][e]},s.prototype.numLayers=function(e){return this._layerViews[e].length},s.prototype._updateTileTextures=function(e){var t=this;this._allTiles.forEach(function(i){i.updateAgents(1),e?t.renderer.updateTileTexture(i):i.updateRenderData(1)})},s.prototype._invalidateLayerData=function(e,t){this._allTiles.forEach(function(i){return i.removeLayerAgent(e,t)}),this._allTiles.forEach(function(i){return i.invalidateLayerData(e,t)})},s.prototype.requestRender=function(e){void 0===e&&(e=1),this.renderer.setNeedsRender(e)},s.prototype.setPendingUpdates=function(){this._pendingUpdates||(this._pendingUpdates=!0,this.notifyChange("updating"))},s.prototype.requestTileData=function(e,t,i,r){var n=this,a=this.layerViewByIndex(t,i),s=a.layer;if(s.tilemapCache&&!W.isVectorTileLayerView(a)){var l=this.getTilemapTile(e),o=l.layerInfo[i][t];if(!o.tilemap)return o.tilemapRequestPromise||(o.tilemapRequestAbort=g.createAbortController(),o.tilemapRequestPromise=this.requestTilemap(l,t,i,a,s,{signal:o.tilemapRequestAbort.signal})),++this._asyncWorkItems,o.tilemapRequestPromise.catch(function(){}).then(function(){--n._asyncWorkItems,o.tilemapRequestPromise=null,o.tilemapRequestAbort=null,g.throwIfAborted(r);var t=n._layerIndexByLayerViewId[i].get(a.uid);if(null!=t)return l.hasDataAvailable(e,t,i)?n._requestTileData(e,i,a,r):(n._dataMissing(e,i,a,{notInTilemap:!0}),g.reject())});if(!l.hasDataAvailable(e,t,i))return this._dataMissing(e,i,a,{notInTilemap:!0}),g.reject()}return this._requestTileData(e,i,a,r)},s.prototype._requestTileData=function(e,t,i,r){return 0===t?this._requestElevationTileData(e,i,r):this._requestMapTileData(e,i,r)},s.prototype._requestElevationTileData=function(e,t,i){var r=this;if(!W.isElevationLayerView(t))return void W.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views");var n=function(i){--r._asyncWorkItems;var n=r._layerIndexByLayerViewId[0].get(t.uid);if(null==n)return void re.warn("TerrainSurface: received data from unknown layer %d %s",0,e.lij.toString());r._usedMemory=oe,r._pendingUpdates=!0,r._elevationDataArrived(e,n,i)},a=function(i){--r._asyncWorkItems,g.isAbortError(i)||r._dataMissing(e,0,t,i)};if(++this._asyncWorkItems,W.useFetchTileForLayer(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:H.ELEVATION_NODATA_VALUE,signal:i.signal}).then(function(e){if(g.isAborted(i))return re.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(g.createAbortError());n(e)},a);var s=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(s,"binary",i).then(function(e){return r._lercWorker.decode(e,{noDataValue:H.ELEVATION_NODATA_VALUE},i.signal)}).then(function(e){n({values:e.pixelData,width:e.width,height:e.height,noDataValue:e.noDataValue,minValue:e.minValue,maxValue:e.maxValue})}).catch(a)},s.prototype._requestMapTileData=function(e,t,i){var r=this;++this._asyncWorkItems;var n=function(i){--r._asyncWorkItems,r._dataArrived(e,1,t,i)},a=function(i){--r._asyncWorkItems,g.isAbortError(i)||r._dataMissing(e,1,t,i)};if(W.isVectorTileLayerView(t)){var s=t.tileHandler,l=t.schemaHelper.getLevelRowColumn(e.lij);return s.getVectorTile(l[0],l[1],l[2]).then(function(e){g.isAborted(i)?--r._asyncWorkItems:n(e)},a)}if(W.useFetchTileForLayer(t.layer)&&W.isTileLayerView(t)){
return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(function(e){if(g.isAborted(i))return re.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(g.createAbortError());n(e)},a)}var o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return ee(t)&&t.refreshTimestamp&&(o+=(o.indexOf("?")>-1?"&":"?")+"_ts="+t.refreshTimestamp),this._mapDataRequester.request(o,"image",i).then(n,a)},s.prototype.requestTilemap=function(e,t,r,n,a,s){var l=this,o=e.lij[0]+x.TILEMAP_SIZE_EXP,d=Math.round(e.lij[1]*Math.pow(2,x.TILEMAP_SIZE_EXP)),h=Math.round(e.lij[2]*Math.pow(2,x.TILEMAP_SIZE_EXP));return a.tilemapCache.fetchTilemap(o,d,h,i({},s,{timeout:6e3})).then(function(i){null!=(t=l._layerIndexByLayerViewId[r].get(n.uid))&&(e.layerInfo[r][t].tilemap=i)}).catch(function(){})},s.prototype.getTilemapTile=function(e){var t=e.level;if(t>x.TILEMAP_SIZE_EXP)return X.getTileNLevelsUp(e,x.TILEMAP_SIZE_EXP);var i=this._topLevelTilemapOnlyTiles[t];if(c.isSome(i))return i;var r=X.getRootTile(e),n=x.TILEMAP_SIZE_EXP-t+r.level,a=[t-x.TILEMAP_SIZE_EXP,r.lij[1]/Math.pow(2,n),r.lij[2]/Math.pow(2,n)];return i=new G(a,this._upsampleInfoPool,[this._layerViews[0].length,this._layerViews[1].length]),this._topLevelTilemapOnlyTiles[t]=i,i},s.prototype._dataArrived=function(e,t,i,r){var n=this._layerIndexByLayerViewId[t].get(i.uid);null!=n?e.dataArrived(n,t,r):re.warn("TerrainSurface: received data from unknown layer")},s.prototype._dataMissing=function(e,t,i,r){var n=this._layerIndexByLayerViewId[t].get(i.uid);null!=n?e.dataMissing(n,t,r):re.warn("TerrainSurface: received data from unknown layer")},s.prototype.updateTileOverlayParams=function(){var e=this;this.rootTiles&&(this._allTiles.forEach(function(t){t.renderData&&e.overlayManager&&e.overlayManager.setTileParameters(t,t.renderData,e._overlayOpacity)}),this._renderer.setNeedsRender())},s.prototype.updateOverlayOpacity=function(){if(this.overlayManager){var e=this._eyePosSurfaceSR[2],t=this.overlayManager.updateOpacity(e);isNaN(t)||t===this._overlayOpacity||(this._allTiles.forEach(function(e){return e.renderData&&(e.renderData.overlayOpacity=t)}),this._overlayOpacity=t,this._renderer.setNeedsRender())}},s.prototype.getStats=function(){var e={numNodes:this._allTiles.length,numLeaves:0,numVisible:0,numRendered:0,numRenderedPerLevel:new Array,numLoadedPerLevel:new Array};return this._allTiles.forEach(function(t){t.isLeaf&&e.numLeaves++;var i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e},s.prototype.getUsedMemory=function(){var e=this;return this.tilingScheme?(this._usedMemory===oe&&(this._usedMemory=0,this._allTiles.forEach(function(t){return e._usedMemory+=t.usedMemory})),this._usedMemory):0},s.prototype.getUsedMemoryForLayerView=function(e){var t=0,i=this.layerClassFromLayerView(e),r=this._layerIndexByLayerViewId[i].get(e.uid);return this._allTiles.forEach(function(e){return t+=e.getUsedMemoryForLayer(i,r)}),t},s.prototype.getMemoryUsage=function(){if(!this.tilingScheme)return{};var e=0,t=0,i=0,r=this.tilingScheme.pixelSize,n=r*r*4;return this._allTiles.forEach(function(r){for(var a=$(r),s=0,l=r.layerInfo[1];s<l.length;s++){var o=l[s],d=o.data,h=0,u=0;d instanceof K?h+=J.getGpuMemoryUsage(d):d instanceof HTMLImageElement?u+=n:d instanceof R.VectorTile&&(i+=d.getMemoryUsage()),r.renderData||a?(e+=u,e+=h):(t+=u,t+=h)}for(var p=0,c=r.layerInfo[0];p<c.length;p++){var o=c[p],d=o.data;e+=d?n:0}if(r.renderData){var _=r.renderData.textureDescriptor;e+=_?J.getGpuMemoryUsage(_):0;var y=r.renderData.estimatedGeometryMemoryUsage;i+=y,i+=y}}),{visibleImageData:e,invisibleImageData:t,geometryData:i}},s.prototype.getTile=function(e){var t=e.split("/").map(function(e){return+e});if(0===t[0])return l.find(this.rootTiles,function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]});var i,r=Math.pow(2,t[0]),n=Math.floor(t[1]/r),a=Math.floor(t[2]/r);if(this.rootTiles.some(function(e){return e.lij[1]===n&&e.lij[2]===a&&(i=e,!0)}),i){for(var s=1<<t[0]-1;i.lij[0]<t[0];){var o=t[1]&s?2:0;if((t[2]&s)>0&&o++,!i.children[o])return console.log("Tile "+e+" doesn't exist, smallest ancestor is "+X.tile2str(i)),null;i=i.children[o],s>>=1}return W.weakAssert(i.lij[0]===t[0]&&i.lij[1]===t[1]&&i.lij[2]===t[2],"not the right tile?"),i}return null},s.prototype.setBorders=function(e){this._renderer.renderPatchBorders=e},s.prototype.setDisableRendering=function(e){this._renderer.renderingDisabled=e},s.prototype.getRenderedTiles=function(){return pe.clear(),this._allTiles.forEach(function(e){e.visible&&e.rendered&&pe.push(e)}),X.sortTiles(this.renderOrder,pe),pe.toArray()},Object.defineProperty(s.prototype,"test",{get:function(){var e=this;return{renderer:this._renderer,lercWorker:this._lercWorker,mergeTile:function(t){return e._mergeTile(t)},updateTiles:function(t){return e._updateTiles(t)},getTiles:function(){return e._allTiles.toArray()}}},enumerable:!0,configurable:!0}),n([m.property()],s.prototype,"_renderer",void 0),n([m.property({constructOnly:!0})],s.prototype,"view",void 0),n([m.property({value:!1})],s.prototype,"cullBackFaces",null),n([m.property({readOnly:!0})],s.prototype,"extent",null),n([m.property({readOnly:!0,dependsOn:["ready","_renderer.updating","_scheduledLayerViewChangesHandle"]})],s.prototype,"updating",null),n([m.property({value:1})],s.prototype,"baseOpacity",null),n([m.property({readOnly:!0})],s.prototype,"overlayManager",void 0),n([m.property({constructOnly:!0})],s.prototype,"manifold",void 0),n([m.property()],s.prototype,"maxTextureScale",void 0),n([m.property({readOnly:!0})],s.prototype,"ready",null),n([m.property({value:1})],s.prototype,"renderOrder",null),n([m.property({readOnly:!0})],s.prototype,"rootTiles",void 0),n([m.property({value:!0})],s.prototype,"skirtScale",null),n([m.property({readOnly:!0,dependsOn:["tilingScheme.spatialReference"]})],s.prototype,"spatialReference",null),n([m.property()],s.prototype,"backgroundImage",void 0),n([m.property({type:a})],s.prototype,"backgroundColor",void 0),n([m.property({dependsOn:["backgroundColor","backgroundImage"]})],s.prototype,"_background",null),n([m.property({value:!1})],s.prototype,"slicePlaneEnabled",null),n([m.property({readOnly:!0})],s.prototype,"tilingScheme",void 0),n([m.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],s.prototype,"tilingSchemeLocked",void 0),n([m.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],s.prototype,"tilingSchemeDone",void 0),n([m.property({readOnly:!0})],s.prototype,"tilingSchemeLogic",void 0),n([m.property({value:!0})],s.prototype,"velvetOverground",null),n([m.property({value:!1})],s.prototype,"wireframe",null),n([m.property({value:!1})],s.prototype,"suspended",null),n([m.property({readOnly:!0,dependsOn:["view.qualitySettings.tiledSurface.reduceTileLevelDifferences"]})],s.prototype,"lodSnapping",null),n([m.property()],s.prototype,"_scheduledLayerViewChangesHandle",void 0),s=n([m.subclass("esri.views.3d.terrain.TerrainSurface")],s)}(m.declared(d.EventedMixin(s))),ae=1.2,se=80/180*Math.PI,le=110/180*Math.PI,oe=-1,de=S.vec4f64.create(),he=E.create(),ue=[0,0,0],pe=new y,ce={spatialReference:null,tile:null,extent:null,context:"ground"},_e={spatialReference:null,extent:null,scale:0};return ne});