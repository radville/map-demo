// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/mathUtils","../../../core/libs/gl-matrix-2/vec2","../../../core/libs/gl-matrix-2/vec2f64","../../../core/libs/gl-matrix-2/vec4","../../2d/engine/vectorTiles/tileRendererHelper3D","../../2d/engine/vectorTiles/VectorTile","./BlendLayersTechnique","./BlendLayersTechnique","./terrainUtils","./support/FBOPool","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../../webgl/Texture","../../webgl/Util"],function(e,t,r,a,i,n,o,s,l,u,c,d,h,f,p,y){function _(e){var t=e&&e.sourceLayerInfo&&e.sourceLayerInfo.data;return t instanceof HTMLImageElement||t instanceof HTMLCanvasElement}function x(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof s.VectorTile}function T(e){return e&&e.sourceLayerInfo&&e.sourceLayerInfo.data instanceof p}function b(e){var t=r.nextHighestPowerOfTwo(e),a=t*t,i=e*e;if(a===i)return e;var n=t/2;return a-i<i-n*n?t:n}function g(e,t,r){r.layerIndex=t;var i=e.layerInfo[1][t];if(i.data)return a.vec2.set(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=i,r;var n=i.upsampleInfo;if(n){var o=n.tile.layerInfo[1][t];return r.tile=n.tile,a.vec2.copy(r.offset,n.offset),r.scale=n.scale,r.sourceLod=n.tile.lij,r.sourceLayerInfo=o,r}return null}var m=function(){function e(e,t,r,a){this._context=e,this.tileSize=t,this._setNeedsRender=a,this._backgroundTexture=null,this._blackTex=null,this._context.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,this._context.parameters.maxMaxAnisotropy)),this._vaoQuad=f.createQuadVAO(this._context,h.Pos3Tex),this._blendLayersTechniqueConfig=new u.BlendLayersTechniqueConfiguration,this._blendLayersTechniqueConfig.mode=2,this._blendLayersTechnique=r.acquireAndReleaseExisting(l.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechniqueConfig.mode=1,this._applyOpacityTechnique=r.acquireAndReleaseExisting(l.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._applyOpacityTechnique),this._blackTex=f.createColorTexture(this._context,[0,0,0,1]),this._fboPool=new d.FBOPool(this._context)}return e.prototype.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),this._backgroundTexture&&(this._backgroundTexture.dispose(),this._backgroundTexture=null),this._blackTex&&(this._blackTex.dispose(),this._blackTex=null),this._blendLayersTechnique&&(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null),this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null)},e.prototype.updateTileTexture=function(e){for(var t=e.layerInfo[1],r=0,a=t;r<a.length;r++){a[r].pendingUpdates&=-33}if(e.renderData){var i,n,o=e.surface,s=o.baseOpacity,l=0,u=this.tileSize,d=!1,h=t.length;for(i=0;i<t.length&&!d;i++){var f=o.layerViewByIndex(i,1),p=f.fullOpacity;n=f.view.pixelRatio,L[i]=p,this._isBaseLayer(f.layer)&&h>=t.length&&(h=i),0!==p&&g(e,i,v)&&(c.isVectorTileLayerView(f)?u=Math.max(u,this.tileSize*f.view.pixelRatio):f.isOpaque&&1===s&&1===p&&(d=!0),l++)}this._cleanupFBOPool(n,t.length),u=b(u);var y=u/this.tileSize,_=i-1;0===l&&this._backgroundTexture?this._useBackgroundTexture(e):1===l&&d?this._useLayerTexture(e,_):this._composeMapLayers(e,_,h,d,L,u,y),this._setNeedsRender()}},e.prototype.setBackground=function(e){e instanceof HTMLImageElement?this._backgroundTexture=this._buildTexture(e):this._backgroundTexture=f.createColorTexture(this._context,e)},e.prototype._buildTexture=function(e){var t,r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},a=this._context;if("number"==typeof e)r.width=r.height=e,t=new p(a,r);else try{t=new p(a,r,e)}catch(e){t=f.createEmptyTexture(a),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}return a.bindTexture(t),t.generateMipmap(),t},e.prototype._drawRasterData=function(e,t,r,a,i){void 0===i&&(i=1);var n=this._context,o=e.program,s=this._vaoQuad;n.setPipelineState(e.pipeline),n.bindProgram(o),n.bindVAO(s),o.assertCompatibleVertexAttributeLocations(s),n.bindTexture(t,0),o.setUniform1i("tex",0),o.setUniform1f("scale",r),o.setUniform2f("offset",a[0],a[1]),o.setUniform1f("opacity",i),n.drawArrays(5,0,y.vertexCount(s,"geometry"))},e.prototype._drawVectorData=function(e,t,r,a,i,n,s){var l,u=this._context,c=t.tile.surface.layerViewByIndex(t.layerIndex,1),d=t.sourceLayerInfo,h=d.data;u.setPipelineState(e.pipeline);var f=a<1;return f?(l=this._fboPool.acquire(i),u.bindFramebuffer(l),u.setClearColor(1,1,1,0),u.clearSafe(16640)):s&&u.clearSafe(256),o.renderVectorTile(u,t.sourceLod,h,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!f||(u.bindFramebuffer(n),this._drawRasterData(e,l.colorTexture,1,[0,0],a),this._fboPool.release(l),!1)},e.prototype._useBackgroundTexture=function(e){e.renderData.releaseTexture(),e.renderData.opacity=e.surface.baseOpacity,e.renderData.textureReference=this._backgroundTexture,n.vec4.set(e.renderData.texOffsetAndScale,0,0,1,1)},e.prototype._useLayerTexture=function(e,t){e.renderData.releaseTexture();var r=g(e,t,v);if(this._dataToTexture(r)){e.renderData.textureReference=r.sourceLayerInfo.data;var a=r.offset;n.vec4.set(e.renderData.texOffsetAndScale,a[0],a[1],r.scale,r.scale)}e.renderData.opacity=e.surface.baseOpacity},e.prototype._composeMapLayers=function(e,t,r,a,o,s,l){var u=this,c=e.renderData.ensureTexture(s,function(){return u._buildTexture(s)}),d=this._context,h=this._fboPool.acquire(s);d.bindFramebuffer(h),d.setViewport(0,0,s,s),d.setClearColor(0,0,0,0),d.setClearDepth(1),d.clearSafe(16640);var f=!1;!a&&this._backgroundTexture&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture,1,i.vec2f64.ZEROS);for(var p=e.surface.baseOpacity,y=!1,_=t;_>=0;_--){var T=g(e,_,v);T&&(_<r&&p<1&&!y&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex,1,i.vec2f64.ZEROS,p),y=!0),0!==o[_]&&(x(T)?this._drawVectorData(this._blendLayersTechnique,T,l,o[_],s,h,f)&&(f=!0):this._dataToTexture(T)&&this._drawRasterData(this._blendLayersTechnique,T.sourceLayerInfo.data,T.scale,T.offset,o[_])))}d.bindTexture(c);var b=c.descriptor;d.gl.copyTexImage2D(d.gl.TEXTURE_2D,0,b.pixelFormat,0,0,b.width,b.height,0),c.generateMipmap(),d.bindFramebuffer(null),this._fboPool.release(h),e.renderData.opacity=y?1:p,e.renderData.textureReference=c,n.vec4.set(e.renderData.texOffsetAndScale,0,0,1,1)},e.prototype._dataToTexture=function(e){return!x(e)&&(_(e)&&(this._rasterDataToTexture(e),e.tile.setMemoryDirty()),T(e))},e.prototype._rasterDataToTexture=function(e){var t=e.sourceLayerInfo;t.data=this._buildTexture(t.data)},e.prototype._isBaseLayer=function(e){return e.parent&&"esri.Basemap"===e.parent.declaredClass&&e.parent.baseLayers.indexOf(e)>-1},e.prototype._cleanupFBOPool=function(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)},e}(),L=new Array,v={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return m});