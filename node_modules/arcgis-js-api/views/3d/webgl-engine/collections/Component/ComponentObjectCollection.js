// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/extendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/typedArrayUtil","../../../../../core/libs/gl-matrix-2/mat3","../../../../../core/libs/gl-matrix-2/mat3f32","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4f32","../../../../../geometry/support/aaBoundingBox","../../../layers/support/symbolColorUtils","../../../support/orientedBoundingBox","../../../support/buffer/BufferView","../../../support/buffer/glUtil","../../../support/buffer/InterleavedLayout","./interface","./RenderSubmitSystem","./SourceGeometry","./IndexRange/ComponentRangeRunLengthEncoded","./Material/ComponentMaterial","./Material/ComponentTechnique","../../core/util/BucketedObjectStore","../../core/util/TwoVectorPosition","../../lib/AutoDisposable","../../lib/geometryDataUtils","../../lib/Util","../../lib/TextureBackedBuffer/BufferManager","../../materials/internal/MaterialUtil","../../../../webgl/BufferObject","../../../../webgl/VertexArrayObject"],function(e,t,o,n,r,i,s,a,c,p,u,l,m,h,f,g,d,y,b,v,C,B,_,x,A,w,D,S,M,P,j,R,O,I){function U(e,t,o){var n=[],r=o.length;return t.forEachComponent(function(t){return e[t]>0&&(r!==t-1&&(n.length&&n.push(o[r+1]-n[n.length-1]),n.push(o[t])),r=t),!0}),n.length&&n.push(o[r+1]-n[n.length-1]),n}function G(e,t){return e===t?0:0===e?2:1}Object.defineProperty(t,"__esModule",{value:!0});var V=i.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection"),H=function(){function e(e){this._renderManager=e,this._objects=new w.BucketedObjectStore,this._renderSubmit=new C.RenderSubmitSystem(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new j.BufferManager(e.rctx)}return e.prototype.dispose=function(){P.assert(0===this.count,"ObjectCollection should be empty upon disposal")},e.prototype.createObject=function(e){var t=new N;return t.transform=e.transform,t.obb=g.clone(e.obb),t.components=new E(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new T(e.geometry.positionData,t.components),this._objects.add(e.visible?W:0,t),t},e.prototype.destroyObject=function(e){var t=e;this._objects.remove(t),t.dispose(),this._notifyDirty()},e.prototype.setObjectVisibility=function(e,t){var o=e;if(t!==o.visible){var n=t?o.bucketKey|W:o.bucketKey&~W;this._objects.updateKey(o,n),this._notifyDirty()}},Object.defineProperty(e.prototype,"count",{get:function(){return this._objects.count},enumerable:!0,configurable:!0}),e.prototype.preRenderUpdate=function(e){var t=e.camera.eye;this._objects.forEach(function(e,o){o&W&&e.forEach(function(e){var o=u.vec3.squaredDistance(t,e.transform.position);e.renderable.meta.cameraDepthSquared=o})})},e.prototype.updateMaterial=function(e,t){var o=e,n=o.renderable.material;t(n),n.dirty&&this._notifyDirty()},e.prototype.setAllComponentVisibilities=function(e,t){var o=e;o.components.visibility.reset(t),o.components.visibilityDirty(),this._notifyDirty()},e.prototype.forEachVisibleComponent=function(e,t){return e.components.visibility.forEachComponent(t)},e.prototype.getComponentCount=function(e){var t=e,o=t.components.visibility.componentCount();return{visible:o,invisible:t.components.count-o}},e.prototype.setComponentData=function(e,t){var o=e,n=o.renderable,r=n.material;if(v.isVaryingComponentParameters(t)){for(var i=o.components,s=i.materialDataBuffer,a=i.materialDataIndices,c={castShadows:!0,externalColor:m.vec4f32.create(),externalColorMixMode:1},p=s.textureBuffer,u=new Uint8Array(4),l=new Uint32Array(u.buffer),h=0,g=0,d=0,y=0,b=!1,C=0,B=0;B<i.count;B++)t(B,c),h+=+(c.externalColor[3]<1),g+=+(3===c.externalColorMixMode&&1===c.externalColor[3]),d+=+(c.externalColor[3]>0),y+=+c.castShadows,f.encodeSymbolColor(c.externalColor,c.externalColorMixMode,u),u[2]=254&u[2]|+c.castShadows,p.setData(a[B],0,u[0],u[1],u[2],u[3]),b=b||B>0&&C!==l[0],C=l[0];b?(r.componentParameters=new x.ComponentParametersVarying,r.componentParameters.castShadows=G(y,i.count),r.componentParameters.transparent=G(h,i.count),r.componentParameters.opaqueOverride=G(g,i.count),r.componentParameters.visible=G(d,i.count),r.componentParameters.texture=p,p.updateTexture()):(r.componentParameters=new x.ComponentParametersUniform,r.componentParameters.castShadows=c.castShadows?0:2,r.componentParameters.externalColor=c.externalColor,r.componentParameters.externalColorMixMode=c.externalColorMixMode)}else r.componentParameters=new x.ComponentParametersUniform,r.componentParameters.castShadows=t.castShadows?0:2,r.componentParameters.externalColor=t.externalColor,r.componentParameters.externalColorMixMode=t.externalColorMixMode;this._notifyDirty()},e.prototype.getComponentAABB=function(e,t,o){return e.intersectionGeometry.getComponentAABB(t,o)},e.prototype.getObjectTransform=function(e){return e.transform},e.prototype.getComponentPositions=function(e,t,o){return e.intersectionGeometry.getComponentPositions(t,o)},e.prototype.intersect=function(e,t,o,n,r,i){var a=e;s.isSome(r)&&(r.localOrigin=a.transform.position);var p=c.mat3.invert(F,a.transform.rotationScale);u.vec3.sub(K,t,a.transform.position),u.vec3.sub(J,o,a.transform.position),u.vec3.transformMat3(K,K,p),u.vec3.transformMat3(J,J,p);var l=c.mat3.transpose(F,p);return a.intersectionGeometry.intersect(K,J,n,l,r,i)},e.prototype.addEdges=function(e,t,o,n){var r=e,i=r.intersectionGeometry.indices,s=r.intersectionGeometry.positions,a=r.components.offsets;return t.addComponentObject(e,r.transform,r.obb.center,s,i,a,o,n)},e.prototype.addComponentHighlight=function(e,t){var o=e.components;s.isNone(o.highlightCounts)&&(o.highlightCounts=new Uint32Array(o.count+1)),0==o.highlightCounts[t]++&&(o.highlightsDirty(),this._notifyDirty()),o.highlightCounts[o.count]++},e.prototype.removeComponentHighlight=function(e,t){var o=e.components;if(s.isNone(o.highlightCounts))return void V.warn("Removing non-existing highlight.");var n=o.highlightCounts[t],r=o.highlightCounts[o.count];return 0===n?void V.warn("Removing non-existing highlight."):n>1?(o.highlightCounts[t]=n-1,void(o.highlightCounts[o.count]=r-1)):(o.highlightCounts[t]=0,o.highlightsDirty(),this._notifyDirty(),void(1===r?o.highlightCounts=null:o.highlightCounts[o.count]=r-1))},e.prototype.clearHighlights=function(e){var t=e.components;s.isSome(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())},e.prototype.getObjectMemoryUsageGPU=function(e){return e.renderable.meta.gpuMemoryEstimate},Object.defineProperty(e.prototype,"visibleObjects",{get:function(){return this._objects.getBucket(W)},enumerable:!0,configurable:!0}),e.prototype._createRenderable=function(e,t){for(var o=this._renderManager.rctx,n=e.geometry,r=n.vertices.layoutParameters,i=O.createVertex(o,35044,n.vertices.data),a=s.applySome(n.indices,function(e){return O.createIndex(o,35044,e)}),l=y.glLayout(B.createVertexBufferLayout(r)),m=new Uint16Array(n.vertices.count),h=0;h<t.count;h++){var f=t.offsets[h],g=t.offsets[h+1],d=t.materialDataIndices[h];if(s.isSome(n.indices))for(var b=f;b<g;b++){var v=n.indices[b];m[v]=d}else for(var b=f;b<g;b++)m[b]=d}var C=O.createVertex(o,35044,m.buffer),_=new D.TwoVectorPosition(e.transform.position),w=p.mat3f32.clone(e.transform.rotationScale);c.mat3.invert(w,w),c.mat3.transpose(w,w);var S=new A.ComponentDrawParameters;u.vec3.copy(S.worldFromModel_TL,_.low),u.vec3.copy(S.worldFromModel_TH,_.high),c.mat3.copy(S.worldFromModel_RS,e.transform.rotationScale),c.mat3.copy(S.transformNormal_GlobalFromModel,w);var M=new x.ComponentMaterial,P=new I(o,M.attributeLocations,{data:l,componentIndices:q},{data:i,componentIndices:C},s.unwrap(a)),j=new k;return j.material=M,j.drawParameters=S,j.geometry=new L(P,n.primitiveType,r,s.isSome(a)),j.meta.cameraDepthSquared=.5,j.meta.gpuMemoryEstimate=i.byteSize+C.byteSize+(s.isSome(a)?a.byteSize:0),j},e.prototype._notifyDirty=function(){this._renderManager.notifyDirty()},e}();t.ComponentObjectCollection=H;var E=function(e){function t(t,o){var n=e.call(this)||this;n.highlightCounts=null,n.cachedGeometryRanges=null,n.cachedHighlightRanges=null,n.offsets=a.slice(o);var r=n.count;n.visibility=new _.ComponentRangeRunLengthEncoded(r),n.materialDataBuffer=t.getBuffer(r),n.materialDataIndices=new Uint16Array(r);for(var i=0;i<r;i++)n.materialDataIndices[i]=n.materialDataBuffer.acquireIndex();return n}return n(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this);for(var t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t])},Object.defineProperty(t.prototype,"count",{get:function(){return this.offsets.length-1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"geometryRanges",{get:function(){return s.isNone(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"highlightRanges",{get:function(){return s.isNone(this.highlightCounts)?null:(s.isNone(this.cachedHighlightRanges)&&(this.cachedHighlightRanges=U(this.highlightCounts,this.visibility,this.offsets)),this.cachedHighlightRanges)},enumerable:!0,configurable:!0}),t.prototype.highlightsDirty=function(){this.cachedHighlightRanges=null},t.prototype.visibilityDirty=function(){this.cachedGeometryRanges=null,this.cachedHighlightRanges=null},t}(S.AutoDisposable),T=function(){function e(e,t){this._indices=s.isSome(e.indices)?e.indices:M.generateDefaultIndexArray(e.positions.length/3),this._positions=new d.BufferViewVec3f(e.positions),this._components=t}return e.prototype.getComponentAABB=function(e,t){if(s.isSome(this._perComponentAABBs)){for(var o=0;o<6;o++)t[o]=this._perComponentAABBs[6*e+o];return t}return this._computePerComponentAABBs(),this.getComponentAABB(e,t)},e.prototype.getComponentPositions=function(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]},e.prototype.intersect=function(e,t,o,n,r,i){var a=this,c={data:this._positions.typedBuffer,strideIdx:this._positions.typedBufferStride,offsetIdx:0,size:3},p=this._indices,l=this._components.offsets,m=R.computeInvDir(e,t,z);this._components.visibility.forEachComponent(function(h){var f=a.getComponentAABB(h,Q);if(s.isSome(r)&&r.applyToAABB(f),!R.intersectAabbInvDir(f,e,m,o))return!0;var g=l[h]/3,d=l[h+1]/3;return R.intersectTriangles(e,t,g,d,p,c,void 0,r,function(e,t,o){return i(h,e,u.vec3.transformMat3(t,t,n),o)}),!0})},e.prototype._computePerComponentAABBs=function(){var e=this._components.count;this._perComponentAABBs=new Float32Array(6*e);for(var t=0;t<e;t++)this._computeAABB(t)},e.prototype._computeAABB=function(e){for(var t=this._indices,o=this._positions,n=this._components.offsets,r=n[e],i=n[e+1],s=[0,0,0],a=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0],p=r;p<i;p++){var l=t[p];o.getVec(l,s),u.vec3.min(a,a,s),u.vec3.max(c,c,s)}var m=6*e;this._perComponentAABBs[m++]=a[0],this._perComponentAABBs[m++]=a[1],this._perComponentAABBs[m++]=a[2],this._perComponentAABBs[m++]=c[0],this._perComponentAABBs[m++]=c[1],this._perComponentAABBs[m]=c[2]},Object.defineProperty(e.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"indices",{get:function(){return this._indices},enumerable:!0,configurable:!0}),e}(),L=function(e){function t(t,o,n,r){var i=e.call(this)||this;return i.vao=t,i.primitiveType=o,i.parameters=n,i.indexed=r,i}return n(t,e),r([S.autoDispose()],t.prototype,"vao",void 0),t}(S.AutoDisposable);t.RenderGeometry=L;var k=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.meta={cameraDepthSquared:0,gpuMemoryEstimate:0},t}return n(t,e),r([S.autoDispose()],t.prototype,"geometry",void 0),t}(S.AutoDisposable);t.Renderable=k;var q=y.glLayout(b.newLayout().u16("componentIndex")),N=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),Object.defineProperty(t.prototype,"visible",{get:function(){return!!(this.bucketKey&W)},enumerable:!0,configurable:!0}),r([S.autoDispose()],t.prototype,"renderable",void 0),r([S.autoDispose()],t.prototype,"components",void 0),t}(w.BucketStorable);t.ComponentObject=N;var F=p.mat3f32.create(),z=l.vec3f64.create(),K=l.vec3f64.create(),J=l.vec3f64.create(),Q=h.create(),W=1});