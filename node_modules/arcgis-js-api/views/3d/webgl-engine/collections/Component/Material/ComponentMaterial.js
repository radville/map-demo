// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/tsSupport/decorateHelper","../../../../../../core/maybe","../../../../../../core/libs/gl-matrix-2/vec3","../../../../../../core/libs/gl-matrix-2/vec3f32","../../../../../../core/libs/gl-matrix-2/vec4","../../../../../../core/libs/gl-matrix-2/vec4f32","./ComponentTechnique","./shader/ComponentShader.glsl","../../../core/material/MaterialBase"],function(e,t,r,o,a,i,n,s,p,c,l,u){function m(e){switch(e){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 6}}Object.defineProperty(t,"__esModule",{value:!0});var h=function(e){function t(){var t=e.call(this)||this;return t.baseColor=p.vec4f32.fromValues(1,1,1,1),t.usePBR=!1,t.roughnessFactor=1,t.metallicFactor=1,t.reflectanceFactor=.5,t.emissiveFactor=n.vec3f32.fromValues(0,0,0),t.baseColorTexture=null,t.metallicRoughnessTexture=null,t.emissionTexture=null,t.occlusionTexture=null,t.normalTexture=null,t.objectOpacity=1,t.commonMaterialParameters=new d,t.componentParameters=new b,t.transparencyHint=null,t.isIntegratedMesh=!1,t.polygonOffsetEnabled=!1,t._techniqueConfig=new c.ComponentTechniqueConfiguration,t}return r(t,e),t.prototype.dispose=function(e){this._technique&&(e.release(this._technique),this._technique=void 0),this.baseColorTexture=null},Object.defineProperty(t.prototype,"hasTransparency",{get:function(){return 0!==this._computeWhichMaterialPass()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasVisibleComponents",{get:function(){return 0!==this.objectOpacity&&2!==this.componentParameters.visible},enumerable:!0,configurable:!0}),t.prototype.getTechnique=function(e,t,r){var o=this._techniqueConfig;if(o.vertexColors=r.colors,o.normalMode=this.isIntegratedMesh?2:r.normals?1:3,o.vertexTextureCoordinates=r.textureCoordinates,o.usePBR=this.usePBR,o.hasMetalnessAndRoughnessTexture=a.isSome(this.metallicRoughnessTexture),o.hasEmissionTexture=a.isSome(this.emissionTexture),o.hasOcclusionTexture=a.isSome(this.occlusionTexture),o.hasNormalTexture=a.isSome(this.normalTexture),this.dirty){o.componentData=this.componentParameters.type,o.cullFace=this.commonMaterialParameters.cullFace,o.doubleSidedMode=this.commonMaterialParameters.doubleSided?1:0,o.baseColorTexture=a.isSome(this.baseColorTexture);var i=this._computeWhichMaterialPass();o.blendingEnabled=1===i||2===i,o.stencilWriteEnabled=this.isIntegratedMesh,o.polygonOffsetEnabled=this.polygonOffsetEnabled,this._setClean()}return o.slicePlaneEnabled=t.slicePlaneEnabled&&this.commonMaterialParameters.slicePlaneEnabled,1===t.identifier?(o.output=3,o.vertexDiscardMode=0):2===t.identifier?(o.output=4,o.vertexDiscardMode=0):(2===this._computeWhichMaterialPass()?o.vertexDiscardMode=t.transparent?2:1:o.vertexDiscardMode=0,o.output=m(t.subPass),0===t.subPass?(o.receiveAmbientOcclusion=t.ambientOcclusionEnabled&&this.commonMaterialParameters.receiveAmbientOcclusion,o.receiveShadows=t.shadowsEnabled&&this.commonMaterialParameters.receiveShadows):(o.receiveAmbientOcclusion=!1,o.receiveShadows=!1)),this._technique=e.repository.acquireAndReleaseExisting(c.ComponentTechnique,o,this._technique),this._technique},t.prototype.submit=function(e,t){var r=t.renderable.geometry,o=t.components,i=t.renderable.drawParameters,n=t.renderable.meta.cameraDepthSquared,s=o.geometryRanges,p=o.highlightRanges;switch(this._computeWhichMaterialPass()){case 0:e.materialOpaque.submitDraw(this,r,s,i,n);break;case 1:e.materialTransparent.submitDraw(this,r,s,i,n);break;case 2:e.materialOpaque.submitDraw(this,r,s,i,n),e.materialTransparent.submitDraw(this,r,s,i,n);break;case 3:e.materialIntegratedMesh.submitDraw(this,r,s,i,n)}a.isSome(e.shadowMap)&&2!==this.componentParameters.castShadows&&e.shadowMap.submitDraw(this,r,s,i,n),a.isSome(e.highlight)&&a.isSome(p)&&e.highlight.submitDraw(this,r,p,i,n)},Object.defineProperty(t.prototype,"attributeLocations",{get:function(){return l.attributeLocations},enumerable:!0,configurable:!0}),t.prototype._computeWhichMaterialPass=function(){return this.isIntegratedMesh?3:0===this.componentParameters.transparent?1:1===this.componentParameters.transparent?2:1===this.objectOpacity&&0===this.componentParameters.opaqueOverride?0:a.isSome(this.transparencyHint)?this.transparencyHint?1:0:this.baseColor[3]<1||this.objectOpacity<1||a.isSome(this.baseColorTexture)?1:2===this.componentParameters.transparent?0:2},o([u.parameter({vectorOps:s.vec4})],t.prototype,"baseColor",void 0),o([u.parameter()],t.prototype,"usePBR",void 0),o([u.parameter()],t.prototype,"roughnessFactor",void 0),o([u.parameter()],t.prototype,"metallicFactor",void 0),o([u.parameter()],t.prototype,"reflectanceFactor",void 0),o([u.parameter({vectorOps:i.vec3})],t.prototype,"emissiveFactor",void 0),o([u.parameter({dispose:!0})],t.prototype,"baseColorTexture",void 0),o([u.parameter({dispose:!0})],t.prototype,"metallicRoughnessTexture",void 0),o([u.parameter({dispose:!0})],t.prototype,"emissionTexture",void 0),o([u.parameter({dispose:!0})],t.prototype,"occlusionTexture",void 0),o([u.parameter({dispose:!0})],t.prototype,"normalTexture",void 0),o([u.parameter()],t.prototype,"objectOpacity",void 0),o([u.parameterBlock()],t.prototype,"commonMaterialParameters",void 0),o([u.parameterBlock()],t.prototype,"componentParameters",void 0),o([u.parameter()],t.prototype,"transparencyHint",void 0),o([u.parameter()],t.prototype,"isIntegratedMesh",void 0),o([u.parameter()],t.prototype,"polygonOffsetEnabled",void 0),t}(u.MaterialBase);t.ComponentMaterial=h;var d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.doubleSided=!1,t.cullFace=2,t.receiveAmbientOcclusion=!0,t.receiveShadows=!0,t.slicePlaneEnabled=!0,t}return r(t,e),o([u.parameter()],t.prototype,"doubleSided",void 0),o([u.parameter()],t.prototype,"cullFace",void 0),o([u.parameter()],t.prototype,"receiveAmbientOcclusion",void 0),o([u.parameter()],t.prototype,"receiveShadows",void 0),o([u.parameter()],t.prototype,"slicePlaneEnabled",void 0),t}(u.MaterialParameterBlock);t.CommonMaterialParameters=d;var b=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.externalColor=p.vec4f32.fromValues(1,1,1,1),t.externalColorMixMode=1,t.castShadows=0,t}return r(t,e),Object.defineProperty(t.prototype,"transparent",{get:function(){return this.externalColor[3]<1?0:2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"opaqueOverride",{get:function(){return 3===this.externalColorMixMode&&1===this.externalColor[3]?0:2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this.externalColor[3]>0?0:2},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return 0},enumerable:!0,configurable:!0}),o([u.parameter({vectorOps:s.vec4})],t.prototype,"externalColor",void 0),o([u.parameter()],t.prototype,"externalColorMixMode",void 0),o([u.parameter()],t.prototype,"castShadows",void 0),t}(u.MaterialParameterBlock);t.ComponentParametersUniform=b;var v=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.texture=null,t.transparent=2,t.opaqueOverride=2,t.castShadows=2,t.visible=2,t}return r(t,e),Object.defineProperty(t.prototype,"type",{get:function(){return 1},enumerable:!0,configurable:!0}),o([u.parameter()],t.prototype,"texture",void 0),o([u.parameter()],t.prototype,"transparent",void 0),o([u.parameter()],t.prototype,"opaqueOverride",void 0),o([u.parameter()],t.prototype,"castShadows",void 0),o([u.parameter()],t.prototype,"visible",void 0),t}(u.MaterialParameterBlock);t.ComponentParametersVarying=v});