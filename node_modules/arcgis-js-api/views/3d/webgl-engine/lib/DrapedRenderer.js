// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/vec4f64","../../support/debugFlags","../../webgl-engine/lib/intersectorUtils","./Camera","./DefaultVertexBufferLayouts","./DrapedUpdates","./glUtil3D","./GridLocalOriginFactory","./Renderer","./TextureTechnique","../lighting/Lightsources","../materials/ColorMaterial","../materials/HUDMaterial","../materials/RibbonLineMaterial","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],function(e,t,r,i,n,a,s,o,u,d,h,l,p,c,g,f,m,_,y,T){var x=function(){function e(e,t,n,a,s,o,d){var g=this;this._renderTargets={},this._clearColor=i.vec4f64.fromValues(0,0,0,0),this._uniqueIdx=0,this._localOrigins=new h,this.longitudeCyclical=null,this._rctx=e,this._canvas=t,this._testTextureTechniqueConfig=new p.TextureTechniqueConfiguration,this._testTextureTechniqueConfig.hasAlpha=!0,this._testTextureTechnique=o.acquireAndReleaseExisting(p.TextureTechnique,this._testTextureTechniqueConfig,this._testTextureTechnique),this._modelDirtySet=d,this._modelDirtySet.onMaterialChanged=function(){return g._emitContentChanged()},this._renderer=new l(n,a,s,o,this._rctx,"draped",function(){return g._emitContentChanged()}),this._updates=new u.DrapedUpdates(this._renderer,{emitContentChanged:function(){return g._emitContentChanged()},emitUpdatingChanged:function(){return g._emitUpdatingChanged()}}),this._renderer.onHasHighlightsChanged=function(e){g.onHasHighlightsChanged&&g.onHasHighlightsChanged(e)},this._renderer.setLighting({lights:[new c.AmbientLight(r.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0})}return e.prototype.dispose=function(){for(var e in this._renderTargets)this._renderTargets[e].dispose();this._renderTargets=null,this._renderer.dispose(),this._renderer=null,this._updates.dispose(),this._updates=null},e.prototype.disposeRenderTarget=function(e){var t=this._renderTargets[e];t&&t.dispose(),delete this._renderTargets[e]},Object.defineProperty(e.prototype,"updating",{get:function(){return this._updates.updating},enumerable:!0,configurable:!0}),e.prototype.commitChanges=function(){this._updates.commitChanges()},e.prototype.getRenderTargetTexture=function(e){var t=this._renderTargets[e];return t?t.colorTexture:null},e.prototype.addRenderGeometries=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];null==i.origin&&(i.origin=this._localOrigins.getOrigin(i.center)),i.idx=this._uniqueIdx++}this._updates.add(e)},e.prototype.removeRenderGeometries=function(e){this._updates.remove(e)},e.prototype.updateRenderGeometries=function(e,t){this._updates.modify(e,t)},e.prototype.updateRenderOrder=function(e){e.size>0&&(this._renderer.modifyRenderOrder(),this._emitContentChanged())},e.prototype.setBackgroundColor=function(e){this._clearColor=e,this._emitContentChanged()},e.prototype.updateHighlights=function(e){this._updates.modify(e,16)},e.prototype.isEmpty=function(){return this._renderer.isEmpty()&&!n.OVERLAY_DRAW_TEST_TEXTURE},e.prototype.processDirtyMaterials=function(){var e=this._modelDirtySet.getDirtyMaterials();e&&this._renderer.modify(null,0,null,0,null,0,e),this._modelDirtySet.clearDirtyMaterials()},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasWater",{get:function(){return this._renderer.hasWater},enumerable:!0,configurable:!0}),e.prototype.draw=function(e,t){return this.drawPass(0,e,t)},e.prototype.drawNormals=function(e,t){return this.drawPass(2,e,t)},e.prototype.drawHighlights=function(e,t){return this.drawPass(4,e,t)},e.prototype.drawPass=function(e,t,r){var i=this;if(0===r.numViews)return!1;if(this._pixelRatio=r.pixelRatio*Math.abs(r.views[0].extent[2]-r.views[0].extent[0])/Math.abs(r.views[0].viewport[2]-r.views[0].viewport[0]),this.isEmpty()||4===e&&!this.hasHighlights||2===e&&!this.hasWater)return!1;if(this.processDirtyMaterials(),!this._hasNonZeroSizedView(r))return!1;var a=this._renderTargets[t];if(!a)return!1;var s=this._rctx,o=r.width,u=r.height;a.width===o&&a.height===u||a.resize(o,u);var d=w.camera;return w.fbo=a,w.views=r.views,w.numViews=r.numViews,n.OVERLAY_DRAW_TEST_TEXTURE?w.predraw=function(){return i._drawTestTexture(o,u,v[r.index%v.length])}:w.predraw=null,d.near=1,d.far=1e4,d.pixelRatio=r.pixelRatio||1,s.bindFramebuffer(a),s.setClearColor.apply(s,this._clearColor),s.clearSafe(16384),this._renderer.renderGeometryPassDraped(e,w),s.bindFramebuffer(null),s.setViewport(0,0,this._canvas.width,this._canvas.height),a.colorTexture.descriptor.hasMipmap&&a.colorTexture.generateMipmap(),w.views=null,w.numViews=0,w.fbo=null,!0},e.prototype._hasNonZeroSizedView=function(e){for(var t=0;t<e.numViews;t++){var r=e.views[t];if(r.extent[0]!==r.extent[2]&&r.extent[1]!==r.extent[3])return!0}return!1},e.prototype._drawTestTexture=function(e,t,r){var i=this._rctx;if(!this._testPatternTexture){for(var n=new Uint8Array(e*t*4),a=0,s=0;s<t;s++)for(var u=0;u<e;u++){var h=Math.floor(u/10),l=Math.floor(s/10);h<2||l<2||10*h>e-20||10*l>t-20?(n[a++]=255,n[a++]=255,n[a++]=255,n[a++]=255):(n[a++]=255,n[a++]=255,n[a++]=255,n[a++]=1&h&&1&l?1&u^1&s?0:255:1&h^1&l?0:128)}this._testPatternTexture=new y(i,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},n),this._testPatternProgram=this._testTextureTechnique.program,this._testPatternPipelineState=this._testTextureTechnique.pipeline,this._quadVAO=d.createQuadVAO(i,o.Pos3Tex)}var p=this._testPatternProgram;i.bindProgram(p),i.setPipelineState(this._testPatternPipelineState),p.setUniform4f("color",r[0],r[1],r[2],1),p.setUniform1i("tex",0),i.bindTexture(this._testPatternTexture,0),i.bindVAO(this._quadVAO),i.drawArrays(5,0,T.vertexCount(this._quadVAO,"geometry"))},e.prototype.updateLogic=function(e){return this._renderer.updateLogic(e)},e.prototype._emitContentChanged=function(){this.onContentChanged&&this.onContentChanged()},e.prototype._emitUpdatingChanged=function(){this.onUpdatingChanged&&this.onUpdatingChanged()},e.prototype.createRenderTarget=function(e,t,r,i){for(var n=e,a=0;this._renderTargets[n];)n=e+"_"+ ++a;return this._renderTargets[n]=new _(this._rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:i,hasMipmap:t,maxAnisotropy:r,width:0,height:0}),n},e.prototype.getGpuMemoryUsage=function(){var e=0;for(var t in this._renderTargets){var r=this._renderTargets[t];e+=T.getGpuMemoryUsage(r)}return e},e.prototype.intersect=function(e,t,r){var i=this,n=0;this._renderer.forEachRenderGeometry(function(a){if(!r||r(a)){if(a.material instanceof g||a.material instanceof m||a.material instanceof f){i.intersectRenderGeometry(a,t,0,e,n);var s=i.longitudeCyclical;s&&(a.center[0]-a.bsRadius<s.min&&i.intersectRenderGeometry(a,t,s.range,e,n),a.center[0]+a.bsRadius>s.max&&i.intersectRenderGeometry(a,t,-s.range,e,n))}n++}})},e.prototype.intersectRenderGeometry=function(e,t,r,i,n){var a=this;r+=e.transformation[12];var s=e.transformation[13];C[0]=t[0]-r,C[1]=t[1]-s,C[2]=1,b[0]=t[0]-r,b[1]=t[1]-s,b[2]=0,e.pixelRatio=this._pixelRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,C,b,function(t,r,s){a.addIntersectionResult(s,e.material.renderPriority,n,i,e.data.layerUid,e.data.graphicUid)},e.calculateShaderTransformation,!0)},e.prototype.addIntersectionResult=function(e,t,r,i,n,s){var o={type:"external",metadata:{layerUid:n,graphicUid:s}},u=function(n){n.set(o,null,i.results.terrain.dist,i.results.terrain.normal,i.results.terrain.transformation,t,null,null,e,r),n.intersector="DrapedRenderer"};if((null==i.results.min.drapedLayerOrder||t>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.terrain.dist<=i.results.min.dist)&&u(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||t<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.terrain.dist>i.results.max.dist)&&u(i.results.max),2===i.options.store){var d=new a.IntersectorResult(i.ray);u(d),i.results.all.push(d)}},Object.defineProperty(e.prototype,"test",{get:function(){return{renderer:this._renderer}},enumerable:!0,configurable:!0}),e}(),v=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],w={fbo:null,camera:new s.default,views:null,numViews:0},C=r.vec3f64.create(),b=r.vec3f64.create();return x});