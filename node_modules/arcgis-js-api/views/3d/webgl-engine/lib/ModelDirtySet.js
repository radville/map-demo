// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/arrayUtils","../../../../core/iteratorUtils","./Util"],function(e,t,r,o,n){return function(){function e(e){this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this._dirtyMaterials=new Set,this._model=e}return Object.defineProperty(e.prototype,"residentLayerCount",{get:function(){return this._residentGeomRecords.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"residentObjectCount",{get:function(){var e=0;return this._residentGeomRecords.forEach(function(t){e+=t.size}),e},enumerable:!0,configurable:!0}),e.prototype.getDirtyMaterials=function(){return this._dirtyMaterials.size>0?this._dirtyMaterials:null},e.prototype.clearDirtyMaterials=function(){this._dirtyMaterials.clear()},e.prototype.hasDirtyGeometryRecords=function(){return o.someMap(this._dirtyGeomRecords,function(e){return o.someMap(e,function(e){return e&&e.size>0})})},e.prototype.handleUpdate=function(e,t,r){return n.assert(this[t],"ModelDirtySet doesn't know how to process "+t),this[t](e,r)},e.prototype.shaderTransformationChanged=function(e){var t=this,r=this._residentGeomRecords.get(e.id);r&&r.forEach(function(e,r){var o=t._model.get(1,r);o&&o.hasVolativeTransformation()&&e.forEach(function(e){for(var t=0,r=e[1];t<r.length;t++){r[t].shaderTransformationChanged()}})})},e.prototype.commit=function(){return this.commitLayers(r.keysOfMap(this._dirtyGeomRecords))},e.prototype.commitLayers=function(e){for(var t=this,r=[],o=[],i=[],a=this,d=0;d<e.length;d++)!function(d){var s=e[d],c=a._dirtyGeomRecords.get(s);if(!c)return"continue";c.forEach(function(e,a){var d=t._ensureGeomRecord(s,a);e.forEach(function(e,s){var c=e[0],y=e[1],p=e[2],h=!1;if(2&y){var f=d.get(s);if(f){var u=f[1];if(4&p)for(var m=t._model.get(1,a),l=0,g=u;l<g.length;l++){var R=g[l];if(t._model.updateRenderGeometryTransformation(m,c,R)){h=!0;break}}if(!h)for(var v=0,_=u;v<_.length;v++){var R=_[v];i.push({renderGeometry:R,updateType:p})}}else n.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(4&y||h){var f=d.get(s);f?o.push.apply(o,f[1]):4===y&&n.assert(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove"),f&&d.delete(s)}if(1&y||h){var G=[c,[]],m=t._model.get(1,a);t._model.getGeometryRenderGeometries(m,c,G[1]),r.push.apply(r,G[1]),d.set(s,G)}}),0===d.size&&t._residentGeomRecords.get(s).delete(a)}),0===a._residentGeomRecords.get(s).size&&a._residentGeomRecords.delete(s),a._dirtyGeomRecords.delete(s)}(d);return[r,o,i]},e.prototype.getResidentRenderGeometries=function(){return this.getResidentRenderGeometriesFilteredByLayers(r.keysOfMap(this._residentGeomRecords))},e.prototype.getResidentRenderGeometriesFilteredByLayers=function(e){for(var t=[],r=0;r<e.length;r++){var o=e[r],n=this._residentGeomRecords.get(o);n&&n.forEach(function(e){e.forEach(function(e){t.push.apply(t,e[1])})})}return t},e.prototype.visibilityChanged=function(e,t,r){if(null!=t)this._componentPropertyChanged(e,t,r,1);else for(var o=0,n=e.geometryRecords;o<n.length;o++){var i=n[o];this._componentPropertyChanged(e,i,r,1)}},e.prototype.componentHighlightChanged=function(e,t,r){if(null!=t)this._componentPropertyChanged(e,t,r,16);else for(var o=0,n=e.geometryRecords;o<n.length;o++){var i=n[o];this._componentPropertyChanged(e,i,r,16)}},e.prototype.vertexAttrsUpdated=function(e,t,r){this._updateOrCreateDirtyRecord(e,t,r,2,0,0,2,5,2)},e.prototype.matChanged=function(e){this._dirtyMaterials.add(e.id),this.onMaterialChanged&&this.onMaterialChanged(e)},e.prototype.layerAdded=function(e){for(var t=e.getObjects(),r=0;r<t.length;r++)this.layerObjectAdded(e,t[r])},e.prototype.layerRemoved=function(e){for(var t=e.getObjects(),r=0;r<t.length;r++)this.layerObjectRemoved(e,t[r])},e.prototype.layerObjectAdded=function(e,t){for(var r=e.id,o=t.geometryRecords,n=0;n<o.length;n++)this.objGeometryAdded(t,o[n],r)},e.prototype.layerObjectRemoved=function(e,t){for(var r=e.id,o=t.geometryRecords,n=0;n<o.length;n++)this.objGeometryRemoved(t,o[n],r)},e.prototype.layObjectReplaced=function(e,t){this.layerObjectRemoved(e,t[0]),this.layerObjectAdded(e,t[1])},e.prototype.objTransformation=function(e,t){var r=this;t=t||this._getParentLayerId(e);var o=e.id;this._ensureGeomRecord(t,o).forEach(function(o){r._updateOrCreateDirtyRecord(e,o[0],t,2,0,0,2,5,4)})},e.prototype.objGeometryAdded=function(e,t,r){this._updateOrCreateDirtyRecord(e,t,r,1,4,0,0,0)},e.prototype.objGeometryRemoved=function(e,t,r){this._updateOrCreateDirtyRecord(e,t,r,4,1,2,0,0)},e.prototype.objGeometryReplaced=function(e,t){this.objGeometryRemoved(e,t[0]),this.objGeometryAdded(e,t[1])},e.prototype.objGeometryTransformation=function(e,t){this.objGeometryReplaced(e,t)},e.prototype._componentPropertyChanged=function(e,t,r,o){this._updateOrCreateDirtyRecord(e,t,r,2,0,0,2,5,o)},e.prototype._updateOrCreateDirtyRecord=function(e,t,r,o,i,a,d,s,c){r=r||this._getParentLayerId(e);var y=e.id,p=t.id,h=this._ensureDirtyRecord(r,y),f=h.get(p);if(f){var u=f[1];u&i?h.delete(p):u&a?(f[1]=o,f[2]=c):u&d?f[2]|=c:u&s||n.assert(!1,"ModelDirtySet.objGeometryAdded: inconsistent state")}else h.set(p,[t,o,c])},e.prototype._ensureGeomRecord=function(e,t){var r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));var o=r.get(t);return o||(o=new Map,r.set(t,o)),o},e.prototype._ensureDirtyRecord=function(e,t){var r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));var o=r.get(t);return o||(o=new Map,r.set(t,o)),o},e.prototype._getParentLayerId=function(e){return e.parentLayer.id},e.prototype.formatDebugInfo=function(e){if(e)return"";var t=["ADD","UPD",void 0,"REM"],r="";return this._dirtyGeomRecords.forEach(function(e,o){e.forEach(function(e,n){r.length>0&&(r+="\n"),r+=o+"."+n;var i=[];e.forEach(function(e){var t=e[1];i[t]||(i[t]=[]),i[t].push(e[0].geometry.id)});for(var a=0;a<i.length;a++)if(i[a]){r+=" "+t[a-1]+": ";for(var d=0;d<i[a].length;d++)r+=i[a][d]+", "}})}),r},e}()});