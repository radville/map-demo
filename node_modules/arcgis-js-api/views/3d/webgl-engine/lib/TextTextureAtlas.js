// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/iteratorUtils","../../../../core/mathUtils","../../../../core/accessorSupport/decorators","./Texture","../../../support/index","../../../webgl/Texture"],function(e,t,s,i,r,n,a,o,l,d,h){Object.defineProperty(t,"__esModule",{value:!0});var c=512,u=function(e){function t(t){var s=e.call(this,t)||this;return s.dirty=!1,s.needsClear=!1,s.elementsToAddOrUpdate=new Map,s.elementsToRemove=new Map,s.elementsToRender=new Map,s.elements=new Map,s.stageObjects=new Map,s}s(t,e),r=t,t.prototype.initialize=function(){this.id=l.idGen.gen(this.idHint),this.stage=this.view._stage,this.canvas=this.create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(4,this);var e=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(e),this.update2DCanvasSize(),this.resetAtlasCursor()},t.prototype.setUnloadFunc=function(e){this.unloadFunc=e},t.prototype.unload=function(){null!=this.unloadFunc&&(this.unloadFunc(this.id),this.unloadFunc=null)},t.prototype.deferredLoading=function(){return!1},t.prototype.getWidth=function(){return this.atlas.size.width},t.prototype.getHeight=function(){return this.atlas.size.height},t.prototype.initializeThroughRender=function(e,t){var s=this;t.wrapMode=33071,t.samplingMode=9987,t.flipped=!0,t.preMultiplyAlpha=!0,t.hasMipmap=!0,this.glTexture=new h(e,t,this.canvas);var i=this.view.resourceController.scheduler;return this.frameWorker=i.registerTask(d.Task.TEXT_TEXTURE_ATLAS,function(e){return s.run(s.makeRunContext(e))},function(){return s.dirty}),this.setDirty(),this.glTexture},t.prototype.dispose=function(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.glTexture&&(this.glTexture=null,this.stage.remove(4,this.id)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null},t.prototype.create2DCanvas=function(){var e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",c.toString()),e.setAttribute("height",c.toString()),e},t.prototype.update2DCanvasSize=function(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())},t.prototype.createAtlasRegion=function(e){void 0===e&&(e=c),this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}},t.prototype.computeAtlasResolution=function(e,t){var s=Math.max(e,t);return s+=256,s=a.nextHighestPowerOfTwo(s),s=Math.min(s,4096)},t.prototype.resizeAtlas=function(e,t){t=t||e;var s=this.atlas;s.size.width=e,s.size.height=t,this.glTexture&&this.glTexture.resize(e,t),this.update2DCanvasSize()},t.prototype.resetAtlasCursor=function(){var e=this.atlas;e.cursor.x=p,e.cursor.y=p+g,e.lineHeight=0,this.needsClear=!0},t.prototype.getAtlasUsage=function(){var e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)},t.prototype.getExpectedAtlasUsage=function(){var e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,s=this.elements.size;return this.getAtlasUsage()/s*(s+t-e)},t.prototype.addAtlasElement=function(e,t,s,i){var r=this.atlas,n=e.textRenderer,a=n.renderedWidth,o=n.renderedHeight,l=n.displayWidth,d=n.displayHeight;e.placement.offset.x=r.cursor.x,e.placement.offset.y=r.cursor.y,e.placement.size.width=a,e.placement.size.height=o,e.placement.size.displayWidth=l,e.placement.size.displayHeight=d,e.placement.uvMinMax=[e.placement.offset.x/r.size.width,1-(e.placement.offset.y+o)/r.size.height,(e.placement.offset.x+a)/r.size.width,1-e.placement.offset.y/r.size.height],r.cursor.x+=s,r.lineHeight=Math.max(r.lineHeight,i),this.elements.set(t,e)},t.prototype.removeAtlasElement=function(e){if(e&&this.elements.has(e.textId)){var t=e.placement.offset,s=e.placement.size;this.ctx.clearRect(t.x,t.y,s.width,s.height),this.elements.delete(e.textId)}},t.prototype.ensureStageObjects=function(e){var t=this.stageObjects.get(e);if(t)return t;var s=new Set;return this.stageObjects.set(e,s),s},t.prototype.addStageObject=function(e,t){this.ensureStageObjects(e).add(t)},t.prototype.removeStageObject=function(e,t){var s=this.stageObjects.get(e);s&&s.delete(t)&&(t.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),t.geometryVertexAttrsUpdated(0))},t.prototype.processAdditionRequest=function(e,t){var s=this.atlas,i=e.textId,r=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,a=r+p,o=n+p+g,l=t.repackingEnabled;if(s.cursor.x+a<s.size.width&&s.cursor.y+o<s.size.height)this.addAtlasElement(e,i,a,o),this.elementsToRender.set(i,e),this.elementsToAddOrUpdate.delete(i);else{if(!(s.cursor.y+o+s.lineHeight<s.size.height)){var d=this.getExpectedAtlasUsage(),h=d>.85&&s.size.width<4096;return h&&this.resizeAtlas(2*s.size.width,2*s.size.height),!l||!h&&d>.95&&4096===s.size.width?(this.processRemovals(),0):(this.repack(),1)}s.cursor.x=p,s.cursor.y+=s.lineHeight,s.lineHeight=0,this.addAtlasElement(e,i,a,o),this.elementsToRender.set(i,e),this.elementsToAddOrUpdate.delete(i)}return 0},t.prototype.processRemovals=function(){var e=this;this.elementsToRemove.forEach(function(t,s){var i=e.stageObjects.get(s);i&&0!==i.size||e.removeAtlasElement(t),i&&0===i.size&&e.stageObjects.delete(s)}),this.elementsToRemove.clear()},t.prototype.repack=function(){var e=this;this.processRemovals(),this.elements.forEach(function(t,s){t.rendered=!1,e.elementsToAddOrUpdate.set(s,t)}),this.elements.clear(),this.resetAtlasCursor(),this.elementsToRender.clear()},t.prototype.processRenderingRequest=function(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);var t=this.stageObjects.get(e.textId);t&&t.forEach(function(t){t.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(e.placement.uvMinMax),t.geometries[0].data.vertexAttributes.size.data=new Float32Array([e.placement.size.displayWidth,e.placement.size.displayHeight]),t.geometryVertexAttrsUpdated(0)}),e.rendered=!0},t.prototype.run=function(e){var t=this;if(this.glTexture){var s=e.budget,i=!1;if(n.someMap(this.elementsToAddOrUpdate,function(s,r){var n=t.elements.get(r);if(n&&n.rendered){var a=t.stageObjects.get(r);return a&&a.forEach(function(e){var s=e.geometries[0].data.vertexAttributes,i=t.elements.get(r);s.uv0.data=new Float32Array(i.placement.uvMinMax),s.size.data=new Float32Array([i.placement.size.displayWidth,i.placement.size.displayHeight]),e.geometryVertexAttrsUpdated(0)}),t.elementsToAddOrUpdate.delete(r),!1}return 1===t.processAdditionRequest(t.elementsToAddOrUpdate.get(r),e)&&(i=!0,!0)}),i)return e.budget=null,e.repackingEnabled=!1,void this.run(e);var a=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),n.someMap(this.elementsToRender,function(e,i){return t.processRenderingRequest(e),t.elementsToRender.delete(i),a=!0,!(!s||(s.madeProgress(),!s.done))}),a&&this.glTexture.setData(this.canvas),this.dirty=this.elementsToRender.size>0,this.dirty||(r.test.orderedRepackingEnabled&&this.repackOrdered(),this.notifyChange("updating"))}},t.prototype.makeRunContext=function(e){return void 0===e&&(e=null),m.budget=e,m.repackingEnabled=!0,m},t.prototype.addTextTexture=function(e,t){var s=e.key;this.elementsToAddOrUpdate.has(s)||this.elementsToAddOrUpdate.set(s,{textId:s,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this.addStageObject(s,t),this.elementsToRemove.delete(s),this.setDirty()},t.prototype.removeTextTexture=function(e,t){var s=e.key;this.elementsToRemove.set(s,this.elements.get(s)),this.removeStageObject(s,t)},Object.defineProperty(t.prototype,"textureId",{get:function(){return this.id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return this.dirty},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this.dirty&&!!this.frameWorker},enumerable:!0,configurable:!0}),t.prototype.setDirty=function(){this.dirty||(this.dirty=!0,this.notifyChange("updating"))},Object.defineProperty(t.prototype,"test",{get:function(){var e=this,t=e.elements,s=e.stageObjects,i=e.elementsToRemove,r=e.atlas,n=this;return{elements:t,stageObjects:s,elementsToRemove:i,atlas:r,resizeAtlas:function(e,t){return n.resizeAtlas(e,t)},run:function(e){return n.run(e)}}},enumerable:!0,configurable:!0}),t.prototype.repackOrdered=function(){if(0!==this.elements.size){var e=[];this.elements.forEach(function(t,s){return e.push({element:t,key:s})});for(var t=!0,s=0;s<e.length-1;s++)if(e[s].key.localeCompare(e[s+1].key)>0){t=!1;break}if(!t){e.sort(function(e,t){return e.key.localeCompare(t.key)}),this.elements.clear();for(var i=0,r=e;i<r.length;i++){var n=r[i],a=n.element,o=n.key;this.elements.set(o,a)}this.repack(),this.setDirty()}}};var r;return t.test={orderedRepackingEnabled:!1},i([o.property({constructOnly:!0})],t.prototype,"idHint",void 0),i([o.property({constructOnly:!0})],t.prototype,"view",void 0),i([o.property({type:Boolean,readOnly:!0})],t.prototype,"updating",null),t=r=i([o.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],t)}(o.declared(r));t.TextTextureAtlas=u;var p=2,g=2,m={budget:null,repackingEnabled:!0};t.default=u});