// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/Logger","./TextureTechnique","./Util","../../../webgl/Texture"],function(e,t,r,i,n,a){var s=r.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository"),u=function(){function e(e,t,r,n,a){this.NUM_PARALLEL=8,this._fallbackTexture=null,this._fallbackTextureTransparent=null,this.textures=e,this._textureTechniqueConfig=new i.TextureTechniqueConfiguration,this._textureTechnique=t.acquireAndReleaseExisting(i.TextureTechnique,this._textureTechniqueConfig,this._textureTechnique),this.getViewportToRestore=r,this.onNewlyTexturesLoaded=a,this._rctx=n,this.NUM_PARALLEL=8,this.id2textureRef={},this.loading={},this._queue=[],this.listeners=[],this.afExt=n.capabilities.textureFilterAnisotropic,this.maxMaxAnisotropy=this.afExt?n.parameters.maxMaxAnisotropy:1,this.maxAnisotropy=Math.min(8,this.maxMaxAnisotropy);this._fallbackTextureData=new Uint8Array(256),this._fallbackTextureTransparentData=new Uint8Array(256);for(var s=0;s<this._fallbackTextureData.length;++s)this._fallbackTextureData[s]=255,this._fallbackTextureTransparentData[s]=(s+1)%4!=0?255:0;this._fallbackTextureDesc={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:8},this.onNewlyTexturesLoaded()}return e.prototype.acquire=function(t,r,i){var a=this,u=this.id2textureRef[t];if(null==u){var o=this.textures.get(t);n.assert(void 0!==o),o.setUnloadFunc(function(e){return a._unload(e)});var h=!0===r,l=this._createGLTextureDescription(o);if(u=new e.TextureRef(null),n.assert(null==this.id2textureRef[t]),this.id2textureRef[t]=u,o.initializeThroughRender){var x=o.initializeThroughRender(this._rctx,l);u.setGLTexture(x),i&&i(u)}else if(o.deferredLoading())this.getLoadingCount()<this.NUM_PARALLEL?this._loadImage(t,l,i):this._queue.push([t,l,i]);else try{o.initializeThroughUpload(this._rctx,l,this._textureTechnique,this.getViewportToRestore(),function(e){u.setGLTexture(e),a.onNewlyTexturesLoaded(),i&&i(u)})}catch(e){s.error("#acquire","Error loading texture: "+e.toString())}null==u.getGLTexture()&&u.setGLTexture(h?this.fallbackTextureTransparent:this.fallbackTexture),this.onNewlyTexturesLoaded()}return u.incRefCnt(),u},e.prototype.release=function(e){var t=this.id2textureRef[e];void 0!==t&&(t.decRefCnt(),n.assert(t.getRefCnt()>=0))},e.prototype.getLoadingCount=function(){return Object.keys(this.loading).length},e.prototype.getTexture=function(e){return this.textures.get(e)},e.prototype.getMaxAnisotropy=function(){return this.maxAnisotropy},e.prototype._unload=function(e){var t=this.id2textureRef[e];if(void 0!==t){var r=t.getGLTexture();r&&r!==this.fallbackTextureTransparent&&r!==this.fallbackTexture&&r.dispose(),delete this.id2textureRef[e]}this.next(e)},e.prototype._createGLTextureDescription=function(e){var t=e.params&&e.params.wrap;return{target:3553,pixelFormat:6408,dataType:5121,maxAnisotropy:this.afExt&&e.params&&e.params.mipmap&&!e.params.disableAnisotropy?this.maxAnisotropy:void 0,wrapMode:t}},e.prototype.next=function(e){if(e in this.loading){delete this.loading[e];var t=Object.keys(this.id2textureRef),r=Object.keys(this.loading);this.listeners.forEach(function(i){i(e,t,r)}),this.processQueue()}},e.prototype._loadImage=function(e,t,r){var i=this;n.assert(null==this.loading[e]),this.loading[e]=!0;var a=this.textures.get(e);n.assert(void 0!==a),setTimeout(function(){var n=i.id2textureRef[e];n&&n.getRefCnt()&&a.initializeThroughUpload(i._rctx,t,i._textureTechnique,i.getViewportToRestore(),function(t){i.next(e),i.onNewlyTexturesLoaded(),n&&n.getRefCnt()&&(n.setGLTexture(t),r&&r(n))})},0)},e.prototype.processQueue=function(){for(var e=[],t=0;t<this._queue.length;++t){var r=this._queue[t],i=r[0],n=this.id2textureRef[i];if(void 0!==n){0===n.getRefCnt()?(n.getGLTexture().dispose(),delete this.id2textureRef[i]):e.push(this._queue[t])}}this._queue=e;for(var a=Math.min(this.NUM_PARALLEL-Object.keys(this.loading).length,this._queue.length),t=0;t<a;++t)this._loadImage(this._queue[t][0],this._queue[t][1],this._queue[t][2]);this._queue.splice(0,a)},Object.defineProperty(e.prototype,"fallbackTexture",{get:function(){return this._fallbackTexture||(this._fallbackTexture=new a(this._rctx,this._fallbackTextureDesc,this._fallbackTextureData)),this._fallbackTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fallbackTextureTransparent",{get:function(){return this._fallbackTextureTransparent||(this._fallbackTextureTransparent=new a(this._rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData)),this._fallbackTextureTransparent},enumerable:!0,configurable:!0}),e}();return function(e){var t=function(){function e(e){this._glTexture=null,this._refCount=0,this._glTexture=e}return e.prototype.incRefCnt=function(){++this._refCount},e.prototype.decRefCnt=function(){--this._refCount,n.assert(this._refCount>=0)},e.prototype.getRefCnt=function(){return this._refCount},e.prototype.setGLTexture=function(e){this._glTexture=e},e.prototype.getGLTexture=function(){return this._glTexture},e}();e.TextureRef=t}(u||(u={})),u});