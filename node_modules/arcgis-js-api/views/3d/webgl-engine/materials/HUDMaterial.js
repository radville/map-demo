// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/mat3","../../../../core/libs/gl-matrix-2/mat3f64","../../../../core/libs/gl-matrix-2/mat4","../../../../core/libs/gl-matrix-2/mat4f64","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec2f64","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../../../core/libs/gl-matrix-2/types/mat4","../../../../geometry/support/aaBoundingRect","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/geometryDataUtils","../lib/GLMaterialTexture","../lib/Material","../lib/screenSizePerspectiveUtils","../lib/Util","./internal/bufferWriterUtils","./internal/MaterialUtil","./renderers/MergedRenderer","../shaders/HUDPrograms","../../../webgl/renderState"],function(e,t,r,i,n,a,o,s,c,l,f,p,v,d,u,m,g,h,S,P,x,A,O,y,b,z){function C(e,t,r){var i=r.cameraAboveGround?1:-1;e.setUniform1f("cameraGroundRelative",i),e.setUniform1f("polygonOffset",t.shaderPolygonOffset),e.setUniform4fv("viewport",r.viewport),e.setUniform1f("perDistancePixelRatio",Math.tan(r.fovY/2)/(r.viewport[2]/2)),O.bindVerticalOffset(t.verticalOffset,r,e),e.setUniformMatrix4fv("viewNormal",r.viewInvTransp),t.screenSizePerspective&&(O.bindScreenSizePerspective(t.screenSizePerspective,e,"screenSizePerspective"),O.bindScreenSizePerspective(t.screenSizePerspectiveAlignment||t.screenSizePerspective,e,"screenSizePerspectiveAlignment"))}function V(e,t,r,i){r.occlusionTest&&(t.setUniform1i("hudVisibilityTexture",1),e.bindTexture(i.hudVisibilityTexture,1),e.setActiveTexture(0)),t.setUniform1f("uRenderTransparentlyOccludedHUD","occluded"===i.renderTransparentlyOccludedHUD?1:"notOccluded"===i.renderTransparentlyOccludedHUD?0:.75);var n=i.pixelRatio||1;t.setUniform4fv("overrideColor",r.color),t.setUniform1f("pixelRatio",n),r.textureIsSignedDistanceField&&(t.setUniform4fv("outlineColor",r.outlineColor),t.setUniform1f("outlineSize",r.outlineSize)),r.vvSizeEnabled&&(t.setUniform3fv("vvSizeMinSize",r.vvSizeMinSize),t.setUniform3fv("vvSizeMaxSize",r.vvSizeMaxSize),t.setUniform3fv("vvSizeOffset",r.vvSizeOffset),t.setUniform3fv("vvSizeFactor",r.vvSizeFactor)),r.vvColorEnabled&&(t.setUniform1fv("vvColorValues",r.vvColorValues),t.setUniform4fv("vvColorColors",r.vvColorColors)),t.setUniform2f("screenOffset",2*r.screenOffset[0]*n,2*r.screenOffset[1]*n),t.setUniform2fv("anchorPos",U(r))}function U(e,t){return void 0===t&&(t=E),e.textureIsSignedDistanceField?M(e.anchorPos,e.distanceFieldBoundingBox,t):c.vec2.copy(t,e.anchorPos),t}function I(e,t,r,i){return void 0===i&&(i=E),c.vec2.copy(i,e.anchorPos),i[0]*=-t[0],i[1]*=-t[1],i[0]+=e.screenOffset[0]*r,i[1]+=e.screenOffset[1]*r,i}function M(e,t,r){r[0]=e[0]*(t[2]-t[0])+t[0],r[1]=e[1]*(t[3]-t[1])+t[1]}function T(e){var t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8],f=1/Math.sqrt(t*t+r*r+i*i),p=1/Math.sqrt(n*n+a*a+o*o),v=1/Math.sqrt(s*s+c*c+l*l);return e[0]=t*f,e[1]=r*f,e[2]=i*f,e[3]=n*p,e[4]=a*p,e[5]=o*p,e[6]=s*v,e[7]=c*v,e[8]=l*v,e}var w=function(e){function t(t,r){var i=e.call(this,r)||this;return i.params=O.copyParameters(t,K),i}return r(t,e),t.prototype.dispose=function(){},t.prototype.setParameterValues=function(e){for(var t in e)"textureId"===t&&x.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[t]=e[t];this.notifyDirty("matChanged")},t.prototype.getParameters=function(){return this.params},t.prototype.intersect=function(e,t,r,i,n,a,o,s,c){c?this.intersectDrapedRenderHudGeometry(e,a,o,s):this.intersectHudGeometry(e,t,r,i,o,s)},t.prototype.intersectDrapedRenderHudGeometry=function(e,t,r,i){var n=e.getAttribute(x.VertexAttrConstants.POSITION),a=e.getAttribute(x.VertexAttrConstants.SIZE),o=this.params,s=U(o),c=1,l=1;if(i){var p=i(q);c=p[0],l=p[5]}c*=e.pixelRatio,l*=e.pixelRatio;for(var v=j*e.pixelRatio,d=0;d<n.data.length/n.size;d++){var u=d*n.size;f.vec3.set(F,n.data[u],n.data[u+1],n.data[u+2]);var m=d*a.size;Y[0]=a.data[m]*c,Y[1]=a.data[m+1]*l;var g=F[0],h=F[1],S=void 0;o.textureIsSignedDistanceField&&(S=o.outlineSize*e.pixelRatio/2),this._isInsideIconBoundaries(t,g,h,v,S,o,s)&&r()}},t.prototype.intersectHudGeometry=function(e,t,r,i,a,s){if(i.options.selectionMode&&i.options.hud&&!m.isAllHidden(t.componentVisibilities,e.componentOffsets)){var c=e.data,l=this.params,v=1,d=1;if(n.mat3.fromMat4(X,r),s){var u=s(q);v=u[0],d=u[5],T(X)}var g=c.getVertexAttr()[x.VertexAttrConstants.POSITION],h=c.getVertexAttr()[x.VertexAttrConstants.SIZE],S=c.getVertexAttr()[x.VertexAttrConstants.NORMAL],A=c.getVertexAttr()[x.VertexAttrConstants.AUXPOS1];x.assert(g.size>=3);var O=i.point,y=i.camera,b=U(l);v*=y.pixelRatio,d*=y.pixelRatio;for(var z="screen"===this.params.centerOffsetUnits,C=0;C<g.data.length/g.size;C++){var V=C*g.size;f.vec3.set(F,g.data[V],g.data[V+1],g.data[V+2]),f.vec3.transformMat4(F,F,r);var I=C*h.size;Y[0]=h.data[I]*v,Y[1]=h.data[I+1]*d,f.vec3.transformMat4(F,F,y.viewMatrix);var M=C*A.size;if(f.vec3.set(k,A.data[M+0],A.data[M+1],A.data[M+2]),!z&&(F[0]+=k[0],F[1]+=k[1],0!==k[2])){var w=k[2];f.vec3.normalize(k,F),f.vec3.subtract(F,F,f.vec3.scale(k,k,w))}var R=C*S.size;if(f.vec3.set(N,S.data[R],S.data[R+1],S.data[R+2]),this.applyVerticalOffsetTransformation(F,N,X,y,B),y.applyProjection(F,H),H[0]>-1){var D=Math.floor(H[0])+this.params.screenOffset[0],E=Math.floor(H[1])+this.params.screenOffset[1];z&&(D+=k[0],0!==k[1]&&(E+=P.applyScaleFactor(k[1],B.factorAlignment))),P.applyPrecomputedScaleFactorVec2(Y,B.factor,Y);var L=_*y.pixelRatio,Z=void 0;if(l.textureIsSignedDistanceField&&(Z=l.outlineSize*y.pixelRatio/2),this._isInsideIconBoundaries(O,D,E,L,Z,l,b)){var j=i.ray;f.vec3.transformMat4(W,F,o.mat4.invert(G,y.viewMatrix)),H[0]=O[0],H[1]=O[1],y.unprojectPoint(H,F);var J=p.vec3f64.create();f.vec3.copy(J,j.direction);var K=1/f.vec3.length(J);f.vec3.scale(J,J,K);a(f.vec3.distance(j.origin,F)*K,J,-1,1,!0,W)}}}}},t.prototype.computeAttachmentOrigin=function(e,t){var r=e.data,i="getVertexAttr"in r?r.getVertexAttr():"vertexAttr"in r?r.vertexAttr:null;if(!i)return null;var n=x.VertexAttrConstants.POSITION,a=i[n],o="getIndices"in r?r.getIndices(n):"indices"in r?r.indices[n]:null;return g.computeAttachmentOriginPoints(a,o,t)},t.prototype._isInsideIconBoundaries=function(e,t,r,i,n,a,o){var s=t-i-(o[0]>0?Y[0]*o[0]:0),c=s+Y[0]+2*i,l=r-i-(o[1]>0?Y[1]*o[1]:0),f=l+Y[1]+2*i;if(a.textureIsSignedDistanceField){var p=a.distanceFieldBoundingBox;s+=Y[0]*p[0],l+=Y[1]*p[1],c-=Y[0]*(1-p[2]),f-=Y[1]*(1-p[3]),s-=n,c+=n,l-=n,f+=n}return e[0]>s&&e[0]<c&&e[1]>l&&e[1]<f},t.prototype.createBufferWriter=function(){return new $(this)},t.prototype.createRenderer=function(e,t){return new y(e,t,this)},t.prototype.normalAndViewAngle=function(e,t,r,i){return void 0===i&&(i=Z),f.vec3.transformMat3(i.normal,e,t),f.vec3.transformMat4(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=f.vec3.dot(L,J),i},t.prototype.updateScaleInfo=function(e,t){var r=this.params;r.screenSizePerspective?e.factor=P.precomputeScaleFactor(Z.cosAngle,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),r.screenSizePerspectiveAlignment?e.factorAlignment=P.precomputeScaleFactor(Z.cosAngle,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)},t.prototype.applyVerticalOffsetTransformation=function(e,t,r,i,a,o){var s=this.params;if(v.isMat4(r)&&(r=n.mat3.fromMat4(X,r)),!s.verticalOffset||!s.verticalOffset.screenLength){if(a&&(s.screenSizePerspective||s.screenSizePerspectiveAlignment)){var c=f.vec3.length(e);this.updateScaleInfo(a,c)}else a&&(a.factor.scale=1,a.factorAlignment.scale=1);return o?f.vec3.copy(o,e):e}var l=this.normalAndViewAngle(t,r,i),p=f.vec3.length(e),d=s.screenSizePerspectiveAlignment||s.screenSizePerspective,u=O.verticalOffsetAtDistance(i,p,s.verticalOffset,l.cosAngle,d);return a&&this.updateScaleInfo(a,p),f.vec3.add(o||e,e,f.vec3.scale(l.normal,l.normal,u))},t.prototype.getGLMaterials=function(){return{color:R,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:D}},t.prototype.calculateRelativeScreenBounds=function(e,t,r){return void 0===r&&(r=d.create()),I(this.params,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r},t.prototype.calculateAnchorPosForRendering=function(e){return U(this.params,e)},t.shouldRenderVisibilityDuringRenderPass=function(e){return 0===e||4},t}(S.Material),R=function(e){function t(t){var r=e.call(this,h.makeCtorParameters(t,t.material.getParameters()))||this;return r.isOcclusionSlot=!1,r.updateParameters(),r}return r(t,e),t.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?16:15},t.prototype.selectProgram=function(){var e=this.params;this.occlusionProgram=this.programRep.getProgram(b.occlusionPass,{verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,slice:e.slicePlaneEnabled}),this.renderProgram=this.programRep.getProgram(b.colorPass,{occlTest:e.occlusionTest,sdf:e.textureIsSignedDistanceField,vvSize:!!e.vvSizeEnabled,vvColor:!!e.vvColorEnabled,verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,debugDrawBorder:!!e.debugDrawBorder,slice:e.slicePlaneEnabled}),this.renderPipelineState=z.makePipelineState({blending:z.simpleBlendingParams(1,771),polygonOffset:e.polygonOffset&&ee,depthTest:{func:515},depthWrite:z.defaultDepthWriteParams,colorWrite:z.defaultColorWriteParams}),this.occlusionPipelineState=z.makePipelineState({depthTest:{func:515},depthWrite:z.defaultDepthWriteParams,colorWrite:z.defaultColorWriteParams})},t.prototype.beginSlot=function(e){return this.params.occlusionTest?(this.isOcclusionSlot=10===e,10===e||e===this.mainSlot):(this.isOcclusionSlot=!1,e===this.mainSlot)},t.prototype.getProgram=function(){return this.isOcclusionSlot?this.occlusionProgram:this.renderProgram},t.prototype.getPrograms=function(){return[this.occlusionProgram,this.renderProgram]},t.prototype.updateParameters=function(){this.params=O.copyParameters(this.material.getParameters()),this.updateTexture(this.params.textureId),this.selectProgram(),this.selectSlot()},t.prototype.bind=function(e,t){if(this.isOcclusionSlot){var r=this.occlusionProgram;e.bindProgram(r),e.setPipelineState(this.occlusionPipelineState),C(r,this.params,t),r.setUniform4f("color",1,1,1,1),r.setUniform1f("pixelRatio",t.pixelRatio||1)}else{var r=this.renderProgram;e.bindProgram(r),e.setPipelineState(this.renderPipelineState),this.bindTexture(e,r),this.bindTextureScale(e,r),C(r,this.params,t),V(e,r,this.params,t)}},t.prototype.bindView=function(e){var t=e.origin,r=this.getProgram();O.bindView(t,e.view,r),O.bindCamPos(t,e.viewInvTransp,r),this.params.slicePlaneEnabled&&O.bindSlicePlane(e.origin,e.slicePlane,r)},t.prototype.bindInstance=function(e){var t=this.getProgram();t.setUniformMatrix4fv("model",e.transformation),t.setUniformMatrix4fv("modelNormal",e.transformationNormal)},t.prototype.release=function(){},t.prototype.getDrawMode=function(){return this.isOcclusionSlot?0:4},t}(h),D=function(e){function t(t){var r=e.call(this,h.makeCtorParameters(t,t.material.getParameters()))||this;return r.updateParameters(),r}return r(t,e),t.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?16:15},t.prototype.beginSlot=function(e){return e===this.mainSlot},t.prototype.getProgram=function(){return this.program},t.prototype.updateParameters=function(){this.params=O.copyParameters(this.material.getParameters()),this.updateTexture(this.params.textureId),this.selectProgram(),this.selectSlot()},t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(b.highlightPass,{occlTest:e.occlusionTest,sdf:e.textureIsSignedDistanceField,vvSize:!!e.vvSizeEnabled,vvColor:!!e.vvColorEnabled,verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,binaryHighlightOcclusion:e.binaryHighlightOcclusion,slice:e.slicePlaneEnabled}),this.pipelineState=z.makePipelineState({blending:z.separateBlendingParams(1,1,771,771),polygonOffset:e.polygonOffset&&ee,depthTest:{func:513},colorWrite:z.defaultColorWriteParams})},t.prototype.bind=function(e,t){var r=this.program;e.bindProgram(r),e.setPipelineState(this.pipelineState),this.bindTexture(e,r),this.bindTextureScale(e,r),C(r,this.params,t),V(e,r,this.params,t),O.bindHighlightRendering(e,t,this.program)},t.prototype.bindView=function(e){var t=e.origin,r=this.getProgram();O.bindView(t,e.view,r),O.bindCamPos(t,e.viewInvTransp,r),this.params.slicePlaneEnabled&&O.bindSlicePlane(e.origin,e.slicePlane,r)},t.prototype.bindInstance=function(e){var t=this.getProgram();t.setUniformMatrix4fv("model",e.transformation),t.setUniformMatrix4fv("modelNormal",e.transformationNormal)},t.prototype.release=function(){},t.prototype.getDrawMode=function(){return 4},t}(h),B={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},E=l.vec2f64.create(),F=p.vec3f64.create(),N=p.vec3f64.create(),H=i.createRenderScreenPointArray3(),L=p.vec3f64.create(),W=p.vec3f64.create(),X=a.mat3f64.create(),G=s.mat4f64.create(),k=p.vec3f64.create(),Z={normal:L,cosAngle:0},q=s.mat4f64.create(),_=1,j=2,Y=[0,0],J=p.vec3f64.fromValues(0,0,1),K={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:l.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",debugDrawBorder:!1},Q=u.newLayout().vec3f(x.VertexAttrConstants.POSITION).vec3f(x.VertexAttrConstants.NORMAL).vec2f(x.VertexAttrConstants.UV0).vec4u8(x.VertexAttrConstants.COLOR).vec2f(x.VertexAttrConstants.SIZE).vec4f(x.VertexAttrConstants.AUXPOS1).vec4f(x.VertexAttrConstants.AUXPOS2),$=function(){function e(e){this.material=e,this.vertexBufferLayout=Q}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return 6*e.indices[x.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,i){A.writePosition(t.indices[x.VertexAttrConstants.POSITION],t.vertexAttr[x.VertexAttrConstants.POSITION].data,e.transformation,r.position,i,6),A.writeNormal(t.indices[x.VertexAttrConstants.NORMAL],t.vertexAttr[x.VertexAttrConstants.NORMAL].data,e.invTranspTransformation,r.normal,i,6);var n=t.vertexAttr[x.VertexAttrConstants.UV0].data,a=void 0,o=void 0,s=void 0,c=void 0;if(null==n||n.length<4){var l=this.material.getParameters();a=0,o=0,s=l.texCoordScale[0],c=l.texCoordScale[1]}else a=n[0],o=n[1],s=n[2],c=n[3];s=Math.min(1.99999,s+1),c=Math.min(1.99999,c+1);for(var f=t.indices[x.VertexAttrConstants.POSITION].length,p=r.uv0,v=i,d=0;d<f;++d)p.set(v,0,a),p.set(v,1,o),v+=1,p.set(v,0,s),p.set(v,1,o),v+=1,p.set(v,0,s),p.set(v,1,c),v+=1,p.set(v,0,s),p.set(v,1,c),v+=1,p.set(v,0,a),p.set(v,1,c),v+=1,p.set(v,0,a),p.set(v,1,o),v+=1;A.writeColor(t.indices[x.VertexAttrConstants.COLOR],t.vertexAttr[x.VertexAttrConstants.COLOR].data,4,r.color,i,6);for(var u=t.indices[x.VertexAttrConstants.SIZE],m=t.vertexAttr[x.VertexAttrConstants.SIZE].data,g=u.length,h=r.size,v=i,d=0;d<g;++d)for(var S=m[2*u[d]],P=m[2*u[d]+1],O=0;O<6;++O)h.set(v,0,S),h.set(v,1,P),v+=1;t.indices[x.VertexAttrConstants.AUXPOS1]&&t.vertexAttr[x.VertexAttrConstants.AUXPOS1]&&A.writeBufferVec4(t.indices[x.VertexAttrConstants.AUXPOS1],t.vertexAttr[x.VertexAttrConstants.AUXPOS1].data,r.auxpos1,i,6),t.indices[x.VertexAttrConstants.AUXPOS2]&&t.vertexAttr[x.VertexAttrConstants.AUXPOS2]&&A.writeBufferVec4(t.indices[x.VertexAttrConstants.AUXPOS2],t.vertexAttr[x.VertexAttrConstants.AUXPOS2].data,r.auxpos2,i,6)},e}(),ee={factor:0,units:-4};return w});