// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/Logger","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/buffer/BufferView","../lib/ComponentUtils","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/bufferWriterUtils","./internal/DefaultBufferWriter","./internal/MaterialUtil","./renderers/MergedRenderer","../shaders/NativeLineTechnique"],function(e,t,r,n,i,a,o,s,c,p,l,u,f,h,g,m,d,v,y,P,b,A){var x=i.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial"),C=function(e){function t(t,r){var n=e.call(this,r)||this;return n.techniqueConfig=new A.NativeLineTechniqueConfiguration,n.params=P.copyParameters(t,D),n}return r(t,e),t.prototype.setParameterValues=function(e){var t=this.params;for(var r in e)t[r]=e[r];this.notifyDirty("matChanged")},t.prototype.getParameters=function(){return this.params},t.prototype.getTechniqueConfig=function(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;var t=a.isSome(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&a.isSome(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig},t.prototype.getPassParameters=function(){return this.params},t.prototype.intersect=function(e,t,r,n,i,a,o,s,c){c?this.intersectLineGeometry(e,t,r,n,o):P.intersectDrapedRenderLineGeometry(e,n,a,1,o)},t.prototype.intersectLineGeometry=function(e,t,r,n,i){if(n.options.selectionMode&&!f.isAllHidden(t.componentVisibilities,e.componentOffsets)){if(!d.isTranslationMatrix(r))return void x.error("intersection assumes a translation-only matrix");var a=e.data.getVertexAttr().position.data,o=n.camera,p=G;s.vec2.copy(p,n.point);c.vec3.set(j[0],p[0]-2,p[1]+2,0),c.vec3.set(j[1],p[0]+2,p[1]+2,0),c.vec3.set(j[2],p[0]+2,p[1]-2,0),c.vec3.set(j[3],p[0]-2,p[1]-2,0);for(var u=0;u<4;u++)o.unprojectPoint(j[u],W[u]);l.plane.fromPoints(o.eye,W[0],W[1],X),l.plane.fromPoints(o.eye,W[1],W[2],H),l.plane.fromPoints(o.eye,W[2],W[3],_),l.plane.fromPoints(o.eye,W[3],W[0],F);for(var h=Number.MAX_VALUE,u=0;u<a.length-5;u+=3)if(V[0]=a[u]+r[12],V[1]=a[u+1]+r[13],V[2]=a[u+2]+r[14],O[0]=a[u+3]+r[12],O[1]=a[u+4]+r[13],O[2]=a[u+5]+r[14],!(l.plane.signedDistance(X,V)<0&&l.plane.signedDistance(X,O)<0||l.plane.signedDistance(H,V)<0&&l.plane.signedDistance(H,O)<0||l.plane.signedDistance(_,V)<0&&l.plane.signedDistance(_,O)<0||l.plane.signedDistance(F,V)<0&&l.plane.signedDistance(F,O)<0)){if(o.projectPoint(V,B),o.projectPoint(O,I),B[2]<0&&I[2]>0){c.vec3.subtract(M,V,O);var g=o.frustum,m=-l.plane.signedDistance(g.planes[4],V),v=m/c.vec3.dot(M,g.planes[4]);c.vec3.scale(M,M,v),c.vec3.add(V,V,M),o.projectPoint(V,B)}else if(B[2]>0&&I[2]<0){c.vec3.subtract(M,O,V);var g=o.frustum,m=-l.plane.signedDistance(g.planes[4],O),v=m/c.vec3.dot(M,g.planes[4]);c.vec3.scale(M,M,v),c.vec3.add(O,O,M),o.projectPoint(O,I)}else if(B[2]<0&&I[2]<0)continue;B[2]=0,I[2]=0;var y=l.lineSegment.distance2(l.lineSegment.fromPoints(B,I,N),p);y<h&&(h=y,c.vec3.copy(T,V),c.vec3.copy(U,O))}var P=n.rayBeginPoint,b=n.rayEndPoint;if(h<4){var A=Number.MAX_VALUE;if(l.lineSegment.closestLineSegmentPoint(l.lineSegment.fromPoints(T,U,N),l.lineSegment.fromPoints(P,b,E),R)){c.vec3.subtract(R,R,P);var C=c.vec3.length(R);c.vec3.scale(R,R,1/C),A=C/c.vec3.distance(P,b)}i(A,R)}}},t.prototype.computeAttachmentOrigin=function(e,t){var r=e.data,n="getVertexAttr"in r?r.getVertexAttr():"vertexAttr"in r?r.vertexAttr:null;if(!n)return null;var i=d.VertexAttrConstants.POSITION,a=n[i];return h.computeAttachmentOriginLines(a,null,t)},t.prototype.createBufferWriter=function(){var e=this.params.vertexColors?y.PositionColorLayout:y.PositionLayout;return a.isNone(this.params.stipplePattern)?new y.DefaultBufferWriter(e):new w(e.clone().vec3f(d.VertexAttrConstants.AUXPOS1))},t.prototype.createRenderer=function(e,t){return new b(e,t,this)},t.prototype.getGLMaterials=function(){return{color:q,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:L}},t}(m.Material),S=function(e){function t(t){var r=e.call(this,t)||this;return r.output=t.output,r.updateParameters(),r}return r(t,e),t.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(A.NativeLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)},t.prototype.beginSlot=function(e){return 4===e},t.prototype.getProgram=function(){return this.technique.program},t.prototype.getPrograms=function(){return null},t.prototype.bind=function(e,t){e.bindProgram(this.technique.program),this.technique.bindPipelineState(e),this.technique.bindPass(e,this.material.getPassParameters(),t)},t.prototype.release=function(){},t.prototype.bindView=function(e){this.technique.bindDraw(e)},t.prototype.bindInstance=function(e){this.technique.program.setUniformMatrix4fv("model",e.transformation)},t.prototype.getDrawMode=function(){return 1},t}(g.GLMaterial),q=function(e){function t(t){return e.call(this,n({},t,{output:0}))||this}return r(t,e),t}(S),L=function(e){function t(t){return e.call(this,n({},t,{output:4}))||this}return r(t,e),t}(S),w=function(){function e(e){this.vertexBufferLayout=e}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return e.indices[d.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,n){v.writeDefaultAttributes(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,n),this.writeAuxpos1(e,t,r,n)},e.prototype.writeAuxpos1=function(e,t,r,n){var i=r.getField(d.VertexAttrConstants.AUXPOS1,u.BufferViewVec3f),a=t.indices[d.VertexAttrConstants.POSITION],o=t.vertexAttr[d.VertexAttrConstants.POSITION].data,s=e.transformation,c=i.typedBufferStride,p=i.typedBuffer;n*=c;for(var l=0;l<a.length;l+=2)for(var f=3*a[l],h=o[f],g=o[f+1],m=o[f+2],v=s[0]*h+s[4]*g+s[8]*m+s[12],y=s[1]*h+s[5]*g+s[9]*m+s[13],P=s[2]*h+s[6]*g+s[10]*m+s[14],b=0;b<2;++b)p[n]=v,p[n+1]=y,p[n+2]=P,n+=c},e}(),D={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null},V=p.vec3f64.create(),O=p.vec3f64.create(),M=p.vec3f64.create(),R=p.vec3f64.create(),B=o.createRenderScreenPointArray3(),I=o.createRenderScreenPointArray3(),T=p.vec3f64.create(),U=p.vec3f64.create(),N=l.lineSegment.create(),E=l.lineSegment.create(),G=p.vec3f64.create(),j=[o.createRenderScreenPointArray3(),o.createRenderScreenPointArray3(),o.createRenderScreenPointArray3(),o.createRenderScreenPointArray3()],W=[p.vec3f64.create(),p.vec3f64.create(),p.vec3f64.create(),p.vec3f64.create()],X=l.plane.create(),H=l.plane.create(),_=l.plane.create(),F=l.plane.create();return C});