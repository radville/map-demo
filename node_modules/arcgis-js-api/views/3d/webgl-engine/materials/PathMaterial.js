// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/mathUtils","../../../../geometry/support/aaBoundingBox","../../support/buffer/BufferView","../../support/buffer/InterleavedLayout","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./PathTechnique","./VisualVariableMaterialParameters","./internal/bufferWriterUtils","./internal/MaterialUtil","./internal/MaterialUtil","./renderers/MergedRenderer"],function(t,e,r,i,n,a,o,s,u,h,p,c,f,l,d,b,v,m){var g=c.assert,y=function(t){function e(r,i){var n=t.call(this,i)||this;return n.supportsEdges=!0,n.techniqueConfig=new f.PathTechniqueConfiguration,n.params=v.copyParameters(r,q),n.vertexBufferLayout=e.getVertexBufferLayout(n.params),n}return i(e,t),e.prototype.getTechniqueConfig=function(t){return this.techniqueConfig.output=t,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,0===t&&(this.techniqueConfig.doubleSidedMode=this.params.doubleSided&&"normal"===this.params.doubleSidedType?1:this.params.doubleSided&&"winding-order"===this.params.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.params.receiveShadows,this.techniqueConfig.receiveSSAO=this.params.receiveSSAO),this.techniqueConfig},e.prototype.getPassParameters=function(){return this.params},e.prototype.isVisibleInPass=function(t){return 3!==t||this.params.castShadows},e.prototype.isVisible=function(){var e=this.params;return!!t.prototype.isVisible.call(this)&&e.opacity>0},e.prototype.setParameterValues=function(t){b.updateParameters(this.params,t)&&this.notifyDirty("matChanged")},e.prototype.getParameters=function(){return this.params},e.prototype.intersect=function(t,e,r,i,o,s,u){var h=t;if(h.metadata){var p=h.metadata.pathGeometry,c=[this.params.size[0],this.params.size[1]];if(this.params.vvSizeEnabled){var f=this.params.vvSizeOffset,l=this.params.vvSizeFactor,d=this.params.vvSizeMinSize,b=this.params.vvSizeMaxSize,m=p.sizeAttributeValue;c[0]*=n.clamp(f[0]+m*l[0],d[0],b[0]),c[1]*=n.clamp(f[1]+m*l[1],d[1],b[1])}var g=Math.max(c[0],c[1]),y=a.fromValues(t.boundingInfo.bbMin[0]-g,t.boundingInfo.bbMin[1]-g,t.boundingInfo.bbMin[2]-g,t.boundingInfo.bbMax[0]+g,t.boundingInfo.bbMax[1]+g,t.boundingInfo.bbMax[2]+g),P=[s[0]-o[0],s[1]-o[1],s[2]-o[2]],S=Math.sqrt(P[0]*P[0]+P[1]*P[1]+P[2]*P[2]),A=[S/P[0],S/P[1],S/P[2]];v.intersectAabbInvDir(y,o,A,i.tolerance)&&(p.baked.size&&p.baked.size[0]===c[0]&&p.baked.size[1]===c[1]||p.baked.bake(c),p.baked.intersect(o,s,u))}},e.prototype.computeAttachmentOrigin=function(t,e){var r=t.data,i="getVertexAttr"in r?r.getVertexAttr():"vertexAttr"in r?r.vertexAttr:null;if(!i)return null;var n=f.PathVertexAttrConstants.POSITION,a=i[n];return u.computeAttachmentOriginLines(a,null,e)},e.prototype.createBufferWriter=function(){return new C(this.vertexBufferLayout)},e.prototype.createRenderer=function(t,e){return new m(t,e,this,f.pathVertexAttributeLocations)},e.prototype.getGLMaterials=function(){return{color:S,depth:A,depthShadowMap:this.params.castShadows?x:null,normal:V,highlight:E}},e.getVertexBufferLayout=function(t){var e=s.newLayout().vec3f(f.PathVertexAttrConstants.POSITION).vec4f(f.PathVertexAttrConstants.PROFILERIGHT).vec4f(f.PathVertexAttrConstants.PROFILEUP).vec4f(f.PathVertexAttrConstants.PROFILEVERTEXANDNORMAL);return(t.vvColorEnabled||t.vvSizeEnabled||t.vvOpacityEnabled)&&(e=e.vec4f(f.PathVertexAttrConstants.FEATUREVALUE)),e},e}(p.Material),P=function(t){function e(e){var r=t.call(this,e)||this;return r.output=e.output,r.updateParameters(),r}return i(e,t),e.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(f.PathTechnique,this.material.getTechniqueConfig(this.output),this.technique)},e.prototype.beginSlot=function(t){return t===(this.technique.configuration.transparent?6:4)},e.prototype.getProgram=function(){return this.technique.program},e.prototype.getPrograms=function(){return null},e.prototype._updateShadowState=function(t){t.shadowMappingEnabled!==this.technique.configuration.receiveShadows&&(this.material.setParameterValues({receiveShadows:t.shadowMappingEnabled}),this.updateParameters())},e.prototype.bind=function(t,e){0===this.output&&this._updateShadowState(e),t.bindProgram(this.technique.program),this.technique.bindPipelineState(t),this.technique.bindPass(t,this.material.getPassParameters(),e)},e.prototype.release=function(){},e.prototype.bindView=function(t){this.technique.bindDraw(t)},e.prototype.bindInstance=function(t){this.technique.bindInstance(t)},e.prototype.getDrawMode=function(){return 4},e}(h.GLMaterial),S=function(t){function e(e){return t.call(this,r({},e,{output:0}))||this}return i(e,t),e}(P),A=function(t){function e(e){return t.call(this,r({},e,{output:1}))||this}return i(e,t),e}(P),x=function(t){function e(e){return t.call(this,r({},e,{output:3}))||this}return i(e,t),e}(P),V=function(t){function e(e){return t.call(this,r({},e,{output:2}))||this}return i(e,t),e}(P),E=function(t){function e(e){return t.call(this,r({},e,{output:4}))||this}return i(e,t),e}(P),q=r({size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1},l.Default),C=function(){function t(t){this.vertexBufferLayout=t}return t.prototype.allocate=function(t){return this.vertexBufferLayout.createBuffer(t)},t.prototype.elementCount=function(t){return t.indices[f.PathVertexAttrConstants.POSITION].length},t.prototype.write=function(t,e,r,i){var n=function(t){if(t in e.vertexAttr){var n=e.vertexAttr[t],a=e.indices[t];g(4===n.size);var s=r.getField(t,o.BufferViewVec4f);if(!s)throw new Error("unable to acquire view for "+t);d.writeBufferVec4(a,n.data,s,i)}};n(f.PathVertexAttrConstants.PROFILERIGHT),n(f.PathVertexAttrConstants.PROFILEUP),n(f.PathVertexAttrConstants.PROFILEVERTEXANDNORMAL),this.vertexBufferLayout.hasField(f.PathVertexAttrConstants.FEATUREVALUE)&&n(f.PathVertexAttrConstants.FEATUREVALUE),d.writeDefaultAttributes(e,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,i)},t}();return y});