// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/assignHelper","../../../../core/Logger","../../../../core/mathUtils","../../../../core/maybe","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/vec2","../../../../core/libs/gl-matrix-2/vec3","../../../../core/libs/gl-matrix-2/vec3f64","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/geometryDataUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./VisualVariableMaterialParameters","./internal/MaterialUtil","./renderers/MergedRenderer","../shaders/RibbonLineTechnique","../shaders/RibbonLineTechnique"],function(t,e,i,n,r,a,s,o,c,p,u,l,h,v,b,f,d,m,g,C,A,S,y){function R(t,e,i,n,r){for(var a=0;a<r;a++)i[n++]=t[e++];return n}var x=r.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial"),P=function(t){function e(e,i){var n=t.call(this,i)||this;return n.techniqueConfig=new y.RibbonLineTechniqueConfiguration,n.params=C.copyParameters(e,V),n.validateParams(),n.params.transparent=n.params.color[3]<1||n.params.transparent,n.layout=n.createLayout(),n}return i(e,t),e.prototype.dispose=function(){},e.prototype.setParameterValues=function(t){for(var e in t)if("cap"!==e){if("join"===e){var i="round"===this.params[e],n="round"===t[e];if(i!==n){x.error("join cannot be changed after creation");continue}}if("stipplePattern"===e){var r=!!this.params[e],a=!!t[e];if(r!==a){x.error("stippledness cannot be changed after creation");continue}}this.params[e]=t[e]}else x.error("cap cannot be changed after creation");this.validateParams(),this.notifyDirty("matChanged")},e.prototype.getParameters=function(){return this.params},e.prototype.getPassParameters=function(){return this.params},e.prototype.getTechniqueConfig=function(t){this.techniqueConfig.output=t;var e=s.isSome(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=e,this.techniqueConfig.stippleIntegerRepeatsEnabled=e&&this.params.stippleIntegerRepeats,this.techniqueConfig.stippleOffColorEnabled=e&&s.isSome(this.params.stippleOffColor),this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.roundJoins="round"===this.params.join,this.techniqueConfig.roundCaps="round"===this.params.cap,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.polygonOffset=this.params.polygonOffset,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.vvColor=this.params.vvColorEnabled,this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled,this.techniqueConfig.vvSize=this.params.vvSizeEnabled,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig},e.prototype.intersect=function(t,e,i,n,r,a,s,o,c){c?C.intersectDrapedRenderLineGeometry(t,n,a,this.params.width,s):this.intersectLineGeometry(t,e,i,n,this.params.width,s)},e.prototype.intersectLineGeometry=function(t,e,i,n,r,s){if(n.options.selectionMode&&!v.isAllHidden(e.componentVisibilities,t.componentOffsets)){if(!m.isTranslationMatrix(i))return void x.error("intersection assumes a translation-only matrix");var o=t.data,u=o.getVertexAttr(),h=u[y.RibbonVertexAttributeConstants.POSITION].data,b=r;if(this.params.vvSizeEnabled){var f=u[y.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0];b*=a.clamp(this.params.vvSizeOffset[0]+f*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])}else u[y.RibbonVertexAttributeConstants.SIZE]&&(b*=u[y.RibbonVertexAttributeConstants.SIZE].data[0]);var d=n.camera,g=B;c.vec2.copy(g,n.point);var C=b*d.pixelRatio,A=4*d.pixelRatio,S=C/2+A;p.vec3.set(H[0],g[0]-S,g[1]+S,0),p.vec3.set(H[1],g[0]+S,g[1]+S,0),p.vec3.set(H[2],g[0]+S,g[1]-S,0),p.vec3.set(H[3],g[0]-S,g[1]-S,0);for(var R=0;R<4;R++)d.unprojectPoint(H[R],Y[R]);l.plane.fromPoints(d.eye,Y[0],Y[1],_),l.plane.fromPoints(d.eye,Y[1],Y[2],W),l.plane.fromPoints(d.eye,Y[2],Y[3],K),l.plane.fromPoints(d.eye,Y[3],Y[0],Q);for(var P=Number.MAX_VALUE,E=this.params.isClosed?h.length-2:h.length-5,R=0;R<E;R+=3){U[0]=h[R]+i[12],U[1]=h[R+1]+i[13],U[2]=h[R+2]+i[14];var I=(R+3)%h.length;if(w[0]=h[I]+i[12],w[1]=h[I+1]+i[13],w[2]=h[I+2]+i[14],!(l.plane.signedDistance(_,U)<0&&l.plane.signedDistance(_,w)<0||l.plane.signedDistance(W,U)<0&&l.plane.signedDistance(W,w)<0||l.plane.signedDistance(K,U)<0&&l.plane.signedDistance(K,w)<0||l.plane.signedDistance(Q,U)<0&&l.plane.signedDistance(Q,w)<0)){if(d.projectPoint(U,N),d.projectPoint(w,z),N[2]<0&&z[2]>0){p.vec3.subtract(D,U,w);var O=d.frustum,V=-l.plane.signedDistance(O.planes[4],U),T=V/p.vec3.dot(D,O.planes[4]);p.vec3.scale(D,D,T),p.vec3.add(U,U,D),d.projectPoint(U,N)}else if(N[2]>0&&z[2]<0){p.vec3.subtract(D,w,U);var O=d.frustum,V=-l.plane.signedDistance(O.planes[4],w),T=V/p.vec3.dot(D,O.planes[4]);p.vec3.scale(D,D,T),p.vec3.add(w,w,D),d.projectPoint(w,z)}else if(N[2]<0&&z[2]<0)continue;N[2]=0,z[2]=0;var q=l.lineSegment.distance2(l.lineSegment.fromPoints(N,z,Z),g);q<P&&(P=q,p.vec3.copy(j,U),p.vec3.copy(F,w))}}var L=n.rayBeginPoint,J=n.rayEndPoint;if(P<S*S){var X=Number.MAX_VALUE;if(l.lineSegment.closestLineSegmentPoint(l.lineSegment.fromPoints(j,F,Z),l.lineSegment.fromPoints(L,J,G),M)){p.vec3.subtract(M,M,L);var k=p.vec3.length(M);p.vec3.scale(M,M,1/k),X=k/p.vec3.distance(L,J)}s(X,M)}}},e.prototype.computeAttachmentOrigin=function(t,e){var i=t.data,n="getVertexAttr"in i?i.getVertexAttr():"vertexAttr"in i?i.vertexAttr:null;if(!n)return null;var r=y.RibbonVertexAttributeConstants.POSITION,a=n[r];return b.computeAttachmentOriginLines(a,null,e)},e.prototype.createLayout=function(){var t=h.newLayout().vec3f(y.RibbonVertexAttributeConstants.POSITION).f32(y.RibbonVertexAttributeConstants.SUBDIVISIONFACTOR).vec2f(y.RibbonVertexAttributeConstants.UV0).vec3f(y.RibbonVertexAttributeConstants.AUXPOS1).vec3f(y.RibbonVertexAttributeConstants.AUXPOS2);return this.params.vvSizeEnabled?t.f32(y.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE):t.f32(y.RibbonVertexAttributeConstants.SIZE),this.params.vvColorEnabled?t.f32(y.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE):t.vec4f(y.RibbonVertexAttributeConstants.COLOR),this.params.vvOpacityEnabled&&t.f32(y.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE),t},e.prototype.createBufferWriter=function(){return new T(this.layout,this.params)},e.prototype.createRenderer=function(t,e){return new A(t,e,this,y.ribbonVertexAttributeLocations)},e.prototype.getGLMaterials=function(){return{color:I,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:O}},e.prototype.validateParams=function(){this.params.width&&this.params.width>1&&(this.params.width=Math.round(this.params.width)),"miter"!==this.params.join&&(this.params.miterLimit=0)},e}(d.Material),E=function(t){function e(e){var i=t.call(this,e)||this;return i.output=e.output,i.updateParameters(),i}return i(e,t),e.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(S.RibbonLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)},e.prototype.beginSlot=function(t){if(0===this.output){return t===(this.technique.configuration.writeDepth?6:9)}return 4===t},e.prototype.getProgram=function(){return this.technique.program},e.prototype.getPrograms=function(){return null},e.prototype.bind=function(t,e){t.bindProgram(this.technique.program),this.technique.bindPipelineState(t),this.technique.bindPass(t,this.material.getPassParameters(),e)},e.prototype.release=function(){},e.prototype.bindView=function(t){this.technique.bindDraw(t)},e.prototype.bindInstance=function(t){this.technique.bindInstance(t)},e.prototype.getDrawMode=function(){return 5},e}(f.GLMaterial),I=function(t){function e(e){return t.call(this,n({},e,{output:0}))||this}return i(e,t),e}(E),O=function(t){function e(e){return t.call(this,n({},e,{output:4}))||this}return i(e,t),e}(E),V=n({width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1},g.Default),T=function(){function t(t,e){if(this.params=e,this.numCapSubdivisions=0,this.numJoinSubdivisions=0,this.vertexBufferLayout=t,!e.isClosed)switch(this.params.cap){case"butt":this.numCapSubdivisions=0;break;case"square":this.numCapSubdivisions=1;break;case"round":this.numCapSubdivisions=q}switch(this.params.join){case"miter":case"bevel":this.numJoinSubdivisions=e.stipplePattern?1:0;break;case"round":this.numJoinSubdivisions=L}}return t.prototype.allocate=function(t){return this.vertexBufferLayout.createBuffer(t)},t.prototype.elementCount=function(t){var e=2*this.numCapSubdivisions+2,i=t.indices[y.RibbonVertexAttributeConstants.POSITION].length/2+1,n=this.params.isClosed,r=n?2:2*e,a=n?0:1,s=n?i:i-1;if(t.vertexAttr[y.RibbonVertexAttributeConstants.SUBDIVISIONS])for(var o=t.vertexAttr[y.RibbonVertexAttributeConstants.SUBDIVISIONS].data,c=a;c<s;++c){var p=o[c];r+=4+2*p}else{r+=s*(2*this.numJoinSubdivisions+4)}return r+=2},t.prototype.write=function(t,e,i,n){var r=this,a=J,s=X,o=k,c=e.vertexAttr[y.RibbonVertexAttributeConstants.POSITION].data,u=e.indices&&e.indices[y.RibbonVertexAttributeConstants.POSITION];u&&u.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var l=null;e.vertexAttr[y.RibbonVertexAttributeConstants.SUBDIVISIONS]&&(l=e.vertexAttr[y.RibbonVertexAttributeConstants.SUBDIVISIONS].data);var h=1,v=0;this.params.vvSizeEnabled?v=e.vertexAttr[y.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]:e.vertexAttr[y.RibbonVertexAttributeConstants.SIZE]&&(h=e.vertexAttr[y.RibbonVertexAttributeConstants.SIZE].data[0]);var b=[1,1,1,1],f=0;this.params.vvColorEnabled?f=e.vertexAttr[y.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE].data[0]:e.vertexAttr[y.RibbonVertexAttributeConstants.COLOR]&&(b=e.vertexAttr[y.RibbonVertexAttributeConstants.COLOR].data);var d=0;this.params.vvOpacityEnabled&&(d=e.vertexAttr[y.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE].data[0]);var m=c.length/3,g=t.transformation,C=new Float32Array(i.buffer),A=this.vertexBufferLayout.stride/4,S=n*A,x=S,P=function(t,e,i,n,a,s){C[S++]=e[0],C[S++]=e[1],C[S++]=e[2],C[S++]=n,C[S++]=a,C[S++]=s,C[S++]=t[0],C[S++]=t[1],C[S++]=t[2],C[S++]=i[0],C[S++]=i[1],C[S++]=i[2],r.params.vvSizeEnabled?C[S++]=v:C[S++]=h,r.params.vvColorEnabled?C[S++]=f:(C[S++]=b[0],C[S++]=b[1],C[S++]=b[2],C[S++]=b[3]),r.params.vvOpacityEnabled&&(C[S++]=d)};S+=A,p.vec3.set(s,c[0],c[1],c[2]),g&&p.vec3.transformMat4(s,s,g);var E=this.params.isClosed;if(E){var I=c.length-3;p.vec3.set(a,c[I],c[I+1],c[I+2]),g&&p.vec3.transformMat4(a,a,g)}else{p.vec3.copy(a,s),p.vec3.set(o,c[3],c[4],c[5]),g&&p.vec3.transformMat4(o,o,g);for(var O=0;O<this.numCapSubdivisions;++O){var V=1-O/this.numCapSubdivisions;P(a,s,o,V,1,-4),P(a,s,o,V,1,4)}P(a,s,o,0,0,-4),P(a,s,o,0,0,4),p.vec3.copy(a,s),p.vec3.copy(s,o)}for(var T=E?0:1,q=E?m:m-1,O=T;O<q;O++){var L=(O+1)%m*3;p.vec3.set(o,c[L+0],c[L+1],c[L+2]),g&&p.vec3.transformMat4(o,o,g),P(a,s,o,0,1,-1),P(a,s,o,0,1,1);for(var U=l?l[O]:this.numJoinSubdivisions,w=0;w<U;++w){var V=(w+1)/(U+1);P(a,s,o,V,1,-2),P(a,s,o,V,1,2)}P(a,s,o,1,0,-2),P(a,s,o,1,0,2),p.vec3.copy(a,s),p.vec3.copy(s,o)}if(E){S=R(C,x+A,C,S,2*A)}else{P(a,s,o,0,1,-5),P(a,s,o,0,1,5);for(var O=0;O<this.numCapSubdivisions;++O){var V=(O+1)/this.numCapSubdivisions;P(a,s,o,V,1,-5),P(a,s,o,V,1,5)}}R(C,x+A,C,x,A),S=R(C,S-A,C,S,A)},t}(),q=3,L=1,U=u.vec3f64.create(),w=u.vec3f64.create(),D=u.vec3f64.create(),M=u.vec3f64.create(),B=u.vec3f64.create(),N=o.createRenderScreenPointArray3(),z=o.createRenderScreenPointArray3(),j=u.vec3f64.create(),F=u.vec3f64.create(),Z=l.lineSegment.create(),G=l.lineSegment.create(),J=u.vec3f64.create(),X=u.vec3f64.create(),k=u.vec3f64.create(),H=[o.createRenderScreenPointArray3(),o.createRenderScreenPointArray3(),o.createRenderScreenPointArray3(),o.createRenderScreenPointArray3()],Y=[u.vec3f64.create(),u.vec3f64.create(),u.vec3f64.create(),u.vec3f64.create()],_=l.plane.create(),W=l.plane.create(),K=l.plane.create(),Q=l.plane.create();return P});