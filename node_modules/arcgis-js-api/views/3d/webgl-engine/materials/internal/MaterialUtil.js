// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/mathUtils","../../../../../core/maybe","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f32","../../../../../core/libs/gl-matrix-2/mat4f64","../../../../../core/libs/gl-matrix-2/vec3","../../../../../core/libs/gl-matrix-2/vec3f64","../../../../../core/libs/gl-matrix-2/vec4","../../../../../geometry/support/aaBoundingBox","../../lib/ComponentUtils","../../lib/doublePrecisionUtils","../../lib/screenSizePerspectiveUtils","../../lib/Util"],function(e,t,r,i,n,a,o,c,s,f,l,u,v,m,d,g){function p(e,t,r,i,n,a,o){var c=t&&t.componentVisibilities,s=r.tolerance;if(e.componentCount>1)b(e,c,i,n,s,a,o);else if(!c||v.getVisibility(c,0))if(e.boundingInfo)g.assert("triangle"===e.data.primitiveType),h(e.boundingInfo,i,n,s,a,o);else{var f=e.getIndices(X.POSITION),l=e.getAttribute(X.POSITION),u=f.length/3;x(i,n,0,u,f,l,void 0,a,o)}}function h(e,t,r,i,a,o){var c=B(t,r,Z);if(u.setMin(k,e.getBBMin()),u.setMax(k,e.getBBMax()),n.isSome(a)&&a.applyToAABB(k),S(k,t,c,i)){var s=e.getPrimitiveIndices(),f=e.getIndices(),l=e.getPosition(),v=s?s.length:f.length/3;if(v>ne){var m=e.getChildren();if(void 0!==m){for(var d=0;d<8;++d)void 0!==m[d]&&h(m[d],t,r,i,a,o);return}}x(t,r,0,v,f,l,s,a,o)}}function b(e,t,r,i,a,o,c){var s=B(r,i,Z),f=e.componentCount,l=e.componentOffsets,m=e.getIndices(X.POSITION),d=e.getAttribute(X.POSITION),g=e.boundingInfo;if(!g||(u.setMin(k,g.getBBMin()),u.setMax(k,g.getBBMax()),n.isSome(o)&&o.applyToAABB(k),S(k,r,s,a)))for(var p=0;p<f;p++)if(!t||v.getVisibility(t,p)){if(e.getComponentAABB){var h=e.getComponentAABB(p,k);if(n.isSome(o)&&o.applyToAABB(h),!S(h,r,s,a))continue}var b=l[p]/3,M=l[p+1]/3;x(r,i,b,M,m,d,void 0,o,c)}}function x(e,t,r,i,a,o,c,s,f){var l,u,v;if(c)return M(e,t,r,i,a,o,c,s,f);for(var m=o.data,d=o.offsetIdx,g=o.strideIdx,p=e[0],h=e[1],b=e[2],x=t[0],B=t[1],S=t[2],A=x-p,I=B-h,T=S-b,y=r,O=3*r;y<i;++y){var U=d+g*a[O++],L=m[U++],V=m[U++],w=m[U];U=d+g*a[O++];var D=m[U++],W=m[U++],R=m[U];U=d+g*a[O++];var E=m[U++],N=m[U++],C=m[U];n.isSome(s)&&(l=s.applyToVertex(L,V,w),L=l[0],V=l[1],w=l[2],u=s.applyToVertex(D,W,R),D=u[0],W=u[1],R=u[2],v=s.applyToVertex(E,N,C),E=v[0],N=v[1],C=v[2]);var z=D-L,F=W-V,H=R-w,q=E-L,_=N-V,j=C-w,G=I*j-_*T,Y=T*q-j*A,k=A*_-q*I,X=z*G+F*Y+H*k;if(!(Math.abs(X)<=J)){var Z=p-L,Q=h-V,$=b-w,ee=Z*G+Q*Y+$*k;if(X>0){if(ee<0||ee>X)continue}else if(ee>0||ee<X)continue;var te=Q*H-F*$,re=$*z-H*Z,ie=Z*F-z*Q,ne=A*te+I*re+T*ie;if(X>0){if(ne<0||ee+ne>X)continue}else if(ne>0||ee+ne<X)continue;var ae=(q*te+_*re+j*ie)/X;if(ae>=0){f(ae,P(z,F,H,q,_,j,K),y)}}}}function M(e,t,r,i,a,o,c,s,f){for(var l,u,v,m=o.data,d=o.offsetIdx,g=o.strideIdx,p=e[0],h=e[1],b=e[2],x=t[0],M=t[1],B=t[2],S=x-p,A=M-h,I=B-b,T=r;T<i;++T){var y=c[T],O=3*y,U=d+g*a[O++],L=m[U++],V=m[U++],w=m[U];U=d+g*a[O++];var D=m[U++],W=m[U++],R=m[U];U=d+g*a[O];var E=m[U++],N=m[U++],C=m[U];n.isSome(s)&&(l=s.applyToVertex(L,V,w),L=l[0],V=l[1],w=l[2],u=s.applyToVertex(D,W,R),D=u[0],W=u[1],R=u[2],v=s.applyToVertex(E,N,C),E=v[0],N=v[1],C=v[2]);var z=D-L,F=W-V,H=R-w,q=E-L,_=N-V,j=C-w,G=A*j-_*I,Y=I*q-j*S,k=S*_-q*A,X=z*G+F*Y+H*k;if(!(Math.abs(X)<=J)){var Z=p-L,Q=h-V,$=b-w,ee=Z*G+Q*Y+$*k;if(X>0){if(ee<0||ee>X)continue}else if(ee>0||ee<X)continue;var te=Q*H-F*$,re=$*z-H*Z,ie=Z*F-z*Q,ne=S*te+A*re+I*ie;if(X>0){if(ne<0||ee+ne>X)continue}else if(ne>0||ee+ne<X)continue;var ae=(q*te+_*re+j*ie)/X;if(ae>=0){f(ae,P(z,F,H,q,_,j,K),y)}}}}function P(e,t,r,i,n,a,o){return s.vec3.set(Q,e,t,r),s.vec3.set($,i,n,a),s.vec3.cross(o,Q,$),s.vec3.normalize(o,o),o}function B(e,t,r){return s.vec3.set(r,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function S(e,t,r,i){return A(e,t,r,i,1/0)}function A(e,t,r,i,n){var a=(e[0]-i-t[0])*r[0],o=(e[3]+i-t[0])*r[0],c=Math.min(a,o),s=Math.max(a,o),f=(e[1]-i-t[1])*r[1],l=(e[4]+i-t[1])*r[1];if((s=Math.min(s,Math.max(f,l)))<0)return!1;if((c=Math.max(c,Math.min(f,l)))>s)return!1;var u=(e[2]-i-t[2])*r[2],v=(e[5]+i-t[2])*r[2];return!((s=Math.min(s,Math.max(u,v)))<0)&&(!((c=Math.max(c,Math.min(u,v)))>s)&&c<n)}function I(e,t,r){return l.vec4.set(r,e[0]-t[0],e[1]-t[1],e[2]-t[2],1)}function T(e,t,r,i){return a.mat4.translate(Y,r,t),r=Y,l.vec4.transformMat4(i,e,r)}function y(e,t,r,i){return i[0]=e[0]+r[0],i[1]=e[1]+r[1],i[2]=e[2]+r[2],i[3]=e[3],l.vec4.transformMat4(i,i,t)}function O(e,t){return l.vec4.scale(t,e,1/Math.abs(e[3]))}function U(e,t,r,i){return d.scale(e,r,t,i)}function L(e,t,r,n,a){var o=(r.screenLength||0)*e.pixelRatio;a&&(o=U(o,t,n,a));var c=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return i.clamp(c*t,r.minWorldLength||0,null!=r.maxWorldLength?r.maxWorldLength:1/0)}function V(e,t,r){if(void 0!==e)return t.acquire(e,r)}function w(e,t){void 0!==e&&t.release(e)}function D(e,t,r){a.mat4.translate(ee,t,e),r.setUniform3fv("localOrigin",e),r.setUniformMatrix4fv("view",ee)}function W(e,t,r){r.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])}function R(e,t){m.encodeDoubleArraySplit(e,te,re,3),t.setUniform3fv("viewOriginHi",te),t.setUniform3fv("viewOriginLo",re)}function E(e,t,r){s.vec3.subtract(ie,t.origin,e),r.setUniform3fv("slicePlaneOrigin",ie),r.setUniform3fv("slicePlaneBasis1",t.basis1),r.setUniform3fv("slicePlaneBasis2",t.basis2)}function N(e,t,r){if(e){var i=z(e,t.fovY,t.viewport[3]),n=t.pixelRatio||1;r.setUniform4f("verticalOffset",i.screenLength*n,i.perDistance,i.minWorldLength,i.maxWorldLength)}}function C(e,t,r){e.bindTexture(t.highlightDepthTexture,5),r.setUniform1i("depthTex",5),r.setUniform4f("highlightViewportPixelSz",0,0,1/t.viewport[2],1/t.viewport[3])}function z(e,t,r,i){return void 0===i&&(i=ae),i.screenLength=e.screenLength,i.perDistance=Math.tan(.5*t)/(.5*r),i.minWorldLength=e.minWorldLength,i.maxWorldLength=e.maxWorldLength,i}function F(e,t,r){if(void 0===r&&(r="screenSizePerspectiveAlignment"),e){var i=e.parameters,n=e.paddingPixelsOverride;t.setUniform4f(r,i.divisor,i.offset,i.minPixelSize,n)}}function H(e,t){var r=t?H(t):{};for(var i in e){var n=e[i];n&&n.forEach&&(n=j(n)),null==n&&i in r||(r[i]=n)}return r}function q(e,t){var r=!1;for(var i in t){var n=t[i];void 0!==n&&(r=!0,Array.isArray(n)?e[i]=n.slice():e[i]=n)}return r}function _(e,t,r,n,a){if(t.options.selectionMode){for(var o=e.getAttribute(X.POSITION).data,c=e.getAttribute(X.SIZE),s=c&&c.data[0],f=r[0],l=r[1],u=s+n,v=(u/2+4)*e.pixelRatio,m=Number.MAX_VALUE,d=0;d<o.length-5;d+=3){var g=o[d],p=o[d+1],h=o[d+3],b=o[d+4],x=f-g,M=l-p,P=h-g,B=b-p,S=P*x+B*M,A=P*P+B*B,I=i.clamp(S/A,0,1),T=P*I-x,y=B*I-M,O=T*T+y*y;O<m&&(m=O)}m<v*v&&a()}}function j(e){var t=[];return e.forEach(function(e){return t.push(e)}),t}function G(e,i){return r({usePBR:e},i?t.defaultPBRTreeMaterialParameters:t.defaultPBRMaterialParameters)}Object.defineProperty(t,"__esModule",{value:!0});var Y=c.mat4f64.create(),k=u.create(),X=g.VertexAttrConstants;t.intersectTriangleGeometry=p;var Z=f.vec3f64.create(),J=Math.pow(2,-52),K=f.vec3f64.create();t.intersectTriangles=x;var Q=f.vec3f64.create(),$=f.vec3f64.create();t.computeNormal=P,t.computeInvDir=B,t.intersectAabbInvDir=S,t.intersectAabbInvDirBefore=A,t.transformToWorld=I,t.transformToView=T,t.transformToProjection=y,t.transformToNDC=O,t.applyScreenSizePerspectiveScale=U,t.verticalOffsetAtDistance=L,t.acquireIfNotUndefined=V,t.releaseIfNotUndefined=w;var ee=o.mat4f32.create();t.bindView=D,t.bindCamPos=W;var te=f.vec3f64.create(),re=f.vec3f64.create();t.bindViewOriginDouble=R;var ie=f.vec3f64.create();t.bindSlicePlane=E,t.bindVerticalOffset=N,t.bindHighlightRendering=C,t.bindScreenSizePerspective=F,t.copyParameters=H,t.updateParameters=q;!function(e){function t(e,t){for(var r=[],i=0;i<2;i++)for(var a=0;a<2;a++){var o=n({shadowMappingEnabled:1===i,ssaoEnabled:1===a}),c=n({shadowMappingEnabled:1===i,ssaoEnabled:1===a&&e.receiveSSAO});r[o]=r[c]||t({receiveShadows:1===i,receiveSSAO:1===a&&e.receiveSSAO})}return{programs:r.filter(function(e){return null!=e}),byParameter:r}}function r(e,t){return e.byParameter[n(t)]}function i(e){return e.programs}function n(e){return(e.shadowMappingEnabled?1:0)|(e.ssaoEnabled?2:0)}e.create=t,e.lookup=r,e.programs=i}(t.BindParametersMap||(t.BindParametersMap={})),t.intersectDrapedRenderLineGeometry=_,t.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ne=1e3,ae={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0};t.defaultPBRMaterialParameters={roughnessFactor:.6,metallicFactor:0,reflectanceFactor:.2},t.defaultPBRTreeMaterialParameters={roughnessFactor:1,metallicFactor:0,reflectanceFactor:.2},t.getDefaultPBRMaterialParameters=G});