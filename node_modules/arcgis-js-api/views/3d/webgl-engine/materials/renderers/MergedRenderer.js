// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../../../core/libs/gl-matrix-2/mat4","../../../../../core/libs/gl-matrix-2/mat4f64","../../../support/buffer/glUtil","../../lib/DefaultVertexAttributeLocations","../../lib/IntervalUtilities","../../lib/ResizableFloat32Array","../../lib/Util","../WaterGLMaterial","./Instance","./utils","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(e,t,r,a,n,i,o,s,u,d,l,f,g,h,p){function m(e,t,r,a){for(var n=new Map,i=t.vertexBufferLayout.stride/4,o=function(r,a){var o=r.origin,s=e.get(o.id),u=n.get(o.id);null==u&&(u={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.size,toAdd:[],toRemove:[],origin:o.vec3},n.set(o.id,u));var d=t.elementCount(r.data)*i;a?(u.optimalCount+=d,u.sparseCount+=d,u.toAdd.push(r)):(u.optimalCount-=d,u.toRemove.push(r))},s=0,u=r;s<u.length;s++){var d=u[s];o(d,!0)}for(var l=0,f=a;l<f.length;l++){var d=f[l];o(d,!1)}return n}var c=function(){function e(e,t,r,a){void 0===a&&(a=i.Default3D),this.type="MergedRenderer",this._dataByOrigin=new Map,this._highlightCount=0,this._rctx=e,this._vertexAttributeLocations=a,this._material=r,this._materialRep=t,this._glMaterials=f.acquireMaterials(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}return e.prototype.dispose=function(){f.releaseMaterials(this._material,this._materialRep)},Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlightCount>0},enumerable:!0,configurable:!0}),e.prototype.hasWater=function(){var e=!1;return this._glMaterials.forEach(function(t){e=e||t instanceof d.WaterGLMaterial}),e},e.prototype.renderPriority=function(){return this._material.renderPriority},e.prototype.modify=function(e){var t=this,r=R;r.clear(),this.updateGeometries(e.toUpdate,r),this.addAndRemoveGeometries(e.toAdd,e.toRemove,r),this.updateHighlightCount(),r.forEach(function(e){return t.updateDisplayedIndexRanges(e)})},e.prototype.addAndRemoveGeometries=function(e,t,r){var a=this,n=this._bufferWriter,i=n.vertexBufferLayout,o=i.stride/4,s=this._dataByOrigin,d=m(s,n,e,t);d.forEach(function(e,t){d.delete(t);var n=e.optimalCount,l=e.sparseCount,f=s.get(t);if(null==f&&(u.assert(n>0),f=a.createData(i,n,e.origin),s.set(t,f)),0===n)return f.vao.dispose(!0),f.vao=null,void s.delete(t);var g=n<e.sparseCount/2,h=g?n:l,p=y,m=f.buffer.size,c=f.buffer.array,b=f.buffer.resize(h,!1);g||b?a.removeAndRebuild(f,e.toRemove,o,c,p):e.toRemove.length>0?(a.removeByErasing(f,e.toRemove,o,p),e.toAdd.length>0&&(p.end=m)):(p.begin=m,p.end=m);var x=v;u.setMatrixTranslation3(x,-e.origin[0],-e.origin[1],-e.origin[2]),a.append(f,e.toAdd,o,x,p);var R=f.vao.vertexBuffers.geometry;if(R.byteSize!==f.buffer.array.buffer.byteLength)R.setData(f.buffer.array);else{var _=p.begin,C=p.end;if(_<C){var I=f.buffer.array,A=4*_,w=4*C;R.setSubData(I,A,A,w)}}(p.updatedDisplayedIndexRange||f.displayedIndexRanges)&&r.add(f)})},e.prototype.updateGeometries=function(e,t){for(var r=this._bufferWriter,a=r.vertexBufferLayout.stride/4,n=0,i=e;n<i.length;n++){var o=i[n],s=o.updateType,d=o.renderGeometry,l=this._dataByOrigin.get(d.origin.id),g=l&&l.instances.get(d.uniqueName);if(!g)return;if(1&s&&(g.displayedIndexRange=f.generateRenderGeometryVisibleIndexRanges(d),t.add(l)),17&s&&(g.highlightedIndexRanges=f.generateRenderGeometryHighlightRanges(d),l.highlightCount=null),6&s){var h=l.buffer.array,p=l.vao;f.calculateTransformRelToOrigin(d,b,x),r.write({transformation:b,invTranspTransformation:x},d.data,r.vertexBufferLayout.createView(h.buffer),g.from),u.assert(g.from+r.elementCount(d.data)===g.to,"material VBO layout has changed"),p.vertexBuffers.geometry.setSubData(h,g.from*a*4,g.from*a*4,g.to*a*4)}}},e.prototype.updateDisplayedIndexRanges=function(e){e.displayedIndexRanges=[];var t=!0;e.instances.forEach(function(r){r.displayedIndexRange?(e.displayedIndexRanges.push.apply(e.displayedIndexRanges,o.offsetIntervals(r.displayedIndexRange,r.from)),t=!1):e.displayedIndexRanges.push([r.from,r.to-1])}),e.displayedIndexRanges=t?null:o.mergeIntervals(e.displayedIndexRanges)},e.prototype.updateHighlightCount=function(){var e=this;this._highlightCount=0,this._dataByOrigin.forEach(function(t){if(null==t.highlightCount){var r=0;t.instances.forEach(function(e){e.highlightedIndexRanges&&++r}),t.highlightCount=r}e._highlightCount+=t.highlightCount})},e.prototype.updateLogic=function(e){return this._material.update(e)},e.prototype.render=function(e,t,r,n){var i=this,o=this._rctx,s=this._glMaterials.get(t.pass),u=4===t.pass,d=e;if(2===t.pass&&null===d&&(d=19),!s||1===s.ensureResources(o)||null!=d&&!s.beginSlot(d)||u&&0===this._highlightCount)return!1;s.bind(o,r);var l=s.getProgram();l.setUniformMatrix4fv("model",a.mat4f64.IDENTITY),l.hasUniform("modelNormal")&&l.setUniformMatrix4fv("modelNormal",a.mat4f64.IDENTITY);var f=!1;return this._dataByOrigin.forEach(function(e){u&&0===e.highlightCount||(r.origin=e.origin,s.bindView(r),f=u?i.renderHighlightPass(s,e,n)||f:i.renderDefaultPass(s,e,n)||f)}),s.release(),f},e.prototype.renderDefaultPass=function(e,t,r){var a=this._rctx,n=e.getDrawMode(),i=t.displayedIndexRanges;if(i&&0===i.length)return!1;if(e.ensureAttributeLocations(t.vao),a.bindVAO(t.vao),i)f.drawArraysFaceRange(a,i,0,n,r);else{var o=4*t.buffer.size/h.getStride(t.vao.layout.geometry);f.drawArrays(a,n,0,o,r)}return!0},e.prototype.renderHighlightPass=function(e,t,r){var a=this._rctx,n=e.getDrawMode(),i=t.vao;e.ensureAttributeLocations(i),a.bindVAO(i);var o=!1;return t.instances.forEach(function(e){var t=e.highlightedIndexRanges;if(t&&0!==t.length)for(var i=0;i<t.length;i++){var s=t[i],u=s.range?s.range[0]+e.from:e.from,d=s.range?s.range[1]-s.range[0]+1:e.to-e.from;f.drawArrays(a,n,u,d,r),o=!0}}),o},e.prototype.createData=function(e,t,r){return{instances:new Map,vao:new p(this._rctx,this._vertexAttributeLocations,{geometry:n.glLayout(e)},{geometry:g.createVertex(this._rctx,35044)}),buffer:new s.ResizableFloat32Array(t),optimalCount:0,origin:r,highlightCount:0}},e.prototype.removeAndRebuild=function(e,t,r,a,n){for(var i=0,o=t;i<o.length;i++){var s=o[i],u=s.uniqueName,d=e.instances.get(u);e.optimalCount-=(d.to-d.from)*r,e.instances.delete(u)}var l=0,f=e.buffer.array;n.begin=0,n.end=0;var g=-1,h=-1,p=0;e.instances.forEach(function(e){var t=e.from*r,n=e.to*r,i=n-t;g!==h&&h!==t?(f.set(a.subarray(g,h),p),p+=h-g,g=t):-1===g&&(g=t),h=n,e.from=l/r,l+=i,e.to=l/r}),g!==h&&f.set(a.subarray(g,h),p),n.end=l},e.prototype.removeByErasing=function(e,t,r,a){a.begin=1/0,a.end=-1/0;for(var n=-1,i=-1,o=0,s=t;o<s.length;o++){var u=s[o],d=u.uniqueName,l=e.instances.get(d),f=l.from*r,g=l.to*r;n!==i&&i!==f?(e.buffer.erase(n,i),n=f):-1===n&&(n=f),i=g,e.instances.delete(d),e.optimalCount-=g-f,f<a.begin&&(a.begin=f),g>a.end&&(a.end=g)}n!==i&&e.buffer.erase(n,i)},e.prototype.append=function(e,t,a,n,i){i.updatedDisplayedIndexRange=!1;for(var o=this._bufferWriter,s=0,d=t;s<d.length;s++){var g=d[s],h=g.data;r.mat4.multiply(b,n,g.transformation),r.mat4.invert(x,b),r.mat4.transpose(x,x);var p=i.end;o.write({transformation:b,invTranspTransformation:x},h,o.vertexBufferLayout.createView(e.buffer.array.buffer),i.end/a);var m=o.elementCount(h)*a,c=p+m;u.assert(null==e.instances.get(g.uniqueName));var y=f.generateRenderGeometryVisibleIndexRanges(g),v=f.generateRenderGeometryHighlightRanges(g);v&&(e.highlightCount=null);var R=new l(g.name,p/a,c/a,y,v,void 0,void 0,g.idx);e.instances.set(g.uniqueName,R),y&&(i.updatedDisplayedIndexRange=!0),e.optimalCount+=m,i.end+=m}},Object.defineProperty(e.prototype,"test",{get:function(){return{material:this._material}},enumerable:!0,configurable:!0}),e}(),y={updatedDisplayedIndexRange:!1,begin:0,end:0},v=a.mat4f64.create(),b=a.mat4f64.create(),x=a.mat4f64.create(),R=new Set;return c});