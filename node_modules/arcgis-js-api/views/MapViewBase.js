// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../geometry","../Viewpoint","../core/Error","../core/Logger","../core/now","../core/promiseUtils","../core/screenUtils","../core/watchUtils","../core/accessorSupport/decorators","../geometry/support/webMercatorUtils","../layers/support/TileInfo","./PopupView","./View","./ViewAnimation","./2d/AnimationManager","./2d/FrameTask","./2d/layerViewModuleImportUtils","./2d/MapViewConstraints","./2d/PaddedViewState","./2d/tiling","./2d/viewpointUtils","./2d/support/Timeline"],function(t,e,i,n,r,o,a,s,p,l,c,u,h,y,d,f,m,g,v,w,_,b,T,O,z,R,x){function V(t){return t&&"esri.Viewpoint"===t.declaredClass}var S=p.getLogger("esri.views.MapView"),P=160;return function(t){function e(e){var i=t.call(this,e)||this;i._stationaryTimer=null,i.frameTask=new _.default(i),i.featuresTilingScheme=null,i.fullOpacity=1,i.interacting=!1,i.initialExtent=null,i.labelManager=null,i.renderingOptions={samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},i.resizeAlign="center",i.timeline=new x.Timeline,i.type="2d",i.constraints=new T,i.padding={top:0,right:0,bottom:0,left:0};var n=i.handles,r=function(){return i.notifyChange("updating")};return n.add([i.watch("viewpoint",function(){i._lastStationaryEventTimestamp=l(),i._flipStationary(P)},!0),i.on("resize",function(t){return i._resizeHandler(t)}),i.watch("animationManager.animation",function(t){i.animation=t}),i.allLayerViews.on("change",function(){r(),n.remove("map-view-base-layerViewsUpdating"),n.add(i.allLayerViews.map(function(t){return t.watch("updating",r)}),"map-view-base-layerViewsUpdating")})],"map-view-base"),i}return n(e,t),e.prototype.destroy=function(){this.destroyed||(this._set("preconditionsReady",!1),this._gotoTask=this.frameTask=null)},Object.defineProperty(e.prototype,"animation",{set:function(t){var e=this,i=this._get("animation");if(t!==i){if(i&&i.stop(),!t||t.isFulfilled())return void this._set("animation",null);this._set("animation",t),this.frameTask.animationInProgress=!0;var n=function(){t===e._get("animation")&&(e._set("animation",null),e.frameTask.requestFrame()),e.frameTask.animationInProgress=!1};t.when(n,n)}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){if(!this.ready)return this._get("center");var t=this.content.center,e=this.content.spatialReference;return new o.Point({x:t[0],y:t[1],spatialReference:e})},set:function(t){if(null!=t){if(!this._normalizeInput(t))return void S.error("#center","incompatible spatialReference "+JSON.stringify(t.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference));if(!this.ready)return this._set("center",t),void this.notifyChange("initialExtentRequired");var e=this.viewpoint;R.centerAt(e,e,t),this.viewpoint=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"constraints",{set:function(t){var e=this,i=this._get("constraints");i&&(this.handles.remove("map-view-base-constraints"),i.destroy()),this._set("constraints",t),t&&(t.view=this,this.ready&&(this.state.viewpoint=t.fit(this.content.viewpoint)),this.handles.add(t.on("update",function(){e.ready&&e.state&&(e.state.viewpoint=t.fit(e.content.viewpoint))}),"map-view-base-constraints"))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extent",{get:function(){return this.ready?this.content.extent.clone():this._get("extent")},set:function(t){if(null!=t){var e=this._normalizeInput(t);if(!e)return void S.error("#center","incompatible spatialReference "+JSON.stringify(t.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference));if(!e.width||!e.height)return void S.error("#extent","invalid extent size");if(!this.ready)return this._set("extent",e),this._set("center",null),this._set("viewpoint",null),this._set("scale",0),this._set("zoom",-1),void this.notifyChange("initialExtentRequired");var i=this.viewpoint;R.setExtent(i,i,e,this.size,{constraints:this.constraints}),this.viewpoint=i}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"initialExtentRequired",{get:function(){var t=this,e=t.extent,i=t.center,n=t.scale,r=t.viewpoint,o=t.zoom;return!this.get("map.initialViewProperties.viewpoint")&&(!e&&((!i||0===n&&-1===o)&&!r))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"padding",{get:function(){return this.ready?this.state.padding:this._get("padding")},set:function(t){if(!this.ready)return void this._set("padding",t);this.state.padding=t,this._set("padding",this.state.padding)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"resolution",{get:function(){return this.state?this.state.resolution:0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotation",{get:function(){return this.ready?this.content.rotation:this._get("rotation")},set:function(t){if(!isNaN(t)){if(!this.ready)return void this._set("rotation",t);var e=this.viewpoint;R.rotateTo(e,e,t),this.viewpoint=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this.ready?this.content.scale:this._get("scale")},set:function(t){if(t&&!isNaN(t)){if(!this.ready){this._set("scale",t),this._set("zoom",-1);var e=this._get("extent");return e&&(this._set("extent",null),this._set("center",e.center)),void this.notifyChange("initialExtentRequired")}var i=this.viewpoint;R.scaleTo(i,i,t),this.viewpoint=i}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stationary",{get:function(){return!(this.animation||this.interacting||this._get("resizing")||this._stationaryTimer)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updating",{get:function(){return!this.destroyed&&(!0===this.get("layerViewManager.updating")||!0===this.get("labelManager.updating")||!0===this.get("graphicsView.updating")||this.allLayerViews.some(function(t){return!t.destroyed&&!("layerViews"in t)&&t.attached&&!0===t.updating}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewpoint",{get:function(){if(!this.ready)return this._get("viewpoint");var t=this.content;return t&&t.viewpoint.clone()},set:function(t){if(null!=t){var e=this._normalizeInput(t);if(!e)return void(!t.scale||isNaN(t.scale)?S.error("#viewpoint","invalid scale value of "+t.scale):t.targetGeometry?S.error("#viewpoint","incompatible spatialReference "+JSON.stringify(t.targetGeometry.spatialReference)+" with view's spatialReference "+JSON.stringify(this.spatialReference)):S.error("#viewpoint","geometry not defined"));if(!this.ready)return this._set("viewpoint",e),this._set("extent",null),this._set("center",null),this._set("zoom",-1),this._set("scale",0),void this.notifyChange("initialExtentRequired");var i=new a({targetGeometry:new o.Point,scale:0,rotation:0});R.copy(i,e),this.constraints.constrain(i,this.content.viewpoint),this.state.viewpoint=i,this.frameTask.requestFrame(),this._set("viewpoint",i)}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zoom",{get:function(){return this.ready?this.constraints.scaleToZoom(this.scale):this._get("zoom")},set:function(t){if(null!=t){if(!this.ready){this.notifyChange("initialExtentRequired"),this._set("zoom",t),this._set("scale",0);var e=this._get("extent");e&&(this._set("extent",null),this._set("center",e.center))}if(this.constraints.effectiveLODs){var i=this.viewpoint;R.scaleTo(i,i,this.constraints.zoomToScale(t)),this.viewpoint=i,this._set("zoom",this.constraints.scaleToZoom(this.scale))}}},enumerable:!0,configurable:!0}),e.prototype.goTo=function(t,e){var n=this;return t?h.whenTrueOnce(this,"ready",e&&e.signal).then(function(){n.animation&&(n.animation=null);var r=i({animate:!0},e),o=R.createAsync(t,n);return n._gotoTask={},r.animate?n._gotoAnimated(o,r):n._gotoImmediate(o,r)}):void S.error("#goTo()","target cannot be null or undefined")},e.prototype.hitTest=function(t){return c.reject("Should be implemented by subclasses")},e.prototype.popupHitTest=function(t){var e=this;return this.hitTest(t).then(function(n){return i({},n,{mapPoint:e.toMap(t)})})},e.prototype.toMap=function(t){if(!this.ready)return null;var e=[0,0],i=this.state.toMap(e,[t.x,t.y]),n=i[0],r=i[1],a=this.spatialReference;return new o.Point({x:n,y:r,spatialReference:a})},e.prototype.isTileInfoRequired=function(){return!0},e.prototype.toScreen=function(t){if(!this.ready)return null;var e=this._normalizeInput(t),i=e.x,n=e.y,r=[i,n],o=this.state.toScreen(r,r),a=o[0],s=o[1];return u.createScreenPoint(a,s)},e.prototype.pixelSizeAt=function(t,e){return this.ready?(t&&null!=t.x&&(e=t.y,t=t.x),this.content.pixelSizeAt([t,e])):NaN},e.prototype.requestLayerViewUpdate=function(t){this.ready&&this.frameTask.requestLayerViewUpdate(t)},e.prototype.requestUpdate=function(t){this.ready&&this.frameTask.requestUpdate(t)},e.prototype.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||null},e.prototype.isSpatialReferenceSupported=function(t,e){return!(!e&&!this._get("ready"))||null!==this._getDefaultViewpoint()},e.prototype.importLayerView=function(t){return b.layerView2DImporter.importLayerView(t)},e.prototype.hasLayerViewModule=function(t){return b.layerView2DImporter.hasLayerViewModule(t)},e.prototype._createOrReplaceAnimation=function(t){return this.animation&&!this.animation.done||(this.animation=new v),this.animation.update(t),this.animation},e.prototype._cancellableGoTo=function(t,e,i){var n=this,r=function(){return t===n._gotoTask},o=function(){r()&&!e.done&&(e.stop(),n.frameTask.animationInProgress=!1)},a=i.then(function(){r()&&(n.animation=null)}).catch(function(t){throw r()&&(n.animation=null,e.done||(e.stop(),n.frameTask.animationInProgress=!1)),t}),s=c.create(function(t){return t(a)},o);return e.when().catch(function(){r()&&s.cancel&&s.cancel()}),s},e.prototype._gotoImmediate=function(t,e){var i=this,n=this._gotoTask,r=this._createOrReplaceAnimation(t),o=t.then(function(t){if(c.throwIfAborted(e),n!==i._gotoTask)throw new s("view:goto-interrupted","Goto was interrupted");i.viewpoint=r.target=t,r.finish()});return this._cancellableGoTo(n,r,o)},e.prototype._gotoAnimated=function(t,e){var i=this,n=this._gotoTask,r=this._createOrReplaceAnimation(t),o=t.then(function(t){if(n!==i._gotoTask)throw new s("view:goto-interrupted","Goto was interrupted");return r.update(t),i.animationManager.animate(r,i.viewpoint,e),r.when().then(function(){},function(){})});return this._cancellableGoTo(n,r,o)},e.prototype._resizeHandler=function(t){var e=this.state;if(e){var i=this.content.viewpoint,n=this.content.size.concat();e.size=[t.width,t.height],R.resize(i,i,n,this.content.size,this.resizeAlign),i=this.constraints.constrain(i,null),this.state.viewpoint=i}},e.prototype._startup=function(){var t=this._getDefaultViewpoint();this.constraints.view=this,this.constraints.fit(t),this._set("animationManager",new w({view:this})),this._set("state",new O({padding:this._get("padding"),size:this.size,viewpoint:t})),this._set("content",this.state.content),this._set("featuresTilingScheme",new z.TileInfoView(f.create({spatialReference:this.spatialReference,size:512}))),this._set("ready",!0),this.frameTask&&this.frameTask.start()},e.prototype._teardown=function(){this.frameTask&&this.frameTask.stop(),this._set("ready",!1),this._stationaryTimer&&(clearTimeout(this._stationaryTimer),this._stationaryTimer=null,this.notifyChange("stationary"));var t=this._get("content"),e=t.center,i=e[0],n=e[1],r=t.spatialReference,a=new o.Point({x:i,y:n,spatialReference:r});this._set("viewpoint",null),this._set("extent",null),this._set("center",a),this._set("zoom",-1),this._set("rotation",t.rotation),this._set("scale",t.scale),this._set("spatialReference",r),this.constraints.view=null,this.animationManager.destroy(),this._set("animationManager",null),this._set("state",null),this._set("content",null),this.animation=null},e.prototype._flipStationary=function(t){var e=this;return null!==this._stationaryTimer?this._stationaryTimer:(this._stationaryTimer=setTimeout(function(){e._stationaryTimer=null;var t=l()-e._lastStationaryEventTimestamp;t<P?e._stationaryTimer=e._flipStationary(t):e.notifyChange("stationary")},t),this._stationaryTimer)},e.prototype._normalizeInput=function(t,e){void 0===e&&(e=this.spatialReference);var i=t&&t.targetGeometry||t;return e?i?e.equals(i.spatialReference)?t:d.canProject(i,e)?V(t)?(t.targetGeometry=d.project(i,e),t):d.project(i,e):null:null:t},e.prototype._getDefaultViewpoint=function(){var t=this.constraints,e={zoom:this._get("zoom"),scale:this._get("scale"),center:this._normalizeInput(this._get("center")),extent:this._normalizeInput(this._get("extent")),rotation:this._get("rotation"),viewpoint:this._normalizeInput(this._get("viewpoint")),spatialReference:this._userSpatialReference};t.effectiveLODs?-1!==e.zoom&&(e.scale=t.zoomToScale(e.zoom)):e.zoom=-1;var i=null,n=null,r=0,o=e.viewpoint&&e.viewpoint.rotation,s=e.viewpoint&&e.viewpoint.targetGeometry;s&&("extent"===s.type?i=s:"point"===s.type&&(n=s,r=e.viewpoint.scale));var p=this._normalizeInput(this.get("map.initialViewProperties.viewpoint.targetGeometry.extent")),l=this._normalizeInput(this.initialExtent),c=e.extent||i||p||l,u=e.center||n||c&&c.center,h=e.scale||r||c&&R.extentToScale(c,this.size),y=e.rotation||o||0;return u&&h?new a({targetGeometry:u,scale:h,rotation:y}):null},r([y.property()],e.prototype,"animation",null),r([y.property({readOnly:!0})],e.prototype,"animationManager",void 0),r([y.property({value:null,type:o.Point,dependsOn:["content.viewpoint","ready"]})],e.prototype,"center",null),r([y.property({type:T})],e.prototype,"constraints",null),r([y.property({readOnly:!0})],e.prototype,"content",void 0),r([y.property({value:null,type:o.Extent,dependsOn:["content.viewpoint","ready"]})],e.prototype,"extent",null),r([y.property({readOnly:!0})],e.prototype,"featuresTilingScheme",void 0),r([y.property()],e.prototype,"fullOpacity",void 0),r([y.property({readOnly:!0})],e.prototype,"interacting",void 0),r([y.property({type:o.Extent})],e.prototype,"initialExtent",void 0),r([y.property({dependsOn:["map.initialViewProperties?.viewpoint"]})],e.prototype,"initialExtentRequired",null),r([y.property()],e.prototype,"labelManager",void 0),r([y.property({value:{top:0,right:0,bottom:0,left:0},cast:function(t){return i({top:0,right:0,bottom:0,left:0},t)}})],e.prototype,"padding",null),r([y.property({type:Object})],e.prototype,"renderingOptions",void 0),r([y.property()],e.prototype,"resizeAlign",void 0),r([y.property({readOnly:!0,dependsOn:["content.viewpoint"]})],e.prototype,"resolution",null),r([y.property({value:0,type:Number,dependsOn:["content.viewpoint","ready"]})],e.prototype,"rotation",null),r([y.property({value:0,type:Number,dependsOn:["content.viewpoint","ready"]})],e.prototype,"scale",null),r([y.property({type:o.SpatialReference,dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],e.prototype,"spatialReference",void 0),r([y.property({readOnly:!0})],e.prototype,"state",void 0),r([y.property()],e.prototype,"stationary",null),r([y.property({type:x.Timeline,readOnly:!0})],e.prototype,"timeline",void 0),r([y.property({readOnly:!0})],e.prototype,"type",void 0),r([y.property({readOnly:!0,dependsOn:["layerViewManager.updating","labelManager.updating","graphicsView?.updating"]})],e.prototype,"updating",null),r([y.property({value:null,type:a,dependsOn:["content.viewpoint","ready"]})],e.prototype,"viewpoint",null),r([y.property({value:-1,dependsOn:["scale"]})],e.prototype,"zoom",null),e=r([y.subclass("esri.views.MapViewBase")],e)}(y.declared(m.PopupView(g)))});