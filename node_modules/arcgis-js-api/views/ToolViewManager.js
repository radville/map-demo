// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/decorateHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../core/tsSupport/assignHelper","../core/Accessor","../core/Collection","../core/Handles","../core/Logger","../core/maybe","../core/promiseUtils","../core/watchUtils","../core/accessorSupport/decorators","./input/InputManager","./input/ViewEvents","./interactive/interactiveToolUtils","./interactive/ToolViewManagerManipulatorState"],function(o,t,e,r,n,i,a,l,s,c,u,h,p,v,f,d,T,_,m){var E=u.getLogger("esri.views.ToolViewManager");return function(o){function t(t){var e=o.call(this,t)||this;return e._handles=new c,e._creatingTool=null,e._manipulatorState=new m.default,e.tools=_.newToolCollection(),e.cursor=null,e._forEachTool=function(o){if(!h.isSome(e._creatingTool)||!o(e._creatingTool))for(var t=0,r=e.tools.items;t<r.length;t++){var n=r[t];if(o(n))return}},e}return r(t,o),t.prototype.initialize=function(){var o=this;this._handles.add([this.view.on(T.eventTypes,function(t){o._handleInputEvent(t)},d.ViewEventPriorities.TOOL),this.tools.on("before-add",function(t){var e=t.item;if(null==e||o.tools.includes(e))return void t.preventDefault();null==e.created||e.created||(E.error("tools","Tool can not be added to view before it has been created"),t.preventDefault())}),this.tools.on("before-remove",function(t){var e=t.item;o._manipulatorState.clearPointers(e,o._forEachTool)}),this.tools.on("change",function(){o._refreshToolWatchers()})])},t.prototype.destroy=function(){this._forEachTool(function(o){return o.destroy()}),this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"activeTool",{set:function(o){var t=this;if(h.isSome(o)&&!this.view.ready)return void E.error("#activeTool=","cannot set active tool while view is not ready");_.swap(this,o,function(e){t._set("activeTool",e),t._removeIncompleteTools(o),t._forEachTool(function(o){var e=h.isNone(t.activeTool)||o===t.activeTool;o.setEditableFlag&&o.setEditableFlag(1,e);var r=_.areToolManipulatorsEditable(o);!h.isNone(t.activeTool)&&r||t._manipulatorState.clearPointers(o,t._forEachTool,!r)}),t._updateCursor()}),this._creatingTool!==o&&this._rejectCreatingTool()},enumerable:!0,configurable:!0}),t.prototype.createTool=function(o,t,e){return i(this,void 0,void 0,function(){var r,i,s,c=this;return n(this,function(n){switch(n.label){case 0:return[4,this.view.whenReady()];case 1:return n.sent(),r=_.evaluateToolConstructorArguments(t),i=new o(a({},r,{view:this.view})),s=p.onAbort(e,function(){return c.activeTool=null}),this._rejectCreatingTool("Tool creation was interrupted by another tool being created"),this._creatingTool=i,i.attach(),this._refreshToolWatchers(),_.setActive(i,!0),[4,i.when()];case 2:return n.sent(),h.isSome(s)&&s.remove(),this._creatingTool=null,this.tools.add(i),i instanceof l&&null!=i.completed&&v.whenOnce(i,"completed").then(function(){_.setActive(i,!1)}),[2,i]}})})},t.prototype.attach=function(){var o=this;this._forEachTool(function(o){return o.attach()}),"3d"===this.view.type?this._handles.add([this.view.state.watch("camera",function(){o.forEachManipulator(function(o){null!=o.onViewChange&&o.onViewChange()})}),this.view.elevationProvider.on("elevation-change",function(t){o.forEachManipulator(function(o){null!=o.onElevationChange&&o.onElevationChange(t)})})],"manipulators"):this._handles.add(this.view.watch("extent",function(){o.forEachManipulator(function(o){null!=o.onViewChange&&o.onViewChange()})}))},t.prototype.detach=function(){this.activeTool=null,this._forEachTool(function(o){o.detach(),o.destroy()}),this.tools.removeAll(),this._handles.remove("manipulators")},t.prototype.forEachManipulator=function(o){this._forEachTool(function(t){t.manipulators&&t.manipulators.forEach(function(e){var r=e.manipulator;return o(r,t)})})},t.prototype._handleInputEvent=function(o){var t=this;h.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(o):this._forEachTool(function(t){!1!==t.visible&&t.handleInputEvent&&t.handleInputEvent(o)}),"key-down"===o.type&&"Escape"===o.key&&this.activeTool&&(o.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(o,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:function(o){t.activeTool=o},creatingTool:this._creatingTool,view:this.view}),this._manipulatorState.handleHoverEvent(o,this._forEachTool),this._updateCursor()},t.prototype._refreshToolWatchers=function(){var o=this;this._handles.remove("tools"),this._updateCursor(),this._forEachTool(function(t){if(t instanceof l){var e=v.watch(t,["cursor","visible","editable"],function(){_.areToolManipulatorsEditable(t)||o._manipulatorState.clearPointers(t,o._forEachTool),o._updateCursor()});o._handles.add(e,"tools")}t.manipulators&&o._handles.add(t.manipulators.on("change",function(e){e.removed.forEach(function(e){var r=e.id;o._manipulatorState.clearPointers(t,o._forEachTool,!0,r)}),o._updateCursor()}),"tools")})},t.prototype._updateCursor=function(){var o=null;this._forEachTool(function(t){return null!=t.cursor&&!1!==t.visible&&(o=t.cursor,!0)}),o||(o=this._manipulatorState.cursor),this._get("cursor")!==o&&this._set("cursor",o)},t.prototype._rejectCreatingTool=function(o){var t=this._creatingTool;h.isNone(t)||(this._manipulatorState.clearPointers(t,this._forEachTool),t.rejectCreation&&t.rejectCreation(p.createAbortError(o)),t.destroy(),this._creatingTool=null,this._refreshToolWatchers())},t.prototype._removeIncompleteTools=function(o){var t=this;this.tools.filter(function(t){return(h.isNone(o)||t!==o)&&null!=t.completed&&!t.completed}).forEach(function(o){t.tools.remove(o)})},e([f.property({constructOnly:!0,nonNullable:!0})],t.prototype,"view",void 0),e([f.property({value:null})],t.prototype,"activeTool",null),e([f.property({readOnly:!0,type:s})],t.prototype,"tools",void 0),e([f.property({readOnly:!0})],t.prototype,"cursor",void 0),t=e([f.subclass("esri.views.ToolViewManager")],t)}(f.declared(l))});