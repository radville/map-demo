// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/arrayUtils","../../../core/Evented","../../../core/Handles","../../../core/lang","../../../core/screenUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","./drawUtils","./input/GraphicMoverEvents","../../input/InputManager"],function(e,i,t,r,n,a,o,c,p,h,s,l,v,u){return function(e){function i(i){var t=e.call(this,i)||this;return t._activeGraphic=null,t._dragEvent=null,t._handles=new o,t._hoverGraphic=null,t._initialDragGeometry=null,t._pointerDownEvent=null,t._viewHandles=new o,t.type="graphic-mover",t.callbacks={onGraphicClick:function(){},onGraphicDoubleClick:function(){},onGraphicMoveStart:function(){},onGraphicMove:function(){},onGraphicMoveStop:function(){},onGraphicPointerOver:function(){},onGraphicPointerOut:function(){},onGraphicPointerDown:function(){},onGraphicPointerUp:function(){}},t.enableMoveAllGraphics=!1,t.graphics=[],t.view=null,t}return t(i,e),i.prototype.initialize=function(){var e=this;this._handles.add([h.whenOnce(this,"view.ready",function(){e._viewHandles.add([e.view.on("immediate-click",function(i){return e._clickHandler(i)},u.ViewEventPriorities.TOOL),e.view.on("double-click",function(i){return e._doubleClickHandler(i)},u.ViewEventPriorities.TOOL),e.view.on("pointer-down",function(i){return e._pointerDownHandler(i)},u.ViewEventPriorities.TOOL),e.view.on("pointer-move",function(i){return e._pointerMoveHandler(i)},u.ViewEventPriorities.TOOL),e.view.on("pointer-up",function(i){return e._pointerUpHandler(i)},u.ViewEventPriorities.TOOL),e.view.on("drag",function(i){return e._dragHandler(i)},u.ViewEventPriorities.TOOL),e.view.on("key-down",function(i){return e._keyDownHandler(i)},u.ViewEventPriorities.TOOL)])})])},i.prototype.destroy=function(){this.reset(),this._viewHandles.removeAll(),this._handles.removeAll()},Object.defineProperty(i.prototype,"state",{get:function(){var e=!!this.get("view.ready"),i=!!this.get("graphics.length"),t=this._activeGraphic;return e&&i?t?"moving":"active":e?"ready":"disabled"},enumerable:!0,configurable:!0}),i.prototype.reset=function(){this._activeGraphic=null,this._hoverGraphic=null,this._dragEvent=null},i.prototype.updateGeometry=function(e,i){var t=this.graphics[e];t&&t.set("geometry",i)},i.prototype._clickHandler=function(e){var i=this;this.view.hitTest(p.createScreenPointFromEvent(e)).then(function(t){var r=t.results;if(r.length&&r[0].graphic){var n=r[0].graphic;if(i.graphics.indexOf(n)>-1){var a=new v.GraphicClickEvent(n,i.graphics.indexOf(n),e.x,e.y,e);i.emit("graphic-click",a),i.callbacks.onGraphicClick&&i.callbacks.onGraphicClick(a)}}})},i.prototype._doubleClickHandler=function(e){var i=this;this.view.hitTest(p.createScreenPointFromEvent(e)).then(function(t){var r=t.results;if(r.length&&r[0].graphic){var n=r[0].graphic;if(i.graphics.indexOf(n)>-1){var a=new v.GraphicDoubleClickEvent(n,i.graphics.indexOf(n),e.x,e.y,e);i.emit("graphic-double-click",a),i.callbacks.onGraphicDoubleClick&&i.callbacks.onGraphicDoubleClick(a)}}})},i.prototype._pointerDownHandler=function(e){var i=this;this._pointerDownEvent=e,this.view.hitTest(p.createScreenPointFromEvent(e)).then(function(t){var r=n.find(t.results,function(e){return-1!==i.graphics.indexOf(e.graphic)});if(r){var a=r.graphic;if(i.graphics.indexOf(a)>-1){i._activeGraphic=a;var o=e.x,c=e.y,p=new v.GraphicPointerDownEvent(a,i.graphics.indexOf(a),o,c,e);i.emit("graphic-pointer-down",p),i.callbacks.onGraphicPointerDown&&i.callbacks.onGraphicPointerDown(p)}else a!==i._activeGraphic&&(i._pointerDownEvent=null,i._activeGraphic=null)}else i._pointerDownEvent=null,i._activeGraphic=null})},i.prototype._pointerUpHandler=function(e){if(this._pointerDownEvent=null,this._activeGraphic){var i=e.x,t=e.y,r=this.graphics.indexOf(this._activeGraphic),n=new v.GraphicPointerUpEvent(this._activeGraphic,r,i,t,e);this._activeGraphic=null,this.emit("graphic-pointer-up",n),this.callbacks.onGraphicPointerUp&&this.callbacks.onGraphicPointerUp(n)}},i.prototype._pointerMoveHandler=function(e){var i=this;this._dragEvent||this.view.hitTest(p.createScreenPointFromEvent(e)).then(function(t){var r=t.results;if(r.length&&r[0].graphic){var n=r[0].graphic;if(n===i._hoverGraphic)return;if(i.graphics.indexOf(n)>-1){var a=e.x,o=e.y;if(i._hoverGraphic){var c=i.graphics.indexOf(i._hoverGraphic),p=new v.GraphicPointerOutEvent(i.graphics[c],c,a,o,e);i._hoverGraphic=null,i.emit("graphic-pointer-out",p),i.callbacks.onGraphicPointerOut&&i.callbacks.onGraphicPointerOut(p)}var h=i.graphics.indexOf(n),s=new v.GraphicPointerOverEvent(n,h,a,o,e);return i._hoverGraphic=n,i.emit("graphic-pointer-over",s),void(i.callbacks.onGraphicPointerOver&&i.callbacks.onGraphicPointerOver(s))}}if(i._hoverGraphic){var a=e.x,o=e.y,c=i.graphics.indexOf(i._hoverGraphic),s=new v.GraphicPointerOutEvent(i.graphics[c],c,a,o,e);i._hoverGraphic=null,i.emit("graphic-pointer-out",s),i.callbacks.onGraphicPointerOut&&i.callbacks.onGraphicPointerOut(s)}})},i.prototype._dragHandler=function(e){var i=this;if(this._pointerDownEvent){if("start"!==e.action&&!this._dragEvent||!this._activeGraphic||!this._activeGraphic.geometry)return;e.stopPropagation();var t=e.x,r=e.y,n=this.graphics.indexOf(this._activeGraphic),a=this._activeGraphic.geometry,o=this._dragEvent?t-this._dragEvent.x:0,p=this._dragEvent?r-this._dragEvent.y:0,h=t-e.origin.x,s=r-e.origin.y;if(this._activeGraphic.geometry=l.cloneMove(a,o,p,this.view),this.enableMoveAllGraphics&&this.graphics.forEach(function(e){e!==i._activeGraphic&&(e.geometry=l.cloneMove(e.geometry,o,p,i.view))}),this._dragEvent=e,"start"===e.action){this._initialDragGeometry=c.clone(a);var u=new v.GraphicMoveStartEvent(this._activeGraphic,this.graphics,n,t,r,o,p,h,s,e);this.emit("graphic-move-start",u),this.callbacks.onGraphicMoveStart&&this.callbacks.onGraphicMoveStart(u),u.defaultPrevented&&this._activeGraphic.set("geometry",a)}else if("update"===e.action){var u=new v.GraphicMoveEvent(this._activeGraphic,this.graphics,n,t,r,o,p,h,s,e);this.emit("graphic-move",u),this.callbacks.onGraphicMove&&this.callbacks.onGraphicMove(u),u.defaultPrevented&&this._activeGraphic.set("geometry",a)}else{this._dragEvent=null;var u=new v.GraphicMoveStopEvent(this._activeGraphic,this.graphics,n,t,r,o,p,h,s,e);this.emit("graphic-move-stop",u),this.callbacks.onGraphicMoveStop&&this.callbacks.onGraphicMoveStop(u),u.defaultPrevented&&this.graphics[n].set("geometry",this._initialDragGeometry),this._initialDragGeometry=null}}},i.prototype._keyDownHandler=function(e){"a"!==e.key&&"d"!==e.key&&"n"!==e.key||"moving"!==this.state||e.stopPropagation()},r([s.property()],i.prototype,"_activeGraphic",void 0),r([s.property({readOnly:!0})],i.prototype,"type",void 0),r([s.property()],i.prototype,"callbacks",void 0),r([s.property()],i.prototype,"enableMoveAllGraphics",void 0),r([s.property()],i.prototype,"graphics",void 0),r([s.property({dependsOn:["view.ready","graphics.length","_activeGraphic"],readOnly:!0})],i.prototype,"state",null),r([s.property()],i.prototype,"view",void 0),i=r([s.subclass("esri.views.draw.support.GraphicMover")],i)}(s.declared(a.EventedAccessor))});