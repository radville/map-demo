// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/Accessor","../../core/Logger","../../core/now","../../core/accessorSupport/decorators","./keys","./handlers/LatestPointerType"],function(e,t,r,n,i,o,a,s,p,d){Object.defineProperty(t,"__esModule",{value:!0});var u=o.getLogger("esri.views.input.InputManager"),l=function(e){function i(t){var r=e.call(this,t)||this;return r._pointerCaptures=new Map,r._nameToGroup={},r._handlers=[],r._currentPropagation=null,r._sourceEvents=new Set,r._keyModifiers=new Set,r._activeKeyModifiers=new Set,r._stoppedPropagationEventIds=new Set,r.primaryKey=p.primaryKey,r.latestPointerType="mouse",r.test={timestamp:void 0},r}return r(i,e),i.prototype.initialize=function(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()},i.prototype.destroy=function(){for(var e=Object.keys(this._nameToGroup),t=0,r=e;t<r.length;t++){var n=r[t];this.uninstallHandlers(n)}this.eventSource=null},Object.defineProperty(i.prototype,"hasPendingInputs",{get:function(){return this._handlers.some(function(e){return e.handler.hasPendingInputs})},enumerable:!0,configurable:!0}),i.prototype.installHandlers=function(e,r,n){var i=this;if(void 0===n&&(n=t.ViewEventPriorities.INTERNAL),this._nameToGroup[e])return void u.error("There is already an InputHandler group registered under the name `"+e+"`");if(0===r.length)return void u.error("Can't register a group of zero handlers");var o={name:e,handlers:r.map(function(e){return{handler:e,active:!0,removed:!1,priorityIndex:0,groupPriority:n,eventCallback:null,uninstallCallback:null}})};this._nameToGroup[e]=o;for(var a=this,s=o.handlers.length-1;s>=0;s--)!function(e){var t=o.handlers[e];a._handlers.push(t),t.handler.onInstall({updateDependencies:function(){i.updateDependencies()},emit:function(e,r,n,o,a){i._emitInputEvent(t.priorityIndex,e,r,n,a,o)},setPointerCapture:function(e,r){i._setPointerCapture(o,t,e,r)},setEventCallback:function(e){t.eventCallback=e},setUninstallCallback:function(e){t.uninstallCallback=e},refreshHasPendingInputs:function(){i.notifyChange("hasPendingInputs")}})}(s);this.updateDependencies()},i.prototype.uninstallHandlers=function(e){var t=this._nameToGroup[e];if(!t)return void u.error("There is no InputHandler group registered under the name `"+e+"`");t.handlers.forEach(function(e){e.removed=!0,e.uninstallCallback()}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()},i.prototype.hasHandlers=function(e){return void 0!==this._nameToGroup[e]},i.prototype.updateDependencies=function(){var e=new Set,t=new Set;this._handlersPriority=[];for(var r=this._handlers.length-1;r>=0;r--){var n=this._handlers[r];n.priorityIndex=r,this._handlersPriority.push(n)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(var r=this._handlersPriority.length-1;r>=0;r--){var i=this._handlersPriority[r];i.priorityIndex=r;var o=i.handler.hasSideEffects;if(!o)for(var a=0,s=i.handler.outgoingEventTypes;a<s.length;a++){var d=s[a];if(e.has(d)){o=!0;break}}if(o)for(var u=0,l=i.handler.incomingEventMatches;u<l.length;u++){var h=l[u];e.add(h.eventType);for(var c=0,v=h.keyModifiers;c<v.length;c++){var f=v[c];p.isSystemModifier(f)||t.add(f)}}i.active=o}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)},i.prototype._setLatestPointerType=function(e){this._set("latestPointerType",e)},i.prototype._onEventReceived=function(e,t){if("pointer-capture-lost"===e){var r=t;this._pointerCaptures.delete(r.native.pointerId)}this._updateKeyModifiers(e,t);var n=null!=this.test.timestamp?this.test.timestamp:t.native?t.native.timestamp:void 0,i=t.native?t.native.cancelable:void 0;this._emitInputEventFromSource(e,t,n,i)},i.prototype._updateKeyModifiers=function(e,t){var r=this;if(t){var n=!1,i=function(){if(!n){var e=new Set;r._activeKeyModifiers.forEach(function(t){e.add(t)}),r._activeKeyModifiers=e,n=!0}},o=function(e,t){t&&!r._activeKeyModifiers.has(e)?(i(),r._activeKeyModifiers.add(e)):!t&&r._activeKeyModifiers.has(e)&&(i(),r._activeKeyModifiers.delete(e))};if("key-down"===e||"key-up"===e){var a=t,s=a.key;this._keyModifiers.has(s)&&o(s,"key-down"===e)}var p=t.native;o("Alt",!(!p||!p.altKey)),o("Ctrl",!(!p||!p.ctrlKey)),o("Shift",!(!p||!p.shiftKey)),o("Meta",!(!p||!p.metaKey)),o("Primary",this._activeKeyModifiers.has(this.primaryKey))}},i.prototype._installRecognizers=function(){var e=this;this._latestPointerTypeHandler=new d.LatestPointerType(function(t){return e._setLatestPointerType(t)}),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,t.ViewEventPriorities.INTERNAL),this.installHandlers("input-manager-logic",[this._latestPointerTypeHandler],t.ViewEventPriorities.INTERNAL)},i.prototype._setPointerCapture=function(e,t,r,n){var i=e.name+"-"+t.priorityIndex,o=this._pointerCaptures.get(r.pointerId)||new Set;this._pointerCaptures.set(r.pointerId,o),n?(o.add(i),1===o.size&&this.eventSource&&this.eventSource.setPointerCapture(r,!0)):o.has(i)&&(o.delete(i),0===o.size&&(this._pointerCaptures.delete(r.pointerId),this.eventSource&&this.eventSource.setPointerCapture(r,!1)))},i.prototype._garbageCollectRemovedHandlers=function(){this._handlers=this._handlers.filter(function(e){return!e.removed}),this.updateDependencies()},i.prototype._emitInputEventFromSource=function(e,t,r,n){this._emitInputEvent(0,e,t,r,n)},i.prototype._emitInputEvent=function(e,t,r,n,i,o){var s=void 0!==n?n:this._currentPropagation?this._currentPropagation.timestamp:a(),p=void 0!==i&&i,d=new h(t,r,s,o||this._activeKeyModifiers,p);if(this._currentPropagation)return void this._currentPropagation.addedEvents.push(d);this._doNewPropagation(e,d)},i.prototype._doNewPropagation=function(e,t){this._currentPropagation={events:[t],addedEvents:[],currentHandler:this._handlersPriority[e],needsHandlerGarbageCollect:!1,timestamp:t.timestamp};for(var r=this._currentPropagation;r.currentHandler;){if(r.currentHandler.removed)r.needsHandlerGarbageCollect=!0;else{var n=r.events,i=[];r.addedEvents=[];for(var o=0;o<n.length;o++){var a=n[o],s=a.data&&a.data.eventId;null!=s&&this._stoppedPropagationEventIds.has(s)||(r.currentHandler.active&&r.currentHandler.eventCallback(a),a.shouldStopPropagation()?null!=s&&this._stoppedPropagationEventIds.add(s):i.push(a))}r.events=i.concat(r.addedEvents)}r.currentHandler=this._handlersPriority[r.currentHandler.priorityIndex+1]}r.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null},i.prototype._compareHandlerPriority=function(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(var r=0,n=e.handler.incomingEventMatches;r<n.length;r++)for(var i=n[r],o=0,a=t.handler.incomingEventMatches;o<a.length;o++){var s=a[o],p=function(e){if(i.eventType!==e.eventType)return"continue";var t=i.keyModifiers.filter(function(t){return-1!==e.keyModifiers.indexOf(t)});return t.length===i.keyModifiers.length!=(t.length===e.keyModifiers.length)?{value:i.keyModifiers.length>e.keyModifiers.length?-1:1}:void 0}(s);if("object"==typeof p)return p.value}return e.priorityIndex>t.priorityIndex?-1:1},i.prototype._sortHandlersPriority=function(e){for(var t=[],r=0,n=e;r<n.length;r++){for(var i=n[r],o=0;o<t.length&&this._compareHandlerPriority(i,t[o])>=0;)o++;t.splice(o,0,i)}return t},Object.defineProperty(i.prototype,"debug",{get:function(){var e=this,t=function(t){var r=e._setPointerCapture;e._setPointerCapture=function(){},t(),e._setPointerCapture=r};return{injectEvent:function(r,n){t(function(){e._onEventReceived(r,n)})},disablePointerCapture:t}},enumerable:!0,configurable:!0}),n([s.property({readOnly:!0})],i.prototype,"hasPendingInputs",null),n([s.property({})],i.prototype,"eventSource",void 0),n([s.property({})],i.prototype,"recognizers",void 0),n([s.property({readOnly:!0})],i.prototype,"latestPointerType",void 0),i=n([s.subclass("esri.views.input.InputManager")],i)}(s.declared(i));t.InputManager=l;var h=function(){function e(e,t,r,n,i){this.type=e,this.data=t,this.timestamp=r,this.modifiers=n,this.cancelable=i,this._stopPropagation=!1}return e.prototype.stopPropagation=function(){this._stopPropagation=!0},e.prototype.shouldStopPropagation=function(){return this._stopPropagation},e.prototype.preventDefault=function(){this.data.native.preventDefault()},e}();t.ViewEventPriorities={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3}});