// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/decorateHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/assignHelper","../../core/Accessor","../../core/Evented","../../core/Logger","../../core/maybe","../../core/screenUtils","../../core/accessorSupport/decorators","../../core/libs/gl-matrix-2/vec2","../../core/libs/gl-matrix-2/vec3","../../core/libs/gl-matrix-2/vec3f64","../../geometry/support/webMercatorUtils","../../support/elevationInfoUtils","../../symbols/support/defaults","../../symbols/support/ElevationInfo","../../views/support/drapedUtils"],function(e,t,r,o,i,n,s,l,a,c,p,u,y,h,f,g,b,d,v){Object.defineProperty(t,"__esModule",{value:!0});var m=l.getLogger("esri.views.interactive.GraphicManipulator"),_=function(e){function t(t){var r=e.call(this,t)||this;return r.layer=null,r.interactive=!0,r.selectable=!1,r.dragging=!1,r.cursor=null,r.events=new s({target:r}),r._circleCollisionCache=null,r._originalSymbol=null,r}return o(t,e),Object.defineProperty(t.prototype,"graphic",{set:function(e){if("mesh"===a.get(e.geometry,"type"))return void m.error("Mesh geometries are not supported");this._circleCollisionCache=null,this._originalSymbol=e.symbol,this._set("graphic",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"elevationInfo",{get:function(){var e="elevationInfo"in this.graphic.layer&&this.graphic.layer.elevationInfo,t=g.getGraphicEffectiveElevationMode(this.graphic);return new d({mode:t,offset:e?e.offset:0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"focusedSymbol",{set:function(e){e!==this._get("focusedSymbol")&&(this._set("focusedSymbol",e),this._updateGraphicSymbol(),this._circleCollisionCache=null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"grabbing",{set:function(e){if(e!==this._get("grabbing")){var t=this._focused;this._set("grabbing",e),this._updateGraphicSymbol(t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hovering",{set:function(e){if(e!==this._get("hovering")){var t=this._focused;this._set("hovering",e),this._updateGraphicSymbol(t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selected",{set:function(e){e!==this._get("selected")&&(this._set("selected",e),this._updateGraphicSymbol())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},enumerable:!0,configurable:!0}),t.prototype.destroy=function(){this._resetGraphicSymbol(),this._set("view",null)},t.prototype.intersectionDistance=function(e){var t=this._get("graphic");if(!1===t.visible)return null;var r=this._get("focusedSymbol"),o=a.isSome(r)?r:t.symbol,i=t.geometry;if(a.isNone(i))return null;var n=this._get("view");return"2d"===n.type?this._intersectDistance2D(e,n,i,o):this._intersectDistance3D(e,n,t)},t.prototype.attach=function(){a.isNone(this.layer)||this.layer.add(this.graphic)},t.prototype.detach=function(){this._resetGraphicSymbol(),a.isNone(this.layer)||this.layer.remove(this.graphic)},t.prototype._updateGraphicSymbol=function(e){if(void 0===e&&(e=this._focused),e!==this._focused){var t=this.graphic.symbol;t!==this._originalSymbol&&t!==this.focusedSymbol&&(this._originalSymbol=t)}this.graphic.symbol=this._focused&&a.isSome(this.focusedSymbol)?this.focusedSymbol:this._originalSymbol},t.prototype._resetGraphicSymbol=function(){this.graphic.symbol=this._originalSymbol},t.prototype._intersectDistance2D=function(e,t,r,o){if(o=o||b.getDefaultSymbol2D(r),a.isNone(o))return null;var i=this._circleCollisionCache;if("point"!==r.type||"simple-marker"!==o.type){var n=v.intersectsDrapedGeometry(e,r,t);return a.isSome(n)?1:null}if(a.isNone(i)||!i.originalPoint.equals(r)){var s=r,l=t.spatialReference;if(f.canProject(s,l)){var n=f.project(s,l);i={originalPoint:s.clone(),mapPoint:n,radiusPx:c.pt2px(o.size)},this._circleCollisionCache=i}}if(a.isSome(i)){var p=c.screenPointObjectToArray(e,P),y=t.state.toScreen(O,i.mapPoint.x,i.mapPoint.y),h=i.radiusPx;return u.vec2.squaredDistance(p,y)<h*h?1:null}return null},t.prototype._intersectDistance3D=function(e,t,r){var o=t.toMap(e,{include:[r]});if(!o)return null;var i=S;return t.renderCoordsHelper.toRenderCoords(o,i)?y.vec3.distance(i,t.state.camera.eye):null},r([p.property({constructOnly:!0,nonNullable:!0})],t.prototype,"graphic",null),r([p.property({readOnly:!0,dependsOn:["graphic"]})],t.prototype,"elevationInfo",null),r([p.property({constructOnly:!0,nonNullable:!0})],t.prototype,"view",void 0),r([p.property({value:null})],t.prototype,"focusedSymbol",null),r([p.property({constructOnly:!0})],t.prototype,"layer",void 0),r([p.property()],t.prototype,"interactive",void 0),r([p.property()],t.prototype,"selectable",void 0),r([p.property({value:!1})],t.prototype,"grabbing",null),r([p.property()],t.prototype,"dragging",void 0),r([p.property()],t.prototype,"hovering",null),r([p.property({value:!1})],t.prototype,"selected",null),r([p.property()],t.prototype,"cursor",void 0),t=r([p.subclass("esri.views.interactive.GraphicManipulator")],t)}(p.declared(n));t.GraphicManipulator=_;var S=h.vec3f64.create(),P=c.createScreenPointArray(),O=c.createScreenPointArray()});