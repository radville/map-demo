// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/iteratorUtils","../../core/mathUtils","../../core/maybe","../../core/screenUtils","./interactiveToolUtils"],function(e,t,r,i,o,n,a){function s(e){return"touch"!==e}function l(e){return"mouse"!==e.pointerType||0===e.button}function p(e){return!!e.native.shiftKey}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(){this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToActiveTool=null,this._cursor=null}return Object.defineProperty(e.prototype,"cursor",{get:function(){return this._cursor},enumerable:!0,configurable:!0}),e.prototype.handleInputEvent=function(e,t){var r=function(){return e.stopPropagation()};switch(e.type){case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(r(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":if(!l(e)||p(e))break;var a=n.createScreenPointFromEvent(e),s=this._intersect(a,e.pointerType,t.forEachTool);if(o.isNone(s))break;var u=this._findManipulatorByKey(s,t.forEachTool);o.isSome(u)&&u.interactive&&!u.grabbing&&(this._grabbedManipulators.set(e.pointerId,{key:s,start:a}),1===this._grabbedManipulators.size&&(this._revertToActiveTool=t.activeTool,t.setActiveTool(s.tool)),u.grabbing=!0,u.events.emit("grab",{action:"start",screenPoint:a}),r());break;case"pointer-up":this._handlePointerEnd(e,t);break;case"pointer-drag":if(!l(e))break;var d=this._grabbedManipulators.get(e.pointerId),h=this._draggedManipulators.get(e.pointerId),f=o.applySome(d||h,function(e){return e.key}),v=this._findManipulatorByKey(f,t.forEachTool);if(o.isNone(v))break;var a=n.createScreenPointFromEvent(e);a.x=i.clamp(a.x,0,t.view.width),a.y=i.clamp(a.y,0,t.view.height);var y=o.expect(d||h).start,g={action:e.action,start:y,screenPoint:a};switch(e.action){case"start":case"update":"update"!==g.action&&1!==this._grabbedManipulators.size||(v.dragging=!0,h||(g.action="start"),v.events.emit("drag",g),this._draggedManipulators.set(e.pointerId,{key:o.expect(f),start:y}));break;case"end":h&&v.events.emit("drag",g),v.dragging=!1,this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}r();break;case"immediate-click":var a=n.createScreenPointFromEvent(e),s=this._intersect(a,e.pointerType,t.forEachTool),_=this._findToolAndManipulatorByKey(s,t.forEachTool,c);if(p(e)||t.forEachTool(function(e){if(e.manipulators){var t=!1;e.manipulators.forEach(function(e){var r=e.manipulator;r.selected&&(r.selected=!1,t=!0)}),t&&e.manipulatorSelectionChanged&&e.manipulatorSelectionChanged()}}),!_)break;var u=c.manipulator,b=c.tool;if(!u.interactive)break;u.selectable&&(u.selected=!u.selected,b.manipulatorSelectionChanged&&b.manipulatorSelectionChanged());var m=e.native.shiftKey;u.events.emit("immediate-click",{screenPoint:a,button:e.button,pointerType:e.pointerType,shiftKey:m,stopPropagation:r});break;case"click":var a=n.createScreenPointFromEvent(e),s=this._intersect(a,e.pointerType,t.forEachTool),u=this._findManipulatorByKey(s,t.forEachTool);if(o.isNone(u)||!u.interactive)break;var m=e.native.shiftKey;u.events.emit(e.type,{screenPoint:a,button:e.button,pointerType:e.pointerType,shiftKey:m}),r();break;case"double-click":var a=n.createScreenPointFromEvent(e),s=this._intersect(a,e.pointerType,t.forEachTool),u=this._findManipulatorByKey(s,t.forEachTool);if(o.isNone(u)||!u.interactive)break;var m=e.native.shiftKey;u.events.emit("double-click",{screenPoint:a,button:e.button,pointerType:e.pointerType,shiftKey:m,stopPropagation:r})}this._updateCursor(t.forEachTool)},e.prototype._handlePointerEnd=function(e,t){var r=o.applySome(this._grabbedManipulators.get(e.pointerId),function(e){return e.key}),i=this._findManipulatorByKey(r,t.forEachTool);if(o.isSome(i)&&!i.dragging){var a=o.isSome(t.creatingTool)&&t.creatingTool===o.expect(r).tool;1!==this._grabbedManipulators.size||0!==this._draggedManipulators.size||a||(t.setActiveTool(this._revertToActiveTool),this._revertToActiveTool=null),i.grabbing&&(i.grabbing=!1,i.events.emit("grab",{action:"end",screenPoint:n.createScreenPointFromEvent(e)})),this._grabbedManipulators.delete(e.pointerId)}},e.prototype._cursorFromMap=function(e,t){var i=this,n=null;return r.someMap(e,function(e){var r=e.key,a=i._findManipulatorByKey(r,t);return!!(o.isSome(a)&&a.interactive&&"cursor"in a&&a.cursor)&&(n=a.cursor,!0)}),n},e.prototype._updateCursor=function(e){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators,e)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators,e)||"pointer":this._cursor=null},e.prototype.clearPointers=function(e,t,r,i){var n=this;void 0===r&&(r=!0);var a=function(t){return t.tool===e&&(o.isNone(i)||t.manipulatorId===i)};this._grabbedManipulators.forEach(function(e,r){var i=e.key;if(a(i)){n._grabbedManipulators.delete(r);var s=n._findManipulatorByKey(i,t);o.isSome(s)&&(s.grabbing=!1,s.events.emit("grab",{action:"end",screenPoint:null}))}}),this._draggedManipulators.forEach(function(e,r){var i=e.key;if(a(i)){n._draggedManipulators.delete(r);var s=n._findManipulatorByKey(i,t);o.isSome(s)&&(s.dragging=!1)}}),r&&this._hoveredManipulators.forEach(function(e,r){var i=e.key;if(a(i)){n._hoveredManipulators.delete(r);var s=n._findManipulatorByKey(i,t);o.isSome(s)&&(s.hovering=!1)}}),this._updateCursor(t)},e.prototype._intersect=function(e,t,r){var i=null;return r(function(r){if(null==r.manipulators||!a.areToolManipulatorsEditable(r))return!1;var n=r.manipulators.intersect(e,t);return!o.isNone(n)&&(i={manipulatorId:n,tool:r},!0)}),i},e.prototype.handleHoverEvent=function(e,t){if(("pointer-up"===e.type||"immediate-click"===e.type||"pointer-move"===e.type)&&s(e.pointerType)){var r=o.applySome(this._hoveredManipulators.get(e.pointerId),function(e){return e.key}),i=this._findManipulatorByKey(r,t),a=this._intersect(n.createScreenPointFromEvent(e),e.pointerType,t),l=this._findManipulatorByKey(a,t);o.isSome(l)&&!l.interactive&&(l=null),i!==l&&(o.isSome(i)&&(i.hovering=!1),o.isSome(l)?(l.hovering=!0,this._hoveredManipulators.set(e.pointerId,{key:o.expect(a)})):this._hoveredManipulators.delete(e.pointerId),this._updateCursor(t))}},e.prototype._findManipulatorByKey=function(e,t){return this._findToolAndManipulatorByKey(e,t,c)?c.manipulator:null},e.prototype._findToolAndManipulatorByKey=function(e,t,r){return o.isNone(e)?null:(r.tool=null,r.manipulator=null,t(function(t){if(t!==e.tool||null==t.manipulators||!a.areToolManipulatorsEditable(t))return!1;var i=t.manipulators.findById(e.manipulatorId);return!!o.isSome(i)&&(r.manipulator=i,r.tool=t,!0)}),null!=r.manipulator)},e}();t.default=u;var c={manipulator:null,tool:null}});