// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../core/Accessor","../../core/arrayUtils","../../core/Handles","../../core/Logger","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/heightModelInfoUtils","../../geometry/support/webMercatorUtils","@dojo/framework/shim/Promise"],function(e,t,i,n,o,r,a,s,l,u,d,p,c,f,h){function g(e){return e?JSON.stringify(e.toJSON()):"undefined"}function _(e){switch(e){case 0:return"Waiting";case 1:return"Found";case 2:return"Exhausted"}return"Unknown: "+e}var y=u.getLogger("esri.views.support.DefaultsFromMap");return function(t){function a(){var e=null!==t&&t.apply(this,arguments)||this;return e._handles=new l,e._waitTask=null,e._extentProjectController=null,e._spatialReferenceCandidates=null,e._extentCandidates=null,e.logDebugInformation=!1,e.isSpatialReferenceDone=!1,e.isTileInfoDone=!1,e.isHeightModelInfoSearching=!1,e.spatialReference=null,e.extent=null,e.heightModelInfo=null,e.vcsWkid=null,e.latestVcsWkid=null,e.mapCollectionPaths=u.DefaultMapCollectionPaths.slice(),e.tileInfo=null,e}i(a,t),u=a,a.prototype.initialize=function(){var e=this;this.watch("mapCollectionPaths",function(){e._running&&(e.reset(),e.start())})},a.prototype.destroy=function(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null),this._cancelLoading()},Object.defineProperty(a.prototype,"_running",{get:function(){return!!(this._handles&&this._handles.size>0)},enumerable:!0,configurable:!0}),a.prototype.reset=function(){this._handles.removeAll(),this._set("isSpatialReferenceDone",!1),this._set("isTileInfoDone",!1),this._set("isHeightModelInfoSearching",!1),this._set("spatialReference",null),this._set("extent",null),this._set("heightModelInfo",null),this._set("vcsWkid",null),this._set("latestVcsWkid",null),this._set("tileInfo",null),this._spatialReferenceCandidates=null,this._extentCandidates=null},a.prototype.start=function(){var e=this;this._handles.removeAll();for(var t=this._updateLayerChange.bind(this),i=0,n=this.mapCollectionPaths;i<n.length;i++){var o=n[i];this._handles.add(p.on(this.view,"map."+o,"change",t,t,t,!0))}this._handles.add(p.when(this,"isSpatialReferenceDone",function(){return e._updateTileInfo()},!0))},a.prototype._ownerNameFromCollectionName=function(e){var t=e.lastIndexOf(".");return-1===t?"view":"view."+e.slice(0,t)},a.prototype._ensureLoadedOwnersFromCollectionName=function(e){for(var t,i=this._ownerNameFromCollectionName(e),n=i.split("."),o=0;o<n.length&&(t=this.get(n.slice(0,o+1).join(".")));o++)if(t.load&&!t.isFulfilled())return{collectionName:e,owner:null,loading:t.load()};return{collectionName:e,owner:t}},a.prototype._cancelLoading=function(){this._waitTask=null,this._extentProjectController&&(this._extentProjectController.abort(),this._extentProjectController=null)},a.prototype._updateWhen=function(e){var t=this,i=!0,n=!1,o=e.catch(function(){}).then(function(){i?n=!0:o===t._waitTask&&t._update()});return i=!1,n||(this._waitTask=o),n},a.prototype._updateLayerChange=function(){this.isSpatialReferenceDone&&!this.spatialReference&&this._set("isSpatialReferenceDone",!1),this._update()},a.prototype._update=function(){var e=this;if(this._cancelLoading(),this.view){if(!this.isSpatialReferenceDone){this._debugLog("Starting search for spatial reference...");var t=this._processMapCollections(function(t){return e._processSpatialReferenceSource(t)});if(this._debugLog("Search ended with status '"+_(t)+"'"),0!==t){var i=null,n=this._spatialReferenceCandidates;if(!n||n.length<1?(i=this.defaultSpatialReference,this._debugLog("No spatial reference found, locking to default ("+g(i)+")")):(this.defaultSpatialReference&&n.length>1&&s.findIndex(n,function(t){return t.equals(e.defaultSpatialReference)})>-1&&(n=[this.defaultSpatialReference]),i=n[0],this._debugLog("Locking to "+g(i))),this._set("spatialReference",i),i)if(this.extent)this._set("isSpatialReferenceDone",!0);else{var o=this.logDebugInformation;this.logDebugInformation=!1,this._processMapCollections(function(t){return e._findExtent(t,i)}),this.logDebugInformation=o,this._projectExtentCandidate().catch().then(function(){return e._set("isSpatialReferenceDone",!0)})}else this._set("isSpatialReferenceDone",!0)}}if(null==this.heightModelInfo&&this.view.isHeightModelInfoRequired){this._debugLog("Starting search for height model info...");var r=this._processMapCollections(function(t){return e._processHeightModelInfoSource(t)},function(e){return f.mayHaveHeightModelInfo(e)});this._debugLog("Search ended with status "+_(r)),this._set("isHeightModelInfoSearching",0===r)}this._updateTileInfo()}},a.prototype._processMapCollections=function(e,t){var i=this;this._preloadMapCollections(t);var n=2;return this._forAllMapCollectionSources(function(e){if(2!==n)return!1;var t=e.collectionName;return i._debugLog("Processing collection "+t+"..."),!(e.loading&&!i._updateWhen(e.loading))||(i._debugLog("Collection "+e.collectionName+" owner is loading -> wait"),n=0,!1)},function(o){return 2===n&&(null==t||t(o)?!o.load||o.isFulfilled()||i._updateWhen(o.load())?!((!o.load||o.isResolved())&&e(o)&&(n=1,1)):(i._debugLog("Source "+o.id+" is loading -> wait"),n=0,!1):(i._debugLog("Source "+o.id+" is skipped due to predicate"),!1))}),n},a.prototype._preloadMapCollections=function(e){var t=this,i=10,n=this.logDebugInformation;this.logDebugInformation=!1,this._forAllMapCollectionSources(function(){return!0},function(o){return 0!==i&&(!(null!=e&&!e(o))&&(o.load&&!o.isFulfilled()&&(t.logDebugInformation=n,t._debugLog("Pre-loading source "+o.id),t.logDebugInformation=!1,o.load(),i--),!0))}),this.logDebugInformation=n},a.prototype._forAllMapCollectionSources=function(e,t){for(var i=0,n=this.mapCollectionPaths;i<n.length;i++){var o=n[i],r="map."+o,a=this._ensureLoadedOwnersFromCollectionName(r);if(!1!==e(a)){var s=a.owner;if(!s||s.isRejected&&s.isRejected())this._debugLog("Collection "+r+" owner is invalid or rejected -> skip");else{var l=this.view.get(r);l?this._forEachSource(l,t):this._debugLog("Collection "+r+" does not exist -> skip")}}}},a.prototype._forEachSource=function(e,t){for(var i=0,n=e.items;i<n.length;i++){var o=n[i];!1!==t(o)&&("layers"in o&&o.layers&&this._forEachSource(o.layers,t))}},a.prototype._processSpatialReferenceSource=function(e){var t=this._getSupportedSpatialReferences(e);return 0!==t.length&&(this._spatialReferenceCandidates?(t=s.intersect(t,this._spatialReferenceCandidates,function(e,t){return e.equals(t)}),t.length>0?this._spatialReferenceCandidates=t:this._debugLog("Layer "+e.id+" is ignored because its supported spatial\n          references are not compatible with the previous candidates")):this._spatialReferenceCandidates=t,1===this._spatialReferenceCandidates.length)},a.prototype._findExtent=function(e,t){var i="fullExtents"in e&&e.fullExtents||(e.fullExtent?[e.fullExtent]:[]),n=s.find(i,function(e){return e.spatialReference.equals(t)});if(n)return this._set("extent",n),!0;if(this._getSupportedSpatialReferences(e).length>0){var o=i.map(function(t){return{extent:t,layer:e}}),r=this._extentCandidates||[];this._extentCandidates=r.concat(o)}return!1},a.prototype._projectExtentCandidate=function(){return r(this,void 0,void 0,function(){var t,i,n,r,a,l;return o(this,function(o){switch(o.label){case 0:return this._extentCandidates&&this._extentCandidates.length?(t=this.spatialReference,(i=s.find(this._extentCandidates,function(e){return h.canProject(e.extent.spatialReference,t)}))?(this._set("extent",h.project(i.extent,t)),[3,7]):[3,1]):[2];case 1:return n=this._extentCandidates[0],this._extentProjectController=d.createAbortController(),[4,new Promise(function(t,i){e(["../../portal/support/geometryServiceUtils"],t,i)})];case 2:r=o.sent(),o.label=3;case 3:return o.trys.push([3,5,,6]),[4,r.projectGeometry(n.extent,t,n.layer.portalItem,this._extentProjectController.signal)];case 4:return a=o.sent(),this._set("extent",a),[3,6];case 5:return l=o.sent(),[3,6];case 6:this._extentProjectController=null,o.label=7;case 7:return[2]}})})},a.prototype._getSupportedSpatialReferences=function(e){var t=this,i="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===i.length)return this._debugLog("Layer "+e.id+" is ignored because it does not have any spatial references"),[];var n=i.filter(function(i){return t.view.isSpatialReferenceSupported(i,e,function(e){return t._debugLog(e)})});return 0===n.length?this._debugLog("Layer "+e.id+" has spatial references but none of them are supported (or layer doesn't require locking)"):this._debugLog("Layer "+e.id+" has spatial references. Resulting candidate set: "+n.map(g).join(", ")),n},a.prototype._processHeightModelInfoSource=function(e){var t=f.deriveHeightModelInfoFromLayer(e);return!!t&&(this._set("heightModelInfo",t),this._set("isHeightModelInfoSearching",!1),e.spatialReference&&(this._set("vcsWkid",e.spatialReference.vcsWkid),this._set("latestVcsWkid",e.spatialReference.latestVcsWkid)),!0)},a.prototype._updateTileInfo=function(){if(null==this.tileInfo){if(!this.view.isTileInfoRequired())return void this._set("isTileInfoDone",!0);if(this.isSpatialReferenceDone){var e=this.get("view.map");if(!e)return void this._debugLog("updateTileInfo: no map");var t=e.basemap,i=e.get("layers.0"),n=null;if(t&&"failed"!==t.loadStatus){if(!t.loaded)return this._updateWhen(t.load()),void this._debugLog("updateTileInfo: basemap still loading");var o=t&&t.get("baseLayers.0");if(o&&"failed"!==o.loadStatus){if(!o.loaded)return this._updateWhen(o.load()),void this._debugLog("updateTileInfo: first basemap layer still loading");n="tileInfo"in o&&o.tileInfo}else{if(!i||"failed"===i.loadStatus)return;if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog("updateTileInfo: first operational layer still loading");n="tileInfo"in i&&i.tileInfo}}else if(i&&"failed"!==i.loadStatus){if(!i.loaded)return this._updateWhen(i.load()),void this._debugLog("updateTileInfo: first operational layer still loading");n="tileInfo"in i&&i.tileInfo}n&&!n.spatialReference.equals(this.spatialReference)&&(n=null),this._debugLog("updateTileInfo: setting "+n),this._set("tileInfo",n),this._set("isTileInfoDone",!0)}}},a.prototype._debugLog=function(e){this.logDebugInformation&&y.info(e)};var u;return a.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"],n([c.property()],a.prototype,"logDebugInformation",void 0),n([c.property({readOnly:!0})],a.prototype,"isSpatialReferenceDone",void 0),n([c.property({readOnly:!0})],a.prototype,"isTileInfoDone",void 0),n([c.property({readOnly:!0})],a.prototype,"isHeightModelInfoSearching",void 0),n([c.property({constructOnly:!0})],a.prototype,"view",void 0),n([c.property({readOnly:!0})],a.prototype,"spatialReference",void 0),n([c.property({readOnly:!0})],a.prototype,"extent",void 0),n([c.property({readOnly:!0})],a.prototype,"heightModelInfo",void 0),n([c.property({readOnly:!0})],a.prototype,"vcsWkid",void 0),n([c.property({readOnly:!0})],a.prototype,"latestVcsWkid",void 0),n([c.property()],a.prototype,"mapCollectionPaths",void 0),n([c.property()],a.prototype,"defaultSpatialReference",void 0),n([c.property({readOnly:!0})],a.prototype,"tileInfo",void 0),a=u=n([c.subclass("esri.views.support.DefaultsFromMap")],a)}(c.declared(a))});