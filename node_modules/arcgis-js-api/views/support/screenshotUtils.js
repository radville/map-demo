// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/compilerUtils","../../core/mathUtils"],function(t,e,i,a,h){function r(t,e){var i=t||{},a=i.format,r=i.quality,o=i.rotation,n=i.disableSlice,l=v(t,e.padding),g={width:e.width-l.left-l.right,height:e.height-l.top-l.bottom},d=s(t,g),u=m(t,d),f=u.width,w=u.height,c=y(a),M=U[c];return{format:c,quality:h.clamp(null!=r?r:M,0,100),area:d,width:f,height:w,rotation:o,disableSlice:!!n,ignoreBackground:!(!t||!t.ignoreBackground),ignorePadding:!(!t||!t.ignorePadding)}}function o(t,e){var i=r(t,e),a=i.area,h=i.width/a.width,o=v(i,e.padding),n=o.left+o.right,l=o.top+o.bottom,g=e.width-n,d=e.height-l,u=Math.floor(g*h+n),f=Math.floor(d*h+l),w=t&&t.layers?t.layers:[],c=i.ignoreBackground,m=i.ignorePadding;return{framebufferWidth:u,framebufferHeight:f,region:{x:Math.floor(a.x*h)+o.left,y:Math.floor(a.y*h)+o.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:h,layers:w,disableSlice:i.disableSlice,ignoreBackground:c,ignorePadding:m}}function n(t,e,i,a){a.premultipliedAlpha&&b(t),i.width=t.width,i.height=t.height;var h=i.getContext("2d");h.putImageData(t,0,0),a.flipY&&x(h);var r=h.getImageData(0,0,t.width,t.height),o=l(i,e);return i.width=0,i.height=0,{dataUrl:o,data:r}}function l(t,e){var i=R[e.format],a=e.quality/100;return t.toDataURL(i,a)}function g(t,e,i){if(!t||!e)throw new Error("Cannot construct image data without dimensions");if(q)try{return new ImageData(t,e)}catch(t){q=!1}return w(t,e,i)}function d(t,e,i,a){if(!e||!i)throw new Error("Cannot construct image data without dimensions");if(q)try{return new ImageData(t,e,i)}catch(t){q=!1}var h=w(e,i,a);return h.data.set(t,0),h}function u(t,e,i,a,h,r,o,n){void 0===a&&(a=0),void 0===h&&(h=0),void 0===r&&(r=t.width-a),void 0===o&&(o=t.height-h),void 0===n&&(n=!1);for(var l=t.data,g=e.width,d=e.height,u=e.data,f=r/g,w=o/d,c=Math.ceil(f/2),m=Math.ceil(w/2),s=t.width,M=0;M<d;M++)for(var p=0;p<g;p++){for(var v=4*(p+(n?d-M-1:M)*g),y=0,x=0,b=0,j=0,S=0,D=0,I=(M+.5)*w,q=Math.floor(M*w);q<(M+1)*w;q++)for(var R=Math.abs(I-(q+.5))/m,P=(p+.5)*f,U=R*R,C=Math.floor(p*f);C<(p+1)*f;C++){var H=Math.abs(P-(C+.5))/c,k=Math.sqrt(U+H*H);if(!(k>=1)){var B=2*k*k*k-3*k*k+1,E=4*(a+C+(h+q)*s);D+=B*l[E+3],x+=B,!i&&l[E+3]<255&&(B=B*l[E+3]/255),b+=B*l[E],j+=B*l[E+1],S+=B*l[E+2],y+=B}}u[v]=b/y,u[v+1]=j/y,u[v+2]=S/y,u[v+3]=D/x}return e}function f(t,e,a){if(!e)return t;var h=t.framebufferWidth,r=t.framebufferHeight,o=t.pixelRatio,n=t.region,l=v(t,a),g=l.left+l.right,d=l.top+l.bottom,u=h-g,f=r-d,w=Math.min(D,Math.min((j-g)/u,(j-d)/f));return w<S?t:i({},t,{framebufferWidth:Math.round(u*w)+g,framebufferHeight:Math.round(f*w)+d,pixelRatio:o*w,resample:{region:{x:Math.round((n.x-l.left)*w)+l.left,y:Math.round((n.y-l.top)*w)+l.top,width:Math.round(n.width*w),height:Math.round(n.height*w)},width:h,height:r}})}function w(t,e,i){return i||(i=c()),i.getContext("2d").createImageData(t,e)}function c(){return I||(I=document.createElement("canvas"),I.width=1,I.height=1),I}function m(t,e){if(!t)return e;var i=t.width,a=t.height;if(null!=i&&null!=a)return{width:Math.floor(i),height:Math.floor(a)};if(null==i&&null==a)return e;var h=e.width/e.height;return null==a?{width:Math.floor(i),height:Math.floor(i/h)}:{width:Math.floor(a*h),height:Math.floor(a)}}function s(t,e){var i={x:0,y:0,width:e.width,height:e.height};if(t&&t.area){null!=t.area.x&&(i.x=Math.floor(t.area.x)),null!=t.area.y&&(i.y=Math.floor(t.area.y));var a=null!=t.area.width?Math.floor(t.area.width):null,h=null!=t.area.height?Math.floor(t.area.height):null;if(i.width=e.width-i.x,i.height=e.height-i.y,null!=a&&null!=h)i.width=Math.min(i.width,a),i.height=Math.min(i.height,h);else if(null==a&&null!=h){var r=Math.min(i.width,a);i.height=r/i.width*i.height,i.width=r}else if(null!=a&&null==h){var o=Math.min(i.height,h);i.width=o/i.height*i.width,i.height=o}}return M(p(i,t),e)}function M(t,e){var i=Math.floor(Math.max(t.x,0)),a=Math.floor(Math.max(t.y,0)),h=Math.floor(Math.min(t.width,e.width-i)),r=Math.floor(Math.min(t.height,e.height-a)),o={x:i,y:a,width:h,height:r},n=o.width/o.height,l=t.width/t.height;if(l===n)return o;if(l>n){var g=Math.floor(o.width/l),d=o.height-g;return{x:o.x,y:Math.floor(o.y+d/2),width:o.width,height:g}}var u=Math.floor(o.height*l),f=o.width-u;return{x:Math.floor(o.x+f/2),y:o.y,width:u,height:o.height}}function p(t,e){if(!e||null==e.width||null==e.height)return t;var i=e.width/e.height,a=t.width/t.height;if(a===i)return t;if(a<i){var h=Math.floor(t.height*i);return t.x-=(h-t.width)/2,t.width=h,t}var r=Math.floor(t.width/i);return t.y-=(r-t.height)/2,t.height=r,t}function v(t,e){return!e||t&&t.ignorePadding?C:e}function y(t){switch(t){case"png":case"jpg":case"jpeg":return t;case null:case void 0:return P;default:return a.neverReached(t),P}}function x(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}function b(t){for(var e=t.data,i=e.length,a=0;a<i;a+=4){var h=e[a+3];if(h>0){var r=h/255;e[a+0]=e[a+0]/r,e[a+1]=e[a+1]/r,e[a+2]=e[a+2]/r}}}Object.defineProperty(e,"__esModule",{value:!0});var j=2048,S=1.5,D=8;e.completeUserSettings=r,e.toRenderSettings=o,e.encodeResult=n,e.toDataUrl=l,e.createEmptyImageData=g,e.wrapImageData=d,e.resampleHermite=u,e.screenshotSuperSampleSettings=f;var I=null,q=!0,R={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},P="jpg",U={png:100,jpg:98,jpeg:98},C={top:0,right:0,bottom:0,left:0}});