// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/Collection","../../core/Evented","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators","../LayerList/ListItem"],function(e,t,i,r,s,a,n,o,c,p){var m={view:"view",basemap:"basemap",baseLayers:"base-layers",referenceLayers:"reference-layers",baseLayersListMode:"reference-layers-list-mode",referenceLayersListMode:"base-layers-list-mode",baseLayerViews:"base-layer-views",referenceLayerViews:"reference-layer-views"},l=s.ofType(p);return function(e){function t(t){var i=e.call(this,t)||this;return i.baseItems=new l,i.basemapTitle=null,i.baseListItemCreatedFunction=null,i.referenceListItemCreatedFunction=null,i.referenceItems=new l,i.view=null,i._compileBaseList=i._compileBaseList.bind(i),i._compileReferenceList=i._compileReferenceList.bind(i),i}return i(t,e),t.prototype.initialize=function(){var e=this;this.handles.add(o.init(this,["view.map.basemap","view","view.ready","view.basemapView"],function(){return e._watchBasemapLayers()}),m.view)},t.prototype.destroy=function(){this.view=null,this.baseItems.removeAll(),this.referenceItems.removeAll()},Object.defineProperty(t.prototype,"state",{get:function(){return this.get("view.ready")?"ready":this.get("view")?"loading":"disabled"},enumerable:!0,configurable:!0}),t.prototype.triggerAction=function(e,t){e&&this.emit("trigger-action",{action:e,item:t})},t.prototype.transferListItem=function(e){var t=e.listItem,i=e.from,r=e.to,s=e.newIndex,a=this,n=a.referenceItems,o=a.baseItems,c=t.layer,p=this.get("view.map.basemap.baseLayers"),m=this.get("view.map.basemap.referenceLayers");if(p&&m&&i!==r){var l="reference"===i?n:o,y="reference"===r?n:o,f="reference"===i?m:p,d="reference"===r?m:p;l.remove(t),f.remove(c),y.add(t,s),d.add(c,s)}},t.prototype._createItemChangeHandles=function(e){var t=e.items,i=e.key,r=e.callback,s=this.handles;s.remove(i),r(),t&&s.add(t.on("change",function(){return r()}),i)},t.prototype._watchItemProperties=function(e){var t=this,i=e.item,r=e.type;this.handles.add([i.children.on("change",function(){t._modifyListItemChildren({type:r,childItems:i.children})})],"children-change-"+i.uid)},t.prototype._modifyListItemChildren=function(e){var t=this,i=e.childItems,r=e.type;i.forEach(function(e){return t._modifyListItem({type:r,item:e})})},t.prototype._modifyListItem=function(e){var t=e.item,i=e.type,r={item:t};"base"===i&&"function"==typeof this.baseListItemCreatedFunction&&this.baseListItemCreatedFunction.call(null,r),"reference"===i&&"function"==typeof this.referenceListItemCreatedFunction&&this.referenceListItemCreatedFunction.call(null,r),this._modifyListItemChildren({type:i,childItems:t.children})},t.prototype._createListItem=function(e){var t=e.layer,i=e.type,r=this.view,s=new p({layer:t,view:r});return this._watchItemProperties({type:i,item:s}),s},t.prototype._watchLayersListMode=function(e){var t=e.layers,i=e.key,r=e.callback,s=this.handles;s.remove(i),t&&t.forEach(function(e){s.add(o.watch(e,"listMode",function(){return r()}),i)})},t.prototype._compileListItems=function(e){var t=e.layers,i=e.items,r=e.key,s=e.type,a=e.callback;this._watchLayersListMode({layers:t,key:r,callback:a}),this._createNewItems({type:s,items:i,layers:t}),this._modifyOrRemoveItems({type:s,items:i,layers:t}),this._sortItems(i,t)},t.prototype._compileReferenceList=function(){var e=this.referenceItems,t=this.get("view.map.basemap.referenceLayers");this._compileListItems({type:"reference",layers:t,items:e,key:m.referenceLayersListMode,callback:this._compileReferenceList})},t.prototype._compileBaseList=function(){var e=this.baseItems,t=this.get("view.map.basemap.baseLayers");this._compileListItems({type:"base",layers:t,items:e,key:m.baseLayersListMode,callback:this._compileBaseList})},t.prototype._compileLists=function(){this._compileReferenceList(),this._compileBaseList()},t.prototype._createNewItems=function(e){var t=this,i=e.items,r=e.layers,s=e.type;r&&r.forEach(function(e){i.find(function(t){return t.layer===e})||i.add(t._createListItem({type:s,layer:e}))})},t.prototype._modifyOrRemoveItems=function(e){var t=this,i=e.items,r=e.layers,s=e.type,a=this.handles;i&&i.forEach(function(e){if(e){r.find(function(t){return e.layer===t})?t._modifyListItem({type:s,item:e}):(a.remove("children-change-"+e.uid),i.remove(e))}})},t.prototype._sortItems=function(e,t){e&&e.sort(function(e,i){var r=t.indexOf(e.layer),s=t.indexOf(i.layer);return r>s?-1:r<s?1:0})},t.prototype._watchBasemapLayers=function(){var e=this,t=this,i=t.handles,r=t.view;i.remove([m.baseLayers,m.referenceLayers,m.basemap,m.baseLayerViews,m.referenceLayerViews]),this._compileLists(),r&&r.ready&&i.add([o.init(this,"view.map.basemap.baseLayers",function(t){return e._createItemChangeHandles({items:t,key:m.baseLayers,callback:e._compileBaseList})}),o.init(this,"view.map.basemap.referenceLayers",function(t){return e._createItemChangeHandles({items:t,key:m.referenceLayers,callback:e._compileReferenceList})}),o.init(this,"view.basemapView.baseLayerViews",function(t){return e._createItemChangeHandles({items:t,key:m.baseLayerViews,callback:e._compileBaseList})}),o.init(this,"view.basemapView.referenceLayerViews",function(t){return e._createItemChangeHandles({items:t,key:m.referenceLayerViews,callback:e._compileReferenceList})}),o.init(this,"baseListItemCreatedFunction",function(){return e._compileBaseList()}),o.init(this,"referenceListItemCreatedFunction",function(){return e._compileReferenceList()})],m.basemap)},r([c.property({type:l})],t.prototype,"baseItems",void 0),r([c.aliasOf("view.map.basemap.title")],t.prototype,"basemapTitle",void 0),r([c.property()],t.prototype,"baseListItemCreatedFunction",void 0),r([c.property()],t.prototype,"referenceListItemCreatedFunction",void 0),r([c.property({type:l})],t.prototype,"referenceItems",void 0),r([c.property({dependsOn:["view.ready"],readOnly:!0})],t.prototype,"state",null),r([c.property()],t.prototype,"view",void 0),r([c.property()],t.prototype,"transferListItem",null),t=r([c.subclass("esri.widgets.BasemapLayerList.BasemapLayerListViewModel")],t)}(c.declared(n.HandleOwnerMixin(a.EventedAccessor)))});