// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../nls/DatePicker","../../../intl","../../../moment","../../../core/events","../../../core/accessorSupport/decorators","../../Widget","./DatePickerViewModel","../../support/Popover","../../support/widget"],function(e,t,r,a,o,i,s,n,c,d,l,h,u){var _={base:"esri-date-picker",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",openIcon:"esri-icon-down-arrow",closeIcon:"esri-icon-up-arrow",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",widget:"esri-widget",button:"esri-widget--button",select:"esri-select"},p={year:"numeric",month:"2-digit",day:"2-digit"},y=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"],v="onfocusout"in HTMLElement.prototype;return function(e){function t(t){var r=e.call(this,t)||this;return r._activeDate=null,r._calendarNode=null,r._calendarPopover=new h({owner:r,placement:"bottom-start",anchorElement:function(){return r._rootNode},renderContentFunction:r._renderCalendar}),r._closedByUserAction=!1,r._isOpen=!1,r._rootNode=null,r.value=null,r.commitOnMonthChange=!1,r.viewModel=new l,r._handleDatePickerBlur=v?null:r._handleDatePickerBlurOrFocusOut,r._handleDatePickerFocusOut=v?r._handleDatePickerBlurOrFocusOut:null,r}return r(t,e),t.prototype.destroy=function(){this._calendarPopover.destroy()},t.prototype.render=function(){var e,t=i.formatDate(this.viewModel.value.valueOf(),p),r=this._isOpen,a=(e={},e[_.openIcon]=!r,e[_.closeIcon]=r,e);return u.tsx("div",{afterCreate:u.storeNode,bind:this,class:this.classes(_.base,_.widget),"data-node-ref":"_rootNode"},u.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-pressed":r.toString(),bind:this,class:this.classes(_.button,_.datePickerToggle),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},u.tsx("span",{class:_.date},t),u.tsx("span",{"aria-hidden":"true",class:this.classes(a)})))},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){"Escape"===n.eventKey(e)&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendar=function(){var e=this._activeDate,t=this.get("viewModel.value");return u.tsx("div",{afterCreate:u.storeNode,bind:this,class:this.classes(_.datePicker,_.widget),"data-node-ref":"_calendarNode",key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._handleDatePickerBlurOrFocusOut=function(e){if(e.currentTarget===e.target){var t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()}},t.prototype._renderMonthPicker=function(e){var t=u.isRTL(),r=t?_.nextIcon:_.previousIcon,a=t?_.previousIcon:_.nextIcon,i=s.months().map(function(t,r){var a=e.month()===r;return u.tsx("option",{selected:a},t)});return u.tsx("div",{class:_.monthPicker},u.tsx("div",{"aria-label":o.goToPreviousMonth,bind:this,class:_.button,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:o.goToPreviousMonth},u.tsx("span",{"aria-hidden":"true",class:r})),u.tsx("select",{"aria-live":"assertive",bind:this,class:this.classes(_.monthDropdown,_.select),id:this.id+"__month-picker",onblur:this._handleDatePickerBlur,onchange:this._setMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setMonth},i),u.tsx("div",{"aria-label":o.goToNextMonth,bind:this,class:_.button,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:o.goToNextMonth},u.tsx("span",{"aria-hidden":"true",class:a})))},t.prototype._renderDayPicker=function(e,t){var r=this,a=e.clone().day(s.localeData().firstDayOfWeek()),o=this._getWeekLabels(a),i=this._getDayId(e),n=this._renderMonth(e,t);return u.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,class:_.dayPicker,id:this.id+"__day-picker",onblur:this._handleDatePickerBlur,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},u.tsx("div",{class:_.week,role:"row"},o.map(function(e){return u.tsx("div",{"aria-label":e.name,class:r.classes(_.day,_.dayHeader),role:"columnheader",title:e.name},e.abbr)})),n)},t.prototype._getDayId=function(e){return this.id+"__"+i.formatDate(e.valueOf(),p)},t.prototype._handleDayPickerCreate=function(e){e.focus()},t.prototype._getWeekLabels=function(e){for(var t=[],r={weekday:"long"},a={weekday:"narrow"},o=0;o<7;o++)t.push({name:i.formatDate(e.valueOf(),r),abbr:i.formatDate(e.valueOf(),a)}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.ctrlKey,r=e.shiftKey,a=n.eventKey(e),o=this._activeDate;if(-1!==y.indexOf(a)){if("ArrowLeft"===a)o.subtract(1,"day");else if("ArrowRight"===a)o.add(1,"day");else if("ArrowUp"===a)o.subtract(1,"week");else if("ArrowDown"===a)o.add(1,"week");else if("PageUp"===a){var i=r?"year":"month";o.subtract(1,i)}else if("PageDown"===a){var i=r?"year":"month";o.add(1,i)}else if("Home"===a){var i=t?"year":"month";o.startOf(i)}else if("End"===a){var i=t?"year":"month";o.endOf(i)}else"Enter"!==a&&" "!==a||(this.viewModel.value=o.clone(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderMonth=function(e,t){for(var r,a=s(),o=e.clone().startOf("month"),i=e.clone().endOf("month"),n=o.clone().subtract(o.weekday(),"day"),c=n,d=[],l=0;l<6;l++){for(var h=[],p=0;p<7;p++){var y=c.date(),v=c.isSame(e,"day"),k=c.isSame(t,"day"),f=this._getDayId(c),D=(r={},r[_.nearbyMonth]=!c.isBetween(o,i,null,"[]"),r[_.today]=c.isSame(a,"day"),r[_.activeDay]=v,r[_.selectedDay]=k,r);h.push(u.tsx("div",{"aria-label":y.toString(),"aria-selected":v.toString(),bind:this,class:this.classes(_.day,D),"data-iso-date":c.toISOString(),id:f,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},y)),c.add(1,"day")}d.push(u.tsx("div",{class:_.week,role:"row"},h))}return d},t.prototype._renderYearPicker=function(e){var t={year:"numeric"},r=e.clone(),a=i.formatDate(r.valueOf(),t),s=i.formatDate(r.add(1,"year").valueOf(),t),n=i.formatDate(r.subtract(2,"year").valueOf(),t);return u.tsx("div",{class:_.yearPicker},u.tsx("div",{"aria-label":o.goToPreviousYear,bind:this,class:_.year,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setPreviousYear,tabIndex:0,title:o.goToPreviousYear},n),u.tsx("div",{class:this.classes(_.year,_.selectedYear),id:this.id+"__selected-year"},a),u.tsx("div",{"aria-label":o.goToNextYear,bind:this,class:_.year,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onfocusout:this._handleDatePickerFocusOut,onkeydown:this._setNextYear,tabIndex:0,title:o.goToNextYear},s))},t.prototype._toggle=function(){if(this._isOpen)return void this._close();this._open(this.viewModel.value.clone())},t.prototype._setMonth=function(e){var t=e.target,r=t.value;this._activeDate.month(r),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate)},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1},t.prototype._open=function(e){this._activeDate=e,this._isOpen=!0,this._calendarPopover.open=!0},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate)},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month"),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate)},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=s(t.getAttribute("data-iso-date")),this._closedByUserAction=!0,this._close()},a([c.aliasOf("viewModel.value")],t.prototype,"value",void 0),a([c.property({type:l}),u.renderable("viewModel.value")],t.prototype,"viewModel",void 0),a([u.accessibleHandler()],t.prototype,"_toggle",null),a([u.accessibleHandler()],t.prototype,"_setPreviousMonth",null),a([u.accessibleHandler()],t.prototype,"_setNextMonth",null),a([u.accessibleHandler()],t.prototype,"_setPreviousYear",null),a([u.accessibleHandler()],t.prototype,"_setNextYear",null),a([u.accessibleHandler()],t.prototype,"_handleSelectedDate",null),t=a([c.subclass("esri.widgets.Directions.support.DatePicker")],t)}(c.declared(d))});