// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","@dojo/framework/shim/Map","dojo/i18n!../nls/common","dojo/i18n!./Editor/nls/Editor","dojo/i18n!./FeatureTemplates/nls/FeatureTemplates","../intl","../core/events","../core/HandleOwner","../core/watchUtils","../core/accessorSupport/decorators","./FeatureForm","./FeatureTemplates","./Spinner","./Widget","./Editor/EditorViewModel","./FeatureTemplates/ItemList","./support/widget"],function(e,t,r,i,n,a,o,s,l,d,c,u,p,f,w,h,v,y,g,_,m){function b(e){e.focus()}var k={base:"esri-editor esri-widget",header:"esri-editor__header",scroller:"esri-editor__scroller",content:"esri-editor__content",contentWrapper:"esri-editor__temp-wrapper",message:"esri-editor__message",controls:"esri-editor__controls",title:"esri-editor__title",backButton:"esri-editor__back-button",modeSelection:"esri-editor__mode-selection",progressBar:"esri-editor__progress-bar",warningCard:"esri-editor__warning-card",warningHeader:"esri-editor__warning-header",warningHeading:"esri-editor__warning-heading",warningMessage:"esri-editor__warning-message",warningDivider:"esri-editor__warning-divider",warningOption:"esri-editor__warning-option",warningOptionPrimary:"esri-editor__warning-option--primary",warningOptionNegative:"esri-editor__warning-option--negative",warningOptionPositive:"esri-editor__warning-option--positive",featureList:"esri-editor__feature-list",featureListItem:"esri-editor__feature-list-item",featureListItemDisabled:"esri-editor__feature-list-item--disabled",featureListName:"esri-editor__feature-list-name",featureListIcon:"esri-editor__feature-list-icon",featureListIndex:"esri-editor__feature-list-index",controlButton:"esri-editor__control-button",overlay:"esri-editor__overlay",errorIcon:"esri-icon-error2",basemapIcon:"esri-basemap",rightArrowIcon:"esri-icon-right",leftArrowIcon:"esri-icon-left",warningIcon:"esri-icon-notice-triangle",widgetIcon:"esri-icon-edit",button:"esri-button",buttonDisabled:"esri-button--disabled",buttonSecondary:"esri-button--secondary",buttonTertiary:"esri-button--tertiary",heading:"esri-heading",input:"esri-input",interactive:"esri-interactive",select:"esri-select"};return function(e){function t(t){var r=e.call(this,t)||this;return r._candidateCommitted=!1,r._featureForm=new w,r._featureTemplates=new h,r._filterText="",r._prompt=null,r._spinner=new v,r.activeWorkflow=null,r.allowedWorkflows=null,r.iconClass=k.widgetIcon,r.label=s.widgetLabel,r.layerInfos=null,r.supportingWidgetDefaults=null,r.view=null,r.viewModel=new g,r._setCandidateFeature=function(e,t){if(void 0===t&&(t=!1),!r._candidateCommitted){var i=r.viewModel.activeWorkflow;i.data.edits.feature=e,t&&(i.next(),r._candidateCommitted=!0)}},r._handleSave=r._handleSave.bind(r),r._handleBack=r._handleBack.bind(r),r._handleDone=r._handleDone.bind(r),r._handleDelete=r._handleDelete.bind(r),r._handleAdd=r._handleAdd.bind(r),r._handleEdit=r._handleEdit.bind(r),r}return r(t,e),t.prototype.postInitialize=function(){var e=this;this.own([p.init(this,"viewModel",function(t){e._featureForm.viewModel=t?t.featureFormViewModel:null,e._featureTemplates.viewModel=t?t.featureTemplatesViewModel:null,e._spinner.viewModel=t?t.spinnerViewModel:null}),p.init(this,"view",function(t,r){var i="editor-"+e.id+"-spinner";r&&r.ui.remove(e._spinner,i),t&&t.ui.add(e._spinner,{key:i,position:"manual"})}),p.on(this,"viewModel.sketchViewModel","create",function(){e.scheduleRender()}),p.on(this,"viewModel.activeWorkflow","cancel-request",function(t){var r=t.controller;e._prompt={title:s.cancelRequestTitle,message:s.cancelRequestWarningMessage,options:[{label:o.form.no,type:"neutral",action:function(){return r.deny(),e._prompt=null}},{label:o.form.yes,type:"negative",action:function(){r.allow(),e._prompt=null}}]},e.scheduleRender()}),p.init(this,"supportingWidgetDefaults",function(t){t&&(e._featureForm.set(t.featureForm),e._featureTemplates.set(t.featureTemplates),e.viewModel.sketchViewModel.set(t.sketch))}),p.watch(this,"viewModel.failures",function(t){if(t){var r=t[0],i=r.error,n=r.retry,a=r.cancel;e._prompt={title:s.errorWarningTitle,message:d.substitute(s.errorWarningMessageTemplate,{errorMessage:i.message}),options:[{label:s.retry,type:"positive",action:function(){n(),e._prompt=null}},{label:s.ignore,type:"neutral",action:function(){return a(),e._prompt=null}}]}}}),p.watch(this,"viewModel.state",function(t){"awaiting-update-feature-candidate"===t&&(e._candidateCommitted=!1)}),p.whenNot(this,"viewModel.activeWorkflow",function(){return e._featureTemplates.filterText=""})])},t.prototype.destroy=function(){this._featureForm.destroy(),this._featureTemplates.destroy()},t.prototype.startCreateWorkflowAtFeatureTypeSelection=function(){return this.viewModel.startCreateWorkflowAtFeatureTypeSelection()},t.prototype.startCreateWorkflowAtFeatureCreation=function(e){return this.viewModel.startCreateWorkflowAtFeatureCreation(e)},t.prototype.startCreateWorkflowAtFeatureEdit=function(e){return this.viewModel.startCreateWorkflowAtFeatureEdit(e)},t.prototype.startUpdateWorkflowAtFeatureSelection=function(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()},t.prototype.startUpdateWorkflowAtMultipleFeatureSelection=function(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)},t.prototype.startUpdateWorkflowAtFeatureEdit=function(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)},t.prototype.deleteFeatureFromWorkflow=function(){return this.viewModel.deleteFeatureFromWorkflow()},t.prototype.cancelWorkflow=function(e){return this.viewModel.cancelWorkflow(e)},t.prototype.render=function(){var e=this.viewModel;if(!e)return m.tsx("div",{class:k.base});var t=e.state,r=this._prompt?m.tsx("div",{class:k.overlay,key:"overlay"},this.renderPrompt({message:this._prompt.message,title:this._prompt.title,options:this._prompt.options})):null;return m.tsx("div",{class:k.base},this.viewModel.syncing?this.renderProgressBar():null,"disabled"===t?null:"ready"===t?this.renderLanding():"awaiting-feature-creation-info"===t?this.renderTemplates():"editing-new-feature"===t||"editing-existing-feature"===t?this.renderAttributeEditing():"awaiting-feature-to-update"===t?this.renderFeatureUpdating():"awaiting-update-feature-candidate"===t?this.renderFeatureList():"awaiting-feature-to-create"===t?this.renderFeatureCreation():null,r)},t.prototype.renderTemplates=function(){return m.tsx("div",{class:k.contentWrapper,key:"wrapper"},this.renderHeader(s.selectTemplate,!0),m.tsx("div",{key:"content",class:k.content},this._featureTemplates.render()))},t.prototype.renderAttributeEditing=function(){var e=this.viewModel,t=e.activeWorkflow,r=e.featureFormViewModel,i=t.data.edits.feature,n="update"===t.type&&!t.data.edits.modified||r.inputFields.length>0&&!r.valid,a="create"===t.type?o.add:o.update,l=[{label:a,type:"primary",disabled:n,clickHandler:this._handleSave}];"update"===t.type&&t.data.editableItem.supports.indexOf("delete")>-1&&l.push({label:o.delete,type:"tertiary",clickHandler:this._handleDelete});var c=this._getLabel(i);return m.tsx("div",{class:k.contentWrapper,key:"wrapper"},this.renderHeader(c,!0),m.tsx("div",{key:"content",class:this.classes(k.content,k.scroller)},r.inputFields.length>0?this._featureForm.render():this.renderMessage(d.substitute(s.clickToFinishTemplate,{button:a}))),this.renderControls(l))},t.prototype.renderFeatureUpdating=function(){return m.tsx("div",{class:k.contentWrapper,key:"wrapper"},this.renderHeader(s.selectFeature,!0),m.tsx("div",{key:"content",class:this.classes(k.content,k.scroller)},this.renderMessage(s.selectFeatureToEdit)))},t.prototype.renderMessage=function(e){return m.tsx("div",{class:k.message},e)},t.prototype.renderFeatureCreation=function(){var e=this.viewModel,t=e.sketchViewModel,r=e.activeWorkflow,i=r.data.creationInfo.layer,n=t.canUndo()&&t.createGraphic?t.createGraphic:null,a=this._getSketchingTip(i.geometryType,n);return m.tsx("div",{class:k.contentWrapper,key:"wrapper"},this.renderHeader(s.placeFeature,!0),m.tsx("div",{key:"content",class:this.classes(k.content,k.scroller)},this.renderMessage(a)))},t.prototype.renderControls=function(e){var t=this;return m.tsx("div",{class:k.controls,key:"controls"},e.map(function(e,r){var i=e.disabled,n=void 0!==i&&i,a=e.label,o=e.type,s=e.clickHandler;return t.renderButton({label:a,class:t.classes(k.controlButton,k.button,"secondary"===o?k.buttonSecondary:"tertiary"===o?k.buttonTertiary:null,n?k.buttonDisabled:null),disabled:n,clickHandler:s,key:r})}))},t.prototype.renderPrompt=function(e){var t=this,r=e.title,i=e.message,n=e.options,a=void 0===n?[]:n;return m.tsx("div",{class:k.warningCard,role:"alert"},m.tsx("div",{class:k.warningHeader},m.tsx("span",{class:k.warningIcon,"aria-hidden":"true"}),m.tsx("h4",{class:this.classes(k.heading,k.warningHeading)},r)),m.tsx("div",{class:k.warningMessage},i),m.tsx("div",{class:k.warningDivider}),a.map(function(e,r){var i=e.label,n=e.action,a=e.type,o=0===r;return m.tsx("div",{afterCreate:o?b:null,class:t.classes(k.warningOption,o?k.warningOptionPrimary:null,"positive"===a?k.warningOptionPositive:"negative"===a?k.warningOptionNegative:null),key:r,onclick:n,onkeydown:function(e){var t=c.eventKey(e);"Enter"!==t&&" "!==t||(e.preventDefault(),n.call(null))},tabIndex:0,role:"button"},i)}))},t.prototype.renderProgressBar=function(){return m.tsx("div",{class:this.classes(k.progressBar),key:"progress-bar"})},t.prototype.renderButton=function(e){return m.tsx("button",{class:e.class,disabled:e.disabled,key:e.key,onclick:e.clickHandler},e.label)},t.prototype.renderHeader=function(e,t){return void 0===t&&(t=!1),m.tsx("header",{class:k.header,key:"header"},t?m.tsx("div",{"aria-label":o.back,class:this.classes(k.backButton,k.interactive),key:"back-button",onclick:this._handleBack,onkeydown:this._handleBack,tabIndex:0,title:o.back},m.tsx("span",{"aria-hidden":"true",class:m.isRTL()?k.rightArrowIcon:k.leftArrowIcon})):null,m.tsx("h4",{class:this.classes(k.title,k.heading)},e))},t.prototype.renderLanding=function(){var e=this.viewModel,t=e.allowedWorkflows,r=e.canCreate,i=e.canUpdate,n=m.isRTL()?k.leftArrowIcon:k.rightArrowIcon;return m.tsx("div",{class:k.contentWrapper,key:"wrapper"},this.renderHeader(s.widgetLabel),m.tsx("div",{key:"content",class:k.content,role:"group"},m.tsx("div",{class:k.modeSelection,key:"mode-selection"},t.indexOf("update")>-1?m.tsx("div",{"aria-disabled":i?"false":"true",class:this.classes(k.featureListItem,i?null:k.featureListItemDisabled),key:"update",onclick:this._handleEdit,onkeydown:this._handleEdit,role:"button",tabIndex:i?0:-1},m.tsx("span",{class:k.featureListName},s.editFeature),m.tsx("span",{"aria-hidden":"true",class:this.classes(k.featureListIcon,n)})):null,t.indexOf("create")>-1?m.tsx("div",{class:this.classes(k.featureListItem,r?null:k.featureListItemDisabled),key:"create",onclick:this._handleAdd,onkeydown:this._handleAdd,role:"button",tabIndex:r?0:-1},m.tsx("span",{class:k.featureListName},s.addFeature),m.tsx("span",{"aria-hidden":"true",class:this.classes(k.featureListIcon,n)})):null)))},t.prototype.renderFeatureList=function(){var e=this,t=this.viewModel,r=t.editableItems,i=t.activeWorkflow,n=i,o=n.data.candidates,c=d.substitute(s.multipleFeaturesTemplate,{total:o.length}),u=new a.default;o.map(function(t){return{label:e._getLabel(t),id:t.attributes[t.layer.objectIdField],data:t}}).filter(function(t){var r=t.label,i=t.data,n=e._filterText.toLowerCase(),a=i.layer.title;return e.viewModel.editableItems.find(function(e){return e.layer===i.layer}).supports.indexOf("update")>-1&&(!n||r.toLowerCase().indexOf(n)>-1||a.toLowerCase().indexOf(n)>-1)}).forEach(function(e){var t=e.data.layer;if(!u.has(t))return void u.set(t,{id:t.id,label:t.title,items:[e]});u.get(t).items.push(e)});var p=r.filter(function(e){var t=e.layer;return u.has(t)}).map(function(e){var t=e.layer;return u.get(t)}).toArray();return m.tsx("div",{class:k.contentWrapper,key:"wrapper"},this.renderHeader(c,!0),m.tsx("div",{key:"content",class:this.classes(k.content,k.scroller)},_.ItemList({id:this.id,filterText:this._filterText,items:p,messages:{filterPlaceholder:l.filterPlaceholder,noItems:l.noItems,noMatches:l.noMatches},onItemMouseEnter:function(t){var r=t.data;return e._setCandidateFeature(r)},onItemMouseLeave:function(){return e._setCandidateFeature(null)},onItemSelect:function(t){var r=t.data;return e._setCandidateFeature(r,!0)},onFilterChange:function(t){return e._filterText=t}})))},t.prototype._getSketchingTip=function(e,t){if("point"===e)return s.tips.clickToAddPoint;if("polygon"===e||"polyline"===e){if(!t)return s.tips.clickToStart;var r=t.geometry,i="polygon"===e?"rings":"paths",n=r[i][0];return"polygon"===e&&n<4?s.tips.clickToContinue:s.tips.clickToContinueThenDoubleClickToEnd}return s.tips.clickToAddFeature},t.prototype._getLabel=function(e){var t=e.layer,r=t.displayField,i=t.objectIdField,n=e.attributes;return r&&n[r]||d.substitute(s.untitledFeatureTemplate,{id:n[i]})},t.prototype._handleDelete=function(){var e=this;this._prompt={title:s.deleteWarningTitle,message:s.deleteWarningMessage,options:[{label:s.keepFeature,type:"neutral",action:function(){return e._prompt=null}},{label:o.delete,type:"positive",action:function(){e.viewModel.deleteFeatureFromWorkflow(),e._prompt=null}}]}},t.prototype._handleSave=function(){this.viewModel.activeWorkflow.commit()},t.prototype._handleAdd=function(){this.viewModel.canCreate&&this.viewModel.startCreateWorkflowAtFeatureTypeSelection()},t.prototype._handleEdit=function(){this.viewModel.canUpdate&&this.viewModel.startUpdateWorkflowAtFeatureSelection()},t.prototype._handleDone=function(){this.viewModel.cancelWorkflow({force:!0})},t.prototype._handleBack=function(){var e=this,t=this.viewModel.activeWorkflow,r=t.stepId,i=t.data,n=t.type,a=function(){if(t.hasPreviousStep)return void t.previous();e.viewModel.cancelWorkflow({force:!0})};if("editing-new-feature"===r||"editing-existing-feature"===r&&i.edits.modified){var o="create"===n?s.cancelAddWarningMessage:s.cancelEditWarningMessage,l="create"===n?s.cancelAddTitle:s.cancelEditTitle,d="create"===n?s.continueAdding:s.continueEditing,c="create"===n?s.discardFeature:s.discardEdits;return void(this._prompt={title:l,message:o,options:[{label:d,type:"neutral",action:function(){return e._prompt=null}},{label:c,type:"negative",action:function(){a(),e._prompt=null}}]})}a()},i([f.aliasOf("viewModel.activeWorkflow")],t.prototype,"activeWorkflow",void 0),i([f.aliasOf("viewModel.allowedWorkflows")],t.prototype,"allowedWorkflows",void 0),i([f.property()],t.prototype,"iconClass",void 0),i([f.property()],t.prototype,"label",void 0),i([f.aliasOf("viewModel.layerInfos")],t.prototype,"layerInfos",void 0),i([f.property()],t.prototype,"supportingWidgetDefaults",void 0),i([f.aliasOf("viewModel.view")],t.prototype,"view",void 0),i([f.property(),m.renderable(["viewModel.canCreate","viewModel.canUpdate","viewModel.failures","viewModel.state","viewModel.syncing","viewModel.activeWorkflow.data.edits.modified"])],t.prototype,"viewModel",void 0),i([m.accessibleHandler()],t.prototype,"_handleDelete",null),i([m.accessibleHandler()],t.prototype,"_handleAdd",null),i([m.accessibleHandler()],t.prototype,"_handleEdit",null),i([m.accessibleHandler()],t.prototype,"_handleDone",null),i([m.accessibleHandler()],t.prototype,"_handleBack",null),t=i([f.subclass("esri.widgets.Editor")],t)}(f.declared(u.HandleOwnerMixin(y)))});