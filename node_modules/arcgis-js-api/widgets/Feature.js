// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","dojo/i18n!./Feature/nls/Feature","../intl","../core/events","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./Feature/FeatureViewModel","./Feature/support/attachmentUtils","./support/chartUtils","./support/uriUtils","./support/widget","./support/widgetUtils"],function(e,t,i,a,r,n,s,o,l,d,c,p,u,m,h,f,_,v,y){var x={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",title:"esri-feature__title",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",showMediaPagination:"esri-feature--media-pagination-visible",attachments:"esri-feature__attachments",attachmentsList:"esri-feature__attachments--list",attachmentsPreview:"esri-feature__attachments--preview",attachmentsTitle:"esri-feature__attachments-title",attachmentsItems:"esri-feature__attachments-items",attachmentsItem:"esri-feature__attachments-item",attachmentsItemMask:"esri-feature__attachment-item-mask",attachmentsItemMaskIcon:"esri-feature__attachment-item-mask--icon",attachmentsItemImage:"esri-feature__attachments-image",attachmentsItemImageOverlay:"esri-feature__attachments-image-overlay",attachmentsItemLinkIcon:"esri-feature__attachments-link-icon esri-icon-link-external",attachmentsItemImageResizable:"esri-feature__attachments-image--resizable",attachmentsItemFilename:"esri-feature__attachments-filename",attachmentsItemLink:"esri-feature__attachments-item-link",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",media:"esri-feature__media",mediaContainer:"esri-feature__media-container",mediaItemContainer:"esri-feature__media-item-container",mediaItem:"esri-feature__media-item",mediaItemTitle:"esri-feature__media-item-title",mediaItemCaption:"esri-feature__media-item-caption",mediaPrevious:"esri-feature__media-previous",mediaPreviousIconLTR:"esri-feature__media-previous-icon",mediaPreviousIconRTL:"esri-feature__media-previous-icon--rtl",mediaNext:"esri-feature__media-next",mediaNextIconLTR:"esri-feature__media-next-icon",mediaNextIconRTL:"esri-feature__media-next-icon--rtl",mediaChart:"esri-feature__media-chart",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},g={title:!0,content:!0,lastEditedInfo:!0};return function(e){function t(t){var i=e.call(this,t)||this;return i._chartMap=new Map,i._activeMediaMap=new Map,i._refreshTimers=new Map,i._mediaInfo=new Map,i._loadingChartsModule=null,i.graphic=null,i.defaultPopupTemplateEnabled=!1,i.label=o.widgetLabel,i.spatialReference=null,i.title=null,i.visibleElements=r({},g),i.map=null,i.view=null,i.viewModel=new m,i}return i(t,e),t.prototype.postInitialize=function(){var e=this;this.own(c.init(this,"viewModel.content",function(){return e._setupMediaRefreshTimers()}))},t.prototype.destroy=function(){this._clearMediaRefreshTimers(),this._activeMediaMap.clear(),this._activeMediaMap=null,this._destroyCharts()},t.prototype.destroyCharts=function(){return this._destroyCharts()},t.prototype.castVisibleElements=function(e){return r({},g,e)},t.prototype.render=function(){var e=v.tsx("div",{key:"loading-container",class:x.loadingSpinnerContainer},v.tsx("span",{class:this.classes(x.iconLoading,x.spinner)})),t=this.visibleElements,i=this.viewModel,a=i.waitingForContent,r=i.title,n=t.title?v.tsx("h4",{class:x.title,innerHTML:r}):null,s=t.content?v.tsx("div",{class:x.main},[this._renderContent(),this._renderLastEditInfo()]):null;return v.tsx("div",{class:this.classes(x.base,x.esriWidget)},v.tsx("div",{class:x.container},n,a?e:s))},t.prototype.goToMedia=function(e,t){this._setContentElementMedia(e,t)},t.prototype.nextMedia=function(e){this._pageContentElementMedia(e,"next")},t.prototype.previousMedia=function(e){this._pageContentElementMedia(e,"previous")},t.prototype._buildKey=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];return e+"__"+(this.get("viewModel.graphic.uid")||"0")+"-"+t.join("-")},t.prototype._destroyCharts=function(){return s(this,void 0,void 0,function(){var e;return n(this,function(t){switch(t.label){case 0:return e=this._loadingChartsModule,e?[4,e]:[3,2];case 1:t.sent(),t.label=2;case 2:return this._chartMap.forEach(function(e){return e.dispose()}),this._chartMap.clear(),[2]}})})},t.prototype._renderContent=function(){var e=this.viewModel.content;return e?"string"==typeof e?v.tsx("div",{key:"content-string",innerHTML:e}):v.isWidget(e)?v.tsx("div",{key:"content-widget"},e.render()):e instanceof HTMLElement?v.tsx("div",{key:"content-html-element",bind:e,afterCreate:this._attachToNode}):v.isWidgetBase(e)?v.tsx("div",{key:"content-dijit",bind:e.domNode,afterCreate:this._attachToNode}):Array.isArray(e)&&e.length?v.tsx("div",{key:"content-content-elements"},e.map(this._renderContentElement,this)):null:null},t.prototype._renderContentElement=function(e,t){var i=this.visibleElements;if("boolean"!=typeof i.content&&!i.content[e.type])return null;switch(e.type){case"attachments":return this._renderAttachments(e);case"fields":return this._renderFields(e,t);case"media":return this._renderMedia(e,t);case"text":return this._renderText(e,t);default:return null}},t.prototype._renderAttachmentInfo=function(e){var t,i,a=e.attachmentInfo,r=e.supportsResizeAttachments,n=e.contentElement,s=n.displayType,l=a.contentType,d=a.orientationInfo,c=a.name,p=a.url,u="list"===s?48:400,m=d?[d.rotation?"rotate("+d.rotation+"deg)":"",d.mirrored?"scaleX(-1)":""].join(" "):"",f=m?{transform:m}:{},_=r&&h.isSupportedImage(l),y=-1===p.indexOf("?")?"?":"&",g=_?""+p+y+"w="+u:h.getIconPath(l),b=(t={},t[x.attachmentsItemMaskIcon]=!_,t),M=(i={},i[x.attachmentsItemImageResizable]=r,i);return v.tsx("li",{class:x.attachmentsItem,key:a},v.tsx("a",{class:x.attachmentsItemLink,href:p,rel:"noreferrer",target:"_blank"},v.tsx("div",{class:this.classes(b,x.attachmentsItemMask)},v.tsx("img",{styles:f,alt:"",class:this.classes(M,x.attachmentsItemImage),src:g}),v.tsx("span",{class:x.attachmentsItemImageOverlay},v.tsx("span",{"aria-hidden":"true",class:x.attachmentsItemLinkIcon}))),v.tsx("span",{class:x.attachmentsItemFilename},c||o.noTitle)))},t.prototype._renderAttachments=function(e){var t,i=this,a=e.displayType,r=e.attachmentInfos,n=r&&r.length,s=this.get("graphic.layer.capabilities.operations.supportsResizeAttachments"),l=(t={},t[x.attachmentsList]="preview"!==a,t[x.attachmentsPreview]="preview"===a,t);return n?v.tsx("div",{key:"attachments-element",class:this.classes(x.attachments,x.contentElement,l)},v.tsx("div",{class:x.attachmentsTitle},o.attach),v.tsx("ul",{class:x.attachmentsItems},r.map(function(t,a){return i._renderAttachmentInfo({attachmentInfo:t,attachmentInfoIndex:a,supportsResizeAttachments:s,contentElement:e})}))):null},t.prototype._forceLTR=function(e){return"&lrm;"+e},t.prototype._renderFieldInfo=function(e,t){var i,a=this.viewModel.formattedAttributes,r=a?a.content[t]||a.global:null,n=e.fieldName,s=e.label||n,o=r?null==r[n]?"":r[n]:"",l=!(!e.format||!e.format.dateFormat),d="number"==typeof o&&!l,c=d?this._forceLTR(o):_.autoLink(o),p=(i={},i[x.fieldDataDate]=l,i);return v.tsx("tr",{key:this._buildKey("fields-element-info-row",t)},v.tsx("th",{key:this._buildKey("fields-element-info-row-header",t),class:x.fieldHeader,innerHTML:s}),v.tsx("td",{key:this._buildKey("fields-element-info-row-data",t),class:this.classes(x.fieldData,p),innerHTML:c}))},t.prototype._renderFields=function(e,t){var i=this,a=e.fieldInfos;return a?v.tsx("div",{key:this._buildKey("fields-element",t),class:this.classes(x.fields,x.contentElement)},v.tsx("table",{class:x.esriTable,summary:o.fieldsSummary,key:this._buildKey("fields-element-table",t)},v.tsx("tbody",{key:this._buildKey("fields-element-table-body",t)},a.map(function(e){return i._renderFieldInfo(e,t)})))):null},t.prototype._shouldOpenInNewTab=function(e){if(void 0===e&&(e=""),e){return!/^(?:mailto:|tel:)/.test(e.trim().toLowerCase())}},t.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach(function(e){return clearTimeout(e)}),this._refreshTimers.clear()},t.prototype._clearMediaRefreshTimer=function(e){var t=this._refreshTimers.get(e);t&&(clearTimeout(t),this._refreshTimers.delete(e))},t.prototype._getImageSource=function(e,t){var i=-1!==e.indexOf("?")?"&":"?",a=e.split("#"),r=a[0],n=a[1],s=void 0===n?"":n;return""+r+i+"timestamp="+t+(s?"#":"")+s},t.prototype._setupMediaRefreshTimer=function(e){var t=this.get("viewModel.content");if(Array.isArray(t)){var i=t[e];if(i&&"media"===i.type){var a=this._activeMediaMap.get(e);isNaN(a)&&(a=0);var r=i.mediaInfos[a];r&&"image"===r.type&&r.refreshInterval&&this._setRefreshTimeout(e,r)}}},t.prototype._setupMediaRefreshTimers=function(){var e=this;this._clearMediaRefreshTimers();var t=this.get("viewModel.content");Array.isArray(t)&&t.forEach(function(t,i){return e._setupMediaRefreshTimer(i)})},t.prototype._updateMediaInfoTimestamp=function(e,t){var i=Date.now();this._mediaInfo.set(t,{timestamp:i,sourceURL:this._getImageSource(e,i)}),this.scheduleRender()},t.prototype._setRefreshTimeout=function(e,t){var i=this,a=t.refreshInterval,r=t.value;if(a){var n=6e4*a;this._updateMediaInfoTimestamp(r.sourceURL,e);var s=setInterval(function(){i._updateMediaInfoTimestamp(r.sourceURL,e)},n);this._refreshTimers.set(e,s)}},t.prototype._renderMediaInfoType=function(e){var t=e.mediaInfo,i=e.contentElementIndex,a=e.activeMediaIndex,r=t.title,n=void 0===r?"":r;if("image"===t.type){var s=t,o=s.value,l=s.refreshInterval,d=o.sourceURL,c=o.linkURL,p=this._shouldOpenInNewTab(c),u=p?"_blank":"_self",m="_blank"===u?"noreferrer":"",h=l?this._mediaInfo.get(i):null,f=h?h.timestamp:0,_=h?h.sourceURL:d,y=v.tsx("img",{alt:n,key:this._buildKey("media-image",i,a,f),src:_}),g=c?v.tsx("a",{title:n,href:c,rel:m,target:u},y):null;return g||y}if(-1!==t.type.indexOf("chart"))return v.tsx("div",{key:this._buildKey("media-chart",i,a),bind:this,"data-media-info":t,"data-content-element-index":i,class:x.mediaChart,afterCreate:this._getChartDependencies})},t.prototype._getChartDependencies=function(e){var t=this,i=e["data-media-info"],a=e["data-content-element-index"],r=this._chartMap.get(a);r&&r.dispose();var n=i.value,s=i.type;this._loadingChartsModule=f.loadChartsModule().then(function(i){return t._renderChart({chartDiv:e,contentElementIndex:a,type:s,value:n,chartsModule:i})})},t.prototype._createPieChart=function(e){var t=e.chartDiv,i=e.chartsModule,a=i.am4core,r=i.am4charts,n=a.create(t,r.PieChart);n.rtl=y.isRTL();var s=n.series.push(new r.PieSeries);return s.labels.template.disabled=!0,s.ticks.template.disabled=!0,s.dataFields.value="y",s.dataFields.category="x",s.tooltip.label.wrap=!0,s.tooltip.label.maxWidth=200,s.tooltip.label.rtl=n.rtl,n},t.prototype._createXYChart=function(e){var t=e.chartDiv,i=e.type,a=e.value,r=e.chartsModule,n=r.am4core,s=r.am4charts,o=n.create(t,s.XYChart);o.rtl=y.isRTL();var l=a.series.length>15;if("column-chart"===i){var d=o.xAxes.push(new s.CategoryAxis);d.dataFields.category="x",d.renderer.labels.template.disabled=!0,d.tooltip.label.wrap=!0,d.tooltip.label.maxWidth=200,d.tooltip.label.rtl=o.rtl,d.tooltip.events.on("sizechanged",function(){d.tooltip.dy=-d.tooltip.contentHeight});var c=o.yAxes.push(new s.ValueAxis),p=c.renderer.labels.template;c.renderer.minLabelPosition=.05,c.renderer.maxLabelPosition=.95,p.wrap=!0;var u=o.series.push(new s.ColumnSeries);u.dataFields.valueY="y",u.dataFields.categoryX="x",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new n.Scrollbar)}if("bar-chart"===i){var m=o.yAxes.push(new s.CategoryAxis);m.dataFields.category="x",m.renderer.inversed=!0,m.renderer.labels.template.disabled=!0,m.tooltip.label.wrap=!0,m.tooltip.label.maxWidth=200,m.tooltip.label.rtl=o.rtl,m.tooltip.events.on("sizechanged",function(){m.tooltip.dx=m.tooltip.contentWidth});var c=o.xAxes.push(new s.ValueAxis),p=c.renderer.labels.template;c.renderer.minLabelPosition=.05,c.renderer.maxLabelPosition=.95,p.wrap=!0;var u=o.series.push(new s.ColumnSeries);u.dataFields.valueX="y",u.dataFields.categoryY="x",o.cursor=new s.XYCursor,l&&(o.scrollbarY=new n.Scrollbar)}if("line-chart"===i){var h=o.xAxes.push(new s.CategoryAxis);h.dataFields.category="x",h.renderer.labels.template.disabled=!0,h.tooltip.label.wrap=!0,h.tooltip.label.maxWidth=200,h.tooltip.label.rtl=o.rtl,h.tooltip.events.on("sizechanged",function(){h.tooltip.dy=-h.tooltip.contentHeight});var c=o.yAxes.push(new s.ValueAxis),p=c.renderer.labels.template;c.renderer.minLabelPosition=.05,c.renderer.maxLabelPosition=.95,p.wrap=!0;var u=o.series.push(new s.LineSeries);u.dataFields.categoryX="x",u.dataFields.valueY="y",o.cursor=new s.XYCursor,l&&(o.scrollbarX=new n.Scrollbar)}return o},t.prototype._renderChart=function(e){var t=e.contentElementIndex,i=e.type,a=e.value,r=e.chartsModule;r.am4core.useTheme(r.am4themes_animated);var n="pie-chart"===i?this._createPieChart(e):this._createXYChart(e);n.data=a.series.map(function(e){return{x:e.tooltip,y:e.y}}),this._chartMap.set(t,n)},t.prototype._renderMediaInfo=function(e){var t=e.mediaInfo,i=e.contentElementIndex,a=e.activeMediaIndex,r=this._renderMediaInfoType({mediaInfo:t,contentElementIndex:i,activeMediaIndex:a}),n=t.title?v.tsx("div",{key:this._buildKey("media-title",i),class:x.mediaItemTitle,innerHTML:t.title}):null,s=t.caption?v.tsx("div",{key:this._buildKey("media-caption",i),class:x.mediaItemCaption,innerHTML:t.caption}):null;return v.tsx("div",{key:this._buildKey("media-container",i),class:x.mediaItemContainer},v.tsx("div",{key:this._buildKey("media-item-container",i),class:x.mediaItem},r),n,s)},t.prototype._renderMediaPageButton=function(e,t){var i="previous"===e,a=i?o.previous:o.next,r=i?this.classes(x.btn,x.mediaPrevious):this.classes(x.btn,x.mediaNext),n=i?this.classes(x.icon,x.mediaPreviousIconLTR,x.iconLeftTriangleArrow):this.classes(x.icon,x.mediaNextIconLTR,x.iconRightTriangleArrow),s=i?this.classes(x.icon,x.mediaPreviousIconRTL,x.iconRightTriangleArrow):this.classes(x.icon,x.mediaNextIconRTL,x.iconLeftTriangleArrow),l=i?"media-previous":"media-next",d=i?this._previousClick:this._nextClick;return v.tsx("div",{key:this._buildKey(l,t),title:a,tabIndex:0,role:"button",class:r,"data-content-element-index":t,bind:this,onkeydown:d,onclick:d},v.tsx("span",{"aria-hidden":"true",class:n}),v.tsx("span",{"aria-hidden":"true",class:s}),v.tsx("span",{class:x.iconText},a))},t.prototype._handleMediaKeyup=function(e){var t=e.currentTarget,i=t["data-content-element-index"],a=d.eventKey(e);"ArrowLeft"===a&&(e.stopPropagation(),this.previousMedia(i)),"ArrowRight"===a&&(e.stopPropagation(),this.nextMedia(i))},t.prototype._renderMedia=function(e,t){var i,a=e.mediaInfos,r=a&&a.length||0,n=(i={},i[x.showMediaPagination]=r>1,i),s=this._renderMediaPageButton("previous",t),o=this._renderMediaPageButton("next",t),l=this._activeMediaMap.get(t);return isNaN(l)&&(this._activeMediaMap.set(t,0),l=0),r?v.tsx("div",{key:this._buildKey("media-element",t),"data-content-element-index":t,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes(x.media,x.contentElement,n)},v.tsx("div",{key:this._buildKey("media-element-container",t),class:x.mediaContainer},s,this._renderMediaInfo({mediaInfo:a[l],contentElementIndex:t,activeMediaIndex:l}),o)):null},t.prototype._renderLastEditInfo=function(){var e=this.visibleElements,t=this.viewModel.lastEditInfo;if(!t||!e.lastEditedInfo)return null;var i=t.date,a=t.user,r="edit"===t.type?a?o.lastEditedByUser:o.lastEdited:a?o.lastCreatedByUser:o.lastCreated,n=l.substitute(r,{date:i,user:a});return v.tsx("div",{key:"edit-info-element",class:this.classes(x.lastEditedInfo,x.contentElement)},n)},t.prototype._renderText=function(e,t){return e.text?v.tsx("div",{key:this._buildKey("text-element",t),innerHTML:e.text,class:this.classes(x.text,x.contentElement)}):null},t.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},t.prototype._setContentElementMedia=function(e,t){this._clearMediaRefreshTimer(e);var i=this.viewModel.content,a=i&&i[e],r=a&&a.mediaInfos;if(r&&r.length){var n=(t+r.length)%r.length;this._activeMediaMap.set(e,n),this._setupMediaRefreshTimer(e),this.scheduleRender()}},t.prototype._pageContentElementMedia=function(e,t){var i="previous"===t?-1:1,a=this._activeMediaMap.get(e)+i;this._setContentElementMedia(e,a)},t.prototype._previousClick=function(e){var t=e.currentTarget,i=t["data-content-element-index"];this.previousMedia(i)},t.prototype._nextClick=function(e){var t=e.currentTarget,i=t["data-content-element-index"];this.nextMedia(i)},a([p.aliasOf("viewModel.graphic")],t.prototype,"graphic",void 0),a([p.aliasOf("viewModel.defaultPopupTemplateEnabled")],t.prototype,"defaultPopupTemplateEnabled",void 0),a([p.property()],t.prototype,"label",void 0),a([p.aliasOf("viewModel.spatialReference")],t.prototype,"spatialReference",void 0),a([p.aliasOf("viewModel.title")],t.prototype,"title",void 0),a([p.property(),v.renderable()],t.prototype,"visibleElements",void 0),a([p.cast("visibleElements")],t.prototype,"castVisibleElements",null),a([p.aliasOf("viewModel.map")],t.prototype,"map",void 0),a([p.aliasOf("viewModel.view")],t.prototype,"view",void 0),a([p.property({type:m}),v.renderable(["viewModel.waitingForContent","viewModel.content","viewModel.lastEditInfo"])],t.prototype,"viewModel",void 0),a([v.accessibleHandler()],t.prototype,"_previousClick",null),a([v.accessibleHandler()],t.prototype,"_nextClick",null),t=a([p.subclass("esri.widgets.Feature")],t)}(p.declared(u))});