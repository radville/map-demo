// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Graphic","../../intl","../../core/Error","../../core/Handles","../../core/lang","../../core/Logger","../../core/promiseUtils","../../core/string","../../core/throttle","../../core/watchUtils","../../core/accessorSupport/decorators","../../intl/date","../../intl/number","../../layers/support/fieldUtils","../../popup/content/TextContent","../../popup/content/support/ChartMediaInfoValueSeries","../../popup/support/FieldInfoFormat","../../tasks/support/AttachmentQuery","./support/featureUtils","./support/RelatedFeatures","../support/widget"],function(e,t,r,i,o,n,a,l,s,u,p,f,c,d,h,y,m,v,_,g,b,F,I,A,T,C,x,w){function L(){return a(this,void 0,void 0,function(){return n(this,function(t){return[2,d.create(function(t){e(["../../support/arcadeUtils"],function(e){t(e)})})]})})}function E(e){var t=/(\n)/gi;return"string"==typeof e?e.replace(t,'<br class="esri-text-new-line" />'):e}function N(e,t){var r=t[e];if("string"==typeof r){var i=/\'/g,o=encodeURIComponent(r).replace(i,"&apos;");t[e]=o}}function R(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function q(e){return(""+e).trim()}function O(e,t,r,i){return t=q(t),s.substitute(e,t&&"{"===t[0]?r:i)}function P(e){return e.replace(/[\u00A0-\u9999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})}var k=["$datastore","$map","$layer"],S=c.getLogger("esri.widgets.FeatureViewModel"),j=/^\s*expression\//i,D=_.convertDateFormatToIntlOptions("short-date-short-time");return function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new p,r._featureAbortController=null,r._graphicChangedThrottled=y.throttle(r._graphicChanged,1,r),r._effectivePopupTemplate=null,r._contentResponse=null,r._graphic=null,r._fieldInfoMap=null,r.content=null,r.defaultPopupTemplateEnabled=!1,r.formattedAttributes=null,r.graphic=null,r.lastEditInfo=null,r.title="",r.view=null,r._handles.add(m.init(r,["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled"],function(){return r._graphicChangedThrottled()})),r}return r(t,e),t.prototype.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._graphic=null},Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this.get("view.spatialReference")||null},set:function(e){if(void 0===e)return void this._clearOverride("spatialReference");this._override("spatialReference",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"map",{get:function(){return this.get("view.map")||null},set:function(e){if(void 0===e)return void this._clearOverride("map");this._override("map",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"waitingForContent",{get:function(){return!!this._featureAbortController},enumerable:!0,configurable:!0}),t.prototype._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},t.prototype._graphicChanged=function(){return a(this,void 0,void 0,function(){var e,t,r,i;return n(this,function(o){switch(o.label){case 0:if(this._cancelFeatureQuery(),this._clear(),e=this.graphic,t=e?e.clone():null,this._graphic=t,!t)return[2];r=d.createAbortController(),this._featureAbortController=r,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this._queryFeature({signal:r.signal})];case 2:return o.sent(),[3,4];case 3:return i=o.sent(),S.error("error","error loading template",i),[3,4];case 4:return this._featureAbortController=null,[2]}})})},t.prototype._cancelFeatureQuery=function(){var e=this._featureAbortController;e&&e.abort(),this._featureAbortController=null},t.prototype._compileContent=function(e,t){var r=this;return e&&(e.nodeName||e&&w.isWidgetBase(e)||w.isWidget(e))?e:this._graphic?"string"==typeof e?this._compileText(new F({text:e})).text:Array.isArray(e)?e.map(function(e,i){var o=t&&t[i],n=o&&o.value;return"attachments"===e.type?r._compileAttachments(e,n):"fields"===e.type?r._compileFields(e):"media"===e.type?r._compileMedia(e):"text"===e.type?r._compileText(e):void 0}):void(e&&S.warn("invalid content type.")):void 0},t.prototype._compileFields=function(e){var t=this,r=this._effectivePopupTemplate,i=f.clone(e),o=r&&r.expressionInfos,n=i.fieldInfos?void 0:r&&r.fieldInfos,a=i.fieldInfos||f.clone(n),l=[];return a&&a.forEach(function(e){var r=e.fieldName.toLowerCase();if(!e.hasOwnProperty("visible")||e.visible){var i=t._isExpressionField(r)?t._getExpressionInfo(o,r):null;e.label=i?i.title:e.label,l.push(e)}}),i.fieldInfos=l,i},t.prototype._setImageValue=function(e){var t=e.value,r=e.formattedAttributes,i=e.layer,o=t.linkURL,n=t.sourceURL;if(n){var a=this._fixTokens(n,i);t.sourceURL=this._substituteAttributes(r,a)}if(o){var l=this._fixTokens(o,i);t.linkURL=this._substituteAttributes(r,l)}},t.prototype._compileMedia=function(e){var t=this,r=this._graphic,i=f.clone(e),n=i.mediaInfos,a=r.attributes,l=C.getSourceLayer(r),s=this.formattedAttributes.global,u=o({},s,a);return i.mediaInfos=n&&n.map(function(e){var r=f.clone(e);if(r){var i=r.title?t._processFieldsInLinks(r.title,u):"",o=r.caption?t._processFieldsInLinks(r.caption,u):"";if(r.title=i?t._substituteAttributes(s,i):"",r.caption=o?t._substituteAttributes(s,o):"","image"===r.type){var n=r.value;return t._setImageValue({value:n,formattedAttributes:s,layer:l}),r.value.sourceURL?r:void 0}if("pie-chart"===r.type||"line-chart"===r.type||"column-chart"===r.type||"bar-chart"===r.type){var n=r.value;return t._setChartValue({value:n,chartType:r.type,attributes:a,formattedAttributes:s,layer:l}),r}}}).filter(Boolean),i},t.prototype._normalizeTemplateFields=function(e){var t=this._fieldInfoMap.get(e.toLowerCase());return"{"+(t&&t.fieldName||e)+"}"},t.prototype._substituteAttributes=function(e,t){var r=this;return q(this._removeEmptyHref(s.substitute(h.replace(t,function(e){return r._normalizeTemplateFields(e)}),e)))},t.prototype._compileText=function(e){var t=f.clone(e);if(t&&t.text){var r=this._graphic.attributes,i=this.formattedAttributes.global,n=this._processFieldsInLinks(t.text,o({},i,r));t.text=this._substituteAttributes(i,n)}return t},t.prototype._formatEditInfo=function(e,t){var r=e.creatorField,i=e.creationDateField,o=e.editorField,n=e.editDateField;if(t){var a=t[n];if("number"==typeof a){var l=t[o],u=s.formatDate(a,D);return{type:"edit",date:u,user:l}}var p=t[i];if("number"==typeof p){var f=t[r],u=s.formatDate(p,D);return{type:"create",date:u,user:f}}}},t.prototype._compileLastEditInfo=function(){var e=this,t=e._effectivePopupTemplate,r=e._graphic;if(t){var i=t.lastEditInfoEnabled,o=r.get("sourceLayer.editFieldsInfo");if(i&&o)return this._formatEditInfo(o,r.attributes)}},t.prototype._compileTitle=function(){var e=this,t=e._effectivePopupTemplate,r=e._graphic,i=t&&t.title,n=r.attributes,a=this.formattedAttributes.global,l="function"==typeof i?i.call(null,{graphic:r}):i;if("string"==typeof l&&l){var s=this._processFieldsInLinks(l,o({},a,n));return this._substituteAttributes(a,s)}return""},t.prototype._getExpressionInfo=function(e,t){if(this._isExpressionField(t)){var r,i=t.replace(j,"").toLowerCase();return e.some(function(e){return e.name.toLowerCase()===i&&(r=e,!0)}),r}},t.prototype._fixTokens=function(e,t){var r=/(\{([^\{\r\n]+)\})/g;return e.replace(r,function(e,r,i){var o=R(t,i);return o?"{"+o.name+"}":r})},t.prototype._encodeAttributes=function(e){var t=e?f.clone(e):{};return Object.keys(t).forEach(function(e){return N(e,t)}),t},t.prototype._createfieldInfoMap=function(e,t){var r=this,i=new Map;return e&&e.forEach(function(e){var o=r._getFixedFieldName(e.fieldName,t);e.fieldName=o,i.set(o.toLowerCase(),e)}),i},t.prototype._formatAttributeValue=function(e){var t=e.value,r=e.fieldName,i=e.fieldInfos,o=e.fieldInfoMap,n=e.layer;if(null==t)return t;var a=this._getDomainName(r,t);if(a)return a;var l=this._getTypeName(r);if(l)return l;if(o.get(r.toLowerCase()))return this._formatValueToFieldInfo(t,{fieldInfos:i,fieldName:r,layer:n});var u=n&&n.fieldsIndex;return u&&u.isDateField(r)?s.formatDate(t,D):E(t)},t.prototype._formatAttributes=function(e){var t=this,r=this._graphic,i=C.getSourceLayer(r),o=f.clone(r.attributes);this.addRelatedFeatureAttributes(o);var n=this._createfieldInfoMap(e,i);return this._fieldInfoMap=n,Object.keys(o).forEach(function(r){var a=o[r];o[r]=t._formatAttributeValue({fieldName:r,fieldInfos:e,fieldInfoMap:n,layer:i,value:a})}),o},t.prototype._formatValueToFieldInfo=function(e,t){var r=t.fieldInfos,i=t.fieldName,n=this._getFieldInfo(r,i),a=f.clone(n),l=t.preventPlacesFormatting,s=t.layer,u=R(s,i);if(u&&"date"===u.type){var p=a.format||new A;p.dateFormat=p.dateFormat||"short-date-short-time",a.format=p}var c=a&&a.format;return"string"==typeof e||null==e||null==c?e:l?g.formatNumber(e,o({},g.convertNumberFormatToIntlOptions(c),{minimumFractionDigits:0,maximumFractionDigits:20})):c.format(e)},t.prototype._getDomainName=function(e,t){if(this.isRelatedField(e))return null;var r=this._graphic,i=C.getSourceLayer(r);if(!i||"function"!=typeof i.getFieldDomain)return null;var o=i.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null},t.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some(function(e){return!(!e.fieldName||e.fieldName.toLowerCase()!==r||(i=e,0))}),i}},t.prototype._getTypeName=function(e){if(this.isRelatedField(e))return null;var t=this._graphic,r=C.getSourceLayer(t);if(!r||"function"!=typeof r.getFeatureType)return null;var i=r.typeIdField;if(!i||e!==i)return null;var o=r.getFeatureType(t);return o?o.name:null},t.prototype._removeEmptyHref=function(e){var t=/href=(""|'')/gi;return e.replace(t,"")},t.prototype._processFieldsInLinks=function(e,t){var r=this.get("_graphic.layer"),i=this._fixTokens(e,r),o=this._encodeAttributes(t),n=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi;return i?i.replace(n,function(e,r,i){return O(e,r||i,t,o)}):i},t.prototype._compileAttachments=function(e,t){var r=f.clone(e);return!t||t&&0===t.length?r:(r.attachmentInfos=t,r)},t.prototype._queryAttachments=function(){var e=this._graphic,t=C.getSourceLayer(e);if(!t)return d.resolve([]);var r="scene"===t.type&&t.associatedLayer?t.associatedLayer:t;if(r&&"function"==typeof r.queryAttachments){var i=r,o=i.objectIdField,n=e.attributes,a=n&&n[o],l=new T({objectIds:[a],returnMetadata:!0});return i.queryAttachments(l).then(function(e){return e[a]||[]})}return d.resolve([])},t.prototype._queryContentElements=function(e){var t=this;if(!Array.isArray(e))return d.resolve();var r={};return e.forEach(function(e,i){if("attachments"===e.type){var o=t._queryAttachments();o&&(r[i]=o)}}),Object.keys(r).length?d.eachAlways(r):d.resolve()},t.prototype._getContent=function(){var e=this,t=e._effectivePopupTemplate,r=e._graphic,i=t&&t.content,o="function"==typeof i?i.call(null,{graphic:r}):i;return d.isPromiseLike(o)?o:d.resolve(o)},t.prototype._querySourceLayer=function(e,t){var r=e.layer,i=e.outFields,o=e.objectIds;if("function"!=typeof r.queryFeatures||!o){var n="Could not query required fields for the specified layer. Some fields will not be available.",a=new u("query-required-fields",n,{outFields:i,objectIds:o});return S.warn("query-required-fields",n),d.reject(a)}var l=r.createQuery();return l.objectIds=o,l.outFields=i,l.returnGeometry=!0,r.queryFeatures(l,t).then(function(e){return e.features[0]})},t.prototype._queryRequiredFieldsFeature=function(e){var t=this,r=this,i=r._graphic,o=r._effectivePopupTemplate,n=i.sourceLayer;return n&&o?("function"==typeof n.load?n.load(e):d.resolve()).then(function(){var r=i.attributes[n.objectIdField],a="number"==typeof r?[r]:void 0;return o.getRequiredFields(n.fields).then(function(r){return b.featureHasFields(r,i)?null:t._querySourceLayer({layer:n,outFields:r,objectIds:a},e)})}):d.resolve(null)},t.prototype._queryFeature=function(e){var t=this,r=this,i=r._featureAbortController,n=r._graphic;return this._effectivePopupTemplate=n&&n.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled),this._getContent().then(function(r){if(i===t._featureAbortController&&n){var a=t._checkForRelatedFeatures(r,e),l=t._createFormattedExpressions().then(function(e){n.attributes=o({},n.attributes,e)}),s=t._queryContentElements(r).then(function(e){return t._contentResponse=e}),u=t._queryRequiredFieldsFeature(e).then(function(e){e&&(n.geometry=e.geometry,n.attributes=o({},n.attributes,e.attributes))});return d.eachAlways([a,l,s,u]).then(function(){if(i===t._featureAbortController&&n){t._set("formattedAttributes",t._createFormattedAttributes(r)),t._set("title",t._compileTitle());var e=t._compileLastEditInfo();t._set("lastEditInfo",e||null);var o=t._compileContent(r,t._contentResponse);return t._set("content",o||null),o}})}})},t.prototype._isExpressionField=function(e){return j.test(e)},t.prototype._formatArcadeArray=function(e){return'<ul class="esri-widget__list">'+e.map(function(e){return"<li>"+("string"==typeof e?E(P(e)):e)+"</li>"}).join("")+"</ul>"},t.prototype._formatArcadeDictionary=function(e){return'<table class="esri-widget__table">'+e.keys().map(function(t){var r=e.field(t);return"<tr><th>"+t+"</th><td>"+("string"==typeof r?E(P(r)):r)+"</td></tr>"}).join("")+"</table>"},t.prototype._createFormattedExpressions=function(){return a(this,void 0,void 0,function(){var e,t,r,i,o,l,s,u,p,f,c,h=this;return n(this,function(y){switch(y.label){case 0:return e=this,t=e._effectivePopupTemplate,r=e._graphic,i=t&&t.expressionInfos,o=[],l={},i&&i.length?[4,L()]:[2,l];case 1:for(s=y.sent(),u=function(e){var t="expression/"+e.name,i=s.createSyntaxTree(e.expression),u=k.filter(function(e){return s.hasVariable(i,e)}),p=s.loadScriptDependencies(i,!0,u).then(function(){return a(h,void 0,void 0,function(){var e,o,a,p,f=this;return n(this,function(n){return e=this.spatialReference,o=s.getViewInfo({spatialReference:e}),a=s.createExecContext(r,o),a.useAsync=!0,this._addVarsToContext(s,u,a,o),p=s.createFunction(i,a),[2,s.executeAsyncFunction(p,a).then(function(e){l[t]="string"==typeof e?E(P(e)):Array.isArray(e)?f._formatArcadeArray(e):e&&"esri.arcade.Dictionary"===e.declaredClass?f._formatArcadeDictionary(e):e},function(e){return S.error("arcade-execution-error",e)})]})})});o.push(p)},p=0,f=i;p<f.length;p++)c=f[p],u(c);return[2,d.eachAlways(o).then(function(){return l})]}})})},t.prototype._addVarsToContext=function(e,t,r,i){var o=this,n=o.graphic,a=o.map;t.forEach(function(t){var o=t.toLowerCase(),l={map:a,spatialReference:i.sr};"$map"===o&&(r.vars[o]=e.convertMapToFeatureSetCollection(l)),"$layer"===o&&(r.vars[o]=e.convertFeatureLayerToFeatureSet(n.sourceLayer,i.sr)),"$datastore"===o&&(r.vars[o]=e.convertServiceUrlToWorkspace(n.sourceLayer.url,i.sr))})},t.prototype._createFormattedAttributes=function(e){var t=this,r=this._effectivePopupTemplate,i=r&&r.fieldInfos,o={global:this._formatAttributes(i),content:[]};return Array.isArray(e)&&e.forEach(function(e,r){"fields"===e.type&&e.fieldInfos&&(o.content[r]=t._formatAttributes(e.fieldInfos))}),o},t.prototype._getAllFieldInfos=function(e){var t=this._effectivePopupTemplate,r=[],i=t&&t.fieldInfos;return i&&r.push.apply(r,i),e&&Array.isArray(e)?(e.forEach(function(e){if("fields"===e.type){var t=e&&e.fieldInfos;r.push.apply(r,t)}}),r):r},t.prototype._checkForRelatedFeatures=function(e,t){var r=this._graphic,i=this._getAllFieldInfos(e);return this.queryRelatedInfos(r,i,t)},t.prototype._getTooltip=function(e){var t=e.label,r=e.value;return"pie-chart"===e.chartType?t:t+":\n"+r},t.prototype._getChartOption=function(e){var t=e.value,r=e.attributes,i=e.formattedAttributes,o=e.fieldName,n=e.relatedFieldName,a=e.fieldInfos,l=e.chartType,s=e.index,u=this._graphic,p=C.getSourceLayer(u),f=t.normalizeField,c=t.tooltipField,d=f?this.isRelatedField(f)?r[this.getRelatedFieldInfo(f).fieldName]:r[f]:null,h=n&&void 0!==r[n]?r[n]:void 0!==r[o]?r[o]:i[o],y=void 0===h?null:h&&d?h/d:h,m=new I({x:s,y:y});if(this.isRelatedField(o)){var v=this.getRelatedFieldInfo(o),_=this.getRelatedFieldInfo(c),g=_?_.fieldName:null,b=this._formatValueToFieldInfo(y,{fieldInfos:a,fieldName:n,layer:p,preventPlacesFormatting:!!d}),F=v?v.label||v.fieldName:n,A=g&&void 0!==r[g]?r[g]:F;return m.tooltip=this._getTooltip({label:A,chartType:l,value:b}),m}var T=this._getFieldInfo(a,o),x=this._getFixedFieldName(o,p),w=T?T.label||T.fieldName:o,L=c&&void 0!==i[c]?i[c]:w,E=i[x];return m.tooltip=this._getTooltip({label:L,chartType:l,value:E}),m},t.prototype._getFixedFieldName=function(e,t){var r=R(t,e);return r?r.name:e},t.prototype._getFixedFieldNames=function(e,t){var r=this;return e&&e.map(function(e){return r._getFixedFieldName(e,t)})},t.prototype._setChartValue=function(e){var t=this,r=e.value,i=e.attributes,o=e.formattedAttributes,n=e.chartType,a=e.layer,l=this,s=l._effectivePopupTemplate,u=l.relatedInfoCount,p=r.fields,f=r.normalizeField;if(r.fields=this._getFixedFieldNames(p,a),f&&(r.normalizeField=this._getFixedFieldName(f,a)),p.some(function(e){return!!(null!=o[e]||t.isRelatedField(e)&&u)})){var c=s&&s.fieldInfos;p.forEach(function(e,a){if(t.isRelatedField(e))return void(r.series=r.series.concat(t._getRelatedChartInfos({fieldInfos:c,fieldName:e,formattedAttributes:o,chartType:n,value:r})));var l=t._getChartOption({value:r,index:a,attributes:i,chartType:n,formattedAttributes:o,fieldName:e,fieldInfos:c});r.series.push(l)})}},t.prototype._getRelatedChartInfos=function(e){var t=this,r=e.fieldInfos,i=e.fieldName,o=e.formattedAttributes,n=e.chartType,a=e.value,l=[],s=this.getRelatedFieldInfo(i),u=s.layerId,p=s.fieldName,f=this.getRelatedInfo(u);if(!f)return l;var c=f.relatedFeatures,d=f.relation;if(!d||!c)return l;var h=d.cardinality;return c.forEach(function(e,s){var u=e.attributes;u&&Object.keys(u).forEach(function(e){e===p&&l.push(t._getChartOption({value:a,index:s,attributes:u,formattedAttributes:o,fieldName:i,chartType:n,relatedFieldName:e,fieldInfos:r}))})}),"one-to-many"===h||"many-to-many"===h?l:[l[0]]},i([v.property()],t.prototype,"_featureAbortController",void 0),i([v.property({readOnly:!0})],t.prototype,"content",void 0),i([v.property({type:Boolean})],t.prototype,"defaultPopupTemplateEnabled",void 0),i([v.property({readOnly:!0})],t.prototype,"formattedAttributes",void 0),i([v.property({type:l})],t.prototype,"graphic",void 0),i([v.property({readOnly:!0})],t.prototype,"lastEditInfo",void 0),i([v.property({dependsOn:["view"]})],t.prototype,"spatialReference",null),i([v.property({readOnly:!0})],t.prototype,"title",void 0),i([v.property({dependsOn:["view"]})],t.prototype,"map",null),i([v.property({readOnly:!0,dependsOn:["_featureAbortController"]})],t.prototype,"waitingForContent",null),i([v.property()],t.prototype,"view",void 0),t=i([v.subclass("esri.widgets.FeatureViewModel")],t)}(v.declared(x))});