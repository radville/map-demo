// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/awaiterHelper","../../../core/tsSupport/generatorHelper","../../../symbols","../../../core/promiseUtils","../../../renderers/support/numberUtils","../../../symbols/support/utils","./utils","@dojo/framework/shim/Promise"],function(e,r,n,t,l,i,s,u,o){function a(e){return"esri.symbols.SimpleMarkerSymbol"===e.declaredClass}function c(e){return"esri.symbols.PictureMarkerSymbol"===e.declaredClass}function f(e){return"esri.symbols.SimpleLineSymbol"===e.declaredClass}function m(e){return"esri.symbols.TextSymbol"===e.declaredClass}function p(e,r){var n=e.length-1;return e.map(function(e,t){return o.createStopLabel(e,t,n,r)})}function b(e,l,o,a,c,f){return n(this,void 0,void 0,function(){var m,b,y,v,d,g,w,z,V,D,x,E,M,O,R,I,k,A=this;return t(this,function(C){switch(C.label){case 0:return m=l.legendOptions,b=m&&m.customValues,y=h(e,o),(v=!!y,d=!!b,g=null!=l.minSize&&null!=l.maxSize,w=l.stops&&l.stops.length>1,z=!!l.target,v&&(d||g||w&&!z))?(V=u.isVolumetricSymbol(y),D=null,x=null,E=null,!V||w?[3,1]:(x=s.round([l.minDataValue,l.maxDataValue]),[3,4])):[2,void 0];case 1:return M=b,M?[3,3]:[4,S(l,y,a,c)];case 2:M=C.sent(),C.label=3;case 3:x=M,C.label=4;case 4:return!x&&w&&(x=l.stops.map(function(e){return e.value}),(D=l.stops.some(function(e){return!!e.label}))&&(E=l.stops.map(function(e){return e.label}))),(V&&x&&x.length>2&&(x=[x[0],x[x.length-1]]),x)?(O=[r.REAL_WORLD_MIN_SIZE,r.REAL_WORLD_MAX_SIZE],R=u.getSymbolOutlineSize(y),I=D?null:p(x,f),[4,i.all(x.map(function(e,r){return n(A,void 0,void 0,function(){var n,i,s,u;return t(this,function(t){switch(t.label){case 0:return V?(s=O[r],[3,3]):[3,1];case 1:return[4,L(l,y,e,a,c)];case 2:s=t.sent(),t.label=3;case 3:return n=s,i=_(y,n),u=D?E[r]:I[r],[2,{value:e,symbol:i,label:u,size:n,outlineSize:R}]}})})}))]):[2,null];case 5:return k=C.sent(),[2,k.reverse()]}})})}function h(e,r){var n=null,t=null;if("simple"===e.type)n=e.symbol;else if("class-breaks"===e.type){var l=e.classBreakInfos;n=l&&l[0]&&l[0].symbol,t=l.length>1}else if("unique-value"===e.type){var l=e.uniqueValueInfos;n=l&&l[0]&&l[0].symbol,t=l.length>1}return!n||y(n)?null:(n=n.clone(),(r||t)&&(n.type.indexOf("3d")>-1?v(n):d(n)),n)}function y(e){if(e){if(l.isSymbol3D(e)){return!!e.symbolLayers&&e.symbolLayers.some(function(e){return e&&"fill"===e.type})}return-1!==e.type.indexOf("fill")}return!1}function v(e){u.isVolumetricSymbol(e)||("line-3d"===e.type?e.symbolLayers.forEach(function(e){e.material={color:x}}):e.symbolLayers.forEach(function(e){"icon"!==e.type||e.resource&&e.resource.href?e.material={color:D}:(e.material={color:V},e.outline={color:x,size:1.5})}))}function d(e){-1!==e.type.indexOf("line")?e.color=x:(e.color=V,"simple-marker"===e.type&&(e.outline={color:x,width:1.5}))}function S(r,l,i,u){return n(this,void 0,void 0,function(){var n,o,a,c,f;return t(this,function(t){switch(t.label){case 0:return[4,new Promise(function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)})];case 1:if(n=t.sent().getSizeRangeAtScale(r,i,u),o=n&&g(n),!n&&!o)return[2,void 0];a=o.map(function(e){return w(e,r,n)}),a=s.round(a),c=1,t.label=2;case 2:return c<a.length-1?[4,z(r,l,a[c],a[c-1],i,u)]:[3,5];case 3:f=t.sent(),f&&(a[c]=f[0],o[c]=f[1]),t.label=4;case 4:return c++,[3,2];case 5:return[2,a]}})})}function g(e){for(var r=e.minSize,n=e.maxSize,t=M,l=(n-r)/(t-1),i=[],s=0;s<t;s++)i.push(r+l*s);return i}function w(e,r,n){var t=n.minSize,l=n.maxSize,i=r.minDataValue,s=r.maxDataValue,u=null;if(e<=t)u=i;else if(e>=l)u=s;else{var o=(e-t)/(l-t);u=o*(s-i)+i}return u}function z(e,r,l,i,u,o){return n(this,void 0,void 0,function(){var n,a,c,f,m,p,b,h,y,v,d,S,g,w,z,_,V,D,x,M,O,R;return t(this,function(t){switch(t.label){case 0:return[4,L(e,r,l,u,o)];case 1:return a=t.sent(),[4,L(e,r,i,u,o)];case 2:c=t.sent(),f=s.numDigits(l),m=f.fractional,p=E,b=f.integer,h=null,y=null,l>0&&l<1&&(h=Math.pow(10,m),l*=h,b=s.numDigits(l).integer),v=b-1,t.label=3;case 3:return v>=0?(d=Math.pow(10,v),S=Math.floor(l/d)*d,g=Math.ceil(l/d)*d,null!=h&&(S/=h,g/=h),w=(S+g)/2,n=s.round([S,w,g],{indexes:[1]}),w=n[1],[4,L(e,r,S,u,o)]):[3,8];case 4:return z=t.sent(),[4,L(e,r,g,u,o)];case 5:return _=t.sent(),[4,L(e,r,w,u,o)];case 6:if(V=t.sent(),D=s.percentChange(a,z,c,null),x=s.percentChange(a,_,c,null),M=s.percentChange(a,V,c,null),O=D.previous<=p,R=x.previous<=p,O&&R&&(D.previous<=x.previous?(O=!0,R=!1):(R=!0,O=!1)),O?y=[S,z]:R?y=[g,_]:M.previous<=p&&(y=[w,V]),y)return[3,8];t.label=7;case 7:return v--,[3,3];case 8:return[2,y]}})})}function L(r,l,i,s,u){return n(this,void 0,void 0,function(){var n;return t(this,function(t){switch(t.label){case 0:return[4,new Promise(function(r,n){e(["../../../renderers/visualVariables/support/visualVariableUtils"],r,n)})];case 1:return n=t.sent().getSize,[2,n(r,i,{scale:s,view:u,shape:"simple-marker"===l.type?l.style:null})]}})})}function _(e,r){var n=e.clone();if(l.isSymbol3D(n))u.isVolumetricSymbol(n)||n.symbolLayers.forEach(function(e){"fill"!==e.type&&(e.size=r)});else if(a(n))n.size=r;else if(c(n)){var t=n.width,i=n.height;n.height=r,n.width=r*(t/i)}else f(n)?n.width=r:m(n)&&n.font&&(n.font.size=r);return n}Object.defineProperty(r,"__esModule",{value:!0}),r.REAL_WORLD_MAX_SIZE=30,r.REAL_WORLD_MIN_SIZE=12;var V=[255,255,255],D=[200,200,200],x=[128,128,128],E=20,M=5;r.getRampStops=b});