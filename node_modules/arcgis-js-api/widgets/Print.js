// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

/**
             * Defines the layout template options used by the {@link module:esri/widgets/Print|Print} widget to generate the print page.
             *
             * @name templateOptions
             * @since 4.6
             * @instance
             *
             * @example
             * templateOptions: {
             *   title: "My Print",
             *   author: "Sam",
             *   copyright: "My Company",
             *   legendEnabled: false
             * }
             *
             * @type {module:esri/widgets/Print/TemplateOptions}
             * @autocast
             */

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!./Print/nls/Print","../core/Collection","../core/events","../core/Logger","../core/urlUtils","../core/watchUtils","../core/accessorSupport/decorators","../tasks/support/PrintTemplate","./Widget","./Print/FileLink","./Print/PrintViewModel","./Print/TemplateOptions","./support/widget"],function(t,e,i,n,a,o,s,r,l,p,d,c,u,h,b,_,v){var y=o.ofType(h),x={base:"esri-print esri-widget esri-widget--panel",headerTitle:"esri-print__header-title",inputText:"esri-print__input-text",layoutTabList:"esri-print__layout-tab-list",layoutTab:"esri-print__layout-tab",layoutSection:"esri-print__layout-section",mapOnlySection:"esri-print__map-only-section",scaleInput:"esri-print__scale-input",loader:"esri-print__loader",advancedOptionsButton:"esri-print__advanced-options-button",advancedOptionsButtonContainer:"esri-print__advanced-options-button-container",advancedOptionsButtonTitle:"esri-print__advanced-options-button-title",advancedOptionsButtonIconOpened:"esri-print__advanced-options-button-icon--opened",advancedOptionsButtonIconClosed:"esri-print__advanced-options-button-icon--closed",advancedOptionsButtonIconClosed_RTL:"esri-print__advanced-options-button-icon--closed-rtl",refreshButton:"esri-print__refresh-button",swapButton:"esri-print__swap-button",linkButton:"esri-print__link-button",printButton:"esri-print__export-button",formSectionContainer:"esri-print__form-section-container",advancedOptionsSection:"esri-print__advanced-options-section",advancedOptionsContainer:"esri-print__advanced-options-container",authorInfoContainer:"esri-print__author-info-container",copyrightInfoContainer:"esri-print__copyright-info-container",exportedFilesContainer:"esri-print__export-panel-container",exportedFilesTitle:"esri-print__export-title",exportedFile:"esri-print__exported-file",exportedFileLink:"esri-widget__anchor esri-print__exported-file-link",exportedFileLinkTitle:"esri-print__exported-file-link-title",heightContainer:"esri-print__height-container",legendInfoContainer:"esri-print__legend-info-container",printWidgetContainer:"esri-print__container",panelContainer:"esri-print__panel-container",scaleInfoContainer:"esri-print__scale-info-container",scaleInputContainer:"esri-print__scale-input-container",sizeContainer:"esri-print__size-container",widthContainer:"esri-print__width-container",widgetButton:"esri-widget--button",button:"esri-button",select:"esri-select",header:"esri-widget__heading",input:"esri-input",disabled:"esri-disabled",anchorDisabled:"esri-widget__anchor--disabled",buttonDisabled:"esri-button--disabled",panelError:"esri-print__panel--error",exportedFileError:"esri-print__exported-file--error",hide:"esri-hidden",rotate:"esri-rotating",iconCheckMark:"esri-icon-check-mark",iconDownload:"esri-icon-download",iconError:"esri-icon-error",iconPrinter:"esri-icon-printer",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconDownArrow:"esri-icon-down-arrow",iconRefresh:"esri-icon-refresh",iconSpinner:"esri-icon-loading-indicator",iconSwap:"esri-icon-swap",iconLinked:"esri-icon-link-horizontal",iconUnlinked:"esri-icon-unlocked-link-horizontal",widgetIcon:"esri-icon-printer"},f=r.getLogger("esri.widgets.Print");return function(t){function e(e){var i=t.call(this,e)||this;return i._activeTabFocusRequested=!1,i._advancedOptionsVisibleForLayout=!1,i._advancedOptionsVisibleForMapOnly=!1,i._awaitingServerResponse=!1,i._exportedFileNameMap={},i._layoutTabSelected=!0,i._pendingExportScroll=!1,i._rootNode=null,i.exportedLinks=new y,i.iconClass=x.widgetIcon,i.label=a.widgetLabel,i.templateOptions=new _,i.printServiceUrl=null,i.view=null,i.viewModel=new b,i._focusOnTabChange=i._focusOnTabChange.bind(i),i}return i(e,t),e.prototype.postInitialize=function(){var t=this;this.own([p.init(this,"viewModel.templatesInfo",function(e){var i=t.templateOptions,n=i.format,a=i.layout;if(e){var o=a===e.layout.defaultValue||a&&"MAP_ONLY"===a.toUpperCase()||e.layout.choiceList&&e.layout.choiceList.indexOf(a)>-1,s=n===e.format.defaultValue||e.format.choiceList&&e.format.choiceList.indexOf(n)>-1;o||(a&&f.warn("User sets an invalid layout, resetting it to the default valid one..."),t.templateOptions.layout=e.layout.defaultValue),s||(n&&f.warn("User sets an invalid format, resetting it to the default valid one..."),t.templateOptions.format=e.format.defaultValue),a&&"MAP_ONLY"===a.toUpperCase()&&(t._layoutTabSelected=!1)}}),p.init(this,"templateOptions.format",function(e){var i=t.viewModel.templatesInfo;if(i&&e){var n=!1;i.format.choiceList&&i.format.choiceList.forEach(function(i){i.toUpperCase()===e.toUpperCase()&&(t.templateOptions.format=i,n=!0)}),n||(t.templateOptions.format=i.format.defaultValue,f.warn("User sets an invalid format, resetting it to the default valid one...")),t.scheduleRender()}}),p.init(this,"templateOptions.layout",function(e){var i=t.viewModel.templatesInfo;if(i&&e){t._layoutTabSelected="MAP_ONLY"!==e.toUpperCase();var n=!t._layoutTabSelected;n||i.layout.choiceList&&i.layout.choiceList.forEach(function(i){i.toUpperCase()===e.toUpperCase()&&(t.templateOptions.layout=i,n=!0)}),n||(t.templateOptions.layout=i.layout.defaultValue,f.warn("User sets an invalid layout, resetting it to the default valid one...")),t.scheduleRender()}}),p.init(this,"templateOptions.dpi",function(e){if(e<=0)return void(t.templateOptions.dpi=1);t.scheduleRender()}),p.init(this,"viewModel.view.scale",function(e){var i=t.templateOptions,n=i.scale;i.scaleEnabled&&n||(t.templateOptions.scale=e)}),p.whenOnce(this,"printServiceUrl",function(){var e=setTimeout(function(){t._awaitingServerResponse=!0,t.scheduleRender()},500);t.viewModel.load().then(function(){return clearTimeout(e)})})]);var e=this.templateOptions,i=e.height,n=e.width;this.templateOptions.width=n||800,this.templateOptions.height=i||1100},e.prototype.render=function(){var t,e=this.templateOptions,i=e.attributionEnabled,n=e.author,o=e.copyright,s=e.dpi,r=e.format,l=e.height,p=e.layout,d=e.legendEnabled,c=e.scaleEnabled,u=e.scale,h=e.width,b=this.renderTitleOrFileNameSection(),_=this.get("viewModel.templatesInfo.format.choiceList")||[],y=_.length>0?_.map(function(t){var e=t===r;return v.tsx("option",{key:t,selected:e,value:t},t.toUpperCase())}):v.tsx("option",{key:"format-default-option"},a.formatDefaultOption),f=v.tsx("div",{class:x.formSectionContainer},v.tsx("label",null,a.fileFormatTitle,v.tsx("select",{class:x.select,onchange:this._updateFromOption,"data-target-property":"format",bind:this},y))),g=this.get("viewModel.templatesInfo.layout.choiceList")||[],m=g.length>0?g.map(function(t){var e=t===p,i=a[t]||t;return v.tsx("option",{key:t,selected:e,value:t},i)}):v.tsx("option",{key:"layout-default-option"},a.layoutDefaultOption),O=v.tsx("div",{class:x.formSectionContainer},v.tsx("label",null,a.layoutTitle,v.tsx("select",{class:x.select,onchange:this._updateFromOption,"data-target-property":"layout",bind:this},m))),w=v.tsx("div",{class:x.formSectionContainer},v.tsx("label",null,a.dpi,v.tsx("input",{type:"number",class:this.classes(x.inputText,x.input),"data-input-name":"dpi",oninput:this._updateInputValue,value:""+s,min:"1",tabIndex:0,bind:this}))),T=v.tsx("div",{class:this.classes(x.scaleInfoContainer,x.formSectionContainer)},v.tsx("label",null,v.tsx("input",{"data-option-name":"scaleEnabled",checked:c,type:"checkbox",tabIndex:0,onchange:this._toggleInputValue,bind:this}),a.scale),v.tsx("div",{class:x.scaleInputContainer},v.tsx("input",{"aria-label":a.scaleLabel,"aria-valuenow":""+u,role:"spinbutton",type:"number",class:this.classes(x.inputText,x.input,x.scaleInput),tabIndex:0,"data-input-name":"scale",oninput:this._updateInputValue,disabled:!c,value:""+u,bind:this}),v.tsx("button",{role:"button","aria-label":a.reset,class:this.classes(x.widgetButton,x.refreshButton,x.iconRefresh),tabIndex:0,onclick:this._resetToCurrentScale,bind:this}))),C=this._advancedOptionsVisibleForLayout?v.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForLayout",class:x.advancedOptionsContainer},T,v.tsx("div",{class:this.classes(x.authorInfoContainer,x.formSectionContainer)},v.tsx("label",null,a.author,v.tsx("input",{type:"text",value:n,class:this.classes(x.inputText,x.input),tabIndex:0,"data-input-name":"author",oninput:this._updateInputValue,bind:this}))),v.tsx("div",{class:this.classes(x.copyrightInfoContainer,x.formSectionContainer)},v.tsx("label",null,a.copyright,v.tsx("input",{type:"text",class:this.classes(x.inputText,x.input),tabIndex:0,value:o,"data-input-name":"copyright",oninput:this._updateInputValue,bind:this}))),w,v.tsx("div",{class:this.classes(x.legendInfoContainer,x.formSectionContainer)},v.tsx("label",null,v.tsx("input",{type:"checkbox","data-option-name":"legendEnabled",tabIndex:0,checked:d,onchange:this._toggleInputValue,bind:this}),a.legend))):null,I=this._advancedOptionsVisibleForMapOnly?v.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForMapOnly",class:x.advancedOptionsContainer},T,w,v.tsx("div",{class:x.formSectionContainer},v.tsx("label",null,v.tsx("input",{"data-option-name":"attributionEnabled",type:"checkbox",onchange:this._toggleInputValue,tabIndex:0,checked:i,bind:this}),a.attribution))):null,S=this._layoutTabSelected?v.tsx("section",{key:"esri-print__layoutContent",id:this.id+"__layoutContent","aria-labelledby":this.id+"__layoutTab",class:x.layoutSection,role:"tabpanel","aria-selected":this._layoutTabSelected},v.tsx("div",{class:x.panelContainer},b,O,this._layoutTabSelected?f:null),v.tsx("div",{class:this.classes(x.panelContainer,x.advancedOptionsSection)},v.tsx("button",{"aria-label":a.advancedOptions,"aria-expanded":this._advancedOptionsVisibleForLayout?"true":"false",role:"button",class:x.advancedOptionsButton,onclick:this._showAdvancedOptions,bind:this},v.tsx("div",{class:x.advancedOptionsButtonContainer},v.tsx("span",{"aria-hidden":"true",class:this.classes(x.iconRightTriangleArrow,x.advancedOptionsButtonIconClosed)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(x.iconLeftTriangleArrow,x.advancedOptionsButtonIconClosed_RTL)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(x.iconDownArrow,x.advancedOptionsButtonIconOpened)}),v.tsx("span",{class:x.advancedOptionsButtonTitle},a.advancedOptions))),C)):v.tsx("section",{key:"esri-print__mapOnlyContent",id:this.id+"__mapOnlyContent","aria-selected":!this._layoutTabSelected,"aria-labelledby":this.id+"__mapOnlyTab",class:x.mapOnlySection,role:"tabpanel"},v.tsx("div",{class:x.panelContainer},b,this._layoutTabSelected?null:f,v.tsx("div",{class:this.classes(x.sizeContainer,x.formSectionContainer)},v.tsx("div",{class:x.widthContainer},v.tsx("label",null,a.width,v.tsx("input",{type:"text",class:this.classes(x.inputText,x.input),"data-input-name":"width",onchange:this._updateInputValue,value:""+h,tabIndex:0,bind:this}))),v.tsx("div",{class:x.heightContainer},v.tsx("label",null,a.height,v.tsx("input",{type:"text",class:this.classes(x.inputText,x.input),"data-input-name":"height",onchange:this._updateInputValue,value:""+l,tabIndex:0,bind:this}))),v.tsx("button",{role:"button","aria-label":a.swap,class:this.classes(x.widgetButton,x.swapButton,x.iconSwap),onclick:this._switchInput,tabIndex:0,bind:this})),v.tsx("div",{class:this.classes(x.panelContainer,x.advancedOptionsSection)},v.tsx("button",{"aria-label":a.advancedOptions,"aria-expanded":this._advancedOptionsVisibleForMapOnly?"true":"false",role:"button",class:x.advancedOptionsButton,onclick:this._showAdvancedOptions,bind:this},v.tsx("div",{class:x.advancedOptionsButtonContainer},v.tsx("span",{"aria-hidden":"true",class:this.classes(x.iconRightTriangleArrow,x.advancedOptionsButtonIconClosed)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(x.iconLeftTriangleArrow,x.advancedOptionsButtonIconClosed_RTL)}),v.tsx("span",{"aria-hidden":"true",class:this.classes(x.iconDownArrow,x.advancedOptionsButtonIconOpened)}),v.tsx("span",{class:x.advancedOptionsButtonTitle},a.advancedOptions))),I))),L=this.exportedLinks.toArray(),k=this._renderExportedLink(L),F=(t={},t[x.buttonDisabled]=!p&&!r,t),M=null!=this.get("view")&&"2d"!==this.get("view.type"),E=v.tsx("div",{class:x.panelError},M?a.sceneViewError:a.serviceError),V=v.tsx("div",null,v.tsx("ul",{class:x.layoutTabList,role:"tablist",onclick:this._toggleLayoutPanel,onkeydown:this._handleLayoutPanelKeyDown,bind:this},v.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__layoutTab","data-tab-id":"layoutTab",class:x.layoutTab,role:"tab",tabIndex:0,"aria-selected":""+this._layoutTabSelected},a.layoutTab),v.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__mapOnlyTab","data-tab-id":"mapOnlyTab",class:x.layoutTab,role:"tab",tabIndex:0,"aria-selected":""+!this._layoutTabSelected},a.mapOnlyTab)),S,v.tsx("button",{"aria-label":a.exportDescription,role:"button",class:this.classes(x.printButton,x.button,F),tabIndex:0,onclick:this._handlePrintMap,bind:this},a.export),v.tsx("div",{class:x.exportedFilesContainer,afterUpdate:this._scrollExportIntoView,onclick:this._removeLink,bind:this},v.tsx("h3",{class:this.classes(x.exportedFilesTitle,x.header)},a.exportText),L.length>0?null:v.tsx("div",null,v.tsx("div",null,a.exportHint)),k)),B=v.tsx("div",null,v.tsx("div",{class:x.printWidgetContainer},v.tsx("header",{class:x.headerTitle},a.export),this.error||!this.printServiceUrl||M||!this.view?E:V)),A="initializing"===this.get("viewModel.state"),P=A?this._renderLoader():B;return v.tsx("div",{afterCreate:v.storeNode,bind:this,class:x.base,"data-node-ref":"_rootNode"},P)},e.prototype.renderTitleOrFileNameSection=function(){var t,e,i,n,o=this.templateOptions;return this._layoutTabSelected?(t=a.title,e=a.titlePlaceHolder,i=o.title,n="title"):(t=a.fileName,e=a.fileNamePlaceHolder,i=o.fileName,n="fileName"),v.tsx("div",{class:x.formSectionContainer,key:n},v.tsx("label",null,t,v.tsx("input",{type:"text",tabIndex:0,placeholder:e,class:this.classes(x.inputText,x.input),value:i,"data-input-name":n,oninput:this._updateInputValue,bind:this})))},e.prototype._focusOnTabChange=function(t){if(this._activeTabFocusRequested){var e=t.getAttribute("data-tab-id");("layoutTab"===e&&this._layoutTabSelected||"mapOnlyTab"===e&&!this._layoutTabSelected)&&(t.focus(),this._activeTabFocusRequested=!1)}},e.prototype._renderLoader=function(){var t,e=(t={},t[x.loader]=this._awaitingServerResponse,t);return v.tsx("div",{class:this.classes(e),key:"loader"})},e.prototype._createFileLink=function(t,e){var i=e||a.untitled,n=t.format.toLowerCase(),o=n.indexOf("png")>-1?"png":n,s=i+o;return void 0!==this._exportedFileNameMap[s]?this._exportedFileNameMap[s]++:this._exportedFileNameMap[s]=0,new h({name:i,extension:o,count:this._exportedFileNameMap[s]})},e.prototype._toPrintTemplate=function(t){var e=t.attributionEnabled,i=t.author,n=t.copyright,a=t.dpi,o=t.forceFeatureAttributes,s=t.format,r=t.height,l=t.layout,p=t.legendEnabled,d=t.title,u=t.scale,h=t.width,b=new c({attributionVisible:e,layoutOptions:{authorText:i||"",copyrightText:n||"",titleText:d||""},forceFeatureAttributes:o,format:s,layout:l,outScale:u});return h&&(b.exportOptions.width=h),r&&(b.exportOptions.height=r),a&&(b.exportOptions.dpi=a),p||(b.layoutOptions.legendLayers=[]),b},e.prototype._resetToCurrentScale=function(){this.templateOptions.scale=this.viewModel.view.scale},e.prototype._updateInputValue=function(t){var e=t.target,i=e.getAttribute("data-input-name");this.templateOptions[i]=e.value},e.prototype._handlePrintMap=function(){var t=this;this._pendingExportScroll=!0;var e=this.templateOptions,i=this._toPrintTemplate(e),n=this._layoutTabSelected?i.layoutOptions.titleText:e.fileName,a=this._createFileLink(i,n);this.exportedLinks.add(a),this.viewModel.print(i).then(function(t){a.set({url:t&&t.url,state:"ready"})}).catch(function(){a.set({state:"error"})}).then(function(){return t.scheduleRender()})},e.prototype._updateFromOption=function(t){var e=t.target,i=e.selectedOptions?e.selectedOptions.item(0).value:e.options[e.selectedIndex].value,n=e.getAttribute("data-target-property");this.templateOptions[n]=i},e.prototype._switchInput=function(){var t;t=[this.templateOptions.height,this.templateOptions.width],this.templateOptions.width=t[0],this.templateOptions.height=t[1]},e.prototype._showAdvancedOptions=function(){this._layoutTabSelected?this._advancedOptionsVisibleForLayout=!this._advancedOptionsVisibleForLayout:this._advancedOptionsVisibleForMapOnly=!this._advancedOptionsVisibleForMapOnly},e.prototype._scrollExportIntoView=function(){if(this._pendingExportScroll){this._pendingExportScroll=!1;var t=this,e=t._rootNode,i=t._rootNode,n=i.clientHeight,a=i.scrollHeight,o=a-n;o>0&&(e.scrollTop=o)}},e.prototype._toggleInputValue=function(t){var e=t.target,i=e.getAttribute("data-option-name");this.templateOptions[i]=e.checked,"scaleEnabled"===i&&(this.viewModel.scaleEnabled=this.templateOptions.scaleEnabled,this.templateOptions[i]||this._resetToCurrentScale())},e.prototype._removeLink=function(t){var e=t.target,i=e["data-item"];i&&"error"===i.state&&this.exportedLinks.remove(i)},e.prototype._renderExportedLink=function(t){var e=this;return t.map(function(t){var i,n,o,s=(i={},i[x.anchorDisabled]="pending"===t.state||"error"===t.state,i),r=(n={},n[x.iconSpinner]="pending"===t.state,n[x.rotate]="pending"===t.state,n[x.iconDownload]="ready"===t.state,n[x.iconError]="error"===t.state,n[x.exportedFileError]="error"===t.state,n),p=(o={},o[x.exportedFileError]="error"===t.state,o),d=""===t.url?null:t.url;d&&(d=l.addProxy(d));var c;return c="pending"===t.state?a.pending:"ready"===t.state?a.ready:a.error,v.tsx("div",{"aria-label":c,key:t.formattedName,class:x.exportedFile},v.tsx("a",{"aria-label":t.formattedName+". "+a.linkReady,href:d,rel:"noreferrer",tabIndex:0,target:"_blank",class:e.classes(x.exportedFileLink,s)},v.tsx("span",{"data-item":t,class:e.classes(r)}),v.tsx("span",{"data-item":t,class:e.classes(x.exportedFileLinkTitle,p)},t.formattedName)))})},e.prototype._toggleLayoutPanel=function(t){var e=t.target;this._toggleTab(e.getAttribute("data-tab-id"))},e.prototype._toggleTab=function(t){if(this._layoutTabSelected="layoutTab"===t,this._layoutTabSelected){var e=this.get("viewModel.templatesInfo.layout.choiceList");this.templateOptions.layout=e&&e[0]}else this.templateOptions.layout="MAP_ONLY";this._activeTabFocusRequested=!0},e.prototype._handleLayoutPanelKeyDown=function(t){var e=s.eventKey(t),i=t.target,n=i.getAttribute("data-tab-id");if("Enter"===e||" "===e)return this._toggleTab(n),t.preventDefault(),void t.stopPropagation();"ArrowLeft"!==e&&"ArrowRight"!==e||(this._toggleTab("layoutTab"===n?"mapOnlyTab":"layoutTab"),t.preventDefault(),t.stopPropagation())},n([d.property({type:y}),v.renderable()],e.prototype,"exportedLinks",void 0),n([d.property()],e.prototype,"iconClass",void 0),n([d.property()],e.prototype,"label",void 0),n([v.renderable(),d.property({type:_})],e.prototype,"templateOptions",void 0),n([d.aliasOf("viewModel.error")],e.prototype,"error",void 0),n([d.aliasOf("viewModel.printServiceUrl")],e.prototype,"printServiceUrl",void 0),n([d.aliasOf("viewModel.view"),v.renderable()],e.prototype,"view",void 0),n([d.property({type:b}),v.renderable(["viewModel.templatesInfo","viewModel.state"])],e.prototype,"viewModel",void 0),e=n([d.subclass("esri.widgets.Print")],e)}(d.declared(u))});