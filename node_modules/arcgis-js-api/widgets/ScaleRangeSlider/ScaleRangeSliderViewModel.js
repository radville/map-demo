// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/awaiterHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/Accessor","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators","./ScaleRanges","../Slider/SliderViewModel"],function(e,a,t,i,r,n,l,o,s,c,d,p){return function(e){function a(a){var t=e.call(this,a)||this;return t.layer=null,t.scaleRanges=d.fromScaleRange({minScale:0,maxScale:0}),t.sliderViewModel=function(){var e=t._getSliderIndexRange(t.scaleRanges.length-1).max;return new p({precision:10,min:0,max:e,values:[0,e]})}(),t}return i(a,e),a.prototype.initialize=function(){var e=this;this.handles.add([s.init(this,"sliderViewModel.values",function(){if(e._hasTiledLayer()){var a=e.sliderViewModel.values,t=a[0],i=a[1],r=e.mapScaleToSlider(e._getTiledLayerMaxScale()),n=e.mapScaleToSlider(e._getTiledLayerMinScale()),l=t<n;(i>r||l)&&(e.sliderViewModel.values=[Math.max(t,n),Math.min(i,r)])}}),s.init(this,"layer.loaded",function(){return t(e,void 0,void 0,function(){var e,a,t,i,r,l;return n(this,function(n){switch(n.label){case 0:return e=this,a=e.layer,t=e.view,a?t?[4,t.when()]:[3,2]:[2];case 1:n.sent(),n.label=2;case 2:return[4,a.when()];case 3:return i=n.sent(),r=i.minScale,l=i.maxScale,this.set({minScale:r,maxScale:l}),[2]}})})})])},Object.defineProperty(a.prototype,"maxScale",{get:function(){var e=this.mapSliderToScale(this.sliderViewModel.values[1]);return Math.round(this._handleEdgeScale("max",e))},set:function(e){this._setMaxScaleOnSlider(e)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"maxScaleLimit",{get:function(){return this.mapSliderToScale(this.sliderViewModel.max)},set:function(e){this._setSliderRange({maxScale:e,minScale:this.minScaleLimit})},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"minScale",{get:function(){var e=this.mapSliderToScale(this.sliderViewModel.values[0]);return Math.round(this._handleEdgeScale("min",e))},set:function(e){this._setMinScaleOnSlider(e)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"minScaleLimit",{get:function(){return this.mapSliderToScale(this.sliderViewModel.min)},set:function(e){this._setSliderRange({maxScale:this.maxScaleLimit,minScale:e})},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"state",{get:function(){var e=this,a=e.view,t=e.layer;return!a&&!t||!a&&t&&t.loaded||!t&&a&&a.ready||a&&a.ready&&t&&t.loaded?"ready":"disabled"},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"view",{set:function(e){this._set("view",e)},enumerable:!0,configurable:!0}),a.prototype.mapScaleToSlider=function(e){var a=this.scaleRanges.scaleToRangeIndex(e),t=this.scaleRanges.findScaleRangeByIndex(a),i=t.maxScale,r=t.minScale,n=this._getSliderIndexRange(a),l=n.max,o=n.min;return this._mapToRange(e,r,i,o,l)},a.prototype.mapSliderToScale=function(e){var a=this.scaleRanges.findScaleRangeByIndex(e),t=a.maxScale,i=a.minScale,r=this._getSliderIndexRange(e),n=r.max,l=r.min;return this._mapToRange(e,l,n,i,t)},a.prototype._setSliderRange=function(e){this.scaleRanges=d.fromScaleRange(e);var a=this._getSliderIndexRange(this.scaleRanges.length-1).max;this.sliderViewModel.max=a,this.sliderViewModel.min=0,this.notifyChange("maxScaleLimit"),this.notifyChange("minScaleLimit")},a.prototype._getSliderIndexRange=function(e){var a=Math.floor(e);return{min:a,max:a+.99999}},a.prototype._mapToRange=function(e,a,t,i,r){return i+(e-a)*(r-i)/(t-a)},a.prototype._setMaxScaleOnSlider=function(e){var a=this,t=a.scaleRanges,i=a.sliderViewModel;if(void 0!==e){var r=this.mapScaleToSlider(this._constrainMaxScaleToLayer(t.clampMaxScale(e)));i.values=[i.values[0],r]}},a.prototype._setMinScaleOnSlider=function(e){var a=this,t=a.scaleRanges,i=a.sliderViewModel;if(void 0!==e){var r=this.mapScaleToSlider(this._constrainMinScaleToLayer(t.clampMinScale(e)));i.values=[r,i.values[1]]}},a.prototype._constrainMinScaleToLayer=function(e){var a=this.scaleRanges;if(this._hasTiledLayer()){var t=a.firstRange,i=this._getTiledLayerMinScale();e=this._mapToRange(e,t.maxScale,t.minScale,0,1)>.85?i:e>i?i:e}return e},a.prototype._constrainMaxScaleToLayer=function(e){if(this._hasTiledLayer()){var a=this._getTiledLayerMaxScale();e=e<a?a:e}return e},a.prototype._handleEdgeScale=function(e,a){var t="max"===e?"maxScale":"minScale";return this.scaleRanges[t]===a?0:a},a.prototype._getLayerLODS=function(){return this.get("layer.tileInfo.lods")},a.prototype._getTiledLayerMinScale=function(){var e=this._getLayerLODS();return this.scaleRanges.clampMinScale(e[0].scale)},a.prototype._getTiledLayerMaxScale=function(){var e=this._getLayerLODS();return e[e.length-1].scale},a.prototype._hasTiledLayer=function(){return!!this._getLayerLODS()},r([c.property()],a.prototype,"layer",void 0),r([c.property({dependsOn:["sliderViewModel.values"]})],a.prototype,"maxScale",null),r([c.property({dependsOn:["sliderViewModel.max"]})],a.prototype,"maxScaleLimit",null),r([c.property({dependsOn:["sliderViewModel.values"]})],a.prototype,"minScale",null),r([c.property({dependsOn:["sliderViewModel.min"]})],a.prototype,"minScaleLimit",null),r([c.property()],a.prototype,"scaleRanges",void 0),r([c.property()],a.prototype,"sliderViewModel",void 0),r([c.property({dependsOn:["layer.loaded","view.ready"],readOnly:!0})],a.prototype,"state",null),r([c.property()],a.prototype,"view",null),a=r([c.subclass("esri.widgets.ScaleRangeSlider.ScaleRangeSliderViewModel")],a)}(c.declared(o.HandleOwnerMixin(l)))});