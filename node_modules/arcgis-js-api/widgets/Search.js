// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","@dojo/framework/shim/array","dojo/i18n!../nls/common","dojo/i18n!./Search/nls/Search","../intl","../../esri/core/promiseUtils","../core/events","../core/Handles","../core/string","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./Search/SearchResultRenderer","./Search/SearchViewModel","./support/widget"],function(e,t,s,o,n,r,i,a,l,u,c,d,h,p,g,_,v,f){var w={base:"esri-search esri-widget",loader:"esri-widget__loader",loaderText:"esri-widget__loader-text",loaderAnimation:"esri-widget__loader-animation",esriInput:"esri-input",hasMultipleSources:"esri-search--multiple-sources",isLoading:"esri-search--loading",isSearching:"esri-search--searching",showSuggestions:"esri-search--show-suggestions",showSources:"esri-search--sources",showWarning:"esri-search--warning",container:"esri-search__container",input:"esri-search__input",inputContainer:"esri-search__input-container",form:"esri-search__form",submitButton:"esri-search__submit-button",sourcesButton:"esri-search__sources-button",clearButton:"esri-search__clear-button",sourceName:"esri-search__source-name",suggestionsMenu:"esri-search__suggestions-menu",suggestionList:"esri-search__suggestions-list",suggestionListCurrentLocation:"esri-search__suggestions-list--current-location",sourcesMenu:"esri-search__sources-menu",source:"esri-search__source",warningMenu:"esri-search__warning-menu",warningMenuBody:"esri-search__warning-body",warningMenuHeader:"esri-search__warning-header",warningMenuText:"esri-search__warning-text",noValueText:"esri-search__no-value-text",button:"esri-widget--button",fallbackText:"esri-icon-font-fallback-text",header:"esri-widget__heading",locate:"esri-icon-locate-circled",menu:"esri-menu",menuList:"esri-menu__list",menuItem:"esri-menu__list-item",menuItemActive:"esri-menu__list-item--active",menuHeader:"esri-menu__header",loadingIcon:"esri-icon-loading-indicator esri-rotating",searchIcon:"esri-icon-search",dropdownIcon:"esri-icon-down-arrow esri-search__sources-button--down",dropupIcon:"esri-icon-up-arrow esri-search__sources-button--up",clearIcon:"esri-icon-close",noticeIcon:"esri-icon-notice-triangle",widgetIcon:"esri-icon-search",disabled:"esri-disabled"},y=/<[a-z\/][\s\S]*>/i;return function(e){function t(t){var s=e.call(this,t)||this;return s._handles=new c,s._inputNode=null,s._sourceMenuButtonNode=null,s._sourceListNode=null,s._suggestionListNode=null,s._searchResultRenderer=new _,s._relatedTarget=null,s.activeMenu="none",s.activeSource=null,s.activeSourceIndex=null,s.allPlaceholder=null,s.allSources=null,s.autoNavigate=null,s.autoSelect=null,s.defaultSources=null,s.goToOverride=null,s.iconClass=w.widgetIcon,s.includeDefaultSources=null,s.label=i.widgetLabel,s.locationEnabled=null,s.maxResults=null,s.maxSuggestions=null,s.minSuggestCharacters=null,s.popupEnabled=null,s.popupTemplate=null,s.portal=null,s.resultGraphic=null,s.resultGraphicEnabled=null,s.results=null,s.searchAllEnabled=null,s.searchTerm=null,s.selectedResult=null,s.sources=null,s.suggestions=null,s.suggestionsEnabled=null,s.view=null,s.viewModel=new v,s.own(h.watch(s,"searchTerm",function(e){(e&&"warning"===s.activeMenu||!e&&!s.get("viewModel.selectedSuggestion.location"))&&(s.activeMenu="none")}),h.on(s,"viewModel.allSources","change",function(){return s._watchSourceChanges()}),h.init(s,["viewModel.popupTemplate","viewModel.popupTemplate.content"],function(){"{Match_addr}"===s.get("viewModel.popupTemplate.content")&&(s.viewModel.popupTemplate.content=s._renderSearchResultsContent.bind(s))})),s}return s(t,e),t.prototype.postInitialize=function(){this.viewModel.load()},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this._cancelSuggest(),this._cancelSearch(),this._searchResultRenderer&&(this._searchResultRenderer.viewModel=null,this._searchResultRenderer.destroy(),this._searchResultRenderer=null)},t.prototype.clear=function(){},t.prototype.focus=function(){this._inputNode&&(this.activeMenu="suggestion",this._inputNode.focus(),this.emit("search-focus"))},t.prototype.blur=function(e){this._inputNode&&(this._inputNode.blur(),this._inputBlur(e),this.emit("search-blur"))},t.prototype.search=function(e){var t=this;this.activeMenu="none",this._cancelSuggest(),this._cancelSearch();var s=l.createAbortController(),o=s.signal;return this._searchController=s,this.viewModel.search(e,{signal:o}).catch(function(e){if(t._suggestController===s)return t.activeMenu="none",t._searchController=null,e}).then(function(e){if(t._suggestController===s)return t.activeMenu=e.numResults?"none":"warning",t._searchController=null,e})},t.prototype.suggest=function(e){var t=this;this._cancelSuggest();var s=l.createAbortController(),o=s.signal;return this._suggestController=s,this.viewModel.suggest(e,null,{signal:o}).then(function(e){if(t._suggestController===s)return t._suggestController=null,e.numResults&&(t.activeMenu="suggestion"),t._scrollToTopSuggestion(),e}).catch(function(){if(t._suggestController===s)return t._suggestController=null,null})},t.prototype.render=function(){var e,t,s=this,o=this.viewModel,n=o.activeSourceIndex,l=o.suggestions,u=o.maxInputLength,c=o.placeholder,d=o.searchTerm,h=o.searchAllEnabled,p=o.allSources,g=this._getSourceName(n),_=(""+d).trim(),y=this,m=y.activeMenu,S=y.id,M=this.viewModel.state,b=this.id+"-suggest-menu",x=f.tsx("input",{bind:this,placeholder:c,"aria-label":i.searchButtonTitle,maxlength:u,autocomplete:"off",type:"text",tabindex:"0",class:this.classes(w.esriInput,w.input),"aria-autocomplete":"list",value:d,"aria-haspopup":"true","aria-owns":b,role:"textbox",onkeydown:this._handleInputKeydown,onkeyup:this._handleInputKeyup,onclick:this._handleInputClick,oninput:this._handleInputPaste,onpaste:this._handleInputPaste,afterCreate:f.storeNode,"data-node-ref":"_inputNode",onfocusout:this._storeRelatedTarget,onfocus:this.focus,onblur:this.blur,title:d?"":c}),C=f.tsx("form",{key:"esri-search__form",bind:this,class:w.form,onsubmit:this._formSubmit,role:"search"},x),k=d?f.tsx("div",{key:"esri-search__clear-button",bind:this,role:"button",class:this.classes(w.clearButton,w.button),tabindex:"0",title:i.clearButtonTitle,onfocus:this._clearButtonFocus,onclick:this._handleClearButtonClick,onkeydown:this._handleClearButtonClick},f.tsx("span",{"aria-hidden":"true",class:w.clearIcon})):null,T=this.locationEnabled&&!_,N=T?f.tsx("ul",{key:"esri-search__suggestion-list-current-location",class:this.classes(w.menuList,w.suggestionList,w.suggestionListCurrentLocation)},f.tsx("li",{bind:this,onclick:this._handleUseCurrentLocationClick,onkeydown:this._handleUseCurrentLocationClick,onkeyup:this._handleSuggestionKeyup,role:"menuitem",class:w.menuItem,tabindex:"-1"},f.tsx("span",{"aria-hidden":"true",role:"presentation",class:w.locate})," ",i.useCurrentLocation)):null,L=p.length>1&&n===v.ALL_INDEX,B=l?l.map(function(e){var t=e.sourceIndex,o=e.results.length,n=o&&L?s._getSuggestionHeaderNode(t):null,r=e.results,i=r.map(function(e,t){return s._getSuggestionNode(e,t)});return[n,o?f.tsx("ul",{key:"esri-search__suggestion-list-"+t,class:s.classes(w.menuList,w.suggestionList)},i):null]}):null,E=f.tsx("div",{id:b,"aria-expanded":"suggestion"===m,key:"esri-search__suggestions-menu",class:this.classes(w.menu,w.suggestionsMenu),role:"menu",bind:this,afterCreate:f.storeNode,"data-node-ref":"_suggestionListNode"},N,B),I=f.tsx("div",{key:"esri-search__input-container",class:w.inputContainer},C,E,k),R=f.tsx("div",{key:"esri-search__submit-button",bind:this,role:"button",title:i.searchButtonTitle,class:this.classes(w.submitButton,w.button),tabindex:"0",onclick:this._handleSearchButtonClick,onkeydown:this._handleSearchButtonClick},f.tsx("span",{"aria-hidden":"true",role:"presentation",class:w.searchIcon}),f.tsx("span",{class:w.fallbackText},i.searchButtonTitle)),A=_?a.substitute(i.noResultsFoundForValue,{value:'"'+d+'"'}):i.noResultsFound,O=o.get("selectedSuggestion.location")||_?f.tsx("div",{key:"esri-search__no_results"},f.tsx("div",{class:w.warningMenuHeader},i.noResults),f.tsx("div",{class:w.warningMenuText},A)):null,K=o.get("selectedSuggestion.location")||_?null:f.tsx("div",{key:"esri-search__empty-search"},f.tsx("span",{"aria-hidden":"true",class:w.noticeIcon}),f.tsx("span",{class:w.noValueText},i.emptyValue)),H=f.tsx("div",{key:"esri-search__error-menu",class:this.classes(w.menu,w.warningMenu)},f.tsx("div",{class:w.warningMenuBody},O,K)),D=p.length>1,U=p&&p.toArray(),P=h?this._getSourceNode(v.ALL_INDEX):null,G=S+"-source-menu",F=D?f.tsx("div",{key:"esri-search__source-menu-button",bind:this,role:"button",title:i.searchIn,"aria-haspopup":"true","aria-expanded":"source"===m,"aria-controls":G,class:this.classes(w.sourcesButton,w.button),tabindex:"0",onkeydown:this._handleSourceMenuButtonKeydown,onclick:this._handleSourcesMenuToggleClick,onkeyup:this._handleSourceMenuButtonKeyup,onblur:this._sourcesButtonBlur,afterCreate:f.storeNode,"data-node-ref":"_sourceMenuButtonNode"},f.tsx("span",{"aria-hidden":"true",role:"presentation",class:w.dropdownIcon}),f.tsx("span",{"aria-hidden":"true",role:"presentation",class:w.dropupIcon}),f.tsx("span",{class:w.sourceName},g)):null,V=D?f.tsx("ul",{bind:this,afterCreate:f.storeNode,"data-node-ref":"_sourceListNode",class:w.menuList},P,U.map(function(e,t){return s._getSourceNode(t)})):null,$=f.tsx("div",{id:G,key:"esri-search__source-menu",class:this.classes(w.menu,w.sourcesMenu),role:"menu"},V),j=(e={},e[w.hasMultipleSources]=D,e[w.isLoading]="loading"===M,e[w.isSearching]="searching"===M,e[w.showWarning]="warning"===m,e[w.showSources]="source"===m,e[w.showSuggestions]="suggestion"===m,e),W=(t={},t[w.disabled]="disabled"===M,t),X="loading"===M?f.tsx("div",{role:"presentation",class:w.loader,key:"base-loader"},f.tsx("span",{"aria-hidden":"true",role:"presentation",class:w.loaderAnimation}),f.tsx("span",{class:w.fallbackText},i.searchButtonTitle),f.tsx("span",{class:w.loaderText},r.loading)):f.tsx("div",{role:"presentation",class:this.classes(j,w.container),key:"base-container"},F,$,I,R,H);return f.tsx("div",{class:this.classes(w.base,W)},X)},t.prototype._watchSourceChanges=function(){var e=this,t=this,s=t._handles,o=t.viewModel.allSources;s.remove("sources"),o.forEach(function(t){return s.add(h.watch(t,"name",function(){return e.scheduleRender()}),"sources")})},t.prototype._handleSourceMenuButtonKeydown=function(e){var t=u.eventKey(e);if("ArrowUp"===t||"ArrowDown"===t||"End"===t||"Home"===t)return e.preventDefault(),e.stopPropagation(),void(this.activeMenu="source");this._handleSourcesMenuToggleClick(e)},t.prototype._handleSourcesMenuToggleClick=function(e){var t="source"===this.activeMenu;if(this.activeMenu=t?"none":"source",this.renderNow(),t)return void(this._sourceMenuButtonNode&&this._sourceMenuButtonNode.focus());var s=this._sourceListNode?this._sourceListNode.getElementsByTagName("li"):null;if(s){var o=u.eventKey(e),n="End"===o?s[s.length-1]:s[0];n&&n.focus()}},t.prototype._handleClearButtonClick=function(){this.viewModel.clear(),this._focus()},t.prototype._handleSearchButtonClick=function(){this.search()},t.prototype._handleSuggestionClick=function(e){var t=e.currentTarget,s=t["data-suggestion"];s&&(this._focus(),this.search(s))},t.prototype._handleUseCurrentLocationClick=function(){var e=this;this._focus("none"),this._cancelSuggest(),this._cancelSearch();var t=l.createAbortController(),s=t.signal;this._searchController=t,this.viewModel.searchNearby({signal:s}).catch().then(function(){e._searchController=null})},t.prototype._handleSourceClick=function(e){var t=e.currentTarget,s=t["data-source-index"];this.viewModel.activeSourceIndex=s,this._focus("none")},t.prototype._sourcesButtonBlur=function(e){var t=e&&e.relatedTarget;this._removeActiveMenu(t,this._sourceListNode)},t.prototype._inputBlur=function(e){var t=e&&e.relatedTarget;this._removeActiveMenu(t||this._relatedTarget,this._suggestionListNode)},t.prototype._storeRelatedTarget=function(e){this._relatedTarget=e.relatedTarget},t.prototype._clearButtonFocus=function(){this.activeMenu="none"},t.prototype._removeActiveMenu=function(e,t){!e||e&&t&&t.contains(e)||(this.activeMenu="none")},t.prototype._cancelSuggest=function(){this._suggestController&&(this._suggestController.abort(),this._suggestController=null)},t.prototype._cancelSearch=function(){this._searchController&&(this._searchController.abort(),this._searchController=null)},t.prototype._handleInputKeydown=function(e){var t=u.eventKey(e);("Tab"===t||"Escape"===t||e.shiftKey&&"Tab"===t)&&this._cancelSuggest()},t.prototype._handleInputKeyup=function(e){var t=u.eventKey(e),s=e.ctrlKey||e.metaKey||"Copy"===t||"ArrowLeft"===t||"ArrowRight"===t||"Enter"===t||"Shift"===t,o=this._suggestionListNode?this._suggestionListNode.getElementsByTagName("li"):null;if(!s){if("Tab"===t||"Escape"===t||e.shiftKey&&"Tab"===t)return this._cancelSuggest(),void("Escape"===t&&(this.activeMenu="none"));if(("ArrowUp"===t||"ArrowDown"===t)&&o){this.activeMenu="suggestion",e.stopPropagation(),e.preventDefault(),this._cancelSuggest();var n="ArrowUp"===t?o.length-1:0,r=o[n];return void(r&&r.focus())}this.viewModel.searchTerm&&this.suggest()}},t.prototype._scrollToTopSuggestion=function(){this._suggestionListNode&&(this._suggestionListNode.scrollTop=0)},t.prototype._handleInputClick=function(){this.activeMenu="suggestion"},t.prototype._handleInputPaste=function(e){var t=e.target;this.viewModel.searchTerm!==t.value&&(this.viewModel.searchTerm=t.value),this.viewModel.searchTerm&&this.suggest()},t.prototype._handleSourceMenuButtonKeyup=function(e){var t=u.eventKey(e);if("ArrowUp"===t||"ArrowDown"===t||"Home"===t||"End"===t){e.stopPropagation(),e.preventDefault();var s=this._sourceListNode?this._sourceListNode.getElementsByTagName("li"):null;if(s){var o="ArrowUp"===t||"End"===t?s.length-1:0,n=s[o];n&&n.focus()}}},t.prototype._handleSourceKeyup=function(e){var t=e.target,s=this._sourceListNode?n.from(this._sourceListNode.getElementsByTagName("li")):null,o=u.eventKey(e);if("Escape"===o)return this._focus("none"),void(this._sourceMenuButtonNode&&this._sourceMenuButtonNode.focus());if(s){var r=s.indexOf(t);if("Home"!==o&&"End"!==o&&"ArrowUp"!==o&&"ArrowDown"!==o||(e.stopPropagation(),e.preventDefault()),"Home"===o){var i=s[0];return void(i&&i.focus())}if("End"===o){var a=s[s.length-1];return void(a&&a.focus())}if("ArrowUp"===o){var l=r-1,c=l<0?this._sourceMenuButtonNode:s[l];return void(c&&c.focus())}if("ArrowDown"===o){var d=r+1,h=d>=s.length?this._sourceMenuButtonNode:s[d];h&&h.focus()}}},t.prototype._handleSuggestionKeyup=function(e){var t=e.target,s=this._suggestionListNode?n.from(this._suggestionListNode.getElementsByTagName("li")):null,o=s.indexOf(t),r=u.eventKey(e);if(this._cancelSuggest(),"Backspace"===r||"Delete"===r)return void this._focus();if("Escape"===r)return void this._focus("none");if(s){if("Home"!==r&&"End"!==r&&"ArrowUp"!==r&&"ArrowDown"!==r||(e.stopPropagation(),e.preventDefault()),"Home"===r){var i=s[0];i&&i.focus()}if("End"===r){var a=s[s.length-1];a&&a.focus()}if("ArrowUp"===r){var l=o-1,c=l<0?s[s.length-1]:s[l];return void(c&&c.focus())}if("ArrowDown"===r){var d=o+1,h=d>=s.length?s[0]:s[d];return void(h&&h.focus())}}},t.prototype._focus=function(e){this.focus(),e&&(this.activeMenu=e)},t.prototype._formSubmit=function(e){e.preventDefault(),this.search()},t.prototype._getSourceName=function(e){var t=this.viewModel,s=t.allSources,o=s.getItemAt(e);return e===v.ALL_INDEX?i.all:o?o.name||i.untitledSource:i.untitledSource},t.prototype._getSuggestionHeaderNode=function(e){var t=this._getSourceName(e);return f.tsx("div",{key:"esri-search__suggestion-header-"+e,class:w.menuHeader},t)},t.prototype._splitResult=function(e,t){var s=d.escapeRegExpString(t);return e.replace(new RegExp("(^|)("+s+")(|$)","ig"),"$1|$2|$3").split("|")},t.prototype._getSuggestionNode=function(e,t){var s=this.viewModel,o=s.searchTerm;if(o){var n=e.text,r=n||i.untitledResult,a=y.test(r),l=[];if(a)l.push(f.tsx("div",{innerHTML:r}));else{var u=this._splitResult(r,o),c=o.toLowerCase();u.forEach(function(e,t){e&&e.length&&(e.toLowerCase()===c?l.push(f.tsx("strong",{key:t},e)):l.push(e))})}return f.tsx("li",{bind:this,onclick:this._handleSuggestionClick,onkeydown:this._handleSuggestionClick,onkeyup:this._handleSuggestionKeyup,key:"esri-search__suggestion$-{sourceIndex}_"+t,"data-suggestion":e,role:"menuitem",class:w.menuItem,tabindex:"-1"},l)}},t.prototype._getSourceNode=function(e){var t,s=(t={},t[w.menuItemActive]=e===this.viewModel.activeSourceIndex,t);return f.tsx("li",{bind:this,key:"esri-search__source-"+e,onclick:this._handleSourceClick,onkeydown:this._handleSourceClick,onkeyup:this._handleSourceKeyup,"data-source-index":e,role:"menuitem",class:this.classes(w.source,w.menuItem,s),tabindex:"-1"},this._getSourceName(e))},t.prototype._renderSearchResultsContent=function(){return this._searchResultRenderer.showMoreResultsOpen=!1,this._searchResultRenderer.viewModel=this.viewModel,this._searchResultRenderer},o([p.property(),f.renderable()],t.prototype,"activeMenu",void 0),o([p.aliasOf("viewModel.activeSource"),f.renderable()],t.prototype,"activeSource",void 0),o([p.aliasOf("viewModel.activeSourceIndex"),f.renderable()],t.prototype,"activeSourceIndex",void 0),o([p.aliasOf("viewModel.allPlaceholder"),f.renderable()],t.prototype,"allPlaceholder",void 0),o([p.aliasOf("viewModel.allSources")],t.prototype,"allSources",void 0),o([p.aliasOf("viewModel.autoNavigate")],t.prototype,"autoNavigate",void 0),o([p.aliasOf("viewModel.autoSelect")],t.prototype,"autoSelect",void 0),o([p.aliasOf("viewModel.defaultSources")],t.prototype,"defaultSources",void 0),o([p.aliasOf("viewModel.goToOverride")],t.prototype,"goToOverride",void 0),o([p.property()],t.prototype,"iconClass",void 0),o([p.aliasOf("viewModel.includeDefaultSources")],t.prototype,"includeDefaultSources",void 0),o([p.property()],t.prototype,"label",void 0),o([f.renderable(),p.aliasOf("viewModel.locationEnabled")],t.prototype,"locationEnabled",void 0),o([p.aliasOf("viewModel.maxResults")],t.prototype,"maxResults",void 0),o([p.aliasOf("viewModel.maxSuggestions")],t.prototype,"maxSuggestions",void 0),o([p.aliasOf("viewModel.minSuggestCharacters")],t.prototype,"minSuggestCharacters",void 0),o([p.aliasOf("viewModel.popupEnabled")],t.prototype,"popupEnabled",void 0),o([p.aliasOf("viewModel.popupTemplate")],t.prototype,"popupTemplate",void 0),o([p.aliasOf("viewModel.portal")],t.prototype,"portal",void 0),o([p.aliasOf("viewModel.resultGraphic")],t.prototype,"resultGraphic",void 0),o([p.aliasOf("viewModel.resultGraphicEnabled")],t.prototype,"resultGraphicEnabled",void 0),o([p.aliasOf("viewModel.results"),f.renderable()],t.prototype,"results",void 0),o([p.aliasOf("viewModel.searchAllEnabled"),f.renderable()],t.prototype,"searchAllEnabled",void 0),o([p.aliasOf("viewModel.searchTerm"),f.renderable()],t.prototype,"searchTerm",void 0),o([p.aliasOf("viewModel.selectedResult")],t.prototype,"selectedResult",void 0),o([p.aliasOf("viewModel.sources")],t.prototype,"sources",void 0),o([p.aliasOf("viewModel.suggestions"),f.renderable()],t.prototype,"suggestions",void 0),o([p.aliasOf("viewModel.suggestionsEnabled")],t.prototype,"suggestionsEnabled",void 0),o([p.aliasOf("viewModel.view"),f.renderable()],t.prototype,"view",void 0),o([f.vmEvent(["search-complete","search-clear","search-start","select-result","suggest-start","suggest-complete"]),p.property({type:v}),f.renderable(["viewModel.allSources","viewModel.activeSource.placeholder","viewModel.activeSource.name","viewModel.state"])],t.prototype,"viewModel",void 0),o([p.aliasOf("viewModel.clear")],t.prototype,"clear",null),o([f.accessibleHandler()],t.prototype,"_handleSourcesMenuToggleClick",null),o([f.accessibleHandler()],t.prototype,"_handleClearButtonClick",null),o([f.accessibleHandler()],t.prototype,"_handleSearchButtonClick",null),o([f.accessibleHandler()],t.prototype,"_handleSuggestionClick",null),o([f.accessibleHandler()],t.prototype,"_handleUseCurrentLocationClick",null),o([f.accessibleHandler()],t.prototype,"_handleSourceClick",null),t=o([p.subclass("esri.widgets.Search")],t)}(p.declared(g))});