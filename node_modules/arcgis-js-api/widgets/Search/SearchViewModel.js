// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","dojo/i18n!./nls/Search","../../Graphic","../../PopupTemplate","../../core/Accessor","../../core/Collection","../../core/Error","../../core/Evented","../../core/geolocationUtils","../../core/Handles","../../core/has","../../core/Logger","../../core/maybe","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/Point","../../geometry/SpatialReference","../../portal/Portal","../../styles/basic","../../symbols/PictureMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/TextSymbol","../../views/support/layerViewUtils","./LayerSearchSource","./LocatorSearchSource","./SearchSource","./support/geometryUtils","./support/locatorUtils","../support/GoTo"],function(e,t,r,o,n,s,i,a,l,u,c,p,h,d,g,y,f,v,S,m,_,b,w,x,I,T,R,E,P,L,A,G,O,D,F,C,j){function N(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}var M=f.getLogger("esri.widgets.Search.SearchViewModel"),V=c.ofType({key:function(e){return e.layer?"layer":"locator"},base:D,typeMap:{layer:G,locator:O}}),H=w.WGS84,k=/<(?:.|\s)*?>/g;return function(t){function u(r){var o=t.call(this,r)||this;return o._handles=new g,o._gotoController=null,o._searching=null,o._loadingDefaultSources=null,o.allPlaceholder=i.allPlaceholder,o.autoNavigate=!0,o.autoSelect=!0,o.defaultSources=new V,o.defaultSymbol=new T({url:e.toUrl(y("trident")?"../../images/search/search-symbol-32.png":"../../images/search/search-symbol-32.svg"),size:24,width:24,height:24}),o.includeDefaultSources=!0,o.maxInputLength=128,o.maxResults=6,o.maxSuggestions=6,o.minSuggestCharacters=1,o.popupEnabled=!0,o.popupTemplate=new l({title:i.searchResult,content:"{Match_addr}"}),o.portal=x.getDefault(),o.resultGraphicEnabled=!0,o.resultGraphic=null,o.results=null,o.selectedSuggestion=null,o.searchAllEnabled=!0,o.selectedResult=null,o.sources=new V,o.suggestionDelay=150,o.suggestions=null,o.suggestionsEnabled=!0,o.view=null,o}return r(u,t),u.prototype.initialize=function(){var e=this;this._handles.add(m.on(this,["defaultSources","sources"],"change",function(){return e.notifyChange("allSources")}))},u.prototype.destroy=function(){this._abortGoTo(),this.clearGraphics(),this._loadingDefaultSources=null,this._clearLoadingDefaultSources(),this._handles.destroy(),this._handles=null},Object.defineProperty(u.prototype,"activeSource",{get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||null},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"activeSourceIndex",{get:function(){return 1!==this.allSources.length&&this.searchAllEnabled?-1:0},set:function(e){if(void 0===e)return void this._clearOverride("activeSourceIndex");this._override("activeSourceIndex",e)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"allSources",{get:function(){var e=this,t=e.sources,r=e.defaultSources,o=e.includeDefaultSources,n="function"==typeof o?o.call(null,{sources:t,defaultSources:r}):o?r.concat(t):t,s=this._get("allSources")||new V;return s.removeAll(),s.addMany(n.filter(Boolean)),s},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"locationEnabled",{get:function(){return this._get("locationEnabled")||d.supported()},set:function(e){if(void 0===e)return void this._clearOverride("locationEnabled");var t=d.supported();if(e&&!t){var r=new p("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});M.error(r)}this._override("locationEnabled",e&&t)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"placeholder",{get:function(){var e=this,t=e.allSources,r=e.activeSourceIndex,o=e.allPlaceholder,n=void 0===o?i.allPlaceholder:o;if(-1===r)return n;var s=t.getItemAt(r);return s?s.placeholder:""},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"state",{get:function(){return this._searching?"searching":this._loadingDefaultSources?"loading":0===this.allSources.length?"disabled":"ready"},enumerable:!0,configurable:!0}),u.prototype.load=function(){return s(this,void 0,void 0,function(){var e=this;return n(this,function(t){return this._handles.add([m.init(this,["portal","includeDefaultSources"],function(){return e._loadPortal()}),m.init(this,["view","portal","includeDefaultSources"],function(){return e._loadDefaultSources()})]),[2]})})},u.prototype.clear=function(){this.searchTerm=""},u.prototype.clearGraphics=function(){this._removeHighlight(),this._closePopup(),this.view&&this.view.graphics.remove(this.resultGraphic),this._set("resultGraphic",null)},u.prototype.search=function(e,t){var r=this;this.emit("search-start"),this.clearGraphics();var o=this._createSuggestionForSearch(e),n=this._whenViewAndPortalLoaded().then(function(){return r._getResultsFromSources(o,t).then(function(e){var t={activeSourceIndex:r.activeSourceIndex,searchTerm:o.text,numResults:0,numErrors:0,errors:[],results:[]};r._formatResponse(t,e,o);var n=r._getFirstResult(t.results),s=o.location&&n?n.name:o.text,i=s.replace(k,"");return r._set("searchTerm",i),(o.key&&"number"==typeof o.sourceIndex||o.location)&&r._set("selectedSuggestion",o),r._set("results",t.results),r.emit("search-complete",t),r._selectFirstResult(n).then(function(){return t})})}).then(function(e){return r._clearSearching(),e},function(e){throw r._clearSearching(),e});return this._searching=n,this.notifyChange("state"),n},u.prototype.searchNearby=function(e){var t=this;if(!this.locationEnabled){var r=new p("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});return M.error(r),S.reject(r)}var o=d.getCurrentPosition().then(function(r){return d.positionToPoint({position:r,view:t.view},e)}).then(function(r){return t.search(r,e)});return this._searching=o,this.notifyChange("state"),o.catch(function(){}).then(function(){return t._clearSearching()}),o},u.prototype.select=function(e){var t=this;if(this.clearGraphics(),!e){var r=new p("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});return M.error(r),S.reject(r)}var o=this.view,n=N(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),s=this.allSources.getItemAt(n);if(!s){var r=new p("select:missing-source","Cannot select without a source.",{source:s});return M.error(r),S.reject(r)}var i=s instanceof G?this._getLayerSourcePopupTemplate(s):s.popupTemplate,l=s.resultSymbol||this._getDefaultSymbol(e),u=N(s,"resultGraphicEnabled")?s.resultGraphicEnabled:this.resultGraphicEnabled,c=N(s,"autoNavigate")?s.autoNavigate:this.autoNavigate,h=N(s,"popupEnabled")?s.popupEnabled:this.popupEnabled,d=h?i||this.popupTemplate:null,g=e.feature;if(!g){var r=new p("select:missing-feature","Cannot select without a feature.",{feature:g});return M.error(r),S.reject(r)}var y=g.attributes,f=g.geometry,m=g.layer,_=g.sourceLayer,b=F.getPointFromGeometry(f),w={layerViewQuery:this._getLayerView(g),elevationQuery:o&&v.isSome(b)?F.getPointWithElevation(b,o).catch(function(){return b}):S.resolve(b)};return S.eachAlways(w).then(function(r){var i=r.layerViewQuery.value,p=r.elevationQuery.value;l instanceof L&&(l.text=e.name);var b=o&&c?t._getGoToTarget(e,s):null;return(v.isSome(b)?t._goToSearchResult(b):S.resolve()).then(function(){var r=i?g:new a({geometry:f,symbol:l,attributes:y,layer:m,sourceLayer:_,popupTemplate:d}),c=h&&t.get("view.popup"),v=c&&r.getEffectivePopupTemplate(c.defaultPopupTemplateEnabled);return v&&o.popup.open({features:[r],location:p}),i&&A.hasHighlight(i)&&!v&&t._highlightFeature({graphic:r,layerView:i}),!i&&u&&o&&o.graphics.push(r),t._set("selectedResult",e),t._set("resultGraphic",r),t.emit("select-result",{result:e,source:s,sourceIndex:n}),e})})},u.prototype.suggest=function(e,t,r){var o=this,n=e||this.searchTerm;return this.emit("suggest-start",{searchTerm:n}),this._suggestTimer(t,r).then(function(){return o._suggestImmediate(n,r).then(function(e){return o._set("suggestions",e.results),o.emit("suggest-complete",e),e})})},u.prototype._loadPortal=function(){var e=this,t=e.includeDefaultSources,r=e.portal;t&&r&&!r.loaded&&r.load()},u.prototype._clearLoadingDefaultSources=function(){this._loadingDefaultSources=null,this.notifyChange("state")},u.prototype._clearSearching=function(){this._searching=null,this.notifyChange("state")},u.prototype._convertHelperServices=function(){var e=this.get("portal.helperServices.geocode");return e?e.map(function(e){if(!1!==e.placefinding){var t=O.fromJSON(e);if(C.isArcGISWorldGeocoder(t.get("locator.url"))&&t.set({singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],placeholder:i.placeholder,defaultZoomScale:2500}),t.singleLineFieldName)return t}}).filter(Boolean):[]},u.prototype._convertApplicationProperties=function(){var e=this,t=this.get("view.map.applicationProperties.viewing.search"),r=this.get("view.map");if(!r||!t)return[];var o=t.enabled,n=t.hintText,s=t.layers;return o?s.map(function(t){var o=r.findLayerById(t.id);if(o){var s=e._getLayerJSON(t),i=G.fromJSON(s);return i.placeholder=n,e._getLayer(o,s).then(function(e){i.layer=e}),i}}).filter(Boolean):[]},u.prototype._getSubLayer=function(e,t){if(!e||!e.allSublayers)return S.reject();var r=e.allSublayers.find(function(e){return e.id===t.subLayer});return r?r.createFeatureLayer():S.reject()},u.prototype._getLayer=function(e,t){var r=this;return"feature"===e.type||"scene"===e.type?S.resolve(e):"map-image"===e.type?e.load().then(function(){return r._getSubLayer(e,t).catch(function(){var t=new p("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return M.error(t),null})}):void 0},u.prototype._getLayerJSON=function(e){return"function"==typeof e.toJSON?e.toJSON():e},u.prototype._updateDefaultSources=function(){var e=this,t=e.defaultSources,r=e.includeDefaultSources;t.removeAll(),r&&t.addMany(this._convertApplicationProperties().concat(this._convertHelperServices())),this.notifyChange("allSources")},u.prototype._abortGoTo=function(){this._gotoController&&this._gotoController.abort(),this._gotoController=null},u.prototype._clear=function(){this._abortGoTo(),this._set("results",null),this._set("suggestions",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")},u.prototype._closePopup=function(){var e=this.get("view.popup"),t=this.resultGraphic;if(e&&t){var r=e.selectedFeature;r&&r===t&&e.close()}},u.prototype._suggestTimer=function(e,t){var r=null!=e?e:this.suggestionDelay;return S.after(r,null,t&&t.signal)},u.prototype._createLocationForSearch=function(e){return e instanceof a?F.getPointFromGeometry(e.geometry):e instanceof b?e:Array.isArray(e)&&2===e.length?new b({longitude:e[0],latitude:e[1]}):null},u.prototype._createSuggestionForSearch=function(e){if(e&&N(e,"key")&&N(e,"text")&&N(e,"sourceIndex"))return e;var t=this._createLocationForSearch(e),r="string"==typeof e?e:this.searchTerm,o=this,n=o.selectedSuggestion,s=o.selectedResult,i=!e&&n&&s,a=i&&n.key===s.key&&n.sourceIndex===s.sourceIndex,l=i&&n.location;return a||l?n:{location:v.unwrap(t),text:t?"":r,sourceIndex:null,key:null}},u.prototype._getFirstResult=function(e){var t=null;return e&&e.some(function(e){var r=e.results,o=r[0],n=!!o;return n&&(t=o),n}),t},u.prototype._selectFirstResult=function(e){return this.autoSelect&&e?this.select(e):S.resolve()},u.prototype._suggestImmediate=function(e,t){var r=this;return this._whenViewAndPortalLoaded().then(function(){return r._getSuggestionsFromSources(e,t)}).then(function(t){var o={activeSourceIndex:r.activeSourceIndex,searchTerm:e,numResults:0,numErrors:0,errors:[],results:[]};return r._formatResponse(o,t),o})},u.prototype._formatSourceResponse=function(e,t,r){var o=t&&t.value||[],n=t&&t.error,s=this.allSources.getItemAt(r);if(n){var i={sourceIndex:r,source:s,error:n};e.errors.push(i),e.numErrors++}else{var a={sourceIndex:r,source:s,results:o};e.results.push(a),e.numResults+=o.length}},u.prototype._formatResponse=function(e,t,r){var o=this;if(t)if(-1===e.activeSourceIndex){var n=r&&N(r,"sourceIndex")&&-1!==r.sourceIndex?r.sourceIndex:void 0;t.forEach(function(t,r){var s=void 0!==n?n:r;o._formatSourceResponse(e,t,s)})}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)},u.prototype._getResultsFromSources=function(e,t){var r=this,o=this.allSources,n=!e.location&&N(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,s=[];if(!o.length){var i=new p("search:no-sources-defined","At least one source is required.",{allSources:o});return M.error(i),S.reject(i)}return-1===n?o.forEach(function(o,n){s.push(r._getResultsFromSource(e,n,t))}):s.push(this._getResultsFromSource(e,n,t)),S.eachAlways(s)},u.prototype._getSuggestionsFromSources=function(e,t){var r=this,o=this,n=o.allSources,s=o.activeSourceIndex,i=[];if(!n.length){var a=new p("suggest:no-sources-defined","At least one source is required.",{allSources:n});return M.error(a),S.reject(a)}return-1===s?n.forEach(function(o,n){i.push(r._getSuggestionsFromSource(e,n,t))}):i.push(this._getSuggestionsFromSource(e,s,t)),S.eachAlways(i)},u.prototype._getResultsFromSource=function(e,t,r){var o=this.allSources.getItemAt(t),n=e.location,s=void 0===n?null:n,i=this.get("view.spatialReference")||H,a=N(o,"maxResults")?o.maxResults:this.maxResults,l=!!(o instanceof G&&N(o,"exactMatch"))&&o.exactMatch,u=this.view;return o.getResults({view:u,sourceIndex:t,location:s,suggestResult:e,spatialReference:i,exactMatch:l,maxResults:a},r)},u.prototype._getSuggestionsFromSource=function(e,t,r){var o=this.allSources.getItemAt(t),n=N(o,"suggestionsEnabled")?o.suggestionsEnabled:this.suggestionsEnabled,s=e.length,i=N(o,"minSuggestCharacters")?o.minSuggestCharacters:this.minSuggestCharacters;if(n&&e.trim()&&s>=i){var a=this.get("view.spatialReference")||H,l=N(o,"maxSuggestions")?o.maxSuggestions:this.maxSuggestions,u=this.view;return o.getSuggestions({view:u,sourceIndex:t,suggestTerm:e,spatialReference:a,maxSuggestions:l},r)}return S.resolve()},u.prototype.createDefaultSymbol=function(e,t){if("point"===t){var r=e;return new P({color:e.color,size:r.size,outline:{color:r.outline.color,width:r.outline.width}})}if("polyline"===t){var o=e;return new E({color:o.color,width:o.width})}if("polygon"===t){var n=e;return new R({color:n.color,outline:{color:n.outline.color,width:n.outline.width}})}},u.prototype._getLayerSourcePopupTemplate=function(e){var t=e.layer;if(t)return N(e,"popupTemplate")?e.popupTemplate:t.popupTemplate},u.prototype._getSourceIndexOfResult=function(e){var t=this.results,r=null;return t.some(function(t){return t.results.some(function(o){return o===e&&(r=t.sourceIndex,!0)})}),r},u.prototype._getGoToTarget=function(e,t){var r=e.extent,o=e.feature;return t instanceof G?o||r:r||o},u.prototype._goToSearchResult=function(e){return s(this,void 0,void 0,function(){var t,r,o;return n(this,function(n){switch(n.label){case 0:return t=!!e,this._abortGoTo(),r=S.createAbortController(),this._gotoController=r,o={target:{target:e},options:{animate:t,signal:r.signal}},[4,this.callGoTo(o)];case 1:return n.sent(),this._gotoController=null,[2]}})})},u.prototype._whenViewAndPortalLoaded=function(){var e=this,t=e.includeDefaultSources,r=e.portal,o=e.view,n=o?o.when():S.resolve(),s=r&&t?r.when():S.resolve();return S.eachAlways([n,s]).then(function(){})},u.prototype._loadDefaultSources=function(){return s(this,void 0,void 0,function(){var e,t,r=this;return n(this,function(o){switch(o.label){case 0:return e=this.includeDefaultSources,t=e?this._whenViewAndPortalLoaded():S.resolve(),this._loadingDefaultSources=t,this.notifyChange("state"),[4,t.catch(function(){}).then(function(){r._loadingDefaultSources===t&&(r._clearLoadingDefaultSources(),r._updateDefaultSources())})];case 1:return o.sent(),[2]}})})},u.prototype._getDefaultSymbol=function(e){var t=this.get("view.map.basemap.id"),r=v.get(e,"feature","geometry","type");if(v.isSome(r)){var o=I.getSchemes({theme:"default",basemap:t,geometryType:r})||I.getSchemes({theme:"default",basemap:"topo",geometryType:r}),n=o&&o.primaryScheme;if(n)return n.color&&N(n,"opacity")&&(n.color.a=n.opacity),this.createDefaultSymbol(n,r)}return this.defaultSymbol},u.prototype._removeHighlight=function(){this._handles.remove("highlight")},u.prototype._getLayerView=function(e){return s(this,void 0,void 0,function(){var t,r;return n(this,function(o){switch(o.label){case 0:return t=this.view,e&&t?(r=e.layer,[4,t.when()]):[2,S.resolve(null)];case 1:return o.sent(),[2,t.whenLayerView(r)]}})})},u.prototype._highlightFeature=function(e){var t=e.graphic,r=e.layerView,o=t.attributes,n=t.layer,s=n.objectIdField,i=o&&o[s],a=r.highlight(i||t);this._handles.add(a,"highlight")},u.ALL_INDEX=-1,o([_.property({readOnly:!0,dependsOn:["activeSourceIndex","allSources.length"],value:null})],u.prototype,"activeSource",null),o([_.property({dependsOn:["allSources.length","searchAllEnabled"]})],u.prototype,"activeSourceIndex",null),o([_.property()],u.prototype,"allPlaceholder",void 0),o([_.property({dependsOn:["defaultSources.length","sources.length","includeDefaultSources"],readOnly:!0})],u.prototype,"allSources",null),o([_.property()],u.prototype,"autoNavigate",void 0),o([_.property()],u.prototype,"autoSelect",void 0),o([_.property({readOnly:!0})],u.prototype,"defaultSources",void 0),o([_.property()],u.prototype,"defaultSymbol",void 0),o([_.property()],u.prototype,"includeDefaultSources",void 0),o([_.property()],u.prototype,"locationEnabled",null),o([_.property()],u.prototype,"maxInputLength",void 0),o([_.property()],u.prototype,"maxResults",void 0),o([_.property()],u.prototype,"maxSuggestions",void 0),o([_.property()],u.prototype,"minSuggestCharacters",void 0),o([_.property({readOnly:!0,dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","allSources"]})],u.prototype,"placeholder",null),o([_.property()],u.prototype,"popupEnabled",void 0),o([_.property({type:l})],u.prototype,"popupTemplate",void 0),o([_.property({type:x})],u.prototype,"portal",void 0),o([_.property()],u.prototype,"resultGraphicEnabled",void 0),o([_.property({readOnly:!0})],u.prototype,"resultGraphic",void 0),o([_.property({readOnly:!0})],u.prototype,"results",void 0),o([_.property({readOnly:!0})],u.prototype,"selectedSuggestion",void 0),o([_.property()],u.prototype,"searchAllEnabled",void 0),o([_.property({readOnly:!0})],u.prototype,"selectedResult",void 0),o([_.property()],u.prototype,"searchTerm",null),o([_.property({type:V})],u.prototype,"sources",void 0),o([_.property({readOnly:!0,dependsOn:["allSources.length"]})],u.prototype,"state",null),o([_.property()],u.prototype,"suggestionDelay",void 0),o([_.property({readOnly:!0})],u.prototype,"suggestions",void 0),o([_.property()],u.prototype,"suggestionsEnabled",void 0),o([_.property()],u.prototype,"view",void 0),o([_.property()],u.prototype,"clear",null),u=o([_.subclass("esri.widgets.Search.SearchViewModel")],u)}(_.declared(j.GoToMixin(h.EventedMixin(u))))});