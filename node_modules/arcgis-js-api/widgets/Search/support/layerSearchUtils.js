// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","dojo/date/locale","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/promiseUtils","../../../core/unitUtils","./geometryUtils"],function(e,r,t,i,n,a,u,l,o,s){function d(e,r){var t=e.exactMatch,i=void 0!==t&&t,a=e.location,u=e.maxResults,l=e.spatialReference,s=e.source,d=e.sourceIndex,f=e.suggestResult,y=e.view,w=s.layer,x=s.filter,R=s.zoomScale,S=y&&y.scale,I=c(s,y),E=r&&r.signal;return v(w).then(function(){var e=w.popupTemplate;return e?e.getRequiredFields(w.fields):null}).then(function(e){var r=w.objectIdField,t=w.returnZ,c=m(s);if(!F(w,c))throw L.error("invalid-field: displayField is invalid."),new n("getResults():invalid-field","displayField is invalid.");var v=e&&e.length?e:[c],P=s.outFields||v,O=g(P);if(-1!==P.indexOf(r)||O||P.push(r),!(O||h(w,P)))throw L.error("invalid-field: outField is invalid."),new n("getResults():invalid-field","outField is invalid.");var D=w.createQuery(),U=s.orderByFields,T=s.searchQueryParams;if(T&&D.set(T),U&&(D.orderByFields=U),l){D.outSpatialReference=l;var q=1/o.getMetersPerUnitForSR(l);q&&(D.maxAllowableOffset=q)}var k=!!w.get("capabilities.data.supportsZ");if(D.returnZ=k&&!1!==t,D.returnGeometry=!0,P&&(D.outFields=P),a)D.geometry=a;else if(f.key)D.objectIds=[parseInt(f.key,10)];else{var A=s.searchFields||[c],B=h(w,A);if(!B)throw L.error("invalid-field: search field is invalid."),new n("getResults():invalid-field","search field is invalid.");p(w)&&(D.num=u),I&&(D.geometry=I);var C=f.text.trim();if(!C)return[];var Q=s.prefix,G=void 0===Q?"":Q,M=s.suffix,V=void 0===M?"":M,Z=b(""+G+f.text+V),_=j(Z,w,A,x,i);if(!_)return[];D.where=_}return w.queryFeatures(D,{signal:E}).then(function(e){return N(e,y,s,d,c,S,R)})})}function f(e,r){var t=e.source,i=e.spatialReference,a=e.view,u=e.suggestTerm,l=e.maxSuggestions,o=e.sourceIndex,s=t.layer,d=t.filter,f=r&&r.signal,y=c(t,a);return v(s).then(function(){if(!p(s))return[];var e=m(t),r=t.searchFields||[e],a=[];t.suggestionTemplate?t.suggestionTemplate.replace(q,function(e,r){return a.push(r),e}):a.push(e);var c=g(a);-1!==a.indexOf(s.objectIdField)||c||a.push(s.objectIdField);var v=F(s,e),w=c||h(s,a),x=h(s,r);if(!v)throw L.error("invalid-field: displayField is invalid."),new n("getSuggestions():invalid-field","displayField is invalid.");if(!w)throw L.error("invalid-field: outField is invalid."),new n("getSuggestions():invalid-field","outField is invalid.");if(!x)throw L.error("invalid-field: search field is invalid."),new n("getSuggestions():invalid-field","search field is invalid.");var R=s.createQuery(),S=t.orderByFields,I=t.suggestQueryParams;if(I&&R.set(I),S&&(R.orderByFields=S),R.outSpatialReference=i,R.returnGeometry=!1,R.num=l,R.outFields=a,y&&(R.geometry=y),!u.trim())return[];var E=t.prefix,P=void 0===E?"":E,O=t.suffix,U=void 0===O?"":O,N=b(""+P+u+U),T=j(N,s,r,d,!1);return T?(R.where=T,s.queryFeatures(R,{signal:f}).then(function(r){return D(r,t,o,e)})):[]})}function c(e,r){var t=e.filter,i=e.searchExtent,n=e.withinViewEnabled,a=r&&r.extent,u=t&&t.geometry,l=n&&a?a:void 0;return u||i||l}function g(e){return e&&-1!==e.indexOf("*")}function v(e){return e?e.load().then(l.resolve).catch(l.reject):l.resolve()}function p(e){return e&&!!e.get("capabilities.query.supportsPagination")}function y(e){var r="";if(e){var t=e.fields;t&&t.some(function(e){return"string"===e.type&&(r=e.name,!0)})}return r}function m(e){return e.displayField||e.layer.displayField||y(e.layer)}function h(e,r){return!(!e||!r)&&r.every(function(r){return F(e,r)})}function F(e,r){return!!e.getField(r)}function w(e){for(var r=0;r<e.length;r++)if(e.charCodeAt(r)>255)return!0;return!1}function x(e,r,t){var i=null,n=e.codedValues;return n&&n.some(function(e){var n=e.name,a=t?n:n.toLowerCase();return(t?r:r.toLowerCase())===a&&(i=e.code.toString(),!0)}),i}function b(e){return e.replace(/\'/g,"''")}function R(e,r){var t=r&&r.where;return t?"("+e+") AND ("+t+")":e}function S(e,r,t,i,n){var a=r.type,u=r.name;if("string"===a||"date"===a||"global-id"===a){if(n)return R(u+" = "+t+"'"+e+"'",i);return R("UPPER("+u+") LIKE "+t+"'%"+e.toUpperCase()+"%'",i)}if("oid"===a||"small-integer"===a||"integer"===a||"single"===a||"double"===a){var l=Number(e);return isNaN(l)?null:R(u+" = "+l,i)}return R(u+" = "+e,i)}function I(e,r){return e?" OR ("+r+")":"("+r+")"}function j(e,r,t,i,n){var a=r.definitionExpression,u="";if(e){var l=T.test(r.url)&&w(e)?"N":"";t&&t.forEach(function(t){var a=r.getField(t),o="function"==typeof r.getFieldDomain&&r.getFieldDomain(t),s=o&&"coded-value"===o.type?x(o,e,n):null,d=s||e||null;if(null!==d){var f=S(d,a,l,i,n);f&&(u+=I(u,f))}})}return a?"("+a+") AND ("+u+")":u}function E(e,r){var t=null,i=e.codedValues;return i&&i.length&&i.some(function(e){return e.code===r&&(t=e.name,!0)}),t}function P(e,r,n){var a=e.layer,u=e.attributes,l="function"==typeof a.getFieldDomain&&a.getFieldDomain(n);if(r)return i.substitute(r,u);if(n&&e.hasOwnProperty("attributes")&&u.hasOwnProperty(n)){var o=u[n],s=a.getField(n);return l&&"coded-value"===l.type?E(l,o):s&&"date"===s.type?t.format(new Date(o)):"number"==typeof o?o.toString():"string"!=typeof o?"":o.trim()}return""}function O(e,r,t,i){var n=e.layer,a=e.attributes,u=n.objectIdField,l=a[u];return{text:P(e,r.suggestionTemplate,i),key:l,sourceIndex:t}}function D(e,r,t,i){return e.features.map(function(e){return O(e,r,t,i)})}function U(e,r,t,i,n,u,l){var o=e.clone(),d=e.layer,f=d&&d.objectIdField,c=f&&e.attributes[f],g=P(e,t.searchTemplate,n),v=s.createExtentFromGeometry(o.geometry,r,u);return{extent:l?s.scaleExtent(a.clone(v),r,l):v,feature:o,key:c,name:g,sourceIndex:i}}function N(e,r,t,i,n,a,u){return e.features.map(function(e){return U(e,r,t,i,n,a,u)})}Object.defineProperty(r,"__esModule",{value:!0});var T=/https?:\/\/services.*\.arcgis\.com/i,q=/(?:\{([^}]+)\})/g,L=u.getLogger("esri.widgets.Search.support.layerSearchUtils");r.getResults=d,r.getSuggestions=f});