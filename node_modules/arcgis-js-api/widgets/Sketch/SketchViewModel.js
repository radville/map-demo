// COPYRIGHT Â© 2019 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.14/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../geometry","../../Graphic","../../symbols","../../core/Collection","../../core/compilerUtils","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/maybe","../../core/screenUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/coordsUtils","../../layers/GraphicsLayer","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/3d/interactive/editingTools/isSupportedGraphicUtils","../../views/3d/interactive/editingTools/graphicMove3D/isSupportedGraphic","../../views/3d/interactive/editingTools/graphicReshape3D/isSupportedGraphic","../../views/3d/interactive/editingTools/graphicTransform3D/isSupportedGraphic","../../views/draw/Draw","../../views/draw/support/createUtils","../../views/draw/support/layerUtils","../../views/input/InputManager","./support/OperationHandle","@dojo/framework/shim/Promise"],function(e,t,r,o,i,n,a,s,p,c,l,h,d,u,v,y,m,f,g,_,G,w,E,b,S,C,x,T,A,H,U,I,O,P){function k(e,t){var r=e.history.undo.pop(),o=r.updates,i=[];t.forEach(function(e,t){var r=o[t],n={};null!=r&&(m.isSome(r.geometry)&&(n.geometry=e.geometry,e.geometry=r.geometry),m.isSome(r.symbol)&&(n.symbol=e.symbol,e.symbol=r.symbol),i.push(n))}),e.history.redo.push({updates:i})}function L(e,t){var r=e.history.redo.pop(),o=r.updates,i=[];t.forEach(function(e,t){var r=o[t],n={};null!=r&&(m.isSome(r.geometry)&&(n.geometry=e.geometry,e.geometry=r.geometry),m.isSome(r.symbol)&&(n.symbol=e.symbol,e.symbol=r.symbol),i.push(n))}),e.history.undo.push({updates:i})}function M(e){return{updates:e.map(function(e){return{geometry:e.geometry}})}}function R(e){return{updates:e.map(function(e){return{symbol:e.symbol}})}}function D(e){e.canUndo()?e.complete():e.cancel()}function V(e){return"requireError"in e&&"aborted"===e.requireError}var F=y.getLogger("esri.widgets.Sketch.SketchViewModel"),K={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift",cancelKey:"Escape",deleteKeys:["Backspace","Delete"]};return function(t){function u(e){var r=t.call(this,e)||this;return r._activeFillGraphic=null,r._activeLineGraphic=null,r._centerIndicatorGraphic=null,r._centerSymbol=new S({style:"cross",size:6,color:[255,255,255]}),r._defaultSegmentOffset=48,r._handles=new v,r._internalGraphicsLayer=new w({listMode:"hide"}),r._lineGraphic=null,r._operationHandle=null,r._vertexGraphics=[],r._viewHandles=new v,r._highlightHandlesByGraphic=new v,r._doUnnormalization=!1,r.activeFillSymbol=new E({style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),r.activeLineSymbol=new b({color:[12,207,255,1],width:2,style:"dash"}),r.activePointSymbol=new S({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.activeVertexSymbol=new S({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.createGraphic=null,r.defaultCreateOptions={mode:"hybrid"},r.defaultUpdateOptions={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform"},r.layer=null,r.pointSymbol=new S({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r.polygonSymbol=new E({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),r.polylineSymbol=new b({color:[130,130,130,1],width:2}),r.updateGraphics=new l,r.updateOnGraphicClick=!0,r.updatePointSymbol=new S({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),r.updatePolygonSymbol=new E({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),r.updatePolylineSymbol=new b({color:[12,207,255],width:2}),r.vertexSymbol=new S({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r}return o(u,t),u.prototype.initialize=function(){var e=this;this._handles.add([g.watch(this,"layer",function(){return e.cancel()}),g.on(this,"view.map.layers","change",function(t){t.removed.indexOf(e.layer)>=0&&e.cancel()}),g.on(this,"layer.graphics","change",function(t){if(m.isSome(e._operationHandle))for(var r=0,o=t.removed;r<o.length;r++){var i=o[r];e.updateGraphics.includes(i)&&(e.updateGraphics.length>1?e._operationHandle.removeFromSelection(i):D(e._operationHandle))}})].concat(this._generateSceneViewHighlightHandles()))},u.prototype.destroy=function(){this.cancel(),this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null,this._highlightHandlesByGraphic.removeAll(),this._highlightHandlesByGraphic=null,this._removeDefaultLayer(),this._draw&&this._draw.destroy(),this._set("view",null),this.emit("destroy")},Object.defineProperty(u.prototype,"_defaultUpdateTool",{get:function(){return"3d"===this.view.type?"move":"transform"},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"_draw",{get:function(){return"ready"===this.state||"active"===this.state?new H({view:this.view}):null},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"activeTool",{get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"activeComponent",{get:function(){return this._operationHandle?this._operationHandle.activeComponent:null},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"state",{get:function(){var e=!(!this.get("view.ready")||!this.layer),t=this._operationHandle;return e&&t?"active":e?"ready":"disabled"},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"view",{get:function(){return this._get("view")},set:function(e){var t=this,r=this._get("view");if(r){var o=r.container,i=r.map;o&&(r.cursor=null),i&&i.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}this._doUnnormalization=null!=e&&"3d"===e.type&&"global"===e.viewingMode;this._handles.remove("view-ready"),e&&this._handles.add(g.when(e,"ready",function(r){t._viewHandles.removeAll(),r&&t._viewHandles.add(t._generateViewHandles(e))},!0),"view-ready"),this._set("view",e)},enumerable:!0,configurable:!0}),u.prototype.cancel=function(){this._moduleLoaderAbortController&&(this._moduleLoaderAbortController.abort(),this._moduleLoaderAbortController=null),this._operationHandle&&this._operationHandle.cancel()},u.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete()},u.prototype.delete=function(){var e=this,t=e.state,r=e.updateGraphics;if("active"===t&&r.length){var o=this,i=o.activeTool,n=o.layer,a=r.toArray();n.removeMany(a),this.cancel(),this._emitDeleteEvent({graphics:a,tool:i})}},u.prototype.create=function(e,t){var r=this;if("disabled"===this.state)return this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),void(this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."));if(this.cancel(),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");var o=this._setupCreateOperation(e,t);if(!m.isNone(o)){I.addUniqueLayer(this.view,this._internalGraphicsLayer);var i=function(){if(o===r._operationHandle){var t=o.cancelled?"cancel":"complete",i=r.createGraphic;r._operationHandle.destroy(),r._operationHandle=null,r._set("createGraphic",null),r.view&&r.view.map&&r.view.map.remove(r._internalGraphicsLayer),o.cancelled||r.layer.add(i),r._emitCreateEvent({graphic:i,state:t,tool:e,toolEventInfo:null})}};o.on("complete",i),o.on("cancel",i),this._operationHandle=o}},u.prototype.update=function(e,t){return a(this,void 0,void 0,function(){var r,o,i,a,s,p,c,l=this;return n(this,function(n){switch(n.label){case 0:return r=this,(o=r.layer,i=r.state,a=r.view,"disabled"===i)?(o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),a||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),[2]):(this.cancel(),(s=Array.isArray(e)?e:[e])&&s.length?(p=s.some(function(e){return e.layer!==o?(l._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):m.isNone(e.geometry)?(l._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"===a.type&&!a.spatialReference.equals(e.geometry.spatialReference)&&(l._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0)}),p?[2]:[4,this._setupUpdateOperation(s,t)]):(this._logError("sketch:missing-parameter","Missing parameter 'graphics'."),[2]));case 1:return c=n.sent(),m.isNone(c)||V(c)?[2]:(I.addUniqueLayer(this.view,this._internalGraphicsLayer),this._emitUpdateEvent({graphics:s,state:"start",tool:c.tool,toolEventInfo:null}),this._setUpdateOperationHandle(c),[2])}})})},u.prototype.undo=function(){this.canUndo()&&this._operationHandle.undo()},u.prototype.redo=function(){this.canRedo()&&this._operationHandle.redo()},u.prototype.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())},u.prototype.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())},u.prototype.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()},u.prototype._getFirstHit=function(e){return a(this,void 0,void 0,function(){var t;return n(this,function(r){switch(r.label){case 0:return[4,this.view.hitTest(e)];case 1:return t=r.sent(),t.results.length>0?[2,{screenPoint:e,results:[t.results[0]]}]:[2,{screenPoint:e,results:[]}]}})})},u.prototype._generateViewHandles=function(e){var t=this;return[e.on("immediate-click",function(e){var o=t,i=o._operationHandle,n=o.defaultUpdateOptions,a=o.layer,s=o.state,p=o.updateGraphics,c=o.updateOnGraphicClick,l="active"===s&&"create"===i.type;"disabled"!==s&&!l&&c&&t._getFirstHit(f.createScreenPointFromEvent(e)).then(function(o){var i=o.results;if(i.length){i.some(function(e){if(e.graphic){var o=e.graphic;if(p.indexOf(o)>-1)return!0;if(o.layer===a)return t.update([o],r({},n)),!0}return!1})&&e.stopPropagation()}else"active"===s&&t.cancel()})},O.ViewEventPriorities.WIDGET)]},u.prototype._validateCreateOperation3D=function(e){var t=this.layer&&this.layer.elevationInfo&&this.layer.elevationInfo;return!t||!t.mode||(!("relative-to-ground"!==t.mode||!m.isNone(t.offset)&&0!==t.offset||"point"!==e)||"on-the-ground"===t.mode)},u.prototype._setupCreateOperation=function(e,t){if(!e)return null;var o=this,i=o.view,n=o.defaultCreateOptions,a=r({},n,t);if("3d"===i.type&&!this._validateCreateOperation3D(e))return this._logError("sketch:create-unsupported","Creating new graphics in SceneView is only supported for `on-the-ground` elevation modes."),null;var s;switch(e){case"point":s=this._setupCreatePointOperation(e,null);break;case"multipoint":s=this._setupCreateMultipointOperation(e,null);break;case"polygon":case"polyline":s=this._setupCreatePolyOperation(e,a);break;case"rectangle":s=this._setupCreateRectangleOperation(e,a);break;case"circle":s=this._setupCreateCircleOperation(e,a)}return s},u.prototype._setupCreatePointOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=[o.on("cursor-update",function(e){m.isSome(e.coordinates)?r._displayCrosshairCursor():r._displayDefaultCursor()}),o.on("draw-complete",function(e){var t=e.coordinates,o=t[0],i=t[1],n=new s.Point(o,i,r.view.spatialReference),c=new p(n,r.pointSymbol);r._set("createGraphic",c),a&&a.complete()})],n=[this.view.on("key-down",function(e){e.key===K.cancelKey&&a&&a.cancel()},O.ViewEventPriorities.WIDGET)],a=this._operationHandleForCreateAction(o,i.concat(n),e);return a},u.prototype._setupCreateMultipointOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=null,n=[],a=this._operationHandleForCreateAction(o,n,e);return n.push(o.on("vertex-add",function(t){var o=t.type,n=t.vertexIndex,a=t.vertices,s=a[n];i=t,r._drawMultipointGraphic(a,!0),r._emitCreateEvent({graphic:r.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:s,type:o}})}),o.on("vertex-remove",function(t){var o=t.type,n=t.vertexIndex,a=t.vertices,s=a[n];i=t,r._drawMultipointGraphic(a,!0),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{removed:s,type:o}})}),o.on("vertex-update",function(t){var o=t.type,n=t.vertexIndex,a=t.vertices,s=a[n];i=t,r._drawMultipointGraphic(a,!0),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:s}})}),o.on("cursor-update",function(e){i=e}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=U.createMultipoint(t,r.view.spatialReference);o?(r.createGraphic&&(r.createGraphic.geometry=o),a&&a.complete()):a&&a.cancel()}),o.on("undo",function(e){var t=e.vertices,o=i&&"cursor-update"!==i.type;r._resetCreateOperationGraphics(),t.length&&r._drawMultipointGraphic(t,o)}),o.on("redo",function(e){var t=e.vertices,o=i&&"cursor-update"!==i.type;r._resetCreateOperationGraphics(),t.length&&r._drawMultipointGraphic(t,o)})),n.push(this.view.on("pointer-move",function(){return r._displayCrosshairCursor()},O.ViewEventPriorities.WIDGET),this.view.on("key-down",function(e){return r._getCommonUpdateOperationKeyDownHandlers(a,e)},O.ViewEventPriorities.WIDGET)),a},u.prototype._setupCreatePolyOperation=function(e,t){var r=this,o=null;"polyline"===e?o=this._draw.create(e,t):"polygon"===e&&(o=this._draw.create(e,t));var i=new s.Point,n=null,a=!1,p=[o.on("vertex-add",function(t){var o=t.type,i=t.vertexIndex,s=t.vertices,p=s[i];r._snap(e,s,a),n=t,r._drawVertexGraphics(e,s,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:p,type:o}})}),o.on("vertex-remove",function(t){var o=t.type,i=t.vertexIndex,s=t.vertices,p=s[i];r._snap(e,s,a),n=t,r._drawVertexGraphics(e,s,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{removed:p,type:o}})}),o.on("vertex-update",function(t){var o=t.type,i=t.vertexIndex,s=t.vertices,p=s[i];r._snap(e,s,a),n=t,r._drawVertexGraphics(e,s,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:p}})}),o.on("cursor-update",function(t){var o=t.type,s=t.vertices;if(t.mapPoint&&(r._snap(e,s,a),n=t,i=t.mapPoint,r._drawVertexGraphics(e,s,{userClicked:!1}),s.length>1)){var p=s[s.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:p,type:o}})}}),o.on("draw-complete",function(t){var o=t.vertices.slice(0),i=null;"polyline"===e?i=U.createPolyline([o],r.view.spatialReference,r._doUnnormalization):"polygon"===e&&(i=U.createPolygon([o],r.view.spatialReference,r._doUnnormalization,!0)),i?(r.createGraphic.geometry=i,u&&u.complete()):u&&u.cancel()}),o.on("undo",function(t){var o=t.vertices,i=n&&"cursor-update"!==n.type;r._resetCreateOperationGraphics(),r._snap(e,o,a),o.length&&r._drawVertexGraphics(e,o,{userClicked:i})}),o.on("redo",function(t){var o=t.vertices,i=n&&"cursor-update"!==n.type;r._resetCreateOperationGraphics(),r._snap(e,o,a),o.length&&r._drawVertexGraphics(e,o,{userClicked:i})})],c=[this.view.on("pointer-move",function(e){r.view.toMap(f.createScreenPoint(e.x,e.y))?r._displayCrosshairCursor():r._displayDefaultCursor()},O.ViewEventPriorities.WIDGET),this.view.on("key-down",function(t){var i=o.vertices.slice(0),s=n&&"cursor-update"!==n.type;t.key!==K.constraintKey||a||"2d"!==r.view.type?t.key===K.undoKey&&u&&u.canUndo()?(t.stopPropagation(),u.undo()):t.key===K.redoKey&&u&&u.canRedo()?(t.stopPropagation(),u.redo()):t.key===K.cancelKey&&u&&u.cancel():(a=!0,r._snap(e,i,!s),r._drawVertexGraphics(e,i,{userClicked:s}))},O.ViewEventPriorities.WIDGET),this.view.on("key-up",function(t){var s=o.vertices.slice(0),p=n&&"cursor-update"!==n.type;t.key===K.constraintKey&&a&&(p||(s.pop(),s.push([i.x,i.y]),r._drawVertexGraphics(e,s,{userClicked:p})),a=!1)},O.ViewEventPriorities.WIDGET)];if("polygon"===e){var l=function(e,t,o){if(!e||!e.layer||!e.visible)return!1;var i=r.view.toScreen(e.geometry);return r._isWithinScreenDistance(i,t,o)},h=function(e){if(!(r._vertexGraphics.length<=2))return l(r._vertexGraphics[0],e,r._getVertexIntersectDistance())},d=!1;c.push(this.view.on("pointer-move",function(e){d=!1;var t=h(e);r._highlightHandlesByGraphic.forEach(function(e){return t?e.pause():e.resume()})},O.ViewEventPriorities.WIDGET),this.view.on("pointer-down",function(e){if(h(e))return d=!0,void e.stopPropagation();r._vertexGraphics.some(function(t){return l(t,e,r._getVertexIntersectDistance())})&&e.stopPropagation()},O.ViewEventPriorities.WIDGET),this.view.on("pointer-up",function(e){d&&(e.stopPropagation(),o.complete())}))}var u=this._operationHandleForCreateAction(o,p.concat(c),e);return u},u.prototype._setupCreateCircleOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=!1,n=!0,a=[o.on("vertex-add",function(t){var o=t.type,a=t.vertexIndex,s=t.vertices,p=s[a];r._drawSegmentGraphic(e,s,{centered:n,constrained:i}),r._emitCreateEvent({graphic:r.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:p,type:o}})}),o.on("cursor-update",function(t){var o=t.type,a=t.vertices;if(r._drawSegmentGraphic(e,a,{centered:n,constrained:i}),2===a.length){var s=a[a.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:s,type:o}})}}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=null,a=U.createViewAlignedCoordinateSystem(r.view,t[0]);1===t.length?(t.push([t[0][0]+r._defaultSegmentOffset*r.view.resolution,t[0][1]]),o=U.createCircle(t,a,!0)):o=i?U.createEllipse(t,a,n):U.createCircle(t,a,n),r.createGraphic?r.createGraphic.geometry=o:(r._removeCreateGraphic(),r._set("createGraphic",new p(o,r.polygonSymbol))),c&&c.complete()})],s=[this.view.on("pointer-move",function(e){r.view.toMap(f.createScreenPoint(e.x,e.y))?r._displayCrosshairCursor():r._displayDefaultCursor()},O.ViewEventPriorities.WIDGET),this.view.on("key-down",function(t){t.key!==K.constraintKey||i?t.key===K.centerKey&&n?(n=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):t.key===K.cancelKey&&c&&c.cancel():(i=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))},O.ViewEventPriorities.WIDGET),this.view.on("key-up",function(t){t.key===K.constraintKey?(i=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):t.key===K.centerKey&&(n=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))},O.ViewEventPriorities.WIDGET)],c=this._operationHandleForCreateAction(o,a.concat(s),e);return c},u.prototype._setupCreateRectangleOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=!1,n=!1,a=[o.on("vertex-add",function(t){var o=t.type,a=t.vertexIndex,s=t.vertices,p=s[a];r._drawSegmentGraphic(e,s,{centered:n,constrained:i}),r._emitCreateEvent({graphic:r.createGraphic,state:1===s.length?"start":"active",tool:e,toolEventInfo:{added:p,type:o}})}),o.on("cursor-update",function(t){var o=t.type,a=t.vertices;if(r._drawSegmentGraphic(e,a,{centered:n,constrained:i}),2===a.length){var s=a[a.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:s,type:o}})}}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=null,a=U.createViewAlignedCoordinateSystem(r.view,t[0]);1===t.length&&(i=!1,n=!1),o=i?U.createSquare(t,a,n):U.createRectangle(t,a,n),r.createGraphic?r.createGraphic.geometry=o:(r._removeCreateGraphic(),r._set("createGraphic",new p(o,r.polygonSymbol))),c&&c.complete()})],s=[this.view.on("pointer-move",function(e){r.view.toMap(f.createScreenPoint(e.x,e.y))?r._displayCrosshairCursor():r._displayDefaultCursor()},O.ViewEventPriorities.WIDGET),this.view.on("key-down",function(t){t.key!==K.constraintKey||i?t.key!==K.centerKey||n?t.key===K.cancelKey&&c&&c.cancel():(n=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):(i=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))},O.ViewEventPriorities.WIDGET),this.view.on("key-up",function(t){t.key===K.constraintKey?(i=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):t.key===K.centerKey&&(n=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))},O.ViewEventPriorities.WIDGET)],c=this._operationHandleForCreateAction(o,a.concat(s),e);return c},u.prototype._setupUpdateOperation=function(e,t){return a(this,void 0,void 0,function(){var o,i,a,s,p,c,l,h,d,u,v,u,y;return n(this,function(n){for(o=this,i=o._defaultUpdateTool,a=o.defaultUpdateOptions,s=o.layer,p=o.view,c=r({},a,t),l=c.tool||i,h=0,d=e;h<d.length;h++)u=d[h],s.remove(u),s.add(u);if("3d"===p.type){if(0===e.length)return[2,null];switch(l){case"move":return[2,this._setupMove3DOperation(e,c,p,l)];case"reshape":return e.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):0===(v=T.isSupportedGraphic(e[0]))?[2,this._setupReshape3DOperation(e[0],c,p)]:(this._logError("sketch:reshape","Reshape operation not supported for provided graphic(s) ("+C.isSupportedGraphicResultMessage(v)+")."),[2,null]);case"transform":return 1===e.length&&0===A.isSupportedGraphic(e[0])?[2,this._setupPointTransform3DOperation(e[0],c,p)]:[2,this._setupMove3DOperation(e,c,p,l)]}return[2,null]}if("move"===l)return[2,this._setupMoveOperation(e,c,p)];if(e.length>1)return"reshape"===l?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):[2,this._setupTransformOrReshapeOperation(e,l,c,p)];if(1===e.length){if(u=e[0],"point"===(y=m.get(u.geometry,"type"))||"multipoint"===y)return[2,this._setupMoveOperation(e,c,p)];if("transform"===l||"reshape"===l)return[2,this._setupTransformOrReshapeOperation(e,l,c,p)]}return[2,null]})})},u.prototype._setupMove3DOperation=function(t,r,o,i,s){return void 0===s&&(s=!1),a(this,void 0,void 0,function(){var p,c,l,h,d,u,v,y,m=this;return n(this,function(f){switch(f.label){case 0:for(p=0,c=t;p<c.length;p++)if(l=c[p],0!==(h=x.isSupportedGraphic(l)))return this._logError("sketch:move","Move operation not supported for provided graphic(s) ("+C.isSupportedGraphicResultMessage(h)+")."),[2,null];return[4,this._requireModule(new Promise(function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)}))];case 1:return d=f.sent(),V(d)?[2,d]:(u=new d.module.GraphicMove3DTool({view:o}),this.view.tools.add(u),u.graphics.addMany(t),s||this.updateGraphics.addMany(t),v=[],y=new P.OperationHandle({activeComponent:u,tool:i,type:"update",onEnd:function(){v.forEach(function(e){return e.remove()}),v.length=0,m.view.tools.remove(u),u.destroy()},undo:function(){k(y,m.updateGraphics.toArray()),m._emitUndoEvent({graphics:m.updateGraphics.toArray(),tool:i})},redo:function(){L(y,m.updateGraphics.toArray()),m._emitRedoEvent({graphics:m.updateGraphics.toArray(),tool:i})},addToSelection:function(e){m.updateGraphics.push(e),u.graphics.push(e),m._emitUpdateEvent({graphics:m.updateGraphics.toArray(),state:"active",tool:m.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},removeFromSelection:function(e){var t=m.updateGraphics.indexOf(e);if(y.history.undo.forEach(function(e){return e.updates.splice(t,1)}),y.history.redo.forEach(function(e){return e.updates.splice(t,1)}),m.updateGraphics.remove(e),0===m.updateGraphics.length)return void D(y);u.graphics.remove(e)},toggleTool:function(){return a(m,void 0,void 0,function(){var e,t;return n(this,function(n){switch(n.label){case 0:return 1!==this.updateGraphics.length||!1===r.toggleToolOnClick?[2]:"transform"!==i?[2]:(e=this.updateGraphics.getItemAt(0),0!==T.isSupportedGraphic(e)?[2]:[4,this._setupReshape3DOperation(e,r,o,!0)]);case 1:return t=n.sent(),V(t)?[2]:(y.onEnd(),y.destroy(),this._setUpdateOperationHandle(t),[2])}})})}}),v.push.apply(v,this._getHandlesForComponent(y,r).concat([this.view.on("immediate-click",function(e){return m._getCommonUpdateOperationClickHandlers(y,e)},O.ViewEventPriorities.WIDGET),this.view.on("key-down",function(e){return m._getCommonUpdateOperationKeyDownHandlers(y,e)},O.ViewEventPriorities.WIDGET)])),[2,y])}})})},u.prototype._setupPointTransform3DOperation=function(t,r,o){return a(this,void 0,void 0,function(){var i,s,p,c,l,h,d,u=this;return n(this,function(v){switch(v.label){case 0:return i="transform",s=r.enableRotation,p=r.enableScaling,[4,this._requireModule(new Promise(function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)}))];case 1:return c=v.sent(),V(c)?[2,c]:(l=new c.module.GraphicTransform3DTool({graphic:t,view:o,enableRotation:s,enableScaling:p}),this.view.tools.add(l),this.updateGraphics.add(t),h=[],d=new P.OperationHandle({activeComponent:l,tool:i,type:"update",onEnd:function(){h.forEach(function(e){return e.remove()}),h.length=0,u.view.tools.remove(l),l.destroy()},undo:function(){k(d,u.updateGraphics.toArray()),u._emitUndoEvent({graphics:u.updateGraphics.toArray(),tool:i})},redo:function(){L(d,u.updateGraphics.toArray()),u._emitRedoEvent({graphics:u.updateGraphics.toArray(),tool:i})},addToSelection:function(e){return a(u,void 0,void 0,function(){var t;return n(this,function(i){switch(i.label){case 0:return this.updateGraphics.add(e),[4,this._setupMove3DOperation(this.updateGraphics.toArray(),r,o,"transform",!0)];case 1:return t=i.sent(),V(t)?[2]:(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(t),[2])}})})}}),h.push.apply(h,this._getHandlesForComponent(d,r).concat([this.view.on("immediate-click",function(e){return u._getCommonUpdateOperationClickHandlers(d,e)},O.ViewEventPriorities.WIDGET),this.view.on("key-down",function(e){return u._getCommonUpdateOperationKeyDownHandlers(d,e)},O.ViewEventPriorities.WIDGET)])),[2,d])}})})},u.prototype._setupMoveOperation=function(e,t,r){return a(this,void 0,void 0,function(){var o,i,a,s,c,l,h=this;return n(this,function(n){switch(n.label){case 0:return o=[],i="move",e.forEach(function(e){o.push(new p(e.geometry,e.symbol,e.attributes)),e.symbol=h._getUpdateSymbol(e.geometry)}),this.updateGraphics.addMany(e),[4,this._getGraphicMover(e,t,r)];case 1:return a=n.sent(),V(a)?[2,a]:(s=new P.OperationHandle({activeComponent:a,tool:i,type:"update",onEnd:function(){l.forEach(function(e){return e.remove()}),c.forEach(function(e){return e.remove()}),l=[],c=[],a.destroy(),h._internalGraphicsLayer&&h._internalGraphicsLayer.removeMany(h.updateGraphics.toArray()),h.updateGraphics.forEach(function(e,t){e.symbol=o[t].symbol})},undo:function(){k(s,h.updateGraphics.toArray()),h._emitUndoEvent({graphics:h.updateGraphics.toArray(),tool:i})},redo:function(){L(s,h.updateGraphics.toArray()),h._emitRedoEvent({graphics:h.updateGraphics.toArray(),tool:i})},addToSelection:function(e){o.push(new p(e.geometry,e.symbol,e.attributes)),e.symbol=h._getUpdateSymbol(e.geometry),h.updateGraphics.push(e),a.graphics=h.updateGraphics.toArray(),h._emitUpdateEvent({graphics:h.updateGraphics.toArray(),state:"active",tool:h.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},removeFromSelection:function(e){var t=h.updateGraphics.indexOf(e);s.history.undo.forEach(function(e){return e.updates.splice(t,1)}),s.history.redo.forEach(function(e){return e.updates.splice(t,1)});var r=o.splice(t,1)[0];if(e.symbol=r.symbol,h.updateGraphics.remove(e),0===h.updateGraphics.length)return void D(s);a.graphics=h.updateGraphics.toArray()}}),c=[r.on("immediate-click",function(e){return h._getCommonUpdateOperationClickHandlers(s,e,t)},O.ViewEventPriorities.WIDGET),r.on("key-down",function(e){h._getCommonUpdateOperationKeyDownHandlers(s,e),e.key!==K.constraintKey||e.repeat||(a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},O.ViewEventPriorities.WIDGET),r.on("key-up",function(e){e.key===K.constraintKey&&(a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},O.ViewEventPriorities.WIDGET)],l=this._getHandlesForComponent(s,t),[2,s])}})})},u.prototype._setupReshape3DOperation=function(t,r,o,i){return void 0===i&&(i=!1),a(this,void 0,void 0,function(){var s,p,c,l,h,d=this;return n(this,function(u){switch(u.label){case 0:return s="reshape",[4,this._requireModule(new Promise(function(t,r){e(["../../views/3d/interactive/editingTools"],t,r)}))];case 1:return p=u.sent(),V(p)?[2,p]:(c=new p.module.GraphicReshape3DTool({view:o,graphic:t}),o.tools.add(c),i||this.updateGraphics.add(t),l=[],h=new P.OperationHandle({activeComponent:c,tool:s,type:"update",onEnd:function(){l.forEach(function(e){return e.remove()}),l.length=0,o.tools.remove(c),c.destroy()},undo:function(){k(h,d.updateGraphics.toArray()),d._emitUndoEvent({graphics:d.updateGraphics.toArray(),tool:s})},redo:function(){L(h,d.updateGraphics.toArray()),d._emitRedoEvent({graphics:d.updateGraphics.toArray(),tool:s})},addToSelection:function(e){return a(d,void 0,void 0,function(){var t;return n(this,function(i){switch(i.label){case 0:return this.updateGraphics.add(e),[4,this._setupMove3DOperation(this.updateGraphics.toArray(),r,o,"transform",!0)];case 1:return t=i.sent(),V(t)?[2]:(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(t),[2])}})})},toggleTool:function(){return a(d,void 0,void 0,function(){var e;return n(this,function(t){switch(t.label){case 0:return!1===r.toggleToolOnClick?[2]:[4,this._setupMove3DOperation(this.updateGraphics.toArray(),r,o,"transform",!0)];case 1:return e=t.sent(),V(e)?[2]:(h.onEnd(),h.destroy(),this._setUpdateOperationHandle(e),[2])}})})}}),l.push.apply(l,this._getHandlesForComponent(h,r).concat([o.on("immediate-click",function(e){return d._getCommonUpdateOperationClickHandlers(h,e)},O.ViewEventPriorities.WIDGET),o.on("key-down",function(e){return d._getCommonUpdateOperationKeyDownHandlers(h,e)},O.ViewEventPriorities.WIDGET)])),[2,h])}})})},u.prototype._setupTransformOrReshapeOperation=function(e,t,r,o){return a(this,void 0,void 0,function(){var i,s,c,l,h,d,u,v,y,g,_=this;return n(this,function(G){switch(G.label){case 0:return i=r.multipleSelectionEnabled,s=void 0===i||i,c=r.toggleToolOnClick,l=void 0===c||c,h=[],e.forEach(function(e){h.push(new p(e.geometry,e.symbol,e.attributes)),e.symbol=_._getUpdateSymbol(e.geometry)}),this.updateGraphics.addMany(e),"transform"!==t?[3,2]:[4,this._getBox(e,r,o)];case 1:return u=G.sent(),[3,4];case 2:return[4,this._getReshape(e,r,o)];case 3:u=G.sent(),G.label=4;case 4:return d=u,V(d)?[2,d]:(v=new P.OperationHandle({activeComponent:d,type:"update",onEnd:function(){g.forEach(function(e){return e.remove()}),y.forEach(function(e){return e.remove()}),g=[],y=[],v.activeComponent&&!v.activeComponent.destroyed&&v.activeComponent.destroy(),_._internalGraphicsLayer.removeMany(_.updateGraphics.toArray()),_.updateGraphics.forEach(function(e,t){h[t]&&h[t].symbol&&(e.symbol=h[t].symbol)})},undo:function(){k(v,_.updateGraphics.toArray()),v.refreshComponent(),_._emitUndoEvent({graphics:_.updateGraphics.toArray(),tool:v.tool})},redo:function(){L(v,_.updateGraphics.toArray()),v.refreshComponent(),_._emitRedoEvent({graphics:_.updateGraphics.toArray(),tool:v.tool})},addToSelection:function(e){var t=v.activeComponent;h.push(new p(e.geometry,e.symbol,e.attributes)),e.symbol=_._getUpdateSymbol(e.geometry),_.updateGraphics.add(e),t.graphics=_.updateGraphics.toArray(),t.refresh(),v.resetHistory(),_._emitUpdateEvent({graphics:_.updateGraphics.toArray(),state:"active",tool:_.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},removeFromSelection:function(e){var t=v.activeComponent,r=_.updateGraphics.indexOf(e);v.history.undo.forEach(function(e){return e.updates.splice(r,1)}),v.history.redo.forEach(function(e){return e.updates.splice(r,1)});var o=h.splice(r,1)[0];if(e.symbol=o.symbol,_.updateGraphics.remove(e),0===_.updateGraphics.length)return void D(v);t.graphics=_.updateGraphics.toArray()},toggleTool:function(){return a(_,void 0,void 0,function(){var t;return n(this,function(i){switch(i.label){
case 0:return this.updateGraphics.length>1?[2]:(t=null,"transform"!==v.tool?[3,2]:[4,this._getReshape(e,r,o)]);case 1:return t=i.sent(),[3,4];case 2:return"reshape"!==v.tool?[3,4]:[4,this._getBox(e,r,o)];case 3:t=i.sent(),i.label=4;case 4:return V(t)?[2]:(v.activeComponent.destroy(),v.activeComponent=t,v.activeComponent&&(g.forEach(function(e){return e.remove()}),g=this._getHandlesForComponent(v,r)),[2])}})})}}),y=[o.on("immediate-click",function(e){_._getFirstHit(f.createScreenPointFromEvent(e)).then(function(t){if(v){var r=t.results;if(!r.length)return void D(v);var o=v.activeComponent,i=e.native&&e.native.shiftKey;r.some(function(e){if(e.graphic){var t=e.graphic;if(s&&i&&o&&"box"===o.type&&!o.isUIGraphic(t))return v.addToSelection(t),!0;if(o&&"box"===o.type&&o.isUIGraphic(t)){if(!1!==l&&1===_.updateGraphics.length){var r=_.updateGraphics.getItemAt(0).geometry;"extent"===m.get(r,"type")?_._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."):v.toggleTool()}return!0}if(o&&"reshape"===o.type){if(t===o.graphic)return!1!==l&&v.toggleTool(),!0;if(o.isUIGraphic(t))return!0;if(t.layer===_._internalGraphicsLayer)return!0}else t.layer===_.layer&&D(v)}return!1})&&e.stopPropagation()}})},O.ViewEventPriorities.WIDGET),o.on("key-down",function(e){if(_._getCommonUpdateOperationKeyDownHandlers(v,e),e.key===K.constraintKey&&!e.repeat&&v){var t=v.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}},O.ViewEventPriorities.WIDGET),o.on("key-up",function(e){if(e.key===K.constraintKey&&v){var t=v.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}},O.ViewEventPriorities.WIDGET)],g=this._getHandlesForComponent(v,r),[2,v])}})})},u.prototype._getGraphicMover=function(t,r,o){return a(this,void 0,void 0,function(){var i,a,s,p=this;return n(this,function(n){switch(n.label){case 0:return i=r.enableMoveAllGraphics,a=void 0===i||i,[4,this._requireModule(new Promise(function(t,r){e(["../../views/draw/support/GraphicMover"],t,r)}))];case 1:return s=n.sent(),V(s)?[2,s]:[2,new s.module({enableMoveAllGraphics:a,graphics:t,view:o,callbacks:{onGraphicMoveStart:function(e){var t=e.dx,r=e.dy,o=e.graphic;return p._emitUpdateEvent({graphics:p.updateGraphics.toArray(),state:"active",tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-start"}})},onGraphicMove:function(e){var t=e.dx,r=e.dy,o=e.graphic;return p._emitUpdateEvent({graphics:p.updateGraphics.toArray(),state:"active",tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move"}})},onGraphicMoveStop:function(e){var t=e.dx,r=e.dy,o=e.graphic;return p._emitUpdateEvent({graphics:p.updateGraphics.toArray(),state:"active",tool:p.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:"move-stop"}})},onGraphicPointerOver:function(){return p._displayDefaultCursor()},onGraphicPointerOut:function(){return p._displayDefaultCursor()}}})]}})})},u.prototype._getBox=function(t,o,i){return a(this,void 0,void 0,function(){var a,s,p,c,l,h,d,u=this;return n(this,function(n){switch(n.label){case 0:return a=o.enableRotation,s=void 0===a||a,p=o.enableScaling,c=void 0===p||p,l=o.preserveAspectRatio,h=void 0!==l&&l,[4,this._requireModule(new Promise(function(t,r){e(["../../views/draw/support/Box"],t,r)}))];case 1:return d=n.sent(),V(d)?[2,d]:[2,new d.module({graphics:t,enableRotation:s,enableScaling:c,preserveAspectRatio:h,layer:this._internalGraphicsLayer,view:i,callbacks:{onMoveStart:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onMove:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onMoveStop:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onScaleStart:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onScale:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onScaleStop:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onRotateStart:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onRotate:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})},onRotateStop:function(e){return u._emitUpdateEvent({graphics:u.updateGraphics.toArray(),state:"active",tool:u.activeTool,toolEventInfo:r({},e)})}}})]}})})},u.prototype._getReshape=function(t,o,i){return a(this,void 0,void 0,function(){var a,s,p,c=this;return n(this,function(n){switch(n.label){case 0:return a=o.enableMidpoints,s=void 0===a||a,[4,this._requireModule(new Promise(function(t,r){e(["../../views/draw/support/Reshape"],t,r)}))];case 1:return p=n.sent(),V(p)?[2,p]:[2,new p.module({enableMidpoints:s,graphic:t[0],layer:this._internalGraphicsLayer,view:i,callbacks:{onReshapeStart:function(e){return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:r({},e)})},onReshape:function(e){return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:r({},e)})},onReshapeStop:function(e){var t=e.mover,r=e.type;return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{mover:t,type:r}})},onMoveStart:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i}})},onMove:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i}})},onMoveStop:function(e){var t=e.dx,r=e.dy,o=e.mover,i=e.type;return c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{dx:t,dy:r,mover:o,type:i}})},onVertexAdd:function(e){var t=e.added,r=e.type,o=t.map(function(e){return G.geometryToCoordinates(e.geometry)});c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{added:o,type:r}})},onVertexRemove:function(e){var t=e.removed,r=e.type,o=t.map(function(e){return G.geometryToCoordinates(e.geometry)});c._emitUpdateEvent({graphics:c.updateGraphics.toArray(),state:"active",tool:c.activeTool,toolEventInfo:{removed:o,type:r}})}}})]}})})},u.prototype._getHandlesForComponent=function(e,t){var r=this,o=e.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-move-start",function(t){return e.addToHistory(M(t.allGraphics))})];case"box":return[o.on("move-start",function(t){return e.addToHistory(M(t.graphics))}),o.on("rotate-start",function(t){return e.addToHistory(M(t.graphics))}),o.on("scale-start",function(t){return e.addToHistory(M(t.graphics))})];case"reshape":return[o.on("move-start",function(t){return e.addToHistory(M([t.mover]))}),o.on("reshape-start",function(t){return e.addToHistory(M([t.graphic]))}),o.on("vertex-add",function(t){return e.addToHistory(M([t.oldGraphic]))}),o.on("vertex-remove",function(t){return e.addToHistory(M([t.oldGraphic]))})];case"move-3d":return[o.on("graphic-move-start",function(t){e.addToHistory(M(t.allGraphics)),r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-start"}})}),o.on("graphic-move",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{dx:e.dx,dy:e.dy,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move"}})}),o.on("graphic-move-stop",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-stop"}})}),o.on("immediate-click",function(o){o.shiftKey?r._toggleSelection([o.graphic],e,t):e.toggleTool()})];case"transform-3d":return[o.on("graphic-translate-start",function(t){e.addToHistory(M([t.graphic])),r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:t.graphic,dx:0,dy:0,type:"move-start"}})}),o.on("graphic-translate-stop",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:e.graphic,dx:0,dy:0,type:"move-stop"}})}),o.on("graphic-rotate-start",function(t){e.addToHistory(R([t.graphic])),r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:t.graphic,angle:0,type:"rotate-start"}})}),o.on("graphic-rotate-stop",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:e.graphic,angle:0,type:"rotate-stop"}})}),o.on("graphic-scale-start",function(t){e.addToHistory(R([t.graphic])),r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:t.graphic,xScale:1,yScale:1,type:"scale-start"}})}),o.on("graphic-scale-stop",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:e.graphic,xScale:1,yScale:1,type:"scale-stop"}})}),o.on("graphic-translate",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:e.graphic,dx:e.dx,dy:e.dy,type:"move"}})}),o.on("graphic-rotate",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:e.graphic,angle:e.angle,type:"rotate"}})}),o.on("graphic-scale",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{mover:e.graphic,xScale:e.scale,yScale:e.scale,type:"scale"}})})];case"reshape-3d":return[o.on("reshape",function(t){"reshape-start"===t.type&&e.addToHistory(M([t.mover])),r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:t})}),o.on("move",function(t){"move-start"===t.type&&e.addToHistory(M([t.mover])),r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:t})}),o.on("vertex-add",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:e})}),o.on("vertex-remove",function(e){r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:e})}),o.on("immediate-click",function(){return e.toggleTool()})];case"draw":return null;default:return void h.neverReached(o)}},u.prototype._setUpdateOperationHandle=function(e){var t=this;this._operationHandle=e;var r=this.view,o=r.map,i=r.popup,n=!0;i&&(n=i.autoOpenEnabled,i.autoOpenEnabled=!1);var a=function(){if(e===t._operationHandle){var r=e.cancelled?"cancel":"complete",a=t.updateGraphics.toArray(),s=t._operationHandle.tool;t._operationHandle.destroy(),t._operationHandle=null,t._internalGraphicsLayer.removeMany(t.updateGraphics.toArray()),t.updateGraphics.removeAll(),o&&o.remove(t._internalGraphicsLayer),i&&(i.autoOpenEnabled=n),t._emitUpdateEvent({graphics:a,state:r,tool:s,toolEventInfo:null})}};e.on("complete",a),e.on("cancel",a)},u.prototype._getCommonUpdateOperationClickHandlers=function(e,t,r){var o=this,i=f.createScreenPointFromEvent(t);this._getFirstHit(i).then(function(i){var n=i.results;return n.length?t.native.shiftKey&&o._toggleSelection(n.map(function(e){return e.graphic}),e,r)?void t.stopPropagation():void(n.some(function(e){return e.graphic&&o.updateGraphics.indexOf(e.graphic)>-1})?t.stopPropagation():D(e)):void D(e)})},u.prototype._toggleSelection=function(e,t,r){var o=this,i=!r||!!r.multipleSelectionEnabled;return e.some(function(e){return null!=e&&(!(!i||e.layer!==o.layer)&&(-1===o.updateGraphics.indexOf(e)?t.addToSelection(e):t.removeFromSelection(e),!0))})},u.prototype._getCommonUpdateOperationKeyDownHandlers=function(e,t){if(e){var r=t.key;r===K.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):r===K.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):r===K.cancelKey?D(e):K.deleteKeys.indexOf(r)>=0&&this._onDeleteKey()}},u.prototype._onDeleteKey=function(){if(this._operationHandle&&"update"===this._operationHandle.type){var e=this.activeComponent;if(e&&"reshape"!==e.type&&"reshape-3d"!==e.type){var t=this.updateGraphics.toArray();this.layer.removeMany(t),this._emitDeleteEvent({graphics:t,tool:this.activeTool})}}},u.prototype._getCreateSymbol=function(e,t){void 0===t&&(t=!1);var r="3d"!==this.view.type&&t;switch(e.type){case"point":case"multipoint":return r?this.activePointSymbol:this.pointSymbol;case"polyline":return r?this.activeLineSymbol:this.polylineSymbol;case"polygon":return r?this.activeFillSymbol:this.polygonSymbol}return null},u.prototype._getUpdateSymbol=function(e){if(m.isNone(e))return null;switch(e.type){case"point":case"multipoint":return this.updatePointSymbol;case"polyline":return this.updatePolylineSymbol;case"polygon":case"extent":return this.updatePolygonSymbol}return null},u.prototype._drawMultipointGraphic=function(e,t){var r=null;if(!t&&e.length>1){var o=e.slice(0);o.pop(),r=U.createMultipoint(o,this.view.spatialReference)}else r=U.createMultipoint(e,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new p(r,this.pointSymbol)),t&&1===e.length&&this._internalGraphicsLayer.add(this.createGraphic)},u.prototype._drawVertexGraphics=function(e,t,r){var o=!(!r||!r.userClicked),i="polygon"===e,n=i?this.polygonSymbol:this.polylineSymbol;if(1===t.length){this._removeLineGraphic(),this._removeActiveLineGraphic();var a=t[0],c=a[0],l=a[1],h=new s.Point(c,l,this.view.spatialReference),d=i?U.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):U.createPolyline([t],this.view.spatialReference,this._doUnnormalization);this._vertexGraphics.length?this._vertexGraphics[0].geometry=h:this._vertexGraphics.push(new p(h,this.activeVertexSymbol)),this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new p(d,n)),o&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===t.length){var u=t[1],c=u[0],l=u[1],v=new s.Point(c,l,this.view.spatialReference),y=this.vertexSymbol,m=U.createPolyline([t],this.view.spatialReference,this._doUnnormalization),d=i?U.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):U.createPolyline([t],this.view.spatialReference,this._doUnnormalization);if(!this._vertexGraphics.length){var f=t[0],g=f[0],_=f[1],h=new s.Point(g,_,this.view.spatialReference),G=new p(h,y);this._vertexGraphics.push(G)}if(1===this._vertexGraphics.length){var w=this._vertexGraphics[0],E=new p(v,y);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(E),this._internalGraphicsLayer.remove(w),this._internalGraphicsLayer.add(w)}else this._vertexGraphics[1].geometry=v;this._showActiveLineGraphic(m);var b=this._vertexGraphics[0];o&&(this._activeLineGraphic.symbol=this.polylineSymbol,b.symbol=this.vertexSymbol,this._internalGraphicsLayer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new p(d,this.polygonSymbol)),this._internalGraphicsLayer.remove(b),this._internalGraphicsLayer.add(b)}else if(t.length>2){var d=i?U.createPolygon([t],this.view.spatialReference,this._doUnnormalization,!0):U.createPolyline([t],this.view.spatialReference,this._doUnnormalization);"polygon"===e&&this._showFillGraphic(d);var S=t.map(function(e){return[e[0],e[1]]}),C=S.pop(),x=[S[S.length-1],C],T=U.createPolyline([S],this.view.spatialReference,this._doUnnormalization),A=U.createPolyline([x],this.view.spatialReference,this._doUnnormalization);this._showLineGraphic(T),this._showActiveLineGraphic(A);for(var H=0;H<S.length;H++){var I=this._vertexGraphics[H];if(I)o||H!==this._vertexGraphics.length-1?I.symbol=this.vertexSymbol:I.symbol=this.activeVertexSymbol;else{var O=t[H],c=O[0],l=O[1];this._showVertexGraphic(new s.Point(c,l,this.view.spatialReference))}}if(o){this._activeLineGraphic.symbol=this.polylineSymbol;var P=t[t.length-1],c=P[0],l=P[1];this._showVertexGraphic(new s.Point(c,l,this.view.spatialReference))}else this._activeLineGraphic.symbol=this.activeLineSymbol;this.createGraphic?this.createGraphic.geometry=d:(this._removeCreateGraphic(),this._set("createGraphic",new p(d,n)));for(var k=0,L=this._vertexGraphics;k<L.length;k++){var G=L[k];this._internalGraphicsLayer.remove(G),this._internalGraphicsLayer.add(G)}}},u.prototype._drawSegmentGraphic=function(e,t,r){if(t.length){var o=U.createViewAlignedCoordinateSystem(this.view,t[0]),i=!(!r||!r.centered),n=!(!r||!r.constrained),a=null;if(1===t.length?this._removeCenterIndicatorGraphic():("rectangle"===e?a=n?U.createSquare(t,o,i):U.createRectangle(t,o,i):"circle"===e&&(a=n?U.createEllipse(t,o,i):U.createCircle(t,o,i)),a.extent&&a.extent.center&&this._showCenterIndicatorGraphic(a.extent.center)),!a)return void this._removeCreateGraphic();this.createGraphic?this.createGraphic.geometry=a:(this._removeCreateGraphic(),this._set("createGraphic",new p(a,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic))}},u.prototype._showCenterIndicatorGraphic=function(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new p(e,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))},u.prototype._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)},u.prototype._showActiveLineGraphic=function(e){this._activeLineGraphic?this._activeLineGraphic.geometry=e:(this._activeLineGraphic=new p(e,this.activeLineSymbol),this._internalGraphicsLayer.graphics.add(this._activeLineGraphic,0))},u.prototype._showFillGraphic=function(e){this._activeFillGraphic?this._activeFillGraphic.geometry=e:(this._activeFillGraphic=new p(e,this._getCreateSymbol(e,!0)),this._internalGraphicsLayer.add(this._activeFillGraphic))},u.prototype._showLineGraphic=function(e){this._lineGraphic?this._lineGraphic.geometry=e:(this._lineGraphic=new p(e,this.polylineSymbol),this._internalGraphicsLayer.graphics.add(this._lineGraphic,0))},u.prototype._showVertexGraphic=function(e,t){var r=t?this.activeVertexSymbol:this.vertexSymbol,o=new p(e,r);this._vertexGraphics.push(o),this._internalGraphicsLayer.add(o)},u.prototype._resetCreateOperationGraphics=function(){this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeActiveLineGraphic(),this._removeVertexGraphics()},u.prototype._removeCreateGraphic=function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))},u.prototype._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()},u.prototype._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)},u.prototype._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)},u.prototype._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)},u.prototype._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach(function(e){return e.destroy()}),this._vertexGraphics=[])},u.prototype._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)},u.prototype._operationHandleForCreateAction=function(e,t,r){var o=this;return new P.OperationHandle({activeComponent:this._draw,tool:r,type:"create",onEnd:function(){t.forEach(function(e){return e.remove()}),t.length=0,o._removeCreateOperationGraphics(),o._internalGraphicsLayer&&o._internalGraphicsLayer.remove(o.createGraphic),o._displayDefaultCursor()},undo:function(){e.undo(),o._emitUndoEvent({graphics:[o.createGraphic],tool:r})},redo:function(){e.redo(),o._emitRedoEvent({graphics:[o.createGraphic],tool:r})},canUndo:function(){return e&&e.canUndo()},canRedo:function(){return e&&e.canRedo()}})},u.prototype._snap=function(e,t,r){r&&this._snapLastVertexToAxis(t),"polygon"===e&&this._snapLastPolygonVertexToFirst(t)},u.prototype._snapLastPolygonVertexToFirst=function(e){if(!(e.length<=2)){var t=e[0],r=e[e.length-1],o=this.view.toScreen(new s.Point(t[0],t[1],this.view.spatialReference)),i=this.view.toScreen(new s.Point(r[0],r[1],this.view.spatialReference));this._isWithinScreenDistance(o,i,this._getVertexIntersectDistance())&&(r[0]=t[0],r[1]=t[1])}},u.prototype._getVertexIntersectDistance=function(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?f.pt2px(this.vertexSymbol.size)/2+3:3},u.prototype._isWithinScreenDistance=function(e,t,r){var o=e.x-t.x,i=e.y-t.y;return Math.sqrt(o*o+i*i)<=r},u.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),r=e[e.length-1],o=U.createViewAlignedCoordinateSystem(this.view,r),i=o.mapToLocal(r),n=o.mapToLocal(t),a=Math.abs(n.x-i.x),s=Math.abs(n.y-i.y),p=o.localToMap(U.makeSurfacePoint(a>s?n.x:i.x,a>s?i.y:n.y));e.push(p)}},u.prototype._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")},u.prototype._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)},u.prototype._logError=function(e,t,r){F.error(new d(e,t,r))},u.prototype._generateSceneViewHighlightHandles=function(){var e=this,t=function(t,r){var o=e.view;if(o&&"2d"!==o.type){var i=o.allLayerViews.find(function(e){return e.layer.uid===r.uid});i&&(t.added&&t.added.forEach(function(t){e._highlightHandlesByGraphic.add(i.highlight(t),t.uid)}),t.removed&&t.removed.forEach(function(t){e._highlightHandlesByGraphic.remove(t.uid)}))}};return[this.updateGraphics.on("after-add",function(r){t({added:[r.item]},e.layer)}),this.updateGraphics.on("after-remove",function(r){t({removed:[r.item]},e.layer)}),this._internalGraphicsLayer.graphics.on("after-add",function(r){t({added:[r.item]},e._internalGraphicsLayer)}),this._internalGraphicsLayer.graphics.on("after-remove",function(r){t({removed:[r.item]},e._internalGraphicsLayer)}),g.on(this,"view.allLayerViews","change",function(r){if(r.added)for(var o=0,i=r.added;o<i.length;o++){var n=i[o];n.layer===e.layer?t({added:e.updateGraphics.toArray(),removed:[]},n.layer):n.layer===e._internalGraphicsLayer&&t({added:e._internalGraphicsLayer.graphics.toArray(),removed:[]},n.layer)}})]},u.prototype._requireModule=function(e){return a(this,void 0,void 0,function(){var t,r;return n(this,function(o){switch(o.label){case 0:return t=new AbortController,this._moduleLoaderAbortController=t,[4,e];case 1:return r=o.sent(),this._moduleLoaderAbortController!==t||t.signal.aborted?[2,{requireError:"aborted"}]:[2,{module:r}]}})})},u.prototype._emitCreateEvent=function(e){this.emit("create",r({},e,{type:"create"}))},u.prototype._emitUpdateEvent=function(e){this.emit("update",r({},e,{type:"update"}))},u.prototype._emitUndoEvent=function(e){this.emit("undo",r({},e,{type:"undo"}))},u.prototype._emitRedoEvent=function(e){this.emit("redo",r({},e,{type:"redo"}))},u.prototype._emitDeleteEvent=function(e){this.emit("delete",r({},e,{type:"delete"}))},i([_.property({dependsOn:["state"],readOnly:!0})],u.prototype,"_draw",null),i([_.property()],u.prototype,"_operationHandle",void 0),i([_.property({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],u.prototype,"activeTool",null),i([_.property()],u.prototype,"activeFillSymbol",void 0),i([_.property()],u.prototype,"activeLineSymbol",void 0),i([_.property()],u.prototype,"activePointSymbol",void 0),i([_.property()],u.prototype,"activeVertexSymbol",void 0),i([_.property({readOnly:!0})],u.prototype,"createGraphic",void 0),i([_.property()],u.prototype,"defaultCreateOptions",void 0),i([_.property()],u.prototype,"defaultUpdateOptions",void 0),i([_.property()],u.prototype,"layer",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"pointSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"polygonSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"polylineSymbol",void 0),i([_.property({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],u.prototype,"state",null),i([_.property({readOnly:!0})],u.prototype,"updateGraphics",void 0),i([_.property()],u.prototype,"updateOnGraphicClick",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"updatePointSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"updatePolygonSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"updatePolylineSymbol",void 0),i([_.property({types:c.symbolTypes})],u.prototype,"vertexSymbol",void 0),i([_.property({value:null})],u.prototype,"view",null),i([_.property()],u.prototype,"cancel",null),i([_.property()],u.prototype,"complete",null),i([_.property()],u.prototype,"delete",null),i([_.property()],u.prototype,"create",null),i([_.property()],u.prototype,"update",null),i([_.property()],u.prototype,"undo",null),i([_.property()],u.prototype,"redo",null),i([_.property()],u.prototype,"canUndo",null),i([_.property()],u.prototype,"canRedo",null),i([_.property()],u.prototype,"toggleUpdateTool",null),u=i([_.subclass("esri.widgets.Sketch.SketchViewModel")],u)}(_.declared(u.EventedAccessor))});